From inssomniak at mountaincable.net  Sun Jul  2 16:35:19 2006
From: inssomniak at mountaincable.net (Dave)
Date: Sun, 02 Jul 2006 10:35:19 -0400
Subject: [Fwd: Re: [Softdevice-devel] I only see osd]
Message-ID: <44A7D9A7.6030309@mountaincable.net>


Nvidia RIVA TNT is broken with softdevice/directfb, it always has been
and only shows OSD as you described.  In fact most nvidia cards dont
work with softdevice/directfb, aside from the MX series which work well. 

FX series, GT series all broken.
A crew of us were never able to determine why.


Dave



Stefan Lucke wrote:
> On Donnerstag 15 Juni 2006 16:59, Leo M?rquez wrote:
>   
>> More info. This is my fbset -i:
>>
>> mode "640x480-60"
>>     # D: 25.176 MHz, H: 31.469 kHz, V: 59.942 Hz
>>     geometry 640 480 640 32767 8
>>     timings 39721 40 24 32 11 96 2
>>     accel true
>>     rgba 8/0,8/0,8/0,0/0
>> endmode
>>
>> Frame buffer device information:
>>     Name        : NV2
>>     Address     : 0xe4000000
>>     Size        : 33554432
>>     Type        : PACKED PIXELS
>>     Visual      : PSEUDOCOLOR
>>     XPanStep    : 8
>>     YPanStep    : 1
>>     YWrapStep   : 0
>>     LineLength  : 640
>>     MMIO Address: 0xe6000000
>>     MMIO Size   : 16777216
>>     Accelerator : nVidia RIVA TNT
>>
>> I hope you could help me.
>>
>>     
>
> So the only info which is missing, is the messages written to stderr.
> Up to now everything looks ok. At least there is no obious error.
>
> Please try to avoid top posts.
>
>
>   
>> Thanks,
>>
>> Leo
>>
>> Leo M?rquez wrote:
>>     
>>> Hi again,
>>> Some logs I see in syslog:
>>>
>>> switching to channel 6
>>> Jun 15 15:51:35 vdr vdr: [3606] transfer thread ended (pid=3577, 
>>> tid=3606)
>>> Jun 15 15:51:35 vdr vdr: [3609] TS buffer on device 1 thread ended 
>>> (pid=3577, tid=3609)
>>> Jun 15 15:51:35 vdr vdr: [3607] buffer stats: 67680 (3%) used
>>> Jun 15 15:51:35 vdr vdr: [3607] receiver on device 1 thread ended 
>>> (pid=3577, tid=3607)
>>> Jun 15 15:51:35 vdr vdr: [3577] cTS2PES got 0 TS errors, 1 TS 
>>> continuity errors
>>> Jun 15 15:51:35 vdr vdr: [3577] buffer stats: 68056 (3%) used
>>> Jun 15 15:51:35 vdr vdr: [3614] transfer thread started (pid=3577, 
>>> tid=3614)
>>> Jun 15 15:51:35 vdr vdr: [3615] receiver on device 1 thread started 
>>> (pid=3577, tid=3615)
>>> Jun 15 15:51:35 vdr vdr: [3617] TS buffer on device 1 thread started 
>>> (pid=3577, tid=3617)
>>> Jun 15 15:51:36 vdr vdr: [3614] setting audio track to 1 (0)
>>> Jun 15 15:51:36 vdr vdr: [3619] [softdevice-audio]: xrun
>>> Jun 15 15:51:39 vdr vdr: [3577] switching to channel 7
>>> Jun 15 15:51:39 vdr vdr: [3614] transfer thread ended (pid=3577, 
>>> tid=3614)
>>> Jun 15 15:51:39 vdr vdr: [3617] TS buffer on device 1 thread ended 
>>> (pid=3577, tid=3617)
>>> Jun 15 15:51:39 vdr vdr: [3615] buffer stats: 57528 (2%) used
>>> Jun 15 15:51:39 vdr vdr: [3615] receiver on device 1 thread ended 
>>> (pid=3577, tid=3615)
>>> Jun 15 15:51:39 vdr vdr: [3577] cTS2PES got 0 TS errors, 1 TS 
>>> continuity errors
>>> Jun 15 15:51:39 vdr vdr: [3577] cTS2PES got 1 TS errors, 1 TS 
>>> continuity errors
>>> Jun 15 15:51:39 vdr vdr: [3577] buffer stats: 57904 (2%) used
>>> Jun 15 15:51:39 vdr vdr: [3620] transfer thread started (pid=3577, 
>>> tid=3620)
>>> Jun 15 15:51:39 vdr vdr: [3621] receiver on device 1 thread started 
>>> (pid=3577, tid=3621)
>>> Jun 15 15:51:39 vdr vdr: [3623] TS buffer on device 1 thread started 
>>> (pid=3577, tid=3623)
>>> Jun 15 15:51:40 vdr vdr: [3624] [VideoOut]: resolution changed: W(720 
>>> -> 528); H(576 ->576)
>>> Jun 15 15:51:40 vdr vdr: [3624] [VideoOut]: 528x576 [0,0 528x576] -> 
>>> 768x576 [0,0 768x576]
>>>
>>>
>>> Can be related to my problem?
>>>
>>> Thanks again.
>>>
>>> Leo
>>>
>>>
>>>
>>> Leo M?rquez wrote:
>>>       
>>>> Hi,
>>>>
>>>> Well I'm setted up a vdr with softdevice, directfb but when I start 
>>>> vdr with:
>>>>
>>>> ./vdr -P"softdevice -vo dfb:"
>>>>
>>>> I only see the osd menus, but no tv image.
>>>> My directfbrc file contains:
>>>>
>>>> mode  = 768x576
>>>> depth = 32
>>>> pixelformat=ARGB
>>>>
>>>> My hardware is a nvidia tnt2 M64.
>>>> The framebuffer module I use is nvidiafb
>>>>
>>>> In var/log/syslog I don't see anything strange.
>>>>
>>>> In the other hand if I start vdr with only -Pstreamdev-server the 
>>>> clients can watch TV.
>>>> In the server few days a go I use -vo fb: as output and It works.
>>>>
>>>> I supose the problem is related to the directfb configuration but... 
>>>> why can I see osd and not TV?
>>>>
>>>> Thanks,
>>>>
>>>> Leo
>>>> _______________________________________________
>>>> Softdevice-devel mailing list
>>>> Softdevice-devel at lists.berlios.de
>>>> http://lists.berlios.de/mailman/listinfo/softdevice-devel
>>>>
>>>>         
>>> _______________________________________________
>>> Softdevice-devel mailing list
>>> Softdevice-devel at lists.berlios.de
>>> http://lists.berlios.de/mailman/listinfo/softdevice-devel
>>>
>>>       
>> _______________________________________________
>> Softdevice-devel mailing list
>> Softdevice-devel at lists.berlios.de
>> http://lists.berlios.de/mailman/listinfo/softdevice-devel
>>
>>     
>
>   




From inssomniak at mountaincable.net  Sun Jul  2 16:35:55 2006
From: inssomniak at mountaincable.net (Dave)
Date: Sun, 02 Jul 2006 10:35:55 -0400
Subject: [Softdevice-devel] [Fwd: Better Error Handling for bad sample rates "Fatal: Exiting"]
Message-ID: <44A7D9CB.6080906@mountaincable.net>

 I have this problem occasionally with softdevice exiting out due to
unsupported audio sample rates. for example 44100 khz causes softdevice
to exit and kill VDR.

 Is there a better way to handle this rather than to kill VDR
 completely? I have 3 DVB-S cards in one box, and 3 dishes. I often am
 recording 3-4 programs at the same time, and for example a brief hard
 rain comes by and lowers the signal too low and causes video/audio
 errors I lose all my other recordings currently being recorded which
 encountered no problems at all. I would much rather have a recording
 with some video/audio errors than no recordings at all.

 Im open to suggestions :)

 Dave


   





From marko.makela at iki.fi  Sun Jul  2 18:50:12 2006
From: marko.makela at iki.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sun, 2 Jul 2006 19:50:12 +0300
Subject: [Softdevice-devel] Matrox busy waiting in Flip() still wastes 10% CPU
In-Reply-To: <20060627203023.GC3594@localhost.localdomain>
References: <200606222208.58088.stefan@lucke.in-berlin.de> <44A07AEC.9090400@users.sourceforge.net> <200606270757.23327.stefan@lucke.in-berlin.de> <20060627200510.GB3594@localhost.localdomain> <20060627203023.GC3594@localhost.localdomain>
Message-ID: <20060702165012.GC3638@localhost.localdomain>

On Tue, Jun 27, 2006 at 11:30:23PM +0300, Marko M?kel? wrote:
> > Ditto, with current CVS of softdevice and DirectFB, on Debian GNU/Linux
> > unstable (updated tonight) and Matrox G450.
> 
> Short profiling results:

Sorry, these were with the following patch applied, to avoid busy-waiting
at DirectFB Flip() calls:

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.68
diff -p -u -r1.68 video-dfb.c
--- video-dfb.c	25 Jun 2006 13:46:12 -0000	1.68
+++ video-dfb.c	2 Jul 2006 16:26:08 -0000
@@ -1289,6 +1289,7 @@ void cDFBVideoOut::ShowOSD ()
         scrSurface->SetBlittingFlags(DSBLIT_BLEND_ALPHACHANNEL);
         scrSurface->Blit(osdSurface, &osdsrc, 0, 0);
       }
+      usleep(1000);
       scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
 
     }
@@ -1488,6 +1489,7 @@ void cDFBVideoOut::YUV(sPicBuffer *buf)
 
       }
       //scrSurface->Flip(NULL, (setupStore->useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
+      usleep(2000);
       scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
     }
     else

Without the patch, processor usage grows by about 10%, because of this
busy loop in libdirectfb:

samples  %        symbol name
11466    98.8193  matroxEngineSync

Ville says that replacing the polling with an interrupt would require at
least one more ioctl in the kernel.

	Marko


From Neumann at do-net.de  Mon Jul  3 09:44:08 2006
From: Neumann at do-net.de (Andre Neumann)
Date: Mon, 3 Jul 2006 09:44:08 +0200
Subject: [Softdevice-devel] live HDTV channel not playing smooth
Message-ID: <FB3B5DB3197CEA429E5FB8E83D01D0390D9256@sbs2003.do-net.de>

Hi,
 
I tested live HDTV output yesterday again with the patch Marko M?kel? send to the list yesterday.
Cpu is now at 70% when watching HD1 channel (1440x1080) here in my cable network (ish).

The Problem is, that die playback is not smooth. It is running only very slowly and every 5 seconds
the output hangs. In the logfiles from vdr i see, that the transfer buffer gets cleared when the
video hangs. 

Softdevice is CVS, ffmpeg SVN. DirectFB 0.9.25.

Softdevice is operating with HDTV buffer method. I also tried to change the buffers in vdr in transfer.c
from 2 MB to 8 MB, but that has no effect.

I think, there is some problem beetween communication vdr --> softdevice. Because when i stream HD1 on my
Notebook, i have no glitches in the video and the transfer buffers dont fill so fast.

Is there something i can do to help to debug this ?

-------------
Andre Neumann



From bob at globall.ru  Tue Jul  4 13:04:24 2006
From: bob at globall.ru (Monchenko Vladimir)
Date: Tue, 04 Jul 2006 15:04:24 +0400
Subject: [Softdevice-devel] EPIA ME6000 and CPU usage
Message-ID: <44AA4B38.4080400@globall.ru>

Hi,

On EPIA ME6000 with latest CVS DirectFB, softdevice and cle266 hw
decoding I obtain CPU load 50-80%, depending on the channel bitrate and
resolution.
Image quality very high, but when load CPU large video not smoothly and
the sound clicks. Someone does use this motherboard?
This correctly or it is possible to reduce CPU usage by a fine adjustment?

Sorry for my bad english.

Best regards,
Monchenko Vladimir.


From Neumann at do-net.de  Thu Jul  6 17:38:44 2006
From: Neumann at do-net.de (Andre Neumann)
Date: Thu, 6 Jul 2006 17:38:44 +0200
Subject: [Softdevice-devel] live HDTV channel not playing smooth
Message-ID: <FB3B5DB3197CEA429E5FB8E83D01D0390D927F@sbs2003.do-net.de>

I noticed the same problem on a 3,4 Ghz P4 HT machine (my VDR is a 2,8 GHz P4 without HT),
so i think it has nothing to do with cpu power.
It must be some buffer or something....

Anyone ?

-------------
Andre Neumann

> -----Original Message-----
> From: softdevice-devel-admin at berlios.de 
> [mailto:softdevice-devel-admin at berlios.de] On Behalf Of Andre Neumann
> Sent: Monday, July 03, 2006 9:44 AM
> To: softdevice-devel at berlios.de
> Subject: [Softdevice-devel] live HDTV channel not playing smooth
> 
> Hi,
>  
> I tested live HDTV output yesterday again with the patch 
> Marko M?kel? send to the list yesterday.
> Cpu is now at 70% when watching HD1 channel (1440x1080) here 
> in my cable network (ish).
> 
> The Problem is, that die playback is not smooth. It is 
> running only very slowly and every 5 seconds
> the output hangs. In the logfiles from vdr i see, that the 
> transfer buffer gets cleared when the
> video hangs. 
> 
> Softdevice is CVS, ffmpeg SVN. DirectFB 0.9.25.
> 
> Softdevice is operating with HDTV buffer method. I also tried 
> to change the buffers in vdr in transfer.c
> from 2 MB to 8 MB, but that has no effect.
> 
> I think, there is some problem beetween communication vdr --> 
> softdevice. Because when i stream HD1 on my
> Notebook, i have no glitches in the video and the transfer 
> buffers dont fill so fast.
> 
> Is there something i can do to help to debug this ?
> 
> -------------
> Andre Neumann
> 
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/softdevice-devel
> 
> 
> 



From per at mellander.org  Mon Jul 10 14:08:49 2006
From: per at mellander.org (Per Mellander)
Date: Mon, 10 Jul 2006 14:08:49 +0200
Subject: [Softdevice-devel] softdevice + libcle266mpegdec
Message-ID: <20060710114955.M36064@mellander.org>

I've managed to setup my EPIA MII 12000 to use the HW support from CLE266. ( I think )

In short words this is what I've done.

* linux-viafb CVS 20060706
* libcle266mpegdec-0.1, from Rolf A's website
* DFB++ CVS 20060706 - patched with patch from libcle266mpegdec-0.1 packages
* DirectFB CVS 20060706 - patched with patch from libcle266mpegdec-0.1 packages
* ffmpeg SVN 20060710
* vdr-1.4.1
* softdevice CVS 20060710

Do I have to patch anything in the softdevice code? It looks like the patch from
libcle266mpegdec-0.1 package already are in CVS?

/Per

---------------8<--------------------------------------------------------------------
./configure gives:

Checking for ffmpeg... Ok.
Checking for DirectFB and DFB++... Enabled video-dfb.
Checking for vidix... Not found.
Checking for libcle266mpegdec ... Enabled cle266 hardware decoding.
Checking for Xv... Enabled video-xv.
Checking for Xinerama... Enabled Xinerama.
---------------8<--------------------------------------------------------------------

Starting vdr it gives the initial 'remote detection' screen but after a few seconds it
dies. Following is the log output:

---------------8<--------------------------------------------------------------------
[root at localhost vdr-1.4.1]# ./vdr -P"softdevice -vo dfb:cle266"
[softdevice] processing args
[softdevice]   argv [0] = softdevice
[softdevice]   argv [1] = -vo
vo_argv: dfb:cle266 
[softdevice] enabling CLE266 HW decoding
[softdevice] initializing Plugin
[softdevice] Initializing Video Out
[softdevice] ffmpeg version(SVN-r5704) build(3344896)
[dfb] init
(*) DirectFB/Config: Parsing config file '/etc/directfbrc'.

       ---------------------- DirectFB v0.9.26 ---------------------
             (c) 2000-2002  convergence integrated media GmbH  
             (c) 2002-2004  convergence GmbH                   
        -----------------------------------------------------------

(*) DirectFB/Core: Single Application Core. (2006-07-10 07:19) 
(*) Direct/Memcpy: Using SSE optimized memcpy()
(*) Direct/Modules: suppress module 'lirc'
(*) Direct/Thread: Running 'Linux Input' (INPUT, 2315)...
 (!!!)  *** UNIMPLEMENTED [fusion_reactor_set_lock] *** [reactor.c:853]
(*) DirectFB/Input: AT Translated Set 2 keyboard (1) 0.1 (convergence integrated media GmbH)
(*) Direct/Thread: Running 'Linux Input' (INPUT, 2316)...
(*) DirectFB/Input: ImExPS/2 Logitech Wheel Mouse (2) 0.1 (convergence integrated media
GmbH)
(*) Direct/Thread: Running 'PS/2 Input' (INPUT, 2317)...
(*) DirectFB/Input: IMPS/2 Mouse 1.0 (Convergence GmbH)
(*) DirectFB/Genefx: MMX detected and enabled
(*) Direct/Modules: suppress module 'cle266'
(*) DirectFB/Graphics: VIA/S3G CLE266/UniChrome 0.4 (-)
(*) DirectFB/Core/WM: Default 0.2 (Convergence GmbH)
[dfb] RAM: 33288192 bytes
[dfb] Accellerated Functions: FillRectange DrawRectange DrawLine FillTriangle Blit
StretchBlit All 
[dfb] Drawing Flags: Blend Xor 
[dfb] Surface Blitting Flags: BlendAlpha BlendColorAlpha Colorize SrcColorkey
DstColorkey Deinterlace 
[dfb] Supported video Modes are: 720x576 at 16 640x480 at 8 640x480 at 8 640x480 at 8 640x480 at 8
640x480 at 8 800x600 at 8 800x600 at 8 800x600 at 8 800x600 at 8 800x600 at 8 800x600 at 8 800x600 at 8
800x600 at 8 1024x768 at 8 1024x768 at 8 1024x768 at 8 1024x768 at 8 1024x768 at 8 1024x768 at 8 1024x768 at 8
1152x864 at 8 1152x864 at 8 1152x864 at 8 1152x864 at 8 1152x864 at 8 1152x864 at 8 1280x1024 at 8
1280x1024 at 8 1280x1024 at 8 1280x1024 at 8 1280x1024 at 8 1600x1200 at 8 1600x1200 at 8 1600x1200 at 8 
[dfb] Enumerating display Layers
[dfb] Configuring CooperativeLevel for OSD
Layer 0 VIA CLE266 Graphics  Type: graphics 
  Caps: alphachannel brightness contrast opacity saturation src_colorkey surface 
Layer 1 VIA Unichrome Video  Type: graphics picture video 
  Caps: deinterlacing dst_colorkey levels field_parity opacity screen_location surface 
Initialising CLE266 decoder (/dev/fb0): MMIO addr: 0xb173a000
success!
CLE266: Creating buffers for decoder
CLE266: Creating buffer number 0
CLE266: Creating buffer number 1
CLE266: Creating buffer number 2
CLE266: Creating buffer number 3
CLE266: passing mpegfb_stride
CLE266: passing buffers to decoder
[dfb] (osdLayer): flags, options, pixelformat: 0000000f, 00000000 00418c04
[dfb] (osdLayer): width, height:               720 576
[dfb] osdLayer has alpha channel
[surface capabilities] scrSurface: videoonly double-buffered flipping PixelFormat =
0x00418c04 
[dfb] width = 720, height = 576
[dfb] got fmt = 0x00418c04 bpp = 32
[dfb] Using this layer for OSD: (VIA CLE266 Graphics - [720x576])
[surface capabilities] osdSurface: videoonly double-buffered flipping PixelFormat =
0x00418c04 
[dfb] Configuring CooperativeLevel for Overlay
[surface capabilities] videoSurface: videoonly PixelFormat = 0x0810060a 
[dfb] Using this layer for OSD:        VIA CLE266 Graphics
[dfb] Using this layer for Video out:  VIA Unichrome Video
[dfb] Display frame time is 16665 microseconds
[dfb] (re)configuring Videolayer to 720 x 576 (720x576)
[surface capabilities] videoSurface: videoonly double-buffered flipping PixelFormat =
0x08100609 
[dfb] (re)configured 0x08100609
[softdevice] Subplugin successfully opend
[softdevice] Video Out seems to be OK
[softdevice] Initializing Audio Out
[softdevice] Audio out seems to be OK
[softdevice] A/V devices initialized, now initializing MPEG2 Decoder
[dfb] (re)configuring Videolayer to 736 x 576 (736x576)
[surface capabilities] videoSurface: videoonly double-buffered flipping PixelFormat =
0x08100609 
[dfb] (re)configured 0x08100609
(!) [ 2314:    0.000] --> Caught signal 11 (at 0x93669770, invalid address) <--
---------------8<--------------------------------------------------------------------

[root at localhost softdevice]# more /etc/directfbrc 
fbdev=/dev/fb0
mode=720x576
depth=32
pixelformat=ARGB
disable-module=cle266
disable-module=lirc
no-vt
---------------8<--------------------------------------------------------------------



From M.Wache at gmx.net  Mon Jul 10 20:06:36 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 10 Jul 2006 20:06:36 +0200
Subject: [Softdevice-devel] live HDTV channel not playing smooth
In-Reply-To: <FB3B5DB3197CEA429E5FB8E83D01D0390D927F@sbs2003.do-net.de>
References: <FB3B5DB3197CEA429E5FB8E83D01D0390D927F@sbs2003.do-net.de>
Message-ID: <44B2972C.9000609@gmx.net>

Andre Neumann schrieb:
> I noticed the same problem on a 3,4 Ghz P4 HT machine (my VDR is a 2,8 GHz P4 without HT),
> so i think it has nothing to do with cpu power.
> It must be some buffer or something....
> 

Yes, probably you are right, please try to increase the buffersizes in
mpeg2decoder.c:


// 0: save buffers, 1: good seeking, 2: HDTV buffers
int dvb_buf_size[] = {64*1024,32*1024,64*1024};
int packet_buf_size[] = {300,150,2000};

The last one is the relevant one of HDTV playback, please try to change
packet_buf_size first and if you find values that are working for you
please report them.
If you don't find any values I will send you a patch which will
introduce some more debugging infos.

Bye,
Martin


From M.Wache at gmx.net  Mon Jul 10 20:14:28 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 10 Jul 2006 20:14:28 +0200
Subject: [Softdevice-devel] softdevice + libcle266mpegdec
In-Reply-To: <20060710114955.M36064@mellander.org>
References: <20060710114955.M36064@mellander.org>
Message-ID: <44B29904.5000904@gmx.net>

Per Mellander schrieb:
> I've managed to setup my EPIA MII 12000 to use the HW support from CLE266. ( I think )
> 
> In short words this is what I've done.
> 
> * linux-viafb CVS 20060706
> * libcle266mpegdec-0.1, from Rolf A's website
> * DFB++ CVS 20060706 - patched with patch from libcle266mpegdec-0.1 packages
> * DirectFB CVS 20060706 - patched with patch from libcle266mpegdec-0.1 packages
> * ffmpeg SVN 20060710
> * vdr-1.4.1
> * softdevice CVS 20060710
> 
> Do I have to patch anything in the softdevice code? It looks like the patch from
> libcle266mpegdec-0.1 package already are in CVS?
>
Yes, the CVS version of the softdevice should work with the hardware
decoding.


> /Per
> 
> ---------------8<--------------------------------------------------------------------
> ./configure gives:
> 
> Checking for ffmpeg... Ok.
> Checking for DirectFB and DFB++... Enabled video-dfb.
> Checking for vidix... Not found.
> Checking for libcle266mpegdec ... Enabled cle266 hardware decoding.
> Checking for Xv... Enabled video-xv.
> Checking for Xinerama... Enabled Xinerama.
> ---------------8<--------------------------------------------------------------------
> 
> Starting vdr it gives the initial 'remote detection' screen but after a few seconds it
> dies. Following is the log output:
> 
Hmm, I don't see anything wrong in the log until it dies...
You seem to have X installed on you system? Is X still runnning in the
background? Was X running before you started the softdevice? Is it
working without hardware decoding ("-vo dfb:")? Is it working with Xv?
Many questions... ;-)
The nicest would be a traceback of the crash, but as far as I know
DirectFB overloads the crash handler so that you don't get a core dump
anymore. Or does anyone know how to get one? I only know that one can
compile DirectFB with a debug option which enables some kind of
backtrace, but I don't remember the details. So if you could try to
produce some kind of traceback, that would be nice!

Bye,
Martin


From laz at club-burniston.co.uk  Mon Jul 10 20:26:40 2006
From: laz at club-burniston.co.uk (Laz)
Date: Mon, 10 Jul 2006 19:26:40 +0100
Subject: [Softdevice-devel] softdevice + libcle266mpegdec
In-Reply-To: <44B29904.5000904@gmx.net>
References: <20060710114955.M36064@mellander.org> <44B29904.5000904@gmx.net>
Message-ID: <200607101926.40869.laz@club-burniston.co.uk>

On Monday 10 July 2006 19:14, Martin Wache wrote:

<snippage>

> Hmm, I don't see anything wrong in the log until it dies...
> You seem to have X installed on you system? Is X still runnning in the
> background? Was X running before you started the softdevice? Is it
> working without hardware decoding ("-vo dfb:")? Is it working with Xv?
> Many questions... ;-)
> The nicest would be a traceback of the crash, but as far as I know
> DirectFB overloads the crash handler so that you don't get a core dump
> anymore. Or does anyone know how to get one? I only know that one can
> compile DirectFB with a debug option which enables some kind of
> backtrace, but I don't remember the details. So if you could try to
> produce some kind of traceback, that would be nice!

It all looked OK to me, too. Did you try it again or just the once?

I sometimes get softdevice dieing with a sig 11 / invalid address error. I've 
yet to work out why, though! I've a feeling that it works when the aspect 
changes on the live stream during playback of a recording but this is a 
complete guess. It usually happens when I stop playback rather than in the 
middle of something, although I have seen it a couple of times at start up.

Cheers,

Laz


From per at mellander.org  Mon Jul 10 20:32:12 2006
From: per at mellander.org (Per Mellander)
Date: Mon, 10 Jul 2006 20:32:12 +0200
Subject: [Softdevice-devel] softdevice + libcle266mpegdec
In-Reply-To: <44B29904.5000904@gmx.net>
References: <20060710114955.M36064@mellander.org> <44B29904.5000904@gmx.net>
Message-ID: <20060710182208.M63893@mellander.org>

On Mon, 10 Jul 2006 20:14:28 +0200, Martin Wache wrote
> Hmm, I don't see anything wrong in the log until it dies...
> You seem to have X installed on you system? Is X still runnning in the
> background? Was X running before you started the softdevice? Is it
> working without hardware decoding ("-vo dfb:")? Is it working with Xv?
> Many questions... ;-)
> The nicest would be a traceback of the crash, but as far as I know
> DirectFB overloads the crash handler so that you don't get a core dump
> anymore. Or does anyone know how to get one? I only know that one can
> compile DirectFB with a debug option which enables some kind of
> backtrace, but I don't remember the details. So if you could try to
> produce some kind of traceback, that would be nice!

As you say it doesn't produce any core dump etc. After some investigations ( i.e
restarting the system ) it runs as expected. Now and then, about 1 out of 10, it dies
after starting vdr. I have ~30-35% load when watching TV on a Nova-T budget so I'm
pleased so far. With "-vo dfb:" I get ~70% load. I'll try get som traceback tonight. X
is btw installed but not running and I haven't used it since install ( console junkie ;) ).

/Per


From M.Wache at gmx.net  Mon Jul 10 20:46:30 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 10 Jul 2006 20:46:30 +0200
Subject: [Softdevice-devel] softdevice + libcle266mpegdec
In-Reply-To: <200607101926.40869.laz@club-burniston.co.uk>
References: <20060710114955.M36064@mellander.org> <44B29904.5000904@gmx.net> <200607101926.40869.laz@club-burniston.co.uk>
Message-ID: <44B2A086.7090500@gmx.net>

Laz schrieb:
> On Monday 10 July 2006 19:14, Martin Wache wrote:
> 
> <snippage>
> 
>> Hmm, I don't see anything wrong in the log until it dies...
>> You seem to have X installed on you system? Is X still runnning in the
>> background? Was X running before you started the softdevice? Is it
>> working without hardware decoding ("-vo dfb:")? Is it working with Xv?
>> Many questions... ;-)
>> The nicest would be a traceback of the crash, but as far as I know
>> DirectFB overloads the crash handler so that you don't get a core dump
>> anymore. Or does anyone know how to get one? I only know that one can
>> compile DirectFB with a debug option which enables some kind of
>> backtrace, but I don't remember the details. So if you could try to
>> produce some kind of traceback, that would be nice!
> 
> It all looked OK to me, too. Did you try it again or just the once?
> 
> I sometimes get softdevice dieing with a sig 11 / invalid address error. I've 
> yet to work out why, though! I've a feeling that it works when the aspect 
> changes on the live stream during playback of a recording but this is a 
> complete guess.
We had an issue like that long ago, Stefan found out that it was
actually a bug in ffmpeg. How old is your ffmpeg version? I don't
remember exactly which version had this problem, but if your version is
about one year old you could try an update of ffmpeg.

> It usually happens when I stop playback rather than in the 
> middle of something, although I have seen it a couple of times at start up.
> 
Please report all crashes of the softdevice! I really don't like the
idea of having crashes with the softdevice. The main problem is that to
be able to do something about it we either have to be able to reproduce
the crash or we must have a (meaningfull) traceback...
But I would really like to try to fix all crashes :-)

Bye,
Martin


From per at mellander.org  Mon Jul 10 21:44:45 2006
From: per at mellander.org (Per Mellander)
Date: Mon, 10 Jul 2006 21:44:45 +0200
Subject: [Softdevice-devel] softdevice + libcle266mpegdec
In-Reply-To: <44B2A086.7090500@gmx.net>
References: <20060710114955.M36064@mellander.org> <44B29904.5000904@gmx.net> <200607101926.40869.laz@club-burniston.co.uk> <44B2A086.7090500@gmx.net>
Message-ID: <20060710194004.M45711@mellander.org>

On Mon, 10 Jul 2006 20:46:30 +0200, Martin Wache wrote
> We had an issue like that long ago, Stefan found out that it was
> actually a bug in ffmpeg. How old is your ffmpeg version? I don't
> remember exactly which version had this problem, but if your version is
> about one year old you could try an update of ffmpeg.

My ffmpeg is SVN as of today.

> 
> > It usually happens when I stop playback rather than in the 
> > middle of something, although I have seen it a couple of times at start up.
> > 
> Please report all crashes of the softdevice! I really don't like the
> idea of having crashes with the softdevice. The main problem is that to
> be able to do something about it we either have to be able to reproduce
> the crash or we must have a (meaningfull) traceback...
> But I would really like to try to fix all crashes :-)

I'll really try to get some useful info. My crashes are all the same as Laz describe his
crashes ( segfault etc. ). On the other hand haven't I done any playback yet, only live
TV. My crashes are as I said right when I start VDR. Any more ideas to get usefull
tracebacks ?

/Per


From M.Wache at gmx.net  Mon Jul 10 22:25:39 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 10 Jul 2006 22:25:39 +0200
Subject: [Softdevice-devel] softdevice + libcle266mpegdec
In-Reply-To: <20060710194004.M45711@mellander.org>
References: <20060710114955.M36064@mellander.org> <44B29904.5000904@gmx.net> <200607101926.40869.laz@club-burniston.co.uk> <44B2A086.7090500@gmx.net> <20060710194004.M45711@mellander.org>
Message-ID: <44B2B7C3.4000905@gmx.net>

Per Mellander schrieb:
> On Mon, 10 Jul 2006 20:46:30 +0200, Martin Wache wrote
>> We had an issue like that long ago, Stefan found out that it was
>> actually a bug in ffmpeg. How old is your ffmpeg version? I don't
>> remember exactly which version had this problem, but if your version is
>> about one year old you could try an update of ffmpeg.
> 
> My ffmpeg is SVN as of today.
> 
>>> It usually happens when I stop playback rather than in the 
>>> middle of something, although I have seen it a couple of times at start up.
>>>
>> Please report all crashes of the softdevice! I really don't like the
>> idea of having crashes with the softdevice. The main problem is that to
>> be able to do something about it we either have to be able to reproduce
>> the crash or we must have a (meaningfull) traceback...
>> But I would really like to try to fix all crashes :-)
> 
> I'll really try to get some useful info. My crashes are all the same as Laz describe his
> crashes ( segfault etc. ). On the other hand haven't I done any playback yet, only live
> TV. My crashes are as I said right when I start VDR. Any more ideas to get usefull
> tracebacks ?
> 
I just looked it up in the readme of DirectFB:

--enable-debug Enables many debug messages and assertions
--enable-trace Enables run time stack trace information

I guess it is a good start to enable both options in the configure of
DirectFB.

Bye,
Martin


From stefan at lucke.in-berlin.de  Mon Jul 10 22:59:39 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 10 Jul 2006 22:59:39 +0200
Subject: [Softdevice-devel] softdevice + libcle266mpegdec
In-Reply-To: <20060710194004.M45711@mellander.org>
References: <20060710114955.M36064@mellander.org> <44B2A086.7090500@gmx.net> <20060710194004.M45711@mellander.org>
Message-ID: <200607102259.39220.stefan@lucke.in-berlin.de>

On Montag 10 Juli 2006 21:44, Per Mellander wrote:
> On Mon, 10 Jul 2006 20:46:30 +0200, Martin Wache wrote
> > We had an issue like that long ago, Stefan found out that it was
> > actually a bug in ffmpeg. How old is your ffmpeg version? I don't
> > remember exactly which version had this problem, but if your version is
> > about one year old you could try an update of ffmpeg.
> 
> My ffmpeg is SVN as of today.
> 
> > 
> > > It usually happens when I stop playback rather than in the 
> > > middle of something, although I have seen it a couple of times at start up.
> > > 
> > Please report all crashes of the softdevice! I really don't like the
> > idea of having crashes with the softdevice. The main problem is that to
> > be able to do something about it we either have to be able to reproduce
> > the crash or we must have a (meaningfull) traceback...
> > But I would really like to try to fix all crashes :-)
> 
> I'll really try to get some useful info. My crashes are all the same as Laz describe his
> crashes ( segfault etc. ). On the other hand haven't I done any playback yet, only live
> TV. My crashes are as I said right when I start VDR. Any more ideas to get usefull
> tracebacks ?

Does it happen before or after the first video frame is displayed ?

My guess is some issue with locking. CloseOSD() in combination with
DrawStill_420pl() [our osd refresher]. Thats because I think I've a similar
situation but more reproducable. Server vdr has both dvb devices allocated,
intercative vdr cannot get one, so I get OSD messages "channel not available".
When I press menu-key sveral time during display of such messages, my
interactive vdr crashes :-( .

You can try to increase vdr's "message time" and/or "channel info time"
by 1 second each.


-- 
Stefan Lucke


From per at mellander.org  Tue Jul 11 08:10:38 2006
From: per at mellander.org (Per Mellander)
Date: Tue, 11 Jul 2006 08:10:38 +0200
Subject: [Softdevice-devel] softdevice + libcle266mpegdec
In-Reply-To: <200607102259.39220.stefan@lucke.in-berlin.de>
References: <20060710114955.M36064@mellander.org> <44B2A086.7090500@gmx.net> <20060710194004.M45711@mellander.org> <200607102259.39220.stefan@lucke.in-berlin.de>
Message-ID: <20060711050346.M17828@mellander.org>

On Mon, 10 Jul 2006 22:59:39 +0200, Stefan Lucke wrote
> 
> Does it happen before or after the first video frame is displayed ?
> 

Before. 

I've just enabled debugging in directfb. This is what I get when it dies. For the record
I can say that this is right after reboot and nothing else but insmod of linux-viafb has
been done.

/Per
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: cle266-seg11.txt
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060711/90bbd53f/attachment.txt>

From laz at club-burniston.co.uk  Tue Jul 11 10:07:22 2006
From: laz at club-burniston.co.uk (Laz)
Date: Tue, 11 Jul 2006 09:07:22 +0100
Subject: [Softdevice-devel] softdevice + libcle266mpegdec
In-Reply-To: <200607102259.39220.stefan@lucke.in-berlin.de>
References: <20060710114955.M36064@mellander.org> <20060710194004.M45711@mellander.org> <200607102259.39220.stefan@lucke.in-berlin.de>
Message-ID: <200607110907.22918.laz@club-burniston.co.uk>

On Monday 10 July 2006 21:59, Stefan Lucke wrote:
> Does it happen before or after the first video frame is displayed ?

For me, always before a frame is displayed. Sometimes, it will dump me to 
a shell on the TV, other times it just stays black.

> My guess is some issue with locking. CloseOSD() in combination with
> DrawStill_420pl() [our osd refresher]. Thats because I think I've a
> similar situation but more reproducable. Server vdr has both dvb
> devices allocated, intercative vdr cannot get one, so I get OSD
> messages "channel not available". When I press menu-key sveral time
> during display of such messages, my interactive vdr crashes :-( .

That sounds very familiar to what I see!

It doesn't happen very often so it's difficult to track down!

:(

I'll try updating my ffmpeg (it's not that old but you never know) and 
rebuilding DirectFB with the --enable-trace and --enable-debug options.

Cheers,

Laz


From per at mellander.org  Tue Jul 11 14:38:48 2006
From: per at mellander.org (Per Mellander)
Date: Tue, 11 Jul 2006 14:38:48 +0200
Subject: [Softdevice-devel] HOWTO libcle266mpegdec
Message-ID: <20060711122833.M94407@mellander.org>

I've written some kind of a HOWTO for making use of the CLE266 hardware decoding with
softdevice. Could you ( Laz, Martin, Stefan etc. ) take a look and comment before I drop
the link on vdr ml?

http://www.mellander.org/per/projects/linux/?chapter=epia-hw-cle266

I'm not really sure concerning prerequisites ( i.e ffmpeg ). And if someone could drop
me a line explaining the technical behind I would be glad to incorporate it.

/Per


From laz at club-burniston.co.uk  Tue Jul 11 16:11:55 2006
From: laz at club-burniston.co.uk (Laz)
Date: Tue, 11 Jul 2006 15:11:55 +0100
Subject: [Softdevice-devel] HOWTO libcle266mpegdec
In-Reply-To: <20060711122833.M94407@mellander.org>
References: <20060711122833.M94407@mellander.org>
Message-ID: <200607111511.55632.laz@club-burniston.co.uk>

On Tuesday 11 July 2006 13:38, Per Mellander wrote:
> I've written some kind of a HOWTO for making use of the CLE266 hardware
> decoding with softdevice. Could you ( Laz, Martin, Stefan etc. ) take a
> look and comment before I drop the link on vdr ml?
>
> http://www.mellander.org/per/projects/linux/?chapter=epia-hw-cle266
>
> I'm not really sure concerning prerequisites ( i.e ffmpeg ). And if
> someone could drop me a line explaining the technical behind I would be
> glad to incorporate it.

It looks pretty much OK to me. I think the main thing is to make sure that 
you have a recent CVS version of softdevice (so it includes the hardware 
decoding stuff) and a recent CVS version of softdevice so it patches 
cleanly. Softdevice also had some fixes to the OSD transparency recently.

I also have a couple of patches applied to give better vertical sync when 
using TV-out. Can post these if anyone is interested. Not tried it 
without these patches recently, so they may not actually be doing much 
now!

It would be nice to get libcle266mpegdec-0.1.tar.gz put somewhere more 
obvious like in the softdevice or DirectFB archives, though.

:)

Cheers,

Laz


From M.Wache at gmx.net  Tue Jul 11 18:45:02 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 11 Jul 2006 18:45:02 +0200
Subject: [Softdevice-devel] softdevice + libcle266mpegdec
In-Reply-To: <200607110907.22918.laz@club-burniston.co.uk>
References: <20060710114955.M36064@mellander.org> <20060710194004.M45711@mellander.org> <200607102259.39220.stefan@lucke.in-berlin.de> <200607110907.22918.laz@club-burniston.co.uk>
Message-ID: <44B3D58E.8080101@gmx.net>

Laz schrieb:
> On Monday 10 July 2006 21:59, Stefan Lucke wrote:
>> Does it happen before or after the first video frame is displayed ?
> 
> For me, always before a frame is displayed. Sometimes, it will dump me to 
> a shell on the TV, other times it just stays black.
> 
>> My guess is some issue with locking. CloseOSD() in combination with
>> DrawStill_420pl() [our osd refresher]. Thats because I think I've a
>> similar situation but more reproducable. Server vdr has both dvb
>> devices allocated, intercative vdr cannot get one, so I get OSD
>> messages "channel not available". When I press menu-key sveral time
>> during display of such messages, my interactive vdr crashes :-( .
>
I tried to reproduce that, but I had no luck...
I also had a look at the code and I'm sending you a patch with a view
trivial fixes, I'm not sure if that could be the reason, but one never
knows.
There a still a few leftover debug messages in CommitUnlockOsdSurface()
and I've added one in GetLockOsdSurface() could someone please uncomment
them and post what they report on a crash?
Stefans suggestions sound reasonable, hopefully with the debug messages
we will be able to track the problems down.

> That sounds very familiar to what I see!
> 
> It doesn't happen very often so it's difficult to track down!
> 
> :(
> 
> I'll try updating my ffmpeg (it's not that old but you never know) and 
> rebuilding DirectFB with the --enable-trace and --enable-debug options.
> 

I had a quick look at the code of DirectFB, it seems that the overload
the signal handlers in lib/direct/signals.c. I guess if we comment out
SIGSEGV in the initialization of the variable sigs_to_handle we should
again get a core dump. I hope that a proper core dump reveals more
information that the trace from DirectFB (Thank you Per for the trace,
unfortunately it didn't help me much...)

Bye,
Martin
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: osd_crash.diff
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060711/6755b881/attachment.ksh>

From per at mellander.org  Tue Jul 11 20:39:54 2006
From: per at mellander.org (Per Mellander)
Date: Tue, 11 Jul 2006 20:39:54 +0200
Subject: [Softdevice-devel] softdevice + libcle266mpegdec
In-Reply-To: <44B3D58E.8080101@gmx.net>
References: <20060710114955.M36064@mellander.org> <20060710194004.M45711@mellander.org> <200607102259.39220.stefan@lucke.in-berlin.de> <200607110907.22918.laz@club-burniston.co.uk> <44B3D58E.8080101@gmx.net>
Message-ID: <20060711181639.M99409@mellander.org>

On Tue, 11 Jul 2006 18:45:02 +0200, Martin Wache wrote

> I had a quick look at the code of DirectFB, it seems that the overload
> the signal handlers in lib/direct/signals.c. I guess if we comment out
> SIGSEGV in the initialization of the variable sigs_to_handle we should
> again get a core dump. I hope that a proper core dump reveals more
> information that the trace from DirectFB (Thank you Per for the trace,
> unfortunately it didn't help me much...)
> 

I did the commenting in signals.c. I do get a segfault now but no core dump. Is there
any other signal that must be commented out to have the system creating a core dump?

static int sigs_to_handle[] = { /*SIGALRM,*/ SIGHUP, SIGINT, /*SIGPIPE,*/ /*SIGPOLL,*/
                                SIGTERM, /*SIGUSR1, SIGUSR2,*/ /*SIGVTALRM,*/
                                /*SIGSTKFLT,*/ SIGABRT, SIGFPE, SIGILL, SIGQUIT,
                                /*SIGSEGV,*/ SIGTRAP, /*SIGSYS, SIGEMT,*/ SIGBUS,
                                SIGXCPU, SIGXFSZ };

/Per


From rahrenbe at cc.hut.fi  Tue Jul 11 20:54:54 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Tue, 11 Jul 2006 21:54:54 +0300 (EEST)
Subject: [Softdevice-devel] HOWTO libcle266mpegdec
In-Reply-To: <200607111511.55632.laz@club-burniston.co.uk>
References: <20060711122833.M94407@mellander.org> <200607111511.55632.laz@club-burniston.co.uk>
Message-ID: <Pine.OSF.4.61.0607112140560.349348@kosh.hut.fi>

On Tue, 11 Jul 2006, Laz wrote:

> On Tuesday 11 July 2006 13:38, Per Mellander wrote:
>> I've written some kind of a HOWTO for making use of the CLE266 hardware
>> decoding with softdevice. Could you ( Laz, Martin, Stefan etc. ) take a
>> look and comment before I drop the link on vdr ml?

You could also mention the "viatv" option.

> It would be nice to get libcle266mpegdec-0.1.tar.gz put somewhere more
> obvious like in the softdevice or DirectFB archives, though.

I already asked earlier in this ml if there are any volunteers for 
hosting the library, but ofcourse there were no responses.

There's an open question about the license as the library code is taken 
from libsoftmpeg-cle266-0.01 archive that was under LGPL. However the 
CLE266 code originates from mtest-0.1.1 archive that has an unique 
licence by Andreas Robinson. When I compiled the libcle266mpegdec-0.1 
archive together I made a crude mistake to include wrong COPYING file 
(GPL-2 instead of LGPL) into it and therefore I've stopped to host the 
library.

BR,
--
rofa


From per at mellander.org  Tue Jul 11 21:17:44 2006
From: per at mellander.org (Per Mellander)
Date: Tue, 11 Jul 2006 21:17:44 +0200
Subject: [Softdevice-devel] HOWTO libcle266mpegdec
In-Reply-To: <Pine.OSF.4.61.0607112140560.349348@kosh.hut.fi>
References: <20060711122833.M94407@mellander.org> <200607111511.55632.laz@club-burniston.co.uk> <Pine.OSF.4.61.0607112140560.349348@kosh.hut.fi>
Message-ID: <20060711185947.M48861@mellander.org>

On Tue, 11 Jul 2006 21:54:54 +0300 (EEST), Rolf Ahrenberg wrote
> On Tue, 11 Jul 2006, Laz wrote:
> 
> > On Tuesday 11 July 2006 13:38, Per Mellander wrote:
> >> I've written some kind of a HOWTO for making use of the CLE266 hardware
> >> decoding with softdevice. Could you ( Laz, Martin, Stefan etc. ) take a
> >> look and comment before I drop the link on vdr ml?
> 
> You could also mention the "viatv" option.

I'll have a look into that.

> 
> > It would be nice to get libcle266mpegdec-0.1.tar.gz put somewhere more
> > obvious like in the softdevice or DirectFB archives, though.
> 
> I already asked earlier in this ml if there are any volunteers for 
> hosting the library, but ofcourse there were no responses.
> 
> There's an open question about the license as the library code is taken 
> from libsoftmpeg-cle266-0.01 archive that was under LGPL. However the 
> CLE266 code originates from mtest-0.1.1 archive that has an unique 
> licence by Andreas Robinson. When I compiled the libcle266mpegdec-0.1 
> archive together I made a crude mistake to include wrong COPYING file 
> (GPL-2 instead of LGPL) into it and therefore I've stopped to host the 
> library.

I've got space to host it, not as good as having it with softdevice or DirectFB though.
Contact me if there's any interest. I've got space for additional mirrors too if there's
any interest. ( 10Mbit, Sweden. ) What needs to be done to sort out the license issue?
Merely a change of COPYING?

/Per


From per at mellander.org  Tue Jul 11 22:22:27 2006
From: per at mellander.org (Per Mellander)
Date: Tue, 11 Jul 2006 22:22:27 +0200
Subject: [Softdevice-devel] softdevice + libcle266mpegdec
In-Reply-To: <20060711181639.M99409@mellander.org>
References: <20060710114955.M36064@mellander.org> <20060710194004.M45711@mellander.org> <200607102259.39220.stefan@lucke.in-berlin.de> <200607110907.22918.laz@club-burniston.co.uk> <44B3D58E.8080101@gmx.net> <20060711181639.M99409@mellander.org>
Message-ID: <20060711201102.M26632@mellander.org>

Well, after pulling my head out of my arse and I made a "ulimit -c unlimited" I was able
to generate a core dump :D

--8<-----------------------------------------------------------------------------------

[root at localhost vdr-1.4.1]# gdb vdr core.2262 
GNU gdb Red Hat Linux (6.3.0.0-1.122rh)
Copyright 2004 Free Software Foundation, Inc.
GDB is free software, covered by the GNU General Public License, and you are
welcome to change it and/or distribute copies of it under certain conditions.
Type "show copying" to see the conditions.
There is absolutely no warranty for GDB.  Type "show warranty" for details.
This GDB was configured as "i386-redhat-linux-gnu"...Using host libthread_db library
"/lib/libthread_db.so.1".

Reading symbols from shared object read from target memory...done.
Loaded system supplied DSO at 0xffffe000
Core was generated by `./vdr --lirc -Psoftdevice -vo dfb:cle266'.
Program terminated with signal 11, Segmentation fault.

warning: svr4_current_sos: Can't read pathname for load map: Input/output error

Reading symbols from /usr/lib/libjpeg.so.62...done.
Loaded symbols for /usr/lib/libjpeg.so.62
Reading symbols from /lib/libpthread.so.0...done.
Loaded symbols for /lib/libpthread.so.0
Reading symbols from /lib/libdl.so.2...done.
Loaded symbols for /lib/libdl.so.2
Reading symbols from /lib/libcap.so.1...done.
Loaded symbols for /lib/libcap.so.1
Reading symbols from /usr/lib/libstdc++.so.6...done.
Loaded symbols for /usr/lib/libstdc++.so.6
Reading symbols from /lib/libm.so.6...done.
Loaded symbols for /lib/libm.so.6
Reading symbols from /lib/libgcc_s.so.1...done.
Loaded symbols for /lib/libgcc_s.so.1
Reading symbols from /lib/libc.so.6...done.
Loaded symbols for /lib/libc.so.6
Reading symbols from /lib/ld-linux.so.2...done.
Loaded symbols for /lib/ld-linux.so.2
Reading symbols from /usr/local/src/vdr-1.4.1/PLUGINS/lib/libvdr-softdevice.so.1.4.1...done.
Loaded symbols for ./PLUGINS/lib/libvdr-softdevice.so.1.4.1
Reading symbols from /usr/local/lib/libavformat.so.50...done.
Loaded symbols for /usr/local/lib/libavformat.so.50
Reading symbols from /usr/local/lib/libavcodec.so.51...done.
Loaded symbols for /usr/local/lib/libavcodec.so.51
Reading symbols from /usr/lib/libz.so.1...done.
Loaded symbols for /usr/lib/libz.so.1
Reading symbols from /usr/local/lib/libavutil.so.49...done.
Loaded symbols for /usr/local/lib/libavutil.so.49
Reading symbols from /usr/local/lib/libpostproc.so.51...done.
Loaded symbols for /usr/local/lib/libpostproc.so.51
Reading symbols from /lib/libasound.so.2...done.
Loaded symbols for /lib/libasound.so.2
Reading symbols from /usr/local/lib/libcle266mpegdec-0.1.so...done.
Loaded symbols for /usr/local/lib/libcle266mpegdec-0.1.so
Reading symbols from /usr/local/src/vdr-1.4.1/PLUGINS/lib/libsoftdevice-dfb.so.1.4.1...done.
Loaded symbols for ./PLUGINS/lib//libsoftdevice-dfb.so.1.4.1
Reading symbols from /usr/local/lib/libdfb++-0.9.so.26...done.
Loaded symbols for /usr/local/lib/libdfb++-0.9.so.26
Reading symbols from /usr/local/lib/libdirectfb-0.9.so.26...done.
Loaded symbols for /usr/local/lib/libdirectfb-0.9.so.26
Reading symbols from /usr/local/lib/libfusion-0.9.so.26...done.
Loaded symbols for /usr/local/lib/libfusion-0.9.so.26
Reading symbols from /usr/local/lib/libdirect-0.9.so.26...done.
Loaded symbols for /usr/local/lib/libdirect-0.9.so.26
Reading symbols from /usr/local/lib/directfb-0.9.26/systems/libdirectfb_fbdev.so...done.
Loaded symbols for /usr/local/lib/directfb-0.9.26/systems/libdirectfb_fbdev.so
Reading symbols from
/usr/local/lib/directfb-0.9.26/inputdrivers/libdirectfb_ps2mouse.so...done.
Loaded symbols for /usr/local/lib/directfb-0.9.26/inputdrivers/libdirectfb_ps2mouse.so
Reading symbols from
/usr/local/lib/directfb-0.9.26/inputdrivers/libdirectfb_linux_input.so...done.
Loaded symbols for /usr/local/lib/directfb-0.9.26/inputdrivers/libdirectfb_linux_input.so
Reading symbols from
/usr/local/lib/directfb-0.9.26/gfxdrivers/libdirectfb_unichrome.so...done.
Loaded symbols for /usr/local/lib/directfb-0.9.26/gfxdrivers/libdirectfb_unichrome.so
Reading symbols from /usr/local/lib/directfb-0.9.26/wm/libdirectfbwm_default.so...done.
Loaded symbols for /usr/local/lib/directfb-0.9.26/wm/libdirectfbwm_default.so
#0  0xb58a4b4f in fast_memcpy (to=0xb501e800, from=0x9307db70, len=736) at utils.c:831
831                     : : "r" (from), "r" (to) : "memory");
(gdb) bt
#0  0xb58a4b4f in fast_memcpy (to=0xb501e800, from=0x9307db70, len=736) at utils.c:831
#1  0xb58a912f in cDFBVideoOut::YUV (this=0x8205620, buf=0xb78b33c0) at video-dfb.c:1355
#2  0xb58a58ec in cVideoOut::DrawStill_420pl (this=0x8205620, buf=0xb78b33c0) at video.c:468
#3  0xb58a60d5 in cVideoOut::Action (this=0x8205620) at video.c:133
#4  0x080f33ec in cThread::StartThread (Thread=0x8205a7c) at thread.c:244
#5  0x00a1b3b6 in start_thread () from /lib/libpthread.so.0
#6  0x0096733e in clone () from /lib/libc.so.6
Current language:  auto; currently c++
(gdb) 

--8<-----------------------------------------------------------------------------------

I then started vdr from within gdb and got a new segfault.
I left out some of the logging for readability purposes.

--8<-----------------------------------------------------------------------------------
[root at localhost vdr-1.4.1]# gdb vdr
(gdb) run  --lirc -P"softdevice -vo dfb:cle266"

........

[surface capabilities] videoSurface: videoonly double-buffered flipping (-) [Main Thread
      3.725] ( 2309) IDirectFBSurface:  IDirectFBSurface_GetPixelFormat( 0x830d7a8 )
PixelFormat = 0x08100609 
[dfb] (re)configured 0x08100609
[softdevice] Subplugin successfully opend
[softdevice] Video Out seems to be OK
[softdevice] Initializing Audio Out
[softdevice] Audio out seems to be OK
[softdevice] A/V devices initialized, now initializing MPEG2 Decoder
[New Thread -1343710304 (LWP 2322)]
(-) [Main Thread       3.750] ( 2309) IDirectFBSurface:  IDirectFBSurface_Clear( 0x82a6c70 )
(-) [Main Thread       3.750] ( 2309) Core/Surface:      dfb_surface_hardware_lock(
0x82a6a90, w, back )
(-) [Main Thread       3.750] ( 2309) Core/Surface:        -> video only, counter: 1
(-) [Main Thread       3.750] ( 2309) Core/Surface:      dfb_surface_unlock( 0x82a6a90,
back )
(-) [Main Thread       3.750] ( 2309) Core/Surface:        -> system/video count: 0/1 before
(-) [Main Thread       3.750] ( 2309) Core/Surface:        -> system/video count: 0/0 after
(-) [Main Thread       3.750] ( 2309) Core/Layers:       dfb_layer_region_flip_update(
0x82a6918, 0xbfabdefc, 0x00000000 ) <- [0, 0 - 720x576]
(-) [Main Thread       3.750] ( 2309) Core/Layers:         -> Going to swap buffers...
(-) [Main Thread       3.750] ( 2309) Core/Layers:         -> Waiting for pending writes...
(-) [Main Thread       3.751] ( 2309) Core/Layers:         -> Flipping region using
driver...
(-) [Main Thread       3.751] ( 2309) Core/Surface:      dfb_surface_flip_buffers(
0x82a6a90, false )
(-) [Main Thread       3.751] ( 2309) Core/Surface:      dfb_surface_notify_listeners(
0x82a6a90, 0x00000010 )
(-) [Main Thread       3.751] ( 2309) Core/Layers:      
_dfb_layer_region_surface_listener( 0xbfabde04, 0x82a6918 ) <- 0x00000010
(-) [Main Thread       3.751] ( 2309) IDirectFBSurface:  IDirectFBSurface_listener(
0xbfabde04, 0x82a6c70 )
(-) [Main Thread       3.751] ( 2309) Core/Layers:         -> done.
(-) [Main Thread       3.751] ( 2309) IDirectFBSurface:  IDirectFBSurface_Clear( 0x82a6c70 )
(-) [Main Thread       3.752] ( 2309) Core/Surface:      dfb_surface_hardware_lock(
0x82a6a90, w, back )
(-) [Main Thread       3.822] ( 2309) Core/Surface:        -> video only, counter: 1
(-) [Main Thread       3.823] ( 2309) Core/Surface:      dfb_surface_unlock( 0x82a6a90,
back )
(-) [Main Thread       3.823] ( 2309) Core/Surface:        -> system/video count: 0/1 before
(-) [Main Thread       3.823] ( 2309) Core/Surface:        -> system/video count: 0/0 after
(-) [Main Thread       3.875] ( 2309) IDirectFBSurface:  IDirectFBSurface_Lock( 0x82a6c70 )
(-) [Main Thread       3.875] ( 2309) Core/Surface:      dfb_surface_soft_lock(
0x82a6a90, w, back )
(-) [Main Thread       3.875] ( 2309) Core/Surface:      dfb_surface_software_lock(
0x82a6a90, w, back )
(-) [Main Thread       3.875] ( 2309) Core/Surface:        -> video only, counter: 1
(-) [Main Thread       3.876] ( 2309) Core/Surface:        -> 0xb3f01000 [2880]
(-) [Main Thread       3.924] ( 2309) IDirectFBSurface:  IDirectFBSurface_Unlock(
0x82a6c70 )
(-) [Main Thread       3.924] ( 2309) Core/Surface:      dfb_surface_unlock( 0x82a6a90,
back )
(-) [Main Thread       3.924] ( 2309) Core/Surface:        -> system/video count: 0/1 before
(-) [Main Thread       3.924] ( 2309) Core/Surface:        -> system/video count: 0/0 after
(-) [Main Thread       3.924] ( 2309) Core/Layers:       dfb_layer_region_flip_update(
0x82a6918, 0xbfabdfbc, 0x00000000 ) <- [0, 0 - 720x576]
(-) [Main Thread       3.924] ( 2309) Core/Layers:         -> Going to swap buffers...
(-) [Main Thread       3.925] ( 2309) Core/Layers:         -> Waiting for pending writes...
(-) [Main Thread       3.925] ( 2309) Core/Layers:         -> Flipping region using
driver...
(-) [Main Thread       3.925] ( 2309) Core/Surface:      dfb_surface_flip_buffers(
0x82a6a90, false )
(-) [Main Thread       3.925] ( 2309) Core/Surface:      dfb_surface_notify_listeners(
0x82a6a90, 0x00000010 )
(-) [Main Thread       3.925] ( 2309) Core/Layers:      
_dfb_layer_region_surface_listener( 0xbfabdec4, 0x82a6918 ) <- 0x00000010
(-) [Main Thread       3.925] ( 2309) IDirectFBSurface:  IDirectFBSurface_listener(
0xbfabdec4, 0x82a6c70 )
(-) [Main Thread       3.925] ( 2309) Core/Layers:         -> done.
(-) [Main Thread       3.925] ( 2309) IDirectFBSurface: 
IDirectFBSurface_SetBlittingFlags( 0x82a6c70 )
(-) [Main Thread       3.925] ( 2309) IDirectFBSurface:  IDirectFBSurface_Blit( 0x82a6c70 )
(-) [Main Thread       3.925] ( 2309) Core/Surface:      dfb_surface_hardware_lock(
0x82a6a90, r, front )
(-) [Main Thread       3.926] ( 2309) Core/Surface:        -> video only, counter: 1
(-) [Main Thread       3.926] ( 2309) Core/Surface:      dfb_surface_hardware_lock(
0x82a6a90, w, back )
(-) [Main Thread       3.926] ( 2309) Core/Surface:        -> video only, counter: 1
(-) [Main Thread       3.926] ( 2309) Core/Surface:      dfb_surface_unlock( 0x82a6a90,
back )
(-) [Main Thread       3.926] ( 2309) Core/Surface:        -> system/video count: 0/1 before
(-) [Main Thread       3.926] ( 2309) Core/Surface:        -> system/video count: 0/0 after
(-) [Main Thread       3.926] ( 2309) Core/Surface:      dfb_surface_unlock( 0x82a6a90,
front )
(-) [Main Thread       3.926] ( 2309) Core/Surface:        -> system/video count: 0/1 before
(-) [Main Thread       3.926] ( 2309) Core/Surface:        -> system/video count: 0/0 after
[New Thread -1354118240 (LWP 2323)]
(-) [  NO NAME         6.463] ( 2317) IDirectFBSurface:  IDirectFBSurface_Lock( 0x830d7a8 )
(-) [  NO NAME         6.463] ( 2317) Core/Surface:      dfb_surface_soft_lock(
0x82d3510, w, back )
(-) [  NO NAME         6.463] ( 2317) Core/Surface:      dfb_surface_software_lock(
0x82d3510, w, back )
(-) [  NO NAME         6.463] ( 2317) Core/Surface:        -> video only, counter: 1
(-) [  NO NAME         6.463] ( 2317) Core/Surface:        -> 0xb5e24c00 [736]

Program received signal SIGSEGV, Segmentation fault.
[Switching to Thread -1224262752 (LWP 2317)]
0xb6066b4f in fast_memcpy (to=0xb5e24c00, from=0x92fffb70, len=736) at utils.c:831
831                     : : "r" (from), "r" (to) : "memory");
Current language:  auto; currently c++
(gdb) bt
#0  0xb6066b4f in fast_memcpy (to=0xb5e24c00, from=0x92fffb70, len=736) at utils.c:831
#1  0xb606b12f in cDFBVideoOut::YUV (this=0x8208078, buf=0xb70733c0) at video-dfb.c:1355
#2  0xb60678ec in cVideoOut::DrawStill_420pl (this=0x8208078, buf=0xb70733c0) at video.c:468
#3  0xb60680d5 in cVideoOut::Action (this=0x8208078) at video.c:133
#4  0x080f33ec in cThread::StartThread (Thread=0x82084d4) at thread.c:244
#5  0x00a1b3b6 in start_thread () from /lib/libpthread.so.0
#6  0x0096733e in clone () from /lib/libc.so.6
(gdb) 

--8<-----------------------------------------------------------------------------------

/Per


From M.Wache at gmx.net  Tue Jul 11 22:26:36 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 11 Jul 2006 22:26:36 +0200
Subject: [Softdevice-devel] softdevice + libcle266mpegdec
In-Reply-To: <20060711181639.M99409@mellander.org>
References: <20060710114955.M36064@mellander.org> <20060710194004.M45711@mellander.org> <200607102259.39220.stefan@lucke.in-berlin.de> <200607110907.22918.laz@club-burniston.co.uk> <44B3D58E.8080101@gmx.net> <20060711181639.M99409@mellander.org>
Message-ID: <44B4097C.4020101@gmx.net>

Per Mellander schrieb:
> On Tue, 11 Jul 2006 18:45:02 +0200, Martin Wache wrote
> 
>> I had a quick look at the code of DirectFB, it seems that the overload
>> the signal handlers in lib/direct/signals.c. I guess if we comment out
>> SIGSEGV in the initialization of the variable sigs_to_handle we should
>> again get a core dump. I hope that a proper core dump reveals more
>> information that the trace from DirectFB (Thank you Per for the trace,
>> unfortunately it didn't help me much...)
>>
> 
> I did the commenting in signals.c. I do get a segfault now but no core dump. Is there
> any other signal that must be commented out to have the system creating a core dump?
> 
> static int sigs_to_handle[] = { /*SIGALRM,*/ SIGHUP, SIGINT, /*SIGPIPE,*/ /*SIGPOLL,*/
>                                 SIGTERM, /*SIGUSR1, SIGUSR2,*/ /*SIGVTALRM,*/
>                                 /*SIGSTKFLT,*/ SIGABRT, SIGFPE, SIGILL, SIGQUIT,
>                                 /*SIGSEGV,*/ SIGTRAP, /*SIGSYS, SIGEMT,*/ SIGBUS,
>                                 SIGXCPU, SIGXFSZ };
> 

I tried it too, I get a core dump only by commenting out SIGSEV, like
you did. Did you enable core dumps in the bash (ulimit -c unlimited)?

Bye,
Martin


From M.Wache at gmx.net  Tue Jul 11 22:52:53 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 11 Jul 2006 22:52:53 +0200
Subject: [Softdevice-devel] softdevice + libcle266mpegdec
In-Reply-To: <20060711201102.M26632@mellander.org>
References: <20060710114955.M36064@mellander.org> <20060710194004.M45711@mellander.org> <200607102259.39220.stefan@lucke.in-berlin.de> <200607110907.22918.laz@club-burniston.co.uk> <44B3D58E.8080101@gmx.net> <20060711181639.M99409@mellander.org> <20060711201102.M26632@mellander.org>
Message-ID: <44B40FA5.1010106@gmx.net>

Per Mellander schrieb:

> #0  0xb58a4b4f in fast_memcpy (to=0xb501e800, from=0x9307db70, len=736) at utils.c:831
> 831                     : : "r" (from), "r" (to) : "memory");
> (gdb) bt
> #0  0xb58a4b4f in fast_memcpy (to=0xb501e800, from=0x9307db70, len=736) at utils.c:831
> #1  0xb58a912f in cDFBVideoOut::YUV (this=0x8205620, buf=0xb78b33c0) at video-dfb.c:1355
> #2  0xb58a58ec in cVideoOut::DrawStill_420pl (this=0x8205620, buf=0xb78b33c0) at video.c:468
> #3  0xb58a60d5 in cVideoOut::Action (this=0x8205620) at video.c:133
> #4  0x080f33ec in cThread::StartThread (Thread=0x8205a7c) at thread.c:244
> #5  0x00a1b3b6 in start_thread () from /lib/libpthread.so.0
> #6  0x0096733e in clone () from /lib/libc.so.6
> Current language:  auto; currently c++
> (gdb) 

Ah, that's much better. So the crash comes from the video thread,
redrawing the video layer...
I'm still not sure what could go wrong.. Maybe the CheckArea() is not
called properly?? Could you please post a "bt full", or at least a
"print *buf" and a if possible print of *vout or *this? I would like to
see what the values the variables of cDFBVideoOut are.

Thank you,

Martin


From M.Wache at gmx.net  Tue Jul 11 23:02:55 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 11 Jul 2006 23:02:55 +0200
Subject: [Softdevice-devel] HOWTO libcle266mpegdec
In-Reply-To: <20060711122833.M94407@mellander.org>
References: <20060711122833.M94407@mellander.org>
Message-ID: <44B411FF.8060009@gmx.net>

Per Mellander schrieb:
> I've written some kind of a HOWTO for making use of the CLE266 hardware decoding with
> softdevice. Could you ( Laz, Martin, Stefan etc. ) take a look and comment before I drop
> the link on vdr ml?
>

Looks good to me!
However you can remove the point about adding FFMPEG_VERSION to
softdevice.c. I just removed it, it was anyway not as relevant as the
ffmepg build number...


> http://www.mellander.org/per/projects/linux/?chapter=epia-hw-cle266
> 
> I'm not really sure concerning prerequisites ( i.e ffmpeg ). And if someone could drop
> me a line explaining the technical behind I would be glad to incorporate it.
> 
Hmm, what do you want to know? If you have some specific questions I
will happily try to answer them :-)

Bye,
Martin


From per at mellander.org  Tue Jul 11 23:03:32 2006
From: per at mellander.org (Per Mellander)
Date: Tue, 11 Jul 2006 23:03:32 +0200
Subject: [Softdevice-devel] softdevice + libcle266mpegdec
In-Reply-To: <44B40FA5.1010106@gmx.net>
References: <20060710114955.M36064@mellander.org> <20060710194004.M45711@mellander.org> <200607102259.39220.stefan@lucke.in-berlin.de> <200607110907.22918.laz@club-burniston.co.uk> <44B3D58E.8080101@gmx.net> <20060711181639.M99409@mellander.org> <20060711201102.M26632@mellander.org> <44B40FA5.1010106@gmx.net>
Message-ID: <20060711210135.M2502@mellander.org>

On Tue, 11 Jul 2006 22:52:53 +0200, Martin Wache wrote
> I'm still not sure what could go wrong.. Maybe the CheckArea() is not
> called properly?? Could you please post a "bt full", or at least a
> "print *buf" and a if possible print of *vout or *this? I would like to
> see what the values the variables of cDFBVideoOut are.
> 

This is what I got, maybe I'm not doing it correctly?


Program received signal SIGSEGV, Segmentation fault.
[Switching to Thread -1216418912 (LWP 2567)]
0xb5fe0b4f in fast_memcpy (to=0xb5d9ec00, from=0x936f4b70, len=736) at utils.c:831
831                     : : "r" (from), "r" (to) : "memory");
Current language:  auto; currently c++
(gdb) bt full
#0  0xb5fe0b4f in fast_memcpy (to=0xb5d9ec00, from=0x936f4b70, len=736) at utils.c:831
        delta = Variable "delta" is not available.
(gdb) print *buf
$1 = 0 '\0'
(gdb) print *vout
No symbol "vout" in current context.
(gdb) print *this
No symbol "this" in current context.
(gdb) bt
#0  0xb5fe0b4f in fast_memcpy (to=0xb5d9ec00, from=0x936f4b70, len=736) at utils.c:831
#1  0xb5fe512f in cDFBVideoOut::YUV (this=0x8208110, buf=0xb77ee3c0) at video-dfb.c:1355
#2  0xb5fe18ec in cVideoOut::DrawStill_420pl (this=0x8208110, buf=0xb77ee3c0) at video.c:468
#3  0xb5fe20d5 in cVideoOut::Action (this=0x8208110) at video.c:133
#4  0x080f33ec in cThread::StartThread (Thread=0x820856c) at thread.c:244
#5  0x00a1b3b6 in start_thread () from /lib/libpthread.so.0
#6  0x0096733e in clone () from /lib/libc.so.6
(gdb) 

/Per



From rahrenbe at cc.hut.fi  Wed Jul 12 01:17:10 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Wed, 12 Jul 2006 02:17:10 +0300 (EEST)
Subject: [Softdevice-devel] HOWTO libcle266mpegdec
In-Reply-To: <20060711185947.M48861@mellander.org>
References: <20060711122833.M94407@mellander.org> <200607111511.55632.laz@club-burniston.co.uk>
 <Pine.OSF.4.61.0607112140560.349348@kosh.hut.fi> <20060711185947.M48861@mellander.org>
Message-ID: <Pine.OSF.4.61.0607120150370.200724@kosh.hut.fi>

On Tue, 11 Jul 2006, Per Mellander wrote:

> I've got space to host it, not as good as having it with softdevice or DirectFB though.

Nice. At least the library and HOWTO would be together...

> Contact me if there's any interest. I've got space for additional mirrors too if there's
> any interest. ( 10Mbit, Sweden. ) What needs to be done to sort out the license issue?
> Merely a change of COPYING?

Well, after checking the copyright headers again, it seems to be the MIT 
license (http://en.wikipedia.org/wiki/MIT_License) that's GPL 
compatible, so I'd use it for the whole package (for example FSF's 
ncurses package is under MIT license instead of GPL). But the hwdec.[ch] 
is missing a license header (and cle266mpegdec.h too), and mtest's 
dfb-test.c suggests that's hwdec would be public domain code. However, 
README.txt suggests that everything would be GPL code... As I'm not a 
lawyer I really don't what would be the correct move.

Also the softdevice patch should be removed as it's not required 
anymore.

--
rofa


From stefan at lucke.in-berlin.de  Wed Jul 12 06:51:41 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 12 Jul 2006 06:51:41 +0200
Subject: [Softdevice-devel] softdevice + libcle266mpegdec
In-Reply-To: <44B40FA5.1010106@gmx.net>
References: <20060710114955.M36064@mellander.org> <20060711201102.M26632@mellander.org> <44B40FA5.1010106@gmx.net>
Message-ID: <200607120651.42052.stefan@lucke.in-berlin.de>

On Dienstag 11 Juli 2006 22:52, Martin Wache wrote:
> Per Mellander schrieb:
> 
> > #0  0xb58a4b4f in fast_memcpy (to=0xb501e800, from=0x9307db70, len=736) at utils.c:831
> > 831                     : : "r" (from), "r" (to) : "memory");
> > (gdb) bt
> > #0  0xb58a4b4f in fast_memcpy (to=0xb501e800, from=0x9307db70, len=736) at utils.c:831
> > #1  0xb58a912f in cDFBVideoOut::YUV (this=0x8205620, buf=0xb78b33c0) at video-dfb.c:1355
> > #2  0xb58a58ec in cVideoOut::DrawStill_420pl (this=0x8205620, buf=0xb78b33c0) at video.c:468
> > #3  0xb58a60d5 in cVideoOut::Action (this=0x8205620) at video.c:133
> > #4  0x080f33ec in cThread::StartThread (Thread=0x8205a7c) at thread.c:244
> > #5  0x00a1b3b6 in start_thread () from /lib/libpthread.so.0
> > #6  0x0096733e in clone () from /lib/libc.so.6
> > Current language:  auto; currently c++
> > (gdb) 
> 
> Ah, that's much better. So the crash comes from the video thread,
> redrawing the video layer...
> I'm still not sure what could go wrong.. Maybe the CheckArea() is not
> called properly?? Could you please post a "bt full", or at least a
> "print *buf" and a if possible print of *vout or *this? I would like to
> see what the values the variables of cDFBVideoOut are.

edge_width & edge_height are not initialized in case of redrawing
without old_picture.
So a:
 tmpBuf.edge_width = tmpBuf.edge_height = 0;
at line 124 in video.c should/could fix this.

-- 
Stefan Lucke


From per at mellander.org  Wed Jul 12 10:19:27 2006
From: per at mellander.org (Per Mellander)
Date: Wed, 12 Jul 2006 10:19:27 +0200
Subject: [Softdevice-devel] softdevice + libcle266mpegdec
In-Reply-To: <200607120651.42052.stefan@lucke.in-berlin.de>
References: <20060710114955.M36064@mellander.org> <20060711201102.M26632@mellander.org> <44B40FA5.1010106@gmx.net> <200607120651.42052.stefan@lucke.in-berlin.de>
Message-ID: <20060712081721.M33648@mellander.org>

On Wed, 12 Jul 2006 06:51:41 +0200, Stefan Lucke wrote
> 
> edge_width & edge_height are not initialized in case of redrawing
> without old_picture.
> So a:
>  tmpBuf.edge_width = tmpBuf.edge_height = 0;
> at line 124 in video.c should/could fix this.


That seems to solve the problem. I've done numerous reboots and it always start without
core dump / sig 11 now.

Thank you!

/Per


From laz at club-burniston.co.uk  Wed Jul 12 11:02:22 2006
From: laz at club-burniston.co.uk (Laz)
Date: Wed, 12 Jul 2006 10:02:22 +0100
Subject: [Softdevice-devel] softdevice + libcle266mpegdec
In-Reply-To: <20060712081721.M33648@mellander.org>
References: <20060710114955.M36064@mellander.org> <200607120651.42052.stefan@lucke.in-berlin.de> <20060712081721.M33648@mellander.org>
Message-ID: <200607121002.22315.laz@club-burniston.co.uk>

On Wednesday 12 July 2006 09:19, Per Mellander wrote:
> On Wed, 12 Jul 2006 06:51:41 +0200, Stefan Lucke wrote
>
> > edge_width & edge_height are not initialized in case of redrawing
> > without old_picture.
> > So a:
> >  tmpBuf.edge_width = tmpBuf.edge_height = 0;
> > at line 124 in video.c should/could fix this.
>
> That seems to solve the problem. I've done numerous reboots and it
> always start without core dump / sig 11 now.

I've just upgraded softdevice to current CVS and added that line to see if 
it cures my occasional seg faults...

:)

Should this give me a core dump if it barfs or do I need to play about 
with the signals and rebuild DirectFB as well for that?

Cheers,

Laz


From stefan at lucke.in-berlin.de  Wed Jul 12 20:40:44 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 12 Jul 2006 20:40:44 +0200
Subject: [Softdevice-devel] softdevice + libcle266mpegdec
In-Reply-To: <200607121002.22315.laz@club-burniston.co.uk>
References: <20060710114955.M36064@mellander.org> <20060712081721.M33648@mellander.org> <200607121002.22315.laz@club-burniston.co.uk>
Message-ID: <200607122040.44168.stefan@lucke.in-berlin.de>

On Mittwoch 12 Juli 2006 11:02, Laz wrote:
> On Wednesday 12 July 2006 09:19, Per Mellander wrote:
> > On Wed, 12 Jul 2006 06:51:41 +0200, Stefan Lucke wrote
> >
> > > edge_width & edge_height are not initialized in case of redrawing
> > > without old_picture.
> > > So a:
> > >  tmpBuf.edge_width = tmpBuf.edge_height = 0;
> > > at line 124 in video.c should/could fix this.
> >
> > That seems to solve the problem. I've done numerous reboots and it
> > always start without core dump / sig 11 now.
> 
> I've just upgraded softdevice to current CVS and added that line to see if 
> it cures my occasional seg faults...
> 
> :)
> 
> Should this give me a core dump if it barfs or do I need to play about 
> with the signals and rebuild DirectFB as well for that?

You'll get a core dump only if you modify DirectFB/lib/direct/signals.c .
edge_with and co is definitly (? stack gets overwritten buf == NULL in YUV() )
the cause as you may see here (thats with gdb command: bt full):

#0  0xb5843227 in fast_memcpy (to=0xb4a61800, from=0x94c50ed0, len=32) at utils.c:814
        delta = 0
        retval = (void *) 0xb4a61800
        i = 11
#1  0xb58488f9 in cDFBVideoOut::YUV (this=0x8214480, buf=0x0) at video-dfb.c:1355
        currentFB = 11
        dst = (uint8_t *) 0xb4a61800 <Address 0xb4a61800 out of bounds>
        pitch = 736
        hi = 0
        Py = (uint8_t *) 0x94c50ed0 <Address 0x94c50ed0 out of bounds>
        Pu = (uint8_t *) 0xadb6c184 <Address 0xadb6c184 out of bounds>
        Pv = (uint8_t *) 0xadb85f94 <Address 0xadb85f94 out of bounds>
        Width = 736
        Height = 576
#2  0xb5844884 in cVideoOut::DrawStill_420pl (this=0x8214480, buf=0xb70513c0) at video.c:466
No locals.
#3  0xb5843dc1 in cVideoOut::Action (this=0x8214480) at video.c:131
        tmpBuf = {format = -1224403988, pixel = {0xb574a008 "", 0x8216180 '\177' <repeats 200 times>...,
    0x822ff90 '\177' <repeats 200 times>..., 0x81e77a0 ""}, stride = {736, 368, 368, -1209297397}, use_count = 3085689680,
  buf_num = -1224403976, max_width = 736, max_height = 576, owner = 0x81e77a0, edge_width = -1224403928,
  edge_height = 135136243, width = 736, height = 576, dtg_active_format = 0, aspect_ratio = 1.27777779, pts = 0,
  interlaced_frame = false, pict_type = 136163856, pic_num = 136214416, age = -1208975436, priv_data = 0x17b}
#4  0x081063fb in cThread::StartThread (Thread=0x82148dc) at thread.c:244

I fixed that in another way: memset (&tmpBuf, 0, sizeof (sPicBuffer)); .

-- 
Stefan Lucke


From torgeir at pobox.com  Fri Jul 14 00:36:29 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Thu, 13 Jul 2006 23:36:29 +0100
Subject: [Softdevice-devel] pseudo alpha mmx2
Message-ID: <44B6CAED.8030502@pobox.com>

The new mmx2 code doing pseudo alpha (aka dithering) doesn't seem to 
dither like the old non mmx2 code did. Instead of using a checker 
pattern it uses vertical black lines. This obviously doesn't look too nice.


The old code used the check

do_dither = ((x % 2 == 1 && y % 2 == 1) ||
              (x % 2 == 1 && y % 2 == 0) || prev_pix);

the new code is (as long as mmx2 is not enabled)

if ( IS_BACKGROUND(GET_A(c)) && (((intptr_t)dest) & 0x4) )

which doesn't seem to take into account that the check needs to be 
different for every second line.

A better check would be something like

if ( IS_BACKGROUND(GET_A(c)) && (
   ((intptr_t)dest) & 0x04 && ((((intptr_t)dest) / (1280*4)) % 2) || 

   (((intptr_t)dest)+0x04) & 0x04 && (((((intptr_t)dest) / (1280*4)) % 
2) == 0)
)) {

but here the horizontal width (1280) is hardcoded and I'm not sure how 
to translate this into mmx code. Ideas?


-- 
-Torgeir


From Neumann at do-net.de  Fri Jul 14 10:23:54 2006
From: Neumann at do-net.de (Andre Neumann)
Date: Fri, 14 Jul 2006 10:23:54 +0200
Subject: [Softdevice-devel] live HDTV channel not playing smooth
Message-ID: <FB3B5DB3197CEA429E5FB8E83D01D0390D92AC@sbs2003.do-net.de>

Hi,

Yesterday i've done some test with higher packet_buf_size for live HDTV
playback.
I changed   int packet_buf_size[] = {300,150,2000};
to          int packet_buf_size[] = {300,150,6000};
and also to int packet_buf_size[] = {300,150,12000};

That cause the ringbuffer to fill later, but the problem is still there.

I've also changed the dvb_buf_size to 128*1024 but it wont help.

Could you post the patch with more debugging infos ?

-------------
Andre Neumann
 
> Yes, probably you are right, please try to increase the buffersizes in
> mpeg2decoder.c:
> 
> 
> // 0: save buffers, 1: good seeking, 2: HDTV buffers
> int dvb_buf_size[] = {64*1024,32*1024,64*1024};
> int packet_buf_size[] = {300,150,2000};
> 
> The last one is the relevant one of HDTV playback, please try 
> to change
> packet_buf_size first and if you find values that are working for you
> please report them.
> If you don't find any values I will send you a patch which will
> introduce some more debugging infos.
> 
> Bye,
> Martin
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/softdevice-devel
> 
> 
> 



From per at mellander.org  Fri Jul 14 12:48:34 2006
From: per at mellander.org (Per Mellander)
Date: Fri, 14 Jul 2006 12:48:34 +0200
Subject: [Softdevice-devel] Some issues regarding libcle266mpegdec
Message-ID: <20060714093841.M9774@mellander.org>

Hi!

As you probably know I've done some testing of the libcle266mpegdec lately and I've got
a few questions.

I've been doing the major testing against a 15" (computer)LCD and lately started using
my 40" Samsung (TV). All my testing has been @ 1024x768 and there is a few issues I
still haven't figured out.

On the 40" display ( btw. I use VGA output ), I have problems with the OSD. That is I
get random black lines all over the OSD part. The same size as the underlaying text on
the console. They disapper when I a) press 'Menu', b) OSD time out. I haven't seen it on
the small LCD though? When the console screen saver kicks in, even when I have done
'setterm -blank 0, I'm also getting this artifacts. As I said it only happens on my 40" LCD.

What is the status of the deinterlacing? I've tested a few setting but my screen get
kind of blueish and it starts to framedrop. dfbinfo gives:

Screen (00) FBDev Primary Screen            (primary screen)
   Caps: VSYNC POWER_MANAGEMENT 

     Layer (00) VIA CLE266 Graphics             (primary layer)
        Type:    GRAPHICS 
        Caps:    SURFACE OPACITY ALPHACHANNEL SRC_COLORKEY BRIGHTNESS CONTRAST SATURATION 

     Layer (01) VIA Unichrome Video           
        Type:    GRAPHICS VIDEO STILL_PICTURE 
        Caps:    SURFACE OPACITY SCREEN_LOCATION DEINTERLACING DST_COLORKEY LEVELS
FIELD_PARITY SCREEN_POSITION SCREEN_SIZE 

     Layer (02) VIA Unichrome DVD Subpicture  
        Type:    GRAPHICS VIDEO STILL_PICTURE 
        Caps:    SURFACE OPACITY 


I thought that DEINTERLACING referred to HW capabilities. Guess I'm wrong.

Last question. Does anyone know how to make directfb/linux-viafb to comply to 1360x768?
If I try to add it to fb.modes and do a fbset I'm getting,

ioctl FBIOPUT_VSCREENINFO: Invalid argument

wich I interpret that there is something to be done to linux-viafb. I can see that the
resolution that I want is not listed ;) Can someone please put me in the right direction
to add this resolution?

/Per



From torgeir at pobox.com  Fri Jul 14 12:55:29 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Fri, 14 Jul 2006 11:55:29 +0100
Subject: [Softdevice-devel] Some issues regarding libcle266mpegdec
In-Reply-To: <20060714093841.M9774@mellander.org>
References: <20060714093841.M9774@mellander.org>
Message-ID: <44B77821.5050608@pobox.com>

Per Mellander wrote:

> Last question. Does anyone know how to make directfb/linux-viafb to comply to 1360x768?
> If I try to add it to fb.modes and do a fbset I'm getting,
> 
> ioctl FBIOPUT_VSCREENINFO: Invalid argument
> 
> wich I interpret that there is something to be done to linux-viafb. I can see that the
> resolution that I want is not listed ;) Can someone please put me in the right direction
> to add this resolution?

What does your relevant lines in fb.modes look like? Maybe there's just 
an error you've overlooked?

-- 
-Torgeir


From torgeir at pobox.com  Fri Jul 14 13:05:45 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Fri, 14 Jul 2006 12:05:45 +0100
Subject: [Softdevice-devel] Some issues regarding libcle266mpegdec
In-Reply-To: <44B77821.5050608@pobox.com>
References: <20060714093841.M9774@mellander.org> <44B77821.5050608@pobox.com>
Message-ID: <44B77A89.8040406@pobox.com>

Torgeir Veimo wrote:
> Per Mellander wrote:
> 
>> Last question. Does anyone know how to make directfb/linux-viafb to comply to 1360x768?
>> If I try to add it to fb.modes and do a fbset I'm getting,
>>
>> ioctl FBIOPUT_VSCREENINFO: Invalid argument
>>
>> wich I interpret that there is something to be done to linux-viafb. I can see that the
>> resolution that I want is not listed ;) Can someone please put me in the right direction
>> to add this resolution?
> 
> What does your relevant lines in fb.modes look like?

Try this one if you haven't put any such modes in yet:

mode "1360x768-48"
     geometry 1360 768 1920 25 16
     timings 15385 160 24 29 3 136 6
endmode

You can also try these, even if they don't match your tvs native resolution:

# 50 Hz
mode "1280x720-50"
    # D: 61.80 MHz, H: 37.50 kHz, V: 50.00 Hz
    geometry 1280 720 1280 720 32
    timings 16181 218 110 20 5 40 5
endmode

# 60 Hz from X setup
mode "1280x720-60"
    # D: 74.25 MHz, H: 45.00 kHz, V: 60.00 Hz
    geometry 1280 720 1280 720 16
    timings 13468 220 110 20 5 40 5
endmode


-- 
-Torgeir


From karl.glatz at googlemail.com  Fri Jul 14 18:12:08 2006
From: karl.glatz at googlemail.com (Karl Glatz)
Date: Fri, 14 Jul 2006 18:12:08 +0200
Subject: [Softdevice-devel] configure Patch for Ubuntu 6.06 (using
	ffmpeg-config instead of pkg-config)
Message-ID: <d5c44b7f0607140912u12340800y6e344433cfae96b9@mail.gmail.com>

Hello,

because I was tired to change the config values every time by hand (c&p from
ffmpeg-config).
I've modified your configure script to work with Ubuntu 6.06. Now it tries
the ffmpeg-config too (only if pkg-config and the --ffmpeg-path method
fails).

Here is my little work, for anyone who's interesed in...

Patch is made against todays CVS.

greets
Karl 'loeppel' Glatz
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060714/8d3155ac/attachment.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: configure.patch
Type: text/x-patch
Size: 1435 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060714/8d3155ac/attachment.bin>

From karl.glatz at googlemail.com  Fri Jul 14 18:42:36 2006
From: karl.glatz at googlemail.com (Karl Glatz)
Date: Fri, 14 Jul 2006 18:42:36 +0200
Subject: [Softdevice-devel] XV: gnome-panel appers on top even if fullscreen
	is used!
Message-ID: <d5c44b7f0607140942xa9d65eejfa3c5011404a6b91@mail.gmail.com>

Hi,

as in Subject line described the gnome-panel on my Ubuntu 6.06 appers on top
even on fullscreen. I don't know why?
With mplayer (-vo xv) it works corretlty...

Gnome Version: 2.14.1.

VDR: 1.4.1, Softdevice: CVS-today

Anyone an idea?

greets,
Karl 'loeppel' Glatz
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060714/29814cfc/attachment.html>

From M.Wache at gmx.net  Fri Jul 14 20:57:47 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Fri, 14 Jul 2006 20:57:47 +0200
Subject: [Softdevice-devel] live HDTV channel not playing smooth
In-Reply-To: <FB3B5DB3197CEA429E5FB8E83D01D0390D92AC@sbs2003.do-net.de>
References: <FB3B5DB3197CEA429E5FB8E83D01D0390D92AC@sbs2003.do-net.de>
Message-ID: <44B7E92B.70901@gmx.net>

Andre Neumann schrieb:
> Hi,
> 
> Yesterday i've done some test with higher packet_buf_size for live HDTV
> playback.
> I changed   int packet_buf_size[] = {300,150,2000};
> to          int packet_buf_size[] = {300,150,6000};
> and also to int packet_buf_size[] = {300,150,12000};
> 
> That cause the ringbuffer to fill later, but the problem is still there.
> 
> I've also changed the dvb_buf_size to 128*1024 but it wont help.
> 
> Could you post the patch with more debugging infos ?
> 
Actually I just noticed that there should be enough debugging infos in
place, you just have to enable it. It is called BUFDEB, you just have to
uncomment the corresponding line in mpeg2decoder.c. It will write quite
a lot to stdout, so please redirect stdout to a file and I guess it is
the best if you send it to me privately (gzipped). I will see if I see
something which goes wrong.

Bye,
Martin


From M.Wache at gmx.net  Fri Jul 14 21:23:29 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Fri, 14 Jul 2006 21:23:29 +0200
Subject: [Softdevice-devel] pseudo alpha mmx2
In-Reply-To: <44B6CAED.8030502@pobox.com>
References: <44B6CAED.8030502@pobox.com>
Message-ID: <44B7EF31.3040901@gmx.net>

Torgeir Veimo schrieb:
> The new mmx2 code doing pseudo alpha (aka dithering) doesn't seem to 
> dither like the old non mmx2 code did. Instead of using a checker 
> pattern it uses vertical black lines. This obviously doesn't look too nice.
> 
> 
> The old code used the check
> 
> do_dither = ((x % 2 == 1 && y % 2 == 1) ||
>               (x % 2 == 1 && y % 2 == 0) || prev_pix);
> 
> the new code is (as long as mmx2 is not enabled)
> 
> if ( IS_BACKGROUND(GET_A(c)) && (((intptr_t)dest) & 0x4) )
> 
> which doesn't seem to take into account that the check needs to be 
> different for every second line.
> 
> A better check would be something like
> 
> if ( IS_BACKGROUND(GET_A(c)) && (
>    ((intptr_t)dest) & 0x04 && ((((intptr_t)dest) / (1280*4)) % 2) || 
> 
>    (((intptr_t)dest)+0x04) & 0x04 && (((((intptr_t)dest) / (1280*4)) % 
> 2) == 0)
> )) {
> 
> but here the horizontal width (1280) is hardcoded and I'm not sure how 
> to translate this into mmx code. Ideas?
> 
> 
I think we would have to change the interface of the convert functions,
and also pass a line number. For the mmx part there are to possible ways:
1. convert a single pixel using the c code for odd lines, and convert
   the rest using the mmx code. The drawback is that the memory access
   won't be aligned anymore, and I guess all the speed advantage will be
   gone.
2. have different mmx codes for odd and even lines. To produce this code
   is quite simple, but the code will be doubled.

Bye,
Martin


From torgeir at pobox.com  Sun Jul 16 13:46:28 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Sun, 16 Jul 2006 12:46:28 +0100
Subject: [Softdevice-devel] [Softdevice-cvs] softdevice CHANGELOG, 1.213,
 1.214 configure, 1.21, 1.22
In-Reply-To: <20060716113541.2845C5A59F@bat.berlios.de>
References: <20060716113541.2845C5A59F@bat.berlios.de>
Message-ID: <44BA2714.5010500@pobox.com>

wachm wrote:

>   Changelog
>   2006-07-16:
> +    - only link against libXi if necessary ( do we need libXi at all?)

The XINPUT extension? Don't think so.

-- 
-Torgeir


From M.Wache at gmx.net  Sun Jul 16 14:06:30 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 16 Jul 2006 14:06:30 +0200
Subject: [Softdevice-devel] [Softdevice-cvs] softdevice CHANGELOG, 1.213,
 1.214 configure, 1.21, 1.22
In-Reply-To: <44BA2714.5010500@pobox.com>
References: <20060716113541.2845C5A59F@bat.berlios.de>
	<44BA2714.5010500@pobox.com>
Message-ID: <44BA2BC6.3000507@gmx.net>

Torgeir Veimo schrieb:
> wachm wrote:
> 
>>   Changelog
>>   2006-07-16:
>> +    - only link against libXi if necessary ( do we need libXi at all?)
> 
> The XINPUT extension? Don't think so.
> 
Me, too. But I was afraid that there are some dependencies from the
other X libraries. What do you think? Should we remove it completely?

Bye,
Martin


From ragawu at gmail.com  Sun Jul 16 18:37:00 2006
From: ragawu at gmail.com (Alasdair Campbell)
Date: Sun, 16 Jul 2006 17:37:00 +0100
Subject: [Softdevice-devel] g450 interlaced output
Message-ID: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>

Hi,

I've been having trouble getting the interlaced output of the G450
working correctly.
With current CVS, DirectFB 0..25.1 & current CVS FFMPEG no matter
whether I set the post-processing option "Deinterlace method" to
'none' or 'FB-intern' I still see lines (interlacing artifacts) where
there is quick movement or scrolling text/credits.

I have followed the instructions on the softdevice home page.

Should I be using "-vo dfb:" or "-vo dfb:mgatv" for my G450 with diy
vga to scart cable?  I should add that using "mplayer -vo dfbmga"
shows the same lines.

I've picked up on work being done to ensue scaling of 16:9 interlaced
video to 4:3 tv works correctly, is this complete & working now? I
notice that if I set "Screen Aspect" to 16:9, although I'm missing a
lot of the image, and the aspect ratio is incorrect, there are no
lines like those mentioned above.

I would prefer not to use any software deinterlacing, as the main
reason I bought this card was that everywhere I read I was told that
the card could do all this in hardware. Other than this current
problem, the output is fantastic, although the audio does seem to lose
sync quite regularly.

thanks for all your hard work on this great peice of software!

-- 
A l a s d a i r   C a m p b e l l

r a g a w u @ g m a i l . c o m


From marko.makela at hut.fi  Sun Jul 16 21:32:23 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sun, 16 Jul 2006 22:32:23 +0300
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
Message-ID: <20060716193223.GA4098@localhost.localdomain>

On Sun, Jul 16, 2006 at 05:37:00PM +0100, Alasdair Campbell wrote:
> I've been having trouble getting the interlaced output of the G450
> working correctly.
> With current CVS, DirectFB 0..25.1 & current CVS FFMPEG no matter
> whether I set the post-processing option "Deinterlace method" to
> 'none' or 'FB-intern' I still see lines (interlacing artifacts) where
> there is quick movement or scrolling text/credits.

Stefan Lucke replaced the scaler one or two months ago.  It works for me,
although with DirectFB CVS the OSD is broken since some weeks.  I think
I'll revert to the latest official release of DirectFB.

> Should I be using "-vo dfb:" or "-vo dfb:mgatv" for my G450 with diy
> vga to scart cable?  I should add that using "mplayer -vo dfbmga"
> shows the same lines.

vdr -P'softdevice -vo dfb:mgatv' works for me.

Note that if you sometimes test with VGA output, you will need a different
/etc/directfbrc.  I solved the problem by creating two /etc/directfbrc.*
files and symlinking the correct one to directfbrc.

> I've picked up on work being done to ensue scaling of 16:9 interlaced
> video to 4:3 tv works correctly, is this complete & working now? I
> notice that if I set "Screen Aspect" to 16:9, although I'm missing a
> lot of the image, and the aspect ratio is incorrect, there are no
> lines like those mentioned above.

Before the field-based scaler, it used to be like that.  I use CropMode 4:3
on my 4:3 video monitor.

> I would prefer not to use any software deinterlacing, as the main
> reason I bought this card was that everywhere I read I was told that
> the card could do all this in hardware. Other than this current
> problem, the output is fantastic, although the audio does seem to lose
> sync quite regularly.

What is the other hardware like?  I have a 900 MHz Celeron running on
VIA 686A chipset, tested with 128 MB and 256 MB RAM, one ATAPI hard disk
and two Nova-T PCI 90002 tuner cards.  It works most of the time, using
nvram-wakeup for timed recordings, but every couple of months, the board
needs to be powered off completely, because something in the PCI bus
controller goes bad.  The only fan is the CPU fan, which blows air directly
outside via a self-made duct.  Other than the size (a large tower case)
and the occasional chipset glitches, I'm very happy with the system.

	Marko


From ragawu at gmail.com  Sun Jul 16 22:34:32 2006
From: ragawu at gmail.com (Alasdair Campbell)
Date: Sun, 16 Jul 2006 21:34:32 +0100
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <20060716193223.GA4098@localhost.localdomain>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<20060716193223.GA4098@localhost.localdomain>
Message-ID: <1849e5180607161334g7d02834fjc94642f44f0be6e@mail.gmail.com>

On 16/07/06, Marko M?kel? <marko.makela at hut.fi> wrote:
> On Sun, Jul 16, 2006 at 05:37:00PM +0100, Alasdair Campbell wrote:
> > I've been having trouble getting the interlaced output of the G450
> > working correctly.
> > With current CVS, DirectFB 0..25.1 & current CVS FFMPEG no matter
> > whether I set the post-processing option "Deinterlace method" to
> > 'none' or 'FB-intern' I still see lines (interlacing artifacts) where
> > there is quick movement or scrolling text/credits.
>
> Stefan Lucke replaced the scaler one or two months ago.  It works for me,
> although with DirectFB CVS the OSD is broken since some weeks.  I think
> I'll revert to the latest official release of DirectFB.
>

I had the problem with the broken OSD, seemed like it was linked to
the interlacing as only half was visible and it flickered like crazy.

If it works for you then I must be doing something stupid, which
wouldn't surprise me, as I'm flying by the seat of my pants where
linux is concerned. As the documentation is so limited, I've not been
sure that I've compiled things correctly, especially FFMPEG - I
followed the instructions "For deinterlacing pp-filters in recent
plugin versions,...." on the vdr wiki page for the plugin. But that
could have been talking about a totally different version or horribly
out of date (curse o' the wiki).

How did you compile FFMPEG?

> > Should I be using "-vo dfb:" or "-vo dfb:mgatv" for my G450 with diy
> > vga to scart cable?  I should add that using "mplayer -vo dfbmga"
> > shows the same lines.
>
> vdr -P'softdevice -vo dfb:mgatv' works for me.
>
> Note that if you sometimes test with VGA output, you will need a different
> /etc/directfbrc.  I solved the problem by creating two /etc/directfbrc.*
> files and symlinking the correct one to directfbrc.
>

I only test on my TV so shouldn't need that - can make for angry
scenes where the partner needs access to big brother....

> > I've picked up on work being done to ensue scaling of 16:9 interlaced
> > video to 4:3 tv works correctly, is this complete & working now? I
> > notice that if I set "Screen Aspect" to 16:9, although I'm missing a
> > lot of the image, and the aspect ratio is incorrect, there are no
> > lines like those mentioned above.
>
> Before the field-based scaler, it used to be like that.  I use CropMode 4:3
> on my 4:3 video monitor.
>

If I set CropMode to 4:3 then the overscan is too severe. Even though
my TV is 4:3, I like to view in the 16:9 aspect ratio whenever
possible, ie there are black bars at the top and bottom. This is how I
want to watch dvds and dvb-t television, though I'm beginning to feel
like this it is going to be impossible to get this setup to be
compatible with hardware interlacing.

*If someone knows a definitive answer to this I would be greatful for the email.

> > I would prefer not to use any software deinterlacing, as the main
> > reason I bought this card was that everywhere I read I was told that
> > the card could do all this in hardware. Other than this current
> > problem, the output is fantastic, although the audio does seem to lose
> > sync quite regularly.
>
> What is the other hardware like?  I have a 900 MHz Celeron running on
> VIA 686A chipset, tested with 128 MB and 256 MB RAM, one ATAPI hard disk
> and two Nova-T PCI 90002 tuner cards.  It works most of the time, using
> nvram-wakeup for timed recordings, but every couple of months, the board
> needs to be powered off completely, because something in the PCI bus
> controller goes bad.  The only fan is the CPU fan, which blows air directly
> outside via a self-made duct.  Other than the size (a large tower case)
> and the occasional chipset glitches, I'm very happy with the system.
>

Hardware is biostar nforce2 based motherboard, underclocked &
undervolted athlon 2500 barton, 512MB ram, one atapi disk, two kworld
vstream dvb-t pci cards, all in an antec aria cube case which used to
get very hot and was really noisy until I replaced the PSU fan and
changed my heatsink fan. I have plans for another vdr box using a
passively cooled 900 Mhz celeron and a fanless psu but that can't
happen until I reach a perfect settlement to my g450 setup, or I find
someother way....


>         Marko
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://bat.berlios.de/mailman/listinfo/softdevice-devel
>


-- 
A l a s d a i r   C a m p b e l l


From torgeir at pobox.com  Mon Jul 17 01:49:13 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Mon, 17 Jul 2006 00:49:13 +0100
Subject: [Softdevice-devel] pseudo alpha mmx2
In-Reply-To: <44B7EF31.3040901@gmx.net>
References: <44B6CAED.8030502@pobox.com> <44B7EF31.3040901@gmx.net>
Message-ID: <44BAD079.3020104@pobox.com>

Martin Wache wrote:
> Torgeir Veimo schrieb:
>> The new mmx2 code doing pseudo alpha (aka dithering) doesn't seem to 
>> dither like the old non mmx2 code did. Instead of using a checker 
>> pattern it uses vertical black lines. This obviously doesn't look too nice.
>>
>>
>> The old code used the check
>>
>> do_dither = ((x % 2 == 1 && y % 2 == 1) ||
>>               (x % 2 == 1 && y % 2 == 0) || prev_pix);
>>
>> the new code is (as long as mmx2 is not enabled)
>>
>> if ( IS_BACKGROUND(GET_A(c)) && (((intptr_t)dest) & 0x4) )
>>
>> which doesn't seem to take into account that the check needs to be 
>> different for every second line.
>>
>> A better check would be something like
>>
>> if ( IS_BACKGROUND(GET_A(c)) && (
>>    ((intptr_t)dest) & 0x04 && ((((intptr_t)dest) / (1280*4)) % 2) || 
>>
>>    (((intptr_t)dest)+0x04) & 0x04 && (((((intptr_t)dest) / (1280*4)) % 
>> 2) == 0)
>> )) {
>>
>> but here the horizontal width (1280) is hardcoded and I'm not sure how 
>> to translate this into mmx code. Ideas?
>>
>>
> I think we would have to change the interface of the convert functions,
> and also pass a line number. For the mmx part there are to possible ways:
> 1. convert a single pixel using the c code for odd lines, and convert
>    the rest using the mmx code. The drawback is that the memory access
>    won't be aligned anymore, and I guess all the speed advantage will be
>    gone.
> 2. have different mmx codes for odd and even lines. To produce this code
>    is quite simple, but the code will be doubled.

What about doing the dithering in the OSD buffer before it's transferred 
to screen? Since the OSD stride is fixed it should be easier to create 
MMX code that is single pass?


-- 
-Torgeir


From dave at optionsdsl.ca  Mon Jul 17 02:53:27 2006
From: dave at optionsdsl.ca (Dave)
Date: Sun, 16 Jul 2006 20:53:27 -0400
Subject: [Softdevice-devel] Exit out on wrong audio rates?
Message-ID: <44BADF87.7020001@optionsdsl.ca>

I tried posted this to mailing list before but Im not sure it ever made
it or not, so forgive me if I duplicate post:

 I have this problem occasionally with softdevice exiting out due to
unsupported audio sample rates. for example 44100 khz causes softdevice
to exit and kill VDR.

 Is there a better way to handle this rather than to kill VDR
 completely? I have 3 DVB-S cards in one box, and 3 dishes. I often am
 recording 3-4 programs at the same time, and for example a brief hard
 rain comes by and lowers the signal too low and causes video/audio
 errors I lose all my other recordings currently being recorded which
 encountered no problems at all. I would much rather have a recording
 with some video/audio errors than no recordings at all.

 Im open to suggestions  :) 

 Dave






From torgeir at pobox.com  Mon Jul 17 03:00:37 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Mon, 17 Jul 2006 02:00:37 +0100
Subject: [Softdevice-devel] Exit out on wrong audio rates?
In-Reply-To: <44BADF87.7020001@optionsdsl.ca>
References: <44BADF87.7020001@optionsdsl.ca>
Message-ID: <44BAE135.4050306@pobox.com>

Dave wrote:
> I tried posted this to mailing list before but Im not sure it ever made
> it or not, so forgive me if I duplicate post:
> 
>  I have this problem occasionally with softdevice exiting out due to
> unsupported audio sample rates. for example 44100 khz causes softdevice
> to exit and kill VDR.
> 
>  Is there a better way to handle this rather than to kill VDR
>  completely? I have 3 DVB-S cards in one box, and 3 dishes. I often am
>  recording 3-4 programs at the same time, and for example a brief hard
>  rain comes by and lowers the signal too low and causes video/audio
>  errors I lose all my other recordings currently being recorded which
>  encountered no problems at all. I would much rather have a recording
>  with some video/audio errors than no recordings at all.
> 
>  Im open to suggestions  :) 

Can you maybe provide a backtrace from a crash running under gdb? Run it 
as gdb --args vdr -v /video/vdr [...] etc. and run the command 'ba' 
after it segfaults on such a programme.



-- 
-Torgeir


From dave at optionsdsl.ca  Mon Jul 17 05:33:17 2006
From: dave at optionsdsl.ca (Dave)
Date: Sun, 16 Jul 2006 23:33:17 -0400
Subject: [Softdevice-devel] Exit out on wrong audio rates?
In-Reply-To: <44BAE135.4050306@pobox.com>
References: <44BADF87.7020001@optionsdsl.ca> <44BAE135.4050306@pobox.com>
Message-ID: <44BB04FD.7020408@optionsdsl.ca>

Torgeir Veimo wrote:
> Dave wrote:
>   
>> I tried posted this to mailing list before but Im not sure it ever made
>> it or not, so forgive me if I duplicate post:
>>
>>  I have this problem occasionally with softdevice exiting out due to
>> unsupported audio sample rates. for example 44100 khz causes softdevice
>> to exit and kill VDR.
>>
>>  Is there a better way to handle this rather than to kill VDR
>>  completely? I have 3 DVB-S cards in one box, and 3 dishes. I often am
>>  recording 3-4 programs at the same time, and for example a brief hard
>>  rain comes by and lowers the signal too low and causes video/audio
>>  errors I lose all my other recordings currently being recorded which
>>  encountered no problems at all. I would much rather have a recording
>>  with some video/audio errors than no recordings at all.
>>
>>  Im open to suggestions  :) 
>>     
>
> Can you maybe provide a backtrace from a crash running under gdb? Run it 
> as gdb --args vdr -v /video/vdr [...] etc. and run the command 'ba' 
> after it segfaults on such a programme.
>
>
>
>   


Softdevice doesnt actually segfault, the error is handled and vdr is
properly shut down.  I just rather softdevice not shutdown VDR on bad
sample rates, the error is similar to "using rate 24000 is not possible
[and using 48000 is not implemented] FATAL: exiting]




From marko.makela at hut.fi  Mon Jul 17 14:19:20 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 17 Jul 2006 15:19:20 +0300
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <1849e5180607161334g7d02834fjc94642f44f0be6e@mail.gmail.com>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<20060716193223.GA4098@localhost.localdomain>
	<1849e5180607161334g7d02834fjc94642f44f0be6e@mail.gmail.com>
Message-ID: <20060717121919.GA3692@localhost.localdomain>

On Sun, Jul 16, 2006 at 09:34:32PM +0100, Alasdair Campbell wrote:
> On 16/07/06, Marko M?kel? <marko.makela at hut.fi> wrote:
> > On Sun, Jul 16, 2006 at 05:37:00PM +0100, Alasdair Campbell wrote:
> > > I've been having trouble getting the interlaced output of the G450
> > > working correctly.
> > > With current CVS, DirectFB 0..25.1 & current CVS FFMPEG no matter
> > > whether I set the post-processing option "Deinterlace method" to
> > > 'none' or 'FB-intern' I still see lines (interlacing artifacts) where
> > > there is quick movement or scrolling text/credits.
> >
> > Stefan Lucke replaced the scaler one or two months ago.  It works for me,
> > although with DirectFB CVS the OSD is broken since some weeks.  I think
> > I'll revert to the latest official release of DirectFB.
> >
> 
> I had the problem with the broken OSD, seemed like it was linked to
> the interlacing as only half was visible and it flickered like crazy.
> 
> If it works for you then I must be doing something stupid, which
> wouldn't surprise me, as I'm flying by the seat of my pants where
> linux is concerned.

I reverted to DirectFB 0.9.25.1 today morning, and OSD is flicker free again.
DirectFB CVS is rather useless for me on -vo dfb:mgatv, because
DVB subtitles would be unavailable.

Note that when compiling DirectFB from source, you should install DirectFB
first and only then compile and install DFB++.  Otherwise, DFB++ will
depend on the wrong DirectFB library.

> How did you compile FFMPEG?

./configure --extra-cflags='-march=pentium3 -ffast-math' --disable-encoders --disable-strip --disable-network --enable-gpl

For DirectFB, I use the following configuration:

./configure --disable-{unique,multi,fusion,text,mpeg,jpeg,gif,png,freetype,video4linux,video4linux2} --with-inputdrivers=linuxinput --with-gfxdrivers=matrox C{,XX}FLAGS=-march=pentium3

For softdevice, I use the following:

./configure --disable-{vidix,fb,xv,shm,subplugins}

If you have multiple versions of the libraries laying around, you should
perhaps check the dependencies
(ldd vdr-1.4.0/PLUGINS/lib/libvdr-softdevice.so.1.4.0).

> If I set CropMode to 4:3 then the overscan is too severe.

I guess it's a matter of taste.

> *If someone knows a definitive answer to this I would be greatful for
> the email.

According to cvs log video-dfb.c, the field-based scaler was introduced
in revision 1.60 on May 7, 2006.  Last Matrox related changes were in
the most recent revision (1.68).  The last release (0.2.3) should be
based on revision 1.58.  So, you will need the CVS version of softdevice.

> Hardware is biostar nforce2 based motherboard, underclocked &
> undervolted athlon 2500 barton, 512MB ram, one atapi disk, two kworld
> vstream dvb-t pci cards

Okay, neither the CPU nor the I/O should be overloaded.  I think you should
double check that you are running the correct version of DirectFB and
softdevice.  I don't think that ffmpeg version is that important.  Mine
is a CVS snapshot from a few months ago.

	Marko


From M.Wache at gmx.net  Mon Jul 17 18:22:13 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 17 Jul 2006 18:22:13 +0200
Subject: [Softdevice-devel] pseudo alpha mmx2
In-Reply-To: <44BAD079.3020104@pobox.com>
References: <44B6CAED.8030502@pobox.com> <44B7EF31.3040901@gmx.net>
	<44BAD079.3020104@pobox.com>
Message-ID: <44BBB935.7070309@gmx.net>

Torgeir Veimo schrieb:
> Martin Wache wrote:
>> I think we would have to change the interface of the convert functions,
>> and also pass a line number. For the mmx part there are to possible ways:
>> 1. convert a single pixel using the c code for odd lines, and convert
>>    the rest using the mmx code. The drawback is that the memory access
>>    won't be aligned anymore, and I guess all the speed advantage will be
>>    gone.
>> 2. have different mmx codes for odd and even lines. To produce this code
>>    is quite simple, but the code will be doubled.
> 
> What about doing the dithering in the OSD buffer before it's transferred 
> to screen? 
That would also be before it is scaled, I don't think that would look good.

> Since the OSD stride is fixed it should be easier to create 
> MMX code that is single pass?
> 

I'm not sure if I understand you... The MMX code would have to process
each line only once, however we would need to have separate source code
for odd and even lines, which means code duplication. But there won't be
any speed impact on the second solution. Probably one could come around
the code duplication using macros. If you want you can change the C part
to the check board pattern and disable the MMX code. I will have a look
at the MMX code when I find some time.

Bye,
Martin



From torgeir at pobox.com  Mon Jul 17 18:30:10 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Mon, 17 Jul 2006 17:30:10 +0100
Subject: [Softdevice-devel] pseudo alpha mmx2
In-Reply-To: <44BBB935.7070309@gmx.net>
References: <44B6CAED.8030502@pobox.com>
	<44B7EF31.3040901@gmx.net>	<44BAD079.3020104@pobox.com>
	<44BBB935.7070309@gmx.net>
Message-ID: <44BBBB12.7000909@pobox.com>

Martin Wache wrote:
> Torgeir Veimo schrieb:
>> Martin Wache wrote:
>>> I think we would have to change the interface of the convert functions,
>>> and also pass a line number. For the mmx part there are to possible ways:
>>> 1. convert a single pixel using the c code for odd lines, and convert
>>>    the rest using the mmx code. The drawback is that the memory access
>>>    won't be aligned anymore, and I guess all the speed advantage will be
>>>    gone.
>>> 2. have different mmx codes for odd and even lines. To produce this code
>>>    is quite simple, but the code will be doubled.
>> What about doing the dithering in the OSD buffer before it's transferred 
>> to screen? 
> That would also be before it is scaled, I don't think that would look good.

This is only when using "pseudo" transparency, it wouldn't apply to 
software OSD, and thus no scaling would occur.

>> Since the OSD stride is fixed it should be easier to create 
>> MMX code that is single pass?
>>
> 
> I'm not sure if I understand you... The MMX code would have to process
> each line only once, however we would need to have separate source code
> for odd and even lines, which means code duplication. But there won't be
> any speed impact on the second solution. Probably one could come around
> the code duplication using macros. If you want you can change the C part
> to the check board pattern and disable the MMX code. I will have a look
> at the MMX code when I find some time.

My idea was to pre-process the OSD buffer before blitting to video ram. 
We'd pass over the buffer turning transparent values into black in a 
dithered pattern. This would require a new method or code step, which 
could potentially be written in MMX.

When the ARGB_to_RGB32 method is called, there's no need to do any 
dithering, so the existing MMX code could be simplified.

I can write some code that does this.

-- 
-Torgeir


From M.Wache at gmx.net  Mon Jul 17 18:42:00 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 17 Jul 2006 18:42:00 +0200
Subject: [Softdevice-devel] pseudo alpha mmx2
In-Reply-To: <44BBBB12.7000909@pobox.com>
References: <44B6CAED.8030502@pobox.com>	<44B7EF31.3040901@gmx.net>	<44BAD079.3020104@pobox.com>	<44BBB935.7070309@gmx.net>
	<44BBBB12.7000909@pobox.com>
Message-ID: <44BBBDD8.8040209@gmx.net>

Torgeir Veimo schrieb:
> Martin Wache wrote:
>> Torgeir Veimo schrieb:
>>> Martin Wache wrote:
>>>> I think we would have to change the interface of the convert functions,
>>>> and also pass a line number. For the mmx part there are to possible ways:
>>>> 1. convert a single pixel using the c code for odd lines, and convert
>>>>    the rest using the mmx code. The drawback is that the memory access
>>>>    won't be aligned anymore, and I guess all the speed advantage will be
>>>>    gone.
>>>> 2. have different mmx codes for odd and even lines. To produce this code
>>>>    is quite simple, but the code will be doubled.
>>> What about doing the dithering in the OSD buffer before it's transferred 
>>> to screen? 
>> That would also be before it is scaled, I don't think that would look good.
> 
> This is only when using "pseudo" transparency, it wouldn't apply to 
> software OSD, and thus no scaling would occur.
> 
No, if you use X11 with a high resolution, or the softdevice in an X
window the OSD has to be scaled. The software OSD usually doesn't have
to be scaled (depends on the stream).

>>> Since the OSD stride is fixed it should be easier to create 
>>> MMX code that is single pass?
>>>
>> I'm not sure if I understand you... The MMX code would have to process
>> each line only once, however we would need to have separate source code
>> for odd and even lines, which means code duplication. But there won't be
>> any speed impact on the second solution. Probably one could come around
>> the code duplication using macros. If you want you can change the C part
>> to the check board pattern and disable the MMX code. I will have a look
>> at the MMX code when I find some time.
> 
> My idea was to pre-process the OSD buffer before blitting to video ram. 
> We'd pass over the buffer turning transparent values into black in a 
> dithered pattern. This would require a new method or code step, which 
> could potentially be written in MMX.
>
The memory transfer is the most costly operation, so if we do the
dithering and the conversion in one step it is faster than doing it in
two steps, having to save the intermediary result in memory.

Martin



From torgeir at pobox.com  Tue Jul 18 01:15:09 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Tue, 18 Jul 2006 00:15:09 +0100
Subject: [Softdevice-devel] pseudo alpha mmx2
In-Reply-To: <44BBBDD8.8040209@gmx.net>
References: <44B6CAED.8030502@pobox.com>	<44B7EF31.3040901@gmx.net>	<44BAD079.3020104@pobox.com>	<44BBB935.7070309@gmx.net>	<44BBBB12.7000909@pobox.com>
	<44BBBDD8.8040209@gmx.net>
Message-ID: <44BC19FD.4090608@pobox.com>

Martin Wache wrote:
> Torgeir Veimo schrieb:
>> Martin Wache wrote:
>>> Torgeir Veimo schrieb:
>>>> Martin Wache wrote:
>>>>> I think we would have to change the interface of the convert functions,
>>>>> and also pass a line number. For the mmx part there are to possible ways:
>>>>> 1. convert a single pixel using the c code for odd lines, and convert
>>>>>    the rest using the mmx code. The drawback is that the memory access
>>>>>    won't be aligned anymore, and I guess all the speed advantage will be
>>>>>    gone.
>>>>> 2. have different mmx codes for odd and even lines. To produce this code
>>>>>    is quite simple, but the code will be doubled.
>>>> What about doing the dithering in the OSD buffer before it's transferred 
>>>> to screen? 
>>> That would also be before it is scaled, I don't think that would look good.
>> This is only when using "pseudo" transparency, it wouldn't apply to 
>> software OSD, and thus no scaling would occur.
>>
> No, if you use X11 with a high resolution, or the softdevice in an X
> window the OSD has to be scaled. The software OSD usually doesn't have
> to be scaled (depends on the stream).

What resolutions are you talking about? I'm displaying in 1280x1024 and 
1280x720 without scaling. The OSD is shown pixel perfect on top of the 
video output.


-- 
-Torgeir


From dave at optionsdsl.ca  Tue Jul 18 04:42:09 2006
From: dave at optionsdsl.ca (Dave)
Date: Mon, 17 Jul 2006 22:42:09 -0400
Subject: [Softdevice-devel] Exit out on wrong audio rates?
In-Reply-To: <44BAE135.4050306@pobox.com>
References: <44BADF87.7020001@optionsdsl.ca> <44BAE135.4050306@pobox.com>
Message-ID: <44BC4A81.2040605@optionsdsl.ca>

Here is the actual log entry:

Jul 17 22:33:32 vdr vdr: [8262] [softdevice-audio] Rate 24000 Hz is not
possible (and using instead 48000 Hz is not implemented) FATAL exiting

This drives me nuts!


Torgeir Veimo wrote:
> Dave wrote:
>   
>> I tried posted this to mailing list before but Im not sure it ever made
>> it or not, so forgive me if I duplicate post:
>>
>>  I have this problem occasionally with softdevice exiting out due to
>> unsupported audio sample rates. for example 44100 khz causes softdevice
>> to exit and kill VDR.
>>
>>  Is there a better way to handle this rather than to kill VDR
>>  completely? I have 3 DVB-S cards in one box, and 3 dishes. I often am
>>  recording 3-4 programs at the same time, and for example a brief hard
>>  rain comes by and lowers the signal too low and causes video/audio
>>  errors I lose all my other recordings currently being recorded which
>>  encountered no problems at all. I would much rather have a recording
>>  with some video/audio errors than no recordings at all.
>>
>>  Im open to suggestions  :) 
>>     
>
> Can you maybe provide a backtrace from a crash running under gdb? Run it 
> as gdb --args vdr -v /video/vdr [...] etc. and run the command 'ba' 
> after it segfaults on such a programme.
>
>
>
>   



From torgeir at pobox.com  Tue Jul 18 10:49:33 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Tue, 18 Jul 2006 09:49:33 +0100
Subject: [Softdevice-devel] Exit out on wrong audio rates?
In-Reply-To: <44BC4A81.2040605@optionsdsl.ca>
References: <44BADF87.7020001@optionsdsl.ca> <44BAE135.4050306@pobox.com>
	<44BC4A81.2040605@optionsdsl.ca>
Message-ID: <44BCA09D.1050103@pobox.com>

Dave wrote:
> Here is the actual log entry:
> 
> Jul 17 22:33:32 vdr vdr: [8262] [softdevice-audio] Rate 24000 Hz is not
> possible (and using instead 48000 Hz is not implemented) FATAL exiting
> 
> This drives me nuts!

Did you try changing the exit(1); in line 335 in audio-alsa.c to return 0; ?

It's probably not enough, but not having a stream to check with makes it 
a bit difficult to test. Can you make a recording where the audio 
changes from 48000 to 24000 and upload it somewhere?


-- 
-Torgeir


From M.Wache at gmx.net  Tue Jul 18 18:15:12 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 18 Jul 2006 18:15:12 +0200
Subject: [Softdevice-devel] pseudo alpha mmx2
In-Reply-To: <44BC19FD.4090608@pobox.com>
References: <44B6CAED.8030502@pobox.com>	<44B7EF31.3040901@gmx.net>	<44BAD079.3020104@pobox.com>	<44BBB935.7070309@gmx.net>	<44BBBB12.7000909@pobox.com>	<44BBBDD8.8040209@gmx.net>
	<44BC19FD.4090608@pobox.com>
Message-ID: <44BD0910.3080407@gmx.net>

Torgeir Veimo schrieb:
> Martin Wache wrote:
>> Torgeir Veimo schrieb:
>>> Martin Wache wrote:
>>>> Torgeir Veimo schrieb:
>>>>> Martin Wache wrote:
>>>>>> I think we would have to change the interface of the convert functions,
>>>>>> and also pass a line number. For the mmx part there are to possible ways:
>>>>>> 1. convert a single pixel using the c code for odd lines, and convert
>>>>>>    the rest using the mmx code. The drawback is that the memory access
>>>>>>    won't be aligned anymore, and I guess all the speed advantage will be
>>>>>>    gone.
>>>>>> 2. have different mmx codes for odd and even lines. To produce this code
>>>>>>    is quite simple, but the code will be doubled.
>>>>> What about doing the dithering in the OSD buffer before it's transferred 
>>>>> to screen? 
>>>> That would also be before it is scaled, I don't think that would look good.
>>> This is only when using "pseudo" transparency, it wouldn't apply to 
>>> software OSD, and thus no scaling would occur.
>>>
>> No, if you use X11 with a high resolution, or the softdevice in an X
>> window the OSD has to be scaled. The software OSD usually doesn't have
>> to be scaled (depends on the stream).
> 
> What resolutions are you talking about? I'm displaying in 1280x1024 and 
> 1280x720 without scaling. The OSD is shown pixel perfect on top of the 
> video output.
> 

The FF cards have an OSD of the same resolution as the streams
(720x576), and vdr renders the OSD in this same resolution. For software
alpha blending we can usually just blend the osd over the stream (they
have the same size), but if the screen has a higher (or lower)
resolution we have to scale video and osd. The video is scaled by the
hardware (except fb-out), and the osd is scaled by
cSoftOsd::Scale(VUp/VDown)CopyToBitmap().

Bye,
Martin


From torgeir at pobox.com  Tue Jul 18 20:02:01 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Tue, 18 Jul 2006 19:02:01 +0100
Subject: [Softdevice-devel] error when starting vdr & softdevice on g550
Message-ID: <44BD2219.90301@pobox.com>

I haven't been using DirectFB lately, but tried today with DirectFB 
current cvs on a Matrox G550. Here's the log output. Does anyone know 
what might be the problem?
[root at htpc VDR]# vdr -v /video/vdr -s "killall vdr;/bin/false" 
-P"softdevice -vo dfb:mgatv" -P"remote -i /dev/input/event1" -P"softplay 
--media-path /video/vdr" -Plcdproc -Pdvd
[softdevice] processing args
[softdevice]   argv [0] = softdevice
[softdevice]   argv [1] = -vo
vo_argv: dfb:mgatv
[setup-softdevice] alsa ac3Mode set to: 0
[setup-softdevice] alsa AC3 device set to: hw:0,1
[setup-softdevice] alsa device set to: default
[setup-softdevice] A/V Offset set to (80)
[setup-softdevice] Cropping 0 lines from bottom
[setup-softdevice] Cropping 0 columns from left
[setup-softdevice] cropping mode set to 1 (4:3)
[setup-softdevice] cropping mode toggle key set to 0 (none)
[setup-softdevice] Cropping 0 columns from right
[setup-softdevice] Cropping 0 lines from top
[setup-softdevice] deinterlace method set to 1 lavc
[setup-softdevice] mainMenu: 1
[setup-softdevice] setting alpha blend mode to pseudo
[softdevice] picture mirroring set to 0 (off)
[setup-softdevice] pixel format set to (YUY2)
[setup-softdevice] shouldSuspend to: 0
[setup-softdevice] syncTimerMode: rtc
[softdevice] UseStretchBlitset to on
[setup-softdevice] vidBrightness: 50
[setup-softdevice] vidContrast: 50
[setup-softdevice] vidHue: 50
[setup-softdevice] vidSaturation: 50
[setup-softdevice] startup aspect set to (4:3 normal)
[softdevice] initializing Plugin
[softdevice] Initializing Video Out
[softdevice] ffmpeg build(3344896)
[dfb] init
(*) DirectFB/Config: Parsing config file '/etc/directfbrc'.

        ---------------------- DirectFB v0.9.26 ---------------------
              (c) 2000-2002  convergence integrated media GmbH
              (c) 2002-2004  convergence GmbH
         -----------------------------------------------------------

(*) DirectFB/Core: Single Application Core. (2006-07-18 16:14) [ DEBUG ]
(*) Direct/Memcpy: Using MMXEXT optimized memcpy()
(*) Direct/Thread: Running 'VT Switcher' (CRITICAL, 2801)...
(*) Direct/Thread: Running 'PS/2 Input' (INPUT, 2802)...
  (!!!)  *** UNIMPLEMENTED [fusion_reactor_set_lock] *** [reactor.c:853]
(*) DirectFB/Input: IMPS/2 Mouse 1.0 (Convergence GmbH)
(*) Direct/Thread: Running 'Linux Input' (INPUT, 2803)...
(*) DirectFB/Input: AT Translated Set 2 keyboard (1) 0.1 (convergence 
integrated media GmbH)
(*) Direct/Thread: Running 'Linux Input' (INPUT, 2804)...
(*) DirectFB/Input: Logitech USB Receiver (2) 0.1 (convergence 
integrated media GmbH)
(*) Direct/Thread: Running 'Linux Input' (INPUT, 2805)...
(*) DirectFB/Input: cx88 IR (Hauppauge Nova-T DVB-T (3) 0.1 (convergence 
integrated media GmbH)
(*) Direct/Thread: Running 'Keyboard Input' (INPUT, 2806)...
(*) DirectFB/Input: Keyboard 0.9 (convergence integrated media GmbH)
(*) DirectFB/Genefx: MMX detected and enabled
(*) DirectFB/Graphics: Matrox G550 0.7 (directfb.org)
(*) DirectFB/Core/WM: Default 0.2 (Convergence GmbH)
[dfb] RAM: 16777216 bytes
[dfb] Accellerated Functions: FillRectange DrawRectange DrawLine 
FillTriangle Blit StretchBlit All
[dfb] Drawing Flags: Blend Src.premultiply
[dfb] Surface Blitting Flags: BlendAlpha BlendColorAlpha Colorize 
SrcColorkey SrcPremultiply Deinterlace
[dfb] Supported video Modes are: 640x480 at 8 640x480 at 8 640x480 at 8 640x480 at 8 
640x480 at 8 800x600 at 8 800x600 at 8 800x600 at 8 800x600 at 8 800x600 at 8 800x600 at 8 
800x600 at 8 800x600 at 8 1024x768 at 8 1024x768 at 8 1024x768 at 8 1024x768 at 8 
1024x768 at 8 1024x768 at 8 1024x768 at 8 1152x864 at 8 1152x864 at 8 1152x864 at 8 
1152x864 at 8 1152x864 at 8 1152x864 at 8 1024x1024 at 8 1280x1024 at 8 1280x1024 at 8 
1280x1024 at 8 1280x1024 at 8 1280x1024 at 8 1600x1200 at 8 1600x1200 at 8 1600x1200 at 8 
1280x720 at 32 1280x720 at 16 720x576 at 32 768x576 at 32
[dfb] Enumerating display Layers
Layer 0 FBDev Primary Layer  Type: graphics
   Caps: brightness contrast saturation surface
Layer 1 Matrox Backend Scaler  Type: graphics picture video
   Caps: brightness contrast deinterlacing dst_colorkey screen_location 
surface
[dfb] New layer name allocation failed. Trying old (dfb-0.9.20) layer name
Layer 0 FBDev Primary Layer  Type: graphics
   Caps: brightness contrast saturation surface
Layer 1 Matrox Backend Scaler  Type: graphics picture video
   Caps: brightness contrast deinterlacing dst_colorkey screen_location 
surface
[dfb]: could not find suitable videolayer
  (!!!)  *** WARNING [Application exited without deinitialization of 
DirectFB!] *** [core.c:741 in dfb_core_deinit_check()]

My /etc/directfbrc:

mode=1280x1024
depth=32
pixelformat=ARGB

-- 
-Torgeir


From stefan at lucke.in-berlin.de  Tue Jul 18 23:04:35 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 18 Jul 2006 23:04:35 +0200
Subject: [Softdevice-devel] error when starting vdr & softdevice on g550
In-Reply-To: <44BD2219.90301@pobox.com>
References: <44BD2219.90301@pobox.com>
Message-ID: <200607182304.35860.stefan@lucke.in-berlin.de>

On Dienstag 18 Juli 2006 20:02, Torgeir Veimo wrote:
> I haven't been using DirectFB lately, but tried today with DirectFB 
> current cvs on a Matrox G550. Here's the log output. Does anyone know 
> what might be the problem?
> [root at htpc VDR]# vdr -v /video/vdr -s "killall vdr;/bin/false" 
> -P"softdevice -vo dfb:mgatv" -P"remote -i /dev/input/event1" -P"softplay 

TV out at 1280x1024 ??

> (*) DirectFB/Graphics: Matrox G550 0.7 (directfb.org)
> (*) DirectFB/Core/WM: Default 0.2 (Convergence GmbH)
> [dfb] RAM: 16777216 bytes

For VGA out int 1280x1024 16M is not enough. If you've mor RAM
on your card, you'll need matrox full memory patch.

> [dfb] Accellerated Functions: FillRectange DrawRectange DrawLine 
> FillTriangle Blit StretchBlit All
> [dfb] Drawing Flags: Blend Src.premultiply
> [dfb] Surface Blitting Flags: BlendAlpha BlendColorAlpha Colorize 
> SrcColorkey SrcPremultiply Deinterlace
> [dfb] Supported video Modes are: 640x480 at 8 640x480 at 8 640x480 at 8 640x480 at 8 
> 640x480 at 8 800x600 at 8 800x600 at 8 800x600 at 8 800x600 at 8 800x600 at 8 800x600 at 8 
> 800x600 at 8 800x600 at 8 1024x768 at 8 1024x768 at 8 1024x768 at 8 1024x768 at 8 
> 1024x768 at 8 1024x768 at 8 1024x768 at 8 1152x864 at 8 1152x864 at 8 1152x864 at 8 
> 1152x864 at 8 1152x864 at 8 1152x864 at 8 1024x1024 at 8 1280x1024 at 8 1280x1024 at 8 
> 1280x1024 at 8 1280x1024 at 8 1280x1024 at 8 1600x1200 at 8 1600x1200 at 8 1600x1200 at 8 
> 1280x720 at 32 1280x720 at 16 720x576 at 32 768x576 at 32
> [dfb] Enumerating display Layers
> Layer 0 FBDev Primary Layer  Type: graphics
>    Caps: brightness contrast saturation surface
> Layer 1 Matrox Backend Scaler  Type: graphics picture video
>    Caps: brightness contrast deinterlacing dst_colorkey screen_location 
> surface
> [dfb] New layer name allocation failed. Trying old (dfb-0.9.20) layer name
> Layer 0 FBDev Primary Layer  Type: graphics
>    Caps: brightness contrast saturation surface
> Layer 1 Matrox Backend Scaler  Type: graphics picture video
>    Caps: brightness contrast deinterlacing dst_colorkey screen_location 
> surface
> [dfb]: could not find suitable videolayer
>   (!!!)  *** WARNING [Application exited without deinitialization of 
> DirectFB!] *** [core.c:741 in dfb_core_deinit_check()]

There is another bug when using BES layer insteadof stretch blitmode.
Some flags set in some combination is now not accepted.
DSCAPS_DOUBLE seems to confilct with DLCONF_BUFFERMODE on setting
videoLayer's configuration ;-) .
For me I just disable failed configuration flags in SetParams(), after code
for triple buffering:

        if (dlc.buffermode == DLBM_UNKNOWN)
        {
          dlc.buffermode = DLBM_BACKVIDEO;
fprintf(stderr, "[dfb]: Testconfiguration (DBLM_BACKVIDEO) ??\n");
          try
          {
            videoLayer->TestConfiguration(dlc, &failed);
            fprintf(stderr, "[dfb]: Testconfiguration (DBLM_BACKVIDEO) OK\n");
          }
          catch (DFBException *ex)
          {
            if (failed & DLCONF_BUFFERMODE)
            {
              fprintf(stderr, "[dfb]: SetParams: failed to set buffermode "
                      "to back video, reverting to normal\n");
              dlc.buffermode = DLBM_FRONTONLY;
            } else {
fprintf(stderr, "[dfb]: Testconfiguration failed %08x\n", failed);
dlc.flags = (DFBDisplayLayerConfigFlags) (dlc.flags & ~failed);
            }
            delete ex;
          }
        }

> 
> My /etc/directfbrc:
> 
> mode=1280x1024
> depth=32
> pixelformat=ARGB
> 

For mgatv, you need a directfbrc like this:
mode=720x576
depth = 32
matrox-crtc2
matrox-tv-standard=pal
primary-layer=2
pixelformat=ARGB
matrox-cable-type=composite


-- 
Stefan Lucke


From dave at optionsdsl.ca  Tue Jul 18 23:10:33 2006
From: dave at optionsdsl.ca (Dave)
Date: Tue, 18 Jul 2006 17:10:33 -0400
Subject: [Softdevice-devel] Exit out on wrong audio rates?
In-Reply-To: <44BCA09D.1050103@pobox.com>
References: <44BADF87.7020001@optionsdsl.ca>
	<44BAE135.4050306@pobox.com>	<44BC4A81.2040605@optionsdsl.ca>
	<44BCA09D.1050103@pobox.com>
Message-ID: <44BD4E49.4000302@optionsdsl.ca>

Torgeir Veimo wrote:
> Dave wrote:
>   
>> Here is the actual log entry:
>>
>> Jul 17 22:33:32 vdr vdr: [8262] [softdevice-audio] Rate 24000 Hz is not
>> possible (and using instead 48000 Hz is not implemented) FATAL exiting
>>
>> This drives me nuts!
>>     
>
> Did you try changing the exit(1); in line 335 in audio-alsa.c to return 0; ?
>
> It's probably not enough, but not having a stream to check with makes it 
> a bit difficult to test. Can you make a recording where the audio 
> changes from 48000 to 24000 and upload it somewhere?
>
>
>   
I dont have any stream at the moment, This happens because there is an
error in the stream, loss of signal, wind/rain, etc.  Id just rather
have it recover from it than exit from it. I lose many recordings/timers
from other good signals on other DVB cards because one had an error in it. 

Ill try to get a stream of it.




From phelin at googlemail.com  Wed Jul 19 10:16:51 2006
From: phelin at googlemail.com (Petri Helin)
Date: Wed, 19 Jul 2006 11:16:51 +0300
Subject: [Softdevice-devel]  Blinking/flickering with dvb-subtitles
Message-ID: <3e063bbf0607190116p6cc01afvd6d2b5d2053ff6c1@mail.gmail.com>

Hi,

I am using softdevice from cvs (17.7.) with VDR 1.4.1 and
DVB-subtitles plugin. Softdevice uses xv. Whenever dvb-subtitles
appear/disappear there's a blink/flash/flicker which looks like the
whole screen goes black for a very short period of time. If OSD is
visible (e.g menu or progressbar), there is no flickering at all. I
have tried changing the deinteracing methods, but that doesn't seem to
have any effect. Any ideas how to correct this would be greatly
appreciated.

PS Otherwise everything seems to work quite well, so thank you for
this great plugin.

-Petri


From phelin at googlemail.com  Wed Jul 19 10:22:45 2006
From: phelin at googlemail.com (Petri Helin)
Date: Wed, 19 Jul 2006 11:22:45 +0300
Subject: [Softdevice-devel] Softplay not playing last seconds of mp3 and
	flac files
Message-ID: <3e063bbf0607190122o71371aefq14b6b506bbe97eed@mail.gmail.com>

Hi,

I am using softdevice and softplay from cvs (17.7.) with VDR 1.4.1.
Softdevice uses xv. Softplay seems to play both flac and mp3 files
quite nicely, but cuts many seconds from the end. Is that a feature or
can I change it somehow?

-Petri


From jonis2006 at yandex.ru  Wed Jul 19 13:33:21 2006
From: jonis2006 at yandex.ru (..::Misha::..)
Date: Wed, 19 Jul 2006 17:33:21 +0600
Subject: [Softdevice-devel] Broken Matrox RGB - is it possible to repair ?
Message-ID: <001a01c6ab27$290203f0$0b0e400a@misha>

Hello !

I have a problem: I broke RGB out on my Matrox G450 when connecting to TV, only composite is now  working. Seems broken G and B rays (color signals), repairing is possible ? Or where I can find another Matrox G450/G400/G550 ?

With best Regards.
Jonis.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060719/9d191cef/attachment.html>

From torgeir at pobox.com  Thu Jul 20 12:52:29 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Thu, 20 Jul 2006 11:52:29 +0100
Subject: [Softdevice-devel] pseudo alpha mmx2
In-Reply-To: <44BD0910.3080407@gmx.net>
References: <44B6CAED.8030502@pobox.com>	<44B7EF31.3040901@gmx.net>	<44BAD079.3020104@pobox.com>	<44BBB935.7070309@gmx.net>	<44BBBB12.7000909@pobox.com>	<44BBBDD8.8040209@gmx.net>	<44BC19FD.4090608@pobox.com>
	<44BD0910.3080407@gmx.net>
Message-ID: <44BF606D.7010106@pobox.com>

Martin Wache wrote:
> Torgeir Veimo schrieb:
>
>> What resolutions are you talking about? I'm displaying in 1280x1024 and 
>> 1280x720 without scaling. The OSD is shown pixel perfect on top of the 
>> video output.
>>
> 
> The FF cards have an OSD of the same resolution as the streams
> (720x576), and vdr renders the OSD in this same resolution. For software
> alpha blending we can usually just blend the osd over the stream (they
> have the same size), but if the screen has a higher (or lower)
> resolution we have to scale video and osd. The video is scaled by the
> hardware (except fb-out), and the osd is scaled by
> cSoftOsd::Scale(VUp/VDown)CopyToBitmap().

Sorry, my mistake. Now I see that in CVS version the OSD is indeed 
scaled even with pseudo transparency..




-- 
-Torgeir


From phelin at googlemail.com  Sat Jul 22 00:52:28 2006
From: phelin at googlemail.com (Petri Helin)
Date: Sat, 22 Jul 2006 01:52:28 +0300
Subject: [Softdevice-devel] Blinking/flickering with dvb-subtitles
In-Reply-To: <3e063bbf0607190116p6cc01afvd6d2b5d2053ff6c1@mail.gmail.com>
References: <3e063bbf0607190116p6cc01afvd6d2b5d2053ff6c1@mail.gmail.com>
Message-ID: <3e063bbf0607211552g4d382380y4bca2105539c6185@mail.gmail.com>

On 7/19/06, Petri Helin <phelin at googlemail.com> wrote:
> Hi,
>
> I am using softdevice from cvs (17.7.) with VDR 1.4.1 and
> DVB-subtitles plugin. Softdevice uses xv. Whenever dvb-subtitles
> appear/disappear there's a blink/flash/flicker which looks like the
> whole screen goes black for a very short period of time. If OSD is
> visible (e.g menu or progressbar), there is no flickering at all. I
> have tried changing the deinteracing methods, but that doesn't seem to
> have any effect. Any ideas how to correct this would be greatly
> appreciated.
>
> PS Otherwise everything seems to work quite well, so thank you for
> this great plugin.
>
> -Petri
>

I think I mannaged to solve this problem, though I am not sure if
there are any side effects with this solution. I simply commented out
the XClearArea in CloseOSD.


--- softdevice/video-xv.c       2006-07-16 05:09:22.000000000 +0300
+++ softdevice-mod/video-xv.c   2006-07-22 01:37:18.000000000 +0300
@@ -1401,7 +1401,7 @@
   {
     memset (osd_buffer, 0, osd_image->bytes_per_line * osd_max_height);
     pthread_mutex_lock(&xv_mutex);
-    XClearArea (dpy, win, 0, 0, 0, 0, False);
+    //XClearArea (dpy, win, 0, 0, 0, 0, False);
     ShowOSD();
     XSync(dpy, False);
     pthread_mutex_unlock(&xv_mutex);


-Petri


From ragawu at gmail.com  Sat Jul 22 07:05:43 2006
From: ragawu at gmail.com (Alasdair Campbell)
Date: Sat, 22 Jul 2006 06:05:43 +0100
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <20060717121919.GA3692@localhost.localdomain>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<20060716193223.GA4098@localhost.localdomain>
	<1849e5180607161334g7d02834fjc94642f44f0be6e@mail.gmail.com>
	<20060717121919.GA3692@localhost.localdomain>
Message-ID: <1849e5180607212205t4b638342wd61d592600af04f6@mail.gmail.com>

On 17/07/06, Marko M?kel? <marko.makela at hut.fi> wrote:
> On Sun, Jul 16, 2006 at 09:34:32PM +0100, Alasdair Campbell wrote:
> > On 16/07/06, Marko M?kel? <marko.makela at hut.fi> wrote:
> > > On Sun, Jul 16, 2006 at 05:37:00PM +0100, Alasdair Campbell wrote:
> > > > I've been having trouble getting the interlaced output of the G450
> > > > working correctly.
> > > > With current CVS, DirectFB 0..25.1 & current CVS FFMPEG no matter
> > > > whether I set the post-processing option "Deinterlace method" to
> > > > 'none' or 'FB-intern' I still see lines (interlacing artifacts) where
> > > > there is quick movement or scrolling text/credits.
> > >
> > > Stefan Lucke replaced the scaler one or two months ago.  It works for me,
> > > although with DirectFB CVS the OSD is broken since some weeks.  I think
> > > I'll revert to the latest official release of DirectFB.
> > >
> >
> > I had the problem with the broken OSD, seemed like it was linked to
> > the interlacing as only half was visible and it flickered like crazy.
> >
> > If it works for you then I must be doing something stupid, which
> > wouldn't surprise me, as I'm flying by the seat of my pants where
> > linux is concerned.
>
> I reverted to DirectFB 0.9.25.1 today morning, and OSD is flicker free again.
> DirectFB CVS is rather useless for me on -vo dfb:mgatv, because
> DVB subtitles would be unavailable.

I've not got to the stage of getting the subtitles working yet, though
I'll make a note of this.

> Note that when compiling DirectFB from source, you should install DirectFB
> first and only then compile and install DFB++.  Otherwise, DFB++ will
> depend on the wrong DirectFB library.

Thats one of the few things I did right, made sense to compile in that order.

>
> > How did you compile FFMPEG?
>
> ./configure --extra-cflags='-march=pentium3 -ffast-math' --disable-encoders --disable-strip --disable-network --enable-gpl
>

Compiled latest SVN of ffmpeg using this command (excluding cpu specific stuff).

> For DirectFB, I use the following configuration:
>
> ./configure --disable-{unique,multi,fusion,text,mpeg,jpeg,gif,png,freetype,video4linux,video4linux2} --with-inputdrivers=linuxinput --with-gfxdrivers=matrox C{,XX}FLAGS=-march=pentium3
>
> For softdevice, I use the following:
>
> ./configure --disable-{vidix,fb,xv,shm,subplugins}
>

Here I had to manually point the configure script to the directory
where ffmpeg was installed (/usr/local/include.ffmpeg).

> If you have multiple versions of the libraries laying around, you should
> perhaps check the dependencies
> (ldd vdr-1.4.0/PLUGINS/lib/libvdr-softdevice.so.1.4.0).
>

I decided to clean everything out, just incase I was making school-boy errors.

> > If I set CropMode to 4:3 then the overscan is too severe.
>
> I guess it's a matter of taste.
>
> > *If someone knows a definitive answer to this I would be greatful for
> > the email.
>
> According to cvs log video-dfb.c, the field-based scaler was introduced
> in revision 1.60 on May 7, 2006.  Last Matrox related changes were in
> the most recent revision (1.68).  The last release (0.2.3) should be
> based on revision 1.58.  So, you will need the CVS version of softdevice.
>

Using CVS softdevice.

> > Hardware is biostar nforce2 based motherboard, underclocked &
> > undervolted athlon 2500 barton, 512MB ram, one atapi disk, two kworld
> > vstream dvb-t pci cards
>
> Okay, neither the CPU nor the I/O should be overloaded.  I think you should
> double check that you are running the correct version of DirectFB and
> softdevice.  I don't think that ffmpeg version is that important.  Mine
> is a CVS snapshot from a few months ago.

Well one thing that has changed is that the only Deinterlace method
available is lavc ( as opposed to before, where I had FB-Intern and a
bunch of others). This may be crazy talk but I had always thought that
FB-Intern was the option I was trying to get to work right. (When I
chose this before I saw the exact same as with 'none', ie interlacing
artifacts on some channels/programmes).

With 'lavc' selected there are no interlacing artifacts, cpu usage
seems to go up 10%, and the current problems I'm having with audio
sync seem to get worse.

With 'none' selected I see interlacing artifacts on certain channels/programmes.

With the screen aspect in softdevice set to 16:9 these artifacts do
not appear, however the aspect ratio is incorrect with vertical
stretching.

As I have video through softdevice working well with deinterlace set
to lavc, I'm tempted to just leave it as it is and concentrate on
pin-pointing the audio sync problems.

However, I'm also keen on getting all the hardware accelerated
features of this card working correctly.

> On Sun, Jul 16, 2006 at 09:34:32PM +0100, Alasdair Campbell wrote:
> > *If someone knows a definitive answer to this I would be greatful for
> > the email.
>

I was looking for a definitive answer to this question:

"Can SoftDevice scale 16:9 interlaced video to a 4:3 TV with Matrox
G450 hardware interlaced output?"

> According to cvs log video-dfb.c, the field-based scaler was introduced
> in revision 1.60 on May 7, 2006.

You may be answering the question here, but I can't tell for sure.

Thanks for all your help


From jmbaty at free.fr  Sat Jul 22 11:37:18 2006
From: jmbaty at free.fr (Anne et Jean-Marc Baty)
Date: Sat, 22 Jul 2006 11:37:18 +0200
Subject: [Softdevice-devel] Way to get best image quality with MGA400 ?
Message-ID: <44C1F1CE.4090401@free.fr>

Hello,

I've got a vdr client with a MGA400 DH. For the moment this machine use 
a dxr3 card but it isn't perfect, i think using softdevice on the mga400 
whith directfb should be better.
But i don't understand howto get softdevice working with interlacing video.
Which type of cable do i need ? When i select an interlaced mode in 
mgafb  on the TVout i get a double vertical image. if i select an 
non-interlaced I've got interlaced acterfacts.
I see on http://softdevice.berlios.de/ that the mga400 can generating an 
interlaced video signal on the vga connector. So i need to build a vga 
to scart cable like 
http://www.obsolyte.com/sunFAQ/faq_framebuffer/fbfaq_files/scart.gif
or http://forum.matrox.com/mga/viewtopic.php?t=4383 (but i don't know if 
this cable work with mga400)
Next i want to TV automatically switch on the good input so i should 
give +5V on the SCART pin 8, perhaps i could take +5v on the VGA pin 9 ?
On which head should I connect this cable ?

On the software side, I'm, using Debian Etch, with Directfb-0.23, and 
vdr and softdevice-plugin from e-tobi, kernel is custom one with all 
matroxfb-patch apply. What other do i need ?

Tanks for any anwser, and sorry for my poor english...

JMB






From marko.makela at hut.fi  Sat Jul 22 21:28:23 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sat, 22 Jul 2006 22:28:23 +0300
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <1849e5180607212205t4b638342wd61d592600af04f6@mail.gmail.com>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<20060716193223.GA4098@localhost.localdomain>
	<1849e5180607161334g7d02834fjc94642f44f0be6e@mail.gmail.com>
	<20060717121919.GA3692@localhost.localdomain>
	<1849e5180607212205t4b638342wd61d592600af04f6@mail.gmail.com>
Message-ID: <20060722192823.GA4001@localhost.localdomain>

On Sat, Jul 22, 2006 at 06:05:43AM +0100, Alasdair Campbell wrote:
> > DirectFB CVS is rather useless for me on -vo dfb:mgatv, because
> > DVB subtitles would be unavailable.
> 
> I've not got to the stage of getting the subtitles working yet, though
> I'll make a note of this.

For the record, I referred to the vdr-subtitles plugin
(http://www.virtanen.org/vdr/subtitles/) that implements the bitmapped
subtitle layer defined in the DVB standards.  It is implemented on the
OSD layer, similar to menus.

> > ./configure --disable-{vidix,fb,xv,shm,subplugins}
> >
> 
> Here I had to manually point the configure script to the directory
> where ffmpeg was installed (/usr/local/include.ffmpeg).

Hm, shouldn't "make install" put it to --prefix=/usr/local by default,
e.g., /usr/local/include, /usr/local/lib, etc.?

> Well one thing that has changed is that the only Deinterlace method
> available is lavc ( as opposed to before, where I had FB-Intern and a
> bunch of others). This may be crazy talk but I had always thought that
> FB-Intern was the option I was trying to get to work right. (When I
> chose this before I saw the exact same as with 'none', ie interlacing
> artifacts on some channels/programmes).

Aren't you using -vo dfb:mgatv, i.e., TV output?  It should be interlaced,
and you shouldn't need any deinterlacing.  Deinterlacing is only needed
on VGA or DVI output, as far as I know.

> With the screen aspect in softdevice set to 16:9 these artifacts do
> not appear, however the aspect ratio is incorrect with vertical
> stretching.

My vdr box is switched off right now, but are you aware that there are two
menu items (in different menus) related to this: the screen aspect ratio
(which I have set to 4:3) and the crop mode (which I usually set to 4:3,
meaning that the left and right borders are cut off).  When a 16:9 program
is running, I can change the crop mode (to "none" or "16:9") without seeing
any interlacing artefacts.  Both fields are scaled separately, as they
should.  Before video-dfb.c revision 1.60 (the old frame-based scaler),
horizontal movement caused weird waves on the screen.

> I was looking for a definitive answer to this question:
> 
> "Can SoftDevice scale 16:9 interlaced video to a 4:3 TV with Matrox
> G450 hardware interlaced output?"

It works for me, and I guess it must also work for Stefan Lucke, who wrote
the field-based scaler.

If you could make a short 16:9 clip available on some http server and
tell the URL to me, I can check it on my system and tell if it looks okay.
The clip should preferrably contain horizontal movement and be interlaced
in the first place (not a movie).  Maybe there is something unusual in
the DVB streams you receive, e.g., different field order.

	Marko


From lucianm at users.sourceforge.net  Mon Jul 24 10:19:08 2006
From: lucianm at users.sourceforge.net (Lucian Muresan)
Date: Mon, 24 Jul 2006 10:19:08 +0200
Subject: [Softdevice-devel] Way to get best image quality with MGA400 ?
In-Reply-To: <44C1F1CE.4090401@free.fr>
References: <44C1F1CE.4090401@free.fr>
Message-ID: <44C4827C.4050408@users.sourceforge.net>

Hi Jean-Marc,

Anne et Jean-Marc Baty wrote:
> Hello,
> 
> I've got a vdr client with a MGA400 DH. For the moment this machine use 
> a dxr3 card but it isn't perfect, i think using softdevice on the mga400 
> whith directfb should be better.

I'm getting very good image quality in RGB mode over SCART to my 
standard PAL TV, as long as the software I'm using (softdevice/DirectFB, 
df_xine, or even fbxine/DirectFB) plays nice and doesn't try to 
deinterlace frames, or put them in the wrong order. With current CVS 
DirectFB and softdevice (well, as from 1 or 2 weeks now) this works very 
well, only there is a bug in DirectFB (I wonder, where, and who and when 
will fix that) which messes up OSD.

> But i don't understand howto get softdevice working with interlacing video.
> Which type of cable do i need ? When i select an interlaced mode in 
> mgafb  on the TVout i get a double vertical image. if i select an 
> non-interlaced I've got interlaced acterfacts.
> I see on http://softdevice.berlios.de/ that the mga400 can generating an 
> interlaced video signal on the vga connector. So i need to build a vga 
> to scart cable like 
> http://www.obsolyte.com/sunFAQ/faq_framebuffer/fbfaq_files/scart.gif
> or http://forum.matrox.com/mga/viewtopic.php?t=4383 (but i don't know if 
> this cable work with mga400)

You're saying you have a MGA400 DH, just like mine, so for getting a 
perfect TV-out you really should use the CRTC2 output, not the primary 
VGA. Threfore, the right cable for this is this one:
: http://forum.matrox.com/mga/viewtopic.php?t=4382

> Next i want to TV automatically switch on the good input so i should 
> give +5V on the SCART pin 8, perhaps i could take +5v on the VGA pin 9 ?
> On which head should I connect this cable ?

For automatic switching, I did this little hack, using the RGB_EN signal 
from the other diagram, to also drive SCART pin 8:
http://www.muresan.de/htpc/VGA-RGB_SCART_switching.png

Hope this helps,
Lucian



From ragawu at gmail.com  Tue Jul 25 11:23:15 2006
From: ragawu at gmail.com (Alasdair Campbell)
Date: Tue, 25 Jul 2006 10:23:15 +0100
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <20060722192823.GA4001@localhost.localdomain>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<20060716193223.GA4098@localhost.localdomain>
	<1849e5180607161334g7d02834fjc94642f44f0be6e@mail.gmail.com>
	<20060717121919.GA3692@localhost.localdomain>
	<1849e5180607212205t4b638342wd61d592600af04f6@mail.gmail.com>
	<20060722192823.GA4001@localhost.localdomain>
Message-ID: <1849e5180607250223m114e8d61qfde92def54e06435@mail.gmail.com>

On 22/07/06, Marko M?kel? <marko.makela at hut.fi> wrote:
> For the record, I referred to the vdr-subtitles plugin
> (http://www.virtanen.org/vdr/subtitles/) that implements the bitmapped
> subtitle layer defined in the DVB standards.  It is implemented on the
> OSD layer, similar to menus.

Thanks for that link, I now have subtitles working really well.

> Hm, shouldn't "make install" put it to --prefix=/usr/local by default,
> e.g., /usr/local/include, /usr/local/lib, etc.?

I thought that too,
>
> > Well one thing that has changed is that the only Deinterlace method
> > available is lavc ( as opposed to before, where I had FB-Intern and a
> > bunch of others). This may be crazy talk but I had always thought that
> > FB-Intern was the option I was trying to get to work right. (When I
> > chose this before I saw the exact same as with 'none', ie interlacing
> > artifacts on some channels/programmes).
>
> Aren't you using -vo dfb:mgatv, i.e., TV output?  It should be interlaced,
> and you shouldn't need any deinterlacing.  Deinterlacing is only needed
> on VGA or DVI output, as far as I know.

Well the question in the first email was whether I should use -vo dfb
or -vo dfb:mgatv! I also mentioned that I was using a home made vga to
scart cable. I do not own the matrox tv out adaptor. I believe that
when I was using CVS DirectFB the interlaced output worked with "-vo
dfb:" although the OSD was halved, enlarged and flickered. Also there
was a copy of the video stream above the 16:9 stream. I will confirm
this soon.

> My vdr box is switched off right now, but are you aware that there are two
> menu items (in different menus) related to this: the screen aspect ratio
> (which I have set to 4:3) and the crop mode (which I usually set to 4:3,
> meaning that the left and right borders are cut off).  When a 16:9 program
> is running, I can change the crop mode (to "none" or "16:9") without seeing
> any interlacing artefacts.

I have screen aspect ratio to 4:3 and crop mode to "none" - I can see
the artifacts. The majority of tv in the uk is now broadcast in 16:9,
so I have no need to change crop mode back to 4:3 really. Also,
softdevce seems to manage to scale 4:3 correctly without any cropping!


> If you could make a short 16:9 clip available on some http server and
> tell the URL to me, I can check it on my system and tell if it looks okay.
> The clip should preferrably contain horizontal movement and be interlaced
> in the first place (not a movie).  Maybe there is something unusual in
> the DVB streams you receive, e.g., different field order.

Here is a clip of the BBC rolling news channel, I can see LOTs of
artifacts with the camera movements, and the scrolling text at the
bottom looks poor:

http://ginezbukov.com/artifacts.tar.bz2

-- 
A l a s d a i r   C a m p b e l l

r a g a w u @ g m a i l . c o m


From marko.makela at hut.fi  Tue Jul 25 17:31:15 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 25 Jul 2006 18:31:15 +0300
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <1849e5180607250223m114e8d61qfde92def54e06435@mail.gmail.com>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<20060716193223.GA4098@localhost.localdomain>
	<1849e5180607161334g7d02834fjc94642f44f0be6e@mail.gmail.com>
	<20060717121919.GA3692@localhost.localdomain>
	<1849e5180607212205t4b638342wd61d592600af04f6@mail.gmail.com>
	<20060722192823.GA4001@localhost.localdomain>
	<1849e5180607250223m114e8d61qfde92def54e06435@mail.gmail.com>
Message-ID: <20060725153115.GB3654@localhost.localdomain>

On Tue, Jul 25, 2006 at 10:23:15AM +0100, Alasdair Campbell wrote:
> Well the question in the first email was whether I should use -vo dfb
> or -vo dfb:mgatv! I also mentioned that I was using a home made vga to
> scart cable.

Sorry, I must have missed that.  You should use -vo dfb:mgatv for TV output.
My home made G450 to SCART cable probably looks like this:

http://forum.matrox.com/mga/viewtopic.php?t=4383

If not, it's adapted from one of the schematics listed
at http://forum.matrox.com/mga/viewforum.php?f=52

I'd be interested in your cable schematics, if you managed to get a picture
from SCART.  I'd like to try out a plain VGA modeline on an interlaced
RGB video monitor.  That would allow me to use the I420 colour space and
thus avoid costly colour space conversion.  The -vo dfb:mgatv output requires
a colour space transformation (between YV12 and YUY2 if I remember correctly)
that costs 10% to 20% of CPU.

> Here is a clip of the BBC rolling news channel, I can see LOTs of
> artifacts with the camera movements, and the scrolling text at the
> bottom looks poor:

Thanks, I downloaded it and will have a look later, hopefully tonight.
Horizontally scrolling text is excellent for this purpose.

	Marko


From ragawu at gmail.com  Tue Jul 25 19:04:36 2006
From: ragawu at gmail.com (Alasdair Campbell)
Date: Tue, 25 Jul 2006 18:04:36 +0100
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <20060725153115.GB3654@localhost.localdomain>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<20060716193223.GA4098@localhost.localdomain>
	<1849e5180607161334g7d02834fjc94642f44f0be6e@mail.gmail.com>
	<20060717121919.GA3692@localhost.localdomain>
	<1849e5180607212205t4b638342wd61d592600af04f6@mail.gmail.com>
	<20060722192823.GA4001@localhost.localdomain>
	<1849e5180607250223m114e8d61qfde92def54e06435@mail.gmail.com>
	<20060725153115.GB3654@localhost.localdomain>
Message-ID: <1849e5180607251004l54d7ea1bl69b0cb846882b80b@mail.gmail.com>

On 25/07/06, Marko M?kel? <marko.makela at hut.fi> wrote:

> Sorry, I must have missed that.  You should use -vo dfb:mgatv for TV output.

when you say TV output what do you mean? This is one of the crucial
questions that I can't answer, as I presumed TV output was just the
directfb driver generating a PAL modeline.

I would like to know the differences between '-vo dfb' and '-vo
dfb:mgatv'. I wonder who is the expert and whether they feel up to
explaining it somewhere....

> My home made G450 to SCART cable probably looks like this:
>
> http://forum.matrox.com/mga/viewtopic.php?t=4383

My cable is built using the same circuit!

> I'd be interested in your cable schematics, if you managed to get a picture
> from SCART.

Have you not got a picture using the circuit above?!

> I'd like to try out a plain VGA modeline on an interlaced
> RGB video monitor.

I had this with my Radeon 9200SE but couldn't get a good enough
picture. Was VERY difficult to tweak the settings as there is no real
time update like with PowerStrip on XP.

> That would allow me to use the I420 colour space and
> thus avoid costly colour space conversion.  The -vo dfb:mgatv output requires
> a colour space transformation (between YV12 and YUY2 if I remember correctly)
> that costs 10% to 20% of CPU.

CPU is definetly reduced when I run "softdevice -vo dfb:". I will do
some invistigating tonight. there is currently another thread on this
list discussing the very same thing.

I would love to save that much too!, remember I'm looking to build a
very low powered system. as well as my main VDR box.

> Thanks, I downloaded it and will have a look later, hopefully tonight.
> Horizontally scrolling text is excellent for this purpose.

You should see the artifacts easily enough with the main picture!

-- 
A l a s d a i r   C a m p b e l l

r a g a w u @ g m a i l . c o m


From marko.makela at hut.fi  Tue Jul 25 21:16:49 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 25 Jul 2006 22:16:49 +0300
Subject: [Softdevice-devel] scaling problem in g450 interlaced output
In-Reply-To: <1849e5180607251004l54d7ea1bl69b0cb846882b80b@mail.gmail.com>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<20060716193223.GA4098@localhost.localdomain>
	<1849e5180607161334g7d02834fjc94642f44f0be6e@mail.gmail.com>
	<20060717121919.GA3692@localhost.localdomain>
	<1849e5180607212205t4b638342wd61d592600af04f6@mail.gmail.com>
	<20060722192823.GA4001@localhost.localdomain>
	<1849e5180607250223m114e8d61qfde92def54e06435@mail.gmail.com>
	<20060725153115.GB3654@localhost.localdomain>
	<1849e5180607251004l54d7ea1bl69b0cb846882b80b@mail.gmail.com>
Message-ID: <20060725191649.GA3656@localhost.localdomain>

On Tue, Jul 25, 2006 at 06:04:36PM +0100, Alasdair Campbell wrote:
> On 25/07/06, Marko M?kel? <marko.makela at hut.fi> wrote:
> 
> > Sorry, I must have missed that.  You should use -vo dfb:mgatv for TV output.
> 
> when you say TV output what do you mean? This is one of the crucial
> questions that I can't answer, as I presumed TV output was just the
> directfb driver generating a PAL modeline.

I mean a composite sync signal with 15625 Hz line rate (horizontal sync)
and 50 Hz field rate (vertical sync) and 25 Hz frame rate (interlaced output).
My monitor is a Commodore 1084 a.k.a. Philips CM8833.  It is a PAL and RGB
monitor from the era of the Commodore Amiga 500.  Its SCART connector is
somewhat non-standard.  On separate connectors, it also supports an S-video
like interface as well as separate hsync and vsync.  However, on the SCART
it only supports composite sync, as far as I know.

I once tried to get composite video output from my vdr box (to record
something to a VHS video cassette recorder) but failed, even after tweaking
the cable.  The VCR would ignore the RGB signals and only record black video
from the composite sync signal.  Some TVs require a voltage to be applied
to some SCART connector pin in order to activate RGB input.  Otherwise, you'd
only see black screen.

> I would like to know the differences between '-vo dfb' and '-vo
> dfb:mgatv'. I wonder who is the expert and whether they feel up to
> explaining it somewhere....

AFAIK, for -vo dfb:mgatv, you will have to use the second head.  The first
head is useable for a VGA monitor (Linux console) while the second head
outputs video.

For -vo dfb, I believe that no composite sync signal is generated.  It should
be like VGA video (separate hsync and vsync signals).  Thus, you can't use
it for SCART input without building a composite sync generator, unless I'm
mistaken.  In theory, you can use either head, but I didn't try with two
VGA monitors.  For some time, I used a VGA monitor at 75 kHz, sometimes
without a deinterlacer.

> My cable is built using the same circuit!
> 
> > I'd be interested in your cable schematics, if you managed to get a picture
> > from SCART.
> 
> Have you not got a picture using the circuit above?!

I meant from -vo dfb.  The cable only works for -vo dfb:mgatv.

> I had this with my Radeon 9200SE but couldn't get a good enough
> picture. Was VERY difficult to tweak the settings as there is no real
> time update like with PowerStrip on XP.

Back when I had an old 75 kHz/70 Hz fixed-sync monitor in active use,
I used xvidtune to fine-tune the settings under XFree86.  AFAIR, one
could tune anything except the dotclock and the active resolution in
real time.  I think that the X.org and DirectFB mode lines are equivalent,
maybe with a slightly different format.

> > Thanks, I downloaded it and will have a look later, hopefully tonight.
> > Horizontally scrolling text is excellent for this purpose.
> 
> You should see the artifacts easily enough with the main picture!

I can confirm the artifacts when using any vertically scaled output.
Only the 4:3 crop mode (with the sides cut out) looks fine.

	Marko


From M.Wache at gmx.net  Tue Jul 25 22:22:12 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 25 Jul 2006 22:22:12 +0200
Subject: [Softdevice-devel] Softplay not playing last seconds of mp3 and
 flac files
In-Reply-To: <3e063bbf0607190122o71371aefq14b6b506bbe97eed@mail.gmail.com>
References: <3e063bbf0607190122o71371aefq14b6b506bbe97eed@mail.gmail.com>
Message-ID: <44C67D74.8050202@gmx.net>

Petri Helin schrieb:
> Hi,
> 
> I am using softdevice and softplay from cvs (17.7.) with VDR 1.4.1.
> Softdevice uses xv. Softplay seems to play both flac and mp3 files
> quite nicely, but cuts many seconds from the end. Is that a feature or
> can I change it somehow?
> 
Please try the latest CVS version, this should be fixed now.

Bye,
Martin


From M.Wache at gmx.net  Tue Jul 25 22:24:45 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 25 Jul 2006 22:24:45 +0200
Subject: [Softdevice-devel] Exit out on wrong audio rates?
In-Reply-To: <44BCA09D.1050103@pobox.com>
References: <44BADF87.7020001@optionsdsl.ca>
	<44BAE135.4050306@pobox.com>	<44BC4A81.2040605@optionsdsl.ca>
	<44BCA09D.1050103@pobox.com>
Message-ID: <44C67E0D.9050306@gmx.net>

Torgeir Veimo schrieb:
> Dave wrote:
>> Here is the actual log entry:
>>
>> Jul 17 22:33:32 vdr vdr: [8262] [softdevice-audio] Rate 24000 Hz is not
>> possible (and using instead 48000 Hz is not implemented) FATAL exiting
>>
>> This drives me nuts!
> 
> Did you try changing the exit(1); in line 335 in audio-alsa.c to return 0; ?
> 
> It's probably not enough, but not having a stream to check with makes it 
> a bit difficult to test. Can you make a recording where the audio 
> changes from 48000 to 24000 and upload it somewhere?
> 
> 
I changed audio-alsa not to exit if the hardware is not able to audio
format. Please report it if there are problems.

Bye,
Martin


From dave at optionsdsl.ca  Wed Jul 26 01:40:48 2006
From: dave at optionsdsl.ca (Dave)
Date: Tue, 25 Jul 2006 19:40:48 -0400
Subject: [Softdevice-devel] Exit out on wrong audio rates?
In-Reply-To: <44C67E0D.9050306@gmx.net>
References: <44BADF87.7020001@optionsdsl.ca>	<44BAE135.4050306@pobox.com>	<44BC4A81.2040605@optionsdsl.ca>	<44BCA09D.1050103@pobox.com>
	<44C67E0D.9050306@gmx.net>
Message-ID: <44C6AC00.8020803@optionsdsl.ca>

Martin Wache wrote:
> Torgeir Veimo schrieb:
>   
>> Dave wrote:
>>     
>>> Here is the actual log entry:
>>>
>>> Jul 17 22:33:32 vdr vdr: [8262] [softdevice-audio] Rate 24000 Hz is not
>>> possible (and using instead 48000 Hz is not implemented) FATAL exiting
>>>
>>> This drives me nuts!
>>>       
>> Did you try changing the exit(1); in line 335 in audio-alsa.c to return 0; ?
>>
>> It's probably not enough, but not having a stream to check with makes it 
>> a bit difficult to test. Can you make a recording where the audio 
>> changes from 48000 to 24000 and upload it somewhere?
>>
>>
>>     
> I changed audio-alsa not to exit if the hardware is not able to audio
> format. Please report it if there are problems.
>
> Bye,
> Martin
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://bat.berlios.de/mailman/listinfo/softdevice-devel
>
>   
Thanks! I will give it a shot!



From phelin at googlemail.com  Wed Jul 26 08:53:56 2006
From: phelin at googlemail.com (Petri Helin)
Date: Wed, 26 Jul 2006 09:53:56 +0300
Subject: [Softdevice-devel] Softplay not playing last seconds of mp3 and
	flac files
In-Reply-To: <44C67D74.8050202@gmx.net>
References: <3e063bbf0607190122o71371aefq14b6b506bbe97eed@mail.gmail.com>
	<44C67D74.8050202@gmx.net>
Message-ID: <3e063bbf0607252353u116a97aaqca287fbb0f40ac20@mail.gmail.com>

On 7/25/06, Martin Wache <M.Wache at gmx.net> wrote:
> Petri Helin schrieb:
> > Hi,
> >
> > I am using softdevice and softplay from cvs (17.7.) with VDR 1.4.1.
> > Softdevice uses xv. Softplay seems to play both flac and mp3 files
> > quite nicely, but cuts many seconds from the end. Is that a feature or
> > can I change it somehow?
> >
> Please try the latest CVS version, this should be fixed now.
>

Actually, it looks like I discovered to right culprit earlier this
week...  You have changed the upper limit for count in the
FlushDevice's while loop to 200 in SoftPlayer.c, but what I tested,
that is not enough. I have been now using 1000 which seems to be
satisfactory. In most of the cases count went up to 955.

But I will test this later today for it looks like you have made some
additional changes.

-Petri


From herbert at 13thfloor.at  Wed Jul 26 15:37:10 2006
From: herbert at 13thfloor.at (Herbert Poetzl)
Date: Wed, 26 Jul 2006 15:37:10 +0200
Subject: [Softdevice-devel] Way to get best image quality with MGA400 ?
In-Reply-To: <44C4827C.4050408@users.sourceforge.net>
References: <44C1F1CE.4090401@free.fr> <44C4827C.4050408@users.sourceforge.net>
Message-ID: <20060726133710.GA11859@MAIL.13thfloor.at>

On Mon, Jul 24, 2006 at 10:19:08AM +0200, Lucian Muresan wrote:
> Hi Jean-Marc,
> 
> Anne et Jean-Marc Baty wrote:
> > Hello,
> > 
> > I've got a vdr client with a MGA400 DH. For the moment this machine
> > use a dxr3 card but it isn't perfect, i think using softdevice on
> > the mga400 whith directfb should be better.
>
> I'm getting very good image quality in RGB mode over SCART
> to my standard PAL TV, as long as the software I'm using
> (softdevice/DirectFB, df_xine, or even fbxine/DirectFB) plays nice and
> doesn't try to deinterlace frames, or put them in the wrong order.
> With current CVS DirectFB and softdevice (well, as from 1 or 2 weeks
> now) this works very well, only there is a bug in DirectFB (I wonder,
> where, and who and when will fix that) which messes up OSD.
> 
> > But i don't understand howto get softdevice working with
> > interlacing video. Which type of cable do i need ? When i
> > select an interlaced mode in mgafb on the TVout i get a
> > double vertical image. if i select an non-interlaced I've got
> > interlaced acterfacts. I see on http://softdevice.berlios.de/
> > that the mga400 can generating an interlaced video signal on
> > the vga connector. So i need to build a vga to scart cable like
> > http://www.obsolyte.com/sunFAQ/faq_framebuffer/fbfaq_files/scart.gif
> > or http://forum.matrox.com/mga/viewtopic.php?t=4383 (but i don't
> > know if this cable work with mga400)
>
> You're saying you have a MGA400 DH, just like mine, so for getting
> a perfect TV-out you really should use the CRTC2 output, not the
> primary VGA. Threfore, the right cable for this is this one: :
> http://forum.matrox.com/mga/viewtopic.php?t=4382
>
> > Next i want to TV automatically switch on the good input so i should
> > give +5V on the SCART pin 8, perhaps i could take +5v on the VGA pin
> > 9 ? On which head should I connect this cable ?
>
> For automatic switching, I did this little hack, using the RGB_EN
> signal from the other diagram, to also drive SCART pin 8:
> http://www.muresan.de/htpc/VGA-RGB_SCART_switching.png

just for the record, 'we' have been toying for some time with
a feasable solution for SCART pin 8 driving with no additional
power source in a simple and easy way (also allowing to select
the different pin 8 voltages to switch to 16:9 and 4:3), and
the best solution we came up so far is a simple circuit on the
serial port, which allows to do all that (simple means a few
diodes, and resistors and optionally two transistors), if there
is some interest, I'm willing to upload the circuit diagrams
somewhere ...

best,
Herbert

> Hope this helps,
> Lucian
> 
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://bat.berlios.de/mailman/listinfo/softdevice-devel


From laz at club-burniston.co.uk  Wed Jul 26 16:48:31 2006
From: laz at club-burniston.co.uk (Laz)
Date: Wed, 26 Jul 2006 15:48:31 +0100
Subject: [Softdevice-devel] Way to get best image quality with MGA400 ?
In-Reply-To: <20060726133710.GA11859@MAIL.13thfloor.at>
References: <44C1F1CE.4090401@free.fr> <44C4827C.4050408@users.sourceforge.net>
	<20060726133710.GA11859@MAIL.13thfloor.at>
Message-ID: <200607261548.31332.laz@club-burniston.co.uk>

On Wednesday 26 July 2006 14:37, Herbert Poetzl wrote:
> On Mon, Jul 24, 2006 at 10:19:08AM +0200, Lucian Muresan wrote:
> > For automatic switching, I did this little hack, using the RGB_EN
> > signal from the other diagram, to also drive SCART pin 8:
> > http://www.muresan.de/htpc/VGA-RGB_SCART_switching.png
>
> just for the record, 'we' have been toying for some time with
> a feasable solution for SCART pin 8 driving with no additional
> power source in a simple and easy way (also allowing to select
> the different pin 8 voltages to switch to 16:9 and 4:3), and
> the best solution we came up so far is a simple circuit on the
> serial port, which allows to do all that (simple means a few
> diodes, and resistors and optionally two transistors), if there
> is some interest, I'm willing to upload the circuit diagrams
> somewhere ...

I'm interested!

That's one thing which is still a bit of a pain: switch on the vdr box and 
then press about 3 buttons on my TV remote to set it to the right A-V 
input!

:(

I've thought about trying to do this in the past but never got round to 
it. Seems pointless reinventing the wheel, if someone else has done it!

Cheers,

Laz


From herbert at 13thfloor.at  Wed Jul 26 17:21:06 2006
From: herbert at 13thfloor.at (Herbert Poetzl)
Date: Wed, 26 Jul 2006 17:21:06 +0200
Subject: [Softdevice-devel] Way to get best image quality with MGA400 ?
In-Reply-To: <200607261548.31332.laz@club-burniston.co.uk>
References: <44C1F1CE.4090401@free.fr> <44C4827C.4050408@users.sourceforge.net>
	<20060726133710.GA11859@MAIL.13thfloor.at>
	<200607261548.31332.laz@club-burniston.co.uk>
Message-ID: <20060726152106.GB11812@MAIL.13thfloor.at>

On Wed, Jul 26, 2006 at 03:48:31PM +0100, Laz wrote:
> On Wednesday 26 July 2006 14:37, Herbert Poetzl wrote:
> > On Mon, Jul 24, 2006 at 10:19:08AM +0200, Lucian Muresan wrote:
> > > For automatic switching, I did this little hack, using the RGB_EN
> > > signal from the other diagram, to also drive SCART pin 8:
> > > http://www.muresan.de/htpc/VGA-RGB_SCART_switching.png
> >
> > just for the record, 'we' have been toying for some time with
> > a feasable solution for SCART pin 8 driving with no additional
> > power source in a simple and easy way (also allowing to select
> > the different pin 8 voltages to switch to 16:9 and 4:3), and
> > the best solution we came up so far is a simple circuit on the
> > serial port, which allows to do all that (simple means a few
> > diodes, and resistors and optionally two transistors), if there
> > is some interest, I'm willing to upload the circuit diagrams
> > somewhere ...
> 
> I'm interested!
> 
> That's one thing which is still a bit of a pain: switch on the vdr box
> and then press about 3 buttons on my TV remote to set it to the right
> A-V input!
> 
> :(
> 
> I've thought about trying to do this in the past but never got round
> to it. Seems pointless reinventing the wheel, if someone else has done
> it!

okay, here is what I could find on a quick check :)

the solutions are listed in chronological order, they
all work (for me) and have slightly different properties 
regarding adjustment, quality of voltages and amount of 
power drained from the serial port, also note that some
laptops only provide about +/-5V on the serial port
which is not enough to reach the 9.5-12V range required 
for the 4:3 mode, but it is sufficient to trigger the 
4.5-7V range (16:9) and/or to trigger the 'source has 
signal'

 http://www.13thfloor.at/~herbert/scart.eps
 http://www.13thfloor.at/~herbert/ser2scart.pdf
 http://www.13thfloor.at/~herbert/ser2scart_V2.pdf
 http://www.13thfloor.at/~herbert/ser2scart_V3.pdf

of course the std disclaimer applies here:
If you fry your computer or TV with one of the 
circuits, we do NOT accept any responsibility. 
Proceed at your own risk.

best,
Herbert

> Cheers,
> 
> Laz
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://bat.berlios.de/mailman/listinfo/softdevice-devel


From laz at club-burniston.co.uk  Wed Jul 26 17:26:15 2006
From: laz at club-burniston.co.uk (Laz)
Date: Wed, 26 Jul 2006 16:26:15 +0100
Subject: [Softdevice-devel] Way to get best image quality with MGA400 ?
In-Reply-To: <20060726152106.GB11812@MAIL.13thfloor.at>
References: <44C1F1CE.4090401@free.fr>
	<200607261548.31332.laz@club-burniston.co.uk>
	<20060726152106.GB11812@MAIL.13thfloor.at>
Message-ID: <200607261626.15753.laz@club-burniston.co.uk>

On Wednesday 26 July 2006 16:21, Herbert Poetzl wrote:
> On Wed, Jul 26, 2006 at 03:48:31PM +0100, Laz wrote:
> > That's one thing which is still a bit of a pain: switch on the vdr
> > box and then press about 3 buttons on my TV remote to set it to the
> > right A-V input!
> >
> > :(
> >
> > I've thought about trying to do this in the past but never got round
> > to it. Seems pointless reinventing the wheel, if someone else has
> > done it!
>
> okay, here is what I could find on a quick check :)
>
> the solutions are listed in chronological order, they
> all work (for me) and have slightly different properties
> regarding adjustment, quality of voltages and amount of
> power drained from the serial port, also note that some
> laptops only provide about +/-5V on the serial port
> which is not enough to reach the 9.5-12V range required
> for the 4:3 mode, but it is sufficient to trigger the
> 4.5-7V range (16:9) and/or to trigger the 'source has
> signal'
>
>  http://www.13thfloor.at/~herbert/scart.eps
>  http://www.13thfloor.at/~herbert/ser2scart.pdf
>  http://www.13thfloor.at/~herbert/ser2scart_V2.pdf
>  http://www.13thfloor.at/~herbert/ser2scart_V3.pdf
>
> of course the std disclaimer applies here:
> If you fry your computer or TV with one of the
> circuits, we do NOT accept any responsibility.
> Proceed at your own risk.

Looks good. All we need now is something to drive the serial port on 
startup and then on aspect-ratio change...

Cheers,

Laz


From herbert at 13thfloor.at  Wed Jul 26 17:32:19 2006
From: herbert at 13thfloor.at (Herbert Poetzl)
Date: Wed, 26 Jul 2006 17:32:19 +0200
Subject: [Softdevice-devel] Way to get best image quality with MGA400 ?
In-Reply-To: <200607261626.15753.laz@club-burniston.co.uk>
References: <44C1F1CE.4090401@free.fr>
	<200607261548.31332.laz@club-burniston.co.uk>
	<20060726152106.GB11812@MAIL.13thfloor.at>
	<200607261626.15753.laz@club-burniston.co.uk>
Message-ID: <20060726153218.GC11812@MAIL.13thfloor.at>

On Wed, Jul 26, 2006 at 04:26:15PM +0100, Laz wrote:
> On Wednesday 26 July 2006 16:21, Herbert Poetzl wrote:
> > On Wed, Jul 26, 2006 at 03:48:31PM +0100, Laz wrote:
> > > That's one thing which is still a bit of a pain: switch on the vdr
> > > box and then press about 3 buttons on my TV remote to set it to the
> > > right A-V input!
> > >
> > > :(
> > >
> > > I've thought about trying to do this in the past but never got round
> > > to it. Seems pointless reinventing the wheel, if someone else has
> > > done it!
> >
> > okay, here is what I could find on a quick check :)
> >
> > the solutions are listed in chronological order, they
> > all work (for me) and have slightly different properties
> > regarding adjustment, quality of voltages and amount of
> > power drained from the serial port, also note that some
> > laptops only provide about +/-5V on the serial port
> > which is not enough to reach the 9.5-12V range required
> > for the 4:3 mode, but it is sufficient to trigger the
> > 4.5-7V range (16:9) and/or to trigger the 'source has
> > signal'
> >
> >  http://www.13thfloor.at/~herbert/scart.eps
> >  http://www.13thfloor.at/~herbert/ser2scart.pdf
> >  http://www.13thfloor.at/~herbert/ser2scart_V2.pdf
> >  http://www.13thfloor.at/~herbert/ser2scart_V3.pdf
> >
> > of course the std disclaimer applies here:
> > If you fry your computer or TV with one of the
> > circuits, we do NOT accept any responsibility.
> > Proceed at your own risk.
> 
> Looks good. All we need now is something to drive the serial port on
> startup and then on aspect-ratio change...

oh, I forgot to attach the source code for a small tool
for such purpose, here it is:

 http://www.13thfloor.at/~herbert/serport.c

you use it like this:

 ./serport -p 0 0
 ./serport -p 0 1
 ./serport -p 0 2
 ./serport -p 0 3

best,
Herbert

> Cheers,
> 
> Laz
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://bat.berlios.de/mailman/listinfo/softdevice-devel


From laz at club-burniston.co.uk  Wed Jul 26 18:05:26 2006
From: laz at club-burniston.co.uk (Laz)
Date: Wed, 26 Jul 2006 17:05:26 +0100
Subject: [Softdevice-devel] Way to get best image quality with MGA400 ?
In-Reply-To: <20060726153218.GC11812@MAIL.13thfloor.at>
References: <44C1F1CE.4090401@free.fr>
	<200607261626.15753.laz@club-burniston.co.uk>
	<20060726153218.GC11812@MAIL.13thfloor.at>
Message-ID: <200607261705.26872.laz@club-burniston.co.uk>

On Wednesday 26 July 2006 16:32, Herbert Poetzl wrote:
> On Wed, Jul 26, 2006 at 04:26:15PM +0100, Laz wrote:
> > Looks good. All we need now is something to drive the serial port on
> > startup and then on aspect-ratio change...
>
> oh, I forgot to attach the source code for a small tool
> for such purpose, here it is:
>
>  http://www.13thfloor.at/~herbert/serport.c
>
> you use it like this:
>
>  ./serport -p 0 0
>  ./serport -p 0 1
>  ./serport -p 0 2
>  ./serport -p 0 3

Cheers.

It should be easy to build this into softdevice: just set the relevant 
states of DTR and RTS whenever the aspect ratio changes.

Hmmmm...I think you might need to run as root for that sort of control of 
the port, though. Unless we use something like your 'serport' as an SUID 
wrapper... I had to do that with a status LED plugin!

Cheers,

Laz


From M.Wache at gmx.net  Wed Jul 26 18:47:03 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Wed, 26 Jul 2006 18:47:03 +0200
Subject: [Softdevice-devel] Softplay not playing last seconds of mp3 and
 flac files
In-Reply-To: <3e063bbf0607252353u116a97aaqca287fbb0f40ac20@mail.gmail.com>
References: <3e063bbf0607190122o71371aefq14b6b506bbe97eed@mail.gmail.com>	<44C67D74.8050202@gmx.net>
	<3e063bbf0607252353u116a97aaqca287fbb0f40ac20@mail.gmail.com>
Message-ID: <44C79C87.9060601@gmx.net>

Petri Helin schrieb:
> On 7/25/06, Martin Wache <M.Wache at gmx.net> wrote:
>> Petri Helin schrieb:
>>> Hi,
>>>
>>> I am using softdevice and softplay from cvs (17.7.) with VDR 1.4.1.
>>> Softdevice uses xv. Softplay seems to play both flac and mp3 files
>>> quite nicely, but cuts many seconds from the end. Is that a feature or
>>> can I change it somehow?
>>>
>> Please try the latest CVS version, this should be fixed now.
>>
> 
> Actually, it looks like I discovered to right culprit earlier this
> week...  You have changed the upper limit for count in the
> FlushDevice's while loop to 200 in SoftPlayer.c, but what I tested,
> that is not enough. I have been now using 1000 which seems to be
> satisfactory. In most of the cases count went up to 955.
> 
> But I will test this later today for it looks like you have made some
> additional changes.
> 
Yes, but the change of the while loop is the only relevant one.

Hm, what codec is that where you need a count of 1000? Or did you switch
the softdevice buffer mode to HDTV?

I would not like just to increase the max. value of the while loop much
more. During the while loop softplay doesn't respond to keypresses (very
well). With a value of 200 that's 200*50ms = 10s. If you need more this
value will to increase...
Maybe we just need an additional criteria (running && !newFile) to get
around those problems. I will think about it and give it a try.

Bye,
Martin


From marko.makela at hut.fi  Wed Jul 26 21:02:27 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 26 Jul 2006 22:02:27 +0300
Subject: [Softdevice-devel] Way to get best image quality with MGA400 ?
In-Reply-To: <200607261705.26872.laz@club-burniston.co.uk>
References: <44C1F1CE.4090401@free.fr>
	<200607261626.15753.laz@club-burniston.co.uk>
	<20060726153218.GC11812@MAIL.13thfloor.at>
	<200607261705.26872.laz@club-burniston.co.uk>
Message-ID: <20060726190227.GA3733@localhost.localdomain>

On Wed, Jul 26, 2006 at 05:05:26PM +0100, Laz wrote:
> It should be easy to build this into softdevice: just set the relevant 
> states of DTR and RTS whenever the aspect ratio changes.
> 
> Hmmmm...I think you might need to run as root for that sort of control of 
> the port, though.

Why?  POSIX termios doesn't require any super-user privileges.

> Unless we use something like your 'serport' as an SUID 
> wrapper... I had to do that with a status LED plugin!

If you're using the parallel printer port, you should use ppdev instead of
the old ioperm() system call.

	Marko


From laz at club-burniston.co.uk  Fri Jul 28 12:13:49 2006
From: laz at club-burniston.co.uk (Laz)
Date: Fri, 28 Jul 2006 11:13:49 +0100
Subject: [Softdevice-devel] Way to get best image quality with MGA400 ?
In-Reply-To: <20060726190227.GA3733@localhost.localdomain>
References: <44C1F1CE.4090401@free.fr>
	<200607261705.26872.laz@club-burniston.co.uk>
	<20060726190227.GA3733@localhost.localdomain>
Message-ID: <200607281113.49907.laz@club-burniston.co.uk>

On Wednesday 26 July 2006 20:02, Marko M?kel? wrote:
> On Wed, Jul 26, 2006 at 05:05:26PM +0100, Laz wrote:
> > It should be easy to build this into softdevice: just set the
> > relevant states of DTR and RTS whenever the aspect ratio changes.
> >
> > Hmmmm...I think you might need to run as root for that sort of
> > control of the port, though.
>
> Why?  POSIX termios doesn't require any super-user privileges.

That's good news: makes life easier!

> > Unless we use something like your 'serport' as an SUID
> > wrapper... I had to do that with a status LED plugin!
>
> If you're using the parallel printer port, you should use ppdev instead
> of the old ioperm() system call.

Ahhh...it's some quite old code that I acquired somewhere and I haven't 
actually used it in a while.

If I can work out which of the aspect ratio variables is the one to watch 
for changes, I might have a go at making a patch to add this to 
softdevice.

This might also be of interest to the dxr3 plugin developers: one revision 
of the card can send the relevant control signals down the SCART 
connector (embedded in the video or sync signals: can't remember what 
they're called) to change the aspect ratio but the other version can't so 
being able to set it via the serial port and the pin on the SCART socket.

Cheers,

Laz


From marko.makela at hut.fi  Fri Jul 28 13:01:13 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 28 Jul 2006 14:01:13 +0300
Subject: [Softdevice-devel] Way to get best image quality with MGA400 ?
In-Reply-To: <200607281113.49907.laz@club-burniston.co.uk>
References: <44C1F1CE.4090401@free.fr>
	<200607261705.26872.laz@club-burniston.co.uk>
	<20060726190227.GA3733@localhost.localdomain>
	<200607281113.49907.laz@club-burniston.co.uk>
Message-ID: <20060728110112.GA25514@localhost.localdomain>

On Fri, Jul 28, 2006 at 11:13:49AM +0100, Laz wrote:
> This might also be of interest to the dxr3 plugin developers: one revision 
> of the card can send the relevant control signals down the SCART 
> connector (embedded in the video or sync signals: can't remember what 
> they're called)

As far as I know, Wide-Screen-Signalling (WSS) is on the first visible line.
It is a black&white line, similar to CeeFax a.k.a. teletext, Bildschirmtext,
text TV lines sent during vertical retrace.  At least one DVB-T sender here
in Finland embeds the WSS signals in the video stream, even though it is
redundant (the set-top-box should embed those signals or use the SCART
line for signalling).  The same sender also burns subtitles to the video
stream.

> to change the aspect ratio but the other version can't so 
> being able to set it via the serial port and the pin on the SCART socket.

I'm interested in this, because some day, I'll replace the 15-year-old
14" monitor with a used 16:9 CRT TV, and I would prefer to power on the
TV from the VDR box.

It might make more sense to implement the actual I/O in a plugin, like
I did with my relay plugin and the suspend patch
(http://www.iki.fi/~msmakela/software/vdr/#suspend).  Some brave soul
might want to use a spare GPIO pin on their DVB tuner card.  He'd then
just write an own plugin instead of having to patch softdevice or vdr.

I've done some bit-banging on the serial port and on the parallel port.
See http://www.iki.fi/~msmakela/electronics/relay/ and in particular
http://www.iki.fi/~msmakela/electronics/relay/bitbang.zip for an example
how to control the serial lines on POSIX systems and on Win32.  For using
the parallel port, see my POSIX/Win32 in-system programmer of Atmel AVR
microcontrollers: http://www.iki.fi/~msmakela/software/cisp/

	Marko


From marko.makela at hut.fi  Fri Jul 28 13:08:25 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 28 Jul 2006 14:08:25 +0300
Subject: [Softdevice-devel] Broken Matrox RGB - is it possible to repair
	?
In-Reply-To: <001a01c6ab27$290203f0$0b0e400a@misha>
References: <001a01c6ab27$290203f0$0b0e400a@misha>
Message-ID: <20060728110825.GB25514@localhost.localdomain>

On Wed, Jul 19, 2006 at 05:33:21PM +0600, ..::Misha::.. wrote:
> I have a problem: I broke RGB out on my Matrox G450 when connecting to TV,
> only composite is now  working. Seems broken G and B rays (color signals),
> repairing is possible ? Or where I can find another Matrox G450/G400/G550 ?

If the D/A converters are on a separate chip (I can't remember, and I haven't
opened my vdr box for a while), then you could replace the converter if
you can handle SMD components.  If it is integrated on a custom Matrox chip,
then I don't think you can get a replacement.

When my DXR3 card fried, the D/A converter chip probably got a voltage
spike when connecting or disconnecting the video cable.  There was a bump
on the cover of the chip.  I installed a replacement, but unfortunately
it was not the only broken chip.

Lesson learned: never hotplug cables, and connect the PC to a properly
grounded wall outlet.  (Actually, I didn't learn, but luckily I haven't
been bitten since that incident.)

	Marko


From dave at optionsdsl.ca  Fri Jul 28 22:55:42 2006
From: dave at optionsdsl.ca (Dave)
Date: Fri, 28 Jul 2006 16:55:42 -0400
Subject: [Softdevice-devel] Broken Matrox RGB - is it possible to repair
 ?
In-Reply-To: <001a01c6ab27$290203f0$0b0e400a@misha>
References: <001a01c6ab27$290203f0$0b0e400a@misha>
Message-ID: <44CA79CE.4080009@optionsdsl.ca>

The cards are cheap enough anywhere and have been outdated for a long
time even but they are plentiful on ebay

..::Misha::.. wrote:
> Hello !
>  
> I have a problem: I broke RGB out on my Matrox G450 when connecting to
> TV, only composite is now  working. Seems broken G and B rays (color
> signals), repairing is possible ? Or where I can find another Matrox
> G450/G400/G550 ?
>  
> With best Regards.
> Jonis.
>  
> ------------------------------------------------------------------------
>
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://bat.berlios.de/mailman/listinfo/softdevice-devel
>   



From chris at shagged.org  Sat Aug  5 00:39:37 2006
From: chris at shagged.org (Chris Elsworth)
Date: Fri, 4 Aug 2006 23:39:37 +0100
Subject: [Softdevice-devel] OSD oddities with softdevice/xv
Message-ID: <20060804223937.GA73213@spork.qfe3.net>

Hello!

I am using softdevice to render my pictures/OSD via an NVidia card
which is hooked up via SVideo tv out.

For the most part, it works wonderfully - for this I thank the authors
very much :)

I have a couple of small oddities which these screenshots show:

firstly a normal shot - this is how it should look:
http://spork.qfe3.net/~chris/vdr/snapshot1.png

this is a mis-coloured OSD, it's pink:
http://spork.qfe3.net/~chris/vdr/snapshot2.png

As far as I can tell, the OSD goes pink when the resolution of the
broadcast goes below 640x480. Sometimes, if I leave some part of OSD
on screen without touching it for a while, it will flick from being
correct to being pink, and back again, as adverts come and go, at
different resolutions.  Does anyone have any idea why this might be
happening? I'd be grateful for any suggestions. (this happens with
0.2.3 and a CVS checkout of a few minutes ago).

Secondly I have an odd problem with windows wrapping:
http://spork.qfe3.net/~chris/vdr/snapshot3.png

This should be centered in the screen. That particular OSD is from
vdr-femon, but vdr-osdteletext does it too. The author of these
plugins thinks the bug might be in softdevice-xv. Again this happens
with 0.2.3 and a recent cvs.

Unfortunately I only have softdevice-xv working as an output method at
the moment, I haven't gotten directfb or anything else to work. I'll
try a PVR-350 or a dxr3 if I can get one.

I was hoping someone might have some ideas on these bugs :)

thanks very much,
-- 
Chris


From dave at optionsdsl.ca  Tue Aug  8 02:42:03 2006
From: dave at optionsdsl.ca (Dave)
Date: Mon, 07 Aug 2006 20:42:03 -0400
Subject: [Softdevice-devel] Exit out on wrong audio rates?
In-Reply-To: <44C6AC00.8020803@optionsdsl.ca>
References: <44BADF87.7020001@optionsdsl.ca>	<44BAE135.4050306@pobox.com>	<44BC4A81.2040605@optionsdsl.ca>	<44BCA09D.1050103@pobox.com>	<44C67E0D.9050306@gmx.net>
	<44C6AC00.8020803@optionsdsl.ca>
Message-ID: <44D7DDDB.90706@optionsdsl.ca>

Dave wrote:
> Martin Wache wrote:
>   
>> Torgeir Veimo schrieb:
>>   
>>     
>>> Dave wrote:
>>>     
>>>       
>>>> Here is the actual log entry:
>>>>
>>>> Jul 17 22:33:32 vdr vdr: [8262] [softdevice-audio] Rate 24000 Hz is not
>>>> possible (and using instead 48000 Hz is not implemented) FATAL exiting
>>>>
>>>> This drives me nuts!
>>>>       
>>>>         
>>> Did you try changing the exit(1); in line 335 in audio-alsa.c to return 0; ?
>>>
>>> It's probably not enough, but not having a stream to check with makes it 
>>> a bit difficult to test. Can you make a recording where the audio 
>>> changes from 48000 to 24000 and upload it somewhere?
>>>
>>>
>>>     
>>>       
>> I changed audio-alsa not to exit if the hardware is not able to audio
>> format. Please report it if there are problems.
>>
>> Bye,
>> Martin
>> _______________________________________________
>> Softdevice-devel mailing list
>> Softdevice-devel at lists.berlios.de
>> http://bat.berlios.de/mailman/listinfo/softdevice-devel
>>
>>   
>>     
> Thanks! I will give it a shot!
>
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://bat.berlios.de/mailman/listinfo/softdevice-devel
>
>   

Ok I have tried this out, and its saved many recordings for me, I see
the logs "NO AUDIO!" now.

Not to be pushy, but is there a way to peek back at the audio stream to
see if its cleared up? (back to 48000 hz, good signal), and re-establish
audio output? The only way for me to re-establish audio  output is to
restart vdr.  Switching channels doesnt help.

Thanks for any reply!




From M.Wache at gmx.net  Tue Aug  8 18:10:15 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 08 Aug 2006 18:10:15 +0200
Subject: [Softdevice-devel] OSD oddities with softdevice/xv
In-Reply-To: <20060804223937.GA73213@spork.qfe3.net>
References: <20060804223937.GA73213@spork.qfe3.net>
Message-ID: <44D8B767.4040402@gmx.net>

Chris Elsworth schrieb:
> Hello!
> 
> I am using softdevice to render my pictures/OSD via an NVidia card
> which is hooked up via SVideo tv out.
> 
> For the most part, it works wonderfully - for this I thank the authors
> very much :)
> 
> I have a couple of small oddities which these screenshots show:
> 
> firstly a normal shot - this is how it should look:
> http://spork.qfe3.net/~chris/vdr/snapshot1.png
> 
> this is a mis-coloured OSD, it's pink:
> http://spork.qfe3.net/~chris/vdr/snapshot2.png
> 
I get an "404 Not Found" with your links. Can you please upload the
pictures again or send updated links?

> As far as I can tell, the OSD goes pink when the resolution of the
> broadcast goes below 640x480. Sometimes, if I leave some part of OSD
> on screen without touching it for a while, it will flick from being
> correct to being pink, and back again, as adverts come and go, at
> different resolutions.  Does anyone have any idea why this might be
> happening? I'd be grateful for any suggestions. (this happens with
> 0.2.3 and a CVS checkout of a few minutes ago).
>
That makes me think that maybe the there is a bug in the scaling code. I
fixed a bug which had similar consequences a few weeks ago, are you sure
that you recompiled the softdevice correctly when you used the CVS version?
On the other hand there have been  reports from nvidia users who reported
similar problems, maybe it is somehow nvidia related.
I never was able to reproduce these problems ( I don't own an nvidia
card), and it is difficult to debug these problems if I don't see them.
Is the flicking from correct to pink reproducable in a recording? It
would be nice to have a short sequence which shows the problems on your
setup which I could test on my machine.


> Secondly I have an odd problem with windows wrapping:
> http://spork.qfe3.net/~chris/vdr/snapshot3.png
> 
That link is also broken...
The funny thing is both femon and osdteletext work nice on my setup.
Which vdr version are you using?

Bye,
Martin


From M.Wache at gmx.net  Tue Aug  8 18:12:34 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 08 Aug 2006 18:12:34 +0200
Subject: [Softdevice-devel] Exit out on wrong audio rates?
In-Reply-To: <44D7DDDB.90706@optionsdsl.ca>
References: <44BADF87.7020001@optionsdsl.ca>	<44BAE135.4050306@pobox.com>	<44BC4A81.2040605@optionsdsl.ca>	<44BCA09D.1050103@pobox.com>	<44C67E0D.9050306@gmx.net>	<44C6AC00.8020803@optionsdsl.ca>
	<44D7DDDB.90706@optionsdsl.ca>
Message-ID: <44D8B7F2.2060404@gmx.net>

Dave schrieb:

> Ok I have tried this out, and its saved many recordings for me, I see
> the logs "NO AUDIO!" now.
> 
> Not to be pushy, but is there a way to peek back at the audio stream to
> see if its cleared up? (back to 48000 hz, good signal), and re-establish
> audio output? The only way for me to re-establish audio  output is to
> restart vdr.  Switching channels doesnt help.
>
Hmm, it was meant to switch back automatically when the stream goes back
to 48000Hz. At least a channel switch to a different channel with
48000Hz should help, I will have a look at it. Sorry I could not fully
test it...

Bye,
Martin



From stefan at lucke.in-berlin.de  Wed Aug  9 09:08:19 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 9 Aug 2006 09:08:19 +0200
Subject: [Softdevice-devel] news for vidix radeon users
Message-ID: <200608090908.19489.stefan@lucke.in-berlin.de>

Hi,

latest version of vidix-radeon-alpha patch is now in vidix cvs :-)) .

To make use of it you need attached patch for softdevice.

This patch includes also an extension of Roland Praml to make
use of available equalizers: brightness, saturation, hue, contrast 
and HW-Deinterlace.

HW-Deinterlace is limited to available vidix constants and some
values present in current xorg radeon sources.

To be honest, I don't see a difference :-( .

-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: softdevice-vidix-radeon-patch-02.diff
Type: text/x-diff
Size: 10098 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060809/051c46cd/attachment.diff>

From stefan at lucke.in-berlin.de  Wed Aug  9 10:04:58 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 9 Aug 2006 10:04:58 +0200
Subject: [Softdevice-devel] list registration at gmane (WAS: Fwd: Uncaught
	bounce notification)
Message-ID: <200608091004.58496.stefan@lucke.in-berlin.de>

Hi,

as list admin I've been noticed, that someone registered our list at gmane. 

I think its a good idea to have a berlios independant backup of our list.

If there are other arguments, please let me know.

-- 
Stefan Lucke
-------------- next part --------------
An embedded message was scrubbed...
From: mailman-bounces at lists.berlios.de
Subject: Uncaught bounce notification
Date: Fri, 04 Aug 2006 22:31:45 +0200
Size: 5730
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060809/fe930e4f/attachment.mht>

From chris at shagged.org  Wed Aug  9 19:20:15 2006
From: chris at shagged.org (Chris Elsworth)
Date: Wed, 9 Aug 2006 18:20:15 +0100
Subject: [Softdevice-devel] OSD oddities with softdevice/xv
In-Reply-To: <44D8B767.4040402@gmx.net>
References: <20060804223937.GA73213@spork.qfe3.net> <44D8B767.4040402@gmx.net>
Message-ID: <20060809172015.GA64618@spork.qfe3.net>

On Tue, Aug 08, 2006 at 06:10:15PM +0200, Martin Wache wrote:
> Chris Elsworth schrieb:
> > Hello!
> > 
> > I am using softdevice to render my pictures/OSD via an NVidia card
> > which is hooked up via SVideo tv out.
> > 
> > For the most part, it works wonderfully - for this I thank the authors
> > very much :)
> > 
> > I have a couple of small oddities which these screenshots show:
> > 
> > firstly a normal shot - this is how it should look:
> > http://spork.qfe3.net/~chris/vdr/snapshot1.png
> > 
> > this is a mis-coloured OSD, it's pink:
> > http://spork.qfe3.net/~chris/vdr/snapshot2.png
> > 
> I get an "404 Not Found" with your links. Can you please upload the
> pictures again or send updated links?

Sorry, try these
http://spork.qfe3.net/~chris/vdr/snapshot4.png
http://spork.qfe3.net/~chris/vdr/snapshot5.png

4 is broken, 5 is working.

> That makes me think that maybe the there is a bug in the scaling code. I
> fixed a bug which had similar consequences a few weeks ago, are you sure
> that you recompiled the softdevice correctly when you used the CVS version?

Yes, I'm sure I'm using the cvs version, because -vo xv:use-defaults
works, which was only added after the last release. So I must be using
cvs build.

> On the other hand there have been  reports from nvidia users who reported
> similar problems, maybe it is somehow nvidia related.
> I never was able to reproduce these problems ( I don't own an nvidia
> card), and it is difficult to debug these problems if I don't see them.
> Is the flicking from correct to pink reproducable in a recording? It
> would be nice to have a short sequence which shows the problems on your
> setup which I could test on my machine.

vdr recordings do not the record the OSDs do they? So I would need
something to externally record the contents of the framebuffer, or
the contents of the vdr window? (using xv output method). I'll look
for something that will do the job, do you have any suggestions?

I would concede that is probably is nvidia related. I'd like to try a
Matrox G450 or similar, but this is a PCI-e system with no AGP slots.



> > Secondly I have an odd problem with windows wrapping:
> > http://spork.qfe3.net/~chris/vdr/snapshot3.png
> > 
> That link is also broken...
> The funny thing is both femon and osdteletext work nice on my setup.
> Which vdr version are you using?

vdr 1.4.0 (binary build in Ubuntu 6.10)
I haven't seen any related looking changes in vdr 1.4.1 but it's worth
a go if I can get it to to build; I have some odd gettid undefined
errors if I try to build 1.4.0 manually, which I haven't resolved yet.

I have put the window wrapping snapshot back at
http://spork.qfe3.net/~chris/vdr/snapshot7.png
(the picture is correctly black and white, it was a b&w broadcast)

-- 
Chris


From M.Wache at gmx.net  Thu Aug 10 20:45:10 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 10 Aug 2006 20:45:10 +0200
Subject: [Softdevice-devel] OSD oddities with softdevice/xv
In-Reply-To: <20060809172015.GA64618@spork.qfe3.net>
References: <20060804223937.GA73213@spork.qfe3.net> <44D8B767.4040402@gmx.net>
	<20060809172015.GA64618@spork.qfe3.net>
Message-ID: <44DB7EB6.3060504@gmx.net>

Chris Elsworth schrieb:

> Sorry, try these
> http://spork.qfe3.net/~chris/vdr/snapshot4.png
> http://spork.qfe3.net/~chris/vdr/snapshot5.png
> 
> 4 is broken, 5 is working.
>
This really looks like a scaling issue.


>> On the other hand there have been  reports from nvidia users who reported
>> similar problems, maybe it is somehow nvidia related.
>> I never was able to reproduce these problems ( I don't own an nvidia
>> card), and it is difficult to debug these problems if I don't see them.
>> Is the flicking from correct to pink reproducable in a recording? It
>> would be nice to have a short sequence which shows the problems on your
>> setup which I could test on my machine.
> 
> vdr recordings do not the record the OSDs do they? So I would need
> something to externally record the contents of the framebuffer, or
> the contents of the vdr window? (using xv output method). I'll look
> for something that will do the job, do you have any suggestions?
> 
You are right, vdr recordings don't contain the osd, the idea was that
the resolution of the stream causes the problems. So with streams of the
resolution I might be able to reproduce the problems. But I already
tried to scale the osd to many different resolution and I never got
problems.

> I would concede that is probably is nvidia related. I'd like to try a
> Matrox G450 or similar, but this is a PCI-e system with no AGP slots.
> 
That would really be a great test. What about pci cards? It doesn't
necessarily has to be a Matrox card, any other card would be nice.

> 
> 
>>> Secondly I have an odd problem with windows wrapping:
>>> http://spork.qfe3.net/~chris/vdr/snapshot3.png
>>>
>> That link is also broken...
>> The funny thing is both femon and osdteletext work nice on my setup.
>> Which vdr version are you using?
> 
> vdr 1.4.0 (binary build in Ubuntu 6.10)

You are using a prebuild vdr together with a self-compiled softdevice?
Hm, how did you compile the softdevice? Did you make sure that the
prebuild vdr *exactly* matches the sources of vdr you used to build the
softdevice (maybe there are some patches applied) ?
Could you try if you have the same issues if you build both vdr and the
softdevice yourself?

One thing which could help to debug both issues would be if you could
enable the OSDDEB (uncomment the line "#define OSDDEB(out...) in the
file SoftOsd.c and recompile), pipe the output in a file and send it to me.
For the color issue it would be nice to have the same OSD (maybe the
main menu) once when it works fine, and once when it doesn't work.
Actually the nicest would be if you could send the log for the osd when
it flicks from correct to pink or back and try to mark where in the log
where it is fine and where not.
For the issue with osdteletext and femon, you can just send me log, but
please use osdteletext, femon updates the osd quite often, so the log
would be a log larger.

Bye,
Martin


From M.Wache at gmx.net  Thu Aug 10 20:49:04 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 10 Aug 2006 20:49:04 +0200
Subject: [Softdevice-devel] Exit out on wrong audio rates?
In-Reply-To: <44D7DDDB.90706@optionsdsl.ca>
References: <44BADF87.7020001@optionsdsl.ca>	<44BAE135.4050306@pobox.com>	<44BC4A81.2040605@optionsdsl.ca>	<44BCA09D.1050103@pobox.com>	<44C67E0D.9050306@gmx.net>	<44C6AC00.8020803@optionsdsl.ca>
	<44D7DDDB.90706@optionsdsl.ca>
Message-ID: <44DB7FA0.2040807@gmx.net>

Dave schrieb:

> 
> Ok I have tried this out, and its saved many recordings for me, I see
> the logs "NO AUDIO!" now.
> 
> Not to be pushy, but is there a way to peek back at the audio stream to
> see if its cleared up? (back to 48000 hz, good signal), and re-establish
> audio output? The only way for me to re-establish audio  output is to
> restart vdr.  Switching channels doesnt help.
> 
Can you please post the syslog output when you get "NO AUDIO" and try to
recover by switching the channels? I did some tests by manually
disabling some sample rates, but for me the audio recovers when I change
the channel again.

Bye,
Martin


From chris at shagged.org  Fri Aug 11 01:59:11 2006
From: chris at shagged.org (Chris Elsworth)
Date: Fri, 11 Aug 2006 00:59:11 +0100
Subject: [Softdevice-devel] OSD oddities with softdevice/xv
In-Reply-To: <44DB7EB6.3060504@gmx.net>
References: <20060804223937.GA73213@spork.qfe3.net> <44D8B767.4040402@gmx.net>
	<20060809172015.GA64618@spork.qfe3.net> <44DB7EB6.3060504@gmx.net>
Message-ID: <20060810235911.GA30006@spork.qfe3.net>

On Thu, Aug 10, 2006 at 08:45:10PM +0200, Martin Wache wrote:
> 
> > I would concede that is probably is nvidia related. I'd like to try a
> > Matrox G450 or similar, but this is a PCI-e system with no AGP slots.
> > 
> That would really be a great test. What about pci cards? It doesn't
> necessarily has to be a Matrox card, any other card would be nice.

I have a PCI PVR350 I can try now. Last time I had a look around it looked
like the pvr350 driver was vdr 1.3.x and earlier only, but I'll have
another hunt around for it.

> > vdr 1.4.0 (binary build in Ubuntu 6.10)
> 
> You are using a prebuild vdr together with a self-compiled softdevice?

That's right.


> Hm, how did you compile the softdevice? Did you make sure that the
> prebuild vdr *exactly* matches the sources of vdr you used to build the
> softdevice (maybe there are some patches applied) ?
> Could you try if you have the same issues if you build both vdr and the
> softdevice yourself?

In Ubuntu, you can get the sources used to build the packaged binary:
apt-get build-dep vdr
apt-get source vdr

That leaves me with a vdr-1.4.0 directory which is guaranteed to be
the same source, including distribution specific patches, as the
installed binary.
However, I'm not sure how the Ubuntu chaps got it built, because:

root at media:~/vdr-1.4.0# make
g++ -fPIC -g -O2 -Wall -Woverloaded-virtual -c -DREMOTE_KBD -DLIRC_DEVICE=\"/dev/lircd\" -DRCU_DEVICE=\"/dev/ttyS1\" -D_GNU_SOURCE -DVIDEODIR=\"/video\" -DPLUGINDIR=\"./PLUGINS/lib\"  thread.c
thread.c:320: error: ?gettid? has not been declared
thread.c:322: error: expected constructor, destructor, or type conversion before ?tThreadId?
make: *** [thread.o] Error 1

root at media:~/vdr-1.4.0# gcc -v
Using built-in specs.
Target: x86_64-linux-gnu
Configured with: ../src/configure -v --enable-languages=c,c++,fortran,objc,obj-c++,ada,treelang --prefix=/usr --enable-shared --with-system-zlib --libexecdir=/usr/lib --without-included-gettext --enable-threads=posix --enable-nls --program-suffix=-4.1 --enable-__cxa_atexit --enable-clocale=gnu --enable-libstdcxx-debug --enable-mpfr --enable-checking=release x86_64-linux-gnu
Thread model: posix
gcc version 4.1.2 20060715 (prerelease) (Ubuntu 4.1.1-9ubuntu1)

I see stuff related to gettid in /usr/include, so I'm not sure what's
going on here.

I can however drop stuff into vdr-1.4.0/PLUGINS/src/
and then 'make plugins' in vdr-1.4.0 which is how I'm getting plugins
built. The reason I can't try xineliboutput is similar to above;
tools/udp_pes_scheduler.c:38: error: ?gettid? has not been declared
tools/udp_pes_scheduler.c:43: error: expected constructor, destructor, or type conversion before ?cTimePts?
tools/udp_pes_scheduler.c:130: error: ?gettid? was not declared in this scope


 
> One thing which could help to debug both issues would be if you could
> enable the OSDDEB (uncomment the line "#define OSDDEB(out...) in the
> file SoftOsd.c and recompile), pipe the output in a file and send it to me.

Once I get it built, I'll do this :)

Thanks for your help so far!
-- 
Chris


From chris at shagged.org  Fri Aug 11 23:37:30 2006
From: chris at shagged.org (Chris Elsworth)
Date: Fri, 11 Aug 2006 22:37:30 +0100
Subject: [Softdevice-devel] OSD oddities with softdevice/xv
In-Reply-To: <20060810235911.GA30006@spork.qfe3.net>
References: <20060804223937.GA73213@spork.qfe3.net> <44D8B767.4040402@gmx.net>
	<20060809172015.GA64618@spork.qfe3.net> <44DB7EB6.3060504@gmx.net>
	<20060810235911.GA30006@spork.qfe3.net>
Message-ID: <20060811213730.GA68733@spork.qfe3.net>

On Fri, Aug 11, 2006 at 12:59:11AM +0100, Chris Elsworth wrote:
> > > I would concede that is probably is nvidia related. I'd like to try a
> > > Matrox G450 or similar, but this is a PCI-e system with no AGP slots.
> > > 
> > That would really be a great test. What about pci cards? It doesn't
> > necessarily has to be a Matrox card, any other card would be nice.
> 
> I have a PCI PVR350 I can try now. Last time I had a look around it looked
> like the pvr350 driver was vdr 1.3.x and earlier only, but I'll have
> another hunt around for it.

As I thought
http://www.linuxtv.org/vdrwiki/index.php/Pvr350-plugin
Says it's dodgy with vdr later than 1.3.44

Is anyone reading this using this plugin with vdr 1.4.0 happily?

-- 
Chris


From stefan at lucke.in-berlin.de  Sun Aug 13 19:01:00 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 13 Aug 2006 19:01:00 +0200
Subject: [Softdevice-devel] OSD oddities with softdevice/xv
In-Reply-To: <44DB7EB6.3060504@gmx.net>
References: <20060804223937.GA73213@spork.qfe3.net>
	<20060809172015.GA64618@spork.qfe3.net> <44DB7EB6.3060504@gmx.net>
Message-ID: <200608131901.00153.stefan@lucke.in-berlin.de>

On Donnerstag 10 August 2006 20:45, Martin Wache wrote:
> Chris Elsworth schrieb:
> 
> > Sorry, try these
> > http://spork.qfe3.net/~chris/vdr/snapshot4.png
> > http://spork.qfe3.net/~chris/vdr/snapshot5.png
> > 
> > 4 is broken, 5 is working.
> >
> This really looks like a scaling issue.
> 
> 
> >> On the other hand there have been  reports from nvidia users who reported
> >> similar problems, maybe it is somehow nvidia related.
> >> I never was able to reproduce these problems ( I don't own an nvidia
> >> card), and it is difficult to debug these problems if I don't see them.
> >> Is the flicking from correct to pink reproducable in a recording? It
> >> would be nice to have a short sequence which shows the problems on your
> >> setup which I could test on my machine.
> > 
> > vdr recordings do not the record the OSDs do they? So I would need
> > something to externally record the contents of the framebuffer, or
> > the contents of the vdr window? (using xv output method). I'll look
> > for something that will do the job, do you have any suggestions?
> > 
> You are right, vdr recordings don't contain the osd, the idea was that
> the resolution of the stream causes the problems. So with streams of the
> resolution I might be able to reproduce the problems. But I already
> tried to scale the osd to many different resolution and I never got
> problems.
> 

There might be some other mystic ;-) .
YUV (aka YV12) valid values are _not_ in the range 0 .. 255 !
Y and U/V values should be clamped:
luma values to the range 16 .. 235 and
chroma values to the range 15 .. 240 .

Perhaps that could be tested in the C part of alpha mixing code -> AlphaBlend().


-- 
Stefan Lucke


From nanouck at gmail.com  Mon Aug 14 16:31:39 2006
From: nanouck at gmail.com (=?ISO-8859-1?Q?Nicolas_D=E9ly?=)
Date: Mon, 14 Aug 2006 16:31:39 +0200
Subject: [Softdevice-devel] HOWTO libcle266mpegdec
In-Reply-To: <20060711122833.M94407@mellander.org>
References: <20060711122833.M94407@mellander.org>
Message-ID: <9d16db1a0608140731r608052ecq8bfdb70383586304@mail.gmail.com>

2006/7/11, Per Mellander <per at mellander.org>:
> I've written some kind of a HOWTO for making use of the CLE266 hardware decoding with
> softdevice. Could you ( Laz, Martin, Stefan etc. ) take a look and comment before I drop
> the link on vdr ml?
>
> http://www.mellander.org/per/projects/linux/?chapter=epia-hw-cle266

Thank you very much for your howto.

I also had pached linux-viafb in order to add hardware ids

to be very detailed your howto is missing:
* "./configure" before  libcle266mpegdec "make"
* "./autogen.sh" before DirectFB "./configure" or replace "./configure
--with-gfxdrivers=cle266,unichrome" by "./autogen.sh
--with-gfxdrivers=cle266,unichrome"

Unfortunately when I demonstated my set top box to my bosses, they
told me that deinterlacing was "bottom first" or something like that,
though it should be "top first" meaning that bottom frames are
displayed before top frames.  On interlaced videos, there are slow
movements. I hope someone understand my troubles.

Good jobs guys


From M.Wache at gmx.net  Mon Aug 14 18:35:41 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 14 Aug 2006 18:35:41 +0200
Subject: [Softdevice-devel] OSD oddities with softdevice/xv
In-Reply-To: <200608131901.00153.stefan@lucke.in-berlin.de>
References: <20060804223937.GA73213@spork.qfe3.net>	<20060809172015.GA64618@spork.qfe3.net>
	<44DB7EB6.3060504@gmx.net>
	<200608131901.00153.stefan@lucke.in-berlin.de>
Message-ID: <44E0A65D.60209@gmx.net>

Stefan Lucke schrieb:
> There might be some other mystic ;-) .
> YUV (aka YV12) valid values are _not_ in the range 0 .. 255 !
> Y and U/V values should be clamped:
> luma values to the range 16 .. 235 and
> chroma values to the range 15 .. 240 .
> 
Of course you are right that YUV values are not in the range 0-255, but
I doubt that this causes the problems.
In this bugreport it was stated that the same osd switches from
correctly displayed to wrong colors:

> Sometimes, if I leave some part of OSD
> on screen without touching it for a while, it will flick from being
> correct to being pink, and back again, as adverts come and go, at
> different resolutions.

I can hardy imagine how a wrong range could cause that. Also the stripes
look like some scaling issue...

> Perhaps that could be tested in the C part of alpha mixing code -> AlphaBlend().
> 
That is one possibility, but using the correct range in ARGB_to_AYUV()
is probably the better solution. By the way, are you sure that the
calculation in ARGB_to_AYUV() is wrong? I must admit that I never
checked it, but at least the Y component seems to be correct.

Bye,
Martin




From laz at club-burniston.co.uk  Mon Aug 14 21:10:40 2006
From: laz at club-burniston.co.uk (Laz)
Date: Mon, 14 Aug 2006 20:10:40 +0100
Subject: [Softdevice-devel] HOWTO libcle266mpegdec
In-Reply-To: <9d16db1a0608140731r608052ecq8bfdb70383586304@mail.gmail.com>
References: <20060711122833.M94407@mellander.org>
	<9d16db1a0608140731r608052ecq8bfdb70383586304@mail.gmail.com>
Message-ID: <200608142010.40643.laz@club-burniston.co.uk>

On Monday 14 August 2006 15:31, Nicolas D?ly wrote:
> 2006/7/11, Per Mellander <per at mellander.org>:
> > I've written some kind of a HOWTO for making use of the CLE266 hardware
> > decoding with softdevice. Could you ( Laz, Martin, Stefan etc. ) take a
> > look and comment before I drop the link on vdr ml?
> >
> > http://www.mellander.org/per/projects/linux/?chapter=epia-hw-cle266
>
> Thank you very much for your howto.
>
> I also had pached linux-viafb in order to add hardware ids
>
> to be very detailed your howto is missing:
> * "./configure" before  libcle266mpegdec "make"
> * "./autogen.sh" before DirectFB "./configure" or replace "./configure
> --with-gfxdrivers=cle266,unichrome" by "./autogen.sh
> --with-gfxdrivers=cle266,unichrome"
>
> Unfortunately when I demonstated my set top box to my bosses, they
> told me that deinterlacing was "bottom first" or something like that,
> though it should be "top first" meaning that bottom frames are
> displayed before top frames.  On interlaced videos, there are slow
> movements. I hope someone understand my troubles.

I _think_ that without Mark Adams's field-sync patches to viafb and DirectFB 
(posted on the directfb-users or -dev list), the field order is random for 
each bootup due to a timing issue. With the patches, I think it keeps track 
of the field order. I use this setup with an interlaced TV and it works fine 
for me (or I've not noticed jagged lines form reversed field lines).

As I say, I think that's what the patches do...they might not even be needed 
these days! It was a while back that I applied them and I've forgotten why I 
needed them!

I've attached the two of them (as I said, it's been a while since I've had to 
apply them so they might need a bit of coaxing with current versions of viafb 
and DirectFB!).

Cheers,

Laz
-------------- next part --------------
A non-text attachment was scrubbed...
Name: viafb_flip_ioctl.patch
Type: text/x-diff
Size: 4357 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060814/3f435dea/attachment.patch>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: dfb_unichrome_flip_ioctl.patch
Type: text/x-diff
Size: 2542 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060814/3f435dea/attachment-0001.patch>

From stefan at lucke.in-berlin.de  Mon Aug 14 21:45:46 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 14 Aug 2006 21:45:46 +0200
Subject: [Softdevice-devel] OSD oddities with softdevice/xv
In-Reply-To: <44E0A65D.60209@gmx.net>
References: <20060804223937.GA73213@spork.qfe3.net>
	<200608131901.00153.stefan@lucke.in-berlin.de>
	<44E0A65D.60209@gmx.net>
Message-ID: <200608142145.46298.stefan@lucke.in-berlin.de>

On Montag 14 August 2006 18:35, Martin Wache wrote:
> Stefan Lucke schrieb:
> > There might be some other mystic ;-) .
> > YUV (aka YV12) valid values are _not_ in the range 0 .. 255 !
> > Y and U/V values should be clamped:
> > luma values to the range 16 .. 235 and
> > chroma values to the range 15 .. 240 .
> > 
> Of course you are right that YUV values are not in the range 0-255, but
> I doubt that this causes the problems.
> In this bugreport it was stated that the same osd switches from
> correctly displayed to wrong colors:
> 
> > Sometimes, if I leave some part of OSD
> > on screen without touching it for a while, it will flick from being
> > correct to being pink, and back again, as adverts come and go, at
> > different resolutions.
> 
> I can hardy imagine how a wrong range could cause that. Also the stripes
> look like some scaling issue...

You are right the symptoms look like a scaling issue, but in that case it
should be possible to reproduce that error on other cards too.

So I try to look at things we did not consider yet .
Another hint could be that most Xorg / XFree driver do a
YV12 -> YUV2 conversion, but I failed to reprocude the error with
vidix, OSD set to software and various horizontal resolutions ;-( .

The only time I saw a out of range problem was here:
http://sourceforge.net/mailarchive/forum.php?thread_id=272658&forum_id=5458

But there was no OSD involved and so failing values looked not regular.


> 
> > Perhaps that could be tested in the C part of alpha mixing code -> AlphaBlend().
> > 
> That is one possibility, but using the correct range in ARGB_to_AYUV()
> is probably the better solution. By the way, are you sure that the
> calculation in ARGB_to_AYUV() is wrong? I must admit that I never
> checked it, but at least the Y component seems to be correct.

My suggestion to use AlphaBlend() is based on the fact that it is the last
step in the mixing pipline and alpha 0 or 255 could lead to calulated luma 0.
That's just a quick thought.

-- 
Stefan Lucke


From per at mellander.org  Tue Aug 15 10:42:06 2006
From: per at mellander.org (Per Mellander)
Date: Tue, 15 Aug 2006 10:42:06 +0200
Subject: [Softdevice-devel] HOWTO libcle266mpegdec
In-Reply-To: <9d16db1a0608140731r608052ecq8bfdb70383586304@mail.gmail.com>
References: <20060711122833.M94407@mellander.org>
	<9d16db1a0608140731r608052ecq8bfdb70383586304@mail.gmail.com>
Message-ID: <20060815083820.M5061@mellander.org>

On Mon, 14 Aug 2006 16:31:39 +0200, Nicolas D?ly wrote

> to be very detailed your howto is missing:
> * "./configure" before  libcle266mpegdec "make"
> * "./autogen.sh" before DirectFB "./configure" or replace "./configure
> --with-gfxdrivers=cle266,unichrome" by "./autogen.sh
> --with-gfxdrivers=cle266,unichrome"
> 

Ok! I'll take a look into that when I get some spare time. Just back from vacation ;)

Thanks, 
/Per


From nanouck at gmail.com  Tue Aug 15 22:51:59 2006
From: nanouck at gmail.com (Nicolas DELY)
Date: Tue, 15 Aug 2006 22:51:59 +0200
Subject: [Softdevice-devel] HOWTO libcle266mpegdec
In-Reply-To: <20060815083820.M5061@mellander.org>
References: <20060711122833.M94407@mellander.org>	<9d16db1a0608140731r608052ecq8bfdb70383586304@mail.gmail.com>
	<20060815083820.M5061@mellander.org>
Message-ID: <44E233EF.2030801@gmail.com>

Per Mellander wrote:
> On Mon, 14 Aug 2006 16:31:39 +0200, Nicolas D?ly wrote
> 
>> to be very detailed your howto is missing:
>> * "./configure" before  libcle266mpegdec "make"
>> * "./autogen.sh" before DirectFB "./configure" or replace "./configure
>> --with-gfxdrivers=cle266,unichrome" by "./autogen.sh
>> --with-gfxdrivers=cle266,unichrome"
>>
> 
> Ok! I'll take a look into that when I get some spare time. Just back from vacation ;)

I'm working with zzam from gentoo to provide fresh ebuilds and all good
dependencies ;-) using your job

I hope It can help someone later


From rahrenbe at cc.hut.fi  Tue Aug 15 23:26:03 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Wed, 16 Aug 2006 00:26:03 +0300 (EEST)
Subject: [Softdevice-devel] HOWTO libcle266mpegdec
In-Reply-To: <44E233EF.2030801@gmail.com>
References: <20060711122833.M94407@mellander.org>
	<9d16db1a0608140731r608052ecq8bfdb70383586304@mail.gmail.com>
	<20060815083820.M5061@mellander.org> <44E233EF.2030801@gmail.com>
Message-ID: <Pine.OSF.4.61.0608160019001.453372@kosh.hut.fi>

On Tue, 15 Aug 2006, Nicolas DELY wrote:

> I'm working with zzam from gentoo to provide fresh ebuilds and all good
> dependencies ;-) using your job

Just a little reminder: I've had ebuilds for DirectDB / DFB++ / 
libcle266mpegdec libraries since day one. Well, the DirectFB is 
currently missing Mark's Unichrome flip ioctl patch, but anyone can add 
that very easily..

google: portage-overlay-for-directfb-and-libcle266mpegdec

BR,
--
rofa


From lists at conealley.net  Wed Aug 23 13:47:35 2006
From: lists at conealley.net (Kim Fredenberg)
Date: Wed, 23 Aug 2006 14:47:35 +0300
Subject: [Softdevice-devel] CLE266 Vertical Refresh
Message-ID: <44EC4057.1000609@conealley.net>

Hi,

I don't know if this is the correct list to ask this question, but I am
playing around with a CLE266 equipped VIA Epia board and want to connect
it to my Thomson TV. I have compiled in support for libcle266mpegdec and
DirectFB/DFB++ for softdevice. Decoding works fine, displaying on a
monitor works fine.

Now my problem is that the Thompson TV is quite sensitive conserning the
vertical refresh rate and would like to have something like 59.7Hz. My
Epia outputs 60.05Hz measured with an oscilloscope.

Now I tried to adjust the frequency using fbset and setting the
pixelclock just slightly higher for the 800x600-60 mode. fbset -i
actually informs me that the frequency should be something like 59.7Hz.

mode "800x600-60"
    # D: 39.604 MHz, H: 37.504 kHz, V: 59.719 Hz
    geometry 800 600 800 600 8
    timings 25250 88 40 23 1 128 4
    hsync high
    vsync high
    accel true
    rgba 6/0,6/0,6/0,0/0
endmode

But it doesn't effect the output from the Epia in any way. The
oscilloscope still displays 60.05Hz. It acutally doesn't matter if I set
it to 800x600-90, then fbset -i shows V: 89.913 Hz but the oscilloscope
still displays 60.05Hz.

What am I doing wrong? Why can't I adjust the frequencies using fbset?
Is my Epia board overriding the settings from linux in any way?

br,

Kim Fredenberg

PS. Dear list administrator, I unfortunaltely sent out this mail already
once having the wrong sender. Please ignore the message, thanks.


From nicolas at huillard.net  Thu Aug 24 10:02:10 2006
From: nicolas at huillard.net (Nicolas Huillard)
Date: Thu, 24 Aug 2006 10:02:10 +0200
Subject: [Softdevice-devel] CLE266 Vertical Refresh
In-Reply-To: <44EC4057.1000609@conealley.net>
References: <44EC4057.1000609@conealley.net>
Message-ID: <44ED5D02.7000408@huillard.net>

Kim Fredenberg a ?crit :
> What am I doing wrong? Why can't I adjust the frequencies using fbset?
> Is my Epia board overriding the settings from linux in any way?

The framebuffer driver adjusts the frequencies of the VGA output when
TV-out is activated, in order to align the VGA out timings to the TV
signal. The TV encoder just encodes the signal without changing the
frequencies.
Thus no change with fbset will have any effect when TV-out is on.
Mark Adams did a very good job to adjust timings in the "tv tables"
inside the framebuffer driver, but did only take PAL into account.
AFAIK, noone ever tried to adjust NTSC setting to proper full-frame
(considering you're using NTSC).
"tv tables" are found in the kernel driver code... You could try to get
old posts from Mark Adams on the directfb-users ML, where he might
explain how he did it. IIRC, this was between september and december 2005.

-- 
NH


From lists at conealley.net  Fri Aug 25 14:17:43 2006
From: lists at conealley.net (Kim Fredenberg)
Date: Fri, 25 Aug 2006 15:17:43 +0300
Subject: [Softdevice-devel] CLE266 Vertical Refresh
In-Reply-To: <44ED5D02.7000408@huillard.net>
References: <44EC4057.1000609@conealley.net> <44ED5D02.7000408@huillard.net>
Message-ID: <44EEEA67.6030306@conealley.net>

Nicolas Huillard wrote:
> Kim Fredenberg a ?crit :
> 
>>What am I doing wrong? Why can't I adjust the frequencies using fbset?
>>Is my Epia board overriding the settings from linux in any way?
> 
> 
> The framebuffer driver adjusts the frequencies of the VGA output when
> TV-out is activated, in order to align the VGA out timings to the TV
> signal. The TV encoder just encodes the signal without changing the
> frequencies.
> Thus no change with fbset will have any effect when TV-out is on.

Nicolas,

Thanks for your answer!

I disabled the TV-Out from BIOS and likewise did not enable TVon in the
driver. Still I cannot manage to adjust the frequency of the VGA output.
When I set TVon=1 then I get PAL frequency ~50Hz but my TV doesn't like
this frequency on the VGA input and I would really like to drive the
output through the VGA connection.

I will search the directfb-users list to see if I find anything useful
and if I somehow could hack in another frequency into the driver.

br, Kim


From omge2ri02 at sneakemail.com  Wed Aug 30 11:56:43 2006
From: omge2ri02 at sneakemail.com (CR)
Date: 30 Aug 2006 09:56:43 -0000
Subject: [Softdevice-devel] nVidia hardware alpha blending for OSD
Message-ID: <30885-36724@sneakemail.com>

Hi all,

Some of you on the VDR mailing list may have seen me struggling to get
softdevice's OSD to work without odd artifacts.

Although I have not yet found the source of the problem, I have a
potential work around:  I believe my nVidia 6200 provides hardware alpha
blending support for Xv images.  I think most, if not all new nVidia cards
do.  If so, this would be really nice to support!

xdpyinfo lists for the blitter port, among other things:


    id: 0x3
        guid: 03000000-0000-0010-8000-00aa00389b71
        bits per pixel: 32
        number of planes: 1
        type: RGB (packed)
        depth: 24
        red, green, blue masks: 0xff0000, 0xff00, 0xff


This is confirmed by page 18/95 on:
download.nvidia.com/XFree86_40/1.0-4191/NVLinuxNotes4191.pdf

"Added an 8:8:8:8 XRGB XvImage format to the video blitter."

To add nVidia alpha-blending support to softdevice for the OSD seems
straightforward.

I would think one would need to:

- Set softdevice to use video blitter for video XvPutImage calls

- Open a second video blitter port for OSD purposes (with id 0x3 for color
space)

- Create an OSD buffer and store VDR's OSD with appropriate color weight

(i.e. if VDR uses 6-6-6 for RGB, left-shift RGB components into upper 6
bits of each XRGB 8-bit color component)

- Store alpha value (menu settable?) in buffer

- Call XvPutImage with second blitter port for OSD updates

- To clear or blank OSD perhaps use a second OSD buffer with alpha set to
zero (0) and just call XvPutImage

Although this seems logical and easy in theory, I am having a very very
hard time following softdevice's code.  I do not understand the
partitioning of functions among files (video.c, video-xv.c, etc) and the
lack of many comments makes it hard for me to reverse engineer the logic.

I tried adding a menu item for "nv_hardware", but immediately after
setting that softdevice crashes.  That's about as far as I've gone.

Is there anyone on the list willing to work with me to add or test this
theory out?

Thank you,
CR.



X-Video Extension version 2.2
screen #0
  Adaptor #0: "NV17 Video Texture"
    number of ports: 1
    port base: 53
    operations supported: PutImage
    supported visuals:
      depth 24, visualID 0x21
      depth 24, visualID 0x22
    number of attributes: 3
      "XV_SET_DEFAULTS" (range 0 to 0)
              client settable attribute
      "XV_ITURBT_709" (range 0 to 1)
              client settable attribute
              client gettable attribute (current value is 0)
      "XV_SYNC_TO_VBLANK" (range 0 to 1)
              client settable attribute
              client gettable attribute (current value is 1)
    maximum XvImage size: 2046 x 2046
    Number of image formats: 4
      id: 0x32595559 (YUY2)
        guid: 59555932-0000-0010-8000-00aa00389b71
        bits per pixel: 16
        number of planes: 1
        type: YUV (packed)
      id: 0x32315659 (YV12)
        guid: 59563132-0000-0010-8000-00aa00389b71
        bits per pixel: 12
        number of planes: 3
        type: YUV (planar)
      id: 0x59565955 (UYVY)
        guid: 55595659-0000-0010-8000-00aa00389b71
        bits per pixel: 16
        number of planes: 1
        type: YUV (packed)
      id: 0x30323449 (I420)
        guid: 49343230-0000-0010-8000-00aa00389b71
        bits per pixel: 12
        number of planes: 3
        type: YUV (planar)
  Adaptor #1: "NV05 Video Blitter"
    number of ports: 32
    port base: 54
    operations supported: PutImage
    supported visuals:
      depth 24, visualID 0x21
      depth 24, visualID 0x22
    number of attributes: 2
      "XV_SET_DEFAULTS" (range 0 to 0)
              client settable attribute
      "XV_SYNC_TO_VBLANK" (range 0 to 1)
              client settable attribute
              client gettable attribute (current value is 0)
    maximum XvImage size: 2046 x 2046
    Number of image formats: 5
      id: 0x32595559 (YUY2)
        guid: 59555932-0000-0010-8000-00aa00389b71
        bits per pixel: 16
        number of planes: 1
        type: YUV (packed)


Adaptor #1: "NV05 Video Blitter"
    number of ports: 32
    port base: 54
    operations supported: PutImage
    supported visuals:
      depth 24, visualID 0x21
      depth 24, visualID 0x22
    number of attributes: 2
      "XV_SET_DEFAULTS" (range 0 to 0)
              client settable attribute
      "XV_SYNC_TO_VBLANK" (range 0 to 1)
              client settable attribute
              client gettable attribute (current value is 0)
    maximum XvImage size: 2046 x 2046
    Number of image formats: 5
      id: 0x32595559 (YUY2)
        guid: 59555932-0000-0010-8000-00aa00389b71
        bits per pixel: 16
        number of planes: 1
        type: YUV (packed)
      id: 0x32315659 (YV12)
        guid: 59563132-0000-0010-8000-00aa00389b71
        bits per pixel: 12
        number of planes: 3
        type: YUV (planar)
      id: 0x59565955 (UYVY)
        guid: 55595659-0000-0010-8000-00aa00389b71
        bits per pixel: 16
        number of planes: 1
        type: YUV (packed)
      id: 0x30323449 (I420)
        guid: 49343230-0000-0010-8000-00aa00389b71
        bits per pixel: 12
        number of planes: 3
        type: YUV (planar)
      id: 0x3
        guid: 03000000-0000-0010-8000-00aa00389b71
        bits per pixel: 32
        number of planes: 1
        type: RGB (packed)
        depth: 24
        red, green, blue masks: 0xff0000, 0xff00, 0xff


From M.Wache at gmx.net  Wed Aug 30 19:27:25 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Wed, 30 Aug 2006 19:27:25 +0200
Subject: [Softdevice-devel] nVidia hardware alpha blending for OSD
In-Reply-To: <30885-36724@sneakemail.com>
References: <30885-36724@sneakemail.com>
Message-ID: <44F5CA7D.6090809@gmx.net>

CR schrieb:

> To add nVidia alpha-blending support to softdevice for the OSD seems
> straightforward.
>
I fear that it is not that simple... But I wont stop you if you want to
try ;-)


> - Create an OSD buffer and store VDR's OSD with appropriate color weight
> 
> (i.e. if VDR uses 6-6-6 for RGB, left-shift RGB components into upper 6
> bits of each XRGB 8-bit color component)
> 
> - Store alpha value (menu settable?) in buffer
>
VDR uses ARGB32 for the OSD, but conversion routines exist. However you
will loose the alpha channel for the pixels (there seems to be no mode
with an alpha channel). _Every_ pixel has it's own alpha value, and this
is needed for most of the skins. I'm also not sure how one could get
transparent pixels with your method.. I doubt that colorkeys will work
in this case.


> - Call XvPutImage with second blitter port for OSD updates
> 
> - To clear or blank OSD perhaps use a second OSD buffer with alpha set to
> zero (0) and just call XvPutImage
> 
> Although this seems logical and easy in theory, I am having a very very
> hard time following softdevice's code.  I do not understand the
> partitioning of functions among files (video.c, video-xv.c, etc) and the
> lack of many comments makes it hard for me to reverse engineer the logic.
> 
Sorry, it is true that it is not simple to understand the code... If you
have specific questions just go on and ask them.

> I tried adding a menu item for "nv_hardware", but immediately after
> setting that softdevice crashes.  That's about as far as I've gone.
> 
> Is there anyone on the list willing to work with me to add or test this
> theory out?
> 
I would rather suggest to try to use OpenGL. I know that most modern
graphics cards support YUV modes in 2D textures. Unfortunately this is
not standardized :-(. If one could solve these problems (either by using
extensions of the standard, or by doing the conversion in the pixel
shaders), it should be quite simple to add an other layer with ARGB32
format for the OSD.
In fact I have running code which does this for Mac OS X which I could
make available. This code uses an extension of OpenGL which is only
available for Mac OS X for the YUV modes, so this would have to be
changed...

Bye,
Martin


From lists at conealley.net  Sat Sep  2 11:05:03 2006
From: lists at conealley.net (Kim Fredenberg)
Date: Sat, 02 Sep 2006 12:05:03 +0300
Subject: [Softdevice-devel] libcle266mpegdec leaking memory?
Message-ID: <44F9493F.9020208@conealley.net>

Hi,

I played around with libcle266 an DirectFB a bit and noticed that my
application was leaking some memory. I traced it down to
libcle266mpegdec using valgrind, the allocated databuf is never freed.

I added free(databuf); to CLE266MPEGClose and this seems to have solved
the problem.

Is this a true bug or am I missing something in my code?

I guess that softdevice just initialises and closes the CLE266 decoder
once so there is no problem with the leak.

br, Kim Fredenberg


From rahrenbe at cc.hut.fi  Sat Sep  2 12:11:18 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Sat, 2 Sep 2006 13:11:18 +0300 (EEST)
Subject: [Softdevice-devel] libcle266mpegdec leaking memory?
In-Reply-To: <44F9493F.9020208@conealley.net>
References: <44F9493F.9020208@conealley.net>
Message-ID: <Pine.OSF.4.61.0609021309080.269094@kosh.hut.fi>

On Sat, 2 Sep 2006, Kim Fredenberg wrote:

> Is this a true bug or am I missing something in my code?
> I guess that softdevice just initialises and closes the CLE266 decoder
> once so there is no problem with the leak.

IMO, it's simply a bug and will be addressed in the upcoming 0.3 version 
with many other enhancements.

BR,
--
rofa


From lists at conealley.net  Sat Sep  2 13:07:26 2006
From: lists at conealley.net (Kim Fredenberg)
Date: Sat, 02 Sep 2006 14:07:26 +0300
Subject: [Softdevice-devel] libcle266mpegdec leaking memory?
In-Reply-To: <Pine.OSF.4.61.0609021309080.269094@kosh.hut.fi>
References: <44F9493F.9020208@conealley.net>
	<Pine.OSF.4.61.0609021309080.269094@kosh.hut.fi>
Message-ID: <44F965EE.9010301@conealley.net>

Rolf Ahrenberg wrote:
> On Sat, 2 Sep 2006, Kim Fredenberg wrote:
> 
> 
>>Is this a true bug or am I missing something in my code?
>>I guess that softdevice just initialises and closes the CLE266 decoder
>>once so there is no problem with the leak.
> 
> 
> IMO, it's simply a bug and will be addressed in the upcoming 0.3 version 
> with many other enhancements.

Ok, thanks for the verification!

Kim


From marko.makela at hut.fi  Sun Sep  3 17:13:51 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sun, 3 Sep 2006 18:13:51 +0300
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <1849e5180607250223m114e8d61qfde92def54e06435@mail.gmail.com>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<20060716193223.GA4098@localhost.localdomain>
	<1849e5180607161334g7d02834fjc94642f44f0be6e@mail.gmail.com>
	<20060717121919.GA3692@localhost.localdomain>
	<1849e5180607212205t4b638342wd61d592600af04f6@mail.gmail.com>
	<20060722192823.GA4001@localhost.localdomain>
	<1849e5180607250223m114e8d61qfde92def54e06435@mail.gmail.com>
Message-ID: <20060903151350.GB2861@localhost.localdomain>

On Tue, Jul 25, 2006 at 10:23:15AM +0100, Alasdair Campbell wrote:
> > If you could make a short 16:9 clip available on some http server and
> > tell the URL to me, I can check it on my system and tell if it looks okay.
> > The clip should preferrably contain horizontal movement and be interlaced
> > in the first place (not a movie).  Maybe there is something unusual in
> > the DVB streams you receive, e.g., different field order.
> 
> Here is a clip of the BBC rolling news channel, I can see LOTs of
> artifacts with the camera movements, and the scrolling text at the
> bottom looks poor:
> 
> http://ginezbukov.com/artifacts.tar.bz2

I don't know if your sample is still available, but I saw similar artifacts
(16:9 material vertically scaled on 4:3 screen on -vo dfb:mgatv) earlier
this week.  I made a short clip that contains some horizontal movement.

Are there any news on the DirectFB front?  I would appreciate an
interrupt-driven interface, to avoid burning CPU in the Flip() method.
Besides, the code from DirectFB CVS for better interlaced output broke
the OSD.  Has the situation improved since I last checked (June perhaps)?

	Marko


From ragawu at gmail.com  Mon Sep  4 01:26:57 2006
From: ragawu at gmail.com (Alasdair Campbell)
Date: Mon, 4 Sep 2006 00:26:57 +0100
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <20060903151350.GB2861@localhost.localdomain>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<20060716193223.GA4098@localhost.localdomain>
	<1849e5180607161334g7d02834fjc94642f44f0be6e@mail.gmail.com>
	<20060717121919.GA3692@localhost.localdomain>
	<1849e5180607212205t4b638342wd61d592600af04f6@mail.gmail.com>
	<20060722192823.GA4001@localhost.localdomain>
	<1849e5180607250223m114e8d61qfde92def54e06435@mail.gmail.com>
	<20060903151350.GB2861@localhost.localdomain>
Message-ID: <1849e5180609031626l7a7cdab6l7732e39e6e067c91@mail.gmail.com>

On 03/09/06, Marko M?kel? <marko.makela at hut.fi> wrote:
> On Tue, Jul 25, 2006 at 10:23:15AM +0100, Alasdair Campbell wrote:
> > Here is a clip of the BBC rolling news channel, I can see LOTs of
> > artifacts with the camera movements, and the scrolling text at the
> > bottom looks poor:
> >
> > http://ginezbukov.com/artifacts.tar.bz2
>
> I don't know if your sample is still available, but I saw similar artifacts
> (16:9 material vertically scaled on 4:3 screen on -vo dfb:mgatv) earlier
> this week.  I made a short clip that contains some horizontal movement.

Clip is still available if anyone is interested in trying it out - BBC
News 24 clip broadcast on UK DVB-T transmission.

> Are there any news on the DirectFB front?  I would appreciate an
> interrupt-driven interface, to avoid burning CPU in the Flip() method.
> Besides, the code from DirectFB CVS for better interlaced output broke
> the OSD.  Has the situation improved since I last checked (June perhaps)?

I've been meaning to do more investigating on this, but things have
been tough this past month and my girlfriend is certain that she likes
vdr and that she doesn't want me messing about with it's inards!

I ended up using the Gentoo ebuilds to build my system from scratch
because I thought make things easier for me. However they have been
even less reliable than my own compiled setup so I'm going back to
running CVS versions etc.

I'd like to investigate the output using "softdevice -vo dfb:" as I
seem to rememebr that although the OSD was broken and there was a
mirroring of picture above and below the 'letter box' there were no
artifacts, and there was also an option to use the Fb-Intern(al)
de-interlacer. Does that have anything to do with the matrox's
Interlaced output(?).

Some sort of reply from the softdevice programmers or any one from
directFB would be useful in determining what could and couldn't work.

-- 
A l a s d a i r   C a m p b e l l

r a g a w u @ g m a i l . c o m


From zzam at gentoo.org  Mon Sep  4 11:59:29 2006
From: zzam at gentoo.org (Matthias Schwarzott)
Date: Mon, 4 Sep 2006 11:59:29 +0200
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <1849e5180609031626l7a7cdab6l7732e39e6e067c91@mail.gmail.com>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<20060903151350.GB2861@localhost.localdomain>
	<1849e5180609031626l7a7cdab6l7732e39e6e067c91@mail.gmail.com>
Message-ID: <200609041159.29746.zzam@gentoo.org>

On Monday 04 September 2006 01:26, Alasdair Campbell wrote:
>
> I've been meaning to do more investigating on this, but things have
> been tough this past month and my girlfriend is certain that she likes
> vdr and that she doesn't want me messing about with it's inards!
>
> I ended up using the Gentoo ebuilds to build my system from scratch
> because I thought make things easier for me. However they have been
> even less reliable than my own compiled setup so I'm going back to
> running CVS versions etc.
>

Nice to see people trying out gentoo-ebuilds for vdr.
The ebuild for softdevice is also a CVS-Snapshot, the only problem here is 
missing time for maintainance and also that one can not have and try out if 
that specific version works with every possible hardware combination.
If you want to help you can contact us - just visit us in #gentoo-vdr on 
Freenode.

Matthias

-- 
Matthias Schwarzott
Gentoo Developer
http://www.gentoo.org
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060904/d7f297e1/attachment.pgp>

From marko.makela at hut.fi  Mon Sep  4 12:39:44 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 4 Sep 2006 13:39:44 +0300
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <1849e5180609031626l7a7cdab6l7732e39e6e067c91@mail.gmail.com>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<20060716193223.GA4098@localhost.localdomain>
	<1849e5180607161334g7d02834fjc94642f44f0be6e@mail.gmail.com>
	<20060717121919.GA3692@localhost.localdomain>
	<1849e5180607212205t4b638342wd61d592600af04f6@mail.gmail.com>
	<20060722192823.GA4001@localhost.localdomain>
	<1849e5180607250223m114e8d61qfde92def54e06435@mail.gmail.com>
	<20060903151350.GB2861@localhost.localdomain>
	<1849e5180609031626l7a7cdab6l7732e39e6e067c91@mail.gmail.com>
Message-ID: <20060904103943.GA2950@localhost.localdomain>

On Mon, Sep 04, 2006 at 12:26:57AM +0100, Alasdair Campbell wrote:
> > I don't know if your sample is still available, but I saw similar artifacts
> > (16:9 material vertically scaled on 4:3 screen on -vo dfb:mgatv) earlier
> > this week.  I made a short clip that contains some horizontal movement.
> 
> Clip is still available if anyone is interested in trying it out - BBC
> News 24 clip broadcast on UK DVB-T transmission.

Actually, yesterday I noticed that I also still have that clip on my vdr box;
from that you can guess I haven't been watching TV much this summer.

> > Are there any news on the DirectFB front?  I would appreciate an
> > interrupt-driven interface, to avoid burning CPU in the Flip() method.
> > Besides, the code from DirectFB CVS for better interlaced output broke
> > the OSD.  Has the situation improved since I last checked (June perhaps)?
> 
> I've been meaning to do more investigating on this, but things have
> been tough this past month and my girlfriend is certain that she likes
> vdr and that she doesn't want me messing about with it's inards!

In our family, vdr+softdevice has been in "production" use since the
spring of 2005, mostly for children's programs.  Trying out patches at
night is not a problem.  In fact, I did upgrade to softdevice CVS when
I upgraded to vdr 1.4.2.

	Marko


From ragawu at gmail.com  Mon Sep  4 22:19:15 2006
From: ragawu at gmail.com (Alasdair Campbell)
Date: Mon, 4 Sep 2006 21:19:15 +0100
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <20060904103943.GA2950@localhost.localdomain>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<20060716193223.GA4098@localhost.localdomain>
	<1849e5180607161334g7d02834fjc94642f44f0be6e@mail.gmail.com>
	<20060717121919.GA3692@localhost.localdomain>
	<1849e5180607212205t4b638342wd61d592600af04f6@mail.gmail.com>
	<20060722192823.GA4001@localhost.localdomain>
	<1849e5180607250223m114e8d61qfde92def54e06435@mail.gmail.com>
	<20060903151350.GB2861@localhost.localdomain>
	<1849e5180609031626l7a7cdab6l7732e39e6e067c91@mail.gmail.com>
	<20060904103943.GA2950@localhost.localdomain>
Message-ID: <1849e5180609041319xcadd18diad2207a9a6d38921@mail.gmail.com>

On 04/09/06, Marko M?kel? <marko.makela at hut.fi> wrote:
> In our family, vdr+softdevice has been in "production" use since the
> spring of 2005, mostly for children's programs.  Trying out patches at
> night is not a problem.  In fact, I did upgrade to softdevice CVS when
> I upgraded to vdr 1.4.2.

I find that I have very little chance of getting back to a succesful
setup, after I've started trying out patches and new versions etc. It
would be great if I could write a shell script that backed up all the
vdr system files but I'm a complete novice.

If I had a simple way of getting back to a production setup, then I'd
be willing to put in lots of time testing.

-- 
A l a s d a i r   C a m p b e l l

r a g a w u @ g m a i l . c o m


From ragawu at gmail.com  Mon Sep  4 22:26:27 2006
From: ragawu at gmail.com (Alasdair Campbell)
Date: Mon, 4 Sep 2006 21:26:27 +0100
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <200609041159.29746.zzam@gentoo.org>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<20060903151350.GB2861@localhost.localdomain>
	<1849e5180609031626l7a7cdab6l7732e39e6e067c91@mail.gmail.com>
	<200609041159.29746.zzam@gentoo.org>
Message-ID: <1849e5180609041326s5ffa3fd4w25aa1912f1068064@mail.gmail.com>

On 04/09/06, Matthias Schwarzott <zzam at gentoo.org> wrote:
> > I ended up using the Gentoo ebuilds to build my system from scratch
> > because I thought make things easier for me. However they have been
> > even less reliable than my own compiled setup so I'm going back to
> > running CVS versions etc.
>
> Nice to see people trying out gentoo-ebuilds for vdr.
> The ebuild for softdevice is also a CVS-Snapshot, the only problem here is
> missing time for maintainance and also that one can not have and try out if
> that specific version works with every possible hardware combination.

Hi Matthias,

The main problem (possibly softdevice related so hopefully not OT) was
that whenever the OSD was initiated, there would appear large sections
of black space and also dotted lines at the top and bottom of the
letterbox picture. They would disappeer soon after the OSD vanished.

I felt bad rubbishing the name of those Gentoo ebuilds when I hadn't
really put the effort into testing them. I love Gentoo!

I'll probably see you in the chatroom.


-- 
A l a s d a i r   C a m p b e l l

r a g a w u @ g m a i l . c o m


From marko.makela at hut.fi  Mon Sep  4 22:45:44 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 4 Sep 2006 23:45:44 +0300
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <1849e5180609041319xcadd18diad2207a9a6d38921@mail.gmail.com>
References: <20060716193223.GA4098@localhost.localdomain>
	<1849e5180607161334g7d02834fjc94642f44f0be6e@mail.gmail.com>
	<20060717121919.GA3692@localhost.localdomain>
	<1849e5180607212205t4b638342wd61d592600af04f6@mail.gmail.com>
	<20060722192823.GA4001@localhost.localdomain>
	<1849e5180607250223m114e8d61qfde92def54e06435@mail.gmail.com>
	<20060903151350.GB2861@localhost.localdomain>
	<1849e5180609031626l7a7cdab6l7732e39e6e067c91@mail.gmail.com>
	<20060904103943.GA2950@localhost.localdomain>
	<1849e5180609041319xcadd18diad2207a9a6d38921@mail.gmail.com>
Message-ID: <20060904204544.GB2813@localhost.localdomain>

On Mon, Sep 04, 2006 at 09:19:15PM +0100, Alasdair Campbell wrote:
> On 04/09/06, Marko M?kel? <marko.makela at hut.fi> wrote:
> > In our family, vdr+softdevice has been in "production" use since the
> > spring of 2005, mostly for children's programs.  Trying out patches at
> > night is not a problem.  In fact, I did upgrade to softdevice CVS when
> > I upgraded to vdr 1.4.2.
> 
> I find that I have very little chance of getting back to a succesful
> setup, after I've started trying out patches and new versions etc. It
> would be great if I could write a shell script that backed up all the
> vdr system files but I'm a complete novice.
> 
> If I had a simple way of getting back to a production setup, then I'd
> be willing to put in lots of time testing.

I haven't seen the OSD artifacts you mentioned in your other message,
but the following combination works for me:

Linux kernel 2.6.16.x
DirectFB 0.9.25 (not CVS)
vdr 1.4.x
ffmpeg CVS from a few months ago
softdevice CVS

The system runs Debian GNU/Linux unstable, but I don't believe that it would
matter.  Also, I don't think that the ffmpeg version matters, provided that
it is at most a year old.  The Linux kernel might make a difference.
I haven't upgraded to 2.6.17.x yet, because I fear it would introduce some
bugs.

With DirectFB CVS (containing the Matrox patches for interlaced output),
I'd get broken OSD, and any black bars on top and bottom would not be
blanked.

When I scale the output (e.g., add black bars to view 16:9 on 4:3 screen),
I almost never see any interlacing artifacts, like you do.  I only noticed
such artifacts a week ago.  Maybe the field order is different from the one
assumed by the code?

	Marko


From stefan at lucke.in-berlin.de  Mon Sep  4 23:01:16 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 4 Sep 2006 23:01:16 +0200
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <1849e5180609031626l7a7cdab6l7732e39e6e067c91@mail.gmail.com>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<20060903151350.GB2861@localhost.localdomain>
	<1849e5180609031626l7a7cdab6l7732e39e6e067c91@mail.gmail.com>
Message-ID: <200609042301.16491.stefan@lucke.in-berlin.de>

On Montag 04 September 2006 01:26, Alasdair Campbell wrote:
> On 03/09/06, Marko M?kel? <marko.makela at hut.fi> wrote:
> > On Tue, Jul 25, 2006 at 10:23:15AM +0100, Alasdair Campbell wrote:
> > > Here is a clip of the BBC rolling news channel, I can see LOTs of
> > > artifacts with the camera movements, and the scrolling text at the
> > > bottom looks poor:
> > >
> > > http://ginezbukov.com/artifacts.tar.bz2
> >
> > I don't know if your sample is still available, but I saw similar artifacts
> > (16:9 material vertically scaled on 4:3 screen on -vo dfb:mgatv) earlier
> > this week.  I made a short clip that contains some horizontal movement.
> 
> Clip is still available if anyone is interested in trying it out - BBC
> News 24 clip broadcast on UK DVB-T transmission.

Got it thanks, but I could not see artifacts and scrolling text looks
fine on my 4:3 TV (use directfb cvs from today with OSD issues).

> 
> > Are there any news on the DirectFB front?  I would appreciate an
> > interrupt-driven interface, to avoid burning CPU in the Flip() method.
> > Besides, the code from DirectFB CVS for better interlaced output broke
> > the OSD.  Has the situation improved since I last checked (June perhaps)?
> 
> I've been meaning to do more investigating on this, but things have
> been tough this past month and my girlfriend is certain that she likes
> vdr and that she doesn't want me messing about with it's inards!
> 
> I ended up using the Gentoo ebuilds to build my system from scratch
> because I thought make things easier for me. However they have been
> even less reliable than my own compiled setup so I'm going back to
> running CVS versions etc.
> 
> I'd like to investigate the output using "softdevice -vo dfb:" as I
> seem to rememebr that although the OSD was broken and there was a
> mirroring of picture above and below the 'letter box' there were no
> artifacts, and there was also an option to use the Fb-Intern(al)
> de-interlacer. Does that have anything to do with the matrox's
> Interlaced output(?).

The OSD is broken with DirectFB since field blit has been added to DirectFB-cvs.
I know this is very annoying. Currently I'm looking for that.

> 
> Some sort of reply from the softdevice programmers or any one from
> directFB would be useful in determining what could and couldn't work.
> 

-- 
Stefan Lucke


From ragawu at gmail.com  Tue Sep  5 01:10:13 2006
From: ragawu at gmail.com (Alasdair Campbell)
Date: Tue, 5 Sep 2006 00:10:13 +0100
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <20060904204544.GB2813@localhost.localdomain>
References: <20060716193223.GA4098@localhost.localdomain>
	<20060717121919.GA3692@localhost.localdomain>
	<1849e5180607212205t4b638342wd61d592600af04f6@mail.gmail.com>
	<20060722192823.GA4001@localhost.localdomain>
	<1849e5180607250223m114e8d61qfde92def54e06435@mail.gmail.com>
	<20060903151350.GB2861@localhost.localdomain>
	<1849e5180609031626l7a7cdab6l7732e39e6e067c91@mail.gmail.com>
	<20060904103943.GA2950@localhost.localdomain>
	<1849e5180609041319xcadd18diad2207a9a6d38921@mail.gmail.com>
	<20060904204544.GB2813@localhost.localdomain>
Message-ID: <1849e5180609041610r274162cblc17bdb72b2ff8c46@mail.gmail.com>

On 04/09/06, Marko M?kel? <marko.makela at hut.fi> wrote:
> I haven't seen the OSD artifacts you mentioned in your other message,
> but the following combination works for me:
>
> ...
>
> With DirectFB CVS (containing the Matrox patches for interlaced output),
> I'd get broken OSD, and any black bars on top and bottom would not be
> blanked.
>
> When I scale the output (e.g., add black bars to view 16:9 on 4:3 screen),
> I almost never see any interlacing artifacts, like you do.  I only noticed
> such artifacts a week ago.  Maybe the field order is different from the one
> assumed by the code?

I don't know much about programming, but I know that field order has
only two options, so it should be easy for me to patch the softdevice
code to see if this has any effect... I'm just wondering if that would
mean that the programs which do not show these artifacts - hbo dramas,
films - would suddenly start misbehaving.

I've been considering searching for a cheap widescreen CRT tele, seems
to me everyone's buying over priced "HD-ready" flat screens at the
moment, so I should be able to pick one up for not too much money. I'd
expect all these problems to disappeer seeing as there would be no
scaling whatsoever.

-- 
A l a s d a i r   C a m p b e l l

r a g a w u @ g m a i l . c o m


From ragawu at gmail.com  Tue Sep  5 01:17:10 2006
From: ragawu at gmail.com (Alasdair Campbell)
Date: Tue, 5 Sep 2006 00:17:10 +0100
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <200609042301.16491.stefan@lucke.in-berlin.de>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<20060903151350.GB2861@localhost.localdomain>
	<1849e5180609031626l7a7cdab6l7732e39e6e067c91@mail.gmail.com>
	<200609042301.16491.stefan@lucke.in-berlin.de>
Message-ID: <1849e5180609041617h4579d219i4bf418bbb1a92612@mail.gmail.com>

On 04/09/06, Stefan Lucke <stefan at lucke.in-berlin.de> wrote:
> The OSD is broken with DirectFB since field blit has been added to DirectFB-cvs.
> I know this is very annoying. Currently I'm looking for that.

Good luck! I don't really have many skills to offer in this field, but
am willing to help in any way.
-- 
A l a s d a i r   C a m p b e l l

r a g a w u @ g m a i l . c o m


From marko.makela at hut.fi  Tue Sep  5 09:35:04 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 5 Sep 2006 10:35:04 +0300
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <1849e5180609041610r274162cblc17bdb72b2ff8c46@mail.gmail.com>
References: <20060717121919.GA3692@localhost.localdomain>
	<1849e5180607212205t4b638342wd61d592600af04f6@mail.gmail.com>
	<20060722192823.GA4001@localhost.localdomain>
	<1849e5180607250223m114e8d61qfde92def54e06435@mail.gmail.com>
	<20060903151350.GB2861@localhost.localdomain>
	<1849e5180609031626l7a7cdab6l7732e39e6e067c91@mail.gmail.com>
	<20060904103943.GA2950@localhost.localdomain>
	<1849e5180609041319xcadd18diad2207a9a6d38921@mail.gmail.com>
	<20060904204544.GB2813@localhost.localdomain>
	<1849e5180609041610r274162cblc17bdb72b2ff8c46@mail.gmail.com>
Message-ID: <20060905073503.GB2887@localhost.localdomain>

On Tue, Sep 05, 2006 at 12:10:13AM +0100, Alasdair Campbell wrote:
> I've been considering searching for a cheap widescreen CRT tele, seems
> to me everyone's buying over priced "HD-ready" flat screens at the
> moment, so I should be able to pick one up for not too much money.

Me too.  It would be a waste to watch low-bitrate DVB streams on such
a big screen.  The MPEG and JPEG artifacts are clearly visible.

A used one would probably do for me.  I think I would have to build a
IR transmitter to avoid having to use a second RCU.  Currently, my monitor
is powered up by a solid-state relay driven from the RS-232 port of the PC.
TVs usually need to be powered up by RCU after getting mains power, and
they may also need to be switched to the AV channel.

> I'd expect all these problems to disappeer seeing as there would be no
> scaling whatsoever.

Sure.

	Marko


From stefan at lucke.in-berlin.de  Tue Sep  5 18:33:51 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 5 Sep 2006 18:33:51 +0200
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <1849e5180609041617h4579d219i4bf418bbb1a92612@mail.gmail.com>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<200609042301.16491.stefan@lucke.in-berlin.de>
	<1849e5180609041617h4579d219i4bf418bbb1a92612@mail.gmail.com>
Message-ID: <200609051833.51434.stefan@lucke.in-berlin.de>

On Dienstag 05 September 2006 01:17, Alasdair Campbell wrote:
> On 04/09/06, Stefan Lucke <stefan at lucke.in-berlin.de> wrote:
> > The OSD is broken with DirectFB since field blit has been added to DirectFB-cvs.
> > I know this is very annoying. Currently I'm looking for that.
> 
> Good luck! I don't really have many skills to offer in this field, but
> am willing to help in any way.

Ok you can help: please test.

I think I found the bug. My first thought from this morning lead my to the
direction, but it _only_ fixed the OSD drawing and _not_ the shrinked
picture above the downscaled 16:9 rect. This rect is from clear background
operation.

Attached patch fixes both: OSD and clear background.

-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: mga_fix_02.patch
Type: text/x-diff
Size: 933 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060905/6a7f5313/attachment.patch>

From rahrenbe at cc.hut.fi  Tue Sep  5 23:09:08 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Wed, 6 Sep 2006 00:09:08 +0300 (EEST)
Subject: [Softdevice-devel] libcle266mpegdec-0.3
Message-ID: <Pine.OSF.4.61.0609052359330.298366@kosh.hut.fi>


Hi,

the libcle266mpegdec library has been floating around more than 4 months 
now and the original author of mtest hasn't complained about this 
spinoff project. So, I've setup a sourceforge project with cvs access 
for it and released a new 0.3 version:

http://sourceforge.net/projects/cle266mpegdec/

Hopefully, all of the authors have been credited as they should be. If 
you want a developer access, please, let me know.

BR,
--
rofa


From lucianm at users.sourceforge.net  Tue Sep  5 23:09:50 2006
From: lucianm at users.sourceforge.net (Lucian Muresan)
Date: Tue, 05 Sep 2006 23:09:50 +0200
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <200609051833.51434.stefan@lucke.in-berlin.de>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>	<200609042301.16491.stefan@lucke.in-berlin.de>	<1849e5180609041617h4579d219i4bf418bbb1a92612@mail.gmail.com>
	<200609051833.51434.stefan@lucke.in-berlin.de>
Message-ID: <44FDE79E.5020809@users.sourceforge.net>

Stefan Lucke wrote:
[..]
> Ok you can help: please test.
> 
> I think I found the bug. My first thought from this morning lead my to the
> direction, but it _only_ fixed the OSD drawing and _not_ the shrinked
> picture above the downscaled 16:9 rect. This rect is from clear background
> operation.
> 
> Attached patch fixes both: OSD and clear background.

Great, it works for me!
Lucian


From ragawu at gmail.com  Wed Sep  6 03:40:20 2006
From: ragawu at gmail.com (Alasdair Campbell)
Date: Wed, 6 Sep 2006 02:40:20 +0100
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <200609051833.51434.stefan@lucke.in-berlin.de>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<200609042301.16491.stefan@lucke.in-berlin.de>
	<1849e5180609041617h4579d219i4bf418bbb1a92612@mail.gmail.com>
	<200609051833.51434.stefan@lucke.in-berlin.de>
Message-ID: <1849e5180609051840l3f5592dep612f6beae02f389a@mail.gmail.com>

On 05/09/06, Stefan Lucke <stefan at lucke.in-berlin.de> wrote:
> Ok you can help: please test.
>
> I think I found the bug. My first thought from this morning lead my to the
> direction, but it _only_ fixed the OSD drawing and _not_ the shrinked
> picture above the downscaled 16:9 rect. This rect is from clear background
> operation.
>
> Attached patch fixes both: OSD and clear background.
Stefan,

Thanks so much for the patch, I can confirm that there are no
artifacts visibile for 16:9 content scaled to a 4:3 screen. There are
still artifacts visible when watching low quality american sitcoms,
but as I have no interest in them I should be able to manage without..

One or two new issues have cropped up, there is a square section of
the screen roughly 40 pixels square that occaisonally shows a
different colour than what should be there, it's almost like the quick
mask in photoshop, the image data is there howevere the colours are
wrong.

The location of the square changes and it isn't always there... any ideas?

Also, I've seen little or no improvement in the audio sync with the
video. I'm suffering from the audio going out of sync every 45 seconds
and taking 4-8 seconds to sync back up, before it loses sync again.
Sometimes I change a channel and the audio can take 20 seconds before
it is in sync and does not stay that way for long.

Is this problem related to your programming, a deficiency in my setup,
a vdr problem or something that is know about and cannot be fixed?

I can provide any log/config files you would need.

thanks
-- 
A l a s d a i r   C a m p b e l l

r a g a w u @ g m a i l . c o m


From stefan at lucke.in-berlin.de  Wed Sep  6 07:02:05 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 6 Sep 2006 07:02:05 +0200
Subject: [Softdevice-devel] dfb-out: square with different colours (Was: Re:
	g450 interlaced output)
Message-ID: <200609060702.05976.stefan@lucke.in-berlin.de>

On Mittwoch 06 September 2006 03:40, Alasdair Campbell wrote:

> One or two new issues have cropped up, there is a square section of
> the screen roughly 40 pixels square that occaisonally shows a
> different colour than what should be there, it's almost like the quick
> mask in photoshop, the image data is there howevere the colours are
> wrong.
> 
> The location of the square changes and it isn't always there... any ideas?

Which output mode are you using (TV-out or VGA-out: "-vo dfb:mgatv"  or "-vo dfb:")?

I've seen some artifacts from color-keying when I use VGA-out _and_ I switch between
YV12 mode (using color keying) and YUV2 mode (with stretchblit). But this
does not happen  when I don't touch these modes. 
I know it's hard, but is it possible to make a screen shot from this ?

-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Wed Sep  6 07:11:48 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 6 Sep 2006 07:11:48 +0200
Subject: [Softdevice-devel] dfb-out audio sync (Was: Re: g450 interlaced
	output)
Message-ID: <200609060711.48160.stefan@lucke.in-berlin.de>

On Mittwoch 06 September 2006 03:40, Alasdair Campbell wrote:

> Also, I've seen little or no improvement in the audio sync with the
> video. I'm suffering from the audio going out of sync every 45 seconds
> and taking 4-8 seconds to sync back up, before it loses sync again.
> Sometimes I change a channel and the audio can take 20 seconds before
> it is in sync and does not stay that way for long.
> 
> Is this problem related to your programming, a deficiency in my setup,
> a vdr problem or something that is know about and cannot be fixed?
> 
> I can provide any log/config files you would need.

Message log written to stderr and stdout would be interesting:
Are '+' chars written, when the resync happens ?

./vdr with_some_parameter >msg.log 2>&1

-- 
Stefan Lucke


From lists at conealley.net  Wed Sep  6 10:10:41 2006
From: lists at conealley.net (Kim Fredenberg)
Date: Wed, 06 Sep 2006 11:10:41 +0300
Subject: [Softdevice-devel] libcle266mpegdec-0.3
In-Reply-To: <Pine.OSF.4.61.0609052359330.298366@kosh.hut.fi>
References: <Pine.OSF.4.61.0609052359330.298366@kosh.hut.fi>
Message-ID: <44FE8281.4080109@conealley.net>

Rolf Ahrenberg wrote:
> Hi,
> 
> the libcle266mpegdec library has been floating around more than 4 months 
> now and the original author of mtest hasn't complained about this 
> spinoff project. So, I've setup a sourceforge project with cvs access 
> for it and released a new 0.3 version:
> 
> http://sourceforge.net/projects/cle266mpegdec/

I tried out 0.3 but I seem to have some problems with it. The output
from the 0.3 version is distorted (huge amount of pixelation) on some
clips. I actually found one working fine, the trailer from
http://www.starwreck.com/.

I just compiled the lib and re-linked my application.

With 0.2 the same code and the same clips are working fine.

Kim


From laz at club-burniston.co.uk  Wed Sep  6 10:56:17 2006
From: laz at club-burniston.co.uk (Laz)
Date: Wed, 6 Sep 2006 09:56:17 +0100
Subject: [Softdevice-devel] libcle266mpegdec-0.3
In-Reply-To: <Pine.OSF.4.61.0609052359330.298366@kosh.hut.fi>
References: <Pine.OSF.4.61.0609052359330.298366@kosh.hut.fi>
Message-ID: <200609060956.17441.laz@club-burniston.co.uk>

On Tuesday 05 September 2006 22:09, Rolf Ahrenberg wrote:
> Hi,
>
> the libcle266mpegdec library has been floating around more than 4
> months now and the original author of mtest hasn't complained about
> this spinoff project. So, I've setup a sourceforge project with cvs
> access for it and released a new 0.3 version:
>
> http://sourceforge.net/projects/cle266mpegdec/
>
> Hopefully, all of the authors have been credited as they should be. If
> you want a developer access, please, let me know.

Nice one. Thanks for getting that up.

I'll try to give the new version a go in the next few days...

Cheers,

Laz


From omge2ri02 at sneakemail.com  Wed Sep  6 12:08:13 2006
From: omge2ri02 at sneakemail.com (CR)
Date: Wed, 6 Sep 2006 03:08:13 -0700 (MST)
Subject: [Softdevice-devel] nV OSD issues
In-Reply-To: <mailman.23.1157536820.30065.softdevice-devel@lists.berlios.de>
References: <mailman.23.1157536820.30065.softdevice-devel@lists.berlios.de>
Message-ID: <28804-07152@sneakemail.com>

Hi,

I'm plauged by an OSD issue with my nV video card, so I'm brain storming
about possible problems/solutions.  It turns out the nVidia Xv blitter
port supports "XRGB" but not ARGB (the "XRGB" == upper bits do nothing).

I specifically notice when VDR starts up and there is no video playback,
the OSD is fine.  The moment video playback starts, the OSD gets
corrupted.  After all video playback has ceased, the OSD retains it's
corruption, even if I change menus, options, etc.

Question:

Does softdevice do something like grab a "blackframe" or a chroma-key
frame when video playback starts, so the OSD does not get removed by the
video card's "overlay" functionality?

CR.



From marko.makela at hut.fi  Wed Sep  6 22:44:17 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 6 Sep 2006 23:44:17 +0300
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <200609051833.51434.stefan@lucke.in-berlin.de>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<200609042301.16491.stefan@lucke.in-berlin.de>
	<1849e5180609041617h4579d219i4bf418bbb1a92612@mail.gmail.com>
	<200609051833.51434.stefan@lucke.in-berlin.de>
Message-ID: <20060906204417.GA2844@localhost.localdomain>

On Tue, Sep 05, 2006 at 06:33:51PM +0200, Stefan Lucke wrote:
> I think I found the bug. My first thought from this morning lead my to the
> direction, but it _only_ fixed the OSD drawing and _not_ the shrinked
> picture above the downscaled 16:9 rect. This rect is from clear background
> operation.
> 
> Attached patch fixes both: OSD and clear background.

Thank you, Stefan! I tested this on fresh DirectFB and DFB++ CVS, and
it really fixes those issues.

The two problematic clips look correct now.  I tried setting
cDFBVideoOut::fieldParity to 1 in the constructor, but it made them
look worse.  The BBC News clip looks completely okay now, but the clip
I made last week may merely be suffering from dropped frames now
(due to very big movement).

Now I only have one wishlist item left for DirectFB on Matrox cards:
get rid of that busy-waiting in IDirectFBSurface::Flip() by implementing
some ioctl() calls to make it interrupt-driven.  Meanwhile, this patch
seems to substantially reduce the CPU consumption on my system:

Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.70
diff -p -u -r1.70 video-dfb.c
--- video-dfb.c	5 Aug 2006 17:51:25 -0000	1.70
+++ video-dfb.c	6 Sep 2006 20:37:47 -0000
@@ -1300,6 +1300,7 @@ void cDFBVideoOut::ShowOSD ()
         scrSurface->SetBlittingFlags(DSBLIT_BLEND_ALPHACHANNEL);
         scrSurface->Blit(osdSurface, &osdsrc, 0, 0);
       }
+      usleep(1000);
       scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
 
     }
@@ -1499,6 +1500,7 @@ void cDFBVideoOut::YUV(sPicBuffer *buf)
 
       }
       //scrSurface->Flip(NULL, (setupStore->useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
+      usleep(2000);
       scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
     }
     else

According to "top", the vdr process consumes 52 to 67 per cent of CPU
(900 MHz Celeron).

I plan to make some OProfile measurements this weekend.  At the very least,
I will measure the impact of colour space transformation (i.e., let
-vo dfb:mgatv show wrong colours by pretending it uses the native output
colour space of ffmpeg).

	Marko


From marko.makela at hut.fi  Wed Sep  6 23:18:13 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 7 Sep 2006 00:18:13 +0300
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <20060906204417.GA2844@localhost.localdomain>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<200609042301.16491.stefan@lucke.in-berlin.de>
	<1849e5180609041617h4579d219i4bf418bbb1a92612@mail.gmail.com>
	<200609051833.51434.stefan@lucke.in-berlin.de>
	<20060906204417.GA2844@localhost.localdomain>
Message-ID: <20060906211813.GB2844@localhost.localdomain>

On Wed, Sep 06, 2006 at 11:44:17PM +0300, Marko M?kel? wrote:
> The two problematic clips look correct now.  I tried setting
> cDFBVideoOut::fieldParity to 1 in the constructor, but it made them
> look worse.  The BBC News clip looks completely okay now, but the clip
> I made last week may merely be suffering from dropped frames now
> (due to very big movement).

Sorry, it seems nondeterministic.  Sometimes (at least after restarting
vdr), the vertically scaled output (CropMode "none", "16:9", or "14:9"
on 4:3 screen) looks similar to fieldParity==1 in CropMode 4:3, but
other times it looks perfect.

Stefan, could you please test that BBC News clip again?  Restart vdr
several times.  Hmm, maybe you will need to kill vdr forcefully to
leave DirectFB in an inconsistent state.  I saw changes of behaviour
after recompiling softdevice with "make plugins", which will cause
vdr to dump core.  After three "killall -KILL vdr", the problem
appeared in 14:9 crop mode.  Screen aspect ratio is set to 4:3.

	Marko


From malcolm.caldwell at cdu.edu.au  Thu Sep  7 01:32:03 2006
From: malcolm.caldwell at cdu.edu.au (Malcolm Caldwell)
Date: Thu, 07 Sep 2006 09:02:03 +0930
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <20060906204417.GA2844@localhost.localdomain>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<200609042301.16491.stefan@lucke.in-berlin.de>
	<1849e5180609041617h4579d219i4bf418bbb1a92612@mail.gmail.com>
	<200609051833.51434.stefan@lucke.in-berlin.de>
	<20060906204417.GA2844@localhost.localdomain>
Message-ID: <1157585523.3822.1.camel@localhost.localdomain>

On Wed, 2006-09-06 at 23:44 +0300, Marko M?kel? wrote:
> On Tue, Sep 05, 2006 at 06:33:51PM +0200, Stefan Lucke wrote:
> > I think I found the bug. My first thought from this morning lead my to the
> > direction, but it _only_ fixed the OSD drawing and _not_ the shrinked
> > picture above the downscaled 16:9 rect. This rect is from clear background
> > operation.
> > 
> > Attached patch fixes both: OSD and clear background.
> 
> Thank you, Stefan! I tested this on fresh DirectFB and DFB++ CVS, and
> it really fixes those issues.
> 
> The two problematic clips look correct now.  I tried setting
> cDFBVideoOut::fieldParity to 1 in the constructor, but it made them
> look worse.  The BBC News clip looks completely okay now, but the clip
> I made last week may merely be suffering from dropped frames now
> (due to very big movement).
> 
> Now I only have one wishlist item left for DirectFB on Matrox cards:
> get rid of that busy-waiting in IDirectFBSurface::Flip() by implementing
> some ioctl() calls to make it interrupt-driven.  Meanwhile, this patch
> seems to substantially reduce the CPU consumption on my system:

I can add my one wishlist item for DirectFB on Matrox cards:

dynamic changing between NTSC and PAL.

Great work so far, the interlaced scaling makes a big difference.



From ragawu at gmail.com  Thu Sep  7 05:03:42 2006
From: ragawu at gmail.com (Alasdair Campbell)
Date: Thu, 7 Sep 2006 04:03:42 +0100
Subject: [Softdevice-devel] dfb-out audio sync (Was: Re: g450 interlaced
	output)
In-Reply-To: <200609060711.48160.stefan@lucke.in-berlin.de>
References: <200609060711.48160.stefan@lucke.in-berlin.de>
Message-ID: <1849e5180609062003rf7231a0g8c71369a8d092e9d@mail.gmail.com>

On 06/09/06, Stefan Lucke <stefan at lucke.in-berlin.de> wrote:
> Message log written to stderr and stdout would be interesting:
> Are '+' chars written, when the resync happens ?
>
> ./vdr with_some_parameter >msg.log 2>&1

I'll get you this tomorrow.

-- 
A l a s d a i r   C a m p b e l l

r a g a w u @ g m a i l . c o m


From ragawu at gmail.com  Thu Sep  7 05:05:59 2006
From: ragawu at gmail.com (Alasdair Campbell)
Date: Thu, 7 Sep 2006 04:05:59 +0100
Subject: [Softdevice-devel] dfb-out: square with different colours (Was:
	Re: g450 interlaced output)
In-Reply-To: <200609060702.05976.stefan@lucke.in-berlin.de>
References: <200609060702.05976.stefan@lucke.in-berlin.de>
Message-ID: <1849e5180609062005y7326332ct3c0e992952d4ee9@mail.gmail.com>

On 06/09/06, Stefan Lucke <stefan at lucke.in-berlin.de> wrote:
> > The location of the square changes and it isn't always there... any ideas?
>
> Which output mode are you using (TV-out or VGA-out: "-vo dfb:mgatv"  or "-vo dfb:")?
>

Using TV-out (-vo dfb:mgatv)

> I've seen some artifacts from color-keying when I use VGA-out _and_ I switch between
> YV12 mode (using color keying) and YUV2 mode (with stretchblit). But this
> does not happen  when I don't touch these modes.
> I know it's hard, but is it possible to make a screen shot from this ?

I'll need to learn how to do that but as soon as I do, I'll stick one
up for everyone to see.


-- 
A l a s d a i r   C a m p b e l l

r a g a w u @ g m a i l . c o m


From stefan at lucke.in-berlin.de  Thu Sep  7 06:55:36 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 7 Sep 2006 06:55:36 +0200
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <20060906211813.GB2844@localhost.localdomain>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<20060906204417.GA2844@localhost.localdomain>
	<20060906211813.GB2844@localhost.localdomain>
Message-ID: <200609070655.36505.stefan@lucke.in-berlin.de>

On Mittwoch 06 September 2006 23:18, Marko M?kel? wrote:
> On Wed, Sep 06, 2006 at 11:44:17PM +0300, Marko M?kel? wrote:
> > The two problematic clips look correct now.  I tried setting
> > cDFBVideoOut::fieldParity to 1 in the constructor, but it made them
> > look worse.  The BBC News clip looks completely okay now, but the clip
> > I made last week may merely be suffering from dropped frames now
> > (due to very big movement).
> 
> Sorry, it seems nondeterministic.  Sometimes (at least after restarting
> vdr), the vertically scaled output (CropMode "none", "16:9", or "14:9"
> on 4:3 screen) looks similar to fieldParity==1 in CropMode 4:3, but
> other times it looks perfect.

Could you check your logs to see if there is an even/odd combination
of source and destination yoffset ? 
I think Ville's modification has the ability of swapping fields and lyoff
is not guarantied to be even.
http://mail.directfb.org/pipermail/directfb-dev/2006-May/001726.html

> 
> Stefan, could you please test that BBC News clip again?  

I'll do that.

> Restart vdr 
> several times.  Hmm, maybe you will need to kill vdr forcefully to
> leave DirectFB in an inconsistent state.  I saw changes of behaviour
> after recompiling softdevice with "make plugins", which will cause
> vdr to dump core.  After three "killall -KILL vdr", the problem
> appeared in 14:9 crop mode.  Screen aspect ratio is set to 4:3.
> 

-- 
Stefan Lucke


From rahrenbe at cc.hut.fi  Thu Sep  7 08:36:07 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Thu, 7 Sep 2006 09:36:07 +0300 (EEST)
Subject: [Softdevice-devel] libcle266mpegdec-0.3
In-Reply-To: <44FE8281.4080109@conealley.net>
References: <Pine.OSF.4.61.0609052359330.298366@kosh.hut.fi>
	<44FE8281.4080109@conealley.net>
Message-ID: <Pine.OSF.4.61.0609070933530.494556@kosh.hut.fi>

On Wed, 6 Sep 2006, Kim Fredenberg wrote:

> I tried out 0.3 but I seem to have some problems with it. The output
> from the 0.3 version is distorted (huge amount of pixelation) on some clips.
> With 0.2 the same code and the same clips are working fine.

I'll try to find some time tonight to verify this.

BR,
--
rofa


From laz at club-burniston.co.uk  Thu Sep  7 12:03:40 2006
From: laz at club-burniston.co.uk (Laz)
Date: Thu, 7 Sep 2006 11:03:40 +0100
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <1157585523.3822.1.camel@localhost.localdomain>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<20060906204417.GA2844@localhost.localdomain>
	<1157585523.3822.1.camel@localhost.localdomain>
Message-ID: <200609071103.41098.laz@club-burniston.co.uk>

On Thursday 07 September 2006 00:32, Malcolm Caldwell wrote:
> On Wed, 2006-09-06 at 23:44 +0300, Marko M?kel? wrote:
> > On Tue, Sep 05, 2006 at 06:33:51PM +0200, Stefan Lucke wrote:
> > > I think I found the bug. My first thought from this morning lead my
> > > to the direction, but it _only_ fixed the OSD drawing and _not_ the
> > > shrinked picture above the downscaled 16:9 rect. This rect is from
> > > clear background operation.
> > >
> > > Attached patch fixes both: OSD and clear background.
> >
> > Thank you, Stefan! I tested this on fresh DirectFB and DFB++ CVS, and
> > it really fixes those issues.
> >
> > The two problematic clips look correct now.  I tried setting
> > cDFBVideoOut::fieldParity to 1 in the constructor, but it made them
> > look worse.  The BBC News clip looks completely okay now, but the
> > clip I made last week may merely be suffering from dropped frames now
> > (due to very big movement).
> >
> > Now I only have one wishlist item left for DirectFB on Matrox cards:
> > get rid of that busy-waiting in IDirectFBSurface::Flip() by
> > implementing some ioctl() calls to make it interrupt-driven. 
> > Meanwhile, this patch seems to substantially reduce the CPU
> > consumption on my system:
>
> I can add my one wishlist item for DirectFB on Matrox cards:
>
> dynamic changing between NTSC and PAL.
>
> Great work so far, the interlaced scaling makes a big difference.

I've been vaguely following this but haven't had a chance to test the mga 
output for a while!

Is the OSD still broken for mga output? I ended up backtracking to about 
February CVS a while back to get my OSD working again!

Trying to work out whether to leave that system as it is or upgrade both 
DirectFB and softdevice on it...

Cheers,

Laz


From lucianm at users.sourceforge.net  Thu Sep  7 12:15:58 2006
From: lucianm at users.sourceforge.net (Lucian Muresan)
Date: Thu, 07 Sep 2006 12:15:58 +0200
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <200609071103.41098.laz@club-burniston.co.uk>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>	<20060906204417.GA2844@localhost.localdomain>	<1157585523.3822.1.camel@localhost.localdomain>
	<200609071103.41098.laz@club-burniston.co.uk>
Message-ID: <44FFF15E.5050805@users.sourceforge.net>

Laz wrote:
[..]
> I've been vaguely following this but haven't had a chance to test the mga 
> output for a while!
> 
> Is the OSD still broken for mga output? I ended up backtracking to about 
> February CVS a while back to get my OSD working again!

DirectFB-CVS + Stefan's patch, together with softdevice-CVS works well 
now on my G400 TV-out (including OSD), I use Gentoo live CVS ebuilds for 
DirectFB and softdevice and I pulled them the day Stefan announced his 
fix. The video seems a bit softer than before, or compared to my 
domestic STB, and I too noticed some A/V sync issues, but I think 
they're not that bad to make the system unusable. I have to admit, I had 
very few time lately to use VDR intensively.

Cheers,
Lucian



From dave at optionsdsl.ca  Thu Sep  7 20:06:22 2006
From: dave at optionsdsl.ca (Dave)
Date: Thu, 07 Sep 2006 14:06:22 -0400
Subject: [Softdevice-devel] dfb-out audio sync (Was: Re: g450 interlaced
 output)
In-Reply-To: <200609060711.48160.stefan@lucke.in-berlin.de>
References: <200609060711.48160.stefan@lucke.in-berlin.de>
Message-ID: <45005F9E.6030706@optionsdsl.ca>

Stefan Lucke wrote:
> On Mittwoch 06 September 2006 03:40, Alasdair Campbell wrote:
>
>   
>> Also, I've seen little or no improvement in the audio sync with the
>> video. I'm suffering from the audio going out of sync every 45 seconds
>> and taking 4-8 seconds to sync back up, before it loses sync again.
>> Sometimes I change a channel and the audio can take 20 seconds before
>> it is in sync and does not stay that way for long.
>>
>> Is this problem related to your programming, a deficiency in my setup,
>> a vdr problem or something that is know about and cannot be fixed?
>>
>> I can provide any log/config files you would need.
>>     
>
> Message log written to stderr and stdout would be interesting:
> Are '+' chars written, when the resync happens ?
>
> ./vdr with_some_parameter >msg.log 2>&1
>
>   

I also suffer from this problem, and have for months using mgatv DFB. 
other output methods like just DFB are fine.  No logs  or stdoutput
entries ever seem to be leading to the problem for me.   


From ragawu at gmail.com  Thu Sep  7 22:09:20 2006
From: ragawu at gmail.com (Alasdair Campbell)
Date: Thu, 7 Sep 2006 21:09:20 +0100
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <20060906204417.GA2844@localhost.localdomain>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<200609042301.16491.stefan@lucke.in-berlin.de>
	<1849e5180609041617h4579d219i4bf418bbb1a92612@mail.gmail.com>
	<200609051833.51434.stefan@lucke.in-berlin.de>
	<20060906204417.GA2844@localhost.localdomain>
Message-ID: <1849e5180609071309i38bfb466hcabae8c61ef4ddbf@mail.gmail.com>

On 06/09/06, Marko M?kel? <marko.makela at hut.fi> wrote:
>
> ...
>
> Now I only have one wishlist item left for DirectFB on Matrox cards:
> get rid of that busy-waiting in IDirectFBSurface::Flip() by implementing
> some ioctl() calls to make it interrupt-driven.

Is that a lot of work?

> Meanwhile, this patch
> seems to substantially reduce the CPU consumption on my system:
>
> ...
>
> According to "top", the vdr process consumes 52 to 67 per cent of CPU
> (900 MHz Celeron).
>

With my underclocked barton (running at 1350 MHz) the following
results were got from 'top'.
[I just took the value for the vdr process with the highest value,
don't know if this is misleading].

Unpatched:
-vo dfb:mgatv  = ~40%
-vo dfb:  = ~21% ( a lovely figure!)

Patched:
-vo dfb:mgatv = ~29% (great patch)
-vo dfb: = ~29%

These were all taken during 10 minute period of BBC News 24 so I could
look out for artifacts. the bbc streams are full bitrate I seem to
remember, so for instance if I changed to something altogether more
low-fi, such as _sky news_, the cpu dropped to as low as 12% with
unpatched softdevice running with '-vo dfb:' (bloody amazing!)

With results like that, and with Matrox hardware scaled interlaced
output working in 'VGA' mode, I could nearly run vdr on my old AMD K6
500mhz relic.

> I plan to make some OProfile measurements this weekend.  At the very least,
> I will measure the impact of colour space transformation (i.e., let
> -vo dfb:mgatv show wrong colours by pretending it uses the native output
> colour space of ffmpeg).

I remember you saying your cable didn't work with "-vo dfb:" because
that option didn't generate a composite sync signal - well I don't
think I made it clear enough that I _did_ see a picture of comparable
(slightly sharper) quality using "-vo dfb:" & the cable from the
diagram we both used. When I was testing -vo dfb: and latest CVS
DirectFB the only problem was the OSD that was double sized and had
horizontal lines, oh and the squashed image above the horizontal bars.
I'm fairly sure you know that already but on reading back I don't
think I made it clear to anyone reading this, and there must be other
folk out there with the same problem.

Basically, latest DirectFB CVS with softdevice option '-vo dfb:' seems
to generate a composite signal just like '-vo dfb:mgatv' does. The
only noticeable difference is that the image quality is sharper with
'vga' out as opposed to 'TV' out, and that the interlacing artifacts
are still visible with & without Stefan's patch.

Seems to me that maybe scaled interlaced output could work with '-vo
dfb:' someday, I just don't know if that's what they're aiming for
with these modifications. I'll need to read their mailing list.

regards,

-- 
A l a s d a i r   C a m p b e l l

r a g a w u @ g m a i l . c o m


From ragawu at gmail.com  Thu Sep  7 22:35:16 2006
From: ragawu at gmail.com (Alasdair Campbell)
Date: Thu, 7 Sep 2006 21:35:16 +0100
Subject: [Softdevice-devel] dfb-out audio sync (Was: Re: g450 interlaced
	output)
In-Reply-To: <45005F9E.6030706@optionsdsl.ca>
References: <200609060711.48160.stefan@lucke.in-berlin.de>
	<45005F9E.6030706@optionsdsl.ca>
Message-ID: <1849e5180609071335y6dd72d9bh5fcfcc1f6632e156@mail.gmail.com>

On 07/09/06, Dave <dave at optionsdsl.ca> wrote:
> Stefan Lucke wrote:
> > Message log written to stderr and stdout would be interesting:
> > Are '+' chars written, when the resync happens ?
> >
> > ./vdr with_some_parameter >msg.log 2>&1
> >
> >
>

I haven't been able to get a long enough log yet, sorry, where the
resyncing is shown, however I do rememebr seeing '+' being written to
the console at regular intervals.
More than likely these are related, as there are no '+' characters
when using '-vo dfb:'

> I also suffer from this problem, and have for months using mgatv DFB.
> other output methods like just DFB are fine.  No logs  or stdoutput
> entries ever seem to be leading to the problem for me.
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/softdevice-devel
>


-- 
A l a s d a i r   C a m p b e l l

r a g a w u @ g m a i l . c o m


From ragawu at gmail.com  Thu Sep  7 22:48:18 2006
From: ragawu at gmail.com (Alasdair Campbell)
Date: Thu, 7 Sep 2006 21:48:18 +0100
Subject: [Softdevice-devel] dfb-out: square with different colours (Was:
	Re: g450 interlaced output)
In-Reply-To: <1849e5180609062005y7326332ct3c0e992952d4ee9@mail.gmail.com>
References: <200609060702.05976.stefan@lucke.in-berlin.de>
	<1849e5180609062005y7326332ct3c0e992952d4ee9@mail.gmail.com>
Message-ID: <1849e5180609071348le23d388jac44ad724821e44@mail.gmail.com>

On 07/09/06, Alasdair Campbell <ragawu at gmail.com> wrote:
> On 06/09/06, Stefan Lucke <stefan at lucke.in-berlin.de> wrote:
> > I know it's hard, but is it possible to make a screen shot from this ?
>
> I'll need to learn how to do that but as soon as I do, I'll stick one
> up for everyone to see.

Not figured out how to do a scren shot, but my description was all
wrong initally - I was far too tired. Infact, the small box is an
enlarged one character display of the flashing cursor. sometimes I see
it normal sized and white on black as usual. I've also seen 2 or 3
lines of text from DFB's output appearing.

These glitches are only visible when DFB outputs to the console,
usually after changing a channel. They vanish shortly after the OSD
hides.

Also, (this is something I have seen with the gentoo ebuilds and
unpatched DirectFb cvs) on the first head, along with the console off
center, I see three instances of the same video image, with the wrong
colours.

I don't know if this is simply a configuration error, I've attached
the config files / outputs I thought were relevant.

-- 
A l a s d a i r   C a m p b e l l

r a g a w u @ g m a i l . c o m
-------------- next part --------------
A non-text attachment was scrubbed...
Name: dfbinfo
Type: application/octet-stream
Size: 1106 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060907/d202262b/attachment.obj>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: fb0-fbset-info
Type: application/octet-stream
Size: 527 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060907/d202262b/attachment-0001.obj>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: fb1-fbset-info
Type: application/octet-stream
Size: 503 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060907/d202262b/attachment-0002.obj>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: directfbrc
Type: application/octet-stream
Size: 138 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060907/d202262b/attachment-0003.obj>

From ragawu at gmail.com  Thu Sep  7 22:51:52 2006
From: ragawu at gmail.com (Alasdair Campbell)
Date: Thu, 7 Sep 2006 21:51:52 +0100
Subject: [Softdevice-devel] dfb-out: square with different colours (Was:
	Re: g450 interlaced output)
In-Reply-To: <1849e5180609071348le23d388jac44ad724821e44@mail.gmail.com>
References: <200609060702.05976.stefan@lucke.in-berlin.de>
	<1849e5180609062005y7326332ct3c0e992952d4ee9@mail.gmail.com>
	<1849e5180609071348le23d388jac44ad724821e44@mail.gmail.com>
Message-ID: <1849e5180609071351t114ee4e0o832d437f5590a10d@mail.gmail.com>

Forgot to stress that these lines of text and cursors only apppear
using dfb mgatv

-- 
A l a s d a i r   C a m p b e l l

r a g a w u @ g m a i l . c o m


From stefan at lucke.in-berlin.de  Thu Sep  7 23:30:32 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 7 Sep 2006 23:30:32 +0200
Subject: [Softdevice-devel] dfb-out: square with different colours
In-Reply-To: <1849e5180609071348le23d388jac44ad724821e44@mail.gmail.com>
References: <200609060702.05976.stefan@lucke.in-berlin.de>
	<1849e5180609062005y7326332ct3c0e992952d4ee9@mail.gmail.com>
	<1849e5180609071348le23d388jac44ad724821e44@mail.gmail.com>
Message-ID: <200609072330.32408.stefan@lucke.in-berlin.de>

On Donnerstag 07 September 2006 22:48, Alasdair Campbell wrote:
> On 07/09/06, Alasdair Campbell <ragawu at gmail.com> wrote:
> > On 06/09/06, Stefan Lucke <stefan at lucke.in-berlin.de> wrote:
> > > I know it's hard, but is it possible to make a screen shot from this ?
> >
> > I'll need to learn how to do that but as soon as I do, I'll stick one
> > up for everyone to see.
> 
> Not figured out how to do a scren shot, but my description was all
> wrong initally - I was far too tired. Infact, the small box is an
> enlarged one character display of the flashing cursor. sometimes I see
> it normal sized and white on black as usual. I've also seen 2 or 3
> lines of text from DFB's output appearing.
> 
> These glitches are only visible when DFB outputs to the console,
> usually after changing a channel. They vanish shortly after the OSD
> hides.

You are using the no-vt* options in your directfbrc. A good way to avoid
any interruptions from text written you should redirect stdout and stderr
to a log file  vdr_call >vdr_log 2>&1.

For hiding cursor etc.. I once suggested the following which may be
useful for vidix users too:

-- snip --
# setup logfile name
LOGFILE=/var/log/my_vdr_logfile
#
# save prompt mode, hide prompt and switch cursor off
PSSAVE=${PS1}
export PS1=''
setterm -cursor off
#
# deactivate powersaving mode and clear screen
setterm -powersave off
clear
#
# start vdr
vdr WITH_DESIRED_PARAMETERS  >${LOGFILE} 2>&1
# restore settings
export PS1=${PSSAVE}
setterm -default
-- snip --

> 
> Also, (this is something I have seen with the gentoo ebuilds and
> unpatched DirectFb cvs) on the first head, along with the console off
> center, I see three instances of the same video image, with the wrong
> colours.
> 
> I don't know if this is simply a configuration error, I've attached
> the config files / outputs I thought were relevant.
> 


-- 
Stefan Lucke


From marko.makela at hut.fi  Thu Sep  7 23:33:51 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 8 Sep 2006 00:33:51 +0300
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <200609070655.36505.stefan@lucke.in-berlin.de>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<20060906204417.GA2844@localhost.localdomain>
	<20060906211813.GB2844@localhost.localdomain>
	<200609070655.36505.stefan@lucke.in-berlin.de>
Message-ID: <20060907213350.GA2875@localhost.localdomain>

On Thu, Sep 07, 2006 at 06:55:36AM +0200, Stefan Lucke wrote:
> Could you check your logs to see if there is an even/odd combination
> of source and destination yoffset ? 

When viewing that BBC News clip at CropMode 14:9, it shows

src (44,0 632x576)
dst (0,41 720x494)

when I enabled the fprintf calls in cDFBVideoOut::YUV().

All other CropModes look fine, and both the source and destination yoffsets
are even in all of them.

So, I think that your guess is correct.  Truncating the destination
yoffset to an even number seems to do the trick on the three 16:9 clips
I tested:

diff -p -u -r1.62 video.c
--- video.c     4 Sep 2006 20:29:54 -0000       1.62
+++ video.c     7 Sep 2006 21:30:39 -0000
@@ -266,7 +266,7 @@ void cVideoOut::AdjustToDisplayGeometry(
    * center result on display
    */
   lxoff = (dwidth - lwidth) / 2;
-  lyoff = (dheight - lheight) / 2;
+  lyoff = ((dheight - lheight) / 2) & ~1;
 }

 /* ---------------------------------------------------------------------------

Please document the reason for this in the source code, and consider making
it conditional (only on mgatv output).

By the way, what is the 14:9 crop mode good for?  For viewing 3:2
photographs?  We only seem to get 4:3 and 16:9 programs.

	Marko


From ragawu at gmail.com  Thu Sep  7 23:41:11 2006
From: ragawu at gmail.com (Alasdair Campbell)
Date: Thu, 7 Sep 2006 22:41:11 +0100
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <20060907213350.GA2875@localhost.localdomain>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<20060906204417.GA2844@localhost.localdomain>
	<20060906211813.GB2844@localhost.localdomain>
	<200609070655.36505.stefan@lucke.in-berlin.de>
	<20060907213350.GA2875@localhost.localdomain>
Message-ID: <1849e5180609071441o5340e3e4j1275ff5cbc96269a@mail.gmail.com>

On 07/09/06, Marko M?kel? <marko.makela at hut.fi> wrote:
> By the way, what is the 14:9 crop mode good for?  For viewing 3:2
> photographs?  We only seem to get 4:3 and 16:9 programs.

As an aside to this aside, I wanted to point out that the interlacing
artifacts still show up when I set aspect to 5:4, I read somewhere
that a tv's aspect ratio is 5:4 rather than a montiors 4:3.

Is that right and is getting the great results with the DFB patch for
4:3 likely to be achieveable with 5:4?


A l a s d a i r   C a m p b e l l

r a g a w u @ g m a i l . c o m


From stefan at lucke.in-berlin.de  Thu Sep  7 23:43:33 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 7 Sep 2006 23:43:33 +0200
Subject: [Softdevice-devel] dfb-out audio sync (Was: Re: g450 interlaced
	output)
In-Reply-To: <1849e5180609071335y6dd72d9bh5fcfcc1f6632e156@mail.gmail.com>
References: <200609060711.48160.stefan@lucke.in-berlin.de>
	<45005F9E.6030706@optionsdsl.ca>
	<1849e5180609071335y6dd72d9bh5fcfcc1f6632e156@mail.gmail.com>
Message-ID: <200609072343.33606.stefan@lucke.in-berlin.de>

On Donnerstag 07 September 2006 22:35, Alasdair Campbell wrote:
> On 07/09/06, Dave <dave at optionsdsl.ca> wrote:
> > Stefan Lucke wrote:
> > > Message log written to stderr and stdout would be interesting:
> > > Are '+' chars written, when the resync happens ?
> > >
> > > ./vdr with_some_parameter >msg.log 2>&1
> > >
> > >
> >
> 
> I haven't been able to get a long enough log yet, sorry, where the
> resyncing is shown, however I do rememebr seeing '+' being written to
> the console at regular intervals.

45 secs as mentioned in your initiating mail ?
What is the the reported frame time in microseconds reported at startup ?

Mine is about 19969 microseconds, which is slightly higher than field duration.

> More than likely these are related, as there are no '+' characters
> when using '-vo dfb:'
> 
> > I also suffer from this problem, and have for months using mgatv DFB.
> > other output methods like just DFB are fine.  No logs  or stdoutput
> > entries ever seem to be leading to the problem for me.


-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Thu Sep  7 23:48:01 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 7 Sep 2006 23:48:01 +0200
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <20060907213350.GA2875@localhost.localdomain>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<200609070655.36505.stefan@lucke.in-berlin.de>
	<20060907213350.GA2875@localhost.localdomain>
Message-ID: <200609072348.01998.stefan@lucke.in-berlin.de>

On Donnerstag 07 September 2006 23:33, Marko M?kel? wrote:
> On Thu, Sep 07, 2006 at 06:55:36AM +0200, Stefan Lucke wrote:
> > Could you check your logs to see if there is an even/odd combination
> > of source and destination yoffset ? 
> 
> When viewing that BBC News clip at CropMode 14:9, it shows
> 
> src (44,0 632x576)
> dst (0,41 720x494)
> 
> when I enabled the fprintf calls in cDFBVideoOut::YUV().
> 
> All other CropModes look fine, and both the source and destination yoffsets
> are even in all of them.
> 
> So, I think that your guess is correct.  Truncating the destination
> yoffset to an even number seems to do the trick on the three 16:9 clips
> I tested:
> 
> diff -p -u -r1.62 video.c
> --- video.c     4 Sep 2006 20:29:54 -0000       1.62
> +++ video.c     7 Sep 2006 21:30:39 -0000
> @@ -266,7 +266,7 @@ void cVideoOut::AdjustToDisplayGeometry(
>     * center result on display
>     */
>    lxoff = (dwidth - lwidth) / 2;
> -  lyoff = (dheight - lheight) / 2;
> +  lyoff = ((dheight - lheight) / 2) & ~1;
>  }
> 
>  /* ---------------------------------------------------------------------------
> 
> Please document the reason for this in the source code, and consider making
> it conditional (only on mgatv output).

It should be done allways, even for lxoff because in YV12 luma is used for
2 horizontal and 2 vertical pixels. Maybe this is causing troubles for other cards
like nVidia too !

> 
> By the way, what is the 14:9 crop mode good for?  For viewing 3:2
> photographs?  We only seem to get 4:3 and 16:9 programs.
> 


-- 
Stefan Lucke


From marko.makela at hut.fi  Thu Sep  7 23:55:11 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 8 Sep 2006 00:55:11 +0300
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <1849e5180609071441o5340e3e4j1275ff5cbc96269a@mail.gmail.com>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<20060906204417.GA2844@localhost.localdomain>
	<20060906211813.GB2844@localhost.localdomain>
	<200609070655.36505.stefan@lucke.in-berlin.de>
	<20060907213350.GA2875@localhost.localdomain>
	<1849e5180609071441o5340e3e4j1275ff5cbc96269a@mail.gmail.com>
Message-ID: <20060907215511.GC2875@localhost.localdomain>

On Thu, Sep 07, 2006 at 10:41:11PM +0100, Alasdair Campbell wrote:
> On 07/09/06, Marko M?kel? <marko.makela at hut.fi> wrote:
> > By the way, what is the 14:9 crop mode good for?  For viewing 3:2
> > photographs?  We only seem to get 4:3 and 16:9 programs.
> 
> As an aside to this aside, I wanted to point out that the interlacing
> artifacts still show up when I set aspect to 5:4, I read somewhere
> that a tv's aspect ratio is 5:4 rather than a montiors 4:3.

True, the pixels are not square.  The aspect "default" seems identical to 5:4.

> Is that right and is getting the great results with the DFB patch for
> 4:3 likely to be achieveable with 5:4?

It seems so, with Stefan's DFB patch and my fresh video.c patch.
Stefan's right: also lxoff needs to be truncated: otherwise the
changing headline "BUSINESS", "SPORT" in your BBC News clip will
look bad on 5:4.  Especially the "O" character of "SPORT" displays
some Moir?-like pattern when lxoff is not truncated like this:

diff -p -u -r1.62 video.c
--- video.c     4 Sep 2006 20:29:54 -0000       1.62
+++ video.c     7 Sep 2006 21:54:11 -0000
@@ -265,8 +265,8 @@ void cVideoOut::AdjustToDisplayGeometry(
   /* -------------------------------------------------------------------------
    * center result on display
    */
-  lxoff = (dwidth - lwidth) / 2;
-  lyoff = (dheight - lheight) / 2;
+  lxoff = ((dwidth - lwidth) / 2) & ~1;
+  lyoff = ((dheight - lheight) / 2) & ~1;
 }

 /* ---------------------------------------------------------------------------

	Marko


From stefan at lucke.in-berlin.de  Thu Sep  7 23:58:43 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 7 Sep 2006 23:58:43 +0200
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <1849e5180609071441o5340e3e4j1275ff5cbc96269a@mail.gmail.com>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<20060907213350.GA2875@localhost.localdomain>
	<1849e5180609071441o5340e3e4j1275ff5cbc96269a@mail.gmail.com>
Message-ID: <200609072358.43812.stefan@lucke.in-berlin.de>

On Donnerstag 07 September 2006 23:41, Alasdair Campbell wrote:
> On 07/09/06, Marko M?kel? <marko.makela at hut.fi> wrote:
> > By the way, what is the 14:9 crop mode good for?  For viewing 3:2
> > photographs?  We only seem to get 4:3 and 16:9 programs.

14:9 is one of the modes which are signalled via AFD values.

> 
> As an aside to this aside, I wanted to point out that the interlacing
> artifacts still show up when I set aspect to 5:4, I read somewhere
> that a tv's aspect ratio is 5:4 rather than a montiors 4:3.

No TV aspect is 4:3 and for TV out this value has to be choosen.
Transmitted pixels are not transmitted as square pixels and for reason
the we don't do scaling the display aspect of the output device has
to be set manual. 720x576 from source video should be displayed
1:1 on TV-out within given 720x576 output area.

> 
> Is that right and is getting the great results with the DFB patch for
> 4:3 likely to be achieveable with 5:4?


-- 
Stefan Lucke


From omge2ri02 at sneakemail.com  Fri Sep  8 01:05:58 2006
From: omge2ri02 at sneakemail.com (CR)
Date: Thu, 7 Sep 2006 16:05:58 -0700 (MST)
Subject: [Softdevice-devel] New OSD method for X/Xv proposed
In-Reply-To: <mailman.8118.1157664658.22248.softdevice-devel@lists.berlios.de>
References: <mailman.8118.1157664658.22248.softdevice-devel@lists.berlios.de>
Message-ID: <15005-60471@sneakemail.com>

Hi,

An nVidia Linux engineer has suggested for HW accelerated OSD this method
(while they consider adding ARGB to Xv port):

"

1. Create a child window of your video window.
2. Redirect it.
3. Draw to it using Xv.
4. Blend your OSD onto it using the RENDER extension.
5. XCopyArea (or RENDER Composite with PictOpSrc) the pixmap contents into
your video window using IncludeInferiors mode (so it's not clipped by the
redirected child window).

"

Long-term OpenGL is probably better solution, but right now this seems
tangible.  Is this even remotely interesting to anyone to work on?  I
think latest ATI/nVidia drivers support XRender/XComposite, etc.

CR.


From stefan at lucke.in-berlin.de  Fri Sep  8 07:06:40 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 8 Sep 2006 07:06:40 +0200
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <20060907215511.GC2875@localhost.localdomain>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<1849e5180609071441o5340e3e4j1275ff5cbc96269a@mail.gmail.com>
	<20060907215511.GC2875@localhost.localdomain>
Message-ID: <200609080706.40628.stefan@lucke.in-berlin.de>

On Donnerstag 07 September 2006 23:55, Marko M?kel? wrote:
> On Thu, Sep 07, 2006 at 10:41:11PM +0100, Alasdair Campbell wrote:
> > On 07/09/06, Marko M?kel? <marko.makela at hut.fi> wrote:
> > > By the way, what is the 14:9 crop mode good for?  For viewing 3:2
> > > photographs?  We only seem to get 4:3 and 16:9 programs.
> > 
> > As an aside to this aside, I wanted to point out that the interlacing
> > artifacts still show up when I set aspect to 5:4, I read somewhere
> > that a tv's aspect ratio is 5:4 rather than a montiors 4:3.
> 
> True, the pixels are not square.  The aspect "default" seems identical to 5:4.
> 
> > Is that right and is getting the great results with the DFB patch for
> > 4:3 likely to be achieveable with 5:4?
> 
> It seems so, with Stefan's DFB patch and my fresh video.c patch.
> Stefan's right: also lxoff needs to be truncated: otherwise the
> changing headline "BUSINESS", "SPORT" in your BBC News clip will
> look bad on 5:4.  Especially the "O" character of "SPORT" displays
> some Moir?-like pattern when lxoff is not truncated like this:
> 
> diff -p -u -r1.62 video.c
> --- video.c     4 Sep 2006 20:29:54 -0000       1.62
> +++ video.c     7 Sep 2006 21:54:11 -0000
> @@ -265,8 +265,8 @@ void cVideoOut::AdjustToDisplayGeometry(
>    /* -------------------------------------------------------------------------
>     * center result on display
>     */
> -  lxoff = (dwidth - lwidth) / 2;
> -  lyoff = (dheight - lheight) / 2;
> +  lxoff = ((dwidth - lwidth) / 2) & ~1;
> +  lyoff = ((dheight - lheight) / 2) & ~1;
>  }
> 

In cvs now.

-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Fri Sep  8 07:06:47 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 8 Sep 2006 07:06:47 +0200
Subject: [Softdevice-devel] nVidia hardware alpha blending for OSD
In-Reply-To: <30885-36724@sneakemail.com>
References: <30885-36724@sneakemail.com>
Message-ID: <200609080706.47174.stefan@lucke.in-berlin.de>

On Mittwoch 30 August 2006 11:56, CR wrote:
> Hi all,
> 
> Some of you on the VDR mailing list may have seen me struggling to get
> softdevice's OSD to work without odd artifacts.

Can you try current cvs ?
Could be that limiting destination x/y offsets to even values may have some
influence on nvidia cards too.


-- 
Stefan Lucke


From lists at conealley.net  Fri Sep  8 10:10:47 2006
From: lists at conealley.net (Kim Fredenberg)
Date: Fri, 08 Sep 2006 11:10:47 +0300
Subject: [Softdevice-devel] libcle266mpegdec-0.3 - SOLVED
In-Reply-To: <Pine.OSF.4.61.0609070933530.494556@kosh.hut.fi>
References: <Pine.OSF.4.61.0609052359330.298366@kosh.hut.fi>	<44FE8281.4080109@conealley.net>
	<Pine.OSF.4.61.0609070933530.494556@kosh.hut.fi>
Message-ID: <45012587.7080800@conealley.net>

Rolf Ahrenberg wrote:
> On Wed, 6 Sep 2006, Kim Fredenberg wrote:
> 
> 
>>I tried out 0.3 but I seem to have some problems with it. The output
>>from the 0.3 version is distorted (huge amount of pixelation) on some clips.
>>With 0.2 the same code and the same clips are working fine.

I had a discussion with Mark Adams and we found the problem. It was not
caused by the lib but by my app. I had made a bad assumption which
revealed itself by the change in the CLE266MPEGDecodeData function in 0.3.

Funnily enough some clips had such packeting that they worked while
others did not.

Kim


From stuart_morris at talk21.com  Fri Sep  8 13:11:18 2006
From: stuart_morris at talk21.com (Stuart Morris)
Date: Fri, 8 Sep 2006 12:11:18 +0100 (BST)
Subject: [Softdevice-devel] g450 interlaced output
Message-ID: <20060908111118.45550.qmail@web86310.mail.ird.yahoo.com>

I have recently tried Softdevice output with mgatv on a g450 and can confirm that
the combination below gives a stable OSD and clear background above and
below the letterbox for widescreen material.

Kernel 2.6.12 (Mandriva2006 distro)
ffmpeg 0.4.9pre1 (Mandriva2006 rpm dated 2005-09-07)
VDR 1.4.1
Directfb cvs with patch from Stefan Lucke Tue, 05 Sep
Softdevice cvs

Interlaced output to composite TV works perfectly for the few channels I have
viewed so far.

I have however noticed a few problems:

I am getting 60% cpu usage on a Duron900 however video frames are being
dropped. Video 'jumps' occur aproximately every 10-20seconds. I have tried using
a multimedia kernel and vdr running at nice -5 but I noticed only a small
improvement.

If I exit from vdr and then run vdr with softdevice for a second time, the system
appears to lock up with no tv or monitor output, forcing a system reboot.
It seems I can run softdevice only once before having to reboot the system.

If I run vdr with softdevice and the text2skin plugin I can get no TV output at all.
I know the text2skin plugin works ok with my dxr3 setup.

Softdevice can only work with VDR run with root privelages. Is this correct?


 		
---------------------------------
 Try the all-new Yahoo! Mail . "The New Version is radically easier to use" ? The Wall Street Journal
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060908/2dfae9f7/attachment.html>

From chris at shagged.org  Fri Sep  8 15:59:53 2006
From: chris at shagged.org (Chris Elsworth)
Date: Fri, 8 Sep 2006 14:59:53 +0100
Subject: [Softdevice-devel] nVidia hardware alpha blending for OSD
In-Reply-To: <200609080706.47174.stefan@lucke.in-berlin.de>
References: <30885-36724@sneakemail.com>
	<200609080706.47174.stefan@lucke.in-berlin.de>
Message-ID: <20060908135953.GA421@spork.qfe3.net>

On Fri, Sep 08, 2006 at 07:06:47AM +0200, Stefan Lucke wrote:
> On Mittwoch 30 August 2006 11:56, CR wrote:
> > Hi all,
> > 
> > Some of you on the VDR mailing list may have seen me struggling to get
> > softdevice's OSD to work without odd artifacts.
> 
> Can you try current cvs ?
> Could be that limiting destination x/y offsets to even values may have some
> influence on nvidia cards too.

Hello,

I haven't got much information to hand at the moment but current CVS
breaks here; this is a pretty useless bug report I'm afraid, there's
no diagnostic information given:

[softdevice] processing args
[softdevice]   argv [0] = softdevice
[softdevice]   argv [1] = -vo
vo_argv: xv:aspect=wide:max-area:full
[ProcessArgs] xv: startup aspect ratio set to wide (16:9)
[ProcessArgs] xv: using max available area
[ProcessArgs] xv: start up fullscreen
[setup-softdevice] alsa ac3Mode set to: 1
[setup-softdevice] alsa AC3 device set to: hw:0,1
[setup-softdevice] alsa device set to: default
[setup-softdevice] A/V Offset set to (80)
[setup-softdevice] Cropping 0 lines from bottom
[setup-softdevice] Cropping 0 columns from left
[setup-softdevice] cropping mode set to 0 (none)
[setup-softdevice] cropping mode toggle key set to 0 (none)
[setup-softdevice] Cropping 0 columns from right
[setup-softdevice] Cropping 0 lines from top
[setup-softdevice] deinterlace method set to 0 none
[setup-softdevice] mainMenu: 0
[setup-softdevice] setting alpha blend mode to software
[softdevice] picture mirroring set to 0 (off)
[setup-softdevice] pixel format set to (I420)
[setup-softdevice] shouldSuspend to: 0
[setup-softdevice] syncTimerMode: sig
[softdevice] UseStretchBlitset to off
[setup-softdevice] vidBrightness: 50
[setup-softdevice] vidContrast: 50
[setup-softdevice] vidHue: 100
[setup-softdevice] vidSaturation: 50
[setup-softdevice] startup aspect set to (16:9 wide)
[softdevice] initializing Plugin
[softdevice] Initializing Video Out
[softdevice] ffmpeg build(3345152)
[XvVideoOut]: osd_image shmid = 9601025
[XvVideoOut]: got osd_image: width 1024 height 768, bytes per line 4096
[softdevice] Xv out failure !

And vdr quits, no further errors. Pity I didn't keep the sources from
the last cvs checkout I had, but it was around a
month/month-and-a-half old. I just did cvs up and make all, then
copied the new lib into place.

-- 
Chris


From M.Wache at gmx.net  Fri Sep  8 17:14:26 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Fri, 08 Sep 2006 17:14:26 +0200
Subject: [Softdevice-devel] nVidia hardware alpha blending for OSD
In-Reply-To: <20060908135953.GA421@spork.qfe3.net>
References: <30885-36724@sneakemail.com>	<200609080706.47174.stefan@lucke.in-berlin.de>
	<20060908135953.GA421@spork.qfe3.net>
Message-ID: <450188D2.4090206@gmx.net>

Chris Elsworth schrieb:
> On Fri, Sep 08, 2006 at 07:06:47AM +0200, Stefan Lucke wrote:
>   
>> On Mittwoch 30 August 2006 11:56, CR wrote:
>>     
>>> Hi all,
>>>
>>> Some of you on the VDR mailing list may have seen me struggling to get
>>> softdevice's OSD to work without odd artifacts.
>>>       
>> Can you try current cvs ?
>> Could be that limiting destination x/y offsets to even values may have some
>> influence on nvidia cards too.
>>     
>
> Hello,
>
> I haven't got much information to hand at the moment but current CVS
> breaks here; this is a pretty useless bug report I'm afraid, there's
> no diagnostic information given:
>
>   
Did you check the syslog for further information?

Bye,

Martin


From chris at shagged.org  Fri Sep  8 17:43:00 2006
From: chris at shagged.org (Chris Elsworth)
Date: Fri, 8 Sep 2006 16:43:00 +0100
Subject: [Softdevice-devel] nVidia hardware alpha blending for OSD
In-Reply-To: <450188D2.4090206@gmx.net>
References: <30885-36724@sneakemail.com>
	<200609080706.47174.stefan@lucke.in-berlin.de>
	<20060908135953.GA421@spork.qfe3.net> <450188D2.4090206@gmx.net>
Message-ID: <20060908154300.GA3168@spork.qfe3.net>

On Fri, Sep 08, 2006 at 05:14:26PM +0200, Martin Wache wrote:
> Chris Elsworth schrieb:
> >
> > I haven't got much information to hand at the moment but current CVS
> > breaks here; this is a pretty useless bug report I'm afraid, there's
> > no diagnostic information given:
> >
> >   
> Did you check the syslog for further information?

Hello,

Here's syslog output with -l 3:

Sep  8 16:42:10 media vdr: [12919] initializing plugin: softdevice (0.2.3): A software emulated MPEG2 device
Sep  8 16:42:10 media vdr: [12919] [XvVideoOut]: patch version (2006-04-24)
Sep  8 16:42:10 media vdr: [12919] [XvVideoOut]: Initialize XShmCreateImage Successful (0x2aaaab47de40)
Sep  8 16:42:10 media vdr: [12919] [XvVideoOut]: Initialize shmget Successful (2359296 bytes)
Sep  8 16:42:10 media vdr: [12919] [XvVideoOut]: Initialize shmat Successful
Sep  8 16:42:10 media vdr: [12919] [softdevice-xscreensaver]: xscreensaver not running
Sep  8 16:42:10 media vdr: [12919] [XvVideoOut]: initialized OK
Sep  8 16:42:10 media vdr: [12929] tuner on device 3 thread started (pid=12919, tid=12929)
Sep  8 16:42:10 media vdr: [12930] section handler thread started (pid=12919, tid=12930)
Sep  8 16:42:10 media vdr: [12919] [softdevice-xscreensaver]: disabling DPMS
Sep  8 16:42:10 media vdr: [12919] [softdevice-xscreensaver]: disabling DPMS stat: 1

And then vdr exits with exit code 1. (from echo $?)


-- 
Chris


From M.Wache at gmx.net  Fri Sep  8 18:01:36 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Fri, 08 Sep 2006 18:01:36 +0200
Subject: [Softdevice-devel] nVidia hardware alpha blending for OSD
In-Reply-To: <20060908154300.GA3168@spork.qfe3.net>
References: <30885-36724@sneakemail.com>	<200609080706.47174.stefan@lucke.in-berlin.de>	<20060908135953.GA421@spork.qfe3.net>
	<450188D2.4090206@gmx.net> <20060908154300.GA3168@spork.qfe3.net>
Message-ID: <450193E0.1050400@gmx.net>

Chris Elsworth schrieb:
> On Fri, Sep 08, 2006 at 05:14:26PM +0200, Martin Wache wrote:
>> Chris Elsworth schrieb:
>>> I haven't got much information to hand at the moment but current CVS
>>> breaks here; this is a pretty useless bug report I'm afraid, there's
>>> no diagnostic information given:
>>>
>>>   
>> Did you check the syslog for further information?
> 
> Hello,
> 
> Here's syslog output with -l 3:
>

This is very strange:


> Sep  8 16:42:10 media vdr: [12919] [XvVideoOut]: initialized OK

This line comes from video-xv.c line 1053 in the method Initialize().
After that line the method _cannot_ return false. But as you posted before:

> [softdevice] Xv out failure !

which belongs to softdevice.c line 252. This line can only be reached if
Initialize() returns false.

Or did I miss anything?

Are you sure that you properly recompiled the softdevice? Do those two
logs really belong together?
You can also try to go back in the CVS using the -D switch of cvs.
Interessting dates can be found in the CHANGELOG. Please do a "make
clean" in the softdevice directory, if you do this. Just to be sure...

Bye,
Martin


From laz at club-burniston.co.uk  Fri Sep  8 18:06:02 2006
From: laz at club-burniston.co.uk (Laz)
Date: Fri, 8 Sep 2006 17:06:02 +0100
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <44FFF15E.5050805@users.sourceforge.net>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<200609071103.41098.laz@club-burniston.co.uk>
	<44FFF15E.5050805@users.sourceforge.net>
Message-ID: <200609081706.02500.laz@club-burniston.co.uk>

On Thursday 07 September 2006 11:15, Lucian Muresan wrote:
> Laz wrote:
> [..]
>
> > I've been vaguely following this but haven't had a chance to test the
> > mga output for a while!
> >
> > Is the OSD still broken for mga output? I ended up backtracking to
> > about February CVS a while back to get my OSD working again!
>
> DirectFB-CVS + Stefan's patch, together with softdevice-CVS works well
> now on my G400 TV-out (including OSD), I use Gentoo live CVS ebuilds
> for DirectFB and softdevice and I pulled them the day Stefan announced
> his fix. The video seems a bit softer than before, or compared to my
> domestic STB, and I too noticed some A/V sync issues, but I think
> they're not that bad to make the system unusable. I have to admit, I
> had very few time lately to use VDR intensively.

Have the patches for interlaced blitting made it into DirectFB CVS yet or 
do they still need to be added by hand? I'm trying to work out whether I 
will get time to test this this weekend or not!

:-)

Cheers,

Laz


From stefan at lucke.in-berlin.de  Fri Sep  8 18:11:50 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri,  8 Sep 2006 18:11:50 +0200
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <200609081706.02500.laz@club-burniston.co.uk>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<200609071103.41098.laz@club-burniston.co.uk>
	<44FFF15E.5050805@users.sourceforge.net>
	<200609081706.02500.laz@club-burniston.co.uk>
Message-ID: <1157731910.450196465eb5e@webmail.in-berlin.de>

Quoting Laz:

> On Thursday 07 September 2006 11:15, Lucian Muresan wrote:
> > Laz wrote:
> > [..]
> >
> > > I've been vaguely following this but haven't had a chance to test the
> > > mga output for a while!
> > >
> > > Is the OSD still broken for mga output? I ended up backtracking to
> > > about February CVS a while back to get my OSD working again!
> >
> > DirectFB-CVS + Stefan's patch, together with softdevice-CVS works well
> > now on my G400 TV-out (including OSD), I use Gentoo live CVS ebuilds
> > for DirectFB and softdevice and I pulled them the day Stefan announced
> > his fix. The video seems a bit softer than before, or compared to my
> > domestic STB, and I too noticed some A/V sync issues, but I think
> > they're not that bad to make the system unusable. I have to admit, I
> > had very few time lately to use VDR intensively.
>
> Have the patches for interlaced blitting made it into DirectFB CVS yet or
> do they still need to be added by hand? I'm trying to work out whether I
> will get time to test this this weekend or not!

Havn't got feedback from Ville on directfb-devel list.
So you must add them by hand.

Stefan


From stefan at lucke.in-berlin.de  Fri Sep  8 18:19:06 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri,  8 Sep 2006 18:19:06 +0200
Subject: [Softdevice-devel] nVidia hardware alpha blending for OSD
In-Reply-To: <450193E0.1050400@gmx.net>
References: <30885-36724@sneakemail.com>
	<200609080706.47174.stefan@lucke.in-berlin.de>
	<20060908135953.GA421@spork.qfe3.net> <450188D2.4090206@gmx.net>
	<20060908154300.GA3168@spork.qfe3.net> <450193E0.1050400@gmx.net>
Message-ID: <1157732346.450197facea92@webmail.in-berlin.de>

Quoting Martin Wache <M.Wache at gmx.net>:

> Chris Elsworth schrieb:
> > On Fri, Sep 08, 2006 at 05:14:26PM +0200, Martin Wache wrote:
> >> Chris Elsworth schrieb:
> >>> I haven't got much information to hand at the moment but current CVS
> >>> breaks here; this is a pretty useless bug report I'm afraid, there's
> >>> no diagnostic information given:
> >>>
> >>>
> >> Did you check the syslog for further information?
> >
> > Hello,
> >
> > Here's syslog output with -l 3:
> >
>
> This is very strange:
>
>
> > Sep  8 16:42:10 media vdr: [12919] [XvVideoOut]: initialized OK
>
> This line comes from video-xv.c line 1053 in the method Initialize().
> After that line the method _cannot_ return false. But as you posted before:
>
> > [softdevice] Xv out failure !
>
> which belongs to softdevice.c line 252. This line can only be reached if
> Initialize() returns false.
>
> Or did I miss anything?

The combination of these two messages should be impossible.
But sometimes after cvs update I get strange results too.
Looks like there is a dependency which is not caught.

In this situation only 'make clean' helps.

>
> Are you sure that you properly recompiled the softdevice? Do those two
> logs really belong together?
> You can also try to go back in the CVS using the -D switch of cvs.
> Interessting dates can be found in the CHANGELOG. Please do a "make
> clean" in the softdevice directory, if you do this. Just to be sure...
>

Stefan



From chris at shagged.org  Fri Sep  8 18:43:30 2006
From: chris at shagged.org (Chris Elsworth)
Date: Fri, 8 Sep 2006 17:43:30 +0100
Subject: [Softdevice-devel] nVidia hardware alpha blending for OSD
In-Reply-To: <450193E0.1050400@gmx.net>
References: <30885-36724@sneakemail.com>
	<200609080706.47174.stefan@lucke.in-berlin.de>
	<20060908135953.GA421@spork.qfe3.net> <450188D2.4090206@gmx.net>
	<20060908154300.GA3168@spork.qfe3.net> <450193E0.1050400@gmx.net>
Message-ID: <20060908164330.GA4273@spork.qfe3.net>

On Fri, Sep 08, 2006 at 06:01:36PM +0200, Martin Wache wrote:
> Chris Elsworth schrieb:
> > On Fri, Sep 08, 2006 at 05:14:26PM +0200, Martin Wache wrote:
> >> Chris Elsworth schrieb:
> >>> I haven't got much information to hand at the moment but current CVS
> >>> breaks here; this is a pretty useless bug report I'm afraid, there's
> >>> no diagnostic information given:
> >>>
> >>>   
> >> Did you check the syslog for further information?
> > 
> > Hello,
> > 
> > Here's syslog output with -l 3:
> >
> 
> This is very strange:
> 
> 
> > Sep  8 16:42:10 media vdr: [12919] [XvVideoOut]: initialized OK
> 
> This line comes from video-xv.c line 1053 in the method Initialize().
> After that line the method _cannot_ return false. But as you posted before:
> 
> > [softdevice] Xv out failure !
> 
> which belongs to softdevice.c line 252. This line can only be reached if
> Initialize() returns false.
> 
> Or did I miss anything?
> 
> Are you sure that you properly recompiled the softdevice? Do those two
> logs really belong together?
> You can also try to go back in the CVS using the -D switch of cvs.
> Interessting dates can be found in the CHANGELOG. Please do a "make
> clean" in the softdevice directory, if you do this. Just to be sure...

Okay some progress :)

root at media:~/vdr-1.4.0/PLUGINS/src/softdevice# cvs up -D 2006-09-04
root at media:~/vdr-1.4.0/PLUGINS/src/softdevice# make clean all
root at media:~/vdr-1.4.0/PLUGINS/src/softdevice# cp libvdr-softdevice.so /usr/lib/vdr/plugins/libvdr-softdevice.so.1.4.0

This broke in the same way

root at media:~/vdr-1.4.0/PLUGINS/src/softdevice# cvs up -D 2006-08-05
root at media:~/vdr-1.4.0/PLUGINS/src/softdevice# make clean all
root at media:~/vdr-1.4.0/PLUGINS/src/softdevice# !cp
cp libvdr-softdevice.so /usr/lib/vdr/plugins/libvdr-softdevice.so.1.4.0

This worked.
So the breaking change is somewhere between those two dates.
I will examine diffs to see if I can find the exact change that causes
it

-- 
Chris


From stefan at lucke.in-berlin.de  Fri Sep  8 18:56:08 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 8 Sep 2006 18:56:08 +0200
Subject: [Softdevice-devel] nVidia hardware alpha blending for OSD
In-Reply-To: <20060908164330.GA4273@spork.qfe3.net>
References: <30885-36724@sneakemail.com> <450193E0.1050400@gmx.net>
	<20060908164330.GA4273@spork.qfe3.net>
Message-ID: <200609081856.08834.stefan@lucke.in-berlin.de>

On Freitag 08 September 2006 18:43, Chris Elsworth wrote:
> On Fri, Sep 08, 2006 at 06:01:36PM +0200, Martin Wache wrote:
> > Chris Elsworth schrieb:
> > > On Fri, Sep 08, 2006 at 05:14:26PM +0200, Martin Wache wrote:
> > >> Chris Elsworth schrieb:
> > >>> I haven't got much information to hand at the moment but current CVS
> > >>> breaks here; this is a pretty useless bug report I'm afraid, there's
> > >>> no diagnostic information given:
> > >>>
> > >>>   
> > >> Did you check the syslog for further information?
> > > 
> > > Hello,
> > > 
> > > Here's syslog output with -l 3:
> > >
> > 
> > This is very strange:
> > 
> > 
> > > Sep  8 16:42:10 media vdr: [12919] [XvVideoOut]: initialized OK
> > 
> > This line comes from video-xv.c line 1053 in the method Initialize().
> > After that line the method _cannot_ return false. But as you posted before:
> > 
> > > [softdevice] Xv out failure !

Ups. Did a "./configure --disable-subplugins" and got the same result :-( .
Dropping this option, working with subplugins, made it work again ;-) .

-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Fri Sep  8 19:06:07 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 8 Sep 2006 19:06:07 +0200
Subject: [Softdevice-devel] nVidia hardware alpha blending for OSD
In-Reply-To: <1157732346.450197facea92@webmail.in-berlin.de>
References: <30885-36724@sneakemail.com> <450193E0.1050400@gmx.net>
	<1157732346.450197facea92@webmail.in-berlin.de>
Message-ID: <200609081906.07524.stefan@lucke.in-berlin.de>

On Freitag 08 September 2006 18:19, Stefan Lucke wrote:
> Quoting Martin Wache <M.Wache at gmx.net>:
> 
> > Chris Elsworth schrieb:
> > > On Fri, Sep 08, 2006 at 05:14:26PM +0200, Martin Wache wrote:
> > >> Chris Elsworth schrieb:
> > >>> I haven't got much information to hand at the moment but current CVS
> > >>> breaks here; this is a pretty useless bug report I'm afraid, there's
> > >>> no diagnostic information given:
> > >>>
> > >>>
> > >> Did you check the syslog for further information?
> > >
> > > Hello,
> > >
> > > Here's syslog output with -l 3:
> > >
> >
> > This is very strange:
> >
> >
> > > Sep  8 16:42:10 media vdr: [12919] [XvVideoOut]: initialized OK
> >
> > This line comes from video-xv.c line 1053 in the method Initialize().
> > After that line the method _cannot_ return false. But as you posted before:
> >
> > > [softdevice] Xv out failure !
> >
> > which belongs to softdevice.c line 252. This line can only be reached if
> > Initialize() returns false.
> >
> > Or did I miss anything?
> 
> The combination of these two messages should be impossible.

Except check conditions are reversed
if ( videoOut->Initialize() ) -> OK path in LoadSubplugins()
if ( !videoOut->Initialize() )  -> OK path ??? without subplugins

Fix is in cvs.


-- 
Stefan Lucke


From chris at shagged.org  Fri Sep  8 19:14:47 2006
From: chris at shagged.org (Chris Elsworth)
Date: Fri, 8 Sep 2006 18:14:47 +0100
Subject: [Softdevice-devel] nVidia hardware alpha blending for OSD
In-Reply-To: <200609081906.07524.stefan@lucke.in-berlin.de>
References: <30885-36724@sneakemail.com> <450193E0.1050400@gmx.net>
	<1157732346.450197facea92@webmail.in-berlin.de>
	<200609081906.07524.stefan@lucke.in-berlin.de>
Message-ID: <20060908171447.GB4273@spork.qfe3.net>

On Fri, Sep 08, 2006 at 07:06:07PM +0200, Stefan Lucke wrote:
> > 
> > The combination of these two messages should be impossible.
> 
> Except check conditions are reversed
> if ( videoOut->Initialize() ) -> OK path in LoadSubplugins()
> if ( !videoOut->Initialize() )  -> OK path ??? without subplugins
> 
> Fix is in cvs.

Success, thanks very much Stefan :)

-- 
Chris


From M.Wache at gmx.net  Fri Sep  8 19:22:11 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Fri, 08 Sep 2006 19:22:11 +0200
Subject: [Softdevice-devel] nVidia hardware alpha blending for OSD
In-Reply-To: <200609081906.07524.stefan@lucke.in-berlin.de>
References: <30885-36724@sneakemail.com>
	<450193E0.1050400@gmx.net>	<1157732346.450197facea92@webmail.in-berlin.de>
	<200609081906.07524.stefan@lucke.in-berlin.de>
Message-ID: <4501A6C3.7070002@gmx.net>

Stefan Lucke schrieb:

> Except check conditions are reversed
> if ( videoOut->Initialize() ) -> OK path in LoadSubplugins()
> if ( !videoOut->Initialize() )  -> OK path ??? without subplugins
> 
> Fix is in cvs.
> 
Ups, I guess that was me... But what really is embarrassing is that I
didn't even notice this when looking at the code :-o

But this brings to my mind that I wanted to suggest long ago to use the
Initialize() methods to auto-detect the video out methods. Currently, if
 all methods are compiled the default is video-vidix. If this is missing
video-fb, then video-dfb and finally video-xv. I think that this is
rather stupid.
I would suggest that, if no options are given to first try
video-xv.Initialize(), if that fails video-dfb.Initialize(), then vidix
and last and least fb.
I think this would make quite a reliable autodetection.
Comments?

Bye,
Martin


From marko.makela at hut.fi  Fri Sep  8 19:25:30 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 8 Sep 2006 20:25:30 +0300
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <1849e5180609071309i38bfb466hcabae8c61ef4ddbf@mail.gmail.com>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<200609042301.16491.stefan@lucke.in-berlin.de>
	<1849e5180609041617h4579d219i4bf418bbb1a92612@mail.gmail.com>
	<200609051833.51434.stefan@lucke.in-berlin.de>
	<20060906204417.GA2844@localhost.localdomain>
	<1849e5180609071309i38bfb466hcabae8c61ef4ddbf@mail.gmail.com>
Message-ID: <20060908172529.GC2833@localhost.localdomain>

On Thu, Sep 07, 2006 at 09:09:20PM +0100, Alasdair Campbell wrote:
> On 06/09/06, Marko M?kel? <marko.makela at hut.fi> wrote:
> > Now I only have one wishlist item left for DirectFB on Matrox cards:
> > get rid of that busy-waiting in IDirectFBSurface::Flip() by implementing
> > some ioctl() calls to make it interrupt-driven.
> 
> Is that a lot of work?

For someone who knows how interrupts are processed in the Linux kernel,
it should not be that hard.  I have programmed interrupt routines in
machine language, but not in C on a sophisticated operating system
like the Linux kernel.  I think that Ville Syrj?l? might have had a
kernel patch for this, but I am not sure how much work it would be
to get it in the 2.6 kernel.

> With my underclocked barton (running at 1350 MHz) the following
> results were got from 'top'.
> [I just took the value for the vdr process with the highest value,
> don't know if this is misleading].

Oh, you must be using LinuxThreads then.  I've used NPTL for the past year
(just unset the environment variable LD_ASSUME_KERNEL if you are using
GNU libc 2.3 or later).  NTPL should have smaller overhead than LinuxThreads.

> Unpatched:
> -vo dfb:mgatv  = ~40%
> -vo dfb:  = ~21% ( a lovely figure!)
> 
> Patched:
> -vo dfb:mgatv = ~29% (great patch)
> -vo dfb: = ~29%

The usleep() calls should not affect the -vo dfb: code path.  You should
perhaps have watched a recording instead of live stream to get more
repeatable results.  Anyway, you seem to be getting 10% savings on
dfb:mgatv, about the same as me.

> With results like that, and with Matrox hardware scaled interlaced
> output working in 'VGA' mode, I could nearly run vdr on my old AMD K6
> 500mhz relic.

You need some margin.  I was unable to underclock my system, but I think
you will be dropping frames if the CPU load goes above 60% or 70%.

> > I plan to make some OProfile measurements this weekend.  At the very least,
> > I will measure the impact of colour space transformation (i.e., let
> > -vo dfb:mgatv show wrong colours by pretending it uses the native output
> > colour space of ffmpeg).
> 
> I remember you saying your cable didn't work with "-vo dfb:" because
> that option didn't generate a composite sync signal - well I don't
> think I made it clear enough that I _did_ see a picture of comparable
> (slightly sharper) quality using "-vo dfb:" & the cable from the
> diagram we both used.

And come to think of it, it might be that the problem is not the
colour space conversion but simply the Flip() call.  I seem to remember
that Stefan's test program from June or so gave comparable results
for memcpy() and yv12_to_yuy2_il_mmx2().  The only thing that you could
avoid on -vo dfb: output is the memcpy(), i.e., let ffmpeg uncompress
the data directly to the frame buffer (if it does not do so already).

> Basically, latest DirectFB CVS with softdevice option '-vo dfb:' seems
> to generate a composite signal just like '-vo dfb:mgatv' does.

I'll give it another try in that case.

	Marko


From marko.makela at hut.fi  Fri Sep  8 19:40:26 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 8 Sep 2006 20:40:26 +0300
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <20060908111118.45550.qmail@web86310.mail.ird.yahoo.com>
References: <20060908111118.45550.qmail@web86310.mail.ird.yahoo.com>
Message-ID: <20060908174026.GD2833@localhost.localdomain>

On Fri, Sep 08, 2006 at 12:11:18PM +0100, Stuart Morris wrote:
> I have however noticed a few problems:
> 
> I am getting 60% cpu usage on a Duron900 however video frames are being
> dropped. Video 'jumps' occur aproximately every 10-20seconds.
> I have tried using a multimedia kernel and vdr running at nice -5 but
> I noticed only a small improvement.

Have you tried adding a usleep(1000) or usleep(2000) right before the
scrSurface->Flip() calls in cDFBVideoOut::ShowOSD() and cDFBVideoOut::YUV()?
The Flip() call is busy-waiting for MGA DMA engine ready.

The sleeps should free about 10% of the CPU for other processes or threads.
The right fix would be to introduce an ioctl() in the kernel that would
allow Flip() to sleep until the MGA DMA engine triggers an interrupt.

> If I exit from vdr and then run vdr with softdevice for a second time, the system
> appears to lock up with no tv or monitor output, forcing a system reboot.
> It seems I can run softdevice only once before having to reboot the system.

Last night, I restarted vdr dozens of times without problem.

> Softdevice can only work with VDR run with root privelages. Is this correct?

No.  You probably need no-vt in /etc/directfbrc.  Here's my file in its
entirety:

matrox-crtc2
matrox-tv-standard=pal
matrox-cable-type=scart-rgb
primary-layer=2
hardware
mmx
no-banner
no-vt
linux-input-ir-only

	Marko


From M.Wache at gmx.net  Fri Sep  8 19:41:10 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Fri, 08 Sep 2006 19:41:10 +0200
Subject: [Softdevice-devel] nvidia OSD patches...
Message-ID: <4501AB36.1010008@gmx.net>

Hi all,

thinking again about the OSD troubles with nvidia, and that Stefan
suggested that it might be a wrong range of YUV values, I have prepared
some patches. Could someone who has these problems with the OSD please
try them separately and tell me if one resolves the problems?

I checked our conversion RGB->YUV, it respects the range. But there is
still this small bug in the scaling algorithm which sometimes produces
stray pixels at the edges. Those pixel may have any values and if the
nVidia cards gets confused by those pixels, it may well be that the
complete line looks strange.

Thank you for any reports!
Martin
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: exclude_edges.diff
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060908/0987b699/attachment.ksh>
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: limit_both.diff
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060908/0987b699/attachment-0001.ksh>
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: limit_max.diff
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060908/0987b699/attachment-0002.ksh>
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: limit_min.diff
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060908/0987b699/attachment-0003.ksh>

From stefan at lucke.in-berlin.de  Fri Sep  8 19:49:34 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 8 Sep 2006 19:49:34 +0200
Subject: [Softdevice-devel] nVidia hardware alpha blending for OSD
In-Reply-To: <4501A6C3.7070002@gmx.net>
References: <30885-36724@sneakemail.com>
	<200609081906.07524.stefan@lucke.in-berlin.de>
	<4501A6C3.7070002@gmx.net>
Message-ID: <200609081949.34769.stefan@lucke.in-berlin.de>

On Freitag 08 September 2006 19:22, Martin Wache wrote:
> Stefan Lucke schrieb:
> 
> > Except check conditions are reversed
> > if ( videoOut->Initialize() ) -> OK path in LoadSubplugins()
> > if ( !videoOut->Initialize() )  -> OK path ??? without subplugins
> > 
> > Fix is in cvs.
> > 
> Ups, I guess that was me... But what really is embarrassing is that I
> didn't even notice this when looking at the code :-o

Seems to be a common problem, as the same happend in front of
my screen too.

> 
> But this brings to my mind that I wanted to suggest long ago to use the
> Initialize() methods to auto-detect the video out methods. Currently, if
>  all methods are compiled the default is video-vidix. If this is missing
> video-fb, then video-dfb and finally video-xv. I think that this is
> rather stupid.

I won't say it is an intelligent or a sopisticated way, perhaps we
should bail out when -vo is not given. I've no preference in that
case except that it should be clear what would happen.

> I would suggest that, if no options are given to first try
> video-xv.Initialize(), if that fails video-dfb.Initialize(), then vidix
> and last and least fb.
> I think this would make quite a reliable autodetection.
> Comments?
> 


-- 
Stefan Lucke


From chris at shagged.org  Fri Sep  8 19:53:15 2006
From: chris at shagged.org (Chris Elsworth)
Date: Fri, 8 Sep 2006 18:53:15 +0100
Subject: [Softdevice-devel] nvidia OSD patches...
In-Reply-To: <4501AB36.1010008@gmx.net>
References: <4501AB36.1010008@gmx.net>
Message-ID: <20060908175314.GA5907@spork.qfe3.net>

On Fri, Sep 08, 2006 at 07:41:10PM +0200, Martin Wache wrote:
> Hi all,
> 
> thinking again about the OSD troubles with nvidia, and that Stefan
> suggested that it might be a wrong range of YUV values, I have prepared
> some patches. Could someone who has these problems with the OSD please
> try them separately and tell me if one resolves the problems?

Hello,

I observed no difference with any of the attached patches.

Interestingly my OSD issue changed with upgrading from softdevice
0.2.3 to cvs recently. It used to be a rather gaudy pink, but now it's
changed to a deep green, when I'm viewing a low resolution broadcast.

-- 
Chris


From chris at shagged.org  Fri Sep  8 19:53:15 2006
From: chris at shagged.org (Chris Elsworth)
Date: Fri, 8 Sep 2006 18:53:15 +0100
Subject: [Softdevice-devel] nvidia OSD patches...
In-Reply-To: <4501AB36.1010008@gmx.net>
References: <4501AB36.1010008@gmx.net>
Message-ID: <20060908175314.GA5907@spork.qfe3.net>

On Fri, Sep 08, 2006 at 07:41:10PM +0200, Martin Wache wrote:
> Hi all,
> 
> thinking again about the OSD troubles with nvidia, and that Stefan
> suggested that it might be a wrong range of YUV values, I have prepared
> some patches. Could someone who has these problems with the OSD please
> try them separately and tell me if one resolves the problems?

Hello,

I observed no difference with any of the attached patches.

Interestingly my OSD issue changed with upgrading from softdevice
0.2.3 to cvs recently. It used to be a rather gaudy pink, but now it's
changed to a deep green, when I'm viewing a low resolution broadcast.

-- 
Chris


From stefan at lucke.in-berlin.de  Fri Sep  8 20:44:59 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 8 Sep 2006 20:44:59 +0200
Subject: [Softdevice-devel] nVidia hardware alpha blending for OSD
In-Reply-To: <30885-36724@sneakemail.com>
References: <30885-36724@sneakemail.com>
Message-ID: <200609082044.59746.stefan@lucke.in-berlin.de>

On Mittwoch 30 August 2006 11:56, CR wrote:
> Hi all,
> 
> Some of you on the VDR mailing list may have seen me struggling to get
> softdevice's OSD to work without odd artifacts.
> 
> Although I have not yet found the source of the problem, I have a
> potential work around:  I believe my nVidia 6200 provides hardware alpha
> blending support for Xv images.  I think most, if not all new nVidia cards
> do.  If so, this would be really nice to support!
> 
> xdpyinfo lists for the blitter port, among other things:
> 
> 


> X-Video Extension version 2.2
> screen #0
>   Adaptor #0: "NV17 Video Texture"
>     number of ports: 1
>     port base: 53

> Adaptor #1: "NV05 Video Blitter"
>     number of ports: 32
>     port base: 54


I don't know if I ask for that, but which port do we use ?
This is reported in syslog. The message looks like:

Sep  8 19:04:08 jarada jarada vdr: [13404] [XvVideoOut]: ATI Radeon Video Overlay: available ports 73 - 73
Sep  8 19:04:08 jarada jarada vdr: [13404] [XvVideoOut]: grabbed port 73

It is possible to force use of a dedicated port in source code. This is 
not yet exposed to an argument.
Can you try this small modification ?

Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.60
diff -U3 -r1.60 video-xv.c
--- video-xv.c  4 Sep 2006 20:29:53 -0000       1.60
+++ video-xv.c  8 Sep 2006 18:39:38 -0000
@@ -776,6 +776,7 @@

   format = FOURCC_YV12;
   use_xv_port = 0;
+  use_xv_port = 54;
   w_name = "vdr";
   i_name = "vdr";


-- 
Stefan Lucke


From marko.makela at hut.fi  Fri Sep  8 21:05:45 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 8 Sep 2006 22:05:45 +0300
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <1849e5180609071309i38bfb466hcabae8c61ef4ddbf@mail.gmail.com>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<200609042301.16491.stefan@lucke.in-berlin.de>
	<1849e5180609041617h4579d219i4bf418bbb1a92612@mail.gmail.com>
	<200609051833.51434.stefan@lucke.in-berlin.de>
	<20060906204417.GA2844@localhost.localdomain>
	<1849e5180609071309i38bfb466hcabae8c61ef4ddbf@mail.gmail.com>
Message-ID: <20060908190545.GA3224@localhost.localdomain>

On Thu, Sep 07, 2006 at 09:09:20PM +0100, Alasdair Campbell wrote:
> I remember you saying your cable didn't work with "-vo dfb:" because
> that option didn't generate a composite sync signal - well I don't
> think I made it clear enough that I _did_ see a picture of comparable
> (slightly sharper) quality using "-vo dfb:" & the cable from the
> diagram we both used.

Please post your vdr command line, /etc/directfb and the relevant part
of /etc/fb.modes.

I can see correct colours with a mode 768x576-75 (75 Hz frame rate,
maybe 45 kHz line rate), but obviously my poor 15625 Hz/50 Hz monitor
can't sync at that.  fbset my-pal-32 (the modeline from
http://softdevice.berlios.de/) produces even less readable picture.
Without an oscilloscope, I can't tell what is wrong with the signal.
Softdevice produced a black picture when I tried to use that mode
(renamed to 768x576-pal and put as the first entry in /etc/fb.modes).
768x576-75 produced sensible colours.  By switching the monitor to
composite video mode (which should normally show a black picture),
I could see a horizontal line moving vertically on the screen.  That
made me suspect that there is no valid sync signal.

	Marko


From zzam at gentoo.org  Fri Sep  8 21:10:24 2006
From: zzam at gentoo.org (Matthias Schwarzott)
Date: Fri, 8 Sep 2006 21:10:24 +0200
Subject: [Softdevice-devel] nvidia OSD patches...
In-Reply-To: <4501AB36.1010008@gmx.net>
References: <4501AB36.1010008@gmx.net>
Message-ID: <200609082110.24446.zzam@gentoo.org>

On Friday 08 September 2006 19:41, Martin Wache wrote:
> Hi all,
>
> thinking again about the OSD troubles with nvidia, and that Stefan
> suggested that it might be a wrong range of YUV values, I have prepared
> some patches. Could someone who has these problems with the OSD please
> try them separately and tell me if one resolves the problems?
>
> I checked our conversion RGB->YUV, it respects the range. But there is
> still this small bug in the scaling algorithm which sometimes produces
> stray pixels at the edges. Those pixel may have any values and if the
> nVidia cards gets confused by those pixels, it may well be that the
> complete line looks strange.
>
> Thank you for any reports!
> Martin

I tried all your patches applied against my ebuild for cvs from today. They 
all do not change anything.
Then I tried using insight as debugger but that crashed :(

Then I found a working version:
Compiling softdevice with -O0 instead of -O2 made it working :)))
(Exactly I use normally: -O2 -march=athlon-xp -fomit-frame-pointer -pipe, and 
changed the -O2 to -O0 leaving the rest as they are).

It works now with -vo xv: and also with -vo shm:, the colors are correct for 
all channels not only these with 720px width.


Btw. When entering menu and switching from Pseudo to Software OSD-Mode the OSD 
is drawn twice (seems like pseudo over software) until I leave OSD and 
reenter it.

Matthias

-- 
Matthias Schwarzott
Gentoo Developer
http://www.gentoo.org
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060908/a214ba8e/attachment.pgp>

From marko.makela at hut.fi  Fri Sep  8 21:25:53 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 8 Sep 2006 22:25:53 +0300
Subject: [Softdevice-devel] dfb vs. dfb:mgatv
Message-ID: <20060908192553.GB3224@localhost.localdomain>

I measured the impact of yv12_to_yuy2_il_mmx2() by running
OProfile for 30 seconds and playing a certain recording.

My usleep() patch was applied.  To disable yv12_to_yuy2_il_mmx2(),
I replaced the condition

      if (pixelformat == DSPF_I420 || pixelformat == DSPF_YV12)

in cDFBVideoOut::YUV() with

      if (1)

so that fast_memcpy() would be used instead.  Here are the highlights:

CPU: PIII, speed 906.765 MHz (estimated)
Counted CPU_CLK_UNHALTED events (clocks processor is not halted) with a unit mask of 0x00 (No unit mask) count 90000
samples  %        symbol name
53030    32.7959  yv12_to_yuy2_il_mmx2_line(...)
13263     8.2024  mpeg_decode_mb
10962     6.7793  ff_mpa_synth_filter
9032      5.5858  put_pixels16_xy2_mmx
8593      5.3143  put_pixels8_mmx
8041      4.9729  ff_simple_idct_add_mmx
7233      4.4732  put_pixels16_mmx
3945      2.4397  MPV_decode_mb
3606      2.2301  MPV_motion

CPU: PIII, speed 906.765 MHz (estimated)
Counted CPU_CLK_UNHALTED events (clocks processor is not halted) with a unit mask of 0x00 (No unit mask) count 90000
samples  %        symbol name
28314    20.3541  fast_memcpy(void*, void const*, unsigned int)
14103    10.1382  mpeg_decode_mb
11570     8.3173  ff_mpa_synth_filter
9119      6.5554  put_pixels16_xy2_mmx
8567      6.1586  put_pixels8_mmx
7992      5.7452  ff_simple_idct_add_mmx
7796      5.6043  put_pixels16_mmx
4008      2.8812  MPV_decode_mb
3903      2.8058  MPV_motion

Above, you can see that fast_memcpy() results in 28314 samples
while yv12_to_yuy2_il_mmx2_line() results in 53030 samples,
almost twice the execution time of fast_memcpy().  The sample
counts of the other top functions are comparable.  The variance
is less than 10%.

I consider this a good result.  Furthermore, given that the CPU
is 50% idle according to "top", reducing 10% of the CPU usage of
softdevice would reduce the total CPU usage by only 5%.

	Marko


From chris at shagged.org  Fri Sep  8 21:48:59 2006
From: chris at shagged.org (Chris Elsworth)
Date: Fri, 8 Sep 2006 20:48:59 +0100
Subject: [Softdevice-devel] nvidia OSD patches...
In-Reply-To: <200609082110.24446.zzam@gentoo.org>
References: <4501AB36.1010008@gmx.net> <200609082110.24446.zzam@gentoo.org>
Message-ID: <20060908194859.GA8371@spork.qfe3.net>

On Fri, Sep 08, 2006 at 09:10:24PM +0200, Matthias Schwarzott wrote:
> 
> Then I found a working version:
> Compiling softdevice with -O0 instead of -O2 made it working :)))
> (Exactly I use normally: -O2 -march=athlon-xp -fomit-frame-pointer -pipe, and 
> changed the -O2 to -O0 leaving the rest as they are).
> 
> It works now with -vo xv: and also with -vo shm:, the colors are correct for 
> all channels not only these with 720px width.

Wow! Nice catch! I can confirm exactly the same result here, using
CXXFLAGS=-O0 -g -Wall -fPIC -Woverloaded-virtual

-- 
Chris


From ragawu at gmail.com  Fri Sep  8 22:01:40 2006
From: ragawu at gmail.com (Alasdair Campbell)
Date: Fri, 8 Sep 2006 21:01:40 +0100
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <20060908190545.GA3224@localhost.localdomain>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<200609042301.16491.stefan@lucke.in-berlin.de>
	<1849e5180609041617h4579d219i4bf418bbb1a92612@mail.gmail.com>
	<200609051833.51434.stefan@lucke.in-berlin.de>
	<20060906204417.GA2844@localhost.localdomain>
	<1849e5180609071309i38bfb466hcabae8c61ef4ddbf@mail.gmail.com>
	<20060908190545.GA3224@localhost.localdomain>
Message-ID: <1849e5180609081301y63768487g9a34884dc03c570b@mail.gmail.com>

On 08/09/06, Marko M?kel? <marko.makela at hut.fi> wrote:
> Please post your vdr command line, /etc/directfb and the relevant part
> of /etc/fb.modes.

"vdr command":
vdr -c /etc/vdr/ -L /usr/lib/vdr/plugins/ -P"softdevice -vo dfb:"

"/etc/directfbrc":
mode=768x576
primary-layer=2
depth=32
matrox-crtc2
matrox-tv-standard=pal
matrox-cable-type=scart-rgb
no-vt-switching
no-vt-switch
no-vt

"/etc/fb.modes":
mode "PAL"
    geometry 768 576 768 576 32
    timings  67723 106 1 44 1 70 4
    csync high
    laced true
    bcast true
endmode

I'm fairly sure the mode "PAL" came from the DirectFB readme.

With softdevice -vo dfb:mgatv, the first head (I've still got a
monitor connected) displays the text output of directfb/vdr and also 3
copies of the video stream with the wrong colours. With -vo dfb: the
console text goes purple and there is no video visible on the first
head.

2nd head display is identical, except -vo dfb: is marginally sharper
with small white text on black, while -vo dfb:mgatv looks almost
anti-aliased. The difference is slight, but exists.

> I can see correct colours with a mode 768x576-75 (75 Hz frame rate,
> maybe 45 kHz line rate), but obviously my poor 15625 Hz/50 Hz monitor
> can't sync at that.  fbset my-pal-32 (the modeline from
> http://softdevice.berlios.de/) produces even less readable picture.
> Without an oscilloscope, I can't tell what is wrong with the signal.
> Softdevice produced a black picture when I tried to use that mode
> (renamed to 768x576-pal and put as the first entry in /etc/fb.modes).
> 768x576-75 produced sensible colours.  By switching the monitor to
> composite video mode (which should normally show a black picture),
> I could see a horizontal line moving vertically on the screen.  That
> made me suspect that there is no valid sync signal.

I don't know much about this sort of thing, but surely the sync signal
must exist, otherwise I would see scrolling images?

>
>         Marko
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/softdevice-devel
>


-- 
A l a s d a i r   C a m p b e l l

r a g a w u @ g m a i l . c o m


From ragawu at gmail.com  Fri Sep  8 22:08:33 2006
From: ragawu at gmail.com (Alasdair Campbell)
Date: Fri, 8 Sep 2006 21:08:33 +0100
Subject: [Softdevice-devel] dfb-out: square with different colours
In-Reply-To: <200609072330.32408.stefan@lucke.in-berlin.de>
References: <200609060702.05976.stefan@lucke.in-berlin.de>
	<1849e5180609062005y7326332ct3c0e992952d4ee9@mail.gmail.com>
	<1849e5180609071348le23d388jac44ad724821e44@mail.gmail.com>
	<200609072330.32408.stefan@lucke.in-berlin.de>
Message-ID: <1849e5180609081308s4994e930jea43811e608f6224@mail.gmail.com>

On 07/09/06, Stefan Lucke <stefan at lucke.in-berlin.de> wrote:
> You are using the no-vt* options in your directfbrc. A good way to avoid
> any interruptions from text written you should redirect stdout and stderr
> to a log file  vdr_call >vdr_log 2>&1.

I should be using those no-vt* options shouldn't I, if I'm just after
vdr output to the 2nd head and won't be using the first? Sorry for
this directfb related question..

> For hiding cursor etc.. I once suggested the following which may be
> useful for vidix users too:
>
> -- snip --
> # setup logfile name
> LOGFILE=/var/log/my_vdr_logfile
> #
> # save prompt mode, hide prompt and switch cursor off
> PSSAVE=${PS1}
> export PS1=''
> setterm -cursor off
> #
> # deactivate powersaving mode and clear screen
> setterm -powersave off
> clear
> #
> # start vdr
> vdr WITH_DESIRED_PARAMETERS  >${LOGFILE} 2>&1
> # restore settings
> export PS1=${PSSAVE}
> setterm -default
> -- snip --

Something strange happened when I tried this script, first of all with
it copied verbatim, vdr loads as normal but there is only a black
screen. I then tried commenting out lines such as the powersave one,
and the "clear" line, however even after removing ALL the lines until
it was only a exact copy of my vdr command line, there was still
nothing but a black screen.

I figure this must be to do with permissions or what not, however I
ran the command on the console directly with the same user and it
worked fine, exact same command in an executable shell script and
nothing appears.

> >
> > Also, (this is something I have seen with the gentoo ebuilds and
> > unpatched DirectFb cvs) on the first head, along with the console off
> > center, I see three instances of the same video image, with the wrong
> > colours.
> >
> > I don't know if this is simply a configuration error, I've attached
> > the config files / outputs I thought were relevant.
> >

So is that to be expected, the video appearing on the first head?

>
>
> --
> Stefan Lucke
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/softdevice-devel
>


-- 
A l a s d a i r   C a m p b e l l

r a g a w u @ g m a i l . c o m


From stefan at lucke.in-berlin.de  Fri Sep  8 22:56:42 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 8 Sep 2006 22:56:42 +0200
Subject: [Softdevice-devel] nvidia OSD patches...
In-Reply-To: <20060908194859.GA8371@spork.qfe3.net>
References: <4501AB36.1010008@gmx.net> <200609082110.24446.zzam@gentoo.org>
	<20060908194859.GA8371@spork.qfe3.net>
Message-ID: <200609082256.42699.stefan@lucke.in-berlin.de>

On Freitag 08 September 2006 21:48, Chris Elsworth wrote:
> On Fri, Sep 08, 2006 at 09:10:24PM +0200, Matthias Schwarzott wrote:
> > 
> > Then I found a working version:
> > Compiling softdevice with -O0 instead of -O2 made it working :)))
> > (Exactly I use normally: -O2 -march=athlon-xp -fomit-frame-pointer -pipe, and 
> > changed the -O2 to -O0 leaving the rest as they are).
> > 
> > It works now with -vo xv: and also with -vo shm:, the colors are correct for 
> > all channels not only these with 720px width.
> 
> Wow! Nice catch! I can confirm exactly the same result here, using
> CXXFLAGS=-O0 -g -Wall -fPIC -Woverloaded-virtual

I'd like to know:
1. compiler version
   mine is:
   gcc (GCC) 3.4.4 (Gentoo 3.4.4-r1, ssp-3.4.4-1.0, pie-8.7.8)
   Copyright (C) 2004 Free Software Foundation, Inc.

2. Did you both succeeded with patched or cvs softdevice ?

-- 
Stefan Lucke


From zzam at gentoo.org  Fri Sep  8 23:06:05 2006
From: zzam at gentoo.org (Matthias Schwarzott)
Date: Fri, 8 Sep 2006 23:06:05 +0200
Subject: [Softdevice-devel] nvidia OSD patches...
In-Reply-To: <200609082256.42699.stefan@lucke.in-berlin.de>
References: <4501AB36.1010008@gmx.net> <20060908194859.GA8371@spork.qfe3.net>
	<200609082256.42699.stefan@lucke.in-berlin.de>
Message-ID: <200609082306.08954.zzam@gentoo.org>

On Friday 08 September 2006 22:56, Stefan Lucke wrote:
> On Freitag 08 September 2006 21:48, Chris Elsworth wrote:
> > On Fri, Sep 08, 2006 at 09:10:24PM +0200, Matthias Schwarzott wrote:
> > > Then I found a working version:
> > > Compiling softdevice with -O0 instead of -O2 made it working :)))
> > > (Exactly I use normally: -O2 -march=athlon-xp -fomit-frame-pointer
> > > -pipe, and changed the -O2 to -O0 leaving the rest as they are).
> > >
> > > It works now with -vo xv: and also with -vo shm:, the colors are
> > > correct for all channels not only these with 720px width.
> >
> > Wow! Nice catch! I can confirm exactly the same result here, using
> > CXXFLAGS=-O0 -g -Wall -fPIC -Woverloaded-virtual
>
> I'd like to know:
> 1. compiler version
>    mine is:
>    gcc (GCC) 3.4.4 (Gentoo 3.4.4-r1, ssp-3.4.4-1.0, pie-8.7.8)
>    Copyright (C) 2004 Free Software Foundation, Inc.
>
gcc-Version 4.1.1 (Gentoo 4.1.1-r1)

> 2. Did you both succeeded with patched or cvs softdevice ?
CVS-Version of now. Only three (small) patches, adding 
libcle266mpegdec-support, adding an option to disable xinerama in configure 
and a hack adding a fullscreen (-f) option to ShmClient.

You can wait some time then it will be available as ebuild :)
I now added a force -O0 to the ebuild.

Matthias

-- 
Matthias Schwarzott
Gentoo Developer
http://www.gentoo.org
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060908/0a433f32/attachment.pgp>

From chris at shagged.org  Fri Sep  8 23:33:49 2006
From: chris at shagged.org (Chris Elsworth)
Date: Fri, 8 Sep 2006 22:33:49 +0100
Subject: [Softdevice-devel] nvidia OSD patches...
In-Reply-To: <200609082256.42699.stefan@lucke.in-berlin.de>
References: <4501AB36.1010008@gmx.net> <200609082110.24446.zzam@gentoo.org>
	<20060908194859.GA8371@spork.qfe3.net>
	<200609082256.42699.stefan@lucke.in-berlin.de>
Message-ID: <20060908213349.GA10218@spork.qfe3.net>

On Fri, Sep 08, 2006 at 10:56:42PM +0200, Stefan Lucke wrote:
> 
> I'd like to know:
> 1. compiler version
>    mine is:
>    gcc (GCC) 3.4.4 (Gentoo 3.4.4-r1, ssp-3.4.4-1.0, pie-8.7.8)
>    Copyright (C) 2004 Free Software Foundation, Inc.

Using built-in specs.
Target: x86_64-linux-gnu
gcc version 4.1.2 20060906 (prerelease) (Ubuntu 4.1.1-13ubuntu2)

> 2. Did you both succeeded with patched or cvs softdevice ?

Unpatched current CVS.

-- 
Chris


From prakash at punnoor.de  Sat Sep  9 00:13:12 2006
From: prakash at punnoor.de (Prakash Punnoor)
Date: Sat, 9 Sep 2006 00:13:12 +0200
Subject: [Softdevice-devel] nvidia OSD patches...
In-Reply-To: <200609082110.24446.zzam@gentoo.org>
References: <4501AB36.1010008@gmx.net> <200609082110.24446.zzam@gentoo.org>
Message-ID: <200609090013.12771.prakash@punnoor.de>

Am Freitag 08 September 2006 21:10 schrieb Matthias Schwarzott:
> On Friday 08 September 2006 19:41, Martin Wache wrote:
> > Hi all,
> >
> > thinking again about the OSD troubles with nvidia, and that Stefan
> > suggested that it might be a wrong range of YUV values, I have prepared
> > some patches. Could someone who has these problems with the OSD please
> > try them separately and tell me if one resolves the problems?
> >
> > I checked our conversion RGB->YUV, it respects the range. But there is
> > still this small bug in the scaling algorithm which sometimes produces
> > stray pixels at the edges. Those pixel may have any values and if the
> > nVidia cards gets confused by those pixels, it may well be that the
> > complete line looks strange.
> >
> > Thank you for any reports!
> > Martin
>
> I tried all your patches applied against my ebuild for cvs from today. They
> all do not change anything.
> Then I tried using insight as debugger but that crashed :(
>
> Then I found a working version:
> Compiling softdevice with -O0 instead of -O2 made it working :)))
> (Exactly I use normally: -O2 -march=athlon-xp -fomit-frame-pointer -pipe,
> and changed the -O2 to -O0 leaving the rest as they are).

Could you bisect thorugh the source files, compiling some with with O2 and O0, 
till you find the affected files? (probabaly needs soe Makefile 
modifications) Then bisect through the functions in that files by copying 
them to a seperate file till you find the broken ones? Then one could analyze 
what goes wrong.

Cheers,
-- 
(?=                 =?)
//\ Prakash Punnoor /\\
V_/                 \_V
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060909/4ac32bab/attachment.pgp>

From M.Wache at gmx.net  Sat Sep  9 07:56:35 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sat, 09 Sep 2006 07:56:35 +0200
Subject: [Softdevice-devel] nvidia OSD patches...
In-Reply-To: <200609082306.08954.zzam@gentoo.org>
References: <4501AB36.1010008@gmx.net>
	<20060908194859.GA8371@spork.qfe3.net>	<200609082256.42699.stefan@lucke.in-berlin.de>
	<200609082306.08954.zzam@gentoo.org>
Message-ID: <45025793.6050700@gmx.net>

Matthias Schwarzott schrieb:
> On Friday 08 September 2006 22:56, Stefan Lucke wrote:
>> On Freitag 08 September 2006 21:48, Chris Elsworth wrote:
>>> On Fri, Sep 08, 2006 at 09:10:24PM +0200, Matthias Schwarzott wrote:
>>>> Then I found a working version:
>>>> Compiling softdevice with -O0 instead of -O2 made it working :)))
>>>> (Exactly I use normally: -O2 -march=athlon-xp -fomit-frame-pointer
>>>> -pipe, and changed the -O2 to -O0 leaving the rest as they are).
>>>>
>>>> It works now with -vo xv: and also with -vo shm:, the colors are
>>>> correct for all channels not only these with 720px width.
>>> Wow! Nice catch! I can confirm exactly the same result here, using
>>> CXXFLAGS=-O0 -g -Wall -fPIC -Woverloaded-virtual
>> I'd like to know:
>> 1. compiler version
>>    mine is:
>>    gcc (GCC) 3.4.4 (Gentoo 3.4.4-r1, ssp-3.4.4-1.0, pie-8.7.8)
>>    Copyright (C) 2004 Free Software Foundation, Inc.
>>
> gcc-Version 4.1.1 (Gentoo 4.1.1-r1)
> 

Maybe it is a compiler bug or at least a change in the behaviour. I had
a similar problem some time ago, it went away when I disabled the mmx
optimization. If with -O2 and --disable-mmx the code works, could you
please try to enable the mmx by hand in the SoftOsd.c file separately
for the Methods ScaleDownHoriz_MMX() and ScaleDownVert_MMX()? The best
method to do this is to insert
#define USE_MMX
#define USE_MMX2
before the method and
#undef USE_MMX
#undef USE_MMX2
after it. If that breaks again, please tell me which method causes the
problems.

Thanks,
Martin



From omge2ri02 at sneakemail.com  Sat Sep  9 11:15:37 2006
From: omge2ri02 at sneakemail.com (CR)
Date: Sat, 9 Sep 2006 02:15:37 -0700 (MST)
Subject: [Softdevice-devel] nvidia OSD patches
In-Reply-To: <mailman.8502.1157749030.22248.softdevice-devel@lists.berlios.de>
References: <mailman.8502.1157749030.22248.softdevice-devel@lists.berlios.de>
Message-ID: <12672-24152@sneakemail.com>

Hi,

> >
> > thinking again about the OSD troubles with nvidia, and that Stefan
> > suggested that it might be a wrong range of YUV values, I have prepared
> > some patches. Could someone who has these problems with the OSD please
> > try them separately and tell me if one resolves the problems?

I'm on the softdevice mailing list in batch mode, so I've just seen a
bunch of mails on this.  I'll try softdevice cvs and cvs + patch tomorrow
and report back.

Thanks,
CR.


From zzam at gentoo.org  Sat Sep  9 12:01:45 2006
From: zzam at gentoo.org (Matthias Schwarzott)
Date: Sat, 9 Sep 2006 12:01:45 +0200
Subject: [Softdevice-devel] nvidia OSD patches...
In-Reply-To: <45025793.6050700@gmx.net>
References: <4501AB36.1010008@gmx.net> <200609082306.08954.zzam@gentoo.org>
	<45025793.6050700@gmx.net>
Message-ID: <200609091201.48615.zzam@gentoo.org>

On Saturday 09 September 2006 07:56, Martin Wache wrote:
> Matthias Schwarzott schrieb:
> > On Friday 08 September 2006 22:56, Stefan Lucke wrote:
> >> On Freitag 08 September 2006 21:48, Chris Elsworth wrote:
> >>> On Fri, Sep 08, 2006 at 09:10:24PM +0200, Matthias Schwarzott wrote:
> >>>> Then I found a working version:
> >>>> Compiling softdevice with -O0 instead of -O2 made it working :)))
> >>>> (Exactly I use normally: -O2 -march=athlon-xp -fomit-frame-pointer
> >>>> -pipe, and changed the -O2 to -O0 leaving the rest as they are).
> >>>>
> >>>> It works now with -vo xv: and also with -vo shm:, the colors are
> >>>> correct for all channels not only these with 720px width.
> >>>
> >>> Wow! Nice catch! I can confirm exactly the same result here, using
> >>> CXXFLAGS=-O0 -g -Wall -fPIC -Woverloaded-virtual
> >>
> >> I'd like to know:
> >> 1. compiler version
> >>    mine is:
> >>    gcc (GCC) 3.4.4 (Gentoo 3.4.4-r1, ssp-3.4.4-1.0, pie-8.7.8)
> >>    Copyright (C) 2004 Free Software Foundation, Inc.
> >
> > gcc-Version 4.1.1 (Gentoo 4.1.1-r1)
>
> Maybe it is a compiler bug or at least a change in the behaviour. I had
> a similar problem some time ago, it went away when I disabled the mmx
> optimization. If with -O2 and --disable-mmx the code works, could you
> please try to enable the mmx by hand in the SoftOsd.c file separately
> for the Methods ScaleDownHoriz_MMX() and ScaleDownVert_MMX()? The best
> method to do this is to insert
> #define USE_MMX
> #define USE_MMX2
> before the method and
> #undef USE_MMX
> #undef USE_MMX2
> after it. If that breaks again, please tell me which method causes the
> problems.
>
I did it another way: bisecting like Prakash Punnoor suggested.
Now I found out that cSoftOsd::ScaleDownHoriz_MMX from SoftOsd.c causes the 
problem.
If compiling that part with -O2 it does not work and with -O0 it works.

When now switching back to -O2 but undefining USE_MMX2 it also works again.


So enough for now.


Btw. I'm not able to compile softdevice with all mmx-versions disabled.
If calling
./configure --disable-mmx --disable-mmx2 --disable-dfb --disable-fb

"make all" then dies with:
g++ -O2 -g -Wall -fPIC -Woverloaded-virtual -c -DHAVE_CONFIG -DCONFIGDIR=\"/etc/vdr\" -DPLUGIN_NAME_I18N='"softdevice"' -D_GNU_SOURCE -DPLUGINLIBDIR='"/usr/lib/vdr/plugins"' -DSHM_SUPPORT -I/usr/include/vdr/.. -I/usr/include/include -I/usr/include/ffmpeg -I/usr/include/postproc   
utils.c
/tmp/cc8z7jw0.s: Assembler messages:
/tmp/cc8z7jw0.s:1420: Error: junk at end of line, first unrecognized character 
is `%'
/tmp/cc8z7jw0.s:1421: Error: junk at end of line, first unrecognized character 
is `%'
/tmp/cc8z7jw0.s:1422: Error: junk at end of line, first unrecognized character 
is `%'
/tmp/cc8z7jw0.s:1423: Error: junk at end of line, first unrecognized character 
is `%'
/tmp/cc8z7jw0.s:1424: Error: junk at end of line, first unrecognized character 
is `%'
/tmp/cc8z7jw0.s:1425: Error: junk at end of line, first unrecognized character 
is `%'
/tmp/cc8z7jw0.s:1426: Error: junk at end of line, first unrecognized character 
is `%'
/tmp/cc8z7jw0.s:1427: Error: junk at end of line, first unrecognized character 
is `%'
/tmp/cc8z7jw0.s:1481: Error: junk at end of line, first unrecognized character 
is `%'
/tmp/cc8z7jw0.s:1482: Error: junk at end of line, first unrecognized character 
is `%'
/tmp/cc8z7jw0.s:1483: Error: junk at end of line, first unrecognized character 
is `%'
/tmp/cc8z7jw0.s:1484: Error: junk at end of line, first unrecognized character 
is `%'
/tmp/cc8z7jw0.s:1485: Error: junk at end of line, first unrecognized character 
is `%'
/tmp/cc8z7jw0.s:1486: Error: junk at end of line, first unrecognized character 
is `%'
/tmp/cc8z7jw0.s:1487: Error: junk at end of line, first unrecognized character 
is `%'
/tmp/cc8z7jw0.s:1488: Error: junk at end of line, first unrecognized character 
is `%'
make: *** [utils.o] Fehler 1

Seems to me like undefined MOVNTQ when not having MMX and MMXEXT.

Matthias

-- 
Matthias Schwarzott
Gentoo Developer
http://www.gentoo.org
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060909/cbdd43ef/attachment.pgp>

From laz at club-burniston.co.uk  Sat Sep  9 13:29:29 2006
From: laz at club-burniston.co.uk (Laz)
Date: Sat, 9 Sep 2006 12:29:29 +0100
Subject: [Softdevice-devel] Contrast, brightness, saturation,
	etc. on dfb output...
Message-ID: <200609091229.29608.laz@club-burniston.co.uk>


Is any one working on implementing vidCaps for the DirectFB output of 
softdevice (I see it has just been added to the vidix driver). If no one is, 
I'll have a go at implementing it.

Cheers,

Laz


From prakash at punnoor.de  Sat Sep  9 13:57:57 2006
From: prakash at punnoor.de (Prakash Punnoor)
Date: Sat, 9 Sep 2006 13:57:57 +0200
Subject: [Softdevice-devel] nvidia OSD patches...
In-Reply-To: <200609091201.48615.zzam@gentoo.org>
References: <4501AB36.1010008@gmx.net> <45025793.6050700@gmx.net>
	<200609091201.48615.zzam@gentoo.org>
Message-ID: <200609091357.57631.prakash@punnoor.de>

Am Samstag 09 September 2006 12:01 schrieb Matthias Schwarzott:
> I did it another way: bisecting like Prakash Punnoor suggested.
> Now I found out that cSoftOsd::ScaleDownHoriz_MMX from SoftOsd.c causes the
> problem.
> If compiling that part with -O2 it does not work and with -O0 it works.

Nice, here is a hackish patch attached, which converts inline asm to 
intrinsics. Could you test this? It works for me when I play 720p files via 
softplay. Beware that it will only compile using gcc >4. If devs are OK, with 
converting inline asm to intrinsics, I could make it clean it up a bit,  
adding support for gcc <4, as well.

Cheers,
-- 
(?=                 =?)
//\ Prakash Punnoor /\\
V_/                 \_V
-------------- next part --------------
A non-text attachment was scrubbed...
Name: softosd-intrin1.diff
Type: text/x-diff
Size: 4671 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060909/9632b3b6/attachment.diff>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060909/9632b3b6/attachment.pgp>

From jonis2006 at yandex.ru  Sat Sep  9 13:59:57 2006
From: jonis2006 at yandex.ru (jonis2006)
Date: Sat, 9 Sep 2006 15:59:57 +0400 (MSD)
Subject: [Softdevice-devel] VIA unichrome TV-out on P4V8X-MX
Message-ID: <4502ACBD.000008.08522@webmail12.yandex.ru>

Hello !

VIA unichrome TV-out on P4V8X-MX is it possible to use with softdevice ? How I can get TV out on VIA Unichrome ? I heard that VIA Unichrome have TV out, but I don't see any video-outs on the motherboard (vga only) , maybe need build special cable ? Or I does not have TV out on this motherboad ?

With best regards
AgentX.


From stefan at lucke.in-berlin.de  Sat Sep  9 14:05:09 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 9 Sep 2006 14:05:09 +0200
Subject: [Softdevice-devel] Contrast, brightness, saturation,
	etc. on dfb output...
In-Reply-To: <200609091229.29608.laz@club-burniston.co.uk>
References: <200609091229.29608.laz@club-burniston.co.uk>
Message-ID: <200609091405.09889.stefan@lucke.in-berlin.de>

On Samstag 09 September 2006 13:29, Laz wrote:
> 
> Is any one working on implementing vidCaps for the DirectFB output of 
> softdevice (I see it has just been added to the vidix driver). If no one is, 
> I'll have a go at implementing it.
> 

The reasons I did not go further in this directtion were:
- At the time I tried, DFB++ had a bug and need a patch to call SetColorAdjustment()
- When working with TV-out and touching color registers, it was not possible for me
  to get the original values back. Maybe that's due to our 0 .. 100% logic.
  Value range of DirectFB is unsigned short.

Attached is my old diff (2005-11-10) , untested with current cvs.

-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: dfb-color-adjust.diff
Type: text/x-diff
Size: 4486 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060909/e939aa3a/attachment.diff>

From M.Wache at gmx.net  Sat Sep  9 14:50:55 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sat, 09 Sep 2006 14:50:55 +0200
Subject: [Softdevice-devel] nvidia OSD patches...
In-Reply-To: <200609091357.57631.prakash@punnoor.de>
References: <4501AB36.1010008@gmx.net>
	<45025793.6050700@gmx.net>	<200609091201.48615.zzam@gentoo.org>
	<200609091357.57631.prakash@punnoor.de>
Message-ID: <4502B8AF.7000408@gmx.net>

Prakash Punnoor schrieb:
> Am Samstag 09 September 2006 12:01 schrieb Matthias Schwarzott:
>> I did it another way: bisecting like Prakash Punnoor suggested.
>> Now I found out that cSoftOsd::ScaleDownHoriz_MMX from SoftOsd.c causes the
>> problem.
>> If compiling that part with -O2 it does not work and with -O0 it works.
> 
> Nice, here is a hackish patch attached, which converts inline asm to 
> intrinsics. Could you test this? It works for me when I play 720p files via 
> softplay. Beware that it will only compile using gcc >4. If devs are OK, with 
> converting inline asm to intrinsics, I could make it clean it up a bit,  
> adding support for gcc <4, as well.
> 
Well, I don't like the intrinsics very much. Would g++-2.95 be supported?
I would rather try to check what is going wrong, and if it is a compiler
bug. Could someone please send me a PM with the assembler output (g++
-S) of SoftOsd.c by g++-4.1 with the -O2 option and debugging info enabled?
Maybe there is a simpler workaround, or it is some bug in the code...

Thank you,

Martin


From laz at club-burniston.co.uk  Sat Sep  9 14:54:38 2006
From: laz at club-burniston.co.uk (Laz)
Date: Sat, 9 Sep 2006 13:54:38 +0100
Subject: [Softdevice-devel] Contrast, brightness, saturation,
	etc. on dfb output...
In-Reply-To: <200609091405.09889.stefan@lucke.in-berlin.de>
References: <200609091229.29608.laz@club-burniston.co.uk>
	<200609091405.09889.stefan@lucke.in-berlin.de>
Message-ID: <200609091354.38877.laz@club-burniston.co.uk>

On Saturday 09 September 2006 13:05, Stefan Lucke wrote:
> On Samstag 09 September 2006 13:29, Laz wrote:
> > Is any one working on implementing vidCaps for the DirectFB output of
> > softdevice (I see it has just been added to the vidix driver). If no one
> > is, I'll have a go at implementing it.
>
> The reasons I did not go further in this directtion were:
> - At the time I tried, DFB++ had a bug and need a patch to call
> SetColorAdjustment()

Ahhh...must admit that I haven't really started looked into this yet just had 
a quick look at the softdevice source to see where to slot bits in.

> - When working with TV-out and touching color 
> registers, it was not possible for me to get the original values back.
> Maybe that's due to our 0 .. 100% logic. Value range of DirectFB is
> unsigned short.
>
> Attached is my old diff (2005-11-10) , untested with current cvs.

Thanks. At first glance, it looks pretty similar to what I was going to do. 
I'll have a look to see if SetColorAdjustment() works in current DFB++.

Cheers,

Laz


From laz at club-burniston.co.uk  Sat Sep  9 16:59:04 2006
From: laz at club-burniston.co.uk (Laz)
Date: Sat, 9 Sep 2006 15:59:04 +0100
Subject: [Softdevice-devel] Contrast, brightness, saturation,
	etc. on dfb output...
In-Reply-To: <200609091405.09889.stefan@lucke.in-berlin.de>
References: <200609091229.29608.laz@club-burniston.co.uk>
	<200609091405.09889.stefan@lucke.in-berlin.de>
Message-ID: <200609091559.04973.laz@club-burniston.co.uk>

On Saturday 09 September 2006 13:05, Stefan Lucke wrote:
> On Samstag 09 September 2006 13:29, Laz wrote:
> > Is any one working on implementing vidCaps for the DirectFB output of
> > softdevice (I see it has just been added to the vidix driver). If no one
> > is, I'll have a go at implementing it.
>
> The reasons I did not go further in this directtion were:
> - At the time I tried, DFB++ had a bug and need a patch to call
> SetColorAdjustment() - When working with TV-out and touching color
> registers, it was not possible for me to get the original values back.
> Maybe that's due to our 0 .. 100% logic. Value range of DirectFB is
> unsigned short.
>
> Attached is my old diff (2005-11-10) , untested with current cvs.

I was originally thinking of using this on my main vdr system which uses viatv 
output but I've since found out that the primary layer supports this but the 
video overlay layer doesn't! I could have adjusted my OSD but not the video! 
Still, I've now had a go on my Matox system.

The actual settings bit seems to work on my Matrox system but it still needs a 
bit of tweaking because I think things have been reordered since the patch 
was written: your patch calls CheckVideoParmChange() before SetParam() is 
called and so videoParmLayer is unset when CheckVideoParmChange() is called 
so it returns straight away.

At the moment, CheckVideoParmChange() is only called from 
GetDisplayFrameTime() at startup and I'm not sure of the best place to add a 
further call: adding it at the end of SetParam() sort of works but it only 
gets called when the aspect ratio, resolution, etc. changes! Ideally, it 
should update the screen as the values are changed in the setup.

Using a combination of playing back recordings at various resolutions (so that 
SetParam() gets called) I can alter the brightness, contrast, etc. for the 
video layer (and OSD layer in this case).

The bug in DFB++ seems to have been fixed (at last, looking back through DFB 
mailing list archives!): I'm using DFB and DirectFB cvs from about April.

Cheers,

Laz


From chris at shagged.org  Sat Sep  9 17:28:44 2006
From: chris at shagged.org (Chris Elsworth)
Date: Sat, 9 Sep 2006 16:28:44 +0100
Subject: [Softdevice-devel] nvidia OSD patches...
In-Reply-To: <4502B8AF.7000408@gmx.net>
References: <4501AB36.1010008@gmx.net> <45025793.6050700@gmx.net>
	<200609091201.48615.zzam@gentoo.org>
	<200609091357.57631.prakash@punnoor.de> <4502B8AF.7000408@gmx.net>
Message-ID: <20060909152844.GA31599@spork.qfe3.net>

On Sat, Sep 09, 2006 at 02:50:55PM +0200, Martin Wache wrote:
> > 
> Well, I don't like the intrinsics very much. Would g++-2.95 be supported?
> I would rather try to check what is going wrong, and if it is a compiler
> bug. Could someone please send me a PM with the assembler output (g++
> -S) of SoftOsd.c by g++-4.1 with the -O2 option and debugging info enabled?
> Maybe there is a simpler workaround, or it is some bug in the code...

http://spork.qfe3.net/~chris/vdr/SoftOsd.sO0
http://spork.qfe3.net/~chris/vdr/SoftOsd.sO2

I used:

g++ -S -O2 -g -Wall -fPIC -Woverloaded-virtual -c -DHAVE_CONFIG -DPLUGIN_NAME_I18N='"softdevice"' -D_GNU_SOURCE -DPLUGINLIBDIR='"./PLUGINS/lib"' -DSHM_SUPPORT -I../../../include -I../../../../DVB/include -I/usr/include/ffmpeg/ -I/usr/include/ffmpeg/libavcodec/ -I/usr/include/ffmpeg/libavformat/  SoftOsd.c

And -O0 for the other one.

Please let me know if you need anything else!

-- 
Chris


From dave at optionsdsl.ca  Sat Sep  9 20:20:22 2006
From: dave at optionsdsl.ca (Dave)
Date: Sat, 09 Sep 2006 14:20:22 -0400
Subject: [Softdevice-devel] Any XvMC Future in Softdevice?
Message-ID: <450305E6.2090800@optionsdsl.ca>

   
Have to ask, I like to move into HDTV soon with XvMC/Nvidia

I Have used softdevice for a long time, and prefer it over the
problematic xine and libxineoutput plugins.  I use it on the framebuffer
with DFB, it has far superior deinterlacing and no A/V sync issues.




From marko.makela at hut.fi  Sat Sep  9 21:45:14 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sat, 9 Sep 2006 22:45:14 +0300
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <1849e5180609081301y63768487g9a34884dc03c570b@mail.gmail.com>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<200609042301.16491.stefan@lucke.in-berlin.de>
	<1849e5180609041617h4579d219i4bf418bbb1a92612@mail.gmail.com>
	<200609051833.51434.stefan@lucke.in-berlin.de>
	<20060906204417.GA2844@localhost.localdomain>
	<1849e5180609071309i38bfb466hcabae8c61ef4ddbf@mail.gmail.com>
	<20060908190545.GA3224@localhost.localdomain>
	<1849e5180609081301y63768487g9a34884dc03c570b@mail.gmail.com>
Message-ID: <20060909194514.GA2891@localhost.localdomain>

On Fri, Sep 08, 2006 at 09:01:40PM +0100, Alasdair Campbell wrote:
> 2nd head display is identical, except -vo dfb: is marginally sharper
> with small white text on black, while -vo dfb:mgatv looks almost
> anti-aliased. The difference is slight, but exists.

Thank you! My mistake was to plug the monitor to the 1st head and to
use a different directfbrc for -vo dfb and -vo dfb:mgatv.  The directfbrc
I tried had worked with a VGA monitor on the 1st head.

The first time I tested with your configuration, I got a picture.
"top" indicated 60% CPU usage, which is slightly more than with
mgatv.  So, I tried to switch from YUY2 to I420.  The CPU load
would drop to around 40%, but the video overlay would be all black.
Switching back to YUY2 did affect CPU usage, but the video overlay
remained black.  Even rebooting did not help.

In the log, I can see messages like this:

[dfb] (re)configuring Videolayer to 720 x 576 (720x576)
[dfb]: SetParams: failed to set buffermode to back video, reverting to normal
[dfb] SetParams: action=IDirectFBDisplayLayer::SetConfiguration(DFBDisplayLayerConfig&), result=Not supported!
Can't configure ScreenLocation. Hope it is Fullscreen
[surface capabilities] videoSurface: videoonly PixelFormat = 0x00200801
[dfb] (re)configured 0x00200806

Any ideas?  -vo dfb:mgatv works fine.

	Marko


From marko.makela at hut.fi  Sat Sep  9 21:48:36 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sat, 9 Sep 2006 22:48:36 +0300
Subject: [Softdevice-devel] Screen no longer blanked when no video
Message-ID: <20060909194836.GB2891@localhost.localdomain>

When I'm listening to a DVB radio program that lacks a video stream,
softdevice will continue to display the last displayed frame.  It
used to blank the screen within a few seconds.

	Marko


From marko.makela at hut.fi  Sat Sep  9 22:07:10 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sat, 9 Sep 2006 23:07:10 +0300
Subject: [Softdevice-devel] dfb-out: square with different colours
In-Reply-To: <1849e5180609081308s4994e930jea43811e608f6224@mail.gmail.com>
References: <200609060702.05976.stefan@lucke.in-berlin.de>
	<1849e5180609062005y7326332ct3c0e992952d4ee9@mail.gmail.com>
	<1849e5180609071348le23d388jac44ad724821e44@mail.gmail.com>
	<200609072330.32408.stefan@lucke.in-berlin.de>
	<1849e5180609081308s4994e930jea43811e608f6224@mail.gmail.com>
Message-ID: <20060909200710.GC2891@localhost.localdomain>

On Fri, Sep 08, 2006 at 09:08:33PM +0100, Alasdair Campbell wrote:
> > LOGFILE=/var/log/my_vdr_logfile
[...]
> > vdr WITH_DESIRED_PARAMETERS  >${LOGFILE} 2>&1

> Something strange happened when I tried this script, first of all with
> it copied verbatim, vdr loads as normal but there is only a black
> screen. I then tried commenting out lines such as the powersave one,
> and the "clear" line, however even after removing ALL the lines until
> it was only a exact copy of my vdr command line, there was still
> nothing but a black screen.

Is that on -vo dfb or -vo dfb:mgatv?  You did define LOGFILE in
a sensible way, didn't you?

Hmm, I'm not sure if '-vo dfb' is compatible with these settings in
your directfbrc:

matrox-crtc2
matrox-tv-standard=pal
matrox-cable-type=scart-rgb

I tried commenting out these, but all seem to be needed in order to
get a composite sync signal.  It was also necessary to define
primary-layer=2, although according to dfbinfo, it should be
the FBDev Primary Layer on the FBDev Primary Screen (i.e.,
the 1st head and not 2nd head).

> I figure this must be to do with permissions or what not, however I
> ran the command on the console directly with the same user and it
> worked fine, exact same command in an executable shell script and
> nothing appears.

Did you try adding "set -x" to the beginning of the script? Then it
should display all commands as they are executed.

	Marko


From ragawu at gmail.com  Sat Sep  9 22:27:28 2006
From: ragawu at gmail.com (Alasdair Campbell)
Date: Sat, 9 Sep 2006 21:27:28 +0100
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <20060909194514.GA2891@localhost.localdomain>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<200609042301.16491.stefan@lucke.in-berlin.de>
	<1849e5180609041617h4579d219i4bf418bbb1a92612@mail.gmail.com>
	<200609051833.51434.stefan@lucke.in-berlin.de>
	<20060906204417.GA2844@localhost.localdomain>
	<1849e5180609071309i38bfb466hcabae8c61ef4ddbf@mail.gmail.com>
	<20060908190545.GA3224@localhost.localdomain>
	<1849e5180609081301y63768487g9a34884dc03c570b@mail.gmail.com>
	<20060909194514.GA2891@localhost.localdomain>
Message-ID: <1849e5180609091327t3a6fbb56xd91baeafaa2f1927@mail.gmail.com>

On 09/09/06, Marko M?kel? <marko.makela at hut.fi> wrote:
> The first time I tested with your configuration, I got a picture.
> "top" indicated 60% CPU usage, which is slightly more than with
> mgatv.  So, I tried to switch from YUY2 to I420.  The CPU load
> would drop to around 40%, but the video overlay would be all black.
> Switching back to YUY2 did affect CPU usage, but the video overlay
> remained black.  Even rebooting did not help.

Well when I was fiddling with different modes in softdevice using -vo
dfb:, I noticed that if I changed away from YUY2, the 2nd head went
blank, and the video appeared on the 1st head with the wrong colours.
After changing back to YUY2 I had to reset the STRETCH BLIT option
just below. It has to be ON for me to see an image. The OSD works
throughout this.

don't know why rebooting didn't help though...

> In the log, I can see messages like this:
>
> [dfb] (re)configuring Videolayer to 720 x 576 (720x576)
> [dfb]: SetParams: failed to set buffermode to back video, reverting to normal
> [dfb] SetParams: action=IDirectFBDisplayLayer::SetConfiguration(DFBDisplayLayerConfig&), result=Not supported!
> Can't configure ScreenLocation. Hope it is Fullscreen
> [surface capabilities] videoSurface: videoonly PixelFormat = 0x00200801
> [dfb] (re)configured 0x00200806
>
> Any ideas?  -vo dfb:mgatv works fine.
>
>         Marko
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/softdevice-devel
>


-- 
A l a s d a i r   C a m p b e l l

r a g a w u @ g m a i l . c o m


From ragawu at gmail.com  Sat Sep  9 22:34:58 2006
From: ragawu at gmail.com (Alasdair Campbell)
Date: Sat, 9 Sep 2006 21:34:58 +0100
Subject: [Softdevice-devel] dfb-out: square with different colours
In-Reply-To: <20060909200710.GC2891@localhost.localdomain>
References: <200609060702.05976.stefan@lucke.in-berlin.de>
	<1849e5180609062005y7326332ct3c0e992952d4ee9@mail.gmail.com>
	<1849e5180609071348le23d388jac44ad724821e44@mail.gmail.com>
	<200609072330.32408.stefan@lucke.in-berlin.de>
	<1849e5180609081308s4994e930jea43811e608f6224@mail.gmail.com>
	<20060909200710.GC2891@localhost.localdomain>
Message-ID: <1849e5180609091334g600667fdj779bf298f06246cb@mail.gmail.com>

On 09/09/06, Marko M?kel? <marko.makela at hut.fi> wrote:
> On Fri, Sep 08, 2006 at 09:08:33PM +0100, Alasdair Campbell wrote:
> > > LOGFILE=/var/log/my_vdr_logfile
> [...]
> > > vdr WITH_DESIRED_PARAMETERS  >${LOGFILE} 2>&1
>
> > Something strange happened when I tried this script, first of all with
> > it copied verbatim, vdr loads as normal but there is only a black
> > screen. I then tried commenting out lines such as the powersave one,
> > and the "clear" line, however even after removing ALL the lines until
> > it was only a exact copy of my vdr command line, there was still
> > nothing but a black screen.
>
> Is that on -vo dfb or -vo dfb:mgatv?  You did define LOGFILE in
> a sensible way, didn't you?

this was on -vo dfb: I didn't change the bits about LOGFILE, and the
file was created successfully in /var/log

I've just noticed after reading through that the following lines appear:

[dfb] Using this layer for OSD:        Matrox CRTC2 Layer
[dfb] Using this layer for Video out:  FBDev Primary Layer

These should both say Matrox CRC2. I can't guess why running the
command in a shell script causes this change. OSD doesn't appear.


> Hmm, I'm not sure if '-vo dfb' is compatible with these settings in
> your directfbrc:
>
> matrox-crtc2
> matrox-tv-standard=pal
> matrox-cable-type=scart-rgb
>
> I tried commenting out these, but all seem to be needed in order to
> get a composite sync signal.  It was also necessary to define
> primary-layer=2, although according to dfbinfo, it should be
> the FBDev Primary Layer on the FBDev Primary Screen (i.e.,
> the 1st head and not 2nd head).
>
> > I figure this must be to do with permissions or what not, however I
> > ran the command on the console directly with the same user and it
> > worked fine, exact same command in an executable shell script and
> > nothing appears.
>
> Did you try adding "set -x" to the beginning of the script? Then it
> should display all commands as they are executed.
>
>         Marko
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/softdevice-devel
>


-- 
A l a s d a i r   C a m p b e l l

r a g a w u @ g m a i l . c o m


From stefan at lucke.in-berlin.de  Sat Sep  9 23:50:19 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 9 Sep 2006 23:50:19 +0200
Subject: [Softdevice-devel] Contrast, brightness, saturation,
	etc. on dfb output...
In-Reply-To: <200609091559.04973.laz@club-burniston.co.uk>
References: <200609091229.29608.laz@club-burniston.co.uk>
	<200609091405.09889.stefan@lucke.in-berlin.de>
	<200609091559.04973.laz@club-burniston.co.uk>
Message-ID: <200609092350.20065.stefan@lucke.in-berlin.de>

On Samstag 09 September 2006 16:59, Laz wrote:
> On Saturday 09 September 2006 13:05, Stefan Lucke wrote:
> > On Samstag 09 September 2006 13:29, Laz wrote:
> > > Is any one working on implementing vidCaps for the DirectFB output of
> > > softdevice (I see it has just been added to the vidix driver). If no one
> > > is, I'll have a go at implementing it.
> >
> > The reasons I did not go further in this directtion were:
> > - At the time I tried, DFB++ had a bug and need a patch to call
> > SetColorAdjustment() - When working with TV-out and touching color
> > registers, it was not possible for me to get the original values back.
> > Maybe that's due to our 0 .. 100% logic. Value range of DirectFB is
> > unsigned short.
> >
> > Attached is my old diff (2005-11-10) , untested with current cvs.
> 
> I was originally thinking of using this on my main vdr system which uses viatv 
> output but I've since found out that the primary layer supports this but the 
> video overlay layer doesn't! I could have adjusted my OSD but not the video! 
> Still, I've now had a go on my Matox system.

Funny, with nearly original version on my radeon, I only could adjust
the values of the videoLayer. Attached version is for current cvs and
does adjust settings for both: video and osd layer.

> 
> The actual settings bit seems to work on my Matrox system but it still needs a 
> bit of tweaking because I think things have been reordered since the patch 
> was written: your patch calls CheckVideoParmChange() before SetParam() is 
> called and so videoParmLayer is unset when CheckVideoParmChange() is called 
> so it returns straight away.

CheckVideoParmChange() is now called at end of SetParams(), 
and it is done allways.

-- 
Stefan Lucke

PS: Mail volume is really high in the past few days.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: dfb-color-adjust-02.diff
Type: text/x-diff
Size: 5538 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060909/28bd9e6a/attachment.diff>

From prakash at punnoor.de  Sun Sep 10 10:03:33 2006
From: prakash at punnoor.de (Prakash Punnoor)
Date: Sun, 10 Sep 2006 10:03:33 +0200
Subject: [Softdevice-devel] nvidia OSD patches...
In-Reply-To: <4502B8AF.7000408@gmx.net>
References: <4501AB36.1010008@gmx.net> <200609091357.57631.prakash@punnoor.de>
	<4502B8AF.7000408@gmx.net>
Message-ID: <200609101003.33802.prakash@punnoor.de>

Am Samstag 09 September 2006 14:50 schrieb Martin Wache:
> Maybe there is a simpler workaround, or it is some bug in the code...

Yes, it seems like it:

Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.16
diff -u -r1.16 SoftOsd.c
--- SoftOsd.c   10 Jul 2006 18:23:28 -0000      1.16
+++ SoftOsd.c   10 Sep 2006 08:02:43 -0000
@@ -1381,10 +1381,10 @@
 #ifdef USE_MMX2
         __asm__ __volatile__ (
                  " pxor %%mm0,%%mm0 \n" //mm0: dest pixel
-                 " movd (%0),%%mm6  \n"
+                 " movd %0,%%mm6  \n"
                  " pshufw $0,%%mm6,%%mm6 \n"// mm6: new_pixel_width_rec
                  " pxor %%mm7,%%mm7 \n" //mm7: 00 00 00 ...
-                 : : "r" (&new_pixel_width_rec)  );
+                 : : "r" (new_pixel_width_rec)  );
 #endif
         SCALEDEBH("OSD_WIDTH: %d dest_width: %d new_pixel_width: %d\n",
                         OSD_WIDTH,dest_Width,new_pixel_width);

Hth,
-- 
(?=                 =?)
//\ Prakash Punnoor /\\
V_/                 \_V
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060910/1ea1c75b/attachment.pgp>

From M.Wache at gmx.net  Sun Sep 10 11:48:55 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 10 Sep 2006 11:48:55 +0200
Subject: [Softdevice-devel] nvidia OSD patches...
In-Reply-To: <200609101003.33802.prakash@punnoor.de>
References: <4501AB36.1010008@gmx.net>
	<200609091357.57631.prakash@punnoor.de>	<4502B8AF.7000408@gmx.net>
	<200609101003.33802.prakash@punnoor.de>
Message-ID: <4503DF87.5040402@gmx.net>

Prakash Punnoor schrieb:
> Am Samstag 09 September 2006 14:50 schrieb Martin Wache:
>> Maybe there is a simpler workaround, or it is some bug in the code...
> 
> Yes, it seems like it:
> 
> Index: SoftOsd.c
> ===================================================================
> RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
> retrieving revision 1.16
> diff -u -r1.16 SoftOsd.c
> --- SoftOsd.c   10 Jul 2006 18:23:28 -0000      1.16
> +++ SoftOsd.c   10 Sep 2006 08:02:43 -0000
> @@ -1381,10 +1381,10 @@
>  #ifdef USE_MMX2
>          __asm__ __volatile__ (
>                   " pxor %%mm0,%%mm0 \n" //mm0: dest pixel
> -                 " movd (%0),%%mm6  \n"
> +                 " movd %0,%%mm6  \n"
>                   " pshufw $0,%%mm6,%%mm6 \n"// mm6: new_pixel_width_rec
>                   " pxor %%mm7,%%mm7 \n" //mm7: 00 00 00 ...
> -                 : : "r" (&new_pixel_width_rec)  );
> +                 : : "r" (new_pixel_width_rec)  );
>  #endif
>          SCALEDEBH("OSD_WIDTH: %d dest_width: %d new_pixel_width: %d\n",
>                          OSD_WIDTH,dest_Width,new_pixel_width);
> 

Yes, this should fix it. To me this looks like a compiler bug, in
SoftOsd.sO2 the initialization of new_pixel_width_rec is moved below
this part of the code. It seems like a reference to the address is not
treated any more as a reference to the value. I don't know the
specification, but I doubt that this is correct.
I will check if this works also with the older compiler version and then
apply this fix.
Thank you, and Chris for your help!

Bye,
Martin


From rahrenbe at cc.hut.fi  Sun Sep 10 22:40:52 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Sun, 10 Sep 2006 23:40:52 +0300 (EEST)
Subject: [Softdevice-devel] [ANNOUNCE] libcle266mpegdec-0.4
Message-ID: <Pine.OSF.4.61.0609102330510.412897@kosh.hut.fi>


Hi,

there's a new 0.4 version of libcle266mpegdec available:

http://sourceforge.net/projects/cle266mpegdec/

2006-09-10: Version 0.4

- Library API changes:
   * CLE266MPEGGetDecoderState now returns additional
     information about the current frame to be displayed.

- Bug fixes:
   * Hardware decoder is now only reset if an error occurs
     during the decode. Resetting before each sequence was
     causing intermittent picture disturbances.
   * Hardware decoder wait function implements a real 2ms
     timeout period.

Also a new decoder plugin for xine, xineplug_decode_cle266-0.1,
is now available for download.

I've attached a patch for softdevice that improves the libcle266mpegdec 
detection and implements some minor API changes in mpeg2decoder.c.

BR,
--
rofa
-------------- next part --------------
Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.24
diff -u -r1.24 configure
--- configure	27 Aug 2006 12:48:46 -0000	1.24
+++ configure	10 Sep 2006 20:07:18 -0000
@@ -324,23 +324,20 @@
 fi
 
 #########################################################
-# cle266mpegdec: check if present
+# libcle266mpegdec: check if version 0.4 or greater is
+# present
 #
 if test "${dfb}" = "yes" ; then
   echo -n "Checking for libcle266mpegdec ... "
-  cle266_cflags=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --cflags libcle266mpegdec 2>>config.log` || cle266="no"
+  pkg-config --atleast-version=0.4 libcle266mpegdec 2>>config.log || cle266="no"
   if test "${cle266}" = "yes" ; then
+    cle266_cflags=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --cflags libcle266mpegdec`
     cle266_libs=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --libs libcle266mpegdec`
     cle266_opts="${cle266_cflags} ${cle266_libs}"
-  fi
-
-  if test "${cle266}" = "yes" ; then
     echo "Enabled cle266 hardware decoding."
   else
     echo "Not found."
   fi
-else
-  cle266="no"
 fi
 
 #########################################################
Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.66
diff -u -r1.66 mpeg2decoder.c
--- mpeg2decoder.c	17 Jun 2006 16:27:34 -0000	1.66
+++ mpeg2decoder.c	10 Sep 2006 20:07:19 -0000
@@ -757,7 +757,7 @@
 };
 
 #ifdef HAVE_CLE266_MPEG_DECODER
-float aspect_ratio_values[5]={1.0, 1.0, 4.0/3.0, 16.0/9.0, 221.0/110 };
+float aspect_ratio_values[5]={1.0, 1.0, 4.0/3.0, 16.0/9.0, 2.21 };
 
 int cVideoStreamDecoder::DecodePicture_cle266(sPicBuffer *&pic, 
                 int &got_picture,uint8_t *data, int length, int64_t pkt_pts) {
@@ -790,9 +790,9 @@
   pic->width = decoder.width;
   pic->height = decoder.height;
   pic->pts = pkt_pts;
-  pic->edge_width=pic->edge_height=0;
-  pic->dtg_active_format = 0; // currently not parsed
-  pic->interlaced_frame = true; // FIXME Do we have that information?
+  pic->edge_width = pic->edge_height = 0;
+  pic->dtg_active_format = decoder.dtg_active_format;
+  pic->interlaced_frame = decoder.progressive_frame ? false : true;
   pic->aspect_ratio = ( decoder.aspect_ratio_info >= 0 
     && decoder.aspect_ratio_info < 5 ) ?
     aspect_ratio_values[decoder.aspect_ratio_info] : 1.0;

From stefan at lucke.in-berlin.de  Sun Sep 10 23:13:47 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 10 Sep 2006 23:13:47 +0200
Subject: [Softdevice-devel] [ANNOUNCE] libcle266mpegdec-0.4
In-Reply-To: <Pine.OSF.4.61.0609102330510.412897@kosh.hut.fi>
References: <Pine.OSF.4.61.0609102330510.412897@kosh.hut.fi>
Message-ID: <200609102313.47094.stefan@lucke.in-berlin.de>

On Sonntag 10 September 2006 22:40, Rolf Ahrenberg wrote:
> 
> Hi,
> 
> there's a new 0.4 version of libcle266mpegdec available:
> 
> http://sourceforge.net/projects/cle266mpegdec/
> 
> 2006-09-10: Version 0.4
> 
> - Library API changes:
>    * CLE266MPEGGetDecoderState now returns additional
>      information about the current frame to be displayed.
> 
> - Bug fixes:
>    * Hardware decoder is now only reset if an error occurs
>      during the decode. Resetting before each sequence was
>      causing intermittent picture disturbances.
>    * Hardware decoder wait function implements a real 2ms
>      timeout period.
> 
> Also a new decoder plugin for xine, xineplug_decode_cle266-0.1,
> is now available for download.
> 
> I've attached a patch for softdevice that improves the libcle266mpegdec 
> detection and implements some minor API changes in mpeg2decoder.c.

Could the be done be a short test of LIBCLE266MPEGDEC_VERSION_INT too ?

#if LIBCLE266MPEGDEC_VERSION_INT >= 4
  pic->dtg_active_format = decoder.dtg_active_format;
  pic->interlaced_frame = decoder.progressive_frame ? false : true;
#else
  pic->dtg_active_format = 0; // currently not parsed
  pic->interlaced_frame = true; // FIXME Do we have that information?
#endif

-- 
Stefan Lucke


From rahrenbe at cc.hut.fi  Sun Sep 10 23:51:38 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Mon, 11 Sep 2006 00:51:38 +0300 (EEST)
Subject: [Softdevice-devel] [ANNOUNCE] libcle266mpegdec-0.4
In-Reply-To: <200609102313.47094.stefan@lucke.in-berlin.de>
References: <Pine.OSF.4.61.0609102330510.412897@kosh.hut.fi>
	<200609102313.47094.stefan@lucke.in-berlin.de>
Message-ID: <Pine.OSF.4.61.0609110045520.157656@kosh.hut.fi>

On Sun, 10 Sep 2006, Stefan Lucke wrote:

> Could the be done be a short test of LIBCLE266MPEGDEC_VERSION_INT too ?

Sure, but these new versions contains many bug fixes, so I really 
recommend everyone to update the library. By removing support of older 
versions in softdevice would do the trick quickly. ;)

However, if you'll add such version tests, remember to modify the 
"--atleast-version" line in configure accordingly.

BR,
--
rofa


From malcolm.caldwell at cdu.edu.au  Mon Sep 11 09:22:04 2006
From: malcolm.caldwell at cdu.edu.au (Malcolm Caldwell)
Date: Mon, 11 Sep 2006 16:52:04 +0930
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <1849e5180609091327t3a6fbb56xd91baeafaa2f1927@mail.gmail.com>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<200609042301.16491.stefan@lucke.in-berlin.de>
	<1849e5180609041617h4579d219i4bf418bbb1a92612@mail.gmail.com>
	<200609051833.51434.stefan@lucke.in-berlin.de>
	<20060906204417.GA2844@localhost.localdomain>
	<1849e5180609071309i38bfb466hcabae8c61ef4ddbf@mail.gmail.com>
	<20060908190545.GA3224@localhost.localdomain>
	<1849e5180609081301y63768487g9a34884dc03c570b@mail.gmail.com>
	<20060909194514.GA2891@localhost.localdomain>
	<1849e5180609091327t3a6fbb56xd91baeafaa2f1927@mail.gmail.com>
Message-ID: <1157959324.3372.38.camel@localhost.localdomain>

On a related front:

Anyone know how to have a "normal" console on the first head at the same
time as mgatv on the second?

On Sat, 2006-09-09 at 21:27 +0100, Alasdair Campbell wrote:
> On 09/09/06, Marko M?kel? <marko.makela-pBLobWGMV7c at public.gmane.org> wrote:
> > The first time I tested with your configuration, I got a picture.
> > "top" indicated 60% CPU usage, which is slightly more than with
> > mgatv.  So, I tried to switch from YUY2 to I420.  The CPU load
> > would drop to around 40%, but the video overlay would be all black.
> > Switching back to YUY2 did affect CPU usage, but the video overlay
> > remained black.  Even rebooting did not help.
> 
> Well when I was fiddling with different modes in softdevice using -vo
> dfb:, I noticed that if I changed away from YUY2, the 2nd head went
> blank, and the video appeared on the 1st head with the wrong colours.
> After changing back to YUY2 I had to reset the STRETCH BLIT option
> just below. It has to be ON for me to see an image. The OSD works
> throughout this.
> 
> don't know why rebooting didn't help though...
> 
> > In the log, I can see messages like this:
> >
> > [dfb] (re)configuring Videolayer to 720 x 576 (720x576)
> > [dfb]: SetParams: failed to set buffermode to back video, reverting to normal
> > [dfb] SetParams: action=IDirectFBDisplayLayer::SetConfiguration(DFBDisplayLayerConfig&), result=Not supported!
> > Can't configure ScreenLocation. Hope it is Fullscreen
> > [surface capabilities] videoSurface: videoonly PixelFormat = 0x00200801
> > [dfb] (re)configured 0x00200806
> >
> > Any ideas?  -vo dfb:mgatv works fine.
> >
> >         Marko
> > _______________________________________________
> > Softdevice-devel mailing list
> > Softdevice-devel-0fE9KPoRgkgATYTw5x5z8w at public.gmane.org
> > https://lists.berlios.de/mailman/listinfo/softdevice-devel
> >
> 
> 



From marko.makela at hut.fi  Mon Sep 11 09:48:43 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 11 Sep 2006 10:48:43 +0300
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <1157959324.3372.38.camel@localhost.localdomain>
References: <200609042301.16491.stefan@lucke.in-berlin.de>
	<1849e5180609041617h4579d219i4bf418bbb1a92612@mail.gmail.com>
	<200609051833.51434.stefan@lucke.in-berlin.de>
	<20060906204417.GA2844@localhost.localdomain>
	<1849e5180609071309i38bfb466hcabae8c61ef4ddbf@mail.gmail.com>
	<20060908190545.GA3224@localhost.localdomain>
	<1849e5180609081301y63768487g9a34884dc03c570b@mail.gmail.com>
	<20060909194514.GA2891@localhost.localdomain>
	<1849e5180609091327t3a6fbb56xd91baeafaa2f1927@mail.gmail.com>
	<1157959324.3372.38.camel@localhost.localdomain>
Message-ID: <20060911074843.GC4385@localhost.localdomain>

On Mon, Sep 11, 2006 at 04:52:04PM +0930, Malcolm Caldwell wrote:
> On a related front:
> 
> Anyone know how to have a "normal" console on the first head at the same
> time as mgatv on the second?

I think I know.  I'll try to post my directfbrcs tonight.  I have
two of them: one for VGA output on primary head, and another one for
-vo dfb:mgatv on the secondary head.  Both allow the console to be used
on the primary head.  I'm using the secondary head only.

Since the console shares the OSD layer of the primary head, the usability
of the primary-head-only setup is a bit limited.  (Also, light grey tiny
text on a bright TV background is often hard to read.)

	Marko


From laz at club-burniston.co.uk  Mon Sep 11 10:46:00 2006
From: laz at club-burniston.co.uk (Laz)
Date: Mon, 11 Sep 2006 09:46:00 +0100
Subject: [Softdevice-devel] [ANNOUNCE] libcle266mpegdec-0.4
In-Reply-To: <Pine.OSF.4.61.0609110045520.157656@kosh.hut.fi>
References: <Pine.OSF.4.61.0609102330510.412897@kosh.hut.fi>
	<200609102313.47094.stefan@lucke.in-berlin.de>
	<Pine.OSF.4.61.0609110045520.157656@kosh.hut.fi>
Message-ID: <200609110946.01130.laz@club-burniston.co.uk>

On Sunday 10 September 2006 22:51, Rolf Ahrenberg wrote:
> On Sun, 10 Sep 2006, Stefan Lucke wrote:
> > Could the be done be a short test of LIBCLE266MPEGDEC_VERSION_INT too
> > ?
>
> Sure, but these new versions contains many bug fixes, so I really
> recommend everyone to update the library. By removing support of older
> versions in softdevice would do the trick quickly. ;)

;)

I've just upgraded to version 0.3 (which worked fine) so I'll have a go at 
0.4 this evening...looks like you might have fixed the nasty blocky 
transitions between different streams, too.

Cheers,

Laz


From marko.makela at hut.fi  Mon Sep 11 21:01:31 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 11 Sep 2006 22:01:31 +0300
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <20060911074843.GC4385@localhost.localdomain>
References: <1849e5180609041617h4579d219i4bf418bbb1a92612@mail.gmail.com>
	<200609051833.51434.stefan@lucke.in-berlin.de>
	<20060906204417.GA2844@localhost.localdomain>
	<1849e5180609071309i38bfb466hcabae8c61ef4ddbf@mail.gmail.com>
	<20060908190545.GA3224@localhost.localdomain>
	<1849e5180609081301y63768487g9a34884dc03c570b@mail.gmail.com>
	<20060909194514.GA2891@localhost.localdomain>
	<1849e5180609091327t3a6fbb56xd91baeafaa2f1927@mail.gmail.com>
	<1157959324.3372.38.camel@localhost.localdomain>
	<20060911074843.GC4385@localhost.localdomain>
Message-ID: <20060911190131.GA2735@localhost.localdomain>

On Mon, Sep 11, 2006 at 10:48:43AM +0300, Marko M?kel? wrote:
> I think I know.  I'll try to post my directfbrcs tonight.  I have
> two of them: one for VGA output on primary head, and another one for
> -vo dfb:mgatv on the secondary head.  Both allow the console to be used
> on the primary head.  I'm using the secondary head only.
> 
> Since the console shares the OSD layer of the primary head, the usability
> of the primary-head-only setup is a bit limited.  (Also, light grey tiny
> text on a bright TV background is often hard to read.)

Attached: directfbrc.vga and directfbrc.mgatv.  I use to symlink either
file to /etc/directfbrc.  Remember to pass -vo dfb or -vo dfb:mgatv
to softdevice.

I believe that DirectFB will pick the first entry from /etc/fb.modes
that matches the specified resolution.  In my case, it'd be 768x576-75
(46.58 kHz and 75 Hz) when I'm using a SVGA monitor.

	Marko
-------------- next part --------------
fbdev=/dev/fb0
mode=768x576
no-banner
no-debug
no-vt
-------------- next part --------------
matrox-crtc2
matrox-tv-standard=pal
matrox-cable-type=scart-rgb
primary-layer=2
hardware
mmx
no-banner
no-vt

From leo at calidae.net  Tue Sep 12 14:20:41 2006
From: leo at calidae.net (=?ISO-8859-1?Q?Leo_M=E1rquez?=)
Date: Tue, 12 Sep 2006 14:20:41 +0200
Subject: [Softdevice-devel] dfb:cle266 or dfb:viatv ?
Message-ID: <4506A619.2090209@calidae.net>

Hi!,

I'm setting a vdr client with an epia-m mobo.
I was thinking in follow this howto:

http://www.mellander.org/per/projects/linux/?chapter=epia-hw-cle266

That uses the cle266 decoder.

Today I have seen that there is an softdevice option called -vo dfb:viatv.

I have to use the s-video out of the epia because I use a normal tv (not 
lcd with vga input).

Whats the diference of this two output methods?
I get good performance with viatv?
cle266 seems to be very good.

What do you think? I'm very confused at this time.

Thanks.

||


From stefan at lucke.in-berlin.de  Tue Sep 12 20:06:42 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 12 Sep 2006 20:06:42 +0200
Subject: [Softdevice-devel] dfb:cle266 or dfb:viatv ?
In-Reply-To: <4506A619.2090209@calidae.net>
References: <4506A619.2090209@calidae.net>
Message-ID: <200609122006.43013.stefan@lucke.in-berlin.de>

On Dienstag 12 September 2006 14:20, Leo M?rquez wrote:
> Hi!,
> 
> I'm setting a vdr client with an epia-m mobo.
> I was thinking in follow this howto:
> 
> http://www.mellander.org/per/projects/linux/?chapter=epia-hw-cle266
> 
> That uses the cle266 decoder.
> 
> Today I have seen that there is an softdevice option called -vo dfb:viatv.
> 
> I have to use the s-video out of the epia because I use a normal tv (not 
> lcd with vga input).
> 
> Whats the diference of this two output methods?

viatv is for TV-out. It sets some flip flags, handling exclusive access of output layer.
cle266 enables use of hw-decoding when it is available.

There is no _exclusive or_  between these option.
For hw-accelerated decoding for TV-out use both:
"-vo dfb:cle266:viatv"
   
> I get good performance with viatv?
> cle266 seems to be very good.
> 
> What do you think? I'm very confused at this time.


-- 
Stefan Lucke


From rahrenbe at cc.hut.fi  Tue Sep 12 20:22:14 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Tue, 12 Sep 2006 21:22:14 +0300 (EEST)
Subject: [Softdevice-devel] dfb:cle266 or dfb:viatv ?
In-Reply-To: <200609122006.43013.stefan@lucke.in-berlin.de>
References: <4506A619.2090209@calidae.net>
	<200609122006.43013.stefan@lucke.in-berlin.de>
Message-ID: <Pine.OSF.4.61.0609122119410.400247@kosh.hut.fi>

On Tue, 12 Sep 2006, Stefan Lucke wrote:

> viatv is for TV-out. It sets some flip flags, handling exclusive access of output layer.
> cle266 enables use of hw-decoding when it is available.
>
> There is no _exclusive or_  between these option.
> For hw-accelerated decoding for TV-out use both:
> "-vo dfb:cle266:viatv"

It would be nice to have this kind of information in README.

--
rofa


From stefan at lucke.in-berlin.de  Tue Sep 12 21:31:34 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 12 Sep 2006 21:31:34 +0200
Subject: [Softdevice-devel] dfb:cle266 or dfb:viatv ?
In-Reply-To: <Pine.OSF.4.61.0609122119410.400247@kosh.hut.fi>
References: <4506A619.2090209@calidae.net>
	<200609122006.43013.stefan@lucke.in-berlin.de>
	<Pine.OSF.4.61.0609122119410.400247@kosh.hut.fi>
Message-ID: <200609122131.34238.stefan@lucke.in-berlin.de>

On Dienstag 12 September 2006 20:22, Rolf Ahrenberg wrote:
> On Tue, 12 Sep 2006, Stefan Lucke wrote:
> 
> > viatv is for TV-out. It sets some flip flags, handling exclusive access of output layer.
> > cle266 enables use of hw-decoding when it is available.
> >
> > There is no _exclusive or_  between these option.
> > For hw-accelerated decoding for TV-out use both:
> > "-vo dfb:cle266:viatv"
> 
> It would be nice to have this kind of information in README.

There has been no new release since integration of cle266. So README
needs some update. Attached is current diff of my working directory.


-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: readme.patch
Type: text/x-diff
Size: 3393 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060912/f5399699/attachment.patch>

From holindho at cs.helsinki.fi  Wed Sep 13 14:44:53 2006
From: holindho at cs.helsinki.fi (Heikki Lindholm)
Date: Wed, 13 Sep 2006 15:44:53 +0300
Subject: [Softdevice-devel] Wrong field order on G400 and some other
	questions
Message-ID: <1158151494.6170.27.camel@marumake>

Hello list,

I just built myself a VDR 1.4.2 setup with a budget DVB-C card and
softdevice. I have a Matrox G400 DualHead outputting to a 16:9 CRT TV
using the composite output. Softdevice almost works, but there are some
things I'd like to have working:
- the displayed field order is wrong, which causes annoying flicker -
seems to be deterministically so; restarts won't help
- audio is off-sync quite a bit
- the VDR OSD is for some reason displayed double height - it seems as
if the OSD was drawn on only one of the fields assuming the field is the
whole frame

At the moment, I'm using today's CVS versions of directfb, DFB++, and
softdevice; ffmpeg is SVN from maybe two days ago. I also tried with
ubuntu breezy's included directfb 0.9.22, which gave a better OSD, but
didn't solve the A/V sync or field order issues. The box I'm using is
really weak, a 450MHz P2, but it seems to struggle along with 80-90% CPU
usage according to vmstat. Mplayer can play recorded .ts's on the box
just fine. The kernel is 2.6.12 from ubuntu configured for the P2 and
G400.

The configuration I use is pretty much copy-pasted blindly from the net:
/etc/directfbrc:
mode=720x576
depth = 32
primary-layer=2
pixelformat=ARGB
matrox-crtc2
matrox-tv-standard=pal
matrox-cable-type=composite

relevant bits from VDR's setup.conf:
softdevice.AC3Mode = 0
softdevice.AlsaAC3Device = hw:0,1
softdevice.AlsaDevice = default
softdevice.avOffset = 0
softdevice.bufferMode = 0
softdevice.CropBottomLines = 0
softdevice.CropLeftCols = 0
softdevice.CropMode = 0
softdevice.CropModeToggleKey = 0
softdevice.CropRightCols = 0
softdevice.CropTopLines = 0
softdevice.Deinterlace Method = 0
softdevice.mainMenu = 1
softdevice.OSDalphablend = 0
softdevice.Picture mirroring = 0
softdevice.PixelAspect = 2
softdevice.PixelFormat = 2
softdevice.Postprocess Method = 0
softdevice.Postprocess Quality = 0
softdevice.Suspend = 0
softdevice.syncTimerMode = 0
softdevice.UseStretchBlit = 1
softdevice.vidBrightness = 50
softdevice.vidContrast = 50
softdevice.vidHue = 50
softdevice.vidSaturation = 50
softdevice.Xv-Aspect = 1

Two somewhat unrelated questions I didn't find an answer for are whether
the /etc/fb.modes file has any effect when using TV output and why to
use "--enable-multi" when configuring directfb for VDR use (some people
seemed to use that, so I did, too).

I'd appreciate if anyone can provide some comments/help on these
problems. 

-- Heikki Lindholm 
 



From leo at calidae.net  Wed Sep 13 22:33:21 2006
From: leo at calidae.net (=?ISO-8859-1?Q?Leo_M=E1rquez?=)
Date: Wed, 13 Sep 2006 22:33:21 +0200
Subject: [Softdevice-devel] problem running dfb:cle255
Message-ID: <45086B11.7090104@calidae.net>

Hi!,

I have followed the fantastic howto:

http://www.mellander.org/per/projects/linux/?chapter=epia-hw-cle266

Every thing seems gone ok but I'm at this point with I try to start vdr.

dori:/usr/src/VDR# ./vdr -P"softdevice -vo dfb:cle266"
[softdevice] processing args
[softdevice]   argv [0] = softdevice
[softdevice]   argv [1] = -vo
vo_argv: dfb:cle266
[softdevice] enabling CLE266 HW decoding
[softdevice] initializing Plugin
[softdevice] Initializing Video Out
[softdevice] ffmpeg build(3345920)
[dfb] init
(*) DirectFB/Config: Parsing config file '/etc/directfbrc'.

       ---------------------- DirectFB v0.9.26 ---------------------
             (c) 2000-2002  convergence integrated media GmbH
             (c) 2002-2004  convergence GmbH
        -----------------------------------------------------------

(*) DirectFB/Core: Single Application Core. (2006-09-11 17:14)
(!) Direct/Modules: Module 'libdirectfb_fbdev.so' did not register 
itself after loading! Trying default module constructor...
(!) Direct/Modules: ... even did not register after explicitly calling 
the module constructor!
(!) DirectFB/core/system: No system found!
[dfb] init EXITING:action=IDirectFB* DirectFB::Create(), result=No 
(suitable) implementation found!

I hope someone understand whats my problem. I don't have the 
knowledgements to understant what is wrong.
A lot of thanks.

Leo.


From stefan at lucke.in-berlin.de  Thu Sep 14 03:10:26 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 14 Sep 2006 03:10:26 +0200
Subject: [Softdevice-devel] g450 interlaced output
In-Reply-To: <1157731910.450196465eb5e@webmail.in-berlin.de>
References: <1849e5180607160937v18db8580n6e27b7c2a4c9fe7c@mail.gmail.com>
	<200609081706.02500.laz@club-burniston.co.uk>
	<1157731910.450196465eb5e@webmail.in-berlin.de>
Message-ID: <200609140310.26953.stefan@lucke.in-berlin.de>

On Freitag 08 September 2006 18:11, Stefan Lucke wrote:
> Quoting Laz:
> 
> > On Thursday 07 September 2006 11:15, Lucian Muresan wrote:
> > > Laz wrote:
> > > [..]
> > >
> > > > I've been vaguely following this but haven't had a chance to test the
> > > > mga output for a while!
> > > >
> > > > Is the OSD still broken for mga output? I ended up backtracking to
> > > > about February CVS a while back to get my OSD working again!
> > >
> > > DirectFB-CVS + Stefan's patch, together with softdevice-CVS works well
> > > now on my G400 TV-out (including OSD), I use Gentoo live CVS ebuilds
> > > for DirectFB and softdevice and I pulled them the day Stefan announced
> > > his fix. The video seems a bit softer than before, or compared to my
> > > domestic STB, and I too noticed some A/V sync issues, but I think
> > > they're not that bad to make the system unusable. I have to admit, I
> > > had very few time lately to use VDR intensively.
> >
> > Have the patches for interlaced blitting made it into DirectFB CVS yet or
> > do they still need to be added by hand? I'm trying to work out whether I
> > will get time to test this this weekend or not!
> 
> Havn't got feedback from Ville on directfb-devel list.
> So you must add them by hand.

Ville's fixes are now in DirectFB cvs :-) .

-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Thu Sep 14 03:11:52 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 14 Sep 2006 03:11:52 +0200
Subject: [Softdevice-devel] Wrong field order on G400 and some other
	questions
In-Reply-To: <1158151494.6170.27.camel@marumake>
References: <1158151494.6170.27.camel@marumake>
Message-ID: <200609140311.52319.stefan@lucke.in-berlin.de>

On Mittwoch 13 September 2006 14:44, Heikki Lindholm wrote:
> Hello list,
> 
> I just built myself a VDR 1.4.2 setup with a budget DVB-C card and
> softdevice. I have a Matrox G400 DualHead outputting to a 16:9 CRT TV
> using the composite output. Softdevice almost works, but there are some
> things I'd like to have working:
> - the displayed field order is wrong, which causes annoying flicker -
> seems to be deterministically so; restarts won't help
> - audio is off-sync quite a bit
> - the VDR OSD is for some reason displayed double height - it seems as
> if the OSD was drawn on only one of the fields assuming the field is the
> whole frame

Displaying issues has been discussed a few days ago. 
See thread: Re: [Softdevice-devel] g450 interlaced output

You need to update your DirectFB version.

-- 
Stefan Lucke


From omge2ri02 at sneakemail.com  Thu Sep 14 10:23:15 2006
From: omge2ri02 at sneakemail.com (CR)
Date: Thu, 14 Sep 2006 01:23:15 -0700 (MST)
Subject: [Softdevice-devel] nvidia OSD patches...fixed!
In-Reply-To: <mailman.27.1157796018.32479.softdevice-devel@lists.berlios.de>
References: <mailman.27.1157796018.32479.softdevice-devel@lists.berlios.de>
Message-ID: <23429-84309@sneakemail.com>

Hi all,

I checked out a CVS copy of softdevice tonight (1:19 AM, Pacific Time,
Sept-14) and the OSD issues with my nVidia card are resolved!

I'm very ecstatic about this, thanks everyone for your hard work!!

I know this has been asked before, what all needs to be done to support
XvMC?  I know there is support for VIA based MPEG2 off-load hopefully that
can be extended to XvMC.

Best regards!
CR.


From holindho at cs.helsinki.fi  Thu Sep 14 11:43:49 2006
From: holindho at cs.helsinki.fi (Heikki Lindholm)
Date: Thu, 14 Sep 2006 12:43:49 +0300
Subject: [Softdevice-devel] Wrong field order on G400 and some
	other	questions
In-Reply-To: <200609140311.52319.stefan@lucke.in-berlin.de>
References: <1158151494.6170.27.camel@marumake>
	<200609140311.52319.stefan@lucke.in-berlin.de>
Message-ID: <1158227029.4252.10.camel@marumake>

to, 2006-09-14 kello 03:11 +0200, Stefan Lucke kirjoitti:
> On Mittwoch 13 September 2006 14:44, Heikki Lindholm wrote:
> > Hello list,
> > 
> > I just built myself a VDR 1.4.2 setup with a budget DVB-C card and
> > softdevice. I have a Matrox G400 DualHead outputting to a 16:9 CRT TV
> > using the composite output. Softdevice almost works, but there are some
> > things I'd like to have working:
> > - the displayed field order is wrong, which causes annoying flicker -
> > seems to be deterministically so; restarts won't help
> > - audio is off-sync quite a bit
> > - the VDR OSD is for some reason displayed double height - it seems as
> > if the OSD was drawn on only one of the fields assuming the field is the
> > whole frame
> 
> Displaying issues has been discussed a few days ago. 
> See thread: Re: [Softdevice-devel] g450 interlaced output

After skimming through the discussion I was under the impression that
the software versions I used should have worked, hence my post.

> You need to update your DirectFB version.

I updated to today's (14.9.) CVS and, indeed, the OSD works now. The
field order issue, however, largely remains. One station that broadcasts
in 352x576 works, but others (704/720) don't. The 352x576 station uses
around 50% CPU and the full D1 broadcasts vary between 60-85% approx. It
doesn't seem like frames are dropped, but could the higher cpu usage
cause timing problems and thus the field order issue? Is there any way
to make softdevice use deeper decode (target) buffering? Btw. I tried
changing the fieldParity variable in video-dfb.c to 1, but it didn't
have any effect. 

-- Heikki Lindholm




From holindho at cs.helsinki.fi  Thu Sep 14 18:51:52 2006
From: holindho at cs.helsinki.fi (Heikki Lindholm)
Date: Thu, 14 Sep 2006 19:51:52 +0300
Subject: [Softdevice-devel] YUY2 on MGA
Message-ID: <1158252712.4252.16.camel@marumake>

Why does the DirectFB driver force PixelFormat to YUY2 when mgatv option
is used? Mplayer works fine with YV12, for example. Or did I overlook
something?

-- Heikki Lindholm




From holindho at cs.helsinki.fi  Sat Sep 16 13:38:18 2006
From: holindho at cs.helsinki.fi (Heikki Lindholm)
Date: Sat, 16 Sep 2006 14:38:18 +0300
Subject: [Softdevice-devel] [PATCH] fix YV12 plane order
Message-ID: <450BE22A.3030905@cs.helsinki.fi>

YV12 has different U/V plane order compared to I420. This patch fixes 
the YUV() method in the dfb driver accordingly. Without the patch YV12 
has wrong colours.

-- Heikki Lindholm
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: patch-softdev-060916-YV12-UVorder.patch
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060916/82397d7d/attachment.ksh>

From stefan at lucke.in-berlin.de  Sat Sep 16 15:25:20 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 16 Sep 2006 15:25:20 +0200
Subject: [Softdevice-devel] [PATCH] fix YV12 plane order
In-Reply-To: <450BE22A.3030905@cs.helsinki.fi>
References: <450BE22A.3030905@cs.helsinki.fi>
Message-ID: <200609161525.20853.stefan@lucke.in-berlin.de>

On Samstag 16 September 2006 13:38, Heikki Lindholm wrote:
> YV12 has different U/V plane order compared to I420. This patch fixes 
> the YUV() method in the dfb driver accordingly. Without the patch YV12 
> has wrong colours.

So you get wrong colors when YV12 is selected.
Do you get wrong colors too when I420 is selected ?

In DirectFB is I420 vs YV12 is swapped. I know that video is YV12. But
we have to specify I420 in DirectFB. With X11 it is YV12 :-).

Look at the code of gfxdriver/radeon/radeon_overlay.c, (line 661):

661                     if (surface->format == DSPF_YV12) {
662                          __u32 tmp  = offsets[1];
663                          offsets[1] = offsets[2];
664                          offsets[2] = tmp;
665                     }

They swap U/V in case of YV12 :-( .

There is to my optinion no need to swap again.

-- 
Stefan Lucke


From M.Wache at gmx.net  Sat Sep 16 15:48:00 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sat, 16 Sep 2006 15:48:00 +0200
Subject: [Softdevice-devel] [PATCH] fix YV12 plane order
In-Reply-To: <200609161525.20853.stefan@lucke.in-berlin.de>
References: <450BE22A.3030905@cs.helsinki.fi>
	<200609161525.20853.stefan@lucke.in-berlin.de>
Message-ID: <450C0090.8050600@gmx.net>

Stefan Lucke schrieb:
> On Samstag 16 September 2006 13:38, Heikki Lindholm wrote:
>> YV12 has different U/V plane order compared to I420. This patch fixes 
>> the YUV() method in the dfb driver accordingly. Without the patch YV12 
>> has wrong colours.
> 
> So you get wrong colors when YV12 is selected.
> Do you get wrong colors too when I420 is selected ?
> 
> In DirectFB is I420 vs YV12 is swapped. I know that video is YV12. But
> we have to specify I420 in DirectFB. With X11 it is YV12 :-).
> 
> Look at the code of gfxdriver/radeon/radeon_overlay.c, (line 661):
> 
> 661                     if (surface->format == DSPF_YV12) {
> 662                          __u32 tmp  = offsets[1];
> 663                          offsets[1] = offsets[2];
> 664                          offsets[2] = tmp;
> 665                     }
> 
> They swap U/V in case of YV12 :-( .
> 
> There is to my optinion no need to swap again.
> 
I guess they swap U and V because the hardware only supports one of the
pixel formats. And in fact I think that makes sense, since exchanging
the pointers in the driver to get the other format is quite simple. So
to the hardware it doesn't matter if YV12 or I420 is selected,
radeon_overlay.c takes care of the swapping of the pointers, and to the
application it looks like there are two different pixel formats.

That means that we have to switch the pointers as well, so that the
hardware gets the correct pointers.
It is done like this in video-xv.c as well, and I can confirm that I
also get wrong colors with my Rage 128pro and my VIAcle266 using DFB.

So I would vote for either apply the patch or a similar one, or remove
either I420 or YV12. In my opinion it makes only sense to be able to
change between the two of them, if the driver is broken.

Bye,
Martin


From holindho at cs.helsinki.fi  Sat Sep 16 16:42:12 2006
From: holindho at cs.helsinki.fi (Heikki Lindholm)
Date: Sat, 16 Sep 2006 17:42:12 +0300
Subject: [Softdevice-devel] [PATCH] fix YV12 plane order
In-Reply-To: <200609161525.20853.stefan@lucke.in-berlin.de>
References: <450BE22A.3030905@cs.helsinki.fi>
	<200609161525.20853.stefan@lucke.in-berlin.de>
Message-ID: <1158417732.5317.5.camel@marumake>

la, 2006-09-16 kello 15:25 +0200, Stefan Lucke kirjoitti:
> On Samstag 16 September 2006 13:38, Heikki Lindholm wrote:
> > YV12 has different U/V plane order compared to I420. This patch fixes 
> > the YUV() method in the dfb driver accordingly. Without the patch YV12 
> > has wrong colours.
> 
> So you get wrong colors when YV12 is selected.

Yes.

> Do you get wrong colors too when I420 is selected ?

No. By the spec the U/V ordering is not the same for the I420 and YV12
color spaces, hence we need to swap pointers somewhere if the source
data (the video) is always in the same format. When looking at different
sources of information, there might well be some inconsistency in what
exactly is the U/V order for the YV12 (or I420.) Anyway, if my patch
works correctly for other hw (I have g400) then it's probably correct.

> In DirectFB is I420 vs YV12 is swapped. I know that video is YV12. But
> we have to specify I420 in DirectFB. With X11 it is YV12 :-).
> 
> Look at the code of gfxdriver/radeon/radeon_overlay.c, (line 661):
> 
> 661                     if (surface->format == DSPF_YV12) {
> 662                          __u32 tmp  = offsets[1];
> 663                          offsets[1] = offsets[2];
> 664                          offsets[2] = tmp;
> 665                     }
> 
> They swap U/V in case of YV12 :-( .
> 
> There is to my optinion no need to swap again.
> 



From stefan at lucke.in-berlin.de  Sat Sep 16 17:59:57 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 16 Sep 2006 17:59:57 +0200
Subject: [Softdevice-devel] [PATCH] fix YV12 plane order
In-Reply-To: <1158417732.5317.5.camel@marumake>
References: <450BE22A.3030905@cs.helsinki.fi>
	<200609161525.20853.stefan@lucke.in-berlin.de>
	<1158417732.5317.5.camel@marumake>
Message-ID: <200609161759.57207.stefan@lucke.in-berlin.de>

On Samstag 16 September 2006 16:42, Heikki Lindholm wrote:
> la, 2006-09-16 kello 15:25 +0200, Stefan Lucke kirjoitti:
> > On Samstag 16 September 2006 13:38, Heikki Lindholm wrote:
> > > YV12 has different U/V plane order compared to I420. This patch fixes 
> > > the YUV() method in the dfb driver accordingly. Without the patch YV12 
> > > has wrong colours.
> > 
> > So you get wrong colors when YV12 is selected.
> 
> Yes.
> 
> > Do you get wrong colors too when I420 is selected ?
> 
> No. By the spec the U/V ordering is not the same for the I420 and YV12
> color spaces, hence we need to swap pointers somewhere if the source
> data (the video) is always in the same format. When looking at different
> sources of information, there might well be some inconsistency in what
> exactly is the U/V order for the YV12 (or I420.) Anyway, if my patch
> works correctly for other hw (I have g400) then it's probably correct.
> 

From naming that would be correct.

I want to explain my argumentation again.
We get some date from the decoder. Ffmpeg's name for that is YV12.
- If we select X11-Xv with YV12 we get correct colors.
- We get correct colors if we convert YV12 -> YUY2 and allocate an X11-Xv surface
  for format YUY2.
- We get correct colors (same decoder + same YV12 -> YUY2 converter) when
  we use a YUY2 surface of directfb.
- Our software OSD converter (RGB -> YV12) produces correct colors too.

By this, it is proven to my opinion that our interpertation of decoded planes is correct.
First plane Y, second plane U and third plane V.

- We have to specify I420 insteadof YV12 for most DirectFB drivers. So DirectFB
  does something bad.

Quoted code from DirectFB is a prove for the fact that they have mixed I420 and YV12,
as it is not executed in case of I420. With I420 we get correct colors.
If they would swap chroma components in case of DSPF_I420 every thing would be fine.

It should be an acceptable action for users to toggle between I420 and YV12 to get
the correct colors. 

We could rename the OSD option to some less technical term if thats an issue.

But I definitly vote against touching a swap in this place.

> > In DirectFB is I420 vs YV12 is swapped. I know that video is YV12. But
> > we have to specify I420 in DirectFB. With X11 it is YV12 :-).
> > 
> > Look at the code of gfxdriver/radeon/radeon_overlay.c, (line 661):
> > 
> > 661                     if (surface->format == DSPF_YV12) {
> > 662                          __u32 tmp  = offsets[1];
> > 663                          offsets[1] = offsets[2];
> > 664                          offsets[2] = tmp;
> > 665                     }
> > 
> > They swap U/V in case of YV12 :-( .
> > 
> > There is to my optinion no need to swap again.
> > 


-- 
Stefan Lucke


From holindho at cs.helsinki.fi  Sat Sep 16 18:31:02 2006
From: holindho at cs.helsinki.fi (Heikki Lindholm)
Date: Sat, 16 Sep 2006 19:31:02 +0300
Subject: [Softdevice-devel] [PATCH] fix YV12 plane order
In-Reply-To: <200609161759.57207.stefan@lucke.in-berlin.de>
References: <450BE22A.3030905@cs.helsinki.fi>
	<200609161525.20853.stefan@lucke.in-berlin.de>
	<1158417732.5317.5.camel@marumake>
	<200609161759.57207.stefan@lucke.in-berlin.de>
Message-ID: <1158424262.5317.23.camel@marumake>

la, 2006-09-16 kello 17:59 +0200, Stefan Lucke kirjoitti:
> On Samstag 16 September 2006 16:42, Heikki Lindholm wrote:
> > la, 2006-09-16 kello 15:25 +0200, Stefan Lucke kirjoitti:
> > > On Samstag 16 September 2006 13:38, Heikki Lindholm wrote:
> > > > YV12 has different U/V plane order compared to I420. This patch fixes 
> > > > the YUV() method in the dfb driver accordingly. Without the patch YV12 
> > > > has wrong colours.
> > > 
> > > So you get wrong colors when YV12 is selected.
> > 
> > Yes.
> > 
> > > Do you get wrong colors too when I420 is selected ?
> > 
> > No. By the spec the U/V ordering is not the same for the I420 and YV12
> > color spaces, hence we need to swap pointers somewhere if the source
> > data (the video) is always in the same format. When looking at different
> > sources of information, there might well be some inconsistency in what
> > exactly is the U/V order for the YV12 (or I420.) Anyway, if my patch
> > works correctly for other hw (I have g400) then it's probably correct.
> > 
> 
> From naming that would be correct.
> 
> I want to explain my argumentation again.
> We get some date from the decoder. Ffmpeg's name for that is YV12.
> - If we select X11-Xv with YV12 we get correct colors.
> - We get correct colors if we convert YV12 -> YUY2 and allocate an X11-Xv surface
>   for format YUY2.
> - We get correct colors (same decoder + same YV12 -> YUY2 converter) when
>   we use a YUY2 surface of directfb.
> - Our software OSD converter (RGB -> YV12) produces correct colors too.
> 
> By this, it is proven to my opinion that our interpertation of decoded planes is correct.
> First plane Y, second plane U and third plane V.
> 
> - We have to specify I420 insteadof YV12 for most DirectFB drivers. So DirectFB
>   does something bad.
> 
> Quoted code from DirectFB is a prove for the fact that they have mixed I420 and YV12,
> as it is not executed in case of I420. With I420 we get correct colors.
> If they would swap chroma components in case of DSPF_I420 every thing would be fine.
> 
> It should be an acceptable action for users to toggle between I420 and YV12 to get
> the correct colors. 

Ok, first, ffmpeg calls it YUV420P, whatever that means. Second, I take
no stance as to whether DirectFB is right or wrong*, all I'm saying is
that (1) AFAIK I420 is not the same is YV12 and, therefore, should not
be handled with the exact same code and (2) my patch works for me. I
have not seen definitions set in stone (I looked from fourcc.org) for
either of the YV12 or I420 colorspaces, so, I cannot really refer to
anything there. I don't care if you apply the patch or not, I simply
sent it in case someone else wonders the wrong colours like me. 

(*) Guessing off hand, the code you pointed in radeon-overlay would
indeed indicate that directfb might be wrong, because they do a swap
when colourspace is YV12, but the hardware constant used to setup the
engine calls its native mode YV12.

-- Heikki Lindholm




From M.Wache at gmx.net  Sat Sep 16 18:54:42 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sat, 16 Sep 2006 18:54:42 +0200
Subject: [Softdevice-devel] [PATCH] fix YV12 plane order
In-Reply-To: <200609161759.57207.stefan@lucke.in-berlin.de>
References: <450BE22A.3030905@cs.helsinki.fi>	<200609161525.20853.stefan@lucke.in-berlin.de>	<1158417732.5317.5.camel@marumake>
	<200609161759.57207.stefan@lucke.in-berlin.de>
Message-ID: <450C2C52.2030701@gmx.net>

Stefan Lucke schrieb:
> On Samstag 16 September 2006 16:42, Heikki Lindholm wrote:
>> la, 2006-09-16 kello 15:25 +0200, Stefan Lucke kirjoitti:
>>> On Samstag 16 September 2006 13:38, Heikki Lindholm wrote:
>>>> YV12 has different U/V plane order compared to I420. This patch fixes 
>>>> the YUV() method in the dfb driver accordingly. Without the patch YV12 
>>>> has wrong colours.
>>> So you get wrong colors when YV12 is selected.
>> Yes.
>>
>>> Do you get wrong colors too when I420 is selected ?
>> No. By the spec the U/V ordering is not the same for the I420 and YV12
>> color spaces, hence we need to swap pointers somewhere if the source
>> data (the video) is always in the same format. When looking at different
>> sources of information, there might well be some inconsistency in what
>> exactly is the U/V order for the YV12 (or I420.) Anyway, if my patch
>> works correctly for other hw (I have g400) then it's probably correct.
>>
> 
>>From naming that would be correct.
> 
> I want to explain my argumentation again.
> We get some date from the decoder. Ffmpeg's name for that is YV12.
> - If we select X11-Xv with YV12 we get correct colors.
> - We get correct colors if we convert YV12 -> YUY2 and allocate an X11-Xv surface
>   for format YUY2.
> - We get correct colors (same decoder + same YV12 -> YUY2 converter) when
>   we use a YUY2 surface of directfb.
> - Our software OSD converter (RGB -> YV12) produces correct colors too.
>
> By this, it is proven to my opinion that our interpertation of decoded planes is correct.
> First plane Y, second plane U and third plane V.
>
I don't doubt that our interpretation of the planes is correct.

> - We have to specify I420 insteadof YV12 for most DirectFB drivers. So DirectFB
>   does something bad.
> 
If you are sure that DirectFB swapped I420 and YV12, then you should ask
them to fix it.

> Quoted code from DirectFB is a prove for the fact that they have mixed I420 and YV12,
> as it is not executed in case of I420. With I420 we get correct colors.
> If they would swap chroma components in case of DSPF_I420 every thing would be fine.
>
> It should be an acceptable action for users to toggle between I420 and YV12 to get
> the correct colors. 
>
I don't think that users should have to work around known bugs in
drivers or programs. Do you know any DirectFB driver which displays YV12
correctly and I420 not? If yes, that one should be fixed or, if you are
right and most of the DirectFB drivers have I420 and YV12 swapped then
all the others should be changed. But one thing is clear to me, if one
driver behaves in an other way then the others, than this is a bug in
DirectFB and should be fixed there.
If we work around bugs all the time, instead of reporting them, no bugs
will ever get fixed.

> We could rename the OSD option to some less technical term if thats an issue.
> 
> But I definitly vote against touching a swap in this place.
>
Whatever DirectFB does, pretending that I420 and YV12 has the same order
of U and V planes is wrong. So in my opinion not swapping the U and V
planes is a bug, but since I don't use DirectFB I don't care.

Thank you Heikki, for the patch. Please don't stop reporting bugs and
sending patches :-)

Bye,
Martin


From holindho at cs.helsinki.fi  Sat Sep 16 19:21:00 2006
From: holindho at cs.helsinki.fi (Heikki Lindholm)
Date: Sat, 16 Sep 2006 20:21:00 +0300
Subject: [Softdevice-devel] [PATCH] make mgatv default to TV output
Message-ID: <450C327C.3090001@cs.helsinki.fi>

I didn't like the need to have "primary-layer=2" in /etc/directfbrc, and 
I also think mgatv output should always go to TV regardless of the 
primary layer. The included patch always defaults both OSD and video 
layers to crtc2 when mgatv option is used.

-- Heikki Lindholm
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: patch-softdev-060916-mgaTV-layers
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060916/2177a51a/attachment.ksh>

From stefan at lucke.in-berlin.de  Sat Sep 16 20:31:43 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 16 Sep 2006 20:31:43 +0200
Subject: [Softdevice-devel] [PATCH] make mgatv default to TV output
In-Reply-To: <450C327C.3090001@cs.helsinki.fi>
References: <450C327C.3090001@cs.helsinki.fi>
Message-ID: <200609162031.43380.stefan@lucke.in-berlin.de>

On Samstag 16 September 2006 19:21, Heikki Lindholm wrote:
> I didn't like the need to have "primary-layer=2" in /etc/directfbrc, and 
> I also think mgatv output should always go to TV regardless of the 
> primary layer. The included patch always defaults both OSD and video 
> layers to crtc2 when mgatv option is used.

Good to know, that even of  my previous replies your are still interested
in some improvements of softdevice.

In case of option mgatv, there are some other parameters of directfbrc
obsolete, like:

  depth = 32
  pixelformat=ARGB

and pal implies:
  matrox-tv-standard=pal
  mode=720x576
ntsc implies:
  matrox-tv-standard=ntsc
  mode=720x480

Passing these parameters to directfb could be done via the Init() call.

char *matroxTvArgs[6] = {
  "depth = 32",
  "pixelformat = ARGB",
  "matrox-crtc2",
  NULL,
  NULL,
  NULL};

dfbInitArgc = 0
dfbInitArgv = NULL;
if (setupstore->useMGAtv) {
  dfbInitArgc = 3;
  dfbInitArgv = matroxTvArgs;
}

DirectFB::Init(dfbInitARgc, dfbInitArgv);

What do you think of such a way ?
I guess we need a way to switch TV-norm on the fly.
Going from PAL to PAL60 depending on current frame duration.

-- 
Stefan Lucke


From holindho at cs.helsinki.fi  Sat Sep 16 21:41:35 2006
From: holindho at cs.helsinki.fi (Heikki Lindholm)
Date: Sat, 16 Sep 2006 22:41:35 +0300
Subject: [Softdevice-devel] [PATCH] make mgatv default to TV output
In-Reply-To: <200609162031.43380.stefan@lucke.in-berlin.de>
References: <450C327C.3090001@cs.helsinki.fi>
	<200609162031.43380.stefan@lucke.in-berlin.de>
Message-ID: <1158435696.11326.14.camel@marumake>

la, 2006-09-16 kello 20:31 +0200, Stefan Lucke kirjoitti:
> On Samstag 16 September 2006 19:21, Heikki Lindholm wrote:
> > I didn't like the need to have "primary-layer=2" in /etc/directfbrc, and 
> > I also think mgatv output should always go to TV regardless of the 
> > primary layer. The included patch always defaults both OSD and video 
> > layers to crtc2 when mgatv option is used.
> 
> Good to know, that even of  my previous replies your are still interested
> in some improvements of softdevice.

Hehe. If you want to scare off people as a maintainer, you still have a
lot to learn - go read glibc-devel and learn from the masters ;) As I
said, I try to post stuff that I think *might* be useful to somebody.
Mailing lists are for discussion, and I really don't expect maintainers
to readily accept patches sent out of nowhere by people they've never
heard of.

> In case of option mgatv, there are some other parameters of directfbrc
> obsolete, like:
> 
>   depth = 32
>   pixelformat=ARGB
> 
> and pal implies:
>   matrox-tv-standard=pal
>   mode=720x576
> ntsc implies:
>   matrox-tv-standard=ntsc
>   mode=720x480
> 
> Passing these parameters to directfb could be done via the Init() call.
> 
> char *matroxTvArgs[6] = {
>   "depth = 32",
>   "pixelformat = ARGB",
>   "matrox-crtc2",
>   NULL,
>   NULL,
>   NULL};
> 
> dfbInitArgc = 0
> dfbInitArgv = NULL;
> if (setupstore->useMGAtv) {
>   dfbInitArgc = 3;
>   dfbInitArgv = matroxTvArgs;
> }
> 
> DirectFB::Init(dfbInitARgc, dfbInitArgv);
> 
> What do you think of such a way ?

The matrox-crtc2 is debatable, I think. Maybe someone who omits it from
directfbrc actually expects programs that try to use crtc2 to fail.

> I guess we need a way to switch TV-norm on the fly.
> Going from PAL to PAL60 depending on current frame duration.

I'm no expert on dfb, but can't the tv norm be changed by any other way
than Init()? Redoing Init() does not sound nice if a mere channel change
would be enough to trigger a norm change.

-- Heikki Lindholm




From rahrenbe at cc.hut.fi  Sat Sep 16 22:06:52 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Sat, 16 Sep 2006 23:06:52 +0300 (EEST)
Subject: [Softdevice-devel] Softdevice & CLE266 support
Message-ID: <Pine.OSF.4.61.0609162252370.405241@kosh.hut.fi>


Hi,

just noticed that you did merge some of my previous CLE266 patch into 
CVS, but missed some portions of it:

- The aspect_ratio_info is somehow 221.0/110 altought it really should 
be 2.21 as defined in Table 6-3 of ISO/IEC 13818-2. What's the story 
behind this non-standard value?

- It seems that you didn't want to remove support from older 
libcle266mpecdec libraries that cannot even be downloaded anywhere 
anymore. :) Anyway I prefer to check the presence of the library with 
pkg-config's "--atleast-version=" instead of "--cflags". If you want to 
support all versions of the library, just use the 
"--atleast-version=0.1" parameter.

BR,
--
rofa
-------------- next part --------------
Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.25
diff -u -r1.25 configure
--- configure	16 Sep 2006 09:30:19 -0000	1.25
+++ configure	16 Sep 2006 19:43:58 -0000
@@ -327,23 +327,19 @@
 fi
 
 #########################################################
-# cle266mpegdec: check if present
+# libcle266mpegdec: check if required version is present
 #
 if test "${dfb}" = "yes" ; then
   echo -n "Checking for libcle266mpegdec ... "
-  cle266_cflags=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --cflags libcle266mpegdec 2>>config.log` || cle266="no"
+  pkg-config --atleast-version=0.2 libcle266mpegdec 2>>config.log || cle266="no"
   if test "${cle266}" = "yes" ; then
+    cle266_cflags=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --cflags libcle266mpegdec`
     cle266_libs=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --libs libcle266mpegdec`
     cle266_opts="${cle266_cflags} ${cle266_libs}"
-  fi
-
-  if test "${cle266}" = "yes" ; then
     echo "Enabled cle266 hardware decoding."
   else
     echo "Not found, not supported by DirectFB or disabled by argument."
   fi
-else
-  cle266="no"
 fi
 
 #########################################################
Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.67
diff -u -r1.67 mpeg2decoder.c
--- mpeg2decoder.c	16 Sep 2006 09:30:19 -0000	1.67
+++ mpeg2decoder.c	16 Sep 2006 19:43:58 -0000
@@ -757,7 +757,7 @@
 };
 
 #ifdef HAVE_CLE266_MPEG_DECODER
-float aspect_ratio_values[5]={1.0, 1.0, 4.0/3.0, 16.0/9.0, 221.0/110 };
+float aspect_ratio_values[5]={1.0, 1.0, 4.0/3.0, 16.0/9.0, 2.21 };
 
 int cVideoStreamDecoder::DecodePicture_cle266(sPicBuffer *&pic,
                 int &got_picture,uint8_t *data, int length, int64_t pkt_pts) {

From stefan at lucke.in-berlin.de  Sat Sep 16 22:34:40 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 16 Sep 2006 22:34:40 +0200
Subject: [Softdevice-devel] Softdevice & CLE266 support
In-Reply-To: <Pine.OSF.4.61.0609162252370.405241@kosh.hut.fi>
References: <Pine.OSF.4.61.0609162252370.405241@kosh.hut.fi>
Message-ID: <200609162234.40182.stefan@lucke.in-berlin.de>

On Samstag 16 September 2006 22:06, Rolf Ahrenberg wrote:
> 
> Hi,
> 
> just noticed that you did merge some of my previous CLE266 patch into 
> CVS, but missed some portions of it:
> 
> - The aspect_ratio_info is somehow 221.0/110 altought it really should 
> be 2.21 as defined in Table 6-3 of ISO/IEC 13818-2. 

I forgot that part.

> What's the story  
> behind this non-standard value?


> 
> - It seems that you didn't want to remove support from older 
> libcle266mpecdec libraries that cannot even be downloaded anywhere 
> anymore. :) 

Just got 0.3 again ;-). This version is still offered when expanding 0.3 mark.

> Anyway I prefer to check the presence of the library with  
> pkg-config's "--atleast-version=" instead of "--cflags". If you want to 
> support all versions of the library, just use the 
> "--atleast-version=0.1" parameter.

On your  announcement I downloaded version 0.3, compiled and 
installed it on my P4 system and went in troubles compiling video-dfb.c
as this directfb version is not patched for cle266 support. So I focused
on that issue. Version check 0.2 is ok I guess.

You patch is in cvs now.

-- 
Stefan Lucke


From herbert at 13thfloor.at  Sun Sep 17 05:37:14 2006
From: herbert at 13thfloor.at (Herbert Poetzl)
Date: Sun, 17 Sep 2006 05:37:14 +0200
Subject: [Softdevice-devel] [PATCH] fix YV12 plane order
In-Reply-To: <200609161759.57207.stefan@lucke.in-berlin.de>
References: <450BE22A.3030905@cs.helsinki.fi>
	<200609161525.20853.stefan@lucke.in-berlin.de>
	<1158417732.5317.5.camel@marumake>
	<200609161759.57207.stefan@lucke.in-berlin.de>
Message-ID: <20060917033714.GA19188@MAIL.13thfloor.at>

On Sat, Sep 16, 2006 at 05:59:57PM +0200, Stefan Lucke wrote:
> On Samstag 16 September 2006 16:42, Heikki Lindholm wrote:
> > la, 2006-09-16 kello 15:25 +0200, Stefan Lucke kirjoitti:
> > > On Samstag 16 September 2006 13:38, Heikki Lindholm wrote:
> > > > YV12 has different U/V plane order compared to I420. This patch fixes 
> > > > the YUV() method in the dfb driver accordingly. Without the patch YV12 
> > > > has wrong colours.
> > > 
> > > So you get wrong colors when YV12 is selected.
> > 
> > Yes.
> > 
> > > Do you get wrong colors too when I420 is selected ?
> > 
> > No. By the spec the U/V ordering is not the same for the I420 and YV12
> > color spaces, hence we need to swap pointers somewhere if the source
> > data (the video) is always in the same format. When looking at different
> > sources of information, there might well be some inconsistency in what
> > exactly is the U/V order for the YV12 (or I420.) Anyway, if my patch
> > works correctly for other hw (I have g400) then it's probably correct.
> > 
> 
> >From naming that would be correct.
> 
> I want to explain my argumentation again.
> We get some date from the decoder. Ffmpeg's name for that is YV12.
> - If we select X11-Xv with YV12 we get correct colors.
> - We get correct colors if we convert YV12 -> YUY2 and allocate an
>   X11-Xv surface for format YUY2.
> - We get correct colors (same decoder + same YV12 -> YUY2 converter) when
>   we use a YUY2 surface of directfb.
> - Our software OSD converter (RGB -> YV12) produces correct colors too.
> 
> By this, it is proven to my opinion that our interpertation of decoded
> planes is correct. First plane Y, second plane U and third plane V.
> 
> - We have to specify I420 insteadof YV12 for most DirectFB drivers. So
> DirectFB does something bad.

just to add some more information into the pool,
here is a list of some good urls to get a feeling
for those formats ...

http://www.fourcc.org/yuv.php
http://wiki.multimedia.cx/index.php?title=I420

HTH,
Herbert

> Quoted code from DirectFB is a prove for the fact that they have mixed
> I420 and YV12, as it is not executed in case of I420. With I420 we
> get correct colors. If they would swap chroma components in case of
> DSPF_I420 every thing would be fine.
>
> It should be an acceptable action for users to toggle between I420 and
> YV12 to get the correct colors.
> 
> We could rename the OSD option to some less technical term if thats an issue.
> 
> But I definitly vote against touching a swap in this place.
> 
> > > In DirectFB is I420 vs YV12 is swapped. I know that video is YV12. But
> > > we have to specify I420 in DirectFB. With X11 it is YV12 :-).
> > > 
> > > Look at the code of gfxdriver/radeon/radeon_overlay.c, (line 661):
> > > 
> > > 661                     if (surface->format == DSPF_YV12) {
> > > 662                          __u32 tmp  = offsets[1];
> > > 663                          offsets[1] = offsets[2];
> > > 664                          offsets[2] = tmp;
> > > 665                     }
> > > 
> > > They swap U/V in case of YV12 :-( .
> > > 
> > > There is to my optinion no need to swap again.
> > > 
> 
> 
> -- 
> Stefan Lucke
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/softdevice-devel


From holindho at cs.helsinki.fi  Sun Sep 17 07:30:58 2006
From: holindho at cs.helsinki.fi (Heikki Lindholm)
Date: Sun, 17 Sep 2006 08:30:58 +0300
Subject: [Softdevice-devel] [PATCH] fix YV12 plane order
In-Reply-To: <200609161759.57207.stefan@lucke.in-berlin.de>
References: <450BE22A.3030905@cs.helsinki.fi>
	<200609161525.20853.stefan@lucke.in-berlin.de>
	<1158417732.5317.5.camel@marumake>
	<200609161759.57207.stefan@lucke.in-berlin.de>
Message-ID: <1158471058.26913.7.camel@marumake>

la, 2006-09-16 kello 17:59 +0200, Stefan Lucke kirjoitti:
> On Samstag 16 September 2006 16:42, Heikki Lindholm wrote:
> > la, 2006-09-16 kello 15:25 +0200, Stefan Lucke kirjoitti:
> > > On Samstag 16 September 2006 13:38, Heikki Lindholm wrote:
> > > > YV12 has different U/V plane order compared to I420. This patch fixes 
> > > > the YUV() method in the dfb driver accordingly. Without the patch YV12 
> > > > has wrong colours.
> > > 
> > > So you get wrong colors when YV12 is selected.
> > 
> > Yes.
> > 
> > > Do you get wrong colors too when I420 is selected ?
> > 
> > No. By the spec the U/V ordering is not the same for the I420 and YV12
> > color spaces, hence we need to swap pointers somewhere if the source
> > data (the video) is always in the same format. When looking at different
> > sources of information, there might well be some inconsistency in what
> > exactly is the U/V order for the YV12 (or I420.) Anyway, if my patch
> > works correctly for other hw (I have g400) then it's probably correct.
> > 
> 
> From naming that would be correct.
> 
> I want to explain my argumentation again.
> We get some date from the decoder. Ffmpeg's name for that is YV12.
> - If we select X11-Xv with YV12 we get correct colors.
> - We get correct colors if we convert YV12 -> YUY2 and allocate an X11-Xv surface
>   for format YUY2.
> - We get correct colors (same decoder + same YV12 -> YUY2 converter) when
>   we use a YUY2 surface of directfb.
> - Our software OSD converter (RGB -> YV12) produces correct colors too.

Here's my final take on the matter:
* assume that the pointers Py,Pu,Pv always point to correct planes
* xv works because you do a swap there, too (search for FOURCC_YV12)
* YV12->YUY2 conversion works because it uses the pointers to the planes
and not just a picture data starting address, ie. it doesn't care if the
memory layout is Y,U,V or Y,V,U. This applies to the DFB YUY2 case, too
* the copying routine in videoDFB::YUV() lays out the planes in Y,U,V
order, but YV12 should be in Y,V,U order. That's why I420 works there
and YV12 does not without swapping

-- Heikki Lindholm



From holindho at cs.helsinki.fi  Sun Sep 17 07:42:45 2006
From: holindho at cs.helsinki.fi (Heikki Lindholm)
Date: Sun, 17 Sep 2006 08:42:45 +0300
Subject: [Softdevice-devel] [PATCH] make mgatv default to TV output
In-Reply-To: <200609162031.43380.stefan@lucke.in-berlin.de>
References: <450C327C.3090001@cs.helsinki.fi>
	<200609162031.43380.stefan@lucke.in-berlin.de>
Message-ID: <1158471765.26913.11.camel@marumake>

la, 2006-09-16 kello 20:31 +0200, Stefan Lucke kirjoitti:
> On Samstag 16 September 2006 19:21, Heikki Lindholm wrote:
> > I didn't like the need to have "primary-layer=2" in /etc/directfbrc, and 
> > I also think mgatv output should always go to TV regardless of the 
> > primary layer. The included patch always defaults both OSD and video 
> > layers to crtc2 when mgatv option is used.
> 
> Good to know, that even of  my previous replies your are still interested
> in some improvements of softdevice.
> 
> In case of option mgatv, there are some other parameters of directfbrc
> obsolete, like:
> 
>   depth = 32
>   pixelformat=ARGB
> 
> and pal implies:
>   matrox-tv-standard=pal
>   mode=720x576
> ntsc implies:
>   matrox-tv-standard=ntsc
>   mode=720x480
> 
> Passing these parameters to directfb could be done via the Init() call.
> 
> char *matroxTvArgs[6] = {
>   "depth = 32",
>   "pixelformat = ARGB",
>   "matrox-crtc2",
>   NULL,
>   NULL,
>   NULL};
> 
> dfbInitArgc = 0
> dfbInitArgv = NULL;
> if (setupstore->useMGAtv) {
>   dfbInitArgc = 3;
>   dfbInitArgv = matroxTvArgs;
> }
> 
> DirectFB::Init(dfbInitARgc, dfbInitArgv);
> 
> What do you think of such a way ?
> I guess we need a way to switch TV-norm on the fly.
> Going from PAL to PAL60 depending on current frame duration.

Just for the record, my motivation for the patch was easy switching
between a CRT TV in the second head and an LCD in the first head.
Actually, it'd be splendid if the output device could be configured
runtime from the VDR menu, similar to what many DVB settop boxes allow.

-- Heikki Lindholm




From public.testasecca at gmail.com  Sun Sep 17 11:33:08 2006
From: public.testasecca at gmail.com (Testasecca public mail)
Date: Sun, 17 Sep 2006 11:33:08 +0200
Subject: [Softdevice-devel] directfb viafb + EPIA M10000, TVOUT problem
Message-ID: <cf1d50160609170233p43318291p8906a6b48572c03c@mail.gmail.com>

Hi all,

I'm new to the list, and of course with a problem ....

I'm a trying to install a TV Box running VDR on an EPIA M 10000 board, under
Ubuntu (server install), kernel version is 2.6.15-23-386.

I want VDR running onto the framebuffer throw softdevice plugin, and i want
hardware MPEG acceleration.

So, i found this nice tutorial :
http://www.mellander.org/per/projects/linux/?chapter=epia-hw-cle266 ...

Everything works perfectly on my PC monitor, i got : the famebuffer console,
i can see VDR interface, decode an MPEG stream with acceleration ...

BUT my TV screen goes crazy ! It  is activated but  completly scrambled,
there is some lines ( looks like interlacing problems ??, the image is
shifted, duplicated .... ).

This problems comes just after viafb/fbcon module inserting,  so there'is no
problem with DiretFB, or DF++ or VDR, the problems comes from viafb module.

I have configured into the BIOS (TV+CRT, 800x600, PAL (i'm in france),
direct access to framebuffer .... ).
Then i load the module :
sudo insmod viafb.ko TVon=0    # (0 is for enable, i tried without options,
same results ...)

When i insert the viafb module, dmesg gives :

[4296000.354000] viafb: VIA UNICHROME framebuffer 1.0 initializing
[4296000.356000] viafb: viafb : CEF00000
[4296000.356000] viafb: framebuffer size = 32 Mb
[4296000.356000] viafb: Found Device Rev:0
[4296000.357000] viafb: X:800 Y:600
[4296000.357000] viafb: mode=800  bpp=32  refresh=50  TVon=0  TVtype=2
[4296000.357000] viafb: VQ start:1FC0000  end:1FFFFFF  size:40000
[4296000.357000] viafb: Cursor start:1FBF000  end:1FBFFFF  size:1000
[4296000.358000] viafb: mode=800  bpp=32  refresh=255  TVon=0  TVtype=2
[ 4296000.358000] viafb: irq handler installed, IRQ(0x200) = 80080c02
[4296000.371000] Console: switching to colour frame buffer device 100x37
[4296000.371000] fb0: UNICHROME frame buffer device

At this time an fbset gives me :
mode "720x576-74"
    # D: 41.475 MHz, H: 44.693 kHz, V: 74.488 Hz
    geometry 720 576 720 1152 32
    timings 24111 88 32 16 4 88 4
    rgba 8/16,8/8,8/0,8/24
endmode

and fbset -i :
Frame buffer device information:
    Name        : UNICHROME
    Address     : 0xd8000000
    Size        : 33288192
    Type        : PACKED PIXELS
    Visual      : TRUECOLOR
    XPanStep    : 0
    YPanStep    : 1
    YWrapStep   : 0
    LineLength  : 2880
    MMIO Address: 0xdc000000
    MMIO Size   : 16777216
    Accelerator : Unknown (77)


So i do a fbset "720x576-50" with this definition :
mode "720x576-50"
    geometry 720 576 720 576 16
    timings 35714 32 8 46 0 136 3
    bcast true # request overscan with (modified) viafb
endmode

then the set gives :
mode "720x576-50"
    # D: 28.000 MHz, H: 31.250 kHz, V: 50.000 Hz
    geometry 720 576 720 576 16
    timings 35714 32 8 46 0 136 3
    bcast true
    accel true
    rgba 5/11,6/5,5/0,0/0
endmode

That's weird, everything is working on PC screen, and not on TV !

I tried a patch to the kernel from VDR Eclipse site, with the same bad
results. (
http://vdr.bluox.org/download/epia/viafb_03-720x576noscale-2.6.14.patch.bz2)

I've also tried via driver and TV out works  (with the same fb.modes) but is
really slow ! I can't decode an MPEG stream with this !

I'm a little bit disapointed ! Please Help ! :)

Some not directly related questions :
Do you know how to prevent fbcon module insertion at boot time ? ( I tried
to remove it from /lib/modules/ ... and it was stille loaded after reboot
!!! Magik ? Initrd ?

Do you know how to force a power off on an USB device?  i want to stop USB
power supply to my DVB-T USB device to make a hard reset to it, it seems to
very stable ....

Thanks in advance for your help ...
Cheers
Tom

I also posted on directfb-users

-- 
Cheers,
Thomas TESTASECCA

(o-
// \        In a world without walls and fences, who needs Windows and Gates
?
\/_/_
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060917/5172b1dc/attachment.html>

From public.testasecca at gmail.com  Sun Sep 17 13:20:28 2006
From: public.testasecca at gmail.com (Public TESTASECCA)
Date: Sun, 17 Sep 2006 13:20:28 +0200
Subject: [Softdevice-devel] directfb viafb + EPIA M10000, TVOUT problem
In-Reply-To: <cf1d50160609170233p43318291p8906a6b48572c03c@mail.gmail.com>
References: <cf1d50160609170233p43318291p8906a6b48572c03c@mail.gmail.com>
Message-ID: <1158492028.8052.15.camel@tubuntu>


I realized, i have not posted the rigth dmesg trace ...

[4303339.616000] viafb: VIA UNICHROME framebuffer 1.0 initializing
[4303339.617000] via_pci_probe:io_base_phy : DC000000
[4303339.617000] via_pci_probe:io_size     : 1000000
[4303339.618000] viafb: viafb : CEF00000
[4303339.618000] via_pci_probe:viafb : 1000000
[4303339.618000] via_pci_probe:viafb_fix.mmio_start : DC000000
[4303339.618000] via_pci_probe:mem_base_phy  : D8000000
[4303339.618000] viafb: framebuffer size = 32 Mb
[4303339.618000] via_pci_probe:mem_size : 2000000
[4303339.619000] viafb: Found Device Rev:0
[4303339.619000] viafb: X:720 Y:576
[4303339.619000] viafb: mode=720  bpp=32  refresh=255  TVon=0  TVtype=2
[4303339.620000] viafb: VQ start:1FC0000  end:1FFFFFF  size:40000
[4303339.620000] viafb: Cursor start:1FBF000  end:1FBFFFF  size:1000
[4303339.620000] viafb: mode=720  bpp=32  refresh=255  TVon=0  TVtype=2
[4303339.620000] viafb: irq handler installed, IRQ(0x200) = 80080c00
[4303339.624000] viafb_set_par:Set_Par x:720 y:576 bpp:32 vxres:720
vyres:1152
[4303339.624000] setmode:setmode fount mode:75
[4303339.624000] viafb_pan_display:pan_display
[4303339.626000] viafb_pan_display:pan_display
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:0 r:0 g:0 b:0 t:FFFF
bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:1 r:0 g:0 b:AAAA t:FFFF
bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:2 r:0 g:AAAA b:0 t:FFFF
bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:3 r:0 g:AAAA b:AAAA
t:FFFF bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:4 r:AAAA g:0 b:0 t:FFFF
bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:5 r:AAAA g:0 b:AAAA
t:FFFF bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:6 r:AAAA g:5555 b:0
t:FFFF bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:7 r:AAAA g:AAAA b:AAAA
t:FFFF bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:8 r:5555 g:5555 b:5555
t:FFFF bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:9 r:5555 g:5555 b:FFFF
t:FFFF bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:10 r:5555 g:FFFF b:5555
t:FFFF bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:11 r:5555 g:FFFF b:FFFF
t:FFFF bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:12 r:FFFF g:5555 b:5555
t:FFFF bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:13 r:FFFF g:5555 b:FFFF
t:FFFF bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:14 r:FFFF g:FFFF b:5555
t:FFFF bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:15 r:FFFF g:FFFF b:FFFF
t:FFFF bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:0 r:0 g:0 b:0 t:FFFF
bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:1 r:0 g:0 b:AAAA t:FFFF
bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:2 r:0 g:AAAA b:0 t:FFFF
bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:3 r:0 g:AAAA b:AAAA
t:FFFF bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:4 r:AAAA g:0 b:0 t:FFFF
bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:5 r:AAAA g:0 b:AAAA
t:FFFF bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:6 r:AAAA g:5555 b:0
t:FFFF bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:7 r:AAAA g:AAAA b:AAAA
t:FFFF bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:8 r:5555 g:5555 b:5555
t:FFFF bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:9 r:5555 g:5555 b:FFFF
t:FFFF bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:10 r:5555 g:FFFF b:5555
t:FFFF bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:11 r:5555 g:FFFF b:FFFF
t:FFFF bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:12 r:FFFF g:5555 b:5555
t:FFFF bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:13 r:FFFF g:5555 b:FFFF
t:FFFF bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:14 r:FFFF g:FFFF b:5555
t:FFFF bpp: 32
[4303339.626000] viafb_setcolreg:set_colreg
[4303339.626000] viafb_setcolreg:set_col_reg reg:15 r:FFFF g:FFFF b:FFFF
t:FFFF bpp: 32
[4303339.629000] viafb_pan_display:pan_display
[4303339.629000] viafb_setcolreg:set_colreg
[4303339.629000] viafb_setcolreg:set_col_reg reg:0 r:0 g:0 b:0 t:FFFF
bpp: 32
[4303339.629000] viafb_setcolreg:set_colreg
[4303339.629000] viafb_setcolreg:set_col_reg reg:1 r:0 g:0 b:AAAA t:FFFF
bpp: 32
[4303339.629000] viafb_setcolreg:set_colreg
[4303339.629000] viafb_setcolreg:set_col_reg reg:2 r:0 g:AAAA b:0 t:FFFF
bpp: 32
[4303339.629000] viafb_setcolreg:set_colreg
[4303339.629000] viafb_setcolreg:set_col_reg reg:3 r:0 g:AAAA b:AAAA
t:FFFF bpp: 32
[4303339.629000] viafb_setcolreg:set_colreg
[4303339.629000] viafb_setcolreg:set_col_reg reg:4 r:AAAA g:0 b:0 t:FFFF
bpp: 32
[4303339.629000] viafb_setcolreg:set_colreg
[4303339.629000] viafb_setcolreg:set_col_reg reg:5 r:AAAA g:0 b:AAAA
t:FFFF bpp: 32
[4303339.629000] viafb_setcolreg:set_colreg
[4303339.629000] viafb_setcolreg:set_col_reg reg:6 r:AAAA g:5555 b:0
t:FFFF bpp: 32
[4303339.629000] viafb_setcolreg:set_colreg
[4303339.629000] viafb_setcolreg:set_col_reg reg:7 r:AAAA g:AAAA b:AAAA
t:FFFF bpp: 32
[4303339.629000] viafb_setcolreg:set_colreg
[4303339.629000] viafb_setcolreg:set_col_reg reg:8 r:5555 g:5555 b:5555
t:FFFF bpp: 32
[4303339.629000] viafb_setcolreg:set_colreg
[4303339.629000] viafb_setcolreg:set_col_reg reg:9 r:5555 g:5555 b:FFFF
t:FFFF bpp: 32
[4303339.630000] viafb_setcolreg:set_colreg
[4303339.630000] viafb_setcolreg:set_col_reg reg:10 r:5555 g:FFFF b:5555
t:FFFF bpp: 32
[4303339.630000] viafb_setcolreg:set_colreg
[4303339.630000] viafb_setcolreg:set_col_reg reg:11 r:5555 g:FFFF b:FFFF
t:FFFF bpp: 32
[4303339.630000] viafb_setcolreg:set_colreg
[4303339.630000] viafb_setcolreg:set_col_reg reg:12 r:FFFF g:5555 b:5555
t:FFFF bpp: 32
[4303339.630000] viafb_setcolreg:set_colreg
[4303339.630000] viafb_setcolreg:set_col_reg reg:13 r:FFFF g:5555 b:FFFF
t:FFFF bpp: 32
[4303339.630000] viafb_setcolreg:set_colreg
[4303339.630000] viafb_setcolreg:set_col_reg reg:14 r:FFFF g:FFFF b:5555
t:FFFF bpp: 32
[4303339.630000] viafb_setcolreg:set_colreg
[4303339.630000] viafb_setcolreg:set_col_reg reg:15 r:FFFF g:FFFF b:FFFF
t:FFFF bpp: 32
[4303339.632000] viafb_setcolreg:set_colreg
[4303339.632000] viafb_setcolreg:set_col_reg reg:0 r:0 g:0 b:0 t:FFFF
bpp: 32
[4303339.632000] viafb_setcolreg:set_colreg
[4303339.632000] viafb_setcolreg:set_col_reg reg:1 r:0 g:0 b:AAAA t:FFFF
bpp: 32
[4303339.632000] viafb_setcolreg:set_colreg
[4303339.632000] viafb_setcolreg:set_col_reg reg:2 r:0 g:AAAA b:0 t:FFFF
bpp: 32
[4303339.632000] viafb_setcolreg:set_colreg
[4303339.632000] viafb_setcolreg:set_col_reg reg:3 r:0 g:AAAA b:AAAA
t:FFFF bpp: 32
[4303339.632000] viafb_setcolreg:set_colreg
[4303339.632000] viafb_setcolreg:set_col_reg reg:4 r:AAAA g:0 b:0 t:FFFF
bpp: 32
[4303339.632000] viafb_setcolreg:set_colreg
[4303339.632000] viafb_setcolreg:set_col_reg reg:5 r:AAAA g:0 b:AAAA
t:FFFF bpp: 32
[4303339.632000] viafb_setcolreg:set_colreg
[4303339.632000] viafb_setcolreg:set_col_reg reg:6 r:AAAA g:5555 b:0
t:FFFF bpp: 32
[4303339.632000] viafb_setcolreg:set_colreg
[4303339.632000] viafb_setcolreg:set_col_reg reg:7 r:AAAA g:AAAA b:AAAA
t:FFFF bpp: 32
[4303339.633000] viafb_setcolreg:set_colreg
[4303339.633000] viafb_setcolreg:set_col_reg reg:8 r:5555 g:5555 b:5555
t:FFFF bpp: 32
[4303339.633000] viafb_setcolreg:set_colreg
[4303339.633000] viafb_setcolreg:set_col_reg reg:9 r:5555 g:5555 b:FFFF
t:FFFF bpp: 32
[4303339.633000] viafb_setcolreg:set_colreg
[4303339.633000] viafb_setcolreg:set_col_reg reg:10 r:5555 g:FFFF b:5555
t:FFFF bpp: 32
[4303339.633000] viafb_setcolreg:set_colreg
[4303339.633000] viafb_setcolreg:set_col_reg reg:11 r:5555 g:FFFF b:FFFF
t:FFFF bpp: 32
[4303339.633000] viafb_setcolreg:set_colreg
[4303339.633000] viafb_setcolreg:set_col_reg reg:12 r:FFFF g:5555 b:5555
t:FFFF bpp: 32
[4303339.633000] viafb_setcolreg:set_colreg
[4303339.633000] viafb_setcolreg:set_col_reg reg:13 r:FFFF g:5555 b:FFFF
t:FFFF bpp: 32
[4303339.633000] viafb_setcolreg:set_colreg
[4303339.633000] viafb_setcolreg:set_col_reg reg:14 r:FFFF g:FFFF b:5555
t:FFFF bpp: 32
[4303339.633000] viafb_setcolreg:set_colreg
[4303339.633000] viafb_setcolreg:set_col_reg reg:15 r:FFFF g:FFFF b:FFFF
t:FFFF bpp: 32
[4303339.633000] Console: switching to colour frame buffer device 90x36
[4303339.656000] setmode:setmode fount mode:75
[4303339.657000] viafb_pan_display:pan_display
[4303339.657000] fb0: UNICHROME frame buffer device



Le dimanche 17 septembre 2006 ? 11:33 +0200, Testasecca public mail a
?crit :
> Hi all,
> 
> I'm new to the list, and of course with a problem .... 
> 
> I'm a trying to install a TV Box running VDR on an EPIA M 10000 board,
> under Ubuntu (server install), kernel version is 2.6.15-23-386.
> 
> I want VDR running onto the framebuffer throw softdevice plugin, and i
> want hardware MPEG acceleration. 
> 
> So, i found this nice tutorial :
> http://www.mellander.org/per/projects/linux/?chapter=epia-hw-cle266 ...
>  
> Everything works perfectly on my PC monitor, i got : the famebuffer
> console, i can see VDR interface, decode an MPEG stream with
> acceleration ... 
> 
> BUT my TV screen goes crazy ! It  is activated but  completly
> scrambled, there is some lines ( looks like interlacing problems ??,
> the image is shifted, duplicated .... ).
> 
> This problems comes just after viafb/fbcon module inserting,  so
> there'is no problem with DiretFB, or DF++ or VDR, the problems comes
> from viafb module. 
> 
> I have configured into the BIOS (TV+CRT, 800x600, PAL (i'm in france),
> direct access to framebuffer .... ).
> Then i load the module :
> sudo insmod viafb.ko TVon=0    # (0 is for enable, i tried without
> options, same results ...) 
> 
> When i insert the viafb module, dmesg gives :
> 
> [4296000.354000] viafb: VIA UNICHROME framebuffer 1.0 initializing
> [4296000.356000] viafb: viafb : CEF00000
> [4296000.356000] viafb: framebuffer size = 32 Mb 
> [4296000.356000] viafb: Found Device Rev:0
> [4296000.357000] viafb: X:800 Y:600
> [4296000.357000] viafb: mode=800  bpp=32  refresh=50  TVon=0  TVtype=2
> [4296000.357000] viafb: VQ start:1FC0000  end:1FFFFFF  size:40000 
> [4296000.357000] viafb: Cursor start:1FBF000  end:1FBFFFF  size:1000
> [4296000.358000] viafb: mode=800  bpp=32  refresh=255  TVon=0
> TVtype=2
> [ 4296000.358000] viafb: irq handler installed, IRQ(0x200) = 80080c02
> [4296000.371000] Console: switching to colour frame buffer device
> 100x37
> [4296000.371000] fb0: UNICHROME frame buffer device
> 
> At this time an fbset gives me :
> mode "720x576-74"
>     # D: 41.475 MHz, H: 44.693 kHz, V: 74.488 Hz
>     geometry 720 576 720 1152 32
>     timings 24111 88 32 16 4 88 4
>     rgba 8/16,8/8,8/0,8/24
> endmode
> 
> and fbset -i :
> Frame buffer device information:
>     Name        : UNICHROME 
>     Address     : 0xd8000000
>     Size        : 33288192
>     Type        : PACKED PIXELS
>     Visual      : TRUECOLOR
>     XPanStep    : 0
>     YPanStep    : 1
>     YWrapStep   : 0
>     LineLength  : 2880 
>     MMIO Address: 0xdc000000
>     MMIO Size   : 16777216
>     Accelerator : Unknown (77)
> 
> 
> So i do a fbset "720x576-50" with this definition :
> mode "720x576-50"
>     geometry 720 576 720 576 16 
>     timings 35714 32 8 46 0 136 3
>     bcast true # request overscan with (modified) viafb
> endmode
> 
> then the set gives :
> mode "720x576-50"
>     # D: 28.000 MHz, H: 31.250 kHz, V: 50.000 Hz
>     geometry 720 576 720 576 16
>     timings 35714 32 8 46 0 136 3
>     bcast true
>     accel true
>     rgba 5/11,6/5,5/0,0/0
> endmode
> 
> That's weird, everything is working on PC screen, and not on TV !
> 
> I tried a patch to the kernel from VDR Eclipse site, with the same bad
> results.
> ( http://vdr.bluox.org/download/epia/viafb_03-720x576noscale-2.6.14.patch.bz2)
> 
> I've also tried via driver and TV out works  (with the same fb.modes)
> but is really slow ! I can't decode an MPEG stream with this !
> 
> I'm a little bit disapointed ! Please Help ! :)
> 
> Some not directly related questions : 
> Do you know how to prevent fbcon module insertion at boot time ? ( I
> tried to remove it from /lib/modules/ ... and it was stille loaded
> after reboot !!! Magik ? Initrd ?
> 
> Do you know how to force a power off on an USB device?  i want to stop
> USB power supply to my DVB-T USB device to make a hard reset to it, it
> seems to very stable .... 
> 
> Thanks in advance for your help ...
> Cheers
> Tom
> 
> I also posted on directfb-users
> 
> -- 
> Cheers,
> Thomas TESTASECCA
> 
> (o-                                                                         
> // \        In a world without walls and fences, who needs Windows and
> Gates ?
> \/_/_



From torgeir at pobox.com  Sun Sep 17 13:39:56 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Sun, 17 Sep 2006 12:39:56 +0100
Subject: [Softdevice-devel] cle266 hw decoding
Message-ID: <1E9F6C90-1835-4B06-BBF9-CCC0DEC9046F@pobox.com>

Does this work yet on CN400/700 based boards when not using the tv  
encoder?

-- 
Torgeir Veimo
torgeir at pobox.com



-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060917/c8107e3f/attachment.html>

From holindho at cs.helsinki.fi  Sun Sep 17 19:33:37 2006
From: holindho at cs.helsinki.fi (Heikki Lindholm)
Date: Sun, 17 Sep 2006 20:33:37 +0300
Subject: [Softdevice-devel] [PATCH] Enable mgatv spic and YV12
Message-ID: <450D86F1.1030200@cs.helsinki.fi>

The included patch makes dfb:mgatv use YV12 colourspace for video and 
the hardware subpicture layer for OSD. The patch is a prime example of 
bad goal-oriented programming, but does what I wanted: improves 
performance to the level that my 450 MHz P2 can now function as a DVB 
box like no underpowered P2 has done before! Unfortunately, the patch 
probably breaks everything else, but I'm too lazy to clean it up.

-- Heikki Lindholm
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: softdevice-060917-mgatv-spic.patch
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060917/2d9701b9/attachment.ksh>

From stefan at lucke.in-berlin.de  Sun Sep 17 20:09:28 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 17 Sep 2006 20:09:28 +0200
Subject: [Softdevice-devel] troubles with new svn version of ffmpeg
Message-ID: <200609172009.28837.stefan@lucke.in-berlin.de>

Hi,

according to this thread of vdr-portal (in german):

http://www.vdr-portal.de/board/thread.php?threadid=54787

we can expect some troubles with ffmpeg versions newer than 2006-08-26.

-- 
Stefan Lucke


From public.testasecca at gmail.com  Sun Sep 17 20:42:11 2006
From: public.testasecca at gmail.com (Testasecca public mail)
Date: Sun, 17 Sep 2006 20:42:11 +0200
Subject: [Softdevice-devel] directfb viafb + EPIA M10000, TVOUT problem
In-Reply-To: <1158492028.8052.15.camel@tubuntu>
References: <cf1d50160609170233p43318291p8906a6b48572c03c@mail.gmail.com>
	<1158492028.8052.15.camel@tubuntu>
Message-ID: <cf1d50160609171142q2b0e89c4icc421f349bb5bede@mail.gmail.com>

The problem comes from TVon=0, to activate the TV out you definitely have to
put TVon=1 !!!!!!!

I won't try to justify me on this .... but the readme.txt says :

TVon=<0|1>       - enable/disable TV output (default 0)
TVtype=<0|1|2>   - set TV type to none/NTSC/PAL (default PAL)
TVoverscan=<0|1> - enable/disable overscan mode (default 0)

so i deduced 0=enable 1=disable ...

all this time lost for this stupid and so logic TVon=1 ;)

Fine, now i have a nice TVout.

2006/9/17, Public TESTASECCA <public.testasecca at gmail.com>:
>
>
> I realized, i have not posted the rigth dmesg trace ...
>
> [4303339.616000] viafb: VIA UNICHROME framebuffer 1.0 initializing
> [4303339.617000] via_pci_probe:io_base_phy : DC000000
> [4303339.617000] via_pci_probe:io_size     : 1000000
> [4303339.618000] viafb: viafb : CEF00000
> [4303339.618000] via_pci_probe:viafb : 1000000
> [4303339.618000] via_pci_probe:viafb_fix.mmio_start : DC000000
> [4303339.618000] via_pci_probe:mem_base_phy  : D8000000
> [4303339.618000] viafb: framebuffer size = 32 Mb
> [4303339.618000] via_pci_probe:mem_size : 2000000
> [4303339.619000] viafb: Found Device Rev:0
> [4303339.619000] viafb: X:720 Y:576
> [4303339.619000] viafb: mode=720  bpp=32  refresh=255  TVon=0  TVtype=2
> [4303339.620000] viafb: VQ start:1FC0000  end:1FFFFFF  size:40000
> [4303339.620000] viafb: Cursor start:1FBF000  end:1FBFFFF  size:1000
> [4303339.620000] viafb: mode=720  bpp=32  refresh=255  TVon=0  TVtype=2
> [4303339.620000] viafb: irq handler installed, IRQ(0x200) = 80080c00
> [4303339.624000] viafb_set_par:Set_Par x:720 y:576 bpp:32 vxres:720
> vyres:1152
> [4303339.624000] setmode:setmode fount mode:75
> [4303339.624000] viafb_pan_display:pan_display
> [4303339.626000] viafb_pan_display:pan_display
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:0 r:0 g:0 b:0 t:FFFF
> bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:1 r:0 g:0 b:AAAA t:FFFF
> bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:2 r:0 g:AAAA b:0 t:FFFF
> bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:3 r:0 g:AAAA b:AAAA
> t:FFFF bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:4 r:AAAA g:0 b:0 t:FFFF
> bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:5 r:AAAA g:0 b:AAAA
> t:FFFF bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:6 r:AAAA g:5555 b:0
> t:FFFF bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:7 r:AAAA g:AAAA b:AAAA
> t:FFFF bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:8 r:5555 g:5555 b:5555
> t:FFFF bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:9 r:5555 g:5555 b:FFFF
> t:FFFF bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:10 r:5555 g:FFFF b:5555
> t:FFFF bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:11 r:5555 g:FFFF b:FFFF
> t:FFFF bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:12 r:FFFF g:5555 b:5555
> t:FFFF bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:13 r:FFFF g:5555 b:FFFF
> t:FFFF bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:14 r:FFFF g:FFFF b:5555
> t:FFFF bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:15 r:FFFF g:FFFF b:FFFF
> t:FFFF bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:0 r:0 g:0 b:0 t:FFFF
> bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:1 r:0 g:0 b:AAAA t:FFFF
> bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:2 r:0 g:AAAA b:0 t:FFFF
> bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:3 r:0 g:AAAA b:AAAA
> t:FFFF bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:4 r:AAAA g:0 b:0 t:FFFF
> bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:5 r:AAAA g:0 b:AAAA
> t:FFFF bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:6 r:AAAA g:5555 b:0
> t:FFFF bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:7 r:AAAA g:AAAA b:AAAA
> t:FFFF bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:8 r:5555 g:5555 b:5555
> t:FFFF bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:9 r:5555 g:5555 b:FFFF
> t:FFFF bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:10 r:5555 g:FFFF b:5555
> t:FFFF bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:11 r:5555 g:FFFF b:FFFF
> t:FFFF bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:12 r:FFFF g:5555 b:5555
> t:FFFF bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:13 r:FFFF g:5555 b:FFFF
> t:FFFF bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:14 r:FFFF g:FFFF b:5555
> t:FFFF bpp: 32
> [4303339.626000] viafb_setcolreg:set_colreg
> [4303339.626000] viafb_setcolreg:set_col_reg reg:15 r:FFFF g:FFFF b:FFFF
> t:FFFF bpp: 32
> [4303339.629000] viafb_pan_display:pan_display
> [4303339.629000] viafb_setcolreg:set_colreg
> [4303339.629000] viafb_setcolreg:set_col_reg reg:0 r:0 g:0 b:0 t:FFFF
> bpp: 32
> [4303339.629000] viafb_setcolreg:set_colreg
> [4303339.629000] viafb_setcolreg:set_col_reg reg:1 r:0 g:0 b:AAAA t:FFFF
> bpp: 32
> [4303339.629000] viafb_setcolreg:set_colreg
> [4303339.629000] viafb_setcolreg:set_col_reg reg:2 r:0 g:AAAA b:0 t:FFFF
> bpp: 32
> [4303339.629000] viafb_setcolreg:set_colreg
> [4303339.629000] viafb_setcolreg:set_col_reg reg:3 r:0 g:AAAA b:AAAA
> t:FFFF bpp: 32
> [4303339.629000] viafb_setcolreg:set_colreg
> [4303339.629000] viafb_setcolreg:set_col_reg reg:4 r:AAAA g:0 b:0 t:FFFF
> bpp: 32
> [4303339.629000] viafb_setcolreg:set_colreg
> [4303339.629000] viafb_setcolreg:set_col_reg reg:5 r:AAAA g:0 b:AAAA
> t:FFFF bpp: 32
> [4303339.629000] viafb_setcolreg:set_colreg
> [4303339.629000] viafb_setcolreg:set_col_reg reg:6 r:AAAA g:5555 b:0
> t:FFFF bpp: 32
> [4303339.629000] viafb_setcolreg:set_colreg
> [4303339.629000] viafb_setcolreg:set_col_reg reg:7 r:AAAA g:AAAA b:AAAA
> t:FFFF bpp: 32
> [4303339.629000] viafb_setcolreg:set_colreg
> [4303339.629000] viafb_setcolreg:set_col_reg reg:8 r:5555 g:5555 b:5555
> t:FFFF bpp: 32
> [4303339.629000] viafb_setcolreg:set_colreg
> [4303339.629000] viafb_setcolreg:set_col_reg reg:9 r:5555 g:5555 b:FFFF
> t:FFFF bpp: 32
> [4303339.630000] viafb_setcolreg:set_colreg
> [4303339.630000] viafb_setcolreg:set_col_reg reg:10 r:5555 g:FFFF b:5555
> t:FFFF bpp: 32
> [4303339.630000] viafb_setcolreg:set_colreg
> [4303339.630000] viafb_setcolreg:set_col_reg reg:11 r:5555 g:FFFF b:FFFF
> t:FFFF bpp: 32
> [4303339.630000] viafb_setcolreg:set_colreg
> [4303339.630000] viafb_setcolreg:set_col_reg reg:12 r:FFFF g:5555 b:5555
> t:FFFF bpp: 32
> [4303339.630000] viafb_setcolreg:set_colreg
> [4303339.630000] viafb_setcolreg:set_col_reg reg:13 r:FFFF g:5555 b:FFFF
> t:FFFF bpp: 32
> [4303339.630000] viafb_setcolreg:set_colreg
> [4303339.630000] viafb_setcolreg:set_col_reg reg:14 r:FFFF g:FFFF b:5555
> t:FFFF bpp: 32
> [4303339.630000] viafb_setcolreg:set_colreg
> [4303339.630000] viafb_setcolreg:set_col_reg reg:15 r:FFFF g:FFFF b:FFFF
> t:FFFF bpp: 32
> [4303339.632000] viafb_setcolreg:set_colreg
> [4303339.632000] viafb_setcolreg:set_col_reg reg:0 r:0 g:0 b:0 t:FFFF
> bpp: 32
> [4303339.632000] viafb_setcolreg:set_colreg
> [4303339.632000] viafb_setcolreg:set_col_reg reg:1 r:0 g:0 b:AAAA t:FFFF
> bpp: 32
> [4303339.632000] viafb_setcolreg:set_colreg
> [4303339.632000] viafb_setcolreg:set_col_reg reg:2 r:0 g:AAAA b:0 t:FFFF
> bpp: 32
> [4303339.632000] viafb_setcolreg:set_colreg
> [4303339.632000] viafb_setcolreg:set_col_reg reg:3 r:0 g:AAAA b:AAAA
> t:FFFF bpp: 32
> [4303339.632000] viafb_setcolreg:set_colreg
> [4303339.632000] viafb_setcolreg:set_col_reg reg:4 r:AAAA g:0 b:0 t:FFFF
> bpp: 32
> [4303339.632000] viafb_setcolreg:set_colreg
> [4303339.632000] viafb_setcolreg:set_col_reg reg:5 r:AAAA g:0 b:AAAA
> t:FFFF bpp: 32
> [4303339.632000] viafb_setcolreg:set_colreg
> [4303339.632000] viafb_setcolreg:set_col_reg reg:6 r:AAAA g:5555 b:0
> t:FFFF bpp: 32
> [4303339.632000] viafb_setcolreg:set_colreg
> [4303339.632000] viafb_setcolreg:set_col_reg reg:7 r:AAAA g:AAAA b:AAAA
> t:FFFF bpp: 32
> [4303339.633000] viafb_setcolreg:set_colreg
> [4303339.633000] viafb_setcolreg:set_col_reg reg:8 r:5555 g:5555 b:5555
> t:FFFF bpp: 32
> [4303339.633000] viafb_setcolreg:set_colreg
> [4303339.633000] viafb_setcolreg:set_col_reg reg:9 r:5555 g:5555 b:FFFF
> t:FFFF bpp: 32
> [4303339.633000] viafb_setcolreg:set_colreg
> [4303339.633000] viafb_setcolreg:set_col_reg reg:10 r:5555 g:FFFF b:5555
> t:FFFF bpp: 32
> [4303339.633000] viafb_setcolreg:set_colreg
> [4303339.633000] viafb_setcolreg:set_col_reg reg:11 r:5555 g:FFFF b:FFFF
> t:FFFF bpp: 32
> [4303339.633000] viafb_setcolreg:set_colreg
> [4303339.633000] viafb_setcolreg:set_col_reg reg:12 r:FFFF g:5555 b:5555
> t:FFFF bpp: 32
> [4303339.633000] viafb_setcolreg:set_colreg
> [4303339.633000] viafb_setcolreg:set_col_reg reg:13 r:FFFF g:5555 b:FFFF
> t:FFFF bpp: 32
> [4303339.633000] viafb_setcolreg:set_colreg
> [4303339.633000] viafb_setcolreg:set_col_reg reg:14 r:FFFF g:FFFF b:5555
> t:FFFF bpp: 32
> [4303339.633000] viafb_setcolreg:set_colreg
> [4303339.633000] viafb_setcolreg:set_col_reg reg:15 r:FFFF g:FFFF b:FFFF
> t:FFFF bpp: 32
> [4303339.633000] Console: switching to colour frame buffer device 90x36
> [4303339.656000] setmode:setmode fount mode:75
> [4303339.657000] viafb_pan_display:pan_display
> [4303339.657000] fb0: UNICHROME frame buffer device
>
>
>
> Le dimanche 17 septembre 2006 ? 11:33 +0200, Testasecca public mail a
> ?crit :
> > Hi all,
> >
> > I'm new to the list, and of course with a problem ....
> >
> > I'm a trying to install a TV Box running VDR on an EPIA M 10000 board,
> > under Ubuntu (server install), kernel version is 2.6.15-23-386.
> >
> > I want VDR running onto the framebuffer throw softdevice plugin, and i
> > want hardware MPEG acceleration.
> >
> > So, i found this nice tutorial :
> > http://www.mellander.org/per/projects/linux/?chapter=epia-hw-cle266 ...
> >
> > Everything works perfectly on my PC monitor, i got : the famebuffer
> > console, i can see VDR interface, decode an MPEG stream with
> > acceleration ...
> >
> > BUT my TV screen goes crazy ! It  is activated but  completly
> > scrambled, there is some lines ( looks like interlacing problems ??,
> > the image is shifted, duplicated .... ).
> >
> > This problems comes just after viafb/fbcon module inserting,  so
> > there'is no problem with DiretFB, or DF++ or VDR, the problems comes
> > from viafb module.
> >
> > I have configured into the BIOS (TV+CRT, 800x600, PAL (i'm in france),
> > direct access to framebuffer .... ).
> > Then i load the module :
> > sudo insmod viafb.ko TVon=0    # (0 is for enable, i tried without
> > options, same results ...)
> >
> > When i insert the viafb module, dmesg gives :
> >
> > [4296000.354000] viafb: VIA UNICHROME framebuffer 1.0 initializing
> > [4296000.356000] viafb: viafb : CEF00000
> > [4296000.356000] viafb: framebuffer size = 32 Mb
> > [4296000.356000] viafb: Found Device Rev:0
> > [4296000.357000] viafb: X:800 Y:600
> > [4296000.357000] viafb: mode=800  bpp=32  refresh=50  TVon=0  TVtype=2
> > [4296000.357000] viafb: VQ start:1FC0000  end:1FFFFFF  size:40000
> > [4296000.357000] viafb: Cursor start:1FBF000  end:1FBFFFF  size:1000
> > [4296000.358000] viafb: mode=800  bpp=32  refresh=255  TVon=0
> > TVtype=2
> > [ 4296000.358000] viafb: irq handler installed, IRQ(0x200) = 80080c02
> > [4296000.371000] Console: switching to colour frame buffer device
> > 100x37
> > [4296000.371000] fb0: UNICHROME frame buffer device
> >
> > At this time an fbset gives me :
> > mode "720x576-74"
> >     # D: 41.475 MHz, H: 44.693 kHz, V: 74.488 Hz
> >     geometry 720 576 720 1152 32
> >     timings 24111 88 32 16 4 88 4
> >     rgba 8/16,8/8,8/0,8/24
> > endmode
> >
> > and fbset -i :
> > Frame buffer device information:
> >     Name        : UNICHROME
> >     Address     : 0xd8000000
> >     Size        : 33288192
> >     Type        : PACKED PIXELS
> >     Visual      : TRUECOLOR
> >     XPanStep    : 0
> >     YPanStep    : 1
> >     YWrapStep   : 0
> >     LineLength  : 2880
> >     MMIO Address: 0xdc000000
> >     MMIO Size   : 16777216
> >     Accelerator : Unknown (77)
> >
> >
> > So i do a fbset "720x576-50" with this definition :
> > mode "720x576-50"
> >     geometry 720 576 720 576 16
> >     timings 35714 32 8 46 0 136 3
> >     bcast true # request overscan with (modified) viafb
> > endmode
> >
> > then the set gives :
> > mode "720x576-50"
> >     # D: 28.000 MHz, H: 31.250 kHz, V: 50.000 Hz
> >     geometry 720 576 720 576 16
> >     timings 35714 32 8 46 0 136 3
> >     bcast true
> >     accel true
> >     rgba 5/11,6/5,5/0,0/0
> > endmode
> >
> > That's weird, everything is working on PC screen, and not on TV !
> >
> > I tried a patch to the kernel from VDR Eclipse site, with the same bad
> > results.
> > (
> http://vdr.bluox.org/download/epia/viafb_03-720x576noscale-2.6.14.patch.bz2
> )
> >
> > I've also tried via driver and TV out works  (with the same fb.modes)
> > but is really slow ! I can't decode an MPEG stream with this !
> >
> > I'm a little bit disapointed ! Please Help ! :)
> >
> > Some not directly related questions :
> > Do you know how to prevent fbcon module insertion at boot time ? ( I
> > tried to remove it from /lib/modules/ ... and it was stille loaded
> > after reboot !!! Magik ? Initrd ?
> >
> > Do you know how to force a power off on an USB device?  i want to stop
> > USB power supply to my DVB-T USB device to make a hard reset to it, it
> > seems to very stable ....
> >
> > Thanks in advance for your help ...
> > Cheers
> > Tom
> >
> > I also posted on directfb-users
> >
> > --
> > Cheers,
> > Thomas TESTASECCA
> >
> > (o-
> > // \        In a world without walls and fences, who needs Windows and
> > Gates ?
> > \/_/_
>
>


-- 
Cheers,
Thomas TESTASECCA

(o-
// \        In a world without walls and fences, who needs Windows and Gates
?
\/_/_
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060917/97595230/attachment.html>

From stefan at lucke.in-berlin.de  Sun Sep 17 21:38:29 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 17 Sep 2006 21:38:29 +0200
Subject: [Softdevice-devel] troubles with new svn version of ffmpeg
In-Reply-To: <200609172009.28837.stefan@lucke.in-berlin.de>
References: <200609172009.28837.stefan@lucke.in-berlin.de>
Message-ID: <1158521909.450da435f2236@webmail.in-berlin.de>

Quoting Stefan Lucke:

> Hi,
>
> according to this thread of vdr-portal (in german):
>
> http://www.vdr-portal.de/board/thread.php?threadid=54787
>
> we can expect some troubles with ffmpeg versions newer than 2006-08-26.
>

The following entry from commit log gave me the hint for this date:

http://svn.mplayerhq.hu/ffmpeg/trunk/libavcodec/mpegaudiodec.c?view=log

Revision number: 6098 :
remove duplicated parser, people who pass random gibblets of the bitstream into the decoder will have to pass it through a AVParser
like for all other codecs too
remove silly internal buffering architecture (removes 1 memcpy() of the bitstream)
mp3on4 and mp3adu untested


Stefan Lucke


From marko.makela at hut.fi  Sun Sep 17 22:17:46 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sun, 17 Sep 2006 23:17:46 +0300
Subject: [Softdevice-devel] [PATCH] Enable mgatv spic and YV12
In-Reply-To: <450D86F1.1030200@cs.helsinki.fi>
References: <450D86F1.1030200@cs.helsinki.fi>
Message-ID: <20060917201746.GB2753@localhost.localdomain>

On Sun, Sep 17, 2006 at 08:33:37PM +0300, Heikki Lindholm wrote:
> The included patch makes dfb:mgatv use YV12 colourspace for video and 
> the hardware subpicture layer for OSD. The patch is a prime example of 
> bad goal-oriented programming, but does what I wanted: improves 
> performance to the level that my 450 MHz P2 can now function as a DVB 
> box like no underpowered P2 has done before! Unfortunately, the patch 
> probably breaks everything else, but I'm too lazy to clean it up.

I'm very much interested in this.

You didn't get rid of the CPU-burning Flip() calls, did you?  At least
on my system, DirectFB spends about 10% of the CPU cycles waiting for
MGA engine ready.  Adding a usleep(2000) right before the Flip() call
reduces the CPU load but risks dropping frames.  I believe it would be
much more efficient if the Flip() method blocked the thread until the
hardware is ready.  That would require some new ioctl() in the kernel.

	Marko


From M.Wache at gmx.net  Sun Sep 17 22:35:40 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 17 Sep 2006 22:35:40 +0200
Subject: [Softdevice-devel] troubles with new svn version of ffmpeg
In-Reply-To: <1158521909.450da435f2236@webmail.in-berlin.de>
References: <200609172009.28837.stefan@lucke.in-berlin.de>
	<1158521909.450da435f2236@webmail.in-berlin.de>
Message-ID: <450DB19C.6020401@gmx.net>

Stefan Lucke schrieb:
> Quoting Stefan Lucke:
> 
>> Hi,
>>
>> according to this thread of vdr-portal (in german):
>>
>> http://www.vdr-portal.de/board/thread.php?threadid=54787
>>
>> we can expect some troubles with ffmpeg versions newer than 2006-08-26.
>>
> 
> The following entry from commit log gave me the hint for this date:
> 
> http://svn.mplayerhq.hu/ffmpeg/trunk/libavcodec/mpegaudiodec.c?view=log
> 
> Revision number: 6098 :
> remove duplicated parser, people who pass random gibblets of the bitstream into the decoder will have to pass it through a AVParser
> like for all other codecs too
> remove silly internal buffering architecture (removes 1 memcpy() of the bitstream)
> mp3on4 and mp3adu untested
> 
I just upgraded to the ffmpeg svn version from today, but I don't
experience any problems. Do you have some samples which show the problems?

Bye,
Martin


From holindho at cs.helsinki.fi  Sun Sep 17 22:46:23 2006
From: holindho at cs.helsinki.fi (Heikki Lindholm)
Date: Sun, 17 Sep 2006 23:46:23 +0300
Subject: [Softdevice-devel] [PATCH] Enable mgatv spic and YV12
In-Reply-To: <20060917201746.GB2753@localhost.localdomain>
References: <450D86F1.1030200@cs.helsinki.fi>
	<20060917201746.GB2753@localhost.localdomain>
Message-ID: <1158525984.16643.10.camel@marumake>

su, 2006-09-17 kello 23:17 +0300, Marko M?kel? kirjoitti:
> On Sun, Sep 17, 2006 at 08:33:37PM +0300, Heikki Lindholm wrote:
> > The included patch makes dfb:mgatv use YV12 colourspace for video and 
> > the hardware subpicture layer for OSD. The patch is a prime example of 
> > bad goal-oriented programming, but does what I wanted: improves 
> > performance to the level that my 450 MHz P2 can now function as a DVB 
> > box like no underpowered P2 has done before! Unfortunately, the patch 
> > probably breaks everything else, but I'm too lazy to clean it up.
> 
> I'm very much interested in this.

Then, maybe, I didn't waste my time posting it :)

> You didn't get rid of the CPU-burning Flip() calls, did you?  At least
> on my system, DirectFB spends about 10% of the CPU cycles waiting for
> MGA engine ready.  Adding a usleep(2000) right before the Flip() call
> reduces the CPU load but risks dropping frames.  I believe it would be
> much more efficient if the Flip() method blocked the thread until the
> hardware is ready.  That would require some new ioctl() in the kernel.

I read your earlier comment about this on the list. I was curious to ask
if you could elaborate on this a bit. I _very_ briefly looked at what
the Flip call does, and the only wait I saw was the wait for vsync,
which for matroxfb seems to be nicely handled by a waitqueue in the
kernel. Where exactly is the wait you're referring to? I believe adding
an usleep() is really artificial way of reducing cpu load and not really
solving anything - at least when the CPU really is underpowered as in my
case - unless there's some convenient reordering happening in the
scheduling of the vdr threads caused by the added usleep.

-- Heikki Lindholm




From stefan at lucke.in-berlin.de  Sun Sep 17 22:47:23 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 17 Sep 2006 22:47:23 +0200
Subject: [Softdevice-devel] troubles with new svn version of ffmpeg
In-Reply-To: <450DB19C.6020401@gmx.net>
References: <200609172009.28837.stefan@lucke.in-berlin.de>
	<1158521909.450da435f2236@webmail.in-berlin.de>
	<450DB19C.6020401@gmx.net>
Message-ID: <200609172247.23209.stefan@lucke.in-berlin.de>

On Sonntag 17 September 2006 22:35, Martin Wache wrote:
> Stefan Lucke schrieb:
> > Quoting Stefan Lucke:
> > 
> >> Hi,
> >>
> >> according to this thread of vdr-portal (in german):
> >>
> >> http://www.vdr-portal.de/board/thread.php?threadid=54787
> >>
> >> we can expect some troubles with ffmpeg versions newer than 2006-08-26.
> >>
> > 
> > The following entry from commit log gave me the hint for this date:
> > 
> > http://svn.mplayerhq.hu/ffmpeg/trunk/libavcodec/mpegaudiodec.c?view=log
> > 
> > Revision number: 6098 :
> > remove duplicated parser, people who pass random gibblets of the bitstream into the decoder will have to pass it through a AVParser
> > like for all other codecs too
> > remove silly internal buffering architecture (removes 1 memcpy() of the bitstream)
> > mp3on4 and mp3adu untested
> > 
> I just upgraded to the ffmpeg svn version from today, but I don't
> experience any problems. Do you have some samples which show the problems?

The sample I got  from Martin Prochnow did not show problems on my 
system, but on his. As he mentioned on vdr-portal, with ffmpeg version 
from 2006-08-26 solved his issue, and version from 2006-08-27 
brought it back again.

Sample size is about 9MB. Do you like to have it ?


-- 
Stefan Lucke


From holindho at cs.helsinki.fi  Sun Sep 17 22:52:32 2006
From: holindho at cs.helsinki.fi (Heikki Lindholm)
Date: Sun, 17 Sep 2006 23:52:32 +0300
Subject: [Softdevice-devel] troubles with new svn version of ffmpeg
In-Reply-To: <200609172009.28837.stefan@lucke.in-berlin.de>
References: <200609172009.28837.stefan@lucke.in-berlin.de>
Message-ID: <1158526352.16643.14.camel@marumake>

su, 2006-09-17 kello 20:09 +0200, Stefan Lucke kirjoitti:
> Hi,
> 
> according to this thread of vdr-portal (in german):
> 
> http://www.vdr-portal.de/board/thread.php?threadid=54787
> 
> we can expect some troubles with ffmpeg versions newer than 2006-08-26.

My German is a bit rusty, but for what it's worth, I have ffmpeg from
maybe two days back and haven't seen the problem the guy describes.

-- Heikki Lindholm




From M.Wache at gmx.net  Sun Sep 17 22:55:30 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 17 Sep 2006 22:55:30 +0200
Subject: [Softdevice-devel] troubles with new svn version of ffmpeg
In-Reply-To: <200609172247.23209.stefan@lucke.in-berlin.de>
References: <200609172009.28837.stefan@lucke.in-berlin.de>	<1158521909.450da435f2236@webmail.in-berlin.de>	<450DB19C.6020401@gmx.net>
	<200609172247.23209.stefan@lucke.in-berlin.de>
Message-ID: <450DB642.9050407@gmx.net>

Stefan Lucke schrieb:
> On Sonntag 17 September 2006 22:35, Martin Wache wrote:
>> I just upgraded to the ffmpeg svn version from today, but I don't
>> experience any problems. Do you have some samples which show the problems?
> 
> The sample I got  from Martin Prochnow did not show problems on my 
> system, but on his. As he mentioned on vdr-portal, with ffmpeg version 
> from 2006-08-26 solved his issue, and version from 2006-08-27 
> brought it back again.
> 
> Sample size is about 9MB. Do you like to have it ?
> 

Why not? Maybe I am able to reproduce the problems.

Martin



From M.Wache at gmx.net  Sun Sep 17 23:13:23 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 17 Sep 2006 23:13:23 +0200
Subject: [Softdevice-devel] cle266 hw decoding
In-Reply-To: <1E9F6C90-1835-4B06-BBF9-CCC0DEC9046F@pobox.com>
References: <1E9F6C90-1835-4B06-BBF9-CCC0DEC9046F@pobox.com>
Message-ID: <450DBA73.202@gmx.net>

Torgeir Veimo schrieb:
> Does this work yet on CN400/700 based boards when not using the tv encoder?
> 
I don't know for sure, but I guess not. There are some differences
between the unichrome and the unichrome pro.

But since the mpeg2 decoder of the CN400 is working with the openchrome
driver, I guess adapting libcle266mpegdec should not be very difficult.

Bye,
Martin


From stefan at lucke.in-berlin.de  Sun Sep 17 23:21:22 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 17 Sep 2006 23:21:22 +0200
Subject: [Softdevice-devel] [PATCH] Enable mgatv spic and YV12
In-Reply-To: <450D86F1.1030200@cs.helsinki.fi>
References: <450D86F1.1030200@cs.helsinki.fi>
Message-ID: <200609172321.22849.stefan@lucke.in-berlin.de>

On Sonntag 17 September 2006 19:33, Heikki Lindholm wrote:
> The included patch makes dfb:mgatv use YV12 colourspace for video and 
> the hardware subpicture layer for OSD. The patch is a prime example of 
> bad goal-oriented programming, but does what I wanted: improves 
> performance to the level that my 450 MHz P2 can now function as a DVB 
> box like no underpowered P2 has done before! Unfortunately, the patch 
> probably breaks everything else, but I'm too lazy to clean it up.
> 

Have to put some comments on this.

Sometime ago we already looked at the subpicture layer of matrox cards.
But the disadvantage of this layer is that it only supports a few lookup entries.
There are less entries than vdr can handle.

Vdr's OSD drawing consists of drawing to several areas and each area
has it's own lookup table. Vdr in native mode (without OSD plugins)
draws it's OSD in a single area with only a few colors entries. So 
you'll eventually don't see a problem.

When i remember our OSD drawing correct, we map all OSD drawing to
a single RGB32 area and so we don't need to have separate areas ourself.

-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Sun Sep 17 23:21:27 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 17 Sep 2006 23:21:27 +0200
Subject: [Softdevice-devel] [PATCH] Enable mgatv spic and YV12
In-Reply-To: <20060917201746.GB2753@localhost.localdomain>
References: <450D86F1.1030200@cs.helsinki.fi>
	<20060917201746.GB2753@localhost.localdomain>
Message-ID: <200609172321.27733.stefan@lucke.in-berlin.de>

On Sonntag 17 September 2006 22:17, Marko M?kel? wrote:
> On Sun, Sep 17, 2006 at 08:33:37PM +0300, Heikki Lindholm wrote:
> > The included patch makes dfb:mgatv use YV12 colourspace for video and 
> > the hardware subpicture layer for OSD. The patch is a prime example of 
> > bad goal-oriented programming, but does what I wanted: improves 
> > performance to the level that my 450 MHz P2 can now function as a DVB 
> > box like no underpowered P2 has done before! Unfortunately, the patch 
> > probably breaks everything else, but I'm too lazy to clean it up.
> 
> I'm very much interested in this.
> 
> You didn't get rid of the CPU-burning Flip() calls, did you?  At least
> on my system, DirectFB spends about 10% of the CPU cycles waiting for
> MGA engine ready.  Adding a usleep(2000) right before the Flip() call
> reduces the CPU load but risks dropping frames.  I believe it would be
> much more efficient if the Flip() method blocked the thread until the
> hardware is ready.  That would require some new ioctl() in the kernel.

Marko, I think you showed me a response from Ville regarding the ioctl
issue. But unfortunatly I could not find this. 
Was the modification based on the ioctl calls from him at directfb list
which were not committed ?


-- 
Stefan Lucke


From holindho at cs.helsinki.fi  Mon Sep 18 08:49:04 2006
From: holindho at cs.helsinki.fi (Heikki Lindholm)
Date: Mon, 18 Sep 2006 09:49:04 +0300
Subject: [Softdevice-devel] [PATCH] Enable mgatv spic and YV12
In-Reply-To: <200609172321.22849.stefan@lucke.in-berlin.de>
References: <450D86F1.1030200@cs.helsinki.fi>
	<200609172321.22849.stefan@lucke.in-berlin.de>
Message-ID: <450E4160.30001@cs.helsinki.fi>

Stefan Lucke kirjoitti:
> On Sonntag 17 September 2006 19:33, Heikki Lindholm wrote:
> 
>>The included patch makes dfb:mgatv use YV12 colourspace for video and 
>>the hardware subpicture layer for OSD. The patch is a prime example of 
>>bad goal-oriented programming, but does what I wanted: improves 
>>performance to the level that my 450 MHz P2 can now function as a DVB 
>>box like no underpowered P2 has done before! Unfortunately, the patch 
>>probably breaks everything else, but I'm too lazy to clean it up.
>>
> 
> 
> Have to put some comments on this.
> 
> Sometime ago we already looked at the subpicture layer of matrox cards.
> But the disadvantage of this layer is that it only supports a few lookup entries.
> There are less entries than vdr can handle.

"Can" as in "vdr has more entries"; yes, that's right. Fortunately, the 
mga spic layer palette (of 16 colours) can be defined freely.

> Vdr's OSD drawing consists of drawing to several areas and each area
> has it's own lookup table. Vdr in native mode (without OSD plugins)

Right. Actually, I was a bit disappointed when I noticed that. A global 
static palette would have been so much easier to handle. Btw. Could you 
point me to some plugins that do use a lot of colours in the OSD? The 
only other (besides of softdevice) plugin I use is the DVB subtitle one, 
which uses 4 colours AFAICT.

> draws it's OSD in a single area with only a few colors entries. So 
> you'll eventually don't see a problem.

And this was good enough for me. Basically, implementing a good colour 
allocator, maybe with some clustering colour reduction algorithm and LRU 
allocation policy, would usually produce acceptable results even when 
there are many more than 16 colours in use. I, however, did not venture 
in to such level of sophistication. But, I definitely don't think the 
mga spic approach is in any way infeasible or worthless. My patch might 
be worthless, though..

I first tried CRTC2 using YV12 colour space with strechBlit, like the 
YUY2 is used currently, but it was dead slow, so, without further 
investigation, I turned to alternative strategy.  My only goal was to 
get decent viewing pleasure from my trusty old P2 box.

> When i remember our OSD drawing correct, we map all OSD drawing to
> a single RGB32 area and so we don't need to have separate areas ourself.

Yes, that seems to be the case, and using RGBA there is ideal, of course.

-- Heikki Lindholm


From marko.makela at hut.fi  Mon Sep 18 09:49:20 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 18 Sep 2006 10:49:20 +0300
Subject: [Softdevice-devel] [PATCH] Enable mgatv spic and YV12
In-Reply-To: <200609172321.27733.stefan@lucke.in-berlin.de>
	<1158525984.16643.10.camel@marumake>
References: <450D86F1.1030200@cs.helsinki.fi>
	<20060917201746.GB2753@localhost.localdomain>
	<200609172321.27733.stefan@lucke.in-berlin.de>
	<450D86F1.1030200@cs.helsinki.fi>
	<20060917201746.GB2753@localhost.localdomain>
	<1158525984.16643.10.camel@marumake>
Message-ID: <20060918074601.GA3928@localhost.localdomain>

On Sun, Sep 17, 2006 at 11:46:23PM +0300, Heikki Lindholm wrote:
> > You didn't get rid of the CPU-burning Flip() calls, did you?  At least
> > on my system, DirectFB spends about 10% of the CPU cycles waiting for
> > MGA engine ready.  Adding a usleep(2000) right before the Flip() call
> > reduces the CPU load but risks dropping frames.  I believe it would be
> > much more efficient if the Flip() method blocked the thread until the
> > hardware is ready.  That would require some new ioctl() in the kernel.
> 
> I read your earlier comment about this on the list. I was curious to ask
> if you could elaborate on this a bit. I _very_ briefly looked at what
> the Flip call does, and the only wait I saw was the wait for vsync,
> which for matroxfb seems to be nicely handled by a waitqueue in the
> kernel.

No, in fact it is waiting for the current operation to finish.  If you
do Flip() immediately after initiating a large blit operation, the CPU
will busy-wait in mga_waitidle() until the operation has finished.

> I believe adding an usleep() is really artificial way of reducing cpu load
> and not really solving anything

It does reduce the CPU load reported by "top" by about 10 per cent,
in my case from around 60% to 50%.

I agree that it is not the right solution and it will probably make things
worse if the CPU is really tightly loaded.  I tried replacing the usleep()
calls with sched_yield(), and that really broke the timing.

On Sun, Sep 17, 2006 at 11:21:27PM +0200, Stefan Lucke wrote:

> Marko, I think you showed me a response from Ville regarding the ioctl
> issue. But unfortunatly I could not find this. 

I probably did not forward his reply to you, because it was written
in Finnish.  On June 28, he wrote that using an IRQ would help but that
it would require at least one more ioctl() to the kernel.

> Was the modification based on the ioctl calls from him at directfb list
> which were not committed ?

I haven't tried any kernel patches.

	Marko


From holindho at cs.helsinki.fi  Mon Sep 18 10:17:54 2006
From: holindho at cs.helsinki.fi (Heikki Lindholm)
Date: Mon, 18 Sep 2006 11:17:54 +0300
Subject: [Softdevice-devel] [PATCH] Enable mgatv spic and YV12
In-Reply-To: <20060918074601.GA3928@localhost.localdomain>
References: <450D86F1.1030200@cs.helsinki.fi>
	<20060917201746.GB2753@localhost.localdomain>
	<200609172321.27733.stefan@lucke.in-berlin.de>
	<450D86F1.1030200@cs.helsinki.fi>
	<20060917201746.GB2753@localhost.localdomain>
	<1158525984.16643.10.camel@marumake>
	<20060918074601.GA3928@localhost.localdomain>
Message-ID: <1158567474.4399.4.camel@marumake>

ma, 2006-09-18 kello 10:49 +0300, Marko M?kel? kirjoitti:
> On Sun, Sep 17, 2006 at 11:46:23PM +0300, Heikki Lindholm wrote:
> > > You didn't get rid of the CPU-burning Flip() calls, did you?  At least
> > > on my system, DirectFB spends about 10% of the CPU cycles waiting for
> > > MGA engine ready.  Adding a usleep(2000) right before the Flip() call
> > > reduces the CPU load but risks dropping frames.  I believe it would be
> > > much more efficient if the Flip() method blocked the thread until the
> > > hardware is ready.  That would require some new ioctl() in the kernel.
> > 
> > I read your earlier comment about this on the list. I was curious to ask
> > if you could elaborate on this a bit. I _very_ briefly looked at what
> > the Flip call does, and the only wait I saw was the wait for vsync,
> > which for matroxfb seems to be nicely handled by a waitqueue in the
> > kernel.
> 
> No, in fact it is waiting for the current operation to finish.  If you
> do Flip() immediately after initiating a large blit operation, the CPU
> will busy-wait in mga_waitidle() until the operation has finished.

Ok. I'll look into that. I don't care if I have to add (dirty) hacks to
the kernel, because the vdr box will be single-purpose anyway. Was there
some patches floating around already, or just conceptual stuff?

-- Heikki Lindholm



From M.Wache at gmx.net  Mon Sep 18 11:39:57 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 18 Sep 2006 11:39:57 +0200
Subject: [Softdevice-devel] [PATCH] Enable mgatv spic and YV12
In-Reply-To: <450D86F1.1030200@cs.helsinki.fi>
References: <450D86F1.1030200@cs.helsinki.fi>
Message-ID: <450E696D.6080304@gmx.net>

Heikki Lindholm schrieb:
> The included patch makes dfb:mgatv use YV12 colourspace for video and
> the hardware subpicture layer for OSD. The patch is a prime example of
> bad goal-oriented programming, but does what I wanted: improves
> performance to the level that my 450 MHz P2 can now function as a DVB
> box like no underpowered P2 has done before! Unfortunately, the patch
> probably breaks everything else, but I'm too lazy to clean it up.
> 
Can you please point out to me what the advantage of using the
subpicture layer is? To me it looks like the main speed change is that
you don't scale the osd. Or does the change to YV12 colourspace bring
some speed advantage?
I would not mind adding support for an indexed bitmap, but currently I
don't see the advantage. If we do that we should probably think again
about the interface of GetOSDMode(), I never liked that very much, it
was a hack from the start...

I also had a quick look at your patch and noticed a bug:

> +	          // if we have space add it
> +		  if (indexedPaletteEntriesFilled < 16) {
> +                    indexedPalette[indexedPaletteEntriesFilled] = 
> +			    orig_palette[i]|0xFF000000;
> +		    palette[i] = indexedPaletteEntriesFilled++;
> +		    indexedPaletteChanged = true;
> +		  }
> +                  else { // if no space, try to find a closest match
> +                    int closest_i=-1, closest=4*0xFF;
> +                    for (int j = 0; j < 16; j++) {
> +		      // euclidean distance would be ideal, but too cumbersome
> +		      int r = ((uint32_t)orig_palette[i]>>16 & 0x000000FF-
> +			      (uint32_t)indexedPalette[j]>>16 & 0x000000FF)&0x000000FF;
> +		      int g = ((uint32_t)orig_palette[i]>>8 & 0x000000FF-
> +			      (uint32_t)indexedPalette[j]>>8 & 0x000000FF)&0x000000FF;
> +		      int b = ((uint32_t)orig_palette[i]>>0 & 0x000000FF-
> +			      (uint32_t)indexedPalette[j]>>0 & 0x000000FF)&0x000000FF;
> +		      int d = r+g+b;

This doesn't work. Consider orig_palette=126 and indexedPalette=128, the
difference will be -2=0xFFFFFFFE. So you will add 0xFE=255 instead of 2.
You either need an abs() or to square the rgb values, I would prefer the
square.


Bye,
Martin


From marko.makela at hut.fi  Mon Sep 18 11:41:26 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 18 Sep 2006 12:41:26 +0300
Subject: [Softdevice-devel] [PATCH] Enable mgatv spic and YV12
In-Reply-To: <1158567474.4399.4.camel@marumake>
References: <450D86F1.1030200@cs.helsinki.fi>
	<20060917201746.GB2753@localhost.localdomain>
	<200609172321.27733.stefan@lucke.in-berlin.de>
	<450D86F1.1030200@cs.helsinki.fi>
	<20060917201746.GB2753@localhost.localdomain>
	<1158525984.16643.10.camel@marumake>
	<20060918074601.GA3928@localhost.localdomain>
	<1158567474.4399.4.camel@marumake>
Message-ID: <20060918094126.GC3928@localhost.localdomain>

On Mon, Sep 18, 2006 at 11:17:54AM +0300, Heikki Lindholm wrote:
> > No, in fact it is waiting for the current operation to finish.  If you
> > do Flip() immediately after initiating a large blit operation, the CPU
> > will busy-wait in mga_waitidle() until the operation has finished.
> 
> Ok. I'll look into that. I don't care if I have to add (dirty) hacks to
> the kernel, because the vdr box will be single-purpose anyway. Was there
> some patches floating around already, or just conceptual stuff?

You'd better ask Ville Syrj?l? or search the directfb-dev archives.
Please post your findings here.  I don't mind a kernel patch either;
I already have added one printk() to tell vdr if the computer was
powered up by the remote control unit and if the display should be
powered on (http://www.iki.fi/~msmakela/software/vdr/#relay).

	Marko


From marko.makela at hut.fi  Mon Sep 18 11:55:30 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 18 Sep 2006 12:55:30 +0300
Subject: [Softdevice-devel] OSD layer not always fully cleared on mgatv
Message-ID: <20060918095530.GD3928@localhost.localdomain>

I'm using CVS versions of softdevice and DirectFB from one or two weeks
ago, when Stefan fixed the big OSD flicker.

I occasionally see flicker on the OSD layer.  Sometimes, when I close the
OSD, it appears that one of the two interlaced fields is not completely
cleared.  A few top and bottom lines will flicker between transparent
and their previous contents until another menu is opened.  Has anyone
else experienced this?

	Marko


From marko.makela at hut.fi  Mon Sep 18 12:24:48 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 18 Sep 2006 13:24:48 +0300
Subject: [Softdevice-devel] [PATCH] Enable mgatv spic and YV12
In-Reply-To: <450E696D.6080304@gmx.net>
References: <450D86F1.1030200@cs.helsinki.fi> <450E696D.6080304@gmx.net>
Message-ID: <20060918102448.GE3928@localhost.localdomain>

On Mon, Sep 18, 2006 at 11:39:57AM +0200, Martin Wache wrote:
> Can you please point out to me what the advantage of using the
> subpicture layer is? To me it looks like the main speed change is that
> you don't scale the osd. Or does the change to YV12 colourspace bring
> some speed advantage?

Some time ago, I tested replacing the YUY2 colour space conversion
with a memcpy().  The memcpy() was about twice as fast on my
900 MHz Celeron, saving another 10% to 15% of CPU.  On his 450 MHz P2,
this change is probably crucial.

I occasionally get dropped frames on my 900 MHz Celeron on dfb:mgatv but
not on dfb output.  I think this is mainly due to the colour space
conversion.  Dropped frames do occur more frequently when the OSD layer
is displayed, though.

	Marko


From holindho at cs.helsinki.fi  Mon Sep 18 14:25:49 2006
From: holindho at cs.helsinki.fi (Heikki Lindholm)
Date: Mon, 18 Sep 2006 15:25:49 +0300
Subject: [Softdevice-devel] [PATCH] Enable mgatv spic and YV12
In-Reply-To: <20060918102448.GE3928@localhost.localdomain>
References: <450D86F1.1030200@cs.helsinki.fi> <450E696D.6080304@gmx.net>
	<20060918102448.GE3928@localhost.localdomain>
Message-ID: <450E904D.8090405@cs.helsinki.fi>

Marko M?kel? kirjoitti:
> On Mon, Sep 18, 2006 at 11:39:57AM +0200, Martin Wache wrote:
> 
>>Can you please point out to me what the advantage of using the
>>subpicture layer is? To me it looks like the main speed change is that
>>you don't scale the osd. Or does the change to YV12 colourspace bring
>>some speed advantage?
> 
> 
> Some time ago, I tested replacing the YUY2 colour space conversion
> with a memcpy().  The memcpy() was about twice as fast on my
> 900 MHz Celeron, saving another 10% to 15% of CPU.  On his 450 MHz P2,
> this change is probably crucial.

I didn't receive the above Martin's message at all - off list, perhaps? 
Anyway, if it's still about the topic in question, the keyword for using 
the subpicture layer from my perspective is 'incompetence': I couldn't 
get crtc2 (mgatv) video layer working with YV12 colourspace and blitted 
OSD, so, I thought maybe it'd work with a subpicture layer more 
effortlessly, and it did. So, the advantage for me isn't the OSD really, 
but the YV12 for the crtc2 video. YV12->YUY2 was simply too slow.

Using YV12 and LUT44 both bring advantages of reduced memory 
requirements and are generally faster. I didn't implement the scaling 
routines for the LUT44 OSD, because I simply didn't grasp the idea of 
the existing code in 5 seconds, and realized that scaling would 
practically never be required by the tv output.

-- Heikki Lindholm



From holindho at cs.helsinki.fi  Mon Sep 18 15:35:03 2006
From: holindho at cs.helsinki.fi (Heikki Lindholm)
Date: Mon, 18 Sep 2006 16:35:03 +0300
Subject: [Softdevice-devel] [PATCH] Enable mgatv spic and YV12
In-Reply-To: <450E696D.6080304@gmx.net>
References: <450D86F1.1030200@cs.helsinki.fi>  <450E696D.6080304@gmx.net>
Message-ID: <1158586503.15103.22.camel@marumake>

ma, 2006-09-18 kello 11:39 +0200, Martin Wache kirjoitti:
> Heikki Lindholm schrieb:
> > The included patch makes dfb:mgatv use YV12 colourspace for video and
> > the hardware subpicture layer for OSD. The patch is a prime example of
> > bad goal-oriented programming, but does what I wanted: improves
> > performance to the level that my 450 MHz P2 can now function as a DVB
> > box like no underpowered P2 has done before! Unfortunately, the patch
> > probably breaks everything else, but I'm too lazy to clean it up.
> > 
> Can you please point out to me what the advantage of using the
> subpicture layer is? To me it looks like the main speed change is that
> you don't scale the osd. Or does the change to YV12 colourspace bring
> some speed advantage?

Wow - this list has wonky ordering. See my previous mail about this.

> I would not mind adding support for an indexed bitmap, but currently I
> don't see the advantage. If we do that we should probably think again
> about the interface of GetOSDMode(), I never liked that very much, it
> was a hack from the start...

And I didn't add much style to that either :) Adding the indexed code is
useless if there are no other users and I'm not going to clean up the
mess I made in video-dfb anytime soon. Of course, if you'd add just the
SoftOsd bits (without maybe the OSD_WIDTH changes), it would make my
life easier when trying to keep up with cvs updates. 

> I also had a quick look at your patch and noticed a bug:
> 
> > +	          // if we have space add it
> > +		  if (indexedPaletteEntriesFilled < 16) {
> > +                    indexedPalette[indexedPaletteEntriesFilled] = 
> > +			    orig_palette[i]|0xFF000000;
> > +		    palette[i] = indexedPaletteEntriesFilled++;
> > +		    indexedPaletteChanged = true;
> > +		  }
> > +                  else { // if no space, try to find a closest match
> > +                    int closest_i=-1, closest=4*0xFF;
> > +                    for (int j = 0; j < 16; j++) {
> > +		      // euclidean distance would be ideal, but too cumbersome
> > +		      int r = ((uint32_t)orig_palette[i]>>16 & 0x000000FF-
> > +			      (uint32_t)indexedPalette[j]>>16 & 0x000000FF)&0x000000FF;
> > +		      int g = ((uint32_t)orig_palette[i]>>8 & 0x000000FF-
> > +			      (uint32_t)indexedPalette[j]>>8 & 0x000000FF)&0x000000FF;
> > +		      int b = ((uint32_t)orig_palette[i]>>0 & 0x000000FF-
> > +			      (uint32_t)indexedPalette[j]>>0 & 0x000000FF)&0x000000FF;
> > +		      int d = r+g+b;
> 
> This doesn't work. Consider orig_palette=126 and indexedPalette=128, the
> difference will be -2=0xFFFFFFFE. So you will add 0xFE=255 instead of 2.
> You either need an abs() or to square the rgb values, I would prefer the
> square.

Yikes. You're right - I was trying to avoid squaring and even abs():ing,
but obviously failed miserably. Of course, like the comment says, that
should be calculated by euclidean distance, but I figured just summing
the component differences is close enough. Thanks for the notice.

-- Heikki Lindholm




From M.Wache at gmx.net  Mon Sep 18 18:44:29 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 18 Sep 2006 18:44:29 +0200
Subject: [Softdevice-devel] [PATCH] Enable mgatv spic and YV12
In-Reply-To: <1158586503.15103.22.camel@marumake>
References: <450D86F1.1030200@cs.helsinki.fi> <450E696D.6080304@gmx.net>
	<1158586503.15103.22.camel@marumake>
Message-ID: <450ECCED.8060601@gmx.net>

Heikki Lindholm schrieb:
> ma, 2006-09-18 kello 11:39 +0200, Martin Wache kirjoitti:
>> Heikki Lindholm schrieb:
>>> The included patch makes dfb:mgatv use YV12 colourspace for video and
>>> the hardware subpicture layer for OSD. The patch is a prime example of
>>> bad goal-oriented programming, but does what I wanted: improves
>>> performance to the level that my 450 MHz P2 can now function as a DVB
>>> box like no underpowered P2 has done before! Unfortunately, the patch
>>> probably breaks everything else, but I'm too lazy to clean it up.
>>>
>> Can you please point out to me what the advantage of using the
>> subpicture layer is? To me it looks like the main speed change is that
>> you don't scale the osd. Or does the change to YV12 colourspace bring
>> some speed advantage?
> 
> Wow - this list has wonky ordering. See my previous mail about this.
>


From marko.makela at hut.fi  Mon Sep 18 19:05:04 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 18 Sep 2006 20:05:04 +0300
Subject: [Softdevice-devel] [PATCH] Enable mgatv spic and YV12
In-Reply-To: <450D86F1.1030200@cs.helsinki.fi>
References: <450D86F1.1030200@cs.helsinki.fi>
Message-ID: <20060918170504.GA2866@localhost.localdomain>

On Sun, Sep 17, 2006 at 08:33:37PM +0300, Heikki Lindholm wrote:
> The included patch makes dfb:mgatv use YV12 colourspace for video and 
> the hardware subpicture layer for OSD. The patch is a prime example of 
> bad goal-oriented programming, but does what I wanted: improves 
> performance to the level that my 450 MHz P2 can now function as a DVB 
> box like no underpowered P2 has done before! Unfortunately, the patch 
> probably breaks everything else, but I'm too lazy to clean it up.

I tried the patch.  When I compiled softdevice while vdr was running
(which will normally result in a SIGSEGV), the parameter
softdevice.AlsaDevice somehow changed from "default" to "ult".
It took me a while to figure out what was going on and how to resolve it.

Two issues:

1) The patch seems to ignore CropMode.  Both 16:9 and 4:3 programs are
blitted pixel for pixel, although the display should be scaled or
cropped.

2) The OSD colours are wrong much of the time.  For instance, when you
hit OK while playing a recording, the progress bar will not be updated
properly.

I did not measure CPU consumption, but it might have been slightly lower.

	Marko


From holindho at cs.helsinki.fi  Mon Sep 18 19:38:54 2006
From: holindho at cs.helsinki.fi (Heikki Lindholm)
Date: Mon, 18 Sep 2006 20:38:54 +0300
Subject: [Softdevice-devel] [PATCH] Enable mgatv spic and YV12
In-Reply-To: <450ECCED.8060601@gmx.net>
References: <450D86F1.1030200@cs.helsinki.fi> <450E696D.6080304@gmx.net>
	<1158586503.15103.22.camel@marumake>  <450ECCED.8060601@gmx.net>
Message-ID: <1158601134.15103.38.camel@marumake>

ma, 2006-09-18 kello 18:44 +0200, Martin Wache kirjoitti:
> Heikki Lindholm schrieb:
> > ma, 2006-09-18 kello 11:39 +0200, Martin Wache kirjoitti:
> >> Heikki Lindholm schrieb:
> >>> The included patch makes dfb:mgatv use YV12 colourspace for video and
> >>> the hardware subpicture layer for OSD. The patch is a prime example of
> >>> bad goal-oriented programming, but does what I wanted: improves
> >>> performance to the level that my 450 MHz P2 can now function as a DVB
> >>> box like no underpowered P2 has done before! Unfortunately, the patch
> >>> probably breaks everything else, but I'm too lazy to clean it up.
> >>>
> >> Can you please point out to me what the advantage of using the
> >> subpicture layer is? To me it looks like the main speed change is that
> >> you don't scale the osd. Or does the change to YV12 colourspace bring
> >> some speed advantage?
> > 
> > Wow - this list has wonky ordering. See my previous mail about this.
> >
> 
> From you other mail:
> > I didn't receive the above Martin's message at all - off list, perhaps? 
> > Anyway, if it's still about the topic in question, the keyword for using 
> > the subpicture layer from my perspective is 'incompetence': I couldn't 
> > get crtc2 (mgatv) video layer working with YV12 colourspace and blitted 
> > OSD, so, I thought maybe it'd work with a subpicture layer more 
> > effortlessly, and it did. So, the advantage for me isn't the OSD really, 
> > but the YV12 for the crtc2 video. YV12->YUY2 was simply too slow.
> > 
> Ah, yes I see. I forgot that for mgatv the default is YUY2, I thought
> that it is I420. Of course YV12 is faster compared to YUY2...
> 
> Why is YUY2 is the default at all? Is the OSD not working at all or is

Don't ask me.

> > Using YV12 and LUT44 both bring advantages of reduced memory 
> > requirements and are generally faster. I didn't implement the scaling 
> > routines for the LUT44 OSD, because I simply didn't grasp the idea of 
> > the existing code in 5 seconds, and realized that scaling would 
> > practically never be required by the tv output.
> > 
> Scaling LUT44 makes not much sense, the quality would be very low
> because of the limited colors. The simplest and fastest solution one

That's true. 2x and (1/2)x scaling might be passable.

> could do, would be to skip or repeat pixels. To adopt the existing
> scaling routines to indexed bitmaps would be dead slow, and probably
> still have a limited quality.
> I saw that you implemented ScaleVUpXXXLut() and ScaleVDownXXXLut(), that
> is not needed, if you don't scale only a CopyToBitmapLut() should be enough.
> But without scaling there probably will be complaints again because of
> the shift of the menu cursor and the menu when using the DVD-plugin.

What does the DVD plugin do? I haven't tried that one (either). 

> >> I would not mind adding support for an indexed bitmap, but currently I
> >> don't see the advantage. If we do that we should probably think again
> >> about the interface of GetOSDMode(), I never liked that very much, it
> >> was a hack from the start...
> > 
> > And I didn't add much style to that either :) Adding the indexed code is
> > useless if there are no other users and I'm not going to clean up the
> > mess I made in video-dfb anytime soon. Of course, if you'd add just the
> > SoftOsd bits (without maybe the OSD_WIDTH changes), it would make my
> > life easier when trying to keep up with cvs updates. 
> >
> No, either we apply the DFB part and the OSD part together or nothing. I

Firm but fair. I'm not going for that, for now, then. Maybe I'll update
the patch sometime and re-post.

-- Heikki Lindholm



From holindho at cs.helsinki.fi  Mon Sep 18 20:00:38 2006
From: holindho at cs.helsinki.fi (Heikki Lindholm)
Date: Mon, 18 Sep 2006 21:00:38 +0300
Subject: [Softdevice-devel] [PATCH] Enable mgatv spic and YV12
In-Reply-To: <20060918170504.GA2866@localhost.localdomain>
References: <450D86F1.1030200@cs.helsinki.fi>
	<20060918170504.GA2866@localhost.localdomain>
Message-ID: <1158602438.15103.57.camel@marumake>

ma, 2006-09-18 kello 20:05 +0300, Marko M?kel? kirjoitti:
> On Sun, Sep 17, 2006 at 08:33:37PM +0300, Heikki Lindholm wrote:
> > The included patch makes dfb:mgatv use YV12 colourspace for video and 
> > the hardware subpicture layer for OSD. The patch is a prime example of 
> > bad goal-oriented programming, but does what I wanted: improves 
> > performance to the level that my 450 MHz P2 can now function as a DVB 
> > box like no underpowered P2 has done before! Unfortunately, the patch 
> > probably breaks everything else, but I'm too lazy to clean it up.
> 
> I tried the patch.  When I compiled softdevice while vdr was running
> (which will normally result in a SIGSEGV), the parameter
> softdevice.AlsaDevice somehow changed from "default" to "ult".
> It took me a while to figure out what was going on and how to resolve it.
> 
> Two issues:
> 
> 1) The patch seems to ignore CropMode.  Both 16:9 and 4:3 programs are
> blitted pixel for pixel, although the display should be scaled or
> cropped.

No wonder. As I said I probably broke everything else in directfb
output. I left completely stupid hacks in the dfb driver. The patch is
more of a proof-of-concept than anything generally usable. Thanks for
testing, though.

> 2) The OSD colours are wrong much of the time.  For instance, when you
> hit OK while playing a recording, the progress bar will not be updated
> properly.

I noticed that, too. It's really weird. That one I'm going to fix (or
try), at least. Even letting the menu just hang there messes the colours
after a while eventhough I don't think anything is actually updated by
softdevice. 

> I did not measure CPU consumption, but it might have been slightly lower.

I get about 20% less CPU usage compared to YUY2, according to vmstat,
when measuring with a "lighter" transmission (544x576) that the CPU
could handle also in YUY2 without too many dropped frames. Because
there's much less blitting going on, there should also be much less
mga_wait_idle:ing going on.

-- Heikki Lindholm




From marko.makela at hut.fi  Mon Sep 18 20:19:52 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 18 Sep 2006 21:19:52 +0300
Subject: [Softdevice-devel] Error! Trying to unlock a nil picture...
	Ignoring.
Message-ID: <20060918181952.GA2739@localhost.localdomain>

I had suspended vdr for some 40 minutes using my suspend patch
(http://www.iki.fi/~msmakela/software/vdr#suspend).  When I hit
the Power key again, the display was powered up, but vdr did
not accept any commands from the RCU and the playback did not
resume.

Unfortunately, I did not think of attaching gdb to the vdr
process.  SIGINT and SIGHUP were ignored, so I had to SIGKILL
the process to get this:

[softdevice] Video Out seems to be OK
[softdevice] Initializing Audio Out
[softdevice] Audio out seems to be OK
[softdevice] A/V devices initialized, now initializing MPEG2 Decoder
[dfb] (re)configuring Videolayer to 720 x 576 (540x576)
[dfb] creating new surface (stretchBlit)
[surface capabilities] videoSurface: videoonly interlaced PixelFormat = 0x00200806
[dfb] (re)configured 0x00200806
Error! Trying to unlock a nil picture... Ignoring.
[mpeg2video @ 0xa7b5b8a8]ac-tex damaged at 11 17
[mpeg2video @ 0xa7b5b8a8]invalid mb type in I Frame at 7 30
[mpeg2video @ 0xa7b5b8a8]skipped MB in I frame at 3 31
[mpeg2video @ 0xa7b5b8a8]ac-tex damaged at 3 32
[mpeg2video @ 0xa7b5b8a8]ac-tex damaged at 2 33
[mpeg2video @ 0xa7b5b8a8]skipped MB in I frame at 9 34
[mpeg2video @ 0xa7b5b8a8]ac-tex damaged at 1 35
[mpeg2video @ 0xa7b5b8a8]Warning MVs not available
[mpeg2video @ 0xa7b5b8a8]concealing 855 DC, 855 AC, 855 MV errors
Killed

Even under normal operation of softdevice, I keep getting these
"Error! Trying to unlock a nil picture... Ignoring." every now and then.
Is there a race condition somewhere, or is this just faulty logic?

	Marko


From stefan at lucke.in-berlin.de  Mon Sep 18 20:37:17 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 18 Sep 2006 20:37:17 +0200
Subject: [Softdevice-devel] [PATCH] Enable mgatv spic and YV12
In-Reply-To: <450ECCED.8060601@gmx.net>
References: <450D86F1.1030200@cs.helsinki.fi>
	<1158586503.15103.22.camel@marumake> <450ECCED.8060601@gmx.net>
Message-ID: <200609182037.18029.stefan@lucke.in-berlin.de>

On Montag 18 September 2006 18:44, Martin Wache wrote:
> Heikki Lindholm schrieb:
> > ma, 2006-09-18 kello 11:39 +0200, Martin Wache kirjoitti:


> Ah, yes I see. I forgot that for mgatv the default is YUY2, I thought
> that it is I420. Of course YV12 is faster compared to YUY2...
> 
> Why is YUY2 is the default at all? Is the OSD not working at all or is
> only the StrechtBlitting not working?

For destination format ARGB, sourceformat I420 and YUV2 is not supported.
And if someone ask for BES: BES scaling is not supported for interlaced output.


> > And I didn't add much style to that either :) Adding the indexed code is
> > useless if there are no other users and I'm not going to clean up the
> > mess I made in video-dfb anytime soon. Of course, if you'd add just the
> > SoftOsd bits (without maybe the OSD_WIDTH changes), it would make my
> > life easier when trying to keep up with cvs updates. 
> >
> No, either we apply the DFB part and the OSD part together or nothing. I
> don't want to have some code in the softdevice which is not used and
> probably never will be used.
> What I wanted to say is, if you agree with Stefan on the DFB part, I
> don't mind if we add the OSD part (maybe with some modifications...).

So we leave this out, sorry. If there are other/better arguments we could 
discuss that later again.

For now we should look for a next release.


-- 
Stefan Lucke


From marko.makela at hut.fi  Mon Sep 18 20:50:20 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 18 Sep 2006 21:50:20 +0300
Subject: [Softdevice-devel] OSD layer not always fully cleared on mgatv
In-Reply-To: <20060918095530.GD3928@localhost.localdomain>
References: <20060918095530.GD3928@localhost.localdomain>
Message-ID: <20060918185020.GB2739@localhost.localdomain>

On Mon, Sep 18, 2006 at 12:55:30PM +0300, Marko M?kel? wrote:
> I'm using CVS versions of softdevice and DirectFB from one or two weeks
> ago, when Stefan fixed the big OSD flicker.
> 
> I occasionally see flicker on the OSD layer.  Sometimes, when I close the
> OSD, it appears that one of the two interlaced fields is not completely
> cleared.  A few top and bottom lines will flicker between transparent
> and their previous contents until another menu is opened.  Has anyone
> else experienced this?

One or two weeks ago I have noticed that when something is blanked
(made transparent) in the OSD of -vo dfb:mgatv, the change does not
happen immediately, but the pixels will fade out in at least 4 steps.

For instance, in the Recordings menu, those entries that are
subdirectories will only display a label for the Red button,
while recordings will display labels for all four colour buttons
at the bottom of the screen.  If I press the Down or Up key,
the labels for Yellow, Green, and Blue keys will appear or
disappear.  They will appear instantly, and the top lines of
the labels will disappear immediately.  The bottom 3 or so lines
will disappear gradually, possibly fading out one step every
1/25 seconds.  It takes about 1/2 or 1 second to fade out
completely.

I'm using the following OSD settings:

OSDHeight = 555
OSDLanguage = 8
OSDLeft = 36
OSDMessageTime = 1
OSDSkin = classic
OSDTheme = default
OSDTop = 12
OSDWidth = 672

Hopefully this information will help in tracking down the bug.

	Marko


From M.Wache at gmx.net  Mon Sep 18 21:12:04 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 18 Sep 2006 21:12:04 +0200
Subject: [Softdevice-devel] Error! Trying to unlock a nil
	picture...	Ignoring.
In-Reply-To: <20060918181952.GA2739@localhost.localdomain>
References: <20060918181952.GA2739@localhost.localdomain>
Message-ID: <450EEF84.5090808@gmx.net>

Marko M?kel? schrieb:
> I had suspended vdr for some 40 minutes using my suspend patch
> (http://www.iki.fi/~msmakela/software/vdr#suspend).  When I hit
> the Power key again, the display was powered up, but vdr did
> not accept any commands from the RCU and the playback did not
> resume.
> 
> Unfortunately, I did not think of attaching gdb to the vdr
> process.  SIGINT and SIGHUP were ignored, so I had to SIGKILL
> the process to get this:
> 
> [softdevice] Video Out seems to be OK
> [softdevice] Initializing Audio Out
> [softdevice] Audio out seems to be OK
> [softdevice] A/V devices initialized, now initializing MPEG2 Decoder
> [dfb] (re)configuring Videolayer to 720 x 576 (540x576)
> [dfb] creating new surface (stretchBlit)
> [surface capabilities] videoSurface: videoonly interlaced PixelFormat = 0x00200806
> [dfb] (re)configured 0x00200806
> Error! Trying to unlock a nil picture... Ignoring.
> [mpeg2video @ 0xa7b5b8a8]ac-tex damaged at 11 17
> [mpeg2video @ 0xa7b5b8a8]invalid mb type in I Frame at 7 30
> [mpeg2video @ 0xa7b5b8a8]skipped MB in I frame at 3 31
> [mpeg2video @ 0xa7b5b8a8]ac-tex damaged at 3 32
> [mpeg2video @ 0xa7b5b8a8]ac-tex damaged at 2 33
> [mpeg2video @ 0xa7b5b8a8]skipped MB in I frame at 9 34
> [mpeg2video @ 0xa7b5b8a8]ac-tex damaged at 1 35
> [mpeg2video @ 0xa7b5b8a8]Warning MVs not available
> [mpeg2video @ 0xa7b5b8a8]concealing 855 DC, 855 AC, 855 MV errors
> Killed
> 
> Even under normal operation of softdevice, I keep getting these
> "Error! Trying to unlock a nil picture... Ignoring." every now and then.
> Is there a race condition somewhere, or is this just faulty logic?
> 

The attached patch should fix the error message, but I don't think that
this is related to your problems. It is more a debugging message for me,
to remind me to code properly ;-)
The log you posted indicates that there as been bad signal during some
time. Maybe this has something to do with you problem?
Did this happen just one time or does it happen more often?

Martin
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: unlock.patch
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060918/1df1171d/attachment.ksh>

From marko.makela at hut.fi  Mon Sep 18 22:22:24 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 18 Sep 2006 23:22:24 +0300
Subject: [Softdevice-devel] Error! Trying to unlock a nil	picture...
	Ignoring.
In-Reply-To: <450EEF84.5090808@gmx.net>
References: <20060918181952.GA2739@localhost.localdomain>
	<450EEF84.5090808@gmx.net>
Message-ID: <20060918202224.GA3319@localhost.localdomain>

On Mon, Sep 18, 2006 at 09:12:04PM +0200, Martin Wache wrote:
> The log you posted indicates that there as been bad signal during some
> time. Maybe this has something to do with you problem?

It might have something to do with my patch suspending the MPEG stream in
cDevice::Action():

@@ -1201,8 +1203,16 @@ void cDevice::Action(void)
                  int Pid = (((uint16_t)b[1] & PID_MASK_HI) << 8) | b[2];
                  // Distribute the packet to all attached receivers:
                  Lock();
+                 int isSuspended = Setup.Suspend;
+                 if (!wasSuspended && isSuspended) {
+                    PrimaryDevice()->Clear();
+                    }
+                 wasSuspended = isSuspended;
                  for (int i = 0; i < MAXRECEIVERS; i++) {
-                     if (receiver[i] && receiver[i]->WantsPid(Pid))
+                     if (!receiver[i]);
+                     else if (isSuspended &&
+                              !dynamic_cast<cRecorder *>(receiver[i]));
+                     else if (receiver[i]->WantsPid(Pid))
                         receiver[i]->Receive(b, TS_SIZE);
                      }
                  Unlock();

I think it is up to what PrimaryDevice()->Clear() does.  The stream will
be suspended or resumed at packet boundary.  Doing it at GOP boundary
would probably be nicer.  I have seen some garbled video for one or
two seconds after resuming live playback.

> Did this happen just one time or does it happen more often?

The hang may have happened once or twice before.  I cannot remember when
the last time was.

	Marko


From M.Wache at gmx.net  Tue Sep 19 15:38:40 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 19 Sep 2006 15:38:40 +0200
Subject: [Softdevice-devel] Error! Trying to unlock a
	nil	picture...	Ignoring.
In-Reply-To: <20060918202224.GA3319@localhost.localdomain>
References: <20060918181952.GA2739@localhost.localdomain>	<450EEF84.5090808@gmx.net>
	<20060918202224.GA3319@localhost.localdomain>
Message-ID: <450FF2E0.9020904@gmx.net>

Marko M?kel? schrieb:
> On Mon, Sep 18, 2006 at 09:12:04PM +0200, Martin Wache wrote:
>> The log you posted indicates that there as been bad signal during some
>> time. Maybe this has something to do with you problem?
> 
> It might have something to do with my patch suspending the MPEG stream in
> cDevice::Action():
> 
> @@ -1201,8 +1203,16 @@ void cDevice::Action(void)
>                   int Pid = (((uint16_t)b[1] & PID_MASK_HI) << 8) | b[2];
>                   // Distribute the packet to all attached receivers:
>                   Lock();
> +                 int isSuspended = Setup.Suspend;
> +                 if (!wasSuspended && isSuspended) {
> +                    PrimaryDevice()->Clear();
> +                    }
> +                 wasSuspended = isSuspended;
>                   for (int i = 0; i < MAXRECEIVERS; i++) {
> -                     if (receiver[i] && receiver[i]->WantsPid(Pid))
> +                     if (!receiver[i]);
> +                     else if (isSuspended &&
> +                              !dynamic_cast<cRecorder *>(receiver[i]));
> +                     else if (receiver[i]->WantsPid(Pid))
>                          receiver[i]->Receive(b, TS_SIZE);
>                       }
>                   Unlock();
> 
> I think it is up to what PrimaryDevice()->Clear() does.  The stream will
> be suspended or resumed at packet boundary.  Doing it at GOP boundary
> would probably be nicer.  I have seen some garbled video for one or
> two seconds after resuming live playback.
> 
Yes, this could indeed be the cause for the messages.

>> Did this happen just one time or does it happen more often?
> 
> The hang may have happened once or twice before.  I cannot remember when
> the last time was.
>

Well, it's not much information we have, so it is difficult to say
anything about it. To be honest currently I don't have a clue what could
cause this. It sounds a bit like a deadlock...

Martin


From M.Wache at gmx.net  Tue Sep 19 16:01:55 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 19 Sep 2006 16:01:55 +0200
Subject: [Softdevice-devel] [PATCH] move setupStore into shared memory (for
	ShmClient)
Message-ID: <450FF853.9040306@gmx.net>

Hi List,

I'm posting a patch for testing which moves the setupStore into shared
memory. This enables some more features, like changing brightness, hue
and contrast for the ShmClient.
This patch is quite intrusive, but most of the changes are trivial
because the variable setupStore is now a pointer. If this patch works
and is merged into the CVS we can start introducing parameters for the
ShmClient.
Comments and failure/success reports are welcome!

Bye,
Martin


From M.Wache at gmx.net  Tue Sep 19 16:03:21 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 19 Sep 2006 16:03:21 +0200
Subject: [Softdevice-devel] [PATCH] move setupStore into shared memory
 (for	ShmClient)
In-Reply-To: <450FF853.9040306@gmx.net>
References: <450FF853.9040306@gmx.net>
Message-ID: <450FF8A9.6080000@gmx.net>

Martin Wache schrieb:
> Hi List,
> 
> I'm posting a patch for testing which moves the setupStore into shared
> memory. This enables some more features, like changing brightness, hue
> and contrast for the ShmClient.
> This patch is quite intrusive, but most of the changes are trivial
> because the variable setupStore is now a pointer. If this patch works
> and is merged into the CVS we can start introducing parameters for the
> ShmClient.
> Comments and failure/success reports are welcome!
> 
And here comes the patch ;-)
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: setupStore.patch
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060919/4c707f59/attachment.ksh>

From marko.makela at hut.fi  Tue Sep 19 21:37:44 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 19 Sep 2006 22:37:44 +0300
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long time
In-Reply-To: <450FF2E0.9020904@gmx.net>
References: <20060918181952.GA2739@localhost.localdomain>
	<450EEF84.5090808@gmx.net>
	<20060918202224.GA3319@localhost.localdomain>
	<450FF2E0.9020904@gmx.net>
Message-ID: <20060919193743.GA2796@localhost.localdomain>

On Tue, Sep 19, 2006 at 03:38:40PM +0200, Martin Wache wrote:
> Well, it's not much information we have, so it is difficult to say
> anything about it. To be honest currently I don't have a clue what could
> cause this. It sounds a bit like a deadlock...

Indeed, it feels like a deadlock.  Fortunately, the problem appears to be
repeatable.  Tonight, I had the MPEG stream suspended for almost an hour.
When I restarted, the display was powered on and audio played for less than
a second before the system hung.  (Audio output may have been produced for
more than a second, but it takes some time for the monitor to power on.)

Here's the syslog from the time of the hang:

Sep 19 22:19:10 vdr sshd[2375]: Accepted publickey for vdr from 10.0.0.3 port 34216 ssh2
Sep 19 22:19:18 vdr kernel: cx88[1]/2: cx8802_restart_queue
Sep 19 22:19:18 vdr kernel: cx88[1]/2: cx8802_restart_queue: queue is empty
Sep 19 22:19:18 vdr kernel: cx88[1]/2: queue is empty - first active
Sep 19 22:19:18 vdr kernel: cx88[1]/2: cx8802_start_dma w: 0, h: 0, f: 2
Sep 19 22:19:18 vdr kernel: cx88[1]/2: setting the interrupt mask
Sep 19 22:19:18 vdr kernel: cx88[1]/2: [bf0fc760/0] cx8802_buf_queue - first active
Sep 19 22:19:18 vdr kernel: cx88[1]/2: cx8802_restart_queue
Sep 19 22:19:18 vdr kernel: cx88[1]/2: cx8802_restart_queue: queue is empty
Sep 19 22:19:18 vdr kernel: cx88[1]/2: queue is empty - first active
Sep 19 22:19:18 vdr kernel: cx88[1]/2: cx8802_start_dma w: 0, h: 0, f: 2
Sep 19 22:19:18 vdr kernel: cx88[1]/2: setting the interrupt mask
Sep 19 22:19:18 vdr kernel: cx88[1]/2: [bf0fc0a0/0] cx8802_buf_queue - first active
Sep 19 22:19:18 vdr kernel: cx88[1]/2: cx8802_restart_queue
Sep 19 22:19:18 vdr kernel: cx88[1]/2: cx8802_restart_queue: queue is empty
Sep 19 22:19:18 vdr kernel: cx88[1]/2: queue is empty - first active
Sep 19 22:19:18 vdr kernel: cx88[1]/2: cx8802_start_dma w: 0, h: 0, f: 2
Sep 19 22:19:18 vdr kernel: cx88[1]/2: setting the interrupt mask
Sep 19 22:19:18 vdr kernel: cx88[1]/2: [bf0fc760/0] cx8802_buf_queue - first active
Sep 19 22:19:27 vdr vdr: [1322] cAudioRepacker(0xC0): skipped 512 bytes to sync
on next audio frame
Sep 19 22:19:34 vdr vdr: [1323] ERROR: 1 ring buffer overflow (177 bytes dropped)
Sep 19 22:19:40 vdr vdr: [1323] ERROR: 10256 ring buffer overflows (1928128 bytes dropped)
Sep 19 22:19:46 vdr vdr: [1323] ERROR: 11692 ring buffer overflows (2198096 bytes dropped)
Sep 19 22:19:52 vdr vdr: [1323] ERROR: 11317 ring buffer overflows (2127596 bytes dropped)
Sep 19 22:19:58 vdr vdr: [1323] ERROR: 11251 ring buffer overflows (2115188 bytes dropped)
Sep 19 22:20:04 vdr vdr: [1323] ERROR: 13308 ring buffer overflows (2501904 bytes dropped)

Those cx88 messages repeat several times a minute, and they are harmless
if I remember correctly the discussion on the v4l mailing list.
The only non-cx88 message since the playback was suspended was this one:

Sep 19 21:44:11 vdr dhclient: DHCPREQUEST on eth0 to 193.229.28.26 port 67
Sep 19 21:44:11 vdr dhclient: DHCPACK from 193.229.28.26
Sep 19 21:44:11 vdr dhclient: bound to 88.113.69.182 -- renewal in 3600 seconds.

Before resuming playback, I checked the vdr log.  The tail looks like this:

[dfb] (re)configuring Videolayer to 704 x 576 (704x576)
[dfb] creating new surface (stretchBlit)
[surface capabilities] videoSurface: videoonly interlaced PixelFormat = 0x00200806
[dfb] (re)configured 0x00200806
[dfb] (re)configuring Videolayer to 720 x 576 (540x576)
[dfb] creating new surface (stretchBlit)
[surface capabilities] videoSurface: videoonly interlaced PixelFormat = 0x00200806
[dfb] (re)configured 0x00200806
[mpeg2video @ 0xa7b448a8]skipped MB in I frame at 34 0
[mpeg2video @ 0xa7b448a8]ac-tex damaged at 4 31
[mpeg2video @ 0xa7b448a8]ac-tex damaged at 0 32
[mpeg2video @ 0xa7b448a8]ac-tex damaged at 1 34
[mpeg2video @ 0xa7b448a8]ac-tex damaged at 1 35
[mpeg2video @ 0xa7b448a8]Warning MVs not available
[mpeg2video @ 0xa7b448a8]concealing 1575 DC, 1575 AC, 1575 MV errors
[mpeg2video @ 0xa7b448a8]concealing 1575 DC, 1575 AC, 1575 MV errors
[mpeg2video @ 0xa7b448a8]concealing 1575 DC, 1575 AC, 1575 MV errors

I can't remember if the second "(re)configuring" message was already there
before resuming playback.  The MPEG errors certainly weren't there.

After the hang, I attached gdb to the process and captured full stack trace
of all threads (gzipped output attached).  I hope that this helps.

	Marko
-------------- next part --------------
A non-text attachment was scrubbed...
Name: gdb.txt.gz
Type: application/octet-stream
Size: 4422 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060919/480b5abc/attachment.obj>

From marko.makela at hut.fi  Tue Sep 19 21:48:39 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 19 Sep 2006 22:48:39 +0300
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long
	time
In-Reply-To: <20060919193743.GA2796@localhost.localdomain>
References: <20060918181952.GA2739@localhost.localdomain>
	<450EEF84.5090808@gmx.net>
	<20060918202224.GA3319@localhost.localdomain>
	<450FF2E0.9020904@gmx.net>
	<20060919193743.GA2796@localhost.localdomain>
Message-ID: <20060919194839.GB2796@localhost.localdomain>

On Tue, Sep 19, 2006 at 10:37:44PM +0300, Marko M?kel? wrote:
> After the hang, I attached gdb to the process and captured full stack trace
> of all threads (gzipped output attached).  I hope that this helps.

There was also another vdr process that had consumed virtually no CPU,
consisting of a single thread:

#0  0xa7dd4e19 in poll () from /lib/tls/libc.so.6
#1  0xa77ae441 in snd_pcm_direct_check_interleave ()
   from /usr/lib/libasound.so.2
#2  0xa77ae95c in snd_pcm_direct_server_create () from /usr/lib/libasound.so.2
#3  0xa77a7b8c in snd_pcm_dmix_open () from /usr/lib/libasound.so.2
#4  0xa77a7fd2 in _snd_pcm_dmix_open () from /usr/lib/libasound.so.2
#5  0xa776d824 in snd_pcm_free () from /usr/lib/libasound.so.2
#6  0xa776dea8 in snd_pcm_free () from /usr/lib/libasound.so.2
#7  0xa776e143 in snd_pcm_open_slave () from /usr/lib/libasound.so.2
#8  0xa77928f4 in _snd_pcm_plug_open () from /usr/lib/libasound.so.2
#9  0xa776d824 in snd_pcm_free () from /usr/lib/libasound.so.2
#10 0xa776e172 in snd_pcm_open_slave () from /usr/lib/libasound.so.2
#11 0xa77aeb92 in _snd_pcm_asym_open () from /usr/lib/libasound.so.2
#12 0xa776d824 in snd_pcm_free () from /usr/lib/libasound.so.2
#13 0xa776dea8 in snd_pcm_free () from /usr/lib/libasound.so.2
#14 0xa78715e4 in cAlsaAudioOut (this=0xa77aea60, setupStore=0xa7b4eb00)
    at audio-alsa.c:44
#15 0xa785b382 in cSoftDevice (this=0x8286d88, method=3, audioMethod=1,
    pluginPath=0x81cf0a0 "./PLUGINS/lib/") at softdevice.c:299
#16 0xa785b468 in cPluginSoftDevice::Initialize (this=0x81cf080)
    at softdevice.c:1039
#17 0x080cd2e8 in cPluginManager::InitializePlugins (this=0xafba7bc4)
    at plugin.c:340
#18 0x080fc8f3 in main (argc=9, argv=0xafba7d14) at vdr.c:567

According to the pid, this process is slightly newer than the multi-threaded
vdr process:

F S   UID   PID  PPID  C PRI  NI ADDR SZ WCHAN  TTY        TIME CMD
0 T  1001   637   620 14  76   0 - 37515 ptrace ?         17:16 ./vdr -l1 -Psoft
1 T  1001   699     1  0  75   0 - 22133 ptrace ?          0:00 ./vdr -l1 -Psoft

I don't think that it was launched by my runvdr script (PID 620).
Besides, there is only one line "[softdevice] processing args"
in my /tmp/vdr.log.  Could vdr fork processes for plugin initialization?
This is on NPTL.

	Marko


From M.Wache at gmx.net  Tue Sep 19 22:44:58 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 19 Sep 2006 22:44:58 +0200
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long
 time
In-Reply-To: <20060919193743.GA2796@localhost.localdomain>
References: <20060918181952.GA2739@localhost.localdomain>	<450EEF84.5090808@gmx.net>	<20060918202224.GA3319@localhost.localdomain>	<450FF2E0.9020904@gmx.net>
	<20060919193743.GA2796@localhost.localdomain>
Message-ID: <451056CA.3030006@gmx.net>

Marko M?kel? schrieb:
> I can't remember if the second "(re)configuring" message was already there
> before resuming playback.  The MPEG errors certainly weren't there.
> 
> After the hang, I attached gdb to the process and captured full stack trace
> of all threads (gzipped output attached).  I hope that this helps.
> 
Maybe this is something:
#5  0x080f3932 in cMutex::Lock (this=0x8287eb0) at thread.c:190
No locals.
#6  0xa7874874 in cDFBVideoOut::YUV (this=0x8287a18, buf=0x8287a8c)
    at video-dfb.c:1440
	src = {x = 90, y = 0, w = 540, h = 576}
	dst = {x = 0, y = 18, w = 720, h = 540}
	dst = (uint8_t *) 0xa3908000 <Address 0xa3908000 out of bounds>
	pitch = 1536
	hi = 0
	Py = (
    uint8_t *) 0xa675e018
"\202\202\202\202\202\202\202\202\203\203\203\203\202\202\202\201\202\201\201\201\200\200\200\200\200\200\200\200\177\177\177~\177~~~}}}}}}}}|||{|{{{zzzzzzzzyyyxyxxxwwwwwwwwvvvuvuuuttttttttsssrsrrrqqqqqqqqpppopooonnnnnnnnmmmlmlllkkkkkkkkjjjijiiihhhhhhhhgggfgfffeeeeeeeedddcdcccbbbbbbbbaaa`a```____"...
	Pu = (uint8_t *) 0x86542c8 '\200' <repeats 200 times>...
	Pv = <value optimized out>
	Width = 720
	Height = 576

the video decoding thread is locked by the osdMutex, but I can't find
the cVideo thread, the only other thread which also takes the mutex. I
don't think that the osdMutex is needed for vdr version > 1.3.7, so you
can try to remove the osdMutex from video-dfb. Maybe we can even remove
it completely.

Bye,
Martin


From stefan at lucke.in-berlin.de  Tue Sep 19 23:44:05 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 19 Sep 2006 23:44:05 +0200
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long
	time
In-Reply-To: <451056CA.3030006@gmx.net>
References: <20060918181952.GA2739@localhost.localdomain>
	<20060919193743.GA2796@localhost.localdomain>
	<451056CA.3030006@gmx.net>
Message-ID: <200609192344.05613.stefan@lucke.in-berlin.de>

On Dienstag 19 September 2006 22:44, Martin Wache wrote:
> Marko M?kel? schrieb:
> > I can't remember if the second "(re)configuring" message was already there
> > before resuming playback.  The MPEG errors certainly weren't there.
> > 
> > After the hang, I attached gdb to the process and captured full stack trace
> > of all threads (gzipped output attached).  I hope that this helps.
> > 
> Maybe this is something:
> #5  0x080f3932 in cMutex::Lock (this=0x8287eb0) at thread.c:190
> No locals.
> #6  0xa7874874 in cDFBVideoOut::YUV (this=0x8287a18, buf=0x8287a8c)
>     at video-dfb.c:1440
> 	src = {x = 90, y = 0, w = 540, h = 576}
> 	dst = {x = 0, y = 18, w = 720, h = 540}
> 	dst = (uint8_t *) 0xa3908000 <Address 0xa3908000 out of bounds>
> 	pitch = 1536
> 	hi = 0
> 	Py = (
>     uint8_t *) 0xa675e018
> "\202\202\202\202\202\202\202\202\203\203\203\203\202\202\202\201\202\201\201\201\200\200\200\200\200\200\200\200\177\177\177~\177~~~}}}}}}}}|||{|{{{zzzzzzzzyyyxyxxxwwwwwwwwvvvuvuuuttttttttsssrsrrrqqqqqqqqpppopooonnnnnnnnmmmlmlllkkkkkkkkjjjijiiihhhhhhhhgggfgfffeeeeeeeedddcdcccbbbbbbbbaaa`a```____"...
> 	Pu = (uint8_t *) 0x86542c8 '\200' <repeats 200 times>...
> 	Pv = <value optimized out>
> 	Width = 720
> 	Height = 576
> 
> the video decoding thread is locked by the osdMutex, but I can't find
> the cVideo thread, the only other thread which also takes the mutex. I
> don't think that the osdMutex is needed for vdr version > 1.3.7, so you
> can try to remove the osdMutex from video-dfb. Maybe we can even remove
> it completely.

No. Don't remove osdMutex as long as video displaying is called from one,
and OSD drawing is called from another thread.

I guess old_picture is protected by the wrong mutex in Action() in video.c
Test and call DrawStill_420pl(old_picture) must be protected against
actions of SetOldPicture().

So assingments and use of old_picture must by protected by a separate mutex.

-- 
Stefan Lucke


From jonis2006 at yandex.ru  Wed Sep 20 06:24:21 2006
From: jonis2006 at yandex.ru (jonis2006)
Date: Wed, 20 Sep 2006 08:24:21 +0400 (MSD)
Subject: [Softdevice-devel] Picture color defects.
Message-ID: <4510C275.000001.13426@webmail10.yandex.ru>

Hello !

When I watching channels sometime I see color defects at the edges of objects in the screen. 
Here is screenshots which describing this problem.

http://woody.on.ufanet.ru/001.vdr
http://woody.on.ufanet.ru/defect1.JPG (Pink lines near red color)
http://woody.on.ufanet.ru/defect2.JPG (Edges of circle with picks)
http://woody.on.ufanet.ru/defect3.JPG (Edges of circle with picks)

In Mplayer I got same problem.

Is this possible to fix ?
Maybe packed color (Packed YUY2) causes problem ?

With best regards.
Jonis.


From jonis2006 at yandex.ru  Wed Sep 20 06:24:21 2006
From: jonis2006 at yandex.ru (jonis2006)
Date: Wed, 20 Sep 2006 08:24:21 +0400 (MSD)
Subject: [Softdevice-devel] Picture color defects.
Message-ID: <4510C275.000001.13426@webmail10.yandex.ru>

Hello !

When I watching channels sometime I see color defects at the edges of objects in the screen. 
Here is screenshots which describing this problem.

http://woody.on.ufanet.ru/001.vdr
http://woody.on.ufanet.ru/defect1.JPG (Pink lines near red color)
http://woody.on.ufanet.ru/defect2.JPG (Edges of circle with picks)
http://woody.on.ufanet.ru/defect3.JPG (Edges of circle with picks)

In Mplayer I got same problem.

Is this possible to fix ?
Maybe packed color (Packed YUY2) causes problem ?

With best regards.
Jonis.


From M.Wache at gmx.net  Wed Sep 20 10:20:49 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Wed, 20 Sep 2006 10:20:49 +0200
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long
 time
In-Reply-To: <200609192344.05613.stefan@lucke.in-berlin.de>
References: <20060918181952.GA2739@localhost.localdomain>	<20060919193743.GA2796@localhost.localdomain>	<451056CA.3030006@gmx.net>
	<200609192344.05613.stefan@lucke.in-berlin.de>
Message-ID: <4510F9E1.3080504@gmx.net>

Stefan Lucke schrieb:
> On Dienstag 19 September 2006 22:44, Martin Wache wrote:
>> Marko M?kel? schrieb:
>>> I can't remember if the second "(re)configuring" message was already there
>>> before resuming playback.  The MPEG errors certainly weren't there.
>>>
>>> After the hang, I attached gdb to the process and captured full stack trace
>>> of all threads (gzipped output attached).  I hope that this helps.
>>>
>> Maybe this is something:
>> #5  0x080f3932 in cMutex::Lock (this=0x8287eb0) at thread.c:190
>> No locals.
>> #6  0xa7874874 in cDFBVideoOut::YUV (this=0x8287a18, buf=0x8287a8c)
>>     at video-dfb.c:1440
>> 	src = {x = 90, y = 0, w = 540, h = 576}
>> 	dst = {x = 0, y = 18, w = 720, h = 540}
>> 	dst = (uint8_t *) 0xa3908000 <Address 0xa3908000 out of bounds>
>> 	pitch = 1536
>> 	hi = 0
>> 	Py = (
>>     uint8_t *) 0xa675e018
>> "\202\202\202\202\202\202\202\202\203\203\203\203\202\202\202\201\202\201\201\201\200\200\200\200\200\200\200\200\177\177\177~\177~~~}}}}}}}}|||{|{{{zzzzzzzzyyyxyxxxwwwwwwwwvvvuvuuuttttttttsssrsrrrqqqqqqqqpppopooonnnnnnnnmmmlmlllkkkkkkkkjjjijiiihhhhhhhhgggfgfffeeeeeeeedddcdcccbbbbbbbbaaa`a```____"...
>> 	Pu = (uint8_t *) 0x86542c8 '\200' <repeats 200 times>...
>> 	Pv = <value optimized out>
>> 	Width = 720
>> 	Height = 576
>>
>> the video decoding thread is locked by the osdMutex, but I can't find
>> the cVideo thread, the only other thread which also takes the mutex. I
>> don't think that the osdMutex is needed for vdr version > 1.3.7, so you
>> can try to remove the osdMutex from video-dfb. Maybe we can even remove
>> it completely.
> 
> No. Don't remove osdMutex as long as video displaying is called from one,
> and OSD drawing is called from another thread.
> 
If DirectFB isn't thread safe, then use a special mutex for protecting
DirectFB calls and not osdMutex.
The problem here is that the cVideo::Action() thread grabs osdMutex and
than calls DrawStill_420pl() which grabs areaMutex, then calls
cDirectFB::YUV() which grabs again(!) osdMutex. This only works because
vdr uses PTHREAD_MUTEX_ERRORCHECK_NP, which is probably a bad idea from
the start...
Of course DrawVideo_420pl() is called by the video decoder thread, it
grabs areaMutex, and calls cDirectFB:YUV() which grabs osdMutex.
Now consider this:
cVideo::Action() grabs osdMutex, and is put to sleep before areaMutex
can be taken. Now comes the decoder thread, it calls DrawVideo_420pl(),
grabs areaMutex, calls cDirectFB::YUV() which tries to take osdMutex.
BANG! Nothing happens anymore, because the cVideo thread can't take
areaMutex and the decoder thread can't take the osdMutex. Deadlock.

The same may happen if you protect old_picture by osdMutex.

I checked cSoftOsd, there is clearly a lock missing, which protects from
interleaved GetLockOsdSurface() and GetUnlockOsdsurface() calls by
different threads. I think I will create a mutex which protects all
calls to cVideo, so that we can be sure that the cVideo osd stuff is
only called separately.

If the video out driver can't allow parallel calls to YUV() and osd
methods there should be a private lock in the video out driver which
protects from that.

That leaves only parallel calls to YUV() by the cVideo thread and by the
decoder thread which should be caught by the areaMutex, about
old_picture we should see.

I would suggest to check what osdMutex is actually protecting, in some
places I really don't know that. So for protecting what is the osdMutex
needed?

Bye,
Martin


From marko.makela at hut.fi  Wed Sep 20 12:27:53 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 20 Sep 2006 13:27:53 +0300
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long
	time
In-Reply-To: <4510F9E1.3080504@gmx.net>
References: <20060918181952.GA2739@localhost.localdomain>
	<20060919193743.GA2796@localhost.localdomain>
	<451056CA.3030006@gmx.net>
	<200609192344.05613.stefan@lucke.in-berlin.de>
	<4510F9E1.3080504@gmx.net>
Message-ID: <20060920102753.GE24354@localhost.localdomain>

On Wed, Sep 20, 2006 at 10:20:49AM +0200, Martin Wache wrote:
> I would suggest to check what osdMutex is actually protecting, in some
> places I really don't know that. So for protecting what is the osdMutex
> needed?

It might be a good idea to try running softdevice under Helgrind,
which implements the Eraser algorithm for detecting data races.

FWIW, a good design principle would be to avoid deadlocks by avoiding
cycles in the waits-for graph altogether.  This can be achieved by having
all threads acquire mutexes in the same order (and to release them in the
opposite order in a stack-like fashion).  Assign a rank to each mutex,
and make sure that each thread can acquire only mutexes of lower rank
than those it is currently holding.

	Marko


From stefan at lucke.in-berlin.de  Thu Sep 21 07:49:48 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 21 Sep 2006 07:49:48 +0200
Subject: [Softdevice-devel]
	=?iso-8859-15?q?=5BPATCH=5D_move_setupStore_in?=
	=?iso-8859-15?q?to_shared_memory_=28_for=09ShmClient_=29?=
In-Reply-To: <450FF8A9.6080000@gmx.net>
References: <450FF853.9040306@gmx.net> <450FF8A9.6080000@gmx.net>
Message-ID: <200609210749.48937.stefan@lucke.in-berlin.de>

On Dienstag 19 September 2006 16:03, Martin Wache wrote:
> Martin Wache schrieb:
> > Hi List,
> > 
> > I'm posting a patch for testing which moves the setupStore into shared
> > memory. This enables some more features, like changing brightness, hue
> > and contrast for the ShmClient.
> > This patch is quite intrusive, but most of the changes are trivial
> > because the variable setupStore is now a pointer. If this patch works
> > and is merged into the CVS we can start introducing parameters for the
> > ShmClient.
> > Comments and failure/success reports are welcome!
> > 
> And here comes the patch ;-)

I did not test this, but it seems to be just replacing  class access by struct access.

Can you keep the pointers to voArgs + aoArgs ?

I know they are currently unused but by this videoout class constructor can access
complete vo parameter string. But it's really not so important. If we need specific
parameter for DirectFB it is easy to reintroduce at least voArgs.


-- 
Stefan Lucke


From nicolas at huillard.net  Thu Sep 21 08:55:26 2006
From: nicolas at huillard.net (Nicolas Huillard)
Date: Thu, 21 Sep 2006 08:55:26 +0200
Subject: [Softdevice-devel] Picture color defects.
In-Reply-To: <4510C275.000001.13426@webmail10.yandex.ru>
References: <4510C275.000001.13426@webmail10.yandex.ru>
Message-ID: <4512375E.3090409@huillard.net>

jonis2006 a ?crit :
> Hello !
> 
> When I watching channels sometime I see color defects at the edges of objects in the screen. 
> Here is screenshots which describing this problem.
> 
> http://woody.on.ufanet.ru/001.vdr
> http://woody.on.ufanet.ru/defect1.JPG (Pink lines near red color)
> http://woody.on.ufanet.ru/defect2.JPG (Edges of circle with picks)
> http://woody.on.ufanet.ru/defect3.JPG (Edges of circle with picks)

It seems like artifacts I had while tuning TV-out registers on VT1622
(S-video output on EPIA M10k).
* wrong color lines may be related to S-video ou Composite, or color
conversion inside the TV encoder (VT1622)
* edges in circles (or generally steps on diangonal lines) is related to
vertical scaling that take place inside the TV encoder (some lines are
dropped, and even the smoothing engine can add more obvious artifact on
particular patterns only)

Can you detail the outpu you use ?
If using a TV encoder, you should adjust the scaling/color correcton
that that place there.

> In Mplayer I got same problem.
> 
> Is this possible to fix ?
> Maybe packed color (Packed YUY2) causes problem ?
> 
> With best regards.
> Jonis.

-- 
NH



From M.Wache at gmx.net  Thu Sep 21 12:28:13 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 21 Sep 2006 12:28:13 +0200
Subject: [Softdevice-devel] [PATCH] move setupStore into shared memory (
 for ShmClient )
In-Reply-To: <200609210749.48937.stefan@lucke.in-berlin.de>
References: <450FF853.9040306@gmx.net> <450FF8A9.6080000@gmx.net>
	<200609210749.48937.stefan@lucke.in-berlin.de>
Message-ID: <4512693D.9070307@gmx.net>

Stefan Lucke schrieb:
> On Dienstag 19 September 2006 16:03, Martin Wache wrote:
>> Martin Wache schrieb:
>>> Hi List,
>>>
>>> I'm posting a patch for testing which moves the setupStore into shared
>>> memory. This enables some more features, like changing brightness, hue
>>> and contrast for the ShmClient.
>>> This patch is quite intrusive, but most of the changes are trivial
>>> because the variable setupStore is now a pointer. If this patch works
>>> and is merged into the CVS we can start introducing parameters for the
>>> ShmClient.
>>> Comments and failure/success reports are welcome!
>>>
>> And here comes the patch ;-)
> 
> I did not test this, but it seems to be just replacing  class access by struct access.
>
Yes, this is necessary because I don't think one can put objects into a
shared memory block. At least not objects with virtual members.

> Can you keep the pointers to voArgs + aoArgs ?
> 
Sure, we can keep it. But I noticed a bug which could cause segfaults,
and since it is not used, I removed it. It is not a big thing, so it can
very easy be reintroduced as soon as there are some videoout classes
which use the parameters.
I would prefer to remove it until it is actually used.

Bye,
Martin


From M.Wache at gmx.net  Thu Sep 21 12:53:14 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 21 Sep 2006 12:53:14 +0200
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long
 time
In-Reply-To: <20060920102753.GE24354@localhost.localdomain>
References: <20060918181952.GA2739@localhost.localdomain>	<20060919193743.GA2796@localhost.localdomain>	<451056CA.3030006@gmx.net>	<200609192344.05613.stefan@lucke.in-berlin.de>	<4510F9E1.3080504@gmx.net>
	<20060920102753.GE24354@localhost.localdomain>
Message-ID: <45126F1A.4050805@gmx.net>

Marko M?kel? schrieb:
> On Wed, Sep 20, 2006 at 10:20:49AM +0200, Martin Wache wrote:
>> I would suggest to check what osdMutex is actually protecting, in some
>> places I really don't know that. So for protecting what is the osdMutex
>> needed?
> 
> It might be a good idea to try running softdevice under Helgrind,
> which implements the Eraser algorithm for detecting data races.
> 
I never worked with Helgrind, but maybe I will it give a try.

> FWIW, a good design principle would be to avoid deadlocks by avoiding
> cycles in the waits-for graph altogether.  This can be achieved by having
> all threads acquire mutexes in the same order (and to release them in the
> opposite order in a stack-like fashion).  Assign a rank to each mutex,
> and make sure that each thread can acquire only mutexes of lower rank
> than those it is currently holding.
>
Sure, ranks for all mutexes would help to solve those problems. But I
don't think we actually need them, cVideo is just not complicated enough
;-). We currently have two mutexes in cVideo, I actually don't think
that we need both of them. If we can get rid of one of them, we should
not have any problems with deadlocks.
If some videout driver needs locks to protect calls to actual drivers,
thats not a problem as long as no other methods of cVideo are called
with the lock held.

Bye,
Martin


From t-erdmann at web.de  Thu Sep 21 18:22:51 2006
From: t-erdmann at web.de (Thomas Erdmann)
Date: Thu, 21 Sep 2006 18:22:51 +0200
Subject: [Softdevice-devel] softdevice xv and i915 Notebook
Message-ID: <200609211822.51577.t-erdmann@web.de>

Hello List,
i copied my running vdr with softdevice from a nVidia Geforce 6600 System to 
an intel notebook with 915 chip set.
The X -Server is set up for 1400x1050, which is the native display resolution.
When i start vdr with softdevice it runs until pressing 'f' for full screen or 
doing some window resizing. Then or after some restarts the X -Server crashes 
and leaves a flat grey full screen picture and only a >4s pressing of the 
power button leads to any action, here to do a shut down.

I tried my older "known good" softdevice version and also a newer cvs download 
a few days before, all showed the same problem.

Does anyone use the same driver or has same hints for me ?

In the command line i use -P'softdevice xv:max-area'.

Thanks
  Thomas


From stefan at lucke.in-berlin.de  Fri Sep 22 06:37:05 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 22 Sep 2006 06:37:05 +0200
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long
	time
In-Reply-To: <45126F1A.4050805@gmx.net>
References: <20060918181952.GA2739@localhost.localdomain>
	<20060920102753.GE24354@localhost.localdomain>
	<45126F1A.4050805@gmx.net>
Message-ID: <200609220637.05681.stefan@lucke.in-berlin.de>

On Donnerstag 21 September 2006 12:53, Martin Wache wrote:
> Marko M?kel? schrieb:
> > On Wed, Sep 20, 2006 at 10:20:49AM +0200, Martin Wache wrote:
> >> I would suggest to check what osdMutex is actually protecting, in some
> >> places I really don't know that. So for protecting what is the osdMutex
> >> needed?

Added some comment on what osdMutex is protecting.
For Action() of cVideoOut, osdMutex is the wrong one, as the existance
and current contend of previous decoded frame has to be protected.
Introduced a separate mutex for that purpose.

That should fix the hang situation.

Martin, what is areaMutex for ?
From reading the the code, it is just for serializing calls of YUV() .
So it could be moved to the private section, right ?

> > 
> > It might be a good idea to try running softdevice under Helgrind,
> > which implements the Eraser algorithm for detecting data races.
> > 
> I never worked with Helgrind, but maybe I will it give a try.
> 
> > FWIW, a good design principle would be to avoid deadlocks by avoiding
> > cycles in the waits-for graph altogether.  This can be achieved by having
> > all threads acquire mutexes in the same order (and to release them in the
> > opposite order in a stack-like fashion).  Assign a rank to each mutex,
> > and make sure that each thread can acquire only mutexes of lower rank
> > than those it is currently holding.
> >
> Sure, ranks for all mutexes would help to solve those problems. But I
> don't think we actually need them, cVideo is just not complicated enough
> ;-). We currently have two mutexes in cVideo, I actually don't think
> that we need both of them. If we can get rid of one of them, we should
> not have any problems with deadlocks.
> If some videout driver needs locks to protect calls to actual drivers,
> thats not a problem as long as no other methods of cVideo are called
> with the lock held.
> 


-- 
Stefan Lucke


From admin at berlios.de  Fri Sep 22 15:20:14 2006
From: admin at berlios.de (admin at berlios.de)
Date: Fri, 22 Sep 2006 15:20:14 +0200 (CEST)
Subject: [Softdevice-devel] [Bug #8863] vdr-softdevice and XGL gives weird
	picture
Message-ID: <200609221320.k8MDKEdP020275@unicorn.berlios.de>

Bug #8863, was updated on 2006-Sep-22 15:20
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: xv-out
Status: Open
Resolution: None
Bug Group: None
Priority: 5
Submitted by: mastercpp
Assigned to : none
Summary: vdr-softdevice and XGL gives weird picture

Details: When I run vdr-softdevice with XGL, I get a weird picture with YV12 and YUY2 pixel format. With I420 pixel format I don't get any picture (black screen).
I'm using vdr-softdevice-cvs-20060912 on amd64 Gentoo.
Screenshot:
http://img212.imageshack.us/my.php?image=yuy2ik8.png


For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=8863&group_id=2051


From stefan at lucke.in-berlin.de  Fri Sep 22 21:34:35 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 22 Sep 2006 21:34:35 +0200
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long
	time
In-Reply-To: <200609220637.05681.stefan@lucke.in-berlin.de>
References: <20060918181952.GA2739@localhost.localdomain>
	<45126F1A.4050805@gmx.net>
	<200609220637.05681.stefan@lucke.in-berlin.de>
Message-ID: <200609222134.35533.stefan@lucke.in-berlin.de>

On Freitag 22 September 2006 06:37, Stefan Lucke wrote:
> On Donnerstag 21 September 2006 12:53, Martin Wache wrote:
> > Marko M?kel? schrieb:
> > > On Wed, Sep 20, 2006 at 10:20:49AM +0200, Martin Wache wrote:
> > >> I would suggest to check what osdMutex is actually protecting, in some
> > >> places I really don't know that. So for protecting what is the osdMutex
> > >> needed?
> 
> Added some comment on what osdMutex is protecting.
> For Action() of cVideoOut, osdMutex is the wrong one, as the existance
> and current contend of previous decoded frame has to be protected.
> Introduced a separate mutex for that purpose.
> 
> That should fix the hang situation.
> 
> Martin, what is areaMutex for ?
> From reading the the code, it is just for serializing calls of YUV() .
> So it could be moved to the private section, right ?

Dropped areaMutex, as there was the possibility of loosing a current
frame. This is now handled by locking with oldPictureMutex too.

I guess I found a way to drop osdMutex from video-dfb.c . 
That will hopefully fix the reported issue with fading OSD effects too.

-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Fri Sep 22 23:12:56 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 22 Sep 2006 23:12:56 +0200
Subject: [Softdevice-devel] OSD layer not always fully cleared on mgatv
In-Reply-To: <20060918185020.GB2739@localhost.localdomain>
References: <20060918095530.GD3928@localhost.localdomain>
	<20060918185020.GB2739@localhost.localdomain>
Message-ID: <200609222312.56960.stefan@lucke.in-berlin.de>

On Montag 18 September 2006 20:50, Marko M?kel? wrote:
> On Mon, Sep 18, 2006 at 12:55:30PM +0300, Marko M?kel? wrote:
> > I'm using CVS versions of softdevice and DirectFB from one or two weeks
> > ago, when Stefan fixed the big OSD flicker.
> > 
> > I occasionally see flicker on the OSD layer.  Sometimes, when I close the
> > OSD, it appears that one of the two interlaced fields is not completely
> > cleared.  A few top and bottom lines will flicker between transparent
> > and their previous contents until another menu is opened.  Has anyone
> > else experienced this?
> 
> One or two weeks ago I have noticed that when something is blanked
> (made transparent) in the OSD of -vo dfb:mgatv, the change does not
> happen immediately, but the pixels will fade out in at least 4 steps.

This fading effect is caused by not clearing non-video area (black 
borders). It most visible in paused mode when there are OSD changes
outside the active video area.

Attached patch dfb-blbar-clear-02.patch should fix this. 
Tested this only in pause mode. As this may cause a  higher
load, it should be tested more careful on small systems.

Patch dfb-blbar-clear-03.patch includes this and osdMutex removal
from video-dfb.c . Did only a compile check with this one.


-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: dfb-blbar-clear-02.patch
Type: text/x-diff
Size: 2741 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060922/a36acebc/attachment.patch>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: dfb-blbar-clear-03.patch
Type: text/x-diff
Size: 4244 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060922/a36acebc/attachment-0001.patch>

From jonis2006 at yandex.ru  Sat Sep 23 12:01:47 2006
From: jonis2006 at yandex.ru (jonis2006)
Date: Sat, 23 Sep 2006 14:01:47 +0400 (MSD)
Subject: [Softdevice-devel] Picture color defects.
In-Reply-To: <4512375E.3090409@huillard.net>
References: <4510C275.000001.13426@webmail10.yandex.ru>
	<4512375E.3090409@huillard.net>
Message-ID: <4515060B.000002.19549@tide.yandex.ru>

>jonis2006 a crit :
>> Hello !
>> 
>> When I watching channels sometime I see color defects at the edges of objects in the screen. 
>> Here is screenshots which describing this problem.
>> 
>> http://woody.on.ufanet.ru/001.vdr
>> http://woody.on.ufanet.ru/defect1.JPG (Pink lines near red color)
>> http://woody.on.ufanet.ru/defect2.JPG (Edges of circle with picks)
>> http://woody.on.ufanet.ru/defect3.JPG (Edges of circle with picks)
>
>It seems like artifacts I had while tuning TV-out registers on VT1622
>(S-video output on EPIA M10k).
>* wrong color lines may be related to S-video ou Composite, or color
>conversion inside the TV encoder (VT1622)
>* edges in circles (or generally steps on diangonal lines) is related to
>vertical scaling that take place inside the TV encoder (some lines are
>dropped, and even the smoothing engine can add more obvious artifact on
>particular patterns only)
>
>Can you detail the outpu you use ?
>If using a TV encoder, you should adjust the scaling/color correcton
>that that place there.
>
>> In Mplayer I got same problem.
>> 
>> Is this possible to fix ?
>> Maybe packed color (Packed YUY2) causes problem ?
>> 
>> With best regards.
>> Jonis.

I am using RGN Scart output via Matrox G450


From marko.makela at hut.fi  Sat Sep 23 21:45:19 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sat, 23 Sep 2006 22:45:19 +0300
Subject: [Softdevice-devel] OSD layer not always fully cleared on mgatv
In-Reply-To: <200609222312.56960.stefan@lucke.in-berlin.de>
References: <20060918095530.GD3928@localhost.localdomain>
	<20060918185020.GB2739@localhost.localdomain>
	<200609222312.56960.stefan@lucke.in-berlin.de>
Message-ID: <20060923194519.GA2825@localhost.localdomain>

On Fri, Sep 22, 2006 at 11:12:56PM +0200, Stefan Lucke wrote:
> > One or two weeks ago I have noticed that when something is blanked
> > (made transparent) in the OSD of -vo dfb:mgatv, the change does not
> > happen immediately, but the pixels will fade out in at least 4 steps.
> 
> This fading effect is caused by not clearing non-video area (black 
> borders). It most visible in paused mode when there are OSD changes
> outside the active video area.
> 
> Attached patch dfb-blbar-clear-02.patch should fix this. 
> Tested this only in pause mode. As this may cause a  higher
> load, it should be tested more careful on small systems.

This one worked for me.  Test case: pressing the Up or Down key for several
seconds in a short Recordings menu (which fits entirely on the screen)
while playing a recording.  The CPU consumption grew from about 55% to
80%, but very few frames were dropped, and the selection on the OSD menu
was updated smoothly.

> Patch dfb-blbar-clear-03.patch includes this and osdMutex removal
> from video-dfb.c . Did only a compile check with this one.

I tested this one first.  It removed the fading effect, but unfortunately
it also caused OSD updates to take much longer or to be lost.  When I
pressed the Down button for a second in a short Recordings menu that fits
entirely on screen, the selection jumped around in a bit chaotic way.
I'm just guessing, but could it be a locking granularity issue?

	Marko


From M.Wache at gmx.net  Sun Sep 24 22:56:39 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 24 Sep 2006 22:56:39 +0200
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long
 time
In-Reply-To: <200609222134.35533.stefan@lucke.in-berlin.de>
References: <20060918181952.GA2739@localhost.localdomain>	<45126F1A.4050805@gmx.net>	<200609220637.05681.stefan@lucke.in-berlin.de>
	<200609222134.35533.stefan@lucke.in-berlin.de>
Message-ID: <4516F107.8050007@gmx.net>

Stefan Lucke schrieb:
> On Freitag 22 September 2006 06:37, Stefan Lucke wrote:
>> On Donnerstag 21 September 2006 12:53, Martin Wache wrote:
>>> Marko M?kel? schrieb:
>>>> On Wed, Sep 20, 2006 at 10:20:49AM +0200, Martin Wache wrote:
>>>>> I would suggest to check what osdMutex is actually protecting, in some
>>>>> places I really don't know that. So for protecting what is the osdMutex
>>>>> needed?
>> Added some comment on what osdMutex is protecting.
// -----------------------------------------------------------------------
// State changes of OSD like on / off transitions, must be proteced by
// osdMutex. This are changes of variable OSDpresent, as the output method
// may need to take some longer actions e.g clearing background for one or
// mutiple output buffers (double, triple buffering).
//

I don't think that for this we actually need a mutex. I saw that you
sent a patch which removes osdMutex from DirectFB. So is this still what
you are thinking? Do we need osdMutex?

>> For Action() of cVideoOut, osdMutex is the wrong one, as the existance
>> and current contend of previous decoded frame has to be protected.
>> Introduced a separate mutex for that purpose.
>>
>> That should fix the hang situation.
>>
>> Martin, what is areaMutex for ?

Funny that you are asking me that question, you introduced areaMutex ;-)
Please check video.c revision 1.30 and the corresponding log message.

>> From reading the the code, it is just for serializing calls of YUV() .
>> So it could be moved to the private section, right ?
> 
Sure, it could be moved. But if you want to do this to avoid deadlocks,
that won't work, since YUV() is still called with areaMutex, or now
oldPictureMutex held. So it is still possible to create deadlocks in the
video-out classes which inherit from cVideo.

> Dropped areaMutex, as there was the possibility of loosing a current
> frame. This is now handled by locking with oldPictureMutex too.
>
Hmm, it would have been simpler just to keep areaMutex and to use
areaMutex instead of osdMutex in cVideo::Action()... Locking an mutex,
which is already held by the thread is not a good coding style (Action()
calls DrawStill())...
And you should update the comments on oldPictureMutex, if it takes over
the responsibilities of areaMutex.

Bye,
Martin


From M.Wache at gmx.net  Sun Sep 24 23:02:25 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 24 Sep 2006 23:02:25 +0200
Subject: [Softdevice-devel] Picture color defects.
In-Reply-To: <4515060B.000002.19549@tide.yandex.ru>
References: <4510C275.000001.13426@webmail10.yandex.ru>	<4512375E.3090409@huillard.net>
	<4515060B.000002.19549@tide.yandex.ru>
Message-ID: <4516F261.1060404@gmx.net>

jonis2006 schrieb:
>> jonis2006 a crit :
>>> Hello !
>>>
>>> When I watching channels sometime I see color defects at the edges of objects in the screen. 
>>> Here is screenshots which describing this problem.
>>>
>>> http://woody.on.ufanet.ru/001.vdr
>>> http://woody.on.ufanet.ru/defect1.JPG (Pink lines near red color)
>>> http://woody.on.ufanet.ru/defect2.JPG (Edges of circle with picks)
>>> http://woody.on.ufanet.ru/defect3.JPG (Edges of circle with picks)
>> It seems like artifacts I had while tuning TV-out registers on VT1622
>> (S-video output on EPIA M10k).
>> * wrong color lines may be related to S-video ou Composite, or color
>> conversion inside the TV encoder (VT1622)
>> * edges in circles (or generally steps on diangonal lines) is related to
>> vertical scaling that take place inside the TV encoder (some lines are
>> dropped, and even the smoothing engine can add more obvious artifact on
>> particular patterns only)
>>
>> Can you detail the outpu you use ?
>> If using a TV encoder, you should adjust the scaling/color correcton
>> that that place there.
>>
>>> In Mplayer I got same problem.
>>>
>>> Is this possible to fix ?
>>> Maybe packed color (Packed YUY2) causes problem ?
>>>
To me it looks like YUV420 is the problem. U and V components (these
components give the color) have only 1/4 (1/2 in X and 1/2 in the
Y-direction) of the resolution of the Y component (which is the
brightness). So obviously on edges there are some parts where the color
doesn't change with the same resolution as the brightness.
Mpeg2 videos usually are encoded using YUV420, if the video out uses
YUY2, YUV420 is converted to YUY2.

Bye,
Martin


From stefan at lucke.in-berlin.de  Sun Sep 24 23:23:44 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 24 Sep 2006 23:23:44 +0200
Subject: [Softdevice-devel] OSD layer not always fully cleared on mgatv
In-Reply-To: <20060923194519.GA2825@localhost.localdomain>
References: <20060918095530.GD3928@localhost.localdomain>
	<200609222312.56960.stefan@lucke.in-berlin.de>
	<20060923194519.GA2825@localhost.localdomain>
Message-ID: <200609242323.44875.stefan@lucke.in-berlin.de>

On Samstag 23 September 2006 21:45, Marko M?kel? wrote:
> On Fri, Sep 22, 2006 at 11:12:56PM +0200, Stefan Lucke wrote:
> > > One or two weeks ago I have noticed that when something is blanked
> > > (made transparent) in the OSD of -vo dfb:mgatv, the change does not
> > > happen immediately, but the pixels will fade out in at least 4 steps.
> > 
> > This fading effect is caused by not clearing non-video area (black 
> > borders). It most visible in paused mode when there are OSD changes
> > outside the active video area.
> > 
> > Attached patch dfb-blbar-clear-02.patch should fix this. 
> > Tested this only in pause mode. As this may cause a  higher
> > load, it should be tested more careful on small systems.
> 
> This one worked for me.  Test case: pressing the Up or Down key for several
> seconds in a short Recordings menu (which fits entirely on the screen)
> while playing a recording.  The CPU consumption grew from about 55% to
> 80%, but very few frames were dropped, and the selection on the OSD menu
> was updated smoothly.
> 
> > Patch dfb-blbar-clear-03.patch includes this and osdMutex removal
> > from video-dfb.c . Did only a compile check with this one.
> 
> I tested this one first.  It removed the fading effect, but unfortunately
> it also caused OSD updates to take much longer or to be lost.  When I
> pressed the Down button for a second in a short Recordings menu that fits
> entirely on screen, the selection jumped around in a bit chaotic way.
> I'm just guessing, but could it be a locking granularity issue?

Was that during live-tv or during a paused playback of a recording?
Could be an issue with triplebuffering too.

-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Sun Sep 24 23:38:37 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 24 Sep 2006 23:38:37 +0200
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long
	time
In-Reply-To: <4516F107.8050007@gmx.net>
References: <20060918181952.GA2739@localhost.localdomain>
	<200609222134.35533.stefan@lucke.in-berlin.de>
	<4516F107.8050007@gmx.net>
Message-ID: <200609242338.37885.stefan@lucke.in-berlin.de>

On Sonntag 24 September 2006 22:56, Martin Wache wrote:
> Stefan Lucke schrieb:
> > On Freitag 22 September 2006 06:37, Stefan Lucke wrote:
> >> On Donnerstag 21 September 2006 12:53, Martin Wache wrote:
> >>> Marko M?kel? schrieb:
> >>>> On Wed, Sep 20, 2006 at 10:20:49AM +0200, Martin Wache wrote:
> >>>>> I would suggest to check what osdMutex is actually protecting, in some
> >>>>> places I really don't know that. So for protecting what is the osdMutex
> >>>>> needed?
> >> Added some comment on what osdMutex is protecting.
> // -----------------------------------------------------------------------
> // State changes of OSD like on / off transitions, must be proteced by
> // osdMutex. This are changes of variable OSDpresent, as the output method
> // may need to take some longer actions e.g clearing background for one or
> // mutiple output buffers (double, triple buffering).
> //
> 
> I don't think that for this we actually need a mutex. I saw that you
> sent a patch which removes osdMutex from DirectFB. So is this still what
> you are thinking? Do we need osdMutex?

I looked too close at directfb and that was my actual impression.
Now I think different :-). The roots of osdMutex are in vdr-1.2.x:
OpenOSD() , CloseOSD()
In CloseOSD there is some code duplicated video.c:

void cVideoOut::CloseOSD()
{
  osdMutex.Lock();
  OSDpresent=false;
  for (int i = 0; i < MAXNUMWINDOWS; i++)
  {
    if (layer[i])
    {
      delete(layer[i]);
      layer[i]=0;
    }
  }
  osdMutex.Unlock();
}

and now in video-xv.c:
/* ---------------------------------------------------------------------------
 */
void cXvVideoOut::CloseOSD()
{
  cVideoOut::CloseOSD();
  osdMutex.Lock();
#if VDRVERSNUM < 10307
  for (int i = 0; i < MAXNUMWINDOWS; i++)
  {
    if (layer[i])
    {
      delete(layer[i]);
      layer[i]=0;
    }
  }
#endif
  [snip]

  osdMutex.Unlock();
}


> 
> >> For Action() of cVideoOut, osdMutex is the wrong one, as the existance
> >> and current contend of previous decoded frame has to be protected.
> >> Introduced a separate mutex for that purpose.
> >>
> >> That should fix the hang situation.
> >>
> >> Martin, what is areaMutex for ?
> 
> Funny that you are asking me that question, you introduced areaMutex ;-)
> Please check video.c revision 1.30 and the corresponding log message.

Ok, then I only removed one of my own dark sides.

> 
> >> From reading the the code, it is just for serializing calls of YUV() .
> >> So it could be moved to the private section, right ?
> > 
> Sure, it could be moved. But if you want to do this to avoid deadlocks,
> that won't work, since YUV() is still called with areaMutex, or now
> oldPictureMutex held. So it is still possible to create deadlocks in the
> video-out classes which inherit from cVideo.
> 
> > Dropped areaMutex, as there was the possibility of loosing a current
> > frame. This is now handled by locking with oldPictureMutex too.
> >
> Hmm, it would have been simpler just to keep areaMutex and to use
> areaMutex instead of osdMutex in cVideo::Action()... Locking an mutex,
> which is already held by the thread is not a good coding style (Action()
> calls DrawStill())...

Beside coding style, do you still see a deadlock possibility ?

> And you should update the comments on oldPictureMutex, if it takes over
> the responsibilities of areaMutex.

Will do that.


-- 
Stefan Lucke


From marko.makela at hut.fi  Mon Sep 25 09:37:12 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 25 Sep 2006 10:37:12 +0300
Subject: [Softdevice-devel] OSD layer not always fully cleared on mgatv
In-Reply-To: <200609242323.44875.stefan@lucke.in-berlin.de>
References: <20060918095530.GD3928@localhost.localdomain>
	<200609222312.56960.stefan@lucke.in-berlin.de>
	<20060923194519.GA2825@localhost.localdomain>
	<200609242323.44875.stefan@lucke.in-berlin.de>
Message-ID: <20060925073712.GA2741@localhost.localdomain>

On Sun, Sep 24, 2006 at 11:23:44PM +0200, Stefan Lucke wrote:
> > > Patch dfb-blbar-clear-03.patch includes this and osdMutex removal
> > > from video-dfb.c . Did only a compile check with this one.
> > 
> > I tested this one first.  It removed the fading effect, but unfortunately
> > it also caused OSD updates to take much longer or to be lost.  When I
> > pressed the Down button for a second in a short Recordings menu that fits
> > entirely on screen, the selection jumped around in a bit chaotic way.
> > I'm just guessing, but could it be a locking granularity issue?
> 
> Was that during live-tv or during a paused playback of a recording?
> Could be an issue with triplebuffering too.

It was during live-tv.  Would you like me to repeat this and send you the
log messages?  Should I enable some extra diagnostics?

	Marko


From M.Wache at gmx.net  Mon Sep 25 19:37:15 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 25 Sep 2006 19:37:15 +0200
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long
 time
In-Reply-To: <200609242338.37885.stefan@lucke.in-berlin.de>
References: <20060918181952.GA2739@localhost.localdomain>	<200609222134.35533.stefan@lucke.in-berlin.de>	<4516F107.8050007@gmx.net>
	<200609242338.37885.stefan@lucke.in-berlin.de>
Message-ID: <451813CB.4010008@gmx.net>

Stefan Lucke schrieb:
> On Sonntag 24 September 2006 22:56, Martin Wache wrote:
>> Stefan Lucke schrieb:
>>> On Freitag 22 September 2006 06:37, Stefan Lucke wrote:
>>>> On Donnerstag 21 September 2006 12:53, Martin Wache wrote:
>>>>> Marko M?kel? schrieb:
>>>>>> On Wed, Sep 20, 2006 at 10:20:49AM +0200, Martin Wache wrote:
>>>>>>> I would suggest to check what osdMutex is actually protecting, in some
>>>>>>> places I really don't know that. So for protecting what is the osdMutex
>>>>>>> needed?
>>>> Added some comment on what osdMutex is protecting.
>> // -----------------------------------------------------------------------
>> // State changes of OSD like on / off transitions, must be proteced by
>> // osdMutex. This are changes of variable OSDpresent, as the output method
>> // may need to take some longer actions e.g clearing background for one or
>> // mutiple output buffers (double, triple buffering).
>> //
>>
>> I don't think that for this we actually need a mutex. I saw that you
>> sent a patch which removes osdMutex from DirectFB. So is this still what
>> you are thinking? Do we need osdMutex?
> 
> I looked too close at directfb and that was my actual impression.
> Now I think different :-). The roots of osdMutex are in vdr-1.2.x:
> OpenOSD() , CloseOSD()
> In CloseOSD there is some code duplicated video.c:
> 
> void cVideoOut::CloseOSD()
> {
>   osdMutex.Lock();
>   OSDpresent=false;
>   for (int i = 0; i < MAXNUMWINDOWS; i++)
>   {
>     if (layer[i])
>     {
>       delete(layer[i]);
>       layer[i]=0;
>     }
>   }
>   osdMutex.Unlock();
> }
> 
> and now in video-xv.c:
> /* ---------------------------------------------------------------------------
>  */
> void cXvVideoOut::CloseOSD()
> {
>   cVideoOut::CloseOSD();
>   osdMutex.Lock();
> #if VDRVERSNUM < 10307
>   for (int i = 0; i < MAXNUMWINDOWS; i++)
>   {
>     if (layer[i])
>     {
>       delete(layer[i]);
>       layer[i]=0;
>     }
>   }
> #endif
>   [snip]
> 
>   osdMutex.Unlock();
> }
> 
> 
>>>> For Action() of cVideoOut, osdMutex is the wrong one, as the existance
>>>> and current contend of previous decoded frame has to be protected.
>>>> Introduced a separate mutex for that purpose.
>>>>
>>>> That should fix the hang situation.
>>>>
>>>> Martin, what is areaMutex for ?
>> Funny that you are asking me that question, you introduced areaMutex ;-)
>> Please check video.c revision 1.30 and the corresponding log message.
> 
> Ok, then I only removed one of my own dark sides.
> 
>>>> From reading the the code, it is just for serializing calls of YUV() .
>>>> So it could be moved to the private section, right ?
>> Sure, it could be moved. But if you want to do this to avoid deadlocks,
>> that won't work, since YUV() is still called with areaMutex, or now
>> oldPictureMutex held. So it is still possible to create deadlocks in the
>> video-out classes which inherit from cVideo.
>>
>>> Dropped areaMutex, as there was the possibility of loosing a current
>>> frame. This is now handled by locking with oldPictureMutex too.
>>>
>> Hmm, it would have been simpler just to keep areaMutex and to use
>> areaMutex instead of osdMutex in cVideo::Action()... Locking an mutex,
>> which is already held by the thread is not a good coding style (Action()
>> calls DrawStill())...
> 
> Beside coding style, do you still see a deadlock possibility ?
> 
On non-linux systems, yes. As soon as you are using strict posix mutexes
 trying to lock a mutex from the thread which already holds the mutex
always results in a deadlock.

But there may be other problems as well: if you lock a mutex, and then
call a method which locks the same mutex again, this second lock will
fail with -EAGAIN (in case of a mutex PTHREAD_MUTEX_ERRORCHECK_NP), but
not block. If this method now unlocks the mutex, the mutex will be
unlocked, even though the calling method still thinks it holds the mutex.
I did not try this out, maybe I'm wrong here (it depends on the
implementation of the library... there are also recursive locks which
are allowed to double lock)
So I would like to avoid double locking...

Thinking again about all this, I don't think that one actually needs to
call DrawStill() from other than cVideo, it is only used to redraw a
frame when the OSD changes and no video currently is displayed.
I think the name is misleading, even still pictures should be displayed
with DrawVideo(), since on OSD change one still wants to have the last
still picture, and only DrawVideo() updates oldPicture. So I would
suggest to remove the lock from DrawStill(), make it private and put a
comment on it, that it only should be called with oldPictureMutex held.

Bye,
Martin


From stefan at lucke.in-berlin.de  Mon Sep 25 19:47:17 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 25 Sep 2006 19:47:17 +0200
Subject: [Softdevice-devel] OSD layer not always fully cleared on mgatv
In-Reply-To: <20060925073712.GA2741@localhost.localdomain>
References: <20060918095530.GD3928@localhost.localdomain>
	<200609242323.44875.stefan@lucke.in-berlin.de>
	<20060925073712.GA2741@localhost.localdomain>
Message-ID: <200609251947.17789.stefan@lucke.in-berlin.de>

On Montag 25 September 2006 09:37, Marko M?kel? wrote:
> On Sun, Sep 24, 2006 at 11:23:44PM +0200, Stefan Lucke wrote:
> > > > Patch dfb-blbar-clear-03.patch includes this and osdMutex removal
> > > > from video-dfb.c . Did only a compile check with this one.
> > > 
> > > I tested this one first.  It removed the fading effect, but unfortunately
> > > it also caused OSD updates to take much longer or to be lost.  When I
> > > pressed the Down button for a second in a short Recordings menu that fits
> > > entirely on screen, the selection jumped around in a bit chaotic way.
> > > I'm just guessing, but could it be a locking granularity issue?
> > 
> > Was that during live-tv or during a paused playback of a recording?
> > Could be an issue with triplebuffering too.
> 
> It was during live-tv.  Would you like me to repeat this and send you the
> log messages?  Should I enable some extra diagnostics?

I think I have to test this with tv-out too as I didn't get the effects
you described with vga out.

You can however do the following (if you like):
- If you've still enabled youre usleeps, disable them.
- dirtyLines in GetLockOsdSurface() should be cleared by:
  memset(dirtyLines,false,sizeof(bool)*Yres);
  as sizeof(dirtyLines) is 4 :-) .
- I guess method ShowOSD() can be dropped. Dropping should be ok now
  for live-tv, but needs some extra handling when paused. In that case
  handling from video:Action() should be like 
  current_osdMode == OSDMODE_SOFTWARE.

-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Mon Sep 25 19:56:49 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 25 Sep 2006 19:56:49 +0200
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long
	time
In-Reply-To: <451813CB.4010008@gmx.net>
References: <20060918181952.GA2739@localhost.localdomain>
	<200609242338.37885.stefan@lucke.in-berlin.de>
	<451813CB.4010008@gmx.net>
Message-ID: <200609251956.49373.stefan@lucke.in-berlin.de>

On Montag 25 September 2006 19:37, Martin Wache wrote:
> Stefan Lucke schrieb:
> > On Sonntag 24 September 2006 22:56, Martin Wache wrote:
> >> Stefan Lucke schrieb:
> >>> On Freitag 22 September 2006 06:37, Stefan Lucke wrote:
> >>>> On Donnerstag 21 September 2006 12:53, Martin Wache wrote:
> >>>>> Marko M?kel? schrieb:
> >>>>>> On Wed, Sep 20, 2006 at 10:20:49AM +0200, Martin Wache wrote:
> >>>>>>> I would suggest to check what osdMutex is actually protecting, in some
> >>>>>>> places I really don't know that. So for protecting what is the osdMutex
> >>>>>>> needed?
> >>>> Added some comment on what osdMutex is protecting.
> >> // -----------------------------------------------------------------------
> >> // State changes of OSD like on / off transitions, must be proteced by
> >> // osdMutex. This are changes of variable OSDpresent, as the output method
> >> // may need to take some longer actions e.g clearing background for one or
> >> // mutiple output buffers (double, triple buffering).
> >> //
> >>
> >> I don't think that for this we actually need a mutex. I saw that you
> >> sent a patch which removes osdMutex from DirectFB. So is this still what
> >> you are thinking? Do we need osdMutex?
> > 
> > I looked too close at directfb and that was my actual impression.
> > Now I think different :-). The roots of osdMutex are in vdr-1.2.x:
> > OpenOSD() , CloseOSD()
> > In CloseOSD there is some code duplicated video.c:
> > 
> > void cVideoOut::CloseOSD()
> > {
> >   osdMutex.Lock();
> >   OSDpresent=false;
> >   for (int i = 0; i < MAXNUMWINDOWS; i++)
> >   {
> >     if (layer[i])
> >     {
> >       delete(layer[i]);
> >       layer[i]=0;
> >     }
> >   }
> >   osdMutex.Unlock();
> > }
> > 
> > and now in video-xv.c:
> > /* ---------------------------------------------------------------------------
> >  */
> > void cXvVideoOut::CloseOSD()
> > {
> >   cVideoOut::CloseOSD();
> >   osdMutex.Lock();
> > #if VDRVERSNUM < 10307
> >   for (int i = 0; i < MAXNUMWINDOWS; i++)
> >   {
> >     if (layer[i])
> >     {
> >       delete(layer[i]);
> >       layer[i]=0;
> >     }
> >   }
> > #endif
> >   [snip]
> > 
> >   osdMutex.Unlock();
> > }
> > 
> > 
> >>>> For Action() of cVideoOut, osdMutex is the wrong one, as the existance
> >>>> and current contend of previous decoded frame has to be protected.
> >>>> Introduced a separate mutex for that purpose.
> >>>>
> >>>> That should fix the hang situation.
> >>>>
> >>>> Martin, what is areaMutex for ?
> >> Funny that you are asking me that question, you introduced areaMutex ;-)
> >> Please check video.c revision 1.30 and the corresponding log message.
> > 
> > Ok, then I only removed one of my own dark sides.
> > 
> >>>> From reading the the code, it is just for serializing calls of YUV() .
> >>>> So it could be moved to the private section, right ?
> >> Sure, it could be moved. But if you want to do this to avoid deadlocks,
> >> that won't work, since YUV() is still called with areaMutex, or now
> >> oldPictureMutex held. So it is still possible to create deadlocks in the
> >> video-out classes which inherit from cVideo.
> >>
> >>> Dropped areaMutex, as there was the possibility of loosing a current
> >>> frame. This is now handled by locking with oldPictureMutex too.
> >>>
> >> Hmm, it would have been simpler just to keep areaMutex and to use
> >> areaMutex instead of osdMutex in cVideo::Action()... Locking an mutex,
> >> which is already held by the thread is not a good coding style (Action()
> >> calls DrawStill())...
> > 
> > Beside coding style, do you still see a deadlock possibility ?
> > 
> On non-linux systems, yes. As soon as you are using strict posix mutexes
>  trying to lock a mutex from the thread which already holds the mutex
> always results in a deadlock.
> 
> But there may be other problems as well: if you lock a mutex, and then
> call a method which locks the same mutex again, this second lock will
> fail with -EAGAIN (in case of a mutex PTHREAD_MUTEX_ERRORCHECK_NP), but
> not block. If this method now unlocks the mutex, the mutex will be
> unlocked, even though the calling method still thinks it holds the mutex.
> I did not try this out, maybe I'm wrong here (it depends on the
> implementation of the library... there are also recursive locks which
> are allowed to double lock)
> So I would like to avoid double locking...
> 
> Thinking again about all this, I don't think that one actually needs to
> call DrawStill() from other than cVideo, it is only used to redraw a
> frame when the OSD changes and no video currently is displayed.
> I think the name is misleading, even still pictures should be displayed
> with DrawVideo(), since on OSD change one still wants to have the last
> still picture, and only DrawVideo() updates oldPicture. So I would
> suggest to remove the lock from DrawStill(), make it private and put a
> comment on it, that it only should be called with oldPictureMutex held.

DrawStill() is called from outside of video.c -> ShmClient.c.
So we should have a non-locking private one, and a locking public.

-- 
Stefan Lucke


From M.Wache at gmx.net  Mon Sep 25 20:22:53 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 25 Sep 2006 20:22:53 +0200
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long
 time
In-Reply-To: <200609251956.49373.stefan@lucke.in-berlin.de>
References: <20060918181952.GA2739@localhost.localdomain>	<200609242338.37885.stefan@lucke.in-berlin.de>	<451813CB.4010008@gmx.net>
	<200609251956.49373.stefan@lucke.in-berlin.de>
Message-ID: <45181E7D.1010001@gmx.net>

Stefan Lucke schrieb:
> On Montag 25 September 2006 19:37, Martin Wache wrote:

>> On non-linux systems, yes. As soon as you are using strict posix mutexes
>>  trying to lock a mutex from the thread which already holds the mutex
>> always results in a deadlock.
>>
>> But there may be other problems as well: if you lock a mutex, and then
>> call a method which locks the same mutex again, this second lock will
>> fail with -EAGAIN (in case of a mutex PTHREAD_MUTEX_ERRORCHECK_NP), but
>> not block. If this method now unlocks the mutex, the mutex will be
>> unlocked, even though the calling method still thinks it holds the mutex.
>> I did not try this out, maybe I'm wrong here (it depends on the
>> implementation of the library... there are also recursive locks which
>> are allowed to double lock)
>> So I would like to avoid double locking...
>>
>> Thinking again about all this, I don't think that one actually needs to
>> call DrawStill() from other than cVideo, it is only used to redraw a
>> frame when the OSD changes and no video currently is displayed.
>> I think the name is misleading, even still pictures should be displayed
>> with DrawVideo(), since on OSD change one still wants to have the last
>> still picture, and only DrawVideo() updates oldPicture. So I would
>> suggest to remove the lock from DrawStill(), make it private and put a
>> comment on it, that it only should be called with oldPictureMutex held.
> 
> DrawStill() is called from outside of video.c -> ShmClient.c.
> So we should have a non-locking private one, and a locking public.
> 
Yes, I forgot that ShmClient uses DrawStill(), but I don't see a reason
why ShmClient should not use DrawVideo(). So we could also change
DrawVideo() to be allowed to be called without syncTimer and make
DrawStill() private.
But as long as no mutexes are taken twice I don't mind :-)

Bye,
Martin


From marko.makela at hut.fi  Mon Sep 25 21:58:33 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 25 Sep 2006 22:58:33 +0300
Subject: [Softdevice-devel] OSD layer not always fully cleared on mgatv
In-Reply-To: <200609251947.17789.stefan@lucke.in-berlin.de>
References: <20060918095530.GD3928@localhost.localdomain>
	<200609242323.44875.stefan@lucke.in-berlin.de>
	<20060925073712.GA2741@localhost.localdomain>
	<200609251947.17789.stefan@lucke.in-berlin.de>
Message-ID: <20060925195833.GA3331@localhost.localdomain>

On Mon, Sep 25, 2006 at 07:47:17PM +0200, Stefan Lucke wrote:
> On Montag 25 September 2006 09:37, Marko M?kel? wrote:
> > On Sun, Sep 24, 2006 at 11:23:44PM +0200, Stefan Lucke wrote:
> > > > > Patch dfb-blbar-clear-03.patch includes this and osdMutex removal
> > > > > from video-dfb.c . Did only a compile check with this one.
> > > > 
> > > > I tested this one first.  It removed the fading effect, but unfortunately
> > > > it also caused OSD updates to take much longer or to be lost.  When I
> > > > pressed the Down button for a second in a short Recordings menu that fits
> > > > entirely on screen, the selection jumped around in a bit chaotic way.
> > > > I'm just guessing, but could it be a locking granularity issue?
> > > 
> > > Was that during live-tv or during a paused playback of a recording?
> > > Could be an issue with triplebuffering too.
> > 
> > It was during live-tv.  Would you like me to repeat this and send you the
> > log messages?  Should I enable some extra diagnostics?
> 
> I think I have to test this with tv-out too as I didn't get the effects
> you described with vga out.
> 
> You can however do the following (if you like):
> - If you've still enabled youre usleeps, disable them.

Sorry, I should have done that.  The usleeps do not seem to affect this.

> - dirtyLines in GetLockOsdSurface() should be cleared by:
>   memset(dirtyLines,false,sizeof(bool)*Yres);
>   as sizeof(dirtyLines) is 4 :-) .

Changed to the following:

    memset(dirtyLines,false,sizeof(*dirtyLines) * Yres);

No effect.

Sometimes, I can keep the Down or Up button pressed for several seconds,
and the selection on the Recordings menu will be updated okay (i.e.,
always jumping by one entry at a constant speed).  Other times, the
selection will jump abnormally at least once per second.  This occurs
also on static scenes.  For the record, the key-repeat rate of RCUs
using the RC5 code is 113.8 ms.

	Marko


From stefan at lucke.in-berlin.de  Mon Sep 25 23:24:32 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 25 Sep 2006 23:24:32 +0200
Subject: [Softdevice-devel] OSD layer not always fully cleared on mgatv
In-Reply-To: <20060925195833.GA3331@localhost.localdomain>
References: <20060918095530.GD3928@localhost.localdomain>
	<200609251947.17789.stefan@lucke.in-berlin.de>
	<20060925195833.GA3331@localhost.localdomain>
Message-ID: <200609252324.33040.stefan@lucke.in-berlin.de>

On Montag 25 September 2006 21:58, Marko M?kel? wrote:
> On Mon, Sep 25, 2006 at 07:47:17PM +0200, Stefan Lucke wrote:
> > On Montag 25 September 2006 09:37, Marko M?kel? wrote:
> > > On Sun, Sep 24, 2006 at 11:23:44PM +0200, Stefan Lucke wrote:
> > > > > > Patch dfb-blbar-clear-03.patch includes this and osdMutex removal
> > > > > > from video-dfb.c . Did only a compile check with this one.
> > > > > 
> > > > > I tested this one first.  It removed the fading effect, but unfortunately
> > > > > it also caused OSD updates to take much longer or to be lost.  When I
> > > > > pressed the Down button for a second in a short Recordings menu that fits
> > > > > entirely on screen, the selection jumped around in a bit chaotic way.
> > > > > I'm just guessing, but could it be a locking granularity issue?
> > > > 
> > > > Was that during live-tv or during a paused playback of a recording?
> > > > Could be an issue with triplebuffering too.
> > > 
> > > It was during live-tv.  Would you like me to repeat this and send you the
> > > log messages?  Should I enable some extra diagnostics?
> > 
> > I think I have to test this with tv-out too as I didn't get the effects
> > you described with vga out.
> > 
> > You can however do the following (if you like):
> > - If you've still enabled youre usleeps, disable them.
> 
> Sorry, I should have done that.  The usleeps do not seem to affect this.
> 
> > - dirtyLines in GetLockOsdSurface() should be cleared by:
> >   memset(dirtyLines,false,sizeof(bool)*Yres);
> >   as sizeof(dirtyLines) is 4 :-) .
> 
> Changed to the following:
> 
>     memset(dirtyLines,false,sizeof(*dirtyLines) * Yres);
> 
> No effect.
> 
> Sometimes, I can keep the Down or Up button pressed for several seconds,
> and the selection on the Recordings menu will be updated okay (i.e.,
> always jumping by one entry at a constant speed).  Other times, the
> selection will jump abnormally at least once per second.  This occurs
> also on static scenes.  For the record, the key-repeat rate of RCUs
> using the RC5 code is 113.8 ms.

So my tv-out test is still pending, but I've a new version of the patch.
If it still happens for you sometimes, there is the possibility to enable
a mutex around Flip() and Blit() calls. To enable this, USE_TEST_MUTEX
should be defined to 1.

Don't know if DirectFB locks Flip() and Blit() calls internal.

-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: dfb-blbar-clear-04.patch
Type: text/x-diff
Size: 7218 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060925/37b1afb5/attachment.patch>

From t-erdmann at web.de  Tue Sep 26 08:14:57 2006
From: t-erdmann at web.de (Thomas Erdmann)
Date: Tue, 26 Sep 2006 08:14:57 +0200
Subject: [Softdevice-devel] softdevice xv and i915 Notebook
In-Reply-To: <200609211822.51577.t-erdmann@web.de>
References: <200609211822.51577.t-erdmann@web.de>
Message-ID: <200609260814.57562.t-erdmann@web.de>

Am Donnerstag, 21. September 2006 18:22 schrieb Thomas Erdmann:
> Hello List,
> i copied my running vdr with softdevice from a nVidia Geforce 6600 System
> to an intel notebook with 915 chip set.

Hello List.
Don't anyone use Softdevice on a Notebook with Intel Graphics ?
Should Softdevice support xv out on that or only on the Desktop Graphics like 
nvidia or ati ?

Thomas



From stefan at lucke.in-berlin.de  Tue Sep 26 09:02:43 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 26 Sep 2006 09:02:43 +0200
Subject: [Softdevice-devel] softdevice xv and i915 Notebook
In-Reply-To: <200609260814.57562.t-erdmann@web.de>
References: <200609211822.51577.t-erdmann@web.de>
	<200609260814.57562.t-erdmann@web.de>
Message-ID: <1159254163.4518d093279df@webmail.in-berlin.de>

Quoting Thomas Erdmann:

> Am Donnerstag, 21. September 2006 18:22 schrieb Thomas Erdmann:
> > Hello List,
> > i copied my running vdr with softdevice from a nVidia Geforce 6600 System
> > to an intel notebook with 915 chip set.
>
> Hello List.
> Don't anyone use Softdevice on a Notebook with Intel Graphics ?
> Should Softdevice support xv out on that or only on the Desktop Graphics like
> nvidia or ati ?

Which OSD drawing method did you choose (pseudo or software)?
Does this happen if you choose the other one too ?

Stefan Lucke


From t-erdmann at web.de  Tue Sep 26 10:08:35 2006
From: t-erdmann at web.de (Thomas Erdmann)
Date: Tue, 26 Sep 2006 10:08:35 +0200
Subject: [Softdevice-devel] softdevice xv and i915 Notebook
In-Reply-To: <1159254163.4518d093279df@webmail.in-berlin.de>
References: <200609211822.51577.t-erdmann@web.de>
	<200609260814.57562.t-erdmann@web.de>
	<1159254163.4518d093279df@webmail.in-berlin.de>
Message-ID: <200609261008.36609.t-erdmann@web.de>

> Which OSD drawing method did you choose (pseudo or software)?
> Does this happen if you choose the other one too ?
>
> Stefan Lucke

softdevice.OSDalphablend=0 is configured.
With the other setting (=1) the OSD is only visable for short times when a key 
is pressed, so i never used it.
As i wrote earlyer in this Thread sometimes the VDR crashes while resizing to 
fullscreen or when switching between channels (which perhaps use different 
Screen ratios ?) or when stopping and restarting the VDR some times.
A fresh booted System with VDR started and without resizing the Softdevice 
Window and without often switching channels runs 10 hours and more without 
Problems.
The whole VDR Project with Plugins is compiled on this System and on another 
with nvidia graphics and there it runs without any stability problems. 
So i think it must be the interaction between softdevice and X-Server (XOrg 
i810).
Both Systems are Debian based and the Notebook System is a nearly clone copy 
of the older System but with normal adjustings, e.g. other xorg.conf and so 
on.
What can i try to improve stability ?

THX
  Thomas



From stefan at lucke.in-berlin.de  Tue Sep 26 16:20:31 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 26 Sep 2006 16:20:31 +0200
Subject: [Softdevice-devel] softdevice xv and i915 Notebook
In-Reply-To: <200609261008.36609.t-erdmann@web.de>
References: <200609211822.51577.t-erdmann@web.de>
	<200609260814.57562.t-erdmann@web.de>
	<1159254163.4518d093279df@webmail.in-berlin.de>
	<200609261008.36609.t-erdmann@web.de>
Message-ID: <1159280431.4519372f56bd8@webmail.in-berlin.de>

Quoting Thomas Erdmann <t-erdmann at web.de>:

> > Which OSD drawing method did you choose (pseudo or software)?
> > Does this happen if you choose the other one too ?
> >
> > Stefan Lucke
>
> softdevice.OSDalphablend=0 is configured.
> With the other setting (=1) the OSD is only visable for short times when a key
> is pressed, so i never used it.

Thats strange.

> As i wrote earlyer in this Thread sometimes the VDR crashes while resizing to
> fullscreen or when switching between channels (which perhaps use different
> Screen ratios ?) or when stopping and restarting the VDR some times.
> A fresh booted System with VDR started and without resizing the Softdevice
> Window and without often switching channels runs 10 hours and more without
> Problems.

To locate the source of the crash, you should run vdr from gdb. For example
# gdb ./ vdr
> set args your_complete_parameterlist_for vdr
> run

-- crash --

> bt
> bt full


> The whole VDR Project with Plugins is compiled on this System and on another
> with nvidia graphics and there it runs without any stability problems.
> So i think it must be the interaction between softdevice and X-Server (XOrg
> i810).
> Both Systems are Debian based and the Notebook System is a nearly clone copy
> of the older System but with normal adjustings, e.g. other xorg.conf and so
> on.
> What can i try to improve stability ?
>
> THX
>   Thomas
>
>




From marko.makela at hut.fi  Tue Sep 26 17:13:23 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 26 Sep 2006 18:13:23 +0300
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long
	time
In-Reply-To: <20060919193743.GA2796@localhost.localdomain>
References: <20060918181952.GA2739@localhost.localdomain>
	<450EEF84.5090808@gmx.net>
	<20060918202224.GA3319@localhost.localdomain>
	<450FF2E0.9020904@gmx.net>
	<20060919193743.GA2796@localhost.localdomain>
Message-ID: <20060926151323.GA21046@localhost.localdomain>

I got another hang today.  I don't know the circumstances, since I was not
there when the hang occurred.  But I think it was caused by a decoding
error or by suspending and resuming vdr (using my patch), as the log
ended with this:

[dfb] (re)configured 0x00200806
[dfb] (re)configuring Videolayer to 720 x 576 (720x576)
[dfb] creating new surface (stretchBlit)
[surface capabilities] videoSurface: videoonly interlaced PixelFormat = 0x00200806
[dfb] (re)configured 0x00200806
[dfb] (re)configuring Videolayer to 704 x 576 (704x576)
[dfb] creating new surface (stretchBlit)
[surface capabilities] videoSurface: videoonly interlaced PixelFormat = 0x00200806
[dfb] (re)configured 0x00200806
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 17 20
[mpeg2video @ 0xa7af58a8]00 motion_type at 4 18
[mpeg2video @ 0xa7af58a8]invalid mb type in P Frame at 13 19
[mpeg2video @ 0xa7af58a8]00 motion_type at 1 20
[mpeg2video @ 0xa7af58a8]00 motion_type at 5 21
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 3 22
[mpeg2video @ 0xa7af58a8]invalid cbp at 25 23
[mpeg2video @ 0xa7af58a8]00 motion_type at 7 24
[mpeg2video @ 0xa7af58a8]00 motion_type at 3 25
[mpeg2video @ 0xa7af58a8]00 motion_type at 1 26
[mpeg2video @ 0xa7af58a8]00 motion_type at 1 27
[mpeg2video @ 0xa7af58a8]00 motion_type at 14 29
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 29
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 30
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 31
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 32
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 33
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 34
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 35
[mpeg2video @ 0xa7af58a8]Warning MVs not available
[mpeg2video @ 0xa7af58a8]concealing 792 DC, 792 AC, 792 MV errors
+++[mpeg2video @ 0xa7af58a8]ac-tex damaged at 39 15
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 1 15
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 16
[mpeg2video @ 0xa7af58a8]invalid mb type in I Frame at 0 17
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 18
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 19
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 20
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 21
[mpeg2video @ 0xa7af58a8]invalid mb type in I Frame at 0 22
[mpeg2video @ 0xa7af58a8]skipped MB in I frame at 1 23
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 24
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 25
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 26
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 27
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 1 28
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 29
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 30
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 31
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 32
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 33
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 34
[mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 35
[mpeg2video @ 0xa7af58a8]Warning MVs not available
[mpeg2video @ 0xa7af58a8]concealing 924 DC, 924 AC, 924 MV errors
*hang*

By the way, it could be useful to have timestamps in the log entries,
or to log via syslog.

Attached are the full stack traces of the two running vdr processes.

Software:

vdr 1.4.2
ffmpeg CVS from months ago
DirectFB CVS from weeks ago
softdevice CVS from 2006-09-22, plus dfb-blbar-clear-03.patch and the
following:

diff -p -u -r1.71 video-dfb.c
--- video-dfb.c 16 Sep 2006 09:30:19 -0000      1.71
+++ video-dfb.c 26 Sep 2006 15:08:19 -0000
@@ -1072,7 +1072,7 @@ void cDFBVideoOut::GetLockOsdSurface(uin
   try
   {
     dirtyLines=DirtyLines=new bool[Yres];
-    memset(dirtyLines,false,sizeof(dirtyLines));
+    memset(dirtyLines,false,sizeof(*dirtyLines) * Yres);

     tmpOsdSurface = (useStretchBlit) ? osdSurface : scrSurface;
     tmpOsdSurface->Lock(DSLF_WRITE, (void **)&dst, &pitch) ;
@@ -1283,6 +1283,7 @@ void cDFBVideoOut::ShowOSD ()
         scrSurface->SetBlittingFlags(DSBLIT_BLEND_ALPHACHANNEL);
         scrSurface->Blit(osdSurface, &osdsrc, 0, 0);
       }
+      usleep(1000);
       scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);

     }
@@ -1471,6 +1472,7 @@ void cDFBVideoOut::YUV(sPicBuffer *buf)

       }
       //scrSurface->Flip(NULL, (setupStore->useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
+      usleep(2000);
       scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
     }
     else

I don't think vdr was suspended this time, but I will ask my wife if she
remembers.

	Marko
-------------- next part --------------
A non-text attachment was scrubbed...
Name: gdb-637.txt.gz
Type: application/octet-stream
Size: 4820 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060926/9a85d431/attachment.obj>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: gdb-714.txt.gz
Type: application/octet-stream
Size: 1727 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060926/9a85d431/attachment-0001.obj>

From laz at club-burniston.co.uk  Tue Sep 26 19:03:17 2006
From: laz at club-burniston.co.uk (Laz)
Date: Tue, 26 Sep 2006 18:03:17 +0100
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long
	time
In-Reply-To: <20060926151323.GA21046@localhost.localdomain>
References: <20060918181952.GA2739@localhost.localdomain>
	<20060919193743.GA2796@localhost.localdomain>
	<20060926151323.GA21046@localhost.localdomain>
Message-ID: <200609261803.17425.laz@club-burniston.co.uk>

On Tuesday 26 September 2006 16:13, Marko M?kel? wrote:
> I got another hang today.  I don't know the circumstances, since I was
> not there when the hang occurred.  But I think it was caused by a
> decoding error or by suspending and resuming vdr (using my patch), as
> the log ended with this:

{snippage}

> I don't think vdr was suspended this time, but I will ask my wife if
> she remembers.

Whenever I've seen this sort of "pause problem" vdr sits there happily 
forever(?!) showing the same image. When replay is started within a short 
time (<30 min?) it carries on working fine. If playback is resumed after 
a long time it usually plays about a seconds' worth of video before 
hanging.

It is difficult to get this to happen on demand so I've never managed to 
get a stack trace, though.

:(

Do you see the same behaviour or does it just become responsive without 
restarting playback?

Cheers,

Laz


From marko.makela at hut.fi  Tue Sep 26 22:13:21 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 26 Sep 2006 23:13:21 +0300
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long
	time
In-Reply-To: <200609261803.17425.laz@club-burniston.co.uk>
References: <20060918181952.GA2739@localhost.localdomain>
	<20060919193743.GA2796@localhost.localdomain>
	<20060926151323.GA21046@localhost.localdomain>
	<200609261803.17425.laz@club-burniston.co.uk>
Message-ID: <20060926201321.GC2753@localhost.localdomain>

On Tue, Sep 26, 2006 at 06:03:17PM +0100, Laz wrote:
> Whenever I've seen this sort of "pause problem" vdr sits there happily 
> forever(?!) showing the same image. When replay is started within a short 
> time (<30 min?) it carries on working fine. If playback is resumed after 
> a long time it usually plays about a seconds' worth of video before 
> hanging.

That is in line with my experience.  Only, instead of pausing, I block
the MPEG stream to softdevice with a small patch to vdr.

> It is difficult to get this to happen on demand so I've never managed to 
> get a stack trace, though.
> 
> :(

Maybe un-pausing triggers an OSD update, and softdevice would only hang
in certain thread schedulings?  My vdr-suspend patch won't pop up any OSD
menu when resuming playback.  When I sent the previous stack traces,
it was the first time I tried to repeat the hang (on the following day
of the original hang).

> Do you see the same behaviour or does it just become responsive without 
> restarting playback?

It won't respond to SVDRP commands (although the SVDRP service still
answers IIRC) or to button events from the remote control unit.  For
all practical purposes, it is dead until the vdr process is killed
and restarted.  The watchdog timer of vdr will not kick in.

I did not get any further info on today's hang, because the vdr box was
started either by my 3-year-old son or his babysitter. :-)

	Marko


From M.Wache at gmx.net  Tue Sep 26 22:56:41 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 26 Sep 2006 22:56:41 +0200
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long
 time
In-Reply-To: <20060926151323.GA21046@localhost.localdomain>
References: <20060918181952.GA2739@localhost.localdomain>	<450EEF84.5090808@gmx.net>	<20060918202224.GA3319@localhost.localdomain>	<450FF2E0.9020904@gmx.net>	<20060919193743.GA2796@localhost.localdomain>
	<20060926151323.GA21046@localhost.localdomain>
Message-ID: <45199409.7090004@gmx.net>

Marko M?kel? schrieb:
> I got another hang today.  I don't know the circumstances, since I was not
> there when the hang occurred.  But I think it was caused by a decoding
> error or by suspending and resuming vdr (using my patch), as the log
> ended with this:
> 
> [dfb] (re)configured 0x00200806
> [dfb] (re)configuring Videolayer to 720 x 576 (720x576)
> [dfb] creating new surface (stretchBlit)
> [surface capabilities] videoSurface: videoonly interlaced PixelFormat = 0x00200806
> [dfb] (re)configured 0x00200806
> [dfb] (re)configuring Videolayer to 704 x 576 (704x576)
> [dfb] creating new surface (stretchBlit)
> [surface capabilities] videoSurface: videoonly interlaced PixelFormat = 0x00200806
> [dfb] (re)configured 0x00200806
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 17 20
> [mpeg2video @ 0xa7af58a8]00 motion_type at 4 18
> [mpeg2video @ 0xa7af58a8]invalid mb type in P Frame at 13 19
> [mpeg2video @ 0xa7af58a8]00 motion_type at 1 20
> [mpeg2video @ 0xa7af58a8]00 motion_type at 5 21
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 3 22
> [mpeg2video @ 0xa7af58a8]invalid cbp at 25 23
> [mpeg2video @ 0xa7af58a8]00 motion_type at 7 24
> [mpeg2video @ 0xa7af58a8]00 motion_type at 3 25
> [mpeg2video @ 0xa7af58a8]00 motion_type at 1 26
> [mpeg2video @ 0xa7af58a8]00 motion_type at 1 27
> [mpeg2video @ 0xa7af58a8]00 motion_type at 14 29
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 29
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 30
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 31
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 32
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 33
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 34
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 35
> [mpeg2video @ 0xa7af58a8]Warning MVs not available
> [mpeg2video @ 0xa7af58a8]concealing 792 DC, 792 AC, 792 MV errors
> +++[mpeg2video @ 0xa7af58a8]ac-tex damaged at 39 15
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 1 15
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 16
> [mpeg2video @ 0xa7af58a8]invalid mb type in I Frame at 0 17
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 18
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 19
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 20
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 21
> [mpeg2video @ 0xa7af58a8]invalid mb type in I Frame at 0 22
> [mpeg2video @ 0xa7af58a8]skipped MB in I frame at 1 23
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 24
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 25
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 26
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 27
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 1 28
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 29
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 30
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 31
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 32
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 33
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 34
> [mpeg2video @ 0xa7af58a8]ac-tex damaged at 0 35
> [mpeg2video @ 0xa7af58a8]Warning MVs not available
> [mpeg2video @ 0xa7af58a8]concealing 924 DC, 924 AC, 924 MV errors
> *hang*
> 
> By the way, it could be useful to have timestamps in the log entries,
> or to log via syslog.
> 
> Attached are the full stack traces of the two running vdr processes.
> 
The gdb-637 stack trace looks perfectly normal. The video decoder thread
waits for displaying a picture, the audio decoder thread is in some alsa
routine waiting to put more sound data into the alsa buffer.
That means both audio and video data are available, which means that
both threads are running. If one of them would have been deadlocked, the
other one would continue to consume data until the buffers are full
because the other thread doesn't consume any data. Then the not locked
thread would have starved... But maybe that argumentation is wrong.
Sorry I didn't get new ideas from that backtrace...

The other backtrace is a vdr which is stuck somewhere during the
initialization, probably because the it could not open the alsa device.
The only strange thing is why it didn't die... Maybe there is something
wrong with alsa or the softdevice -> alsa communication?

> Software:
> 
> vdr 1.4.2
> ffmpeg CVS from months ago
> DirectFB CVS from weeks ago
> softdevice CVS from 2006-09-22, plus dfb-blbar-clear-03.patch and the
I assume this contains the fixes by Stefan on 09-22? And the
dfb-blbar-clear-03.patch is the one without osdMutex, okay.

Laz, how do you suspend your vdr? Do you use Marko's patch or the
softdevice suspend method?

Bye,
Martin


From marko.makela at hut.fi  Tue Sep 26 23:17:29 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 27 Sep 2006 00:17:29 +0300
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long
	time
In-Reply-To: <45199409.7090004@gmx.net>
References: <20060918181952.GA2739@localhost.localdomain>
	<450EEF84.5090808@gmx.net>
	<20060918202224.GA3319@localhost.localdomain>
	<450FF2E0.9020904@gmx.net>
	<20060919193743.GA2796@localhost.localdomain>
	<20060926151323.GA21046@localhost.localdomain>
	<45199409.7090004@gmx.net>
Message-ID: <20060926211729.GE2753@localhost.localdomain>

On Tue, Sep 26, 2006 at 10:56:41PM +0200, Martin Wache wrote:
> Laz, how do you suspend your vdr? Do you use Marko's patch or the
> softdevice suspend method?

I understood that he just pauses some recording, and he sometimes gets
the hang when he resumes playback.  There was a suspend plugin
for some vdr 1.3 version that did roughly so.

	Marko


From laz at club-burniston.co.uk  Wed Sep 27 10:27:45 2006
From: laz at club-burniston.co.uk (Laz)
Date: Wed, 27 Sep 2006 09:27:45 +0100
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long
	time
In-Reply-To: <45199409.7090004@gmx.net>
References: <20060918181952.GA2739@localhost.localdomain>
	<20060926151323.GA21046@localhost.localdomain>
	<45199409.7090004@gmx.net>
Message-ID: <200609270927.45699.laz@club-burniston.co.uk>

On Tuesday 26 September 2006 21:56, Martin Wache wrote:

> Laz, how do you suspend your vdr? Do you use Marko's patch or the
> softdevice suspend method?

All I'm doing is pressing "pause" whilst I go off and do something (then 
get distracted and end up coming back a long time later!), unpausing 
playback, and then I get the ca. 1 s of playback before it dies. Offhand, 
I can't remember whether this is softdevice bombing out with something 
like an "invalid address" error (which I still get occasionally) or 
whether vdr itself hangs.

As I said, I could never manage to induce this bug when I tried! It only 
ever happens when paused for a long time, though.

A thought (probably totally off-track and irrelevant!): how long in terms 
of playback time do the softdevice buffers hold (can't really check this 
now; I think I'm set to "Good seeking")? I.e., am I seeing the buffers 
being flushed over about 1 s and then it dies because there is no more 
MPEG stream being fed into them (or no more is requested)?

I posted something about this problem on the main vdr mailing list a while 
back and someone reported that you can pause "forever" with a 
full-featured card.

Cheers,

Laz


From t-erdmann at web.de  Wed Sep 27 17:32:24 2006
From: t-erdmann at web.de (Thomas Erdmann)
Date: Wed, 27 Sep 2006 17:32:24 +0200
Subject: [Softdevice-devel] softdevice xv and i915 Notebook
In-Reply-To: <1159280431.4519372f56bd8@webmail.in-berlin.de>
References: <200609211822.51577.t-erdmann@web.de>
	<200609261008.36609.t-erdmann@web.de>
	<1159280431.4519372f56bd8@webmail.in-berlin.de>
Message-ID: <200609271732.24495.t-erdmann@web.de>

> Thats strange.
> To locate the source of the crash, you should run vdr from gdb. For example
> # gdb ./ vdr
>

This is the output of trying to do full screen with the "f" key, 
vdr started under control of gdb 'vdr -Psoftdevice .....`:
VDR terminates when pressing f and gdb shows "No stack".
Any hints ?

THX
  Thomas


[softdevice] initializing Plugin
[softdevice] Initializing Video Out
[softdevice] ffmpeg version(CVS) build(3344384)
[XvVideoOut]: osd_image shmid = 557058
[XvVideoOut]: got osd_image: width 1400 height 1050, bytes per line 5600
[XvVideoOut]: max area size 1920 x 1088
[XvVideoOut]: using area size 736 x 576
[softdevice] Subplugin successfully opend
[softdevice] Video Out seems to be OK
[softdevice] Initializing Audio Out
[softdevice] Audio out seems to be OK
[softdevice] A/V devices initialized, now initializing MPEG2 Decoder
GNU gdb 6.4.90-debian
Copyright (C) 2006 Free Software Foundation, Inc.
GDB is free software, covered by the GNU General Public License, and you are
welcome to change it and/or distribute copies of it under certain conditions.
Type "show copying" to see the conditions.
There is absolutely no warranty for GDB.  Type "show warranty" for details.
This GDB was configured as "i486-linux-gnu".
(gdb) No stack.
(gdb)            



From stefan at lucke.in-berlin.de  Wed Sep 27 19:30:02 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 27 Sep 2006 19:30:02 +0200
Subject: [Softdevice-devel] softdevice xv and i915 Notebook
In-Reply-To: <200609271732.24495.t-erdmann@web.de>
References: <200609211822.51577.t-erdmann@web.de>
	<200609261008.36609.t-erdmann@web.de>
	<1159280431.4519372f56bd8@webmail.in-berlin.de>
	<200609271732.24495.t-erdmann@web.de>
Message-ID: <1159378202.451ab51a6ebce@webmail.in-berlin.de>

Quoting Thomas Erdmann <t-erdmann at web.de>:

> > Thats strange.
> > To locate the source of the crash, you should run vdr from gdb. For example
> > # gdb ./ vdr
> >
>
> This is the output of trying to do full screen with the "f" key,
> vdr started under control of gdb 'vdr -Psoftdevice .....`:

But that's not the sequence I intendet to asked for. Command I wrote
is buggy. From vdr's directrory I do:

jarada vdr-1.4.0.jarada # gdb ./vdr
GNU gdb 6.4
Copyright 2005 Free Software Foundation, Inc.
GDB is free software, covered by the GNU General Public License, and you are
welcome to change it and/or distribute copies of it under certain conditions.
Type "show copying" to see the conditions.
There is absolutely no warranty for GDB.  Type "show warranty" for details.
This GDB was configured as "i686-pc-linux-gnu"...Using host libthread_db library "/lib/tls/libthread_db.so.1".

(gdb) set args -P "softdevice -vo xv:" -E /net_data/vdr137-dvb-t-jarada/epg.data -c /net_data/vdr137-dvb-t-jarada -v
/net_data/video/ -p 2010
(gdb) run
Starting program: /home/nfs/extra/src/video/DVB/vdr-1.4.0.jarada/vdr -P "softdevice -vo xv:" -E
/net_data/vdr137-dvb-t-jarada/epg.data -c /net_data/vdr137-dvb-t-jarada -v /net_data/video/ -p 2010
[Thread debugging using libthread_db enabled]


> VDR terminates when pressing f and gdb shows "No stack".
> Any hints ?

Which messages were written to syslog (/var/log/messages or
/var/log/syslog, depending on your distribution).


Stefan Lucke


From t-erdmann at web.de  Wed Sep 27 20:55:02 2006
From: t-erdmann at web.de (Thomas Erdmann)
Date: Wed, 27 Sep 2006 20:55:02 +0200
Subject: [Softdevice-devel] softdevice xv and i915 Notebook
In-Reply-To: <1159378202.451ab51a6ebce@webmail.in-berlin.de>
References: <200609211822.51577.t-erdmann@web.de>
	<200609271732.24495.t-erdmann@web.de>
	<1159378202.451ab51a6ebce@webmail.in-berlin.de>
Message-ID: <200609272055.02845.t-erdmann@web.de>

Am Mittwoch, 27. September 2006 19:30 schrieb Stefan Lucke:
> But that's not the sequence I intendet to asked for. Command I wrote
> is buggy. From vdr's directrory I do:
>
> jarada vdr-1.4.0.jarada # gdb ./vdr
> GNU gdb 6.4
> Copyright 2005 Free Software Foundation, Inc.
> GDB is free software, covered by the GNU General Public License, and you
> are welcome to change it and/or distribute copies of it under certain
> conditions. Type "show copying" to see the conditions.
> There is absolutely no warranty for GDB.  Type "show warranty" for details.
> This GDB was configured as "i686-pc-linux-gnu"...Using host libthread_db
> library "/lib/tls/libthread_db.so.1".
>
> (gdb) set args -P "softdevice -vo xv:" -E
> /net_data/vdr137-dvb-t-jarada/epg.data -c /net_data/vdr137-dvb-t-jarada -v
> /net_data/video/ -p 2010
> (gdb) run

Hello Stefan,
with this setup some more Information is printed:

[Thread debugging using libthread_db enabled]
[New Thread -1211808064 (LWP 8438)]
[softdevice] processing args
[softdevice]   argv [0] = softdevice
[softdevice]   argv [1] = -vo
vo_argv: xv:
[setup-softdevice] alsa ac3Mode set to: 0
[setup-softdevice] alsa AC3 device set to: hw:0,1
[setup-softdevice] alsa device set to: default
[setup-softdevice] A/V Offset set to (0)
[setup-softdevice] Cropping 0 lines from bottom
[setup-softdevice] Cropping 0 columns from left
[setup-softdevice] cropping mode set to 0 (none)
[setup-softdevice] cropping mode toggle key set to 0 (none)
[setup-softdevice] Cropping 0 columns from right
[setup-softdevice] Cropping 0 lines from top
[setup-softdevice] deinterlace method set to 0 none
[setup-softdevice] mainMenu: 1
[setup-softdevice] setting alpha blend mode to pseudo
[softdevice] picture mirroring set to 0 (off)
[setup-softdevice] pixel format set to (I420)
[setup-softdevice] shouldSuspend to: 0
[setup-softdevice] syncTimerMode: sig
[softdevice] UseStretchBlitset to off
[setup-softdevice] vidBrightness: 40
[setup-softdevice] vidContrast: 37
[setup-softdevice] vidHue: 50
[setup-softdevice] vidSaturation: 50
[setup-softdevice] startup aspect set to (4:3 normal)
[New Thread -1219802192 (LWP 8439)]
[New Thread -1228190800 (LWP 8440)]
[New Thread -1236579408 (LWP 8442)]
[New Thread -1244968016 (LWP 8443)]
[softdevice] initializing Plugin
[softdevice] Initializing Video Out
[softdevice] ffmpeg version(CVS) build(3344384)
[New Thread -1255257168 (LWP 8444)]
[XvVideoOut]: osd_image shmid = 3801090
[XvVideoOut]: got osd_image: width 1400 height 1050, bytes per line 5600
[XvVideoOut]: max area size 1920 x 1088
[XvVideoOut]: using area size 736 x 576
[softdevice] Subplugin successfully opend
[softdevice] Video Out seems to be OK
[softdevice] Initializing Audio Out
[softdevice] Audio out seems to be OK
[softdevice] A/V devices initialized, now initializing MPEG2 Decoder
[New Thread -1270617168 (LWP 8447)]
[New Thread -1281025104 (LWP 8448)]
[Thread -1228190800 (LWP 8440) exited]
[Thread -1219802192 (LWP 8439) exited]
[Thread -1281025104 (LWP 8448) exited]
[New Thread -1281025104 (LWP 8450)]
[New Thread -1219802192 (LWP 8451)]
[New Thread -1228190800 (LWP 8452)]
[New Thread -1293616208 (LWP 8453)]
[New Thread -1303712848 (LWP 8454)]
[New Thread -1312101456 (LWP 8455)]
[New Thread -1322255440 (LWP 8456)]
[Thread -1303712848 (LWP 8454) exited]
[mpeg2video @ 0xb7ac5304]ac-tex damaged at 13 25
[mpeg2video @ 0xb7ac5304]Warning MVs not available
[mpeg2video @ 0xb7ac5304]concealing 60 DC, 60 AC, 60 MV errors
[mpeg2video @ 0xb7ac5304]ac-tex damaged at 24 19
[mpeg2video @ 0xb7ac5304]Warning MVs not available
[mpeg2video @ 0xb7ac5304]concealing 180 DC, 180 AC, 180 MV errors
[New Thread -1303712848 (LWP 8457)]
[Thread -1281025104 (LWP 8450) exited]
[Thread -1312101456 (LWP 8455) exited]
[Thread -1293616208 (LWP 8453) exited]
[Thread -1322255440 (LWP 8456) exited]
[Thread -1219802192 (LWP 8451) exited]
[Thread -1228190800 (LWP 8452) exited]
[New Thread -1228190800 (LWP 8458)]
[New Thread -1219802192 (LWP 8459)]
[New Thread -1322255440 (LWP 8460)]
[New Thread -1293616208 (LWP 8462)]
[New Thread -1312101456 (LWP 8463)]
[New Thread -1285063760 (LWP 8464)]

Program received signal SIGSEGV, Segmentation fault.
[Switching to Thread -1303712848 (LWP 8457)]
0xb7bf5067 in cSoftOsd::ScaleUpVert_MMX (this=0x87db5a0, dest=0x0, 
linesize=5600, new_pixel_height=0,
    start_pos=0, pixmap=0xb24ae33c, Pixel=1400) at SoftOsd.c:1640
1640                                    "r" 
(&dest[ypos*linesize+currPixel*4]) );
Current language:  auto; currently c++
(gdb) bt
#0  0xb7bf5067 in cSoftOsd::ScaleUpVert_MMX (this=0x87db5a0, dest=0x0, 
linesize=5600, new_pixel_height=0,
    start_pos=0, pixmap=0xb24ae33c, Pixel=1400) at SoftOsd.c:1640
#1  0xb7bf599d in cSoftOsd::ScaleVUpCopyToBitmap (this=0x87db5a0, 
dest=0xb4533000 "", linesize=5600,
    dest_Width=1400, dest_Height=1049, RefreshAll=true, dest_dirtyLines=0x0) 
at SoftOsd.c:1091
#2  0xb7bf65b0 in cSoftOsd::OsdCommit (this=0x87db5a0) at SoftOsd.c:181
#3  0xb7bf6764 in cSoftOsd::Action (this=0x87db5a0) at SoftOsd.c:120
#4  0x080f22ac in cThread::StartThread (Thread=0x87db5fc) at thread.c:244
#5  0xb7eaeced in start_thread () from /lib/tls/libpthread.so.0
#6  0xb7d27dee in clone () from /lib/tls/libc.so.6
(gdb) bt full
#0  0xb7bf5067 in cSoftOsd::ScaleUpVert_MMX (this=0x87db5a0, dest=0x0, 
linesize=5600, new_pixel_height=0,
    start_pos=0, pixmap=0xb24ae33c, Pixel=1400) at SoftOsd.c:1640
        pos = 0
        currPixel = 0
#1  0xb7bf599d in cSoftOsd::ScaleVUpCopyToBitmap (this=0x87db5a0, 
dest=0xb4533000 "", linesize=5600,
    dest_Width=1400, dest_Height=1049, RefreshAll=true, dest_dirtyLines=0x0) 
at SoftOsd.c:1091
        start_row = 0
        start_pos = 0
        src = (uint8_t *) 0x42a0201 <Address 0x42a0201 out of bounds>
#2  0xb7bf65b0 in cSoftOsd::OsdCommit (this=0x87db5a0) at SoftOsd.c:181
        osd = (uint8_t *) 0xb4533000 ""
        stride = 5600
        dirtyLines = (bool *) 0x0
#3  0xb7bf6764 in cSoftOsd::Action (this=0x87db5a0) at SoftOsd.c:120
        newYPan = 0
        Depth = 32
        HasAlpha = false
        IsYUV = false
        modeChanged = false
        newOsdWidth = 1400
        newOsdHeight = 1049
        newXPan = 0
        AlphaInversed = false
        PixelMask = (uint8_t *) 0x0
#4  0x080f22ac in cThread::StartThread (Thread=0x87db5fc) at thread.c:244
No locals.
#5  0xb7eaeced in start_thread () from /lib/tls/libpthread.so.0
No symbol table info available.
#6  0xb7d27dee in clone () from /lib/tls/libc.so.6
No symbol table info available.


From M.Wache at gmx.net  Wed Sep 27 21:00:19 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Wed, 27 Sep 2006 21:00:19 +0200
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long
 time
In-Reply-To: <200609270927.45699.laz@club-burniston.co.uk>
References: <20060918181952.GA2739@localhost.localdomain>	<20060926151323.GA21046@localhost.localdomain>	<45199409.7090004@gmx.net>
	<200609270927.45699.laz@club-burniston.co.uk>
Message-ID: <451ACA43.6040605@gmx.net>

Laz schrieb:
> On Tuesday 26 September 2006 21:56, Martin Wache wrote:
> 
>> Laz, how do you suspend your vdr? Do you use Marko's patch or the
>> softdevice suspend method?
> 
> All I'm doing is pressing "pause" whilst I go off and do something (then 
> get distracted and end up coming back a long time later!), unpausing 
> playback, and then I get the ca. 1 s of playback before it dies. Offhand, 

Is this video only, audio only, or both?

> I can't remember whether this is softdevice bombing out with something 
> like an "invalid address" error (which I still get occasionally) or 
> whether vdr itself hangs.
> 
> As I said, I could never manage to induce this bug when I tried! It only 
> ever happens when paused for a long time, though.
> 
> A thought (probably totally off-track and irrelevant!): how long in terms 
> of playback time do the softdevice buffers hold (can't really check this 
> now; I think I'm set to "Good seeking")? 

Hmm, sorry right now I don't now.

> I.e., am I seeing the buffers 
> being flushed over about 1 s and then it dies because there is no more 
> MPEG stream being fed into them (or no more is requested)?
> 
Not sure what happens. In one of the backtraces Marko sent it looked
like the video decoder thread got deadlocked.

> I posted something about this problem on the main vdr mailing list a while 
> back and someone reported that you can pause "forever" with a 
> full-featured card.
>
I also never had problems when I closed the ShmClient. The softdevice is
then automatically suspended. However I'm not sure if that means
anything... I will try some experiments at the weekend.

If you, or anyone else experiences could you please try to attach to the
vdr with a gdb and post backtraces like Marko did? Maybe we get some
hints from them.

Bye,
Martin



From marko.makela at hut.fi  Wed Sep 27 21:05:58 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 27 Sep 2006 22:05:58 +0300
Subject: [Softdevice-devel] OSD layer not always fully cleared on mgatv
In-Reply-To: <200609252324.33040.stefan@lucke.in-berlin.de>
References: <20060918095530.GD3928@localhost.localdomain>
	<200609251947.17789.stefan@lucke.in-berlin.de>
	<20060925195833.GA3331@localhost.localdomain>
	<200609252324.33040.stefan@lucke.in-berlin.de>
Message-ID: <20060927190558.GA2823@localhost.localdomain>

On Mon, Sep 25, 2006 at 11:24:32PM +0200, Stefan Lucke wrote:
> So my tv-out test is still pending, but I've a new version of the patch.
> If it still happens for you sometimes, there is the possibility to enable
> a mutex around Flip() and Blit() calls. To enable this, USE_TEST_MUTEX
> should be defined to 1.

Sorry, I haven't gotten around to testing this yet.  Should I revert the
-03 patch and apply this one instead?  By the way, the -03 patch does slow
down my system too much from time to time, especially when watching programs
containing DVB subtitles, which are mapped to OSD by the subtitles plugin.

> Don't know if DirectFB locks Flip() and Blit() calls internal.

I'm not familiar with the code, but I would tend to believe it does not.
When I did my weekly EPG scan (looking for programs to record) today and
was changing pages in the EPG menu, a few times the old page quickly
flashed (for one field or frame) immediately after the page was redrawn.

	Marko


From marko.makela at hut.fi  Wed Sep 27 21:14:42 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 27 Sep 2006 22:14:42 +0300
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long
	time
In-Reply-To: <451ACA43.6040605@gmx.net>
References: <20060918181952.GA2739@localhost.localdomain>
	<20060926151323.GA21046@localhost.localdomain>
	<45199409.7090004@gmx.net>
	<200609270927.45699.laz@club-burniston.co.uk>
	<451ACA43.6040605@gmx.net>
Message-ID: <20060927191442.GB2823@localhost.localdomain>

On Wed, Sep 27, 2006 at 09:00:19PM +0200, Martin Wache wrote:
> If you, or anyone else experiences could you please try to attach to the
> vdr with a gdb and post backtraces like Marko did? Maybe we get some
> hints from them.

Indeed.  I did something like this after the hang occurred:

$ cd vdr-1.4.2
$ ps x|grep vdr
$ gdb vdr
(gdb) attach <pid displayed by the ps command>
(gdb) set height 0
(gdb) set logging on
(gdb) i thr
(gdb) thr 1
(gdb) bt full
(gdb) thr 2
(gdb) bt full
...
(gdb) thr <highest reported by "i thr">
(gdb) bt full
(gdb) set logging off
(gdb) quit

Next time, I will override my relay box when resuming from a long
suspend, to see if any video is displayed during the one-second period
after resuming.

	Marko


From stefan at lucke.in-berlin.de  Thu Sep 28 00:09:51 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 28 Sep 2006 00:09:51 +0200
Subject: [Softdevice-devel] OSD layer not always fully cleared on mgatv
In-Reply-To: <20060927190558.GA2823@localhost.localdomain>
References: <20060918095530.GD3928@localhost.localdomain>
	<200609252324.33040.stefan@lucke.in-berlin.de>
	<20060927190558.GA2823@localhost.localdomain>
Message-ID: <200609280009.52120.stefan@lucke.in-berlin.de>

On Mittwoch 27 September 2006 21:05, Marko M?kel? wrote:
> On Mon, Sep 25, 2006 at 11:24:32PM +0200, Stefan Lucke wrote:
> > So my tv-out test is still pending, but I've a new version of the patch.
> > If it still happens for you sometimes, there is the possibility to enable
> > a mutex around Flip() and Blit() calls. To enable this, USE_TEST_MUTEX
> > should be defined to 1.
> 
> Sorry, I haven't gotten around to testing this yet.  Should I revert the
> -03 patch and apply this one instead?

Please don't test the -04 patch. It has still the osdMutex in. Have to test
this on my system with tv-out first. 

> By the way, the -03 patch does slow 
> down my system too much from time to time, especially when watching programs
> containing DVB subtitles, which are mapped to OSD by the subtitles plugin.
> 
> > Don't know if DirectFB locks Flip() and Blit() calls internal.
> 
> I'm not familiar with the code, but I would tend to believe it does not.
> When I did my weekly EPG scan (looking for programs to record) today and
> was changing pages in the EPG menu, a few times the old page quickly
> flashed (for one field or frame) immediately after the page was redrawn.


-- 
Stefan Lucke


From malcolm.caldwell at cdu.edu.au  Thu Sep 28 00:14:22 2006
From: malcolm.caldwell at cdu.edu.au (Malcolm Caldwell)
Date: Thu, 28 Sep 2006 07:44:22 +0930
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long
	time
In-Reply-To: <20060926211729.GE2753@localhost.localdomain>
References: <20060918181952.GA2739@localhost.localdomain>
	<450EEF84.5090808@gmx.net>
	<20060918202224.GA3319@localhost.localdomain>
	<450FF2E0.9020904@gmx.net>
	<20060919193743.GA2796@localhost.localdomain>
	<20060926151323.GA21046@localhost.localdomain>
	<45199409.7090004@gmx.net>
	<20060926211729.GE2753@localhost.localdomain>
Message-ID: <1159395262.3251.4.camel@localhost.localdomain>

On Wed, 2006-09-27 at 00:17 +0300, Marko M?kel? wrote:
> On Tue, Sep 26, 2006 at 10:56:41PM +0200, Martin Wache wrote:
> > Laz, how do you suspend your vdr? Do you use Marko's patch or the
> > softdevice suspend method?
> 
> I understood that he just pauses some recording, and he sometimes gets
> the hang when he resumes playback.  There was a suspend plugin
> for some vdr 1.3 version that did roughly so.

Just to say me-too.  I have had a hang after resuming a paused playback.
I can not say how many times this has happened, but it would be at least
5.

> 
> 	Marko


From stefan at lucke.in-berlin.de  Thu Sep 28 10:04:16 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 28 Sep 2006 10:04:16 +0200
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a
	long	time
Message-ID: <1159430656.451b8200d5e39@webmail.in-berlin.de>

Quoting Malcolm Caldwell <malcolm.caldwell at cdu.edu.au>:

> On Wed, 2006-09-27 at 00:17 +0300, Marko M??kel?? wrote:
> > On Tue, Sep 26, 2006 at 10:56:41PM +0200, Martin Wache wrote:
> > > Laz, how do you suspend your vdr? Do you use Marko's patch or the
> > > softdevice suspend method?
> >
> > I understood that he just pauses some recording, and he sometimes gets
> > the hang when he resumes playback.  There was a suspend plugin
> > for some vdr 1.3 version that did roughly so.
>
> Just to say me-too.  I have had a hang after resuming a paused playback.
> I can not say how many times this has happened, but it would be at least
> 5.

Just another me too. If I remember my situation correct, I've
had 2 or 3 times the same with xv-out: paused video, window blanked.
After continuing playback, there was a short time with audio and
nothing else. Had to CONTROL-C (killall -9) from command window.

There are some essential operations in audio-alsa.c , which are
not protected by handleMutex: Suspend(), Resume() and calling
snd_pcm_mmap_writei() after while (paused) usleep(1000); .

Problem here is, that we need to differ between read and write locks.
Read locks for all operations on handle (including snd--writei()) and
write lock for those which change the state of handle.

Vdr's class cRwLock was introduced in the late 1.3.xx time.
So we have to decide:
1. make a lokal copy of that code to support all vdr versions
2. make softdevice a vdr-1.4.x plugins only

Stefan


From stefan at lucke.in-berlin.de  Thu Sep 28 20:57:27 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 28 Sep 2006 20:57:27 +0200
Subject: [Softdevice-devel] OSD layer not always fully cleared on mgatv
In-Reply-To: <200609280009.52120.stefan@lucke.in-berlin.de>
References: <20060918095530.GD3928@localhost.localdomain>
	<20060927190558.GA2823@localhost.localdomain>
	<200609280009.52120.stefan@lucke.in-berlin.de>
Message-ID: <200609282057.27462.stefan@lucke.in-berlin.de>

On Donnerstag 28 September 2006 00:09, Stefan Lucke wrote:
> On Mittwoch 27 September 2006 21:05, Marko M?kel? wrote:
> > On Mon, Sep 25, 2006 at 11:24:32PM +0200, Stefan Lucke wrote:
> > > So my tv-out test is still pending, but I've a new version of the patch.
> > > If it still happens for you sometimes, there is the possibility to enable
> > > a mutex around Flip() and Blit() calls. To enable this, USE_TEST_MUTEX
> > > should be defined to 1.
> > 
> > Sorry, I haven't gotten around to testing this yet.  Should I revert the
> > -03 patch and apply this one instead?
> 
> Please don't test the -04 patch. It has still the osdMutex in. Have to test
> this on my system with tv-out first. 

So her comes -05 version of the patch. I tested this with tv-out.
My testing was fast scrolling through the channel list.
I did not see any issues with a missed flip on OSD drawing.

So I had no need for enabling the dfbFlipMutex.

The final version will have method ShowOSD() removed.

If you ask for differences between -03 and -05 ..
Upon processing events there will be never an internal OSD refresh
via ShowOSD() .

> 
> > By the way, the -03 patch does slow 
> > down my system too much from time to time, especially when watching programs
> > containing DVB subtitles, which are mapped to OSD by the subtitles plugin.

If you've still this issue, I think black bar clearing could be done after
scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC); 
to clear borders of the next frame.

-- 
Stefan Lucke
-------------- next part --------------
Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.66
diff -U3 -r1.66 video.c
--- video.c	22 Sep 2006 19:28:04 -0000	1.66
+++ video.c	28 Sep 2006 17:29:55 -0000
@@ -105,7 +105,7 @@
 
     if (
         OsdRefreshCounter > 120 || // blanks the screen after inactivity (4s)
-        (current_osdMode == OSDMODE_SOFTWARE &&
+        (IsSoftOSDMode() &&
          OsdRefreshCounter>5 && Osd_changed))
     {
       oldPictureMutex.Lock();
@@ -476,8 +476,6 @@
 void cVideoOut::ClearOSD()
 {
   OSDDEB("ClearOSD\n");
-  osdMutex.Lock();
-
   OSDpresent=false; // will automaticly be set to true on redraw ;-)
   if (OsdPy)
     memset(OsdPy,0,OSD_FULL_WIDTH*OSD_FULL_HEIGHT);
@@ -490,8 +488,13 @@
   if (OsdPAlphaUV)
     memset(OsdPAlphaUV,0,OSD_FULL_WIDTH*OSD_FULL_HEIGHT/4);
   Osd_changed=1;
+}
 
- osdMutex.Unlock();
+/* ---------------------------------------------------------------------------
+ */
+bool cVideoOut::IsSoftOSDMode()
+{
+  return current_osdMode == OSDMODE_SOFTWARE;
 }
 
 #if VDRVERSNUM >= 10307
@@ -503,10 +506,8 @@
 
 void cVideoOut::CloseOSD()
 {
-  osdMutex.Lock();
   ClearOSD();
   OSDpresent=false;
-  osdMutex.Unlock();
   OSDDEB("CloseOSD\n");
 }
 
Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.43
diff -U3 -r1.43 video.h
--- video.h	22 Sep 2006 19:28:04 -0000	1.43
+++ video.h	28 Sep 2006 17:29:56 -0000
@@ -79,7 +79,9 @@
     // oldPicture is a reference to a previous decoded frame. It is used
     // when there is osd drawing activity in case of no video currently
     // available. Access to this pointer must be protected by corresponding
-    // mutex: oldPictureMutex .
+    // mutex: oldPictureMutex . This includes changeing the contens e.g.
+    // when a decoded picture will be displayed and thus will be the reference
+    // for future operation on oldPicture.
     //
     sPicBuffer  *oldPicture;
     cMutex      oldPictureMutex;
@@ -89,12 +91,8 @@
     inline double GetAspect_F()
     { return aspect_F;};
 
-protected:
     // -----------------------------------------------------------------------
-    // State changes of OSD like on / off transitions, must be proteced by
-    // osdMutex. This are changes of variable OSDpresent, as the output method
-    // may need to take some longer actions e.g clearing background for one or
-    // mutiple output buffers (double, triple buffering).
+    // Artefakt of vdr-1.2.x OSD create/delete locking
     //
     cMutex  osdMutex;
     bool    OSDpresent,
@@ -193,6 +191,8 @@
 public:
     virtual void ClearOSD();
     // clear the OSD buffer
+
+    virtual bool IsSoftOSDMode();
 
 #if VDRVERSNUM >= 10307
     virtual void OpenOSD();
Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.71
diff -U3 -r1.71 video-dfb.c
--- video-dfb.c	16 Sep 2006 09:30:19 -0000	1.71
+++ video-dfb.c	28 Sep 2006 17:29:58 -0000
@@ -49,6 +49,8 @@
            }                                                         \
      }
 
+#define USE_TEST_MUTEX 0
+
 typedef struct
 {
   const char            *shortName;
@@ -661,8 +663,8 @@
     }
   }
 
-  if (OsdRefreshCounter && (OsdRefreshCounter % 3) == 0)
-    ShowOSD();
+  //if (OsdRefreshCounter && (OsdRefreshCounter % 3) == 0)
+    //ShowOSD();
 }
 
 /* ---------------------------------------------------------------------------
@@ -1072,7 +1074,7 @@
   try
   {
     dirtyLines=DirtyLines=new bool[Yres];
-    memset(dirtyLines,false,sizeof(dirtyLines));
+    memset(dirtyLines,false,sizeof(bool)*Yres);
 
     tmpOsdSurface = (useStretchBlit) ? osdSurface : scrSurface;
     tmpOsdSurface->Lock(DSLF_WRITE, (void **)&dst, &pitch) ;
@@ -1100,7 +1102,13 @@
     DFBRectangle      osdsrc;
 
     tmpOsdSurface->Unlock();
+#if USE_TEST_MUTEX
+    dfbFlipMutex.Lock();
+#endif
     tmpOsdSurface->Flip();
+#if USE_TEST_MUTEX
+    dfbFlipMutex.Unlock();
+#endif
 
     int miny=0;
     int maxy=0;
@@ -1137,6 +1145,7 @@
   delete[] dirtyLines;
   dirtyLines=NULL;
   tmpOsdSurface=NULL;
+  clearBackground = 0;
   cVideoOut::CommitUnlockOsdSurface();
 }
 
@@ -1203,6 +1212,14 @@
 
 /* ---------------------------------------------------------------------------
  */
+bool cDFBVideoOut::IsSoftOSDMode()
+{
+  return cVideoOut::IsSoftOSDMode() ||
+         useStretchBlit;
+}
+
+/* ---------------------------------------------------------------------------
+ */
 void cDFBVideoOut::CloseOSD()
 {
     IDirectFBSurface  *tmpSurface;
@@ -1210,16 +1227,14 @@
   if (!videoInitialized)
     return;
 
+  cVideoOut::CloseOSD();
   tmpSurface = (useStretchBlit) ? osdSurface : scrSurface;
-
   try
   {
     if (useStretchBlit)
     {
-      osdMutex.Lock();
       OSDpresent  = false;
-      osdClrBack = true;
-      osdMutex.Unlock();
+      clearBackground = clearBackCount;
       tmpSurface->Clear(COLORKEY,clearAlpha); //clear and
     }
     else
@@ -1248,7 +1263,7 @@
   if (!videoInitialized)
     return;
 
-  if (useStretchBlit && (OSDpresent || osdClrBack)) {
+  if (useStretchBlit && OSDpresent) {
     // do image and OSD mix here
       DFBRectangle  src, dst, osdsrc;
 
@@ -1261,12 +1276,6 @@
     dst.w = lwidth;
     dst.h = lheight;
 
-    osdMutex.Lock();
-    if (osdClrBack) {
-      clearBackground = clearBackCount;
-      osdClrBack = false;
-    }
-
     try
     {
       if (clearBackground) {
@@ -1274,6 +1283,32 @@
         clearBackground--;
       }
 
+      /* ---------------------------------------------------------------------
+       * clear parts of screen when OSD is present and which are not
+       * covered by video. This avoids fading effects when 16:9 video
+       * is shown on 4:3 screen (top & bottom) or when 4:3 video is shown
+       * on 16:9 screen (left & right).
+       */
+      if (OSDpresent) {
+          scrSurface->SetColor(0,0,0,0);
+
+        /* -------------------------------------------------------------------
+         * clear top & bottom black bar area
+         */
+        if (lyoff) {
+          scrSurface->FillRectangle(0,0,            dwidth,lyoff);
+          scrSurface->FillRectangle(0,lyoff+lheight,dwidth,lyoff);
+        }
+
+        /* -------------------------------------------------------------------
+         * clear left & right black bar area
+         */
+        if (lxoff) {
+          scrSurface->FillRectangle(0,0,           lxoff,dheight);
+          scrSurface->FillRectangle(lxoff+lwidth,0,lxoff,dheight);
+        }
+      }
+
       scrSurface->SetBlittingFlags(DSBLIT_NOFX);
       scrSurface->StretchBlit(videoSurface, &src, &dst);
       if (OSDpresent)
@@ -1292,7 +1327,6 @@
                ex->GetAction(), ex->GetResult());
       delete ex;
     }
-    osdMutex.Unlock();
   }
 }
 
@@ -1436,9 +1470,7 @@
       //fprintf (stderr, "src (%d,%d %dx%d)\n", sxoff,syoff,swidth,sheight);
       //fprintf (stderr, "dst (%d,%d %dx%d)\n", lxoff,lyoff,lwidth,lheight);
 
-      osdMutex.Lock();
-      clearBackground = (aspect_changed || osdClrBack) ? clearBackCount: clearBackground;
-      osdClrBack = false;
+      clearBackground = (aspect_changed) ? clearBackCount: clearBackground;
 
       if (clearBackground)
       {
@@ -1446,7 +1478,32 @@
         clearBackground--;
       }
 
-      osdMutex.Unlock();
+
+      /* ---------------------------------------------------------------------
+       * clear parts of screen when OSD is present and which are not
+       * covered by video. This avoids fading effects when 16:9 video
+       * is shown on 4:3 screen (top & bottom) or when 4:3 video is shown
+       * on 16:9 screen (left & right).
+       */
+      if (OSDpresent) {
+          scrSurface->SetColor(0,0,0,0);
+
+        /* -------------------------------------------------------------------
+         * clear top & bottom black bar area
+         */
+        if (lyoff) {
+          scrSurface->FillRectangle(0,0,            dwidth,lyoff);
+          scrSurface->FillRectangle(0,lyoff+lheight,dwidth,lyoff);
+        }
+
+        /* -------------------------------------------------------------------
+         * clear left & right black bar area
+         */
+        if (lxoff) {
+          scrSurface->FillRectangle(0,0,           lxoff,dheight);
+          scrSurface->FillRectangle(lxoff+lwidth,0,lxoff,dheight);
+        }
+      }
 
       scrSurface->SetBlittingFlags(DSBLIT_NOFX);
       scrSurface->StretchBlit(videoSurface, &src, &dst);
@@ -1457,6 +1514,11 @@
         osdsrc.x = osdsrc.y = 0;
         osdsrc.w = Xres;osdsrc.h=Yres;
         scrSurface->SetBlittingFlags(DSBLIT_BLEND_ALPHACHANNEL);
+
+#if USE_TEST_MUTEX
+        dfbFlipMutex.Lock();
+#endif
+
 #if 0
         /* --------------------------------------------------------------------
          * test for OSD scaleinf to 4:3 aspect on a 16:9 tv
@@ -1467,6 +1529,10 @@
         scrSurface->StretchBlit(osdSurface, &osdsrc, &osddest);
 #else
         scrSurface->Blit(osdSurface, &osdsrc, 0, 0);
+#endif
+
+#if USE_TEST_MUTEX
+        dfbFlipMutex.Unlock();
 #endif
 
       }
Index: video-dfb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.h,v
retrieving revision 1.22
diff -U3 -r1.22 video-dfb.h
--- video-dfb.h	17 Jun 2006 16:27:35 -0000	1.22
+++ video-dfb.h	28 Sep 2006 17:29:59 -0000
@@ -50,6 +50,8 @@
     void SetParams();
     void EnableFieldParity(IDirectFBDisplayLayer *layer);
 
+    cMutex  dfbFlipMutex;
+
 #ifdef HAVE_CLE266_MPEG_DECODER
     IDirectFBSurface* mpegfb[LAST_PICBUF];
     int               mpegfb_ofs[4];
@@ -62,6 +64,7 @@
     void ProcessEvents ();
     void ShowOSD ();
     void GetDisplayFrameTime();
+    virtual bool IsSoftOSDMode();
 
 #if VDRVERSNUM >= 10307
     bool *dirtyLines;

From M.Wache at gmx.net  Thu Sep 28 23:40:25 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 28 Sep 2006 23:40:25 +0200
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a	long
 time
In-Reply-To: <1159430656.451b8200d5e39@webmail.in-berlin.de>
References: <1159430656.451b8200d5e39@webmail.in-berlin.de>
Message-ID: <451C4149.8040004@gmx.net>

Stefan Lucke schrieb:
> Quoting Malcolm Caldwell <malcolm.caldwell at cdu.edu.au>:
> 
>> On Wed, 2006-09-27 at 00:17 +0300, Marko M??kel?? wrote:
>>> On Tue, Sep 26, 2006 at 10:56:41PM +0200, Martin Wache wrote:
>>>> Laz, how do you suspend your vdr? Do you use Marko's patch or the
>>>> softdevice suspend method?
>>> I understood that he just pauses some recording, and he sometimes gets
>>> the hang when he resumes playback.  There was a suspend plugin
>>> for some vdr 1.3 version that did roughly so.
>> Just to say me-too.  I have had a hang after resuming a paused playback.
>> I can not say how many times this has happened, but it would be at least
>> 5.
> 
> Just another me too. If I remember my situation correct, I've
> had 2 or 3 times the same with xv-out: paused video, window blanked.
> After continuing playback, there was a short time with audio and
> nothing else. Had to CONTROL-C (killall -9) from command window.
> 
> There are some essential operations in audio-alsa.c , which are
> not protected by handleMutex: Suspend(), Resume() and calling
> snd_pcm_mmap_writei() after while (paused) usleep(1000); .
> 
That is true, those calls are unprotected.

However, the audio-out is during normal operation only called from one
thread, namely the audio-decoder. Only if the user request a suspend,
the mpegdecoder thread suspends the audio-out. But that wasn't the case,
  so that audio-out was only called by one thread, and that means locks
should not be needed.

Bye,
Martin


From laz at club-burniston.co.uk  Fri Sep 29 11:24:20 2006
From: laz at club-burniston.co.uk (Laz)
Date: Fri, 29 Sep 2006 10:24:20 +0100
Subject: [Softdevice-devel]
	=?iso-8859-1?q?Hang_after_suspending_MPEG_stre?=
	=?iso-8859-1?q?am_for_a=09long_time?=
In-Reply-To: <451C4149.8040004@gmx.net>
References: <1159430656.451b8200d5e39@webmail.in-berlin.de>
	<451C4149.8040004@gmx.net>
Message-ID: <200609291024.20726.laz@club-burniston.co.uk>

On Thursday 28 September 2006 22:40, Martin Wache wrote:
> Stefan Lucke schrieb:
> > Just another me too. If I remember my situation correct, I've
> > had 2 or 3 times the same with xv-out: paused video, window blanked.
> > After continuing playback, there was a short time with audio and
> > nothing else. Had to CONTROL-C (killall -9) from command window.
> >
> > There are some essential operations in audio-alsa.c , which are
> > not protected by handleMutex: Suspend(), Resume() and calling
> > snd_pcm_mmap_writei() after while (paused) usleep(1000); .
>
> That is true, those calls are unprotected.
>
> However, the audio-out is during normal operation only called from one
> thread, namely the audio-decoder. Only if the user request a suspend,
> the mpegdecoder thread suspends the audio-out. But that wasn't the
> case, so that audio-out was only called by one thread, and that means
> locks should not be needed.

Hmmmm...I don't think I get this problem if I suspend decoding, if that's 
what you mean here by 'suspend'. Having said that, I don't think I've 
tried suspending the decoding for a long while... I see the effect when I 
pause playback.

As to whether I get audio only or video, I can't really say for certain. 
This only happens occasionally and when it does I'm not usually expecting 
it so I might not be looking at the TV when I press play. I definitely 
get audio for about a second or less, and I _think_ I get video but I 
could be making that up.

Cheers,

Laz


From torgeir at pobox.com  Fri Sep 29 14:19:39 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Fri, 29 Sep 2006 13:19:39 +0100
Subject: [Softdevice-devel] just recompiled, now fails to run..
Message-ID: <9F84AAE5-5E94-428E-96E4-73935C69C9AB@pobox.com>

I just updated and recompiled DirectFB and softdevice to test the  
fixes for interlaced output, but now vdr won't start again. I've seen  
it before but I don't remember how I fixed it. Can anyone give me a  
hint?

log:

(*) DirectFB/Input: Keyboard 0.9 (convergence integrated media GmbH)
(*) DirectFB/Genefx: MMX detected and enabled
(*) DirectFB/Graphics: Matrox G550 0.7 (directfb.org)
(*) DirectFB/Core/WM: Default 0.2 (Convergence GmbH)
[dfb] RAM: 33554432 bytes
[dfb] Accellerated Functions: FillRectange DrawRectange DrawLine  
FillTriangle Blit StretchBlit All
[dfb] Drawing Flags: Blend Src.premultiply
[dfb] Surface Blitting Flags: BlendAlpha BlendColorAlpha Colorize  
SrcColorkey SrcPremultiply Deinterlace
[dfb] Supported video Modes are: 640x480 at 8 640x480 at 8 640x480 at 8  
640x480 at 8 640x480 at 8 800x600 at 8 800x600 at 8 800x600 at 8 800x600 at 8 800x600 at 8  
800x600 at 8 800x600 at 8 800x600 at 8 1024x768 at 8 1024x768 at 8 1024x768 at 8  
1024x768 at 8 1024x768 at 8 1024x768 at 8 1152x864 at 8 1152x864 at 8 1152x864 at 8  
1152x864 at 8 1152x864 at 8 1152x864 at 8 1280x1024 at 8 1600x1200 at 8 1600x1200 at 8  
1600x1200 at 8 1280x720 at 32 1280x720 at 16 720x576 at 32 768x576 at 32
[dfb] Enumerating display Layers
Layer 2 FBDev Primary Layer  Type: graphics
   Caps: brightness contrast saturation surface
Layer 1 Matrox Backend Scaler  Type: graphics picture video
   Caps: brightness contrast deinterlacing dst_colorkey  
screen_location surface
Layer 0 Matrox CRTC2 Layer  Type: graphics picture video
   Caps: brightness contrast hue field_parity saturation surface
[dfb] (osdLayer): flags, options, pixelformat: 0000005f, 00000000  
00418c04
[dfb] (osdLayer): width, height:               720 576
[dfb] osdLayer without !! alpha channel
[dfb] Set DLBM_TRIPLE for layer [Matrox CRTC2 Layer]
[dfb] DLOP_FIELD_PARITY supported by layer [Matrox CRTC2 Layer]
[surface capabilities] scrSurface: videoonly flipping interlaced  
triple-buffered (!) [20966:    0.000] --> Caught signal 11 (at 0x2d0,  
invalid address) <--
/usr/local/bin/rundfb: line 17: 20966 Killed                  ./vdr - 
v /video/vdr -m 0 -s "killall vdr;/bin/false" -P"softdevice -vo  
dfb:mgatv" -P"remote -i /dev/input/event2" -P"remote -i /dev/input/ 
event1" -P"softplay --media-path /video/vdr" -Pdvd -Pfemon
Fri Sep 29 13:20:02 BST 2006
restarting VDR

gdb with backtrace give me this:

[dfb] (osdLayer): flags, options, pixelformat: 0000005f, 00000000  
00418c04
[dfb] (osdLayer): width, height:               720 576
[dfb] osdLayer without !! alpha channel
[dfb] Set DLBM_TRIPLE for layer [Matrox CRTC2 Layer]
[dfb] DLOP_FIELD_PARITY supported by layer [Matrox CRTC2 Layer]
[surface capabilities] scrSurface: videoonly flipping interlaced  
triple-buffered
Program received signal SIGSEGV, Segmentation fault.
[Switching to Thread -1208375072 (LWP 21000)]
0x002acb91 in reportSurfaceCapabilities (name=Variable "name" is not  
available.
) at video-dfb.c:195
195       fprintf(stderr, "PixelFormat = 0x%08x ", surf- 
 >GetPixelFormat());
Current language:  auto; currently c++
(gdb) ba
#0  0x002acb91 in reportSurfaceCapabilities (name=Variable "name" is  
not available.
) at video-dfb.c:195
#1  0x002af629 in cDFBVideoOut (this=0x92ba128, setupStore=0x170940)  
at video-dfb.c:402
#2  0x002afe27 in SubPluginCreator (s=0x170940) at video-dfb.c:1620
#3  0x0014d6f7 in cSoftDevice::LoadSubPlugin (this=0x92b9060,  
outMethodName=0x1672bd "dfb",
     pluginPath=0x8f18800 "./PLUGINS/lib/") at softdevice.c:355
#4  0x0014dd0e in cSoftDevice (this=0x92b9060, method=3, audioMethod=1,
     pluginPath=0x8f18800 "./PLUGINS/lib/") at softdevice.c:211
#5  0x0014de26 in cPluginSoftDevice::Initialize (this=0x8f187e0) at  
softdevice.c:1039
#6  0x080cc58c in cPluginManager::InitializePlugins (this=0xbff0bed4)  
at plugin.c:340
#7  0x080fb9c0 in main (argc=Cannot access memory at address 0x1
) at vdr.c:568
(gdb)

-- 
Torgeir Veimo
torgeir at pobox.com





From marko.makela at hut.fi  Fri Sep 29 14:44:43 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 29 Sep 2006 15:44:43 +0300
Subject: [Softdevice-devel] just recompiled, now fails to run..
In-Reply-To: <9F84AAE5-5E94-428E-96E4-73935C69C9AB@pobox.com>
References: <9F84AAE5-5E94-428E-96E4-73935C69C9AB@pobox.com>
Message-ID: <20060929124443.GC2840@localhost.localdomain>

On Fri, Sep 29, 2006 at 01:19:39PM +0100, Torgeir Veimo wrote:
> I just updated and recompiled DirectFB and softdevice to test the  
> fixes for interlaced output, but now vdr won't start again. I've seen  
> it before but I don't remember how I fixed it. Can anyone give me a  
> hint?

Recompile also vdr, in case you had applied any patches to it or updated
the compiler since the last time you compiled vdr and plugins.

	Marko


From torgeir at pobox.com  Fri Sep 29 15:10:27 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Fri, 29 Sep 2006 14:10:27 +0100
Subject: [Softdevice-devel] just recompiled, now fails to run..
In-Reply-To: <20060929124443.GC2840@localhost.localdomain>
References: <9F84AAE5-5E94-428E-96E4-73935C69C9AB@pobox.com>
	<20060929124443.GC2840@localhost.localdomain>
Message-ID: <356D4B55-9B0A-4459-9DFA-56E395EF92CF@pobox.com>


On 29 Sep 2006, at 13:44, Marko M?kel? wrote:

> On Fri, Sep 29, 2006 at 01:19:39PM +0100, Torgeir Veimo wrote:
>> I just updated and recompiled DirectFB and softdevice to test the
>> fixes for interlaced output, but now vdr won't start again. I've seen
>> it before but I don't remember how I fixed it. Can anyone give me a
>> hint?
>
> Recompile also vdr, in case you had applied any patches to it or  
> updated
> the compiler since the last time you compiled vdr and plugins.

I've recompiled VDR and all plugins.. Still get the same error.

-- 
Torgeir Veimo
torgeir at pobox.com





From torgeir at pobox.com  Fri Sep 29 17:37:27 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Fri, 29 Sep 2006 16:37:27 +0100
Subject: [Softdevice-devel] just recompiled, now fails to run..
In-Reply-To: <20060929124443.GC2840@localhost.localdomain>
References: <9F84AAE5-5E94-428E-96E4-73935C69C9AB@pobox.com>
	<20060929124443.GC2840@localhost.localdomain>
Message-ID: <73011110-5056-41FA-BE84-7F804A0C8A5A@pobox.com>


On 29 Sep 2006, at 13:44, Marko M?kel? wrote:

> On Fri, Sep 29, 2006 at 01:19:39PM +0100, Torgeir Veimo wrote:
>> I just updated and recompiled DirectFB and softdevice to test the
>> fixes for interlaced output, but now vdr won't start again. I've seen
>> it before but I don't remember how I fixed it. Can anyone give me a
>> hint?
>
> Recompile also vdr, in case you had applied any patches to it or  
> updated
> the compiler since the last time you compiled vdr and plugins.

It seems to be a problem with surfaces. It's weird, since every other  
dfb program works, df_xine runs nicely etc..

[dfb] Accellerated Functions: FillRectange DrawRectange DrawLine  
FillTriangle Blit StretchBlit All
[dfb] Drawing Flags: Blend Src.premultiply
[dfb] Surface Blitting Flags: BlendAlpha BlendColorAlpha Colorize  
SrcColorkey SrcPremultiply Deinterlace
[dfb] Supported video Modes are: 640x480 at 8 640x480 at 8 640x480 at 8  
640x480 at 8 640x480 at 8 800x600 at 8 800x600 at 8 800x600 at 8 800x600 at 8 800x600 at 8  
800x600 at 8 800x600 at 8 800x600 at 8 1024x768 at 8 1024x768 at 8 1024x768 at 8  
1024x768 at 8 1024x768 at 8 1024x768 at 8 1152x864 at 8 1152x864 at 8 1152x864 at 8  
1152x864 at 8 1152x864 at 8 1152x864 at 8 1280x1024 at 8 1600x1200 at 8 1600x1200 at 8  
1600x1200 at 8 1280x720 at 32 1280x720 at 16 720x576 at 32 768x576 at 32
[dfb] Enumerating display Layers
Layer 2 FBDev Primary Layer  Type: graphics
   Caps: brightness contrast saturation surface
Layer 1 Matrox Backend Scaler  Type: graphics picture video
   Caps: brightness contrast deinterlacing dst_colorkey  
screen_location surface
Layer 0 Matrox CRTC2 Layer  Type: graphics picture video
   Caps: brightness contrast hue field_parity saturation surface
[dfb] (osdLayer): flags, options, pixelformat: 0000005f, 00000000  
00418c04
[dfb] (osdLayer): width, height:               720 576
[dfb] osdLayer without !! alpha channel
[dfb] Set DLBM_TRIPLE for layer [Matrox CRTC2 Layer]
[dfb] DLOP_FIELD_PARITY supported by layer [Matrox CRTC2 Layer]
[surface capabilities] scrSurface: videoonly flipping interlaced  
triple-buffered
Program received signal SIGSEGV, Segmentation fault.
[Switching to Thread -1208162080 (LWP 17382)]
0x00a43b91 in reportSurfaceCapabilities (name=Variable "name" is not  
available.
) at video-dfb.c:195
195       fprintf(stderr, "PixelFormat = 0x%08x ", surf- 
 >GetPixelFormat());
Current language:  auto; currently c++
(gdb) ba
#0  0x00a43b91 in reportSurfaceCapabilities (name=Variable "name" is  
not available.
) at video-dfb.c:195
#1  0x00a46629 in cDFBVideoOut (this=0x888a9a0, setupStore=0x5a4d00)  
at video-dfb.c:402
#2  0x00a46e27 in SubPluginCreator (s=0x5a4d00) at video-dfb.c:1620
#3  0x00580b17 in cSoftDevice::LoadSubPlugin (this=0x8887a90,  
outMethodName=0x59b39d "dfb", pluginPath=0x84e4920 "./PLUGINS/lib/")
     at softdevice.c:355
#4  0x0058112e in cSoftDevice (this=0x8887a90, method=3,  
audioMethod=1, pluginPath=0x84e4920 "./PLUGINS/lib/") at softdevice.c: 
211
#5  0x00581246 in cPluginSoftDevice::Initialize (this=0x84e4900) at  
softdevice.c:1039
#6  0x080cc58c in cPluginManager::InitializePlugins (this=0xbffb0fc4)  
at plugin.c:340
#7  0x080fb9c0 in main (argc=Cannot access memory at address 0x1
) at vdr.c:568


[root at htpc VDR]# dfbinfo
(*) DirectFB/Config: Parsing config file '/etc/directfbrc'.

       =======================  DirectFB 1.0.0-rc1   
=======================
           (c) 2001-2006  United Cultures of Earth - go for outer space!
           (c) 2000-2004  Convergence (integrated media) GmbH
          
----------------------------------------------------------------

(*) DirectFB/Core: Single Application Core. (2006-09-29 12:11) [ DEBUG ]
(*) Direct/Memcpy: Using MMXEXT optimized memcpy()
(*) Direct/Thread: Running 'VT Switcher' (CRITICAL, 17453)...
(*) Direct/Thread: Running 'PS/2 Input' (INPUT, 17454)...
(*) DirectFB/Input: IMPS/2 Mouse 1.0 (Convergence GmbH)
(*) Direct/Thread: Running 'Linux Input' (INPUT, 17455)...
(*) DirectFB/Input: AT Translated Set 2 keyboard (1) 0.1 (convergence  
integrated media GmbH)
(*) Direct/Thread: Running 'Linux Input' (INPUT, 17456)...
(*) DirectFB/Input: Logitech USB Receiver (2) 0.1 (convergence  
integrated media GmbH)
(*) Direct/Thread: Running 'Linux Input' (INPUT, 17457)...
(*) DirectFB/Input: cx88 IR (Hauppauge Nova-T DVB-T (3) 0.1  
(convergence integrated media GmbH)
(*) Direct/Thread: Running 'Keyboard Input' (INPUT, 17458)...
(*) DirectFB/Input: Keyboard 0.9 (convergence integrated media GmbH)
(*) DirectFB/Genefx: MMX detected and enabled
(*) DirectFB/Graphics: Matrox G550 0.7 (directfb.org)
(*) DirectFB/Core/WM: Default 0.2 (Convergence GmbH)


Screen (01) FBDev Primary Screen
    Caps: VSYNC POWER_MANAGEMENT

      Layer (02) FBDev Primary Layer
         Type:    GRAPHICS
         Caps:    SURFACE BRIGHTNESS CONTRAST SATURATION

      Layer (01) Matrox Backend Scaler
         Type:    GRAPHICS VIDEO STILL_PICTURE
         Caps:    SURFACE SCREEN_LOCATION DEINTERLACING DST_COLORKEY  
BRIGHTNESS CONTRAST SCREEN_POSITION SCREEN_SIZE

Screen (00) Matrox CRTC2 Screen             (primary screen)
    Caps: VSYNC ENCODERS OUTPUTS

    Encoder (0)
      Type:           TV
      Caps:           TV_STANDARDS
      TV Standards:   PAL NTSC PAL_60


    Output (0)
      Caps:       CONNECTORS SIGNAL_SEL CONNECTOR_SEL
      Connectors: SCART YC CVBS
      Signals:    YC CVBS RGB


      Layer (00) Matrox CRTC2 Layer              (primary layer)
         Type:    GRAPHICS VIDEO STILL_PICTURE
         Caps:    SURFACE BRIGHTNESS CONTRAST HUE SATURATION  
FIELD_PARITY ALPHA_RAMP

      Layer (03) Matrox CRTC2 Sub-Picture
         Type:    GRAPHICS VIDEO STILL_PICTURE
         Caps:    SURFACE OPACITY ALPHACHANNEL


Input (01) IMPS/2 Mouse                    (primary mouse)
    Type: MOUSE
    Caps: AXES BUTTONS
    Max. Axis: 2
    Max. Button: 2

Input (00) AT Translated Set 2 keyboard    (primary keyboard)
    Type: KEYBOARD
    Caps: KEYS

Input (10) Logitech USB Receiver
    Type: MOUSE
    Caps: AXES BUTTONS
    Max. Axis: 2
    Max. Button: 4

Input (03) cx88 IR (Hauppauge Nova-T DVB-T  (primary remote control)
    Type: REMOTE
    Caps: KEYS

Input (11) Keyboard
    Type: KEYBOARD
    Caps: KEYS



-- 
Torgeir Veimo
torgeir at pobox.com





From torgeir at pobox.com  Fri Sep 29 18:24:17 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Fri, 29 Sep 2006 17:24:17 +0100
Subject: [Softdevice-devel] just recompiled, now fails to run..
In-Reply-To: <73011110-5056-41FA-BE84-7F804A0C8A5A@pobox.com>
References: <9F84AAE5-5E94-428E-96E4-73935C69C9AB@pobox.com>
	<20060929124443.GC2840@localhost.localdomain>
	<73011110-5056-41FA-BE84-7F804A0C8A5A@pobox.com>
Message-ID: <23526619-41EB-476C-BEE4-D59EBB600C11@pobox.com>


On 29 Sep 2006, at 16:37, Torgeir Veimo wrote:

>
> On 29 Sep 2006, at 13:44, Marko M?kel? wrote:
>
>> On Fri, Sep 29, 2006 at 01:19:39PM +0100, Torgeir Veimo wrote:
>>> I just updated and recompiled DirectFB and softdevice to test the
>>> fixes for interlaced output, but now vdr won't start again. I've  
>>> seen
>>> it before but I don't remember how I fixed it. Can anyone give me a
>>> hint?
>>
>> Recompile also vdr, in case you had applied any patches to it or
>> updated
>> the compiler since the last time you compiled vdr and plugins.

Doh! Of course I had forgotten about DFB++...

-- 
Torgeir Veimo
torgeir at pobox.com





From stefan at lucke.in-berlin.de  Fri Sep 29 21:34:39 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 29 Sep 2006 21:34:39 +0200
Subject: [Softdevice-devel] OSD layer not always fully cleared on mgatv
In-Reply-To: <200609282057.27462.stefan@lucke.in-berlin.de>
References: <20060918095530.GD3928@localhost.localdomain>
	<200609280009.52120.stefan@lucke.in-berlin.de>
	<200609282057.27462.stefan@lucke.in-berlin.de>
Message-ID: <200609292134.39322.stefan@lucke.in-berlin.de>

On Donnerstag 28 September 2006 20:57, Stefan Lucke wrote:
> On Donnerstag 28 September 2006 00:09, Stefan Lucke wrote:
> > On Mittwoch 27 September 2006 21:05, Marko M?kel? wrote:
> > > On Mon, Sep 25, 2006 at 11:24:32PM +0200, Stefan Lucke wrote:
> > > > So my tv-out test is still pending, but I've a new version of the patch.
> > > > If it still happens for you sometimes, there is the possibility to enable
> > > > a mutex around Flip() and Blit() calls. To enable this, USE_TEST_MUTEX
> > > > should be defined to 1.
> > > 
> > > Sorry, I haven't gotten around to testing this yet.  Should I revert the
> > > -03 patch and apply this one instead?
> > 
> > Please don't test the -04 patch. It has still the osdMutex in. Have to test
> > this on my system with tv-out first. 
> 
> So her comes -05 version of the patch. I tested this with tv-out.
> My testing was fast scrolling through the channel list.
> I did not see any issues with a missed flip on OSD drawing.
> 
> So I had no need for enabling the dfbFlipMutex.
> 
> The final version will have method ShowOSD() removed.

Final version is in cvs now.
With an extra change, see below.

> 
> If you ask for differences between -03 and -05 ..
> Upon processing events there will be never an internal OSD refresh
> via ShowOSD() .
> 
> > 
> > > By the way, the -03 patch does slow 
> > > down my system too much from time to time, especially when watching programs
> > > containing DVB subtitles, which are mapped to OSD by the subtitles plugin.
> 
> If you've still this issue, I think black bar clearing could be done after
> scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC); 
> to clear borders of the next frame.

Upon OSD activation/deactivation, there is no extra clear of entire
screen. Only non video area will be cleared.

-- 
Stefan Lucke


From marko.makela at hut.fi  Fri Sep 29 22:40:07 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 29 Sep 2006 23:40:07 +0300
Subject: [Softdevice-devel] just recompiled, now fails to run..
In-Reply-To: <23526619-41EB-476C-BEE4-D59EBB600C11@pobox.com>
References: <9F84AAE5-5E94-428E-96E4-73935C69C9AB@pobox.com>
	<20060929124443.GC2840@localhost.localdomain>
	<73011110-5056-41FA-BE84-7F804A0C8A5A@pobox.com>
	<23526619-41EB-476C-BEE4-D59EBB600C11@pobox.com>
Message-ID: <20060929204007.GA2875@localhost.localdomain>

On Fri, Sep 29, 2006 at 05:24:17PM +0100, Torgeir Veimo wrote:
> >> Recompile also vdr, in case you had applied any patches to it or
> >> updated
> >> the compiler since the last time you compiled vdr and plugins.
> 
> Doh! Of course I had forgotten about DFB++...

Once I wasted quite some time, until I finally did "make install" of
DirectFB before compiling DFB++ and "make install" of DFB++ before
compiling softdevice.

	Marko


From M.Wache at gmx.net  Sat Sep 30 17:36:45 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sat, 30 Sep 2006 17:36:45 +0200
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long
 time
In-Reply-To: <200609291024.20726.laz@club-burniston.co.uk>
References: <1159430656.451b8200d5e39@webmail.in-berlin.de>	<451C4149.8040004@gmx.net>
	<200609291024.20726.laz@club-burniston.co.uk>
Message-ID: <451E8F0D.3050700@gmx.net>

Laz schrieb:
> On Thursday 28 September 2006 22:40, Martin Wache wrote:
>> Stefan Lucke schrieb:
>>> Just another me too. If I remember my situation correct, I've
>>> had 2 or 3 times the same with xv-out: paused video, window blanked.
>>> After continuing playback, there was a short time with audio and
>>> nothing else. Had to CONTROL-C (killall -9) from command window.
>>>
>>> There are some essential operations in audio-alsa.c , which are
>>> not protected by handleMutex: Suspend(), Resume() and calling
>>> snd_pcm_mmap_writei() after while (paused) usleep(1000); .
>> That is true, those calls are unprotected.
>>
>> However, the audio-out is during normal operation only called from one
>> thread, namely the audio-decoder. Only if the user request a suspend,
>> the mpegdecoder thread suspends the audio-out. But that wasn't the
>> case, so that audio-out was only called by one thread, and that means
>> locks should not be needed.
> 
> Hmmmm...I don't think I get this problem if I suspend decoding, if that's 
> what you mean here by 'suspend'. Having said that, I don't think I've 
> tried suspending the decoding for a long while... I see the effect when I 
> pause playback.
>
I usually suspend the decoding on my vdr when I go away, so I'm pretty
sure that this works ;-)
This is probably the reason why I never noticed this... Now I've tried
to pause my vdr for a long time and indeed it looked up :-(

I have now an idea what could be the reason for the deadlock. It could
be that the counters for synchronizing the video are overflowing, the
result would be a _very_ long delay until the next frame is actually
displayed. That would match quite well with Marco's backtrace...

And here is a patch which hopefully fixes the problem (I'm trying
currently it out, which obviously takes some time... but I wanted to
shared it with you in case someone else wants to join the testing)

Bye,
Martin
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: deadlock.patch
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060930/e7dafb76/attachment.ksh>

From laz at club-burniston.co.uk  Sat Sep 30 18:32:06 2006
From: laz at club-burniston.co.uk (Laz)
Date: Sat, 30 Sep 2006 17:32:06 +0100
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long
	time
In-Reply-To: <451E8F0D.3050700@gmx.net>
References: <1159430656.451b8200d5e39@webmail.in-berlin.de>
	<200609291024.20726.laz@club-burniston.co.uk>
	<451E8F0D.3050700@gmx.net>
Message-ID: <200609301732.07696.laz@club-burniston.co.uk>

On Saturday 30 September 2006 16:36, Martin Wache wrote:
> Laz schrieb:
> > Hmmmm...I don't think I get this problem if I suspend decoding, if that's
> > what you mean here by 'suspend'. Having said that, I don't think I've
> > tried suspending the decoding for a long while... I see the effect when I
> > pause playback.
>
> I usually suspend the decoding on my vdr when I go away, so I'm pretty
> sure that this works ;-)

I usually let mine turn itself on and off with nvram-wakeup! I see the problem 
when I leave it for a short while in the middle of something and get 
distracted!

:)

> This is probably the reason why I never noticed this... Now I've tried
> to pause my vdr for a long time and indeed it looked up :-(
>
> I have now an idea what could be the reason for the deadlock. It could
> be that the counters for synchronizing the video are overflowing, the
> result would be a _very_ long delay until the next frame is actually
> displayed. That would match quite well with Marco's backtrace...

Ooooo...that sounds feasible. I must admit, that I've never sat there for ages 
to see if it wakes up again.

> And here is a patch which hopefully fixes the problem (I'm trying
> currently it out, which obviously takes some time... but I wanted to
> shared it with you in case someone else wants to join the testing)

Applied. Not sure I'll be able to recreate the situation off-hand, though.

Hmmm...if you're right about this, how long should it take to overflow? The 
only counter I can see is a 64-bit integer which looks like it's counting in 
useconds which would take a few million years to overflow, by my reckoning! 
Maybe I'm looking in the wrong place and it's a 32-bit counter which would 
take 1 h 12 min to overflow. Not sure it was taking that long but it's hard 
to tell.

I will try to make it happen without the patch and then try with the patched 
version.

Cheers,

Laz

Cheers,

Laz


From marko.makela at hut.fi  Sat Sep 30 19:27:51 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sat, 30 Sep 2006 20:27:51 +0300
Subject: [Softdevice-devel] OSD layer not always fully cleared on mgatv
In-Reply-To: <200609292134.39322.stefan@lucke.in-berlin.de>
References: <20060918095530.GD3928@localhost.localdomain>
	<200609280009.52120.stefan@lucke.in-berlin.de>
	<200609282057.27462.stefan@lucke.in-berlin.de>
	<200609292134.39322.stefan@lucke.in-berlin.de>
Message-ID: <20060930172751.GA2818@localhost.localdomain>

On Fri, Sep 29, 2006 at 09:34:39PM +0200, Stefan Lucke wrote:
> Final version is in cvs now.

Thanks, it works for me.

> Upon OSD activation/deactivation, there is no extra clear of entire
> screen. Only non video area will be cleared.

Makes sense.

	Marko


From marko.makela at hut.fi  Sat Sep 30 20:04:25 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sat, 30 Sep 2006 21:04:25 +0300
Subject: [Softdevice-devel] Hang after suspending MPEG stream for a long
	time
In-Reply-To: <200609301732.07696.laz@club-burniston.co.uk>
	<451E8F0D.3050700@gmx.net>
References: <1159430656.451b8200d5e39@webmail.in-berlin.de>
	<200609291024.20726.laz@club-burniston.co.uk>
	<451E8F0D.3050700@gmx.net>
	<200609301732.07696.laz@club-burniston.co.uk>
	<1159430656.451b8200d5e39@webmail.in-berlin.de>
	<451C4149.8040004@gmx.net>
	<200609291024.20726.laz@club-burniston.co.uk>
	<451E8F0D.3050700@gmx.net>
Message-ID: <20060930180425.GB2818@localhost.localdomain>

On Sat, Sep 30, 2006 at 05:36:45PM +0200, Martin Wache wrote:
> And here is a patch which hopefully fixes the problem (I'm trying
> currently it out, which obviously takes some time... but I wanted to
> shared it with you in case someone else wants to join the testing)

Your patch might fix the "long pause" problem but not the hang that
I am experiencing.  My vdr-suspend patch simply stops the delivery
of MPEG packets to other than recorder threads.  Would it be possible
to reset and stop the timers in cMpeg2Decoder::Clear() as well?

As far as I know, several vdr packagers apply the vdr-suspend patch,
but the feature is disabled in the default configuration.  I am
afraid that several people could be affected by this.  Maybe the hang
only occurs in conjunction with the vdr-subtitles plugin when there
are DVB subtitles being displayed at resume time.

On the other hand, I may need to rework the vdr-suspend patch anyway.
In its current form, it does not work on full-featured cards, nor
does it blank the screen.  (It used to blank the screen on softdevice,
relying on its built-in blank timer.)

On Sat, Sep 30, 2006 at 05:32:06PM +0100, Laz wrote:
> I usually let mine turn itself on and off with nvram-wakeup! I see
> the problem when I leave it for a short while in the middle of something
> and get distracted!

Me too.  Sometimes, I hit the Power button followed by some other button
to suspend the playback and to prevent the system from powering off.
Then, I'd hit the Power button to resume.

> Hmmm...if you're right about this, how long should it take to overflow? The 
> only counter I can see is a 64-bit integer which looks like it's counting in 
> useconds which would take a few million years to overflow, by my reckoning! 
> Maybe I'm looking in the wrong place and it's a 32-bit counter which would 
> take 1 h 12 min to overflow. Not sure it was taking that long but it's hard 
> to tell.

I would have believed that one hang occurred after a 40-minute suspension.
Could it perhaps be a signed counter, counting 1<<31 microseconds before
overflow?

	Marko


From omge2ri02 at sneakemail.com  Sat Sep 30 22:44:55 2006
From: omge2ri02 at sneakemail.com (CR)
Date: Sat, 30 Sep 2006 13:44:55 -0700 (MST)
Subject: [Softdevice-devel] ShmClient and cropping
In-Reply-To: <mailman.21.1159610418.3483.softdevice-devel@lists.berlios.de>
References: <mailman.21.1159610418.3483.softdevice-devel@lists.berlios.de>
Message-ID: <14472-39254@sneakemail.com>

Hi,

I recently learned about the softdevice ShmClient option.  This is perfect
for me since I want vdr running in the background to record shows and if I
want to watch TV, I can launch the client.

1. The ShmClient does not seem to honor the cropping setting. Perhaps this
is part of it not being able to access the "SetupStore"?  I'd like to crop
the first line from the top, usually I see a bunch of flickering there.

Can I compile in an option in the ShmClient to get it to remove the top
line?  Any otherways to accomplish this?

2. When using ShmClient, the image on the screen is shifted down and to
the right by 20-30 pixels (it looks like).  When using softdevice -vo xv,
the image looks correct (without any strange offsets).

If I set the post processing quality (with post processing off) to medium,
and/or turn on mirroring, the image pops back to the place where I would
expect it (same place as running -vo xv).  Anyway to get the ShmClient's
output to match the standard -xv output?

If ShmClient cannot be fixed or made to do any of this, is there a way to
suspend the -vo xv output, and then resume it later?

Thanks,
CR.






