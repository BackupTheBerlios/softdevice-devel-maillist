From stefan at lucke.in-berlin.de  Fri Jul  1 00:09:14 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 1 Jul 2005 00:09:14 +0200
Subject: [Softdevice-devel] Jerky picture when i replay recordings.
In-Reply-To: <42C467E6.1010806@kapsi.fi>
References: <42C2D849.7040808@kapsi.fi> <200506302142.54143.stefan@lucke.in-berlin.de> <42C467E6.1010806@kapsi.fi>
Message-ID: <200507010009.14554.stefan@lucke.in-berlin.de>

On Donnerstag, 30. Juni 2005 23:45, Tommi Lundell wrote:
> Stefan Lucke wrote:
> 
> >I think it's the same we talked about some days (week) ago.
> >I changed clamping low limit and added a fprintf in case we drop frames.
> >
> >Tommi can you try this change ?
> >
> >Stefan Lucke
> >
> >_______________________________________________
> >Softdevice-devel mailing list
> >Softdevice-devel at lists.berlios.de
> >http://lists.berlios.de/mailman/listinfo/softdevice-devel
> >
> >  
> >
> I made test whit current CVS (taken from CVS 30 mins ago) and result is 
> same i don t see any different behavior that before.

Hm, there is now an other change in cvs for directfb, but ..

> And in syslog i don t see anything unfamiliar (no errors or warnings or 
> anything about frame dropping)

The rising buffer fill rate is the same I saw a while ago.
My buffer setting is HDTV in OSD. Could you try to change your buffer
settings before cvs update ?

Stefan Lucke



From M.Wache at gmx.net  Fri Jul  1 14:45:39 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Fri, 01 Jul 2005 14:45:39 +0200
Subject: [Softdevice-devel] Jerky picture when i replay recordings.
In-Reply-To: <42C467E6.1010806@kapsi.fi>
References: <42C2D849.7040808@kapsi.fi> <42C41AC9.1080203@gmx.net> <200506302142.54143.stefan@lucke.in-berlin.de> <42C467E6.1010806@kapsi.fi>
Message-ID: <42C53AF3.7040603@gmx.net>

Tommi Lundell schrieb:

> I try to look logs someday when i have time but if someone want to look
> log what i made (uncommenting #define BUFDEB(out...)
> {printf("BUF[%04d]:",(int)(getTimeMilis() % 10000));printf(out);} line
> from mpeg2decoder.c) then you can download it from:
> http://prelude.kapsi.fi/jerky.tar.gz (about 500kB)

That log is really interessting... From what I saw in the logs I think
the following happens:

The softdevice buffers are not really full, frames can still be
accepted. So the softdevice doesn't sleep in Poll() (just like I
understood the interface up to know...)
On the other hand vdr doesn't have any frames to deliver to the
softdevice, so it does nothing in the dvbplayer loop except for doing
Poll() calls to the softdevice.
The result is a busy loop!!!!

I'm not yet sure how to cure that correctly. From how I understand
Poll(), the softdevice should only sleep if a write to the softdevice
would block because of full buffers, however the description in device.h
is not completly clear.

Please try the attached patch which causes the softdevice to sleep in
Poll() already if the buffers a 50% full (if you want you can even try
smaller values). If this fixes problems during playback we can think
about what the correct solution would be.

Martin
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: jerky_replay.patch
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050701/665a0463/attachment.ksh>

From patrick.boettcher at desy.de  Fri Jul  1 15:09:44 2005
From: patrick.boettcher at desy.de (Patrick Boettcher)
Date: Fri, 1 Jul 2005 15:09:44 +0200 (CEST)
Subject: [Softdevice-devel] Jerky picture when i replay recordings.
In-Reply-To: <42C53AF3.7040603@gmx.net>
References: <42C2D849.7040808@kapsi.fi> <42C41AC9.1080203@gmx.net>
 <200506302142.54143.stefan@lucke.in-berlin.de> <42C467E6.1010806@kapsi.fi>
 <42C53AF3.7040603@gmx.net>
Message-ID: <Pine.LNX.4.61.0507011503380.6190@pub6.ifh.de>

Hi Martin,

On Fri, 1 Jul 2005, Martin Wache wrote:

> Tommi Lundell schrieb:
>
>> I try to look logs someday when i have time but if someone want to look
>> log what i made (uncommenting #define BUFDEB(out...)
>> {printf("BUF[%04d]:",(int)(getTimeMilis() % 10000));printf(out);} line
>> from mpeg2decoder.c) then you can download it from:
>> http://prelude.kapsi.fi/jerky.tar.gz (about 500kB)
>
> That log is really interessting... From what I saw in the logs I think
> the following happens:
>
> The softdevice buffers are not really full, frames can still be
> accepted. So the softdevice doesn't sleep in Poll() (just like I
> understood the interface up to know...)
> On the other hand vdr doesn't have any frames to deliver to the
> softdevice, so it does nothing in the dvbplayer loop except for doing
> Poll() calls to the softdevice.
> The result is a busy loop!!!!
>
> I'm not yet sure how to cure that correctly. From how I understand
> Poll(), the softdevice should only sleep if a write to the softdevice
> would block because of full buffers, however the description in device.h
> is not completly clear.
>
> Please try the attached patch which causes the softdevice to sleep in
> Poll() already if the buffers a 50% full (if you want you can even try
> smaller values). If this fixes problems during playback we can think
> about what the correct solution would be.

I tried your patch and it seems to cure the problem partially. Jerking 
picture is almost gone (when playing recordings) but sometimes the sound 
stutters.

Lowering it to 40% reduces stuttering a little again.

Anything else I can do to debug?

Patrick.

--
   Mail: patrick.boettcher at desy.de
   WWW:  http://www.wi-bw.tfh-wildau.de/~pboettch/


From M.Wache at gmx.net  Fri Jul  1 15:24:48 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Fri, 01 Jul 2005 15:24:48 +0200
Subject: [Softdevice-devel] Jerky picture when i replay recordings.
In-Reply-To: <Pine.LNX.4.61.0507011503380.6190@pub6.ifh.de>
References: <42C2D849.7040808@kapsi.fi> <42C41AC9.1080203@gmx.net> <200506302142.54143.stefan@lucke.in-berlin.de> <42C467E6.1010806@kapsi.fi> <42C53AF3.7040603@gmx.net> <Pine.LNX.4.61.0507011503380.6190@pub6.ifh.de>
Message-ID: <42C54420.5010101@gmx.net>

Patrick Boettcher schrieb:

>> I'm not yet sure how to cure that correctly. From how I understand
>> Poll(), the softdevice should only sleep if a write to the softdevice
>> would block because of full buffers, however the description in device.h
>> is not completly clear.
>>
>> Please try the attached patch which causes the softdevice to sleep in
>> Poll() already if the buffers a 50% full (if you want you can even try
>> smaller values). If this fixes problems during playback we can think
>> about what the correct solution would be.
> 
> 
> I tried your patch and it seems to cure the problem partially. Jerking
> picture is almost gone (when playing recordings) but sometimes the sound
> stutters.
I guess that's because the buffers are now not full enough.... As I
already said, I don't think that this is patch is the correct solution...
> 
> Lowering it to 40% reduces stuttering a little again.
> 
> Anything else I can do to debug?
You can play with different values, also some larger ones, or change the
buffer sizes from the OSD.

Alternativly you can try the untested attached patch for vdr-1.3.27 (if
it doesn't compile, maybe you can fix it, I guess the idea is clear...).
It will cause vdr to sleep when it doesn't have any new frame for the
softdevice. That will hopefully break the busy loop, but please undo the
previous patch for the softdevice when trying this.

Martin
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: vdr-jerky-replay.patch
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050701/f5c07f10/attachment.ksh>

From patrick.boettcher at desy.de  Fri Jul  1 16:00:19 2005
From: patrick.boettcher at desy.de (Patrick Boettcher)
Date: Fri, 1 Jul 2005 16:00:19 +0200 (CEST)
Subject: [Softdevice-devel] Jerky picture when i replay recordings.
In-Reply-To: <42C54420.5010101@gmx.net>
References: <42C2D849.7040808@kapsi.fi> <42C41AC9.1080203@gmx.net>
 <200506302142.54143.stefan@lucke.in-berlin.de> <42C467E6.1010806@kapsi.fi>
 <42C53AF3.7040603@gmx.net> <Pine.LNX.4.61.0507011503380.6190@pub6.ifh.de>
 <42C54420.5010101@gmx.net>
Message-ID: <Pine.LNX.4.61.0507011557330.6190@pub6.ifh.de>

Hi,

On Fri, 1 Jul 2005, Martin Wache wrote:
> Alternativly you can try the untested attached patch for vdr-1.3.27 (if
> it doesn't compile, maybe you can fix it, I guess the idea is clear...).
> It will cause vdr to sleep when it doesn't have any new frame for the
> softdevice. That will hopefully break the busy loop, but please undo the
> previous patch for the softdevice when trying this.

I changed it back to > 90 and applied your patch to VDR. And now it seems 
to work.

Still some av-asynchronous (livetv and recordings), but by setting it to 2 
for correction it is OK again.

Thanks for the work. Now please convince Klaus to merge it to mainstream 
vdr.

Patrick.

--
   Mail: patrick.boettcher at desy.de
   WWW:  http://www.wi-bw.tfh-wildau.de/~pboettch/


From M.Wache at gmx.net  Fri Jul  1 16:20:56 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Fri, 01 Jul 2005 16:20:56 +0200
Subject: [Softdevice-devel] Jerky picture when i replay recordings.
In-Reply-To: <Pine.LNX.4.61.0507011557330.6190@pub6.ifh.de>
References: <42C2D849.7040808@kapsi.fi> <42C41AC9.1080203@gmx.net> <200506302142.54143.stefan@lucke.in-berlin.de> <42C467E6.1010806@kapsi.fi> <42C53AF3.7040603@gmx.net> <Pine.LNX.4.61.0507011503380.6190@pub6.ifh.de> <42C54420.5010101@gmx.net> <Pine.LNX.4.61.0507011557330.6190@pub6.ifh.de>
Message-ID: <42C55148.4070306@gmx.net>

Patrick Boettcher schrieb:

> I changed it back to > 90 and applied your patch to VDR. And now it
> seems to work.
> 
> Still some av-asynchronous (livetv and recordings), but by setting it to
> 2 for correction it is OK again.
> 
> Thanks for the work. Now please convince Klaus to merge it to mainstream
> vdr.

Sure, I will try to convice Klaus as soon as there are some more success
reports.

Thanks for your testing!

Martin


From nhuillard at e-dition.fr  Fri Jul  1 17:33:50 2005
From: nhuillard at e-dition.fr (Nicolas Huillard)
Date: Fri, 01 Jul 2005 17:33:50 +0200
Subject: [Softdevice-devel] Jerky picture when i replay recordings.
In-Reply-To: <42C55148.4070306@gmx.net>
References: <42C2D849.7040808@kapsi.fi> <42C41AC9.1080203@gmx.net> <200506302142.54143.stefan@lucke.in-berlin.de> <42C467E6.1010806@kapsi.fi> <42C53AF3.7040603@gmx.net> <Pine.LNX.4.61.0507011503380.6190@pub6.ifh.de> <42C54420.5010101@gmx.net> <Pine.LNX.4.61.0507011557330.6190@pub6.ifh.de> <42C55148.4070306@gmx.net>
Message-ID: <42C5625E.10503@e-dition.fr>

Martin Wache a ?crit :
> Patrick Boettcher schrieb:
> 
>>I changed it back to > 90 and applied your patch to VDR. And now it
>>seems to work.
>>
>>Still some av-asynchronous (livetv and recordings), but by setting it to
>>2 for correction it is OK again.
>>
>>Thanks for the work. Now please convince Klaus to merge it to mainstream
>>vdr.
> 
> Sure, I will try to convice Klaus as soon as there are some more success
> reports.

All this is apparently triggered by 1.3.27. Is that right ?
I'll upgrade my system steps by steps, starting from the kernel (and
Skystar patches) and the way up... Testing every step long enough.

> Thanks for your testing!
> 
> Martin

-- 
NH


From M.Wache at gmx.net  Fri Jul  1 18:25:26 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Fri, 01 Jul 2005 18:25:26 +0200
Subject: [Softdevice-devel] Jerky picture when i replay recordings.
In-Reply-To: <42C5625E.10503@e-dition.fr>
References: <42C2D849.7040808@kapsi.fi> <42C41AC9.1080203@gmx.net> <200506302142.54143.stefan@lucke.in-berlin.de> <42C467E6.1010806@kapsi.fi> <42C53AF3.7040603@gmx.net> <Pine.LNX.4.61.0507011503380.6190@pub6.ifh.de> <42C54420.5010101@gmx.net> <Pine.LNX.4.61.0507011557330.6190@pub6.ifh.de> <42C55148.4070306@gmx.net> <42C5625E.10503@e-dition.fr>
Message-ID: <42C56E76.1080406@gmx.net>

Nicolas Huillard schrieb:

>>Sure, I will try to convice Klaus as soon as there are some more success
>>reports.
> 
> 
> All this is apparently triggered by 1.3.27. Is that right ?
No, Torgeir reported it already a long time ago and the relevant parts
in vdr and the softdevice didn't change for a long time.
I think to see these problems you need a very fast CPU, and some other
still unknown factors...

> I'll upgrade my system steps by steps, starting from the kernel (and
> Skystar patches) and the way up... Testing every step long enough.
> 
When I said I wanted to wait for more success reports I meant by the
people who've seen these problems before (Torgeir, Ari or Tommi).
I've used the same versions of vdr and softdevice on my machine and
never had any problems, so it's not sure wether you will see the
problems just by upgrading your system. But thanks for offer :-)

Bye,
Martin


From prelude at kapsi.fi  Fri Jul  1 18:41:17 2005
From: prelude at kapsi.fi (Tommi Lundell)
Date: Fri, 01 Jul 2005 19:41:17 +0300
Subject: [Softdevice-devel] Jerky picture when i replay recordings.
In-Reply-To: <42C54420.5010101@gmx.net>
References: <42C2D849.7040808@kapsi.fi> <42C41AC9.1080203@gmx.net> <200506302142.54143.stefan@lucke.in-berlin.de> <42C467E6.1010806@kapsi.fi> <42C53AF3.7040603@gmx.net> <Pine.LNX.4.61.0507011503380.6190@pub6.ifh.de> <42C54420.5010101@gmx.net>
Message-ID: <42C5722D.3030702@kapsi.fi>

Martin Wache wrote:

>Alternativly you can try the untested attached patch for vdr-1.3.27 (if
>it doesn't compile, maybe you can fix it, I guess the idea is clear...).
>It will cause vdr to sleep when it doesn't have any new frame for the
>softdevice. That will hopefully break the busy loop, but please undo the
>previous patch for the softdevice when trying this.
>
>Martin
>  
>
>------------------------------------------------------------------------
>
>--- dvbplayer.c.orig	Fri Jul  1 15:14:49 2005
>+++ dvbplayer.c	Fri Jul  1 15:16:50 2005
>@@ -497,6 +497,7 @@
>                  p = NULL;
>                  }
>               }
>+              else Sleep=true;
>            }
>         }
>   active = running = false;
>  
>

Hello

I tested that also and it's seems to work ok (about 5min testing before 
my wife 'ask' permission to look her food program)
I made same logs what i made last night:
http://prelude.kapsi.fi/jerky2.tar.gz
(I don t understand that but maybe Martin or Stefan see is all ok now or 
not)

Anyway..Great job again guys :-)

Ps. In osd menu you can select aspect ration and when you select 4:3 tv 
and looking 16:9 material softdevice work right and add those black 
areas top and below picture. But can we get some setup where aspect 
ratio is ignored and sofdevice send whole picture whit out scaling to 
screen? (So all are really  thin and tall when you look 16:9 material in 
4:3 screen). I as that because i rather press aspect ratio button single 
from my remote that looking scaled image (it's looking like interlace 
problem but it is really scaling (scretchblit) problem).

Tommi



From stefan at lucke.in-berlin.de  Fri Jul  1 20:54:30 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 1 Jul 2005 20:54:30 +0200
Subject: [Softdevice-devel] Jerky picture when i replay recordings.
In-Reply-To: <42C55148.4070306@gmx.net>
References: <42C2D849.7040808@kapsi.fi> <Pine.LNX.4.61.0507011557330.6190@pub6.ifh.de> <42C55148.4070306@gmx.net>
Message-ID: <200507012054.30427.stefan@lucke.in-berlin.de>

On Freitag, 1. Juli 2005 16:20, Martin Wache wrote:
> Patrick Boettcher schrieb:
> 
> > I changed it back to > 90 and applied your patch to VDR. And now it
> > seems to work.
> > 
> > Still some av-asynchronous (livetv and recordings), but by setting it to
> > 2 for correction it is OK again.
> > 
> > Thanks for the work. Now please convince Klaus to merge it to mainstream
> > vdr.
> 
> Sure, I will try to convice Klaus as soon as there are some more success
> reports.

Martin, your patch will reduce vdr's cpu usage I think, but it still does
not explain why in Tommi's log our buffer usage went up. If our
buffer usage is so high, so I think it is our problem that we don't
use it (and decode something).

Your vdr patch affects a part of vdr, that's the same in vdr-1.3.22,
and that version worked well with softdevice until May 29.

I'm still focused on the packet queue handling, which I don't
understand in all details:

int cPacketQueue::PutPacket(const AVPacket &Packet) {
/* --- !!! ---
Here we wait until the queue is filled up to 66% until
a waiting read-process gets a "wakeup".
*/
  if (Available()>MaxPackets*2/3) {
      BUFDEB("PacketQueue.EnableGet.Signal\n");
      EnableGet.Signal();
  };

  if (FirstPacket == Next(LastPacket) ) {
        BUFDEB("PacketQueue.EnablePut.Sleep start\n");
        EnablePut.Sleep(50000);
        BUFDEB("PacketQueue.EnablePut.Sleep stop\n");
  };

  if (FirstPacket != Next(LastPacket) ) {
    queue[LastPacket]=Packet;
    LastPacket=Next(LastPacket);
//    printf("PutPacket %x FirstPacket %d LastPacket %d\n",
//      queue,FirstPacket,LastPacket);
    return 0;
  } else return -1;
};

AVPacket * cPacketQueue::GetReadPacket() {
//  printf("GetReadPacket %x FirstPacket %d LastPacket %d\n",
//    queue,FirstPacket,LastPacket);

/* --- !!! ---
Here we wait until the queue is empty in order to wake up the
sleeping write-process. That process has a timeout of 50ms,
which is more than a complete pal frame duration.
*/
  if (Available()==0)  {
      BUFDEB("PacketQueue.EnablePut.Signal pid: %d\n",getpid());
      EnablePut.Signal();
  };

  if (FirstPacket==LastPacket) {
       BUFDEB("PacketQueue.EnableGet.Sleep start pid: %d\n",getpid());
       EnableGet.Sleep(10000);
       BUFDEB("PacketQueue.EnableGet.Sleep stop pid: %d \n",getpid());
  };

  if ( FirstPacket != LastPacket )
    return &queue[FirstPacket];

  return NULL;
};


-- 
Stefan Lucke



From stefan at lucke.in-berlin.de  Fri Jul  1 21:26:35 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 1 Jul 2005 21:26:35 +0200
Subject: [Softdevice-devel] compile problem:parse error before string constant
In-Reply-To: <200506302134.39419.stefan@lucke.in-berlin.de>
References: <200506302134.39419.stefan@lucke.in-berlin.de>
Message-ID: <200507012126.35371.stefan@lucke.in-berlin.de>

On Donnerstag, 30. Juni 2005 21:34, Stefan Lucke wrote:
> Hi,
> 
> got some compile problem on my prod vdr box with current cvs:
> 
> utils.c: In function `void * fast_memcpy(void *, const void *, unsigned int)':
> utils.c:469: parse error before string constant
> utils.c:514: confused by earlier errors, bailing out
> 
> Thats is with gcc: 2.95.3
> 

Strange, it compiles with the following change:
-- cut --
Index: utils.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.c,v
retrieving revision 1.5
diff -U5 -r1.5 utils.c
--- utils.c     26 Jun 2005 20:12:40 -0000      1.5
+++ utils.c     1 Jul 2005 19:23:42 -0000
@@ -464,11 +464,11 @@
                        "sub %4, %2             \n\t"
                        "cmp %4, %2             \n\t"
                        " jae 1b                \n\t"
                                : "+r" (from), "+r" (to), "+r" (i)
                                : "r" ((long)BLOCK_SIZE), "i" (BLOCK_SIZE/64), "i" ((long)CONFUSION_FACTOR)
-                               : "%"REG_a, "%ebx"
+                               : "%eax" , "%ebx"
                );

        for(; i>0; i--)
        {
                __asm__ __volatile__ (
-- cut --

But REG_a is defined as:
#define REG_a "eax"

-- 
Stefan Lucke



From M.Wache at gmx.net  Fri Jul  1 21:50:19 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Fri, 01 Jul 2005 21:50:19 +0200
Subject: [Softdevice-devel] Jerky picture when i replay recordings.
In-Reply-To: <200507012054.30427.stefan@lucke.in-berlin.de>
References: <42C2D849.7040808@kapsi.fi> <Pine.LNX.4.61.0507011557330.6190@pub6.ifh.de> <42C55148.4070306@gmx.net> <200507012054.30427.stefan@lucke.in-berlin.de>
Message-ID: <42C59E7B.9040109@gmx.net>

Stefan Lucke schrieb:
> Martin, your patch will reduce vdr's cpu usage I think, but it still does
> not explain why in Tommi's log our buffer usage went up. If our
> buffer usage is so high, so I think it is our problem that we don't
> use it (and decode something).
Well, usually a disk can read video data faster than it shown to the
user. So I would expect that the buffers are almost full all the time
(when playing a recording) since we show the movie at the nominal speed,
and therefore decode at the same speed.
Live-TV is different, there the data comes in at the same rate as it is
consumed.

> 
> Your vdr patch affects a part of vdr, that's the same in vdr-1.3.22,
> and that version worked well with softdevice until May 29.
I'm not sure since I never had this problem, but Torgeir told me in an
e-mail on May 17 that the problem was there even before.

> 
> I'm still focused on the packet queue handling, which I don't
> understand in all details:
> 
> int cPacketQueue::PutPacket(const AVPacket &Packet) {
> /* --- !!! ---
> Here we wait until the queue is filled up to 66% until
> a waiting read-process gets a "wakeup".
> */
>   if (Available()>MaxPackets*2/3) {
>       BUFDEB("PacketQueue.EnableGet.Signal\n");
>       EnableGet.Signal();
>   };
> 
>   if (FirstPacket == Next(LastPacket) ) {
>         BUFDEB("PacketQueue.EnablePut.Sleep start\n");
>         EnablePut.Sleep(50000);
>         BUFDEB("PacketQueue.EnablePut.Sleep stop\n");
>   };
> 
>   if (FirstPacket != Next(LastPacket) ) {
>     queue[LastPacket]=Packet;
>     LastPacket=Next(LastPacket);
> //    printf("PutPacket %x FirstPacket %d LastPacket %d\n",
> //      queue,FirstPacket,LastPacket);
>     return 0;
>   } else return -1;
> };
> 
> AVPacket * cPacketQueue::GetReadPacket() {
> //  printf("GetReadPacket %x FirstPacket %d LastPacket %d\n",
> //    queue,FirstPacket,LastPacket);
> 
> /* --- !!! ---
> Here we wait until the queue is empty in order to wake up the
> sleeping write-process. That process has a timeout of 50ms,
> which is more than a complete pal frame duration.
> */
Yes, you are right the timeout is 50ms which is more than a complete
frame duration, but this timeout is never meant to exceed. The write
process will get a signal each time the buffers a empty and the reading
process wakes up (which will be every 10ms). But also the reading thread
should not exceed the timeout, in the best case everything should work
signal triggered.
By the way most of these values are picked by some sort of educated
guess, so if have better values and some explanation why they are better
we can change them.

Martin


From M.Wache at gmx.net  Sun Jul  3 12:33:56 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 03 Jul 2005 12:33:56 +0200
Subject: [Softdevice-devel] compile problem:parse error before string
 constant
In-Reply-To: <200507012126.35371.stefan@lucke.in-berlin.de>
References: <200506302134.39419.stefan@lucke.in-berlin.de> <200507012126.35371.stefan@lucke.in-berlin.de>
Message-ID: <42C7BF14.1050602@gmx.net>

Stefan Lucke schrieb:
> On Donnerstag, 30. Juni 2005 21:34, Stefan Lucke wrote:
> 
>>Hi,
>>
>>got some compile problem on my prod vdr box with current cvs:
>>
>>utils.c: In function `void * fast_memcpy(void *, const void *, unsigned int)':
>>utils.c:469: parse error before string constant
>>utils.c:514: confused by earlier errors, bailing out
>>
>>Thats is with gcc: 2.95.3
>>
> 
> 
> Strange, it compiles with the following change:
> -- cut --
> Index: utils.c
> ===================================================================
> RCS file: /cvsroot/softdevice/softdevice/utils.c,v
> retrieving revision 1.5
> diff -U5 -r1.5 utils.c
> --- utils.c     26 Jun 2005 20:12:40 -0000      1.5
> +++ utils.c     1 Jul 2005 19:23:42 -0000
> @@ -464,11 +464,11 @@
>                         "sub %4, %2             \n\t"
>                         "cmp %4, %2             \n\t"
>                         " jae 1b                \n\t"
>                                 : "+r" (from), "+r" (to), "+r" (i)
>                                 : "r" ((long)BLOCK_SIZE), "i" (BLOCK_SIZE/64), "i" ((long)CONFUSION_FACTOR)
> -                               : "%"REG_a, "%ebx"
> +                               : "%eax" , "%ebx"
>                 );
> 
>         for(; i>0; i--)
>         {
>                 __asm__ __volatile__ (
> -- cut --
> 
> But REG_a is defined as:
> #define REG_a "eax"
> 

Hi Stefan,

I'm sorry but I can't debug this since my distribution doesn't has gcc
2.95.3 anymore :-(. So I would be happy if you could try to fix this.
The define REG_a is necessary for 64 bit systems, there REG_a has to be
defined as "rax".

Thank you,
Martin


From stefan at lucke.in-berlin.de  Sun Jul  3 17:33:48 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 3 Jul 2005 17:33:48 +0200
Subject: [Softdevice-devel] compile problem:parse error before string constant
In-Reply-To: <42C7BF14.1050602@gmx.net>
References: <200506302134.39419.stefan@lucke.in-berlin.de> <200507012126.35371.stefan@lucke.in-berlin.de> <42C7BF14.1050602@gmx.net>
Message-ID: <200507031733.48422.stefan@lucke.in-berlin.de>

On Sonntag, 3. Juli 2005 12:33, Martin Wache wrote:
> Stefan Lucke schrieb:
> > On Donnerstag, 30. Juni 2005 21:34, Stefan Lucke wrote:
> > 
> >>Hi,
> >>
> >>got some compile problem on my prod vdr box with current cvs:
> >>
> >>utils.c: In function `void * fast_memcpy(void *, const void *, unsigned int)':
> >>utils.c:469: parse error before string constant
> >>utils.c:514: confused by earlier errors, bailing out
> >>
> >>Thats is with gcc: 2.95.3
> >>
> > 

> >                                 : "r" ((long)BLOCK_SIZE), "i" (BLOCK_SIZE/64), "i" ((long)CONFUSION_FACTOR)
> > -                               : "%"REG_a, "%ebx"
> > +                               : "%eax" , "%ebx"
> >                 );

> > 
> > But REG_a is defined as:
> > #define REG_a "eax"
> > 
> 
> Hi Stefan,
> 
> I'm sorry but I can't debug this since my distribution doesn't has gcc
> 2.95.3 anymore :-(. So I would be happy if you could try to fix this.
> The define REG_a is necessary for 64 bit systems, there REG_a has to be
> defined as "rax".

At the moment I can live with that, as I know how to circumvent that.
I think it's a compiler error with my old gcc. Previous use of REG_a is ok
but this one fails. When I use: "%""eax" which is REG_a direct substituted,
it will fail with the same error.

-- 
Stefan Lucke



From marko.makela at hut.fi  Tue Jul  5 23:26:13 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 6 Jul 2005 00:26:13 +0300
Subject: [Softdevice-devel] Jerky picture when i replay recordings.
In-Reply-To: <42C41AC9.1080203@gmx.net>
References: <42C2D849.7040808@kapsi.fi> <42C41AC9.1080203@gmx.net>
Message-ID: <20050705212613.GB3302@localhost.localdomain>

On Thu, Jun 30, 2005 at 06:16:09PM +0200, Martin Wache wrote:
> It would be really nice to find the reason for these troubles,
> unfortunatly on my box I don't see them, so for me it is impossible to
> find out more....

Don't you even see increased CPU usage when playing back recordings?
Luckily, I don't have jerky playback (unless using Matrox tv-out, which
consumes way more CPU than VGA for some reason).  I made two simple
profiling runs on NPTL and vdr 1.3.27, subtitles 0.3.7 and current
softdevice with the following settings:

CropMode: 4:3
Deinterlace: none
Postprocess: none
Buffer Mode: good seeking
Pixel Format: I420

In the live playback run, I recorded the stream.  Here's the top of
opreport --global-percent:

  samples|      %|
------------------
   151565 57.0991 libvdr-softdevice.so.1.3.27
    52674 19.8439 libc-2.3.2.so
    27401 10.3228 vmlinux
     8782  3.3084 oprofiled
     8427  3.1747 vdr

Here's the output when playing back.  This should be less work, as
there's less I/O (no I/O from the DVB tuner).  Alas, the CPU usage
is higher:

  samples|      %|
------------------
   170194 51.5064 libvdr-softdevice.so.1.3.27
    43782 13.2499 libc-2.3.2.so
    38975 11.7951 vdr
    31644  9.5765 libpthread-0.60.so
    20935  6.3356 vmlinux
    11247  3.4037 oprofiled

In softdevice, the top of opreport -l looks as follows for live
playback:

samples  %        symbol name
17392    11.4749  put_pixels16_mmx
15957    10.5282  put_pixels8_mmx
10520     6.9409  put_pixels16_xy2_mmx
9062      5.9790  ff_simple_idct_add_mmx
8337      5.5006  mpeg_decode_mb
8300      5.4762  ff_mpa_synth_filter
6107      4.0293  mpeg2_decode_block_non_intra
5718      3.7726  MPV_decode_mb
5173      3.4131  mpeg2_decode_block_intra
5017      3.3101  put_pixels16_y2_mmx2
4760      3.1406  ff_simple_idct_put_mmx
4326      2.8542  avg_pixels8_mmx2
4258      2.8094  MPV_motion
3993      2.6345  mpeg_decode_motion
... (lots of symbols that appear to be in ffmpeg)
654       0.4315  mpeg_decode_frame
615       0.4058  avg_pixels8_xy2_mmx2
599       0.3952  put_pixels_clamped_mmx
507       0.3345  cDFBVideoOut::YUV(unsigned char*, unsigned char*,
unsigned char*, int, int, int, int)
378       0.2494  ff_er_add_slice
341       0.2250  cVideoOut::Draw(cBitmap*, unsigned char*, int, bool)
252       0.1663  ScaleBitmap(cBitmap*, int&, int&, int&, int&, int,
int, int, int)
186       0.1227  ff_init_block_index
149       0.0983  cVideoStreamDecoder::DecodePacket(AVPacket*)
134       0.0884  MPV_frame_start

In "dead" playback, the list looks roughly the same, except for the
method at top:

samples  %        symbol name
22284    13.0933  cStreamDecoder::BufferFill()
16221     9.5309  put_pixels16_mmx
15273     8.9739  put_pixels8_mmx
9733      5.7188  put_pixels16_xy2_mmx
8515      5.0031  ff_simple_idct_add_mmx
7917      4.6518  mpeg_decode_mb
7674      4.5090  ff_mpa_synth_filter
5949      3.4954  mpeg2_decode_block_non_intra
5487      3.2240  MPV_decode_mb
4774      2.8050  mpeg2_decode_block_intra
4771      2.8033  put_pixels16_y2_mmx2
4376      2.5712  ff_simple_idct_put_mmx
4018      2.3608  MPV_motion

In live playback, the method cStreamDecoder::BufferFill() got only
16 samples (0.0106 % of softdevice execution time).  In the output of
"opannotate -t 13 -a --source .../libvdr-softdevice-1.3.27", there
are two weird-looking instructions that seem to consume a lot of time.
Or maybe it's the preceding idiv that is consuming the time:

   187  0.1099 :   656d3:       idiv   %ecx
  9485  5.5731 :   656d5:       lea    (%edx,%edx,4),%edx
   302  0.1774 :   656d8:       lea    (%edx,%edx,4),%edx
   289  0.1698 :   656db:       lea    0x0(,%edx,4),%eax

This is after the call to Available():
               :    inline int Available()
	       :    { return (LastPacket+MaxPackets - FirstPacket)%MaxPackets; }

The "+MaxPackets" is redundant, isn't it?  (Unless LastPacket<FirstPacket,
of course.)

But I guess the real reason why this takes so much time is that the
BufferFill method is being called too often.  It looks like it's only
called from cSoftDevice::Poll().  Unfortunately I can't see the caller
of that method without linking vdr and softdevice statically (or maybe
I can, but I haven't figured out how).

After I applied the patch you posted later (Sleep=true in dvbplayer.c),
this problem went away.  The samples reported for live and recorded
playback are comparable - in fact, the system appears to be consuming
slightly less CPU when playing back recorded streams.  Good work, Martin!

BTW, any chance of introducing the "suspended" flag to vdr itself?
That'd go with some auto-power-off logic, i.e., if suspended=true
and vdr is currently recording, turn power off after the recording
is completed (after some short timeout).  That'd make vdr much easier
to use for my wife.  (We're recording children's programs daily, and
she leaves the computer on, because she won't retry if the timed
recording is still going on at the time she tries to power the
system off.)

Should there perhaps be a bug reporting system or a list of known
bugs on the web page?  I have reported two bugs earlier that still
appear to be there with vdr-1.3.27 and current softdevice CVS.
First, the Power key is ignored when playing back recordings.
Second, vdr crashes with Signal 11 when selecting "Restart" (sp?,
my OSD is in Finnish).

	Marko


From marko.makela at hut.fi  Wed Jul  6 08:37:00 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 6 Jul 2005 09:37:00 +0300
Subject: [Softdevice-devel] Jerky picture when i replay recordings.
In-Reply-To: <20050705212613.GB3302@localhost.localdomain>
References: <42C2D849.7040808@kapsi.fi> <42C41AC9.1080203@gmx.net> <20050705212613.GB3302@localhost.localdomain>
Message-ID: <20050706063700.GA3292@localhost.localdomain>

On Wed, Jul 06, 2005 at 12:26:13AM +0300, Marko M?kel? wrote:
> After I applied the patch you posted later (Sleep=true in dvbplayer.c),
> this problem went away.  The samples reported for live and recorded
> playback are comparable - in fact, the system appears to be consuming
> slightly less CPU when playing back recorded streams.  Good work, Martin!

I don't know why, but this morning, using exactly the same software, vdr
would consume only a couple per cent of CPU time, displaying perhaps one
or two frames and then sleeping about a second, both on live and
recorded playback.  After I commented out the added assignment in
dvbplayer.c, it plays again.  Any idea why it worked differently at this
time?

	Marko


From torgeir at pobox.com  Wed Jul  6 10:10:34 2005
From: torgeir at pobox.com (Torgeir Veimo)
Date: Wed, 06 Jul 2005 09:10:34 +0100
Subject: [Softdevice-devel] Jerky picture when i replay recordings.
In-Reply-To: <20050706063700.GA3292@localhost.localdomain>
References: <42C2D849.7040808@kapsi.fi> <42C41AC9.1080203@gmx.net>
	 <20050705212613.GB3302@localhost.localdomain>
	 <20050706063700.GA3292@localhost.localdomain>
Message-ID: <1120637434.28383.2.camel@africa>

On Wed, 2005-07-06 at 09:37 +0300, Marko M?kel? wrote:
> On Wed, Jul 06, 2005 at 12:26:13AM +0300, Marko M?kel? wrote:
> > After I applied the patch you posted later (Sleep=true in dvbplayer.c),
> > this problem went away.  The samples reported for live and recorded
> > playback are comparable - in fact, the system appears to be consuming
> > slightly less CPU when playing back recorded streams.  Good work, Martin!
> 
> I don't know why, but this morning, using exactly the same software, vdr
> would consume only a couple per cent of CPU time, displaying perhaps one
> or two frames and then sleeping about a second, both on live and
> recorded playback.  After I commented out the added assignment in
> dvbplayer.c, it plays again.  Any idea why it worked differently at this
> time?

Very interesting. I've seen this on my box too, but before trying out
any changes in dvbplayer.c. I've come to believe it's a hardware fault
in my pci bridge, since the fan on it went bust a few weeks ago, and I
didn't notice until recently. I've tried different kernels, different
dvb-t cards, but not different vdr versions. 

I might have to try downgrading. It's very weird, as when it happens,
everything goes really slowly, even X cannot refresh its display.


-- 
Torgeir Veimo <torgeir at pobox.com>



From marko.makela at hut.fi  Wed Jul  6 14:39:42 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 6 Jul 2005 15:39:42 +0300
Subject: [Softdevice-devel] Jerky picture when i replay recordings.
In-Reply-To: <1120637434.28383.2.camel@africa>
References: <42C2D849.7040808@kapsi.fi> <42C41AC9.1080203@gmx.net> <20050705212613.GB3302@localhost.localdomain> <20050706063700.GA3292@localhost.localdomain> <1120637434.28383.2.camel@africa>
Message-ID: <20050706123942.GE3292@localhost.localdomain>

On Wed, Jul 06, 2005 at 09:10:34AM +0100, Torgeir Veimo wrote:
> > I don't know why, but this morning, using exactly the same software, vdr
> > would consume only a couple per cent of CPU time, displaying perhaps one
> > or two frames and then sleeping about a second, both on live and
> > recorded playback.  After I commented out the added assignment in
> > dvbplayer.c, it plays again.  Any idea why it worked differently at this
> > time?
> 
> Very interesting. I've seen this on my box too, but before trying out
> any changes in dvbplayer.c. I've come to believe it's a hardware fault
> in my pci bridge, since the fan on it went bust a few weeks ago, and I
> didn't notice until recently. I've tried different kernels, different
> dvb-t cards, but not different vdr versions. 

For me, commenting out the assignment and recompiling and restarting vdr
fixed the problem.  I didn't reboot.  I'm using DirectFB on Matrox G450.

	Marko


From M.Wache at gmx.net  Wed Jul  6 18:34:44 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Wed, 06 Jul 2005 18:34:44 +0200
Subject: [Softdevice-devel] Jerky picture when i replay recordings.
In-Reply-To: <20050705212613.GB3302@localhost.localdomain>
References: <42C2D849.7040808@kapsi.fi> <42C41AC9.1080203@gmx.net> <20050705212613.GB3302@localhost.localdomain>
Message-ID: <42CC0824.6080708@gmx.net>

Marko M?kel? schrieb:
> On Thu, Jun 30, 2005 at 06:16:09PM +0200, Martin Wache wrote:
> 
>>It would be really nice to find the reason for these troubles,
>>unfortunatly on my box I don't see them, so for me it is impossible to
>>find out more....
> 
> 
> Don't you even see increased CPU usage when playing back recordings?
On my old box (1GHz AMD) I never noticed an increased CPU usage. Now I
finally moved my vdr to the new AMD64 box and there I see the increased
CPU usage clearly.

> In "dead" playback, the list looks roughly the same, except for the
> method at top:
> 
> samples  %        symbol name
> 22284    13.0933  cStreamDecoder::BufferFill()
Yep, that's the one which is called in Poll() to check the buffer fill.
It should be inside of the busy loop in cDvbplayer::Action().

> In live playback, the method cStreamDecoder::BufferFill() got only
> 16 samples (0.0106 % of softdevice execution time).  In the output of
> "opannotate -t 13 -a --source .../libvdr-softdevice-1.3.27", there
> are two weird-looking instructions that seem to consume a lot of time.
> Or maybe it's the preceding idiv that is consuming the time:
> 
>    187  0.1099 :   656d3:       idiv   %ecx
>   9485  5.5731 :   656d5:       lea    (%edx,%edx,4),%edx
>    302  0.1774 :   656d8:       lea    (%edx,%edx,4),%edx
>    289  0.1698 :   656db:       lea    0x0(,%edx,4),%eax
I guess it's the "idiv" instruction which uses the time. I think shifts
by one instruction is possible when using oprofile, or am I wrong?

> 
> This is after the call to Available():
>                :    inline int Available()
> 	       :    { return (LastPacket+MaxPackets - FirstPacket)%MaxPackets; }
> 
> The "+MaxPackets" is redundant, isn't it?  (Unless LastPacket<FirstPacket,
> of course.)
The PacketBuffer is a ringbuffer, so LastPacket maybe smaller than
FirstPacket.

> BTW, any chance of introducing the "suspended" flag to vdr itself?
> That'd go with some auto-power-off logic, i.e., if suspended=true
> and vdr is currently recording, turn power off after the recording
> is completed (after some short timeout).  That'd make vdr much easier
> to use for my wife.  (We're recording children's programs daily, and
> she leaves the computer on, because she won't retry if the timed
> recording is still going on at the time she tries to power the
> system off.)
Hmm, you should ask that question on the vdr maillinglist.

> 
> Should there perhaps be a bug reporting system or a list of known
> bugs on the web page?  I have reported two bugs earlier that still
> appear to be there with vdr-1.3.27 and current softdevice CVS.
There is a bug tracking system for the softdevice at:

http://developer.berlios.de/bugs/?group_id=2051

> First, the Power key is ignored when playing back recordings.
I don't think this bug is softdevice related, the softdevice has no
chance to interfere on keypress events (except for those keys which are
used for the control of Xv which are not delivered to vdr).

> Second, vdr crashes with Signal 11 when selecting "Restart" (sp?,
> my OSD is in Finnish).
I will try to have a look at this.

Bye,
Martin


From M.Wache at gmx.net  Wed Jul  6 18:39:35 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Wed, 06 Jul 2005 18:39:35 +0200
Subject: [Softdevice-devel] Jerky picture when i replay recordings.
In-Reply-To: <20050706123942.GE3292@localhost.localdomain>
References: <42C2D849.7040808@kapsi.fi> <42C41AC9.1080203@gmx.net> <20050705212613.GB3302@localhost.localdomain> <20050706063700.GA3292@localhost.localdomain> <1120637434.28383.2.camel@africa> <20050706123942.GE3292@localhost.localdomain>
Message-ID: <42CC0947.1020501@gmx.net>

Marko M?kel? schrieb:
> On Wed, Jul 06, 2005 at 09:10:34AM +0100, Torgeir Veimo wrote:
> 
>>>I don't know why, but this morning, using exactly the same software, vdr
>>>would consume only a couple per cent of CPU time, displaying perhaps one
>>>or two frames and then sleeping about a second, both on live and
>>>recorded playback.  After I commented out the added assignment in
>>>dvbplayer.c, it plays again.  Any idea why it worked differently at this
>>>time?

If you've experienced the problems for both live-tv and playback I doubt
any connection with my patch. dvbplayer.c is only used when during
playback of recordings, so the patch should not affect live-tv at all.
I would suspect some different problem...

Can you please try to put the patch back now after it works without? Do
the problems return?

Martin


From juniper81 at gmail.com  Wed Jul  6 21:38:07 2005
From: juniper81 at gmail.com (Ari Koponen)
Date: Wed, 6 Jul 2005 22:38:07 +0300
Subject: [Softdevice-devel] Jerky picture when i replay recordings.
In-Reply-To: <42CC0947.1020501@gmx.net>
References: <42C2D849.7040808@kapsi.fi> <42C41AC9.1080203@gmx.net>
	 <20050705212613.GB3302@localhost.localdomain>
	 <20050706063700.GA3292@localhost.localdomain>
	 <1120637434.28383.2.camel@africa>
	 <20050706123942.GE3292@localhost.localdomain>
	 <42CC0947.1020501@gmx.net>
Message-ID: <b7bb364105070612383ec8797f@mail.gmail.com>

Awesome work guys! The patch works also on my system. Thanks for your
commitment! Hopefully the patch finds it's way in some form to the
vanilla vdr also.

- Ari


From marko.makela at hut.fi  Wed Jul  6 22:03:29 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 6 Jul 2005 23:03:29 +0300
Subject: [Softdevice-devel] Jerky picture when i replay recordings.
In-Reply-To: <42CC0824.6080708@gmx.net>
References: <42C2D849.7040808@kapsi.fi> <42C41AC9.1080203@gmx.net> <20050705212613.GB3302@localhost.localdomain> <42CC0824.6080708@gmx.net>
Message-ID: <20050706200329.GA503208@kosh.hut.fi>

On Wed, Jul 06, 2005 at 06:34:44PM +0200, Martin Wache wrote:
> > are two weird-looking instructions that seem to consume a lot of time.
> > Or maybe it's the preceding idiv that is consuming the time:
> > 
> >    187  0.1099 :   656d3:       idiv   %ecx
> >   9485  5.5731 :   656d5:       lea    (%edx,%edx,4),%edx
> >    302  0.1774 :   656d8:       lea    (%edx,%edx,4),%edx
> >    289  0.1698 :   656db:       lea    0x0(,%edx,4),%eax
> I guess it's the "idiv" instruction which uses the time. I think shifts
> by one instruction is possible when using oprofile, or am I wrong?

Yes, I've observed shifts by one instruction when there have been memory
faults.

> Hmm, you should ask that question on the vdr maillinglist.

Time to subscribe then.

> > Second, vdr crashes with Signal 11 when selecting "Restart" (sp?,
> > my OSD is in Finnish).
> I will try to have a look at this.

According to the VDR mailing list archive, this may be NPTL related.
I haven't tried running with LinuxThreads lately.

Unfortunately, I can't reboot tonight because of some ongoing recordings.
(Maybe I should build a separate development box, so that I could leave
the production system alone.)

I'll make some more experiments tomorrow.

	Marko


From marko.makela at hut.fi  Wed Jul  6 23:28:55 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 7 Jul 2005 00:28:55 +0300
Subject: [Softdevice-devel] Jerky picture when i replay recordings.
In-Reply-To: <42CC0947.1020501@gmx.net>
References: <42C2D849.7040808@kapsi.fi> <42C41AC9.1080203@gmx.net> <20050705212613.GB3302@localhost.localdomain> <20050706063700.GA3292@localhost.localdomain> <1120637434.28383.2.camel@africa> <20050706123942.GE3292@localhost.localdomain> <42CC0947.1020501@gmx.net>
Message-ID: <20050706212855.GA3288@localhost.localdomain>

On Wed, Jul 06, 2005 at 06:39:35PM +0200, Martin Wache wrote:
> If you've experienced the problems for both live-tv and playback I doubt
> any connection with my patch. dvbplayer.c is only used when during
> playback of recordings, so the patch should not affect live-tv at all.
> I would suspect some different problem...

The strange thing is that I didn't change anything else.  Maybe there is
some race condition or other timing related bug in the thread setup that
manifests itself very rarely.  I put the patch back, and got no
problems, not even after reboot.

Hmm, I got a crash when pressing the Videos button (the first button
press after reboot).  Unfortunately, I didn't get a core dump for that.
The crash at restart happens both on LinuxThreads and NPTL:

#0  0x0830b538 in ?? ()
#1  0xb79479f4 in ~cSoftOsd (this=0x8450fa8) at softdevice.c:113
#2  0xb7798039 in SubtitlesViewer::Hide (this=0x82eb000) at viewer.c:51
#3  0x08105e7b in NonInteractiveOsdPatch::cOsdController::Unsubscribe (
    this=0x81d2898, listener=0x82eb000) at osdcontroller.c:93
#4  0xb77965f5 in ~cSubtitlesReceiver (this=0x82eaec0) at receiver.c:36
#5  0xb779ef78 in ~cSubtitlesChangedHandler (this=0xb77a9ec0)
    at subfilter.c:329
#6  0xb77a27c2 in __tcf_0 () at subfilter.c:449
#7  0xb7d82de1 in __cxa_finalize () from /lib/libc.so.6
#8  0xb77958f0 in __do_global_dtors_aux ()
   from ./PLUGINS/lib/libvdr-subtitles.so.1.3.27
#9  0xb77a4376 in _fini () from ./PLUGINS/lib/libvdr-subtitles.so.1.3.27
#10 0xb7e5f4a8 in _dl_close () from /lib/libc.so.6
#11 0x00000022 in ?? ()
Previous frame inner to this frame (corrupt stack?)

That was with -Psoftdevice -Psubtitles.  Another crash I got was a bit
earlier:
0xb79479f1 in ~cSoftOsd (this=0x8459650) at softdevice.c:113
113         videoOut->CloseOSD();

With -Psubtitles -Psoftdevice (in the opposite order), I get a different
crash, on both LinuxThreads and NPTL:

#0  0xb7ca8036 in SubtitlesViewer::Hide (this=0x8273cb8) at viewer.c:51
#1  0x08105e7b in NonInteractiveOsdPatch::cOsdController::Unsubscribe (
    this=0x81d2898, listener=0x8273cb8) at osdcontroller.c:93
#2  0xb7ca65f5 in ~cSubtitlesReceiver (this=0x8273b78) at receiver.c:36
#3  0xb7caef78 in ~cSubtitlesChangedHandler (this=0xb7cb9ec0)
    at subfilter.c:329
#4  0xb7cb27c2 in __tcf_0 () at subfilter.c:449
#5  0xb7d82de1 in __cxa_finalize () from /lib/libc.so.6
#6  0xb7ca58f0 in __do_global_dtors_aux ()
    from ./PLUGINS/lib/libvdr-subtitles.so.1.3.27
#7  0xb7cb4376 in _fini () from ./PLUGINS/lib/libvdr-subtitles.so.1.3.27
#8  0xb7e5f4a8 in _dl_close () from /lib/libc.so.6
#9  0x00000022 in ?? ()
Previous frame inner to this frame (corrupt stack?)

Hmm, VDR shuts down cleanly if there are no subtitles to be shown
in a live program.  I couldn't repeat this crash with a recording
containing subtitles.

Also, while testing this, I once got no video at all, even though
suspend=false.  Only the subtitles were shown on the otherwise black
screen.  I've seen this a few times before, although with a completely
black screen.  Switching channels back and forth helps, although not
this time (because I was running it in gdb, and for some reason gdb
wanted to report a SIGTRAP and become confused when I tried to switch
channels).

	Marko


From felix_lists at smega.com  Fri Jul  8 14:45:34 2005
From: felix_lists at smega.com (Felix)
Date: Fri, 08 Jul 2005 14:45:34 +0200
Subject: [Softdevice-devel] softdevice 0.1.2 + vdr 1.3.27 on EPIA M10000 - flickering or hanging
Message-ID: <42CE756E.4040705@smega.com>

Hi everybody,

after one week of trying all possibilities to get live TV running on the 
above setup, you are my last hope.

With fb, Live TV output is flickering like hell, and sound his jerky. It 
looks like i only got a third of the framerate and the output is not in 
sync with screen refresh. However, for about half a second after 
starting vdr, the output looks good.

The kernel fb is a:
    VIA Graphics Intergration Chipset framebuffer 0.9 initializing
configured at kernel startup with
   append="video=viafb:720x576,bpp=16"
<mailto:softdevice-devel at lists.berlios.de>
When starting with dfb, vdr just locks with a black screen after giving 
the following output. I have to kill -9 it.

Any hints?

... Felix

This is the output with -vo fb:
[softdevice] processing args
[softdevice]   argv [0] = softdevice
[softdevice] initializing Plugin
[softdevice] Initializing Video Out
[softdevice] ffmpeg version(0.4.9-pre1) build(4757)
[video-fb] Initializing Driver
[video-fb] Truecolor FB found
[video-fb] init 720 x 576 (Size: 33288192 Bytes LineLen 1440) Bpp: 16
[video-fb] Clearing the FB
Subplugin successfully opend
[softdevice] Video Out seems to be OK
[softdevice] Initializing Audio Out
[softdevice] Audio out seems to be OK
[softdevice] A/V devices initialized, now initializing MPEG2 Decoder
cSoftDevice::MakePrimaryDevice
CMD[4019]:SetAudioMode 0
CMD[4024]:SetPlayMode PmAudioVideo
CMD[4024]:Start IsSuspended 0
CMD[4024]:init put byte finished
CMD[4033]:Neuer Thread gestartet: Mpeg2Decoder pid 1851
CMD[4241]:new Video stream index.. old -1 new 0
CMD[4241]:Neuer StreamDecoder Pid: 1851 context 0x83d4ca8 type 0

this with -vo dfb:
[softdevice] processing args
[softdevice]   argv [0] = softdevice
[softdevice]   argv [1] = -vo
[setup-softdevice] alsa ac3Mode set to: 0
[setup-softdevice] alsa device set to: default
[setup-softdevice] A/V Offset set to (2)
[setup-softdevice] cropping mode set to 0 (none)
[setup-softdevice] cropping mode toggle key set to 0 (none)
[setup-softdevice] deinterlace method set to 0 none
[softdevice] picture mirroring set to 0 (off)
[setup-softdevice] pixel format set to (I420)
[setup-softdevice] shouldSuspend to: 0
[setup-softdevice] startup aspect set to (4:3 normal)
[softdevice] initializing Plugin
[softdevice] Initializing Video Out
[softdevice] ffmpeg version(0.4.9-pre1) build(4757)
[dfb] init
(*) DirectFB/Config: Parsing config file '/etc/directfbrc'.

       ---------------------- DirectFB v0.9.22 ---------------------
             (c) 2000-2002  convergence integrated media GmbH 
             (c) 2002-2004  convergence GmbH                  
        -----------------------------------------------------------

(*) DirectFB/Core: Single Application Core. (2005-07-03 19:04)
(*) Direct/Memcpy: Using SSE optimized memcpy()
(*) Direct/Thread: Running 'VT Switcher' (CRITICAL, 1926)...
(*) Direct/Modules: suppress module 'linux_input'
(*) Direct/Thread: Running 'PS/2 Input' (INPUT, 1927)...
 (!!!)  *** UNIMPLEMENTED [fusion_reactor_set_lock] *** [reactor.c:802]
(*) DirectFB/Input: IMPS/2 Mouse 1.0 (Convergence GmbH)
(*) Direct/Thread: Running 'LiRC Input' (INPUT, 1928)...
(*) DirectFB/Input: LIRC Device 0.2 (convergence integrated media GmbH)
(*) Direct/Thread: Running 'Keyboard Input' (INPUT, 1929)...
(*) DirectFB/Input: Keyboard 0.9 (convergence integrated media GmbH)
(*) DirectFB/Genefx: MMX detected and enabled
(*) Direct/Modules: suppress module 'cle266'
(*) DirectFB/Graphics: VIA/S3G UniChrome 0.4 (-)
(*) DirectFB/Core/WM: Default 0.2 (Convergence GmbH)
[dfb] RAM: 33288192 bytes
[dfb] Accellerated Functions: FillRectange DrawRectange DrawLine 
FillTriangle Blit StretchBlit All
[dfb] Drawing Flags: Blend Xor
[dfb] Surface Blitting Flags: BlendAlpha BlendColorAlpha Colorize 
SrcColorkey DstColorkey Deinterlace
[dfb] Supported video Modes are: 640x480 at 32 640x480 at 32 640x480 at 32 
640x480 at 32 640x480 at 32 720x480 at 32 720x576 at 32 800x600 at 32 800x600 at 32 
800x600 at 32 800x600 at 32 800x600 at 32 848x480 at 32 856x480 at 32 1024x512 at 32 
1024x768 at 32 1024x768 at 32 1024x768 at 32 1024x768 at 32 1152x864 at 32 1152x864 at 32 
1280x768 at 32 1280x960 at 32 1280x1024 at 32 1280x1024 at 32 1280x1024 at 32 
1600x1200 at 32 1600x1200 at 32 1400x1050 at 32
[dfb] Enumeratig display Layers
Layer 0 FBDev Primary Layer  Type: graphics
  Caps: brightness contrast saturation surface
Layer 1 VIA Unichrome Video  Type: graphics picture video
  Caps: deinterlacing dst_colorkey opacity screen_location surface
uc_overlay: color-keying is disabled
[surface capabilities] scrSurface: primary videoonly double-buffered 
flipping
[dfb] width = 720, height = 576
[dfb] got fmt = 0x00418c04 bpp = 32
[dfb] Using this layer for OSD: (FBDev Primary Layer - [720x576])
[surface capabilities] osdSurface: videoonly double-buffered flipping
 (!!!)  *** WARNING [letting unprivileged 
IDirectFBDisplayLayer::GetSurface() call pass until cooperative level 
handling is finished] *** [idirectfbdisplaylayer.c:170 in 
IDirectFBDisplayLayer_GetSurface()]
[surface capabilities] videoSurface: videoonly
[dfb] Configuring CooperativeLevel for Overlay
[dfb] Configuring CooperativeLevel for OSD
[dfb] Using this layer for OSD: FBDev Primary Layer
[dfb] Using this layer for Video out: VIA Unichrome Video
[dfb] Display frame time is 100010?s
[dfb] (re)configuring Videolayer to 720 x 576 (720x576)
Caught: action=IDirectFBDisplayLayer::SetLevel(int), result=Not 
supported! Failed: SetLevel()
uc_overlay: color-keying is enabled
uc_overlay: color-keying is enabled
uc_overlay: color-keying is enabled
uc_overlay: color-keying is enabled
[surface capabilities] videoSurface: videoonly double-buffered flipping
[dfb] (re)configured 0x08100609
Subplugin successfully opend
[softdevice] Video Out seems to be OK
[softdevice] Initializing Audio Out
[softdevice] Audio out seems to be OK
[softdevice] A/V devices initialized, now initializing MPEG2 Decoder
cSoftDevice::MakePrimaryDevice


# fbset -i

mode "720x576-74"
    # D: 41.475 MHz, H: 44.693 kHz, V: 74.488 Hz
    geometry 720 576 720 1152 16
    timings 24111 88 32 16 4 88 4
    rgba 5/11,6/5,5/0,0/0
endmode

Frame buffer device information:
    Name        : UNICHROME
    Address     : 0xd8000000
    Size        : 33288192
    Type        : PACKED PIXELS
    Visual      : TRUECOLOR
    XPanStep    : 0
    YPanStep    : 1
    YWrapStep   : 0
    LineLength  : 1440
    MMIO Address: 0xdc000000
    MMIO Size   : 16777216
    Accelerator : Unknown (77)

# dfbinfo
(*) DirectFB/Config: Parsing config file '/etc/directfbrc'.

       ---------------------- DirectFB v0.9.22 ---------------------
             (c) 2000-2002  convergence integrated media GmbH 
             (c) 2002-2004  convergence GmbH                  
        -----------------------------------------------------------

(*) DirectFB/Core: Single Application Core. (2005-07-03 19:04)
(*) Direct/Memcpy: Using SSE optimized memcpy()
(*) Direct/Thread: Running 'VT Switcher' (CRITICAL, 1909)...
(*) Direct/Modules: suppress module 'linux_input'
(*) Direct/Thread: Running 'PS/2 Input' (INPUT, 1910)...
 (!!!)  *** UNIMPLEMENTED [fusion_reactor_set_lock] *** [reactor.c:802]
(*) DirectFB/Input: IMPS/2 Mouse 1.0 (Convergence GmbH)
(*) Direct/Thread: Running 'LiRC Input' (INPUT, 1911)...
(*) DirectFB/Input: LIRC Device 0.2 (convergence integrated media GmbH)
(*) Direct/Thread: Running 'Keyboard Input' (INPUT, 1912)...
(*) DirectFB/Input: Keyboard 0.9 (convergence integrated media GmbH)
(*) DirectFB/Genefx: MMX detected and enabled
(*) Direct/Modules: suppress module 'cle266'
(*) DirectFB/Graphics: VIA/S3G UniChrome 0.4 (-)
(*) DirectFB/Core/WM: Default 0.2 (Convergence GmbH)


Screen (00) FBDev Primary Screen            (primary screen)
   Caps: VSYNC POWER_MANAGEMENT

     Layer (00) FBDev Primary Layer             (primary layer)
        Type:    GRAPHICS
        Caps:    SURFACE BRIGHTNESS CONTRAST SATURATION

     Layer (01) VIA Unichrome Video          
        Type:    GRAPHICS VIDEO STILL_PICTURE
        Caps:    SURFACE OPACITY SCREEN_LOCATION DEINTERLACING 
DST_COLORKEY SCREEN_POSITION SCREEN_SIZE

     Layer (02) VIA Unichrome DVD Subpicture 
        Type:    GRAPHICS VIDEO STILL_PICTURE
        Caps:    SURFACE OPACITY


Input (01) IMPS/2 Mouse                    (primary mouse)
   Type: MOUSE
   Caps: AXES BUTTONS

Input (03) LIRC Device                     (primary remote control)
   Type: REMOTE
   Caps: KEYS

Input (00) Keyboard                        (primary keyboard)
   Type: KEYBOARD
   Caps: KEYS




From stefan at lucke.in-berlin.de  Fri Jul  8 23:34:33 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 8 Jul 2005 23:34:33 +0200
Subject: [Softdevice-devel] softdevice 0.1.2 + vdr 1.3.27 on EPIA M10000 - flickering or hanging
In-Reply-To: <42CE756E.4040705@smega.com>
References: <42CE756E.4040705@smega.com>
Message-ID: <200507082334.33499.stefan@lucke.in-berlin.de>

On Freitag, 8. Juli 2005 14:45, Felix wrote:
> Hi everybody,
> 
> after one week of trying all possibilities to get live TV running on the 
> above setup, you are my last hope.
> 
> With fb, Live TV output is flickering like hell, and sound his jerky. It 
> looks like i only got a third of the framerate and the output is not in 
> sync with screen refresh. However, for about half a second after 
> starting vdr, the output looks good.

I think M10000 is to slow for plain (unaccelerated) output "-vo fb:"

> 
> The kernel fb is a:
>     VIA Graphics Intergration Chipset framebuffer 0.9 initializing
> configured at kernel startup with
>    append="video=viafb:720x576,bpp=16"
> <mailto:softdevice-devel at lists.berlios.de>
> When starting with dfb, vdr just locks with a black screen after giving 
> the following output. I have to kill -9 it.
> 
> Any hints?

Did you check the following thread ?

http://lists.berlios.de/pipermail/softdevice-devel/2005q2/000785.html


-- 
Stefan Lucke



From malcolm.caldwell at cdu.edu.au  Sun Jul 10 16:37:41 2005
From: malcolm.caldwell at cdu.edu.au (Malcolm Caldwell)
Date: Mon, 11 Jul 2005 00:07:41 +0930
Subject: [Softdevice-devel] softdevice and 4:2:2
Message-ID: <1121006262.17754.6.camel@localhost.localdomain>

Hello,

I have a C-band dish and I thought I would look around for some feeds.

Many feeds are broadcast with a YUV 4:2:2 colour space rather than the
more normal 4:2:0 colour space of mpeg.

My dxr3 does not play these channels at all.  Audio works, but there is
no picture.

So I thought I would try softdevice.  I complied a vdr on my laptop
along with streamdev-client and softdevice.

The good news is it works: I get a picture!  Then bad news is that
softdevice does not handle 4:2:2 as evidenced by the colours being in
the wrong place.

For reference, mplayer is able to play these recordings.

Is there any hope?



From M.Wache at gmx.net  Sun Jul 10 19:28:58 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 10 Jul 2005 19:28:58 +0200
Subject: [Softdevice-devel] softdevice and 4:2:2
In-Reply-To: <1121006262.17754.6.camel@localhost.localdomain>
References: <1121006262.17754.6.camel@localhost.localdomain>
Message-ID: <42D15ADA.2020300@gmx.net>

Malcolm Caldwell schrieb:
> Hello,
> 
> I have a C-band dish and I thought I would look around for some feeds.
> 
> Many feeds are broadcast with a YUV 4:2:2 colour space rather than the
> more normal 4:2:0 colour space of mpeg.
> 
> My dxr3 does not play these channels at all.  Audio works, but there is
> no picture.
> 
> So I thought I would try softdevice.  I complied a vdr on my laptop
> along with streamdev-client and softdevice.
> 
> The good news is it works: I get a picture!  Then bad news is that
> softdevice does not handle 4:2:2 as evidenced by the colours being in
> the wrong place.
> 
> For reference, mplayer is able to play these recordings.
> 
> Is there any hope?
That mostly depends on if libavcodec properly decodes the samples. If it
does, which I currently assume since you get some kind of picture, we
just need to transform from YUV422 to YUV420 colourspace which should be
easy.

So I think there is hope :-). A sample for testing would be nice, since
I don't recieve any channels broadcasting in YUV422 colour space.

Unfortunatly I'm currently really short on time, so I guess most of the
development on the softdevice from my side has to wait :-(

Martin


From M.Wache at gmx.net  Sun Jul 10 19:34:30 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 10 Jul 2005 19:34:30 +0200
Subject: [Softdevice-devel] Jerky picture when i replay recordings.
In-Reply-To: <b7bb364105070612383ec8797f@mail.gmail.com>
References: <42C2D849.7040808@kapsi.fi> <42C41AC9.1080203@gmx.net>	 <20050705212613.GB3302@localhost.localdomain>	 <20050706063700.GA3292@localhost.localdomain>	 <1120637434.28383.2.camel@africa>	 <20050706123942.GE3292@localhost.localdomain>	 <42CC0947.1020501@gmx.net> <b7bb364105070612383ec8797f@mail.gmail.com>
Message-ID: <42D15C26.6090700@gmx.net>

Ari Koponen schrieb:
> Awesome work guys! The patch works also on my system. Thanks for your
> commitment!
Your're welcome ;-)

> Hopefully the patch finds it's way in some form to the
> vanilla vdr also.

I already asked Klaus on the vdr mailling list, but I didn't get an
answer from Klaus yet. I think I'll ask again when Klaus is back on the
mailling list.

Martin


From M.Wache at gmx.net  Sun Jul 10 19:53:31 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 10 Jul 2005 19:53:31 +0200
Subject: [Softdevice-devel] Jerky picture when i replay recordings.
In-Reply-To: <20050706212855.GA3288@localhost.localdomain>
References: <42C2D849.7040808@kapsi.fi> <42C41AC9.1080203@gmx.net> <20050705212613.GB3302@localhost.localdomain> <20050706063700.GA3292@localhost.localdomain> <1120637434.28383.2.camel@africa> <20050706123942.GE3292@localhost.localdomain> <42CC0947.1020501@gmx.net> <20050706212855.GA3288@localhost.localdomain>
Message-ID: <42D1609B.9020404@gmx.net>

Marko M?kel? schrieb:
> On Wed, Jul 06, 2005 at 06:39:35PM +0200, Martin Wache wrote:
> 
>>If you've experienced the problems for both live-tv and playback I doubt
>>any connection with my patch. dvbplayer.c is only used when during
>>playback of recordings, so the patch should not affect live-tv at all.
>>I would suspect some different problem...
> 
> 
> The strange thing is that I didn't change anything else.  Maybe there is
> some race condition or other timing related bug in the thread setup that
> manifests itself very rarely.  I put the patch back, and got no
> problems, not even after reboot.
> 
Well, at lest it is working now. And sometimes I think it is the best
not even to try to understand computers ;-)

> Hmm, I got a crash when pressing the Videos button (the first button
> press after reboot).  Unfortunately, I didn't get a core dump for that.
> The crash at restart happens both on LinuxThreads and NPTL:
> 
> #0  0x0830b538 in ?? ()
> #1  0xb79479f4 in ~cSoftOsd (this=0x8450fa8) at softdevice.c:113
> #2  0xb7798039 in SubtitlesViewer::Hide (this=0x82eb000) at viewer.c:51
> #3  0x08105e7b in NonInteractiveOsdPatch::cOsdController::Unsubscribe (
>     this=0x81d2898, listener=0x82eb000) at osdcontroller.c:93
> #4  0xb77965f5 in ~cSubtitlesReceiver (this=0x82eaec0) at receiver.c:36
> #5  0xb779ef78 in ~cSubtitlesChangedHandler (this=0xb77a9ec0)
>     at subfilter.c:329
> #6  0xb77a27c2 in __tcf_0 () at subfilter.c:449
> #7  0xb7d82de1 in __cxa_finalize () from /lib/libc.so.6
> #8  0xb77958f0 in __do_global_dtors_aux ()
>    from ./PLUGINS/lib/libvdr-subtitles.so.1.3.27
> #9  0xb77a4376 in _fini () from ./PLUGINS/lib/libvdr-subtitles.so.1.3.27
> #10 0xb7e5f4a8 in _dl_close () from /lib/libc.so.6
> #11 0x00000022 in ?? ()
> Previous frame inner to this frame (corrupt stack?)
> 
Hmm, ~cSoftOSD calls videoOut->CloseOSD.

> That was with -Psoftdevice -Psubtitles.  Another crash I got was a bit
> earlier:
> 0xb79479f1 in ~cSoftOsd (this=0x8459650) at softdevice.c:113
> 113         videoOut->CloseOSD();
>
So I guess these two are related...
But there is not much which could crash, especially if you're using
DirectFB and thus not the software osd alpha blending. Then CloseOSD
should do *nothing*...

> With -Psubtitles -Psoftdevice (in the opposite order), I get a different
> crash, on both LinuxThreads and NPTL:
> 
> #0  0xb7ca8036 in SubtitlesViewer::Hide (this=0x8273cb8) at viewer.c:51
> #1  0x08105e7b in NonInteractiveOsdPatch::cOsdController::Unsubscribe (
>     this=0x81d2898, listener=0x8273cb8) at osdcontroller.c:93
> #2  0xb7ca65f5 in ~cSubtitlesReceiver (this=0x8273b78) at receiver.c:36
> #3  0xb7caef78 in ~cSubtitlesChangedHandler (this=0xb7cb9ec0)
>     at subfilter.c:329
> #4  0xb7cb27c2 in __tcf_0 () at subfilter.c:449
> #5  0xb7d82de1 in __cxa_finalize () from /lib/libc.so.6
> #6  0xb7ca58f0 in __do_global_dtors_aux ()
>     from ./PLUGINS/lib/libvdr-subtitles.so.1.3.27
> #7  0xb7cb4376 in _fini () from ./PLUGINS/lib/libvdr-subtitles.so.1.3.27
> #8  0xb7e5f4a8 in _dl_close () from /lib/libc.so.6
> #9  0x00000022 in ?? ()
> Previous frame inner to this frame (corrupt stack?)
There is no method from the softdevice in this stack trace. Like it is
said, it looks like a corrupt stack, so I would guess someone writes too
much to some lokal variable. But where?
No clue right now... :-(
Anybody else who has these problems on restart?

Bye,
Martin


From prelude at kapsi.fi  Sun Jul 10 20:42:40 2005
From: prelude at kapsi.fi (Tommi Lundell)
Date: Sun, 10 Jul 2005 21:42:40 +0300
Subject: [Softdevice-devel] Jerky picture when i replay recordings.
In-Reply-To: <42C5722D.3030702@kapsi.fi>
References: <42C2D849.7040808@kapsi.fi> <42C41AC9.1080203@gmx.net> <200506302142.54143.stefan@lucke.in-berlin.de> <42C467E6.1010806@kapsi.fi> <42C53AF3.7040603@gmx.net> <Pine.LNX.4.61.0507011503380.6190@pub6.ifh.de> <42C54420.5010101@gmx.net> <42C5722D.3030702@kapsi.fi>
Message-ID: <42D16C20.8060204@kapsi.fi>

Tommi Lundell wrote:

> Martin Wache wrote:
>
>> Alternativly you can try the untested attached patch for vdr-1.3.27 (if
>> it doesn't compile, maybe you can fix it, I guess the idea is clear...).
>> It will cause vdr to sleep when it doesn't have any new frame for the
>> softdevice. That will hopefully break the busy loop, but please undo the
>> previous patch for the softdevice when trying this.
>>
>> Martin
>>  
>>
>> ------------------------------------------------------------------------
>>
>> --- dvbplayer.c.orig    Fri Jul  1 15:14:49 2005
>> +++ dvbplayer.c    Fri Jul  1 15:16:50 2005
>> @@ -497,6 +497,7 @@
>>                  p = NULL;
>>                  }
>>               }
>> +              else Sleep=true;
>>            }
>>         }
>>   active = running = false;
>>  
>>
>
> Hello
>
> I tested that also and it's seems to work ok (about 5min testing 
> before my wife 'ask' permission to look her food program)
> I made same logs what i made last night:
> http://prelude.kapsi.fi/jerky2.tar.gz
> (I don t understand that but maybe Martin or Stefan see is all ok now 
> or not)
>
> Anyway..Great job again guys :-)


Hello again :-)

I have been away for while and and it's time to spend my holidays so im 
away for while.
But i think it's propably better to write that note first ;-)

Ok that patch works fine some time but after 3-5 simpsons episode i 
start to see jerkying again. (I dont have log from that :-/)

And second point. I got two dxr3 cards form my frends and i tested vdr 
whit dxr3 plugin. Whit that patch in vdr picture jumping and stilling 
whole time. example:show couple frame ok then still about 0.5-1s jumping 
to that point or show old frames...etc. Whitout that patch vdr+dxr3 
plugin works fine.
So it's propably better to test it bit more before Klaus add that in vdr 
CVS.

Tommi



From vcatana at registru.md  Mon Jul 11 08:09:00 2005
From: vcatana at registru.md (Vadim Catana)
Date: Mon, 11 Jul 2005 09:09:00 +0300
Subject: [Softdevice-devel] [PATCH]
Message-ID: <42D20CFC.1060003@registru.md>

Hi,

This patch makes the following modifications to
softdevice plugin from CVS:

1. Some channels display white dots at the top and bottom of
    the screen due to WSS data encoded in the picture.
    This problem has been mentioned on vdr, linux-dvb and
    dxr3 mailinglists a few times. I added two new items in
    the softdevice menu that allow to cut off a number of lines
    from top and bottom of the picture. It is implemented now
    only for -vo vidix and dfb with i420/YV12 format and hardware
    alpha blending.

2. the video-vidix.c and video-dfb.c both contain code
    that converts pictures from YV12 format to YUY2. I moved
    this common code to a function in utils.c .

3. fixed a couple of compiler warnings for gcc4 on x86-64.
    And the function fast_memcpy() from utils.c does not
    compile on x86-64, so I commented it. Please, somebody
    fix it.

------------
Regards,
Vadim Catana
-------------- next part --------------
A non-text attachment was scrubbed...
Name: softdevice.patch
Type: text/x-patch
Size: 19556 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050711/8837ea4d/attachment.bin>

From vcatana at registru.md  Mon Jul 11 08:32:19 2005
From: vcatana at registru.md (Vadim Catana)
Date: Mon, 11 Jul 2005 09:32:19 +0300
Subject: [Softdevice-devel] softdevice and 4:2:2
In-Reply-To: <42D15ADA.2020300@gmx.net>
References: <1121006262.17754.6.camel@localhost.localdomain> <42D15ADA.2020300@gmx.net>
Message-ID: <42D21273.4020508@registru.md>

Martin Wache wrote:
> That mostly depends on if libavcodec properly decodes the samples. If it
> does, which I currently assume since you get some kind of picture, we
> just need to transform from YUV422 to YUV420 colourspace which should be
> easy.

If the videocard supports YUV422 in hardware we don't need to transform
anything. BTW, did you try to change the pixel format from softdevice menu ?
If you could record a channel with YUV422 for a couple of minutes and
upload it somewhere, I could take a look.

-------------------
Vadim Catana


From malcolm.caldwell at cdu.edu.au  Mon Jul 11 15:43:57 2005
From: malcolm.caldwell at cdu.edu.au (Malcolm Caldwell)
Date: Mon, 11 Jul 2005 23:13:57 +0930
Subject: [Softdevice-devel] softdevice and 4:2:2
In-Reply-To: <42D21273.4020508@registru.md>
References: <1121006262.17754.6.camel@localhost.localdomain>
	 <42D15ADA.2020300@gmx.net>  <42D21273.4020508@registru.md>
Message-ID: <1121089438.4556.1.camel@localhost.localdomain>

On Mon, 2005-07-11 at 09:32 +0300, Vadim Catana wrote:
> Martin Wache wrote:
> > That mostly depends on if libavcodec properly decodes the samples. If it
> > does, which I currently assume since you get some kind of picture, we
> > just need to transform from YUV422 to YUV420 colourspace which should be
> > easy.
> 
> If the videocard supports YUV422 in hardware we don't need to transform
> anything. BTW, did you try to change the pixel format from softdevice menu ?

Is this driver dependant? On my laptop I using xv, and I don't see any
options to change the format in the menu.

> If you could record a channel with YUV422 for a couple of minutes and
> upload it somewhere, I could take a look.

I will try to get something together for this - probably later today.

> -------------------
> Vadim Catana
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/softdevice-devel



From vcatana at registru.md  Mon Jul 11 16:48:51 2005
From: vcatana at registru.md (Vadim Catana)
Date: Mon, 11 Jul 2005 17:48:51 +0300
Subject: [Softdevice-devel] softdevice and 4:2:2
In-Reply-To: <1121089438.4556.1.camel@localhost.localdomain>
References: <1121006262.17754.6.camel@localhost.localdomain>	 <42D15ADA.2020300@gmx.net>  <42D21273.4020508@registru.md> <1121089438.4556.1.camel@localhost.localdomain>
Message-ID: <42D286D3.6090505@registru.md>

Malcolm Caldwell wrote:
>>
>>If the videocard supports YUV422 in hardware we don't need to transform
>>anything. BTW, did you try to change the pixel format from softdevice menu ?
> 
> 
> Is this driver dependant? On my laptop I using xv, and I don't see any
> options to change the format in the menu.

I don't know about xv, but with vidix or directfb you can select
the format of the picture from softdevice menu. It now supports
i420, yv12 and yuy2. YUV422 can also be added. If you prepare
a couple of minutes of video in this format, i'll try if my
radeon and matrox cards can play it. What video chip is in
your laptop? If vidix or directfb do not have drivers for it,
than a function to convert from yuv422 to a supported format
will have to be provided, as Martin Wache wrote.

-------------------
Vadim Catana


From stefan at lucke.in-berlin.de  Mon Jul 11 23:01:38 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 11 Jul 2005 23:01:38 +0200
Subject: [Softdevice-devel] softdevice and 4:2:2
In-Reply-To: <1121089438.4556.1.camel@localhost.localdomain>
References: <1121006262.17754.6.camel@localhost.localdomain> <42D21273.4020508@registru.md> <1121089438.4556.1.camel@localhost.localdomain>
Message-ID: <200507112301.38477.stefan@lucke.in-berlin.de>

On Montag, 11. Juli 2005 15:43, Malcolm Caldwell wrote:
> On Mon, 2005-07-11 at 09:32 +0300, Vadim Catana wrote:
> > Martin Wache wrote:
> > > That mostly depends on if libavcodec properly decodes the samples. If it
> > > does, which I currently assume since you get some kind of picture, we
> > > just need to transform from YUV422 to YUV420 colourspace which should be
> > > easy.
> > 
> > If the videocard supports YUV422 in hardware we don't need to transform
> > anything. BTW, did you try to change the pixel format from softdevice menu ?
> 
> Is this driver dependant? On my laptop I using xv, and I don't see any
> options to change the format in the menu.

Most xv driver support YUV422 too. Do you know if it is planar or
packed format ? In the latter case, you could try to replace FOURCC_YV12
by FOURCC_YUY2 in softdevice.c in line 243 and 320. But in this color
mode, software alpha blending will produce some strange colored OSDs.

Having a short sample stream will be helpful.

> 
> > If you could record a channel with YUV422 for a couple of minutes and
> > upload it somewhere, I could take a look.
> 
> I will try to get something together for this - probably later today.
> 

-- 
Stefan Lucke



From dikranh at hotmail.com  Mon Jul 11 23:15:26 2005
From: dikranh at hotmail.com (Dikran Hovagimian)
Date: Mon, 11 Jul 2005 14:15:26 -0700
Subject: [Softdevice-devel] EPIA-M DirectFB + Softdevice Configuration
Message-ID: <BAY102-DAV1044CC00691BC11F0DB4CDBCDC0@phx.gbl>

Hi all,

I have been playing with my EPIA configuration for about a week, but I still have no good results.

I am using 2.6.9 kernel and the viafb driver.
When I load the viafb driver using "insmod viafb" and run:
vdr -P"softdevice -vo dfb:" I get garbage on the screen.
I've tried many different modes (720x576, 800x600, 640x480) but I always get the same results.
Trying to run vdr with vidix I get a black screen.

I read somewhere that I needed to install fbcon after installing viafb.  Running:
"insmod viafb" 
"insmod fbcon" 
turns the screen black.  I figured after a while that the font color is turning black.  So, when I type (very carefully on the black screen):
vdr -P"softdevice -vo dfb:" 
I get "panning buffer out of range" bug and the yres,vyres and offset are all set to the same value (looking at the code, it seems that the virtual yres should not acceed yres + offset).

But, running the vidix output:
vdr -P"softdevice -vo vidix:" 
I get a black screen with orange border and blue writings "Learning Remote Control Keys".  Regardless of what I press, VDR exits in about 5 seconds.

Can someone tell me what am I doing wrong or how to get VDR to work???

Thanks in advance,
Dikran Hovagimian
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050711/a6d8b430/attachment.html>

From malcolm.caldwell at ntu.edu.au  Tue Jul 12 02:52:01 2005
From: malcolm.caldwell at ntu.edu.au (Malcolm Caldwell)
Date: Tue, 12 Jul 2005 10:22:01 +0930
Subject: [Softdevice-devel] softdevice and 4:2:2
In-Reply-To: <200507112301.38477.stefan@lucke.in-berlin.de>
References: <1121006262.17754.6.camel@localhost.localdomain>
	 <42D21273.4020508@registru.md>
	 <1121089438.4556.1.camel@localhost.localdomain>
	 <200507112301.38477.stefan@lucke.in-berlin.de>
Message-ID: <1121129521.4246.2.camel@localhost.localdomain>

On Mon, 2005-07-11 at 23:01 +0200, Stefan Lucke wrote:
> On Montag, 11. Juli 2005 15:43, Malcolm Caldwell wrote:
> > On Mon, 2005-07-11 at 09:32 +0300, Vadim Catana wrote:
> > > Martin Wache wrote:
> > > > That mostly depends on if libavcodec properly decodes the samples. If it
> > > > does, which I currently assume since you get some kind of picture, we
> > > > just need to transform from YUV422 to YUV420 colourspace which should be
> > > > easy.
> > > 
> > > If the videocard supports YUV422 in hardware we don't need to transform
> > > anything. BTW, did you try to change the pixel format from softdevice menu ?
> > 
> > Is this driver dependant? On my laptop I using xv, and I don't see any
> > options to change the format in the menu.
> 
> Most xv driver support YUV422 too. Do you know if it is planar or
> packed format ? 

I am not sure, I guess that it is somewhat dependant on libavcodec?

Looking at it I would guess planer, but thats just a guess.

> In the latter case, you could try to replace FOURCC_YV12
> by FOURCC_YUY2 in softdevice.c in line 243 and 320. But in this color
> mode, software alpha blending will produce some strange colored OSDs.
> 
> Having a short sample stream will be helpful.

A sample stream is at http://abu.ntu.edu.au/422sample.vdr

This is not a great sample: it is just some colour bars and it seems to
crash mplayer.  It was all I could find on the sat last night (after
people had stopped watching stuff on our vdr box)
 
> > > If you could record a channel with YUV422 for a couple of minutes and
> > > upload it somewhere, I could take a look.
> > 
> > I will try to get something together for this - probably later today.
> > 
> 



From malcolm.caldwell at ntu.edu.au  Tue Jul 12 02:52:57 2005
From: malcolm.caldwell at ntu.edu.au (Malcolm Caldwell)
Date: Tue, 12 Jul 2005 10:22:57 +0930
Subject: [Softdevice-devel] softdevice and 4:2:2
In-Reply-To: <42D286D3.6090505@registru.md>
References: <1121006262.17754.6.camel@localhost.localdomain>
	 <42D15ADA.2020300@gmx.net>  <42D21273.4020508@registru.md>
	 <1121089438.4556.1.camel@localhost.localdomain>
	 <42D286D3.6090505@registru.md>
Message-ID: <1121129577.4246.4.camel@localhost.localdomain>

On Mon, 2005-07-11 at 17:48 +0300, Vadim Catana wrote:
> Malcolm Caldwell wrote:
> >>
> >>If the videocard supports YUV422 in hardware we don't need to transform
> >>anything. BTW, did you try to change the pixel format from softdevice menu ?
> > 
> > 
> > Is this driver dependant? On my laptop I using xv, and I don't see any
> > options to change the format in the menu.
> 
> I don't know about xv, but with vidix or directfb you can select
> the format of the picture from softdevice menu. It now supports
> i420, yv12 and yuy2. YUV422 can also be added. If you prepare
> a couple of minutes of video in this format, i'll try if my
> radeon and matrox cards can play it. 

See other post for a (bad) sample of video.

> What video chip is in
> your laptop? 

nvidia.

> If vidix or directfb do not have drivers for it,
> than a function to convert from yuv422 to a supported format
> will have to be provided, as Martin Wache wrote.
> 
> -------------------
> Vadim Catana
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/softdevice-devel



From nhuillard at e-dition.fr  Tue Jul 12 09:00:52 2005
From: nhuillard at e-dition.fr (Nicolas Huillard)
Date: Tue, 12 Jul 2005 09:00:52 +0200
Subject: [Softdevice-devel] softdevice and 4:2:2
In-Reply-To: <1121129521.4246.2.camel@localhost.localdomain>
References: <1121006262.17754.6.camel@localhost.localdomain>	 <42D21273.4020508@registru.md>	 <1121089438.4556.1.camel@localhost.localdomain>	 <200507112301.38477.stefan@lucke.in-berlin.de> <1121129521.4246.2.camel@localhost.localdomain>
Message-ID: <42D36AA4.9060303@e-dition.fr>

Malcolm Caldwell a ?crit :
> On Mon, 2005-07-11 at 23:01 +0200, Stefan Lucke wrote:
> 
>>Most xv driver support YUV422 too. Do you know if it is planar or
>>packed format ? 
> 
> I am not sure, I guess that it is somewhat dependant on libavcodec?
> 
> Looking at it I would guess planer, but thats just a guess.

My FX5200 here does not seem to support I422 (with free X drivers).
Pixel formats are all packet.
Type xvinfo for the full description. See attached files.

-- 
NH
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: lspci.txt
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050712/602d74d0/attachment.txt>
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: xvinfo.txt
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050712/602d74d0/attachment-0001.txt>

From stefan at lucke.in-berlin.de  Tue Jul 12 09:35:41 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 12 Jul 2005 09:35:41 +0200
Subject: [Softdevice-devel] softdevice and 4:2:2
In-Reply-To: <1121129521.4246.2.camel@localhost.localdomain>
References: <1121006262.17754.6.camel@localhost.localdomain> <200507112301.38477.stefan@lucke.in-berlin.de> <1121129521.4246.2.camel@localhost.localdomain>
Message-ID: <200507120935.41240.stefan@lucke.in-berlin.de>

On Dienstag, 12. Juli 2005 02:52, Malcolm Caldwell wrote:
> On Mon, 2005-07-11 at 23:01 +0200, Stefan Lucke wrote:
> > On Montag, 11. Juli 2005 15:43, Malcolm Caldwell wrote:
> > > On Mon, 2005-07-11 at 09:32 +0300, Vadim Catana wrote:
> > > > Martin Wache wrote:
> > > > > That mostly depends on if libavcodec properly decodes the samples. If it
> > > > > does, which I currently assume since you get some kind of picture, we
> > > > > just need to transform from YUV422 to YUV420 colourspace which should be
> > > > > easy.
> > > > 
> > > > If the videocard supports YUV422 in hardware we don't need to transform
> > > > anything. BTW, did you try to change the pixel format from softdevice menu ?
> > > 
> > > Is this driver dependant? On my laptop I using xv, and I don't see any
> > > options to change the format in the menu.
> > 
> > Most xv driver support YUV422 too. Do you know if it is planar or
> > packed format ? 
> 
> I am not sure, I guess that it is somewhat dependant on libavcodec?
> 
> Looking at it I would guess planer, but thats just a guess.

Yes, it is planar. That is ffmpeg's pix_fmt == 4. So the options are
a. convert 422 planar to 422 packed,
b. convert 422 planar to 420 planar.
c. find a way to get ffmpeg deliver 420 planar (preferred) or 422 packed.

Option "c" is would be best way. Option "b" is less cpu intensive than "a", as
it requires only touching the color components. Finally option "a"
preserves the best color quality.

> 
> > In the latter case, you could try to replace FOURCC_YV12
> > by FOURCC_YUY2 in softdevice.c in line 243 and 320. But in this color
> > mode, software alpha blending will produce some strange colored OSDs.
> > 
> > Having a short sample stream will be helpful.
> 
> A sample stream is at http://abu.ntu.edu.au/422sample.vdr

Thanks, got it.


-- 
Stefan Lucke



From anthony.hornby at cdu.edu.au  Tue Jul 12 12:38:09 2005
From: anthony.hornby at cdu.edu.au (Anthony Hornby)
Date: Tue, 12 Jul 2005 20:08:09 +0930
Subject: [Softdevice-devel] Thanks to the softdevice team
Message-ID: <1121164690.3694.3.camel@localhost.localdomain>

Hi,
I have a working setup of vdr 1.3.24 on gentoo 2005.

I am using softdevice for video output using directfb on a Matrox g550
graphics card (using tv-out cable).

I am using the bitstreamout plugin to deliver output to my denon
surround amp via the a7v600 motherboard spdif output.

The setup is great - way better than the dxr3 setup I had previously.

Just wanted to say thanks to the developer team.

Thanks a lot :-)

Anthony.


-- 
Mr Anthony Hornby RHCE BIT ALIATEC
Library Systems & Technology Coordinator
Charles Darwin University | CRICOS 300K
anthony.hornby at cdu.edu.au | office +61 8 89 466011



From lucianm at users.sourceforge.net  Tue Jul 12 13:46:29 2005
From: lucianm at users.sourceforge.net (Lucian Muresan)
Date: Tue, 12 Jul 2005 13:46:29 +0200
Subject: [Softdevice-devel] Thanks to the softdevice team
In-Reply-To: <1121164690.3694.3.camel@localhost.localdomain>
References: <1121164690.3694.3.camel@localhost.localdomain>
Message-ID: <42D3AD95.7060006@users.sourceforge.net>

Hi Anthony,

Anthony Hornby wrote:
> Hi,
> I have a working setup of vdr 1.3.24 on gentoo 2005.
> 
> I am using softdevice for video output using directfb on a Matrox g550
> graphics card (using tv-out cable).
> 
> I am using the bitstreamout plugin to deliver output to my denon
> surround amp via the a7v600 motherboard spdif output.

I'm trying to use a similar setup, but never managed to make 
bitstreamout to work (I have just a budget card, so no actual SPDIF 
output directly on the DVB card). I've connected the SPDIF-out of my 
soundcard to the external amp, and the soundcard gets the sound through 
ALSA directly from softdevice, but so far AC3 passthrough, or upmixing 
mono broadcasts to stereo, to be recognized by the external amp is not 
implemented AFAIK, I can only hear stereo MP2 broadcasts, or with some 
softdevice version, software-decoded AC3. Is there a solution to this 
with bitstreamout, or do you happen to have a "FF"-card with a physical 
SPDIF output which you just route through the motherboards sound chip?

Regards,
Lucian


From nhuillard at e-dition.fr  Tue Jul 12 19:22:33 2005
From: nhuillard at e-dition.fr (Nicolas Huillard)
Date: Tue, 12 Jul 2005 19:22:33 +0200
Subject: [Softdevice-devel] EPIA-M DirectFB + Softdevice Configuration
In-Reply-To: <BAY102-DAV1044CC00691BC11F0DB4CDBCDC0@phx.gbl>
References: <BAY102-DAV1044CC00691BC11F0DB4CDBCDC0@phx.gbl>
Message-ID: <42D3FC59.4090304@e-dition.fr>

Dikran Hovagimian a ?crit :
> Hi all,
> 
> I have been playing with my EPIA configuration for about a week, but I still have no good results.
> 
> I am using 2.6.9 kernel and the viafb driver.
> When I load the viafb driver using "insmod viafb" and run:
> vdr -P"softdevice -vo dfb:" I get garbage on the screen.
> I've tried many different modes (720x576, 800x600, 640x480) but I always get the same results.
> Trying to run vdr with vidix I get a black screen.
> 
> I read somewhere that I needed to install fbcon after installing viafb.  Running:
> "insmod viafb" 
> "insmod fbcon" 
> turns the screen black.  I figured after a while that the font color is turning black.  So, when I type (very carefully on the black screen):
> vdr -P"softdevice -vo dfb:" 
> I get "panning buffer out of range" bug and the yres,vyres and offset are all set to the same value (looking at the code, it seems that the virtual yres should not acceed yres + offset).

You must be using the viafb driver from ViaArena, which isn't DirectFB
friendly. Try the one from patcher2k (and read this thread :
http://mail.directfb.org/pipermail/directfb-users/2005-May/000268.html)

> But, running the vidix output:
> vdr -P"softdevice -vo vidix:" 
> I get a black screen with orange border and blue writings "Learning Remote Control Keys".  Regardless of what I press, VDR exits in about 5 seconds.

Vidix might work with this frame-buffer driver, and goes into learning
mode. It times-out when it does not recognize any input.
You must have some config or compile-in options that prevent VDR to
recognize your remote or keyboard.
Try to compile VDR with LIRC support, or keyboard support, and elaborate
on this.

> Can someone tell me what am I doing wrong or how to get VDR to work???
> 
> Thanks in advance,
> Dikran Hovagimian

-- 
NH


From vcatana at registru.md  Wed Jul 13 08:58:59 2005
From: vcatana at registru.md (Vadim Catana)
Date: Wed, 13 Jul 2005 09:58:59 +0300
Subject: [Softdevice-devel] [PATCH]
In-Reply-To: <42D20CFC.1060003@registru.md>
References: <42D20CFC.1060003@registru.md>
Message-ID: <42D4BBB3.2060804@registru.md>

Could someone with write access to CVS apply this patch ?

Thanks,
V.Catana


From stefan at lucke.in-berlin.de  Wed Jul 13 13:15:26 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 13 Jul 2005 13:15:26 +0200
Subject: [Softdevice-devel] [PATCH]
In-Reply-To: <42D20CFC.1060003@registru.md>
References: <42D20CFC.1060003@registru.md>
Message-ID: <200507131315.26223.stefan@lucke.in-berlin.de>

On Montag, 11. Juli 2005 08:09, Vadim Catana wrote:
> Hi,
> 
> This patch makes the following modifications to
> softdevice plugin from CVS:
> 
> 1. Some channels display white dots at the top and bottom of
>     the screen due to WSS data encoded in the picture.
>     This problem has been mentioned on vdr, linux-dvb and
>     dxr3 mailinglists a few times. I added two new items in
>     the softdevice menu that allow to cut off a number of lines
>     from top and bottom of the picture. It is implemented now
>     only for -vo vidix and dfb with i420/YV12 format and hardware
>     alpha blending.
> 
> 2. the video-vidix.c and video-dfb.c both contain code
>     that converts pictures from YV12 format to YUY2. I moved
>     this common code to a function in utils.c .
> 
> 3. fixed a couple of compiler warnings for gcc4 on x86-64.
>     And the function fast_memcpy() from utils.c does not
>     compile on x86-64, so I commented it. Please, somebody
>     fix it.

Sorry for late reply, but I'm busy with other things (garden work, ..).

Deactivating fast_memcopy I'd like to reject. Do you know a compiler
flag (define) which is set when compiling on x86-64 architectures ?
(probably ARCH_X86_64 )
If that is true, we could try something like (from mplayer;cpudetect.h):
#ifdef ARCH_X86_64
# define REG_a	"rax"
#else
# define REG_a	"eax"
#endif

or are there other problems with these function on x86_64 architectures.

-- 
Stefan Lucke



From malcolm.caldwell at ntu.edu.au  Thu Jul 14 05:02:10 2005
From: malcolm.caldwell at ntu.edu.au (Malcolm Caldwell)
Date: Thu, 14 Jul 2005 12:32:10 +0930
Subject: [Softdevice-devel] Minimum spec for a matrox based system
Message-ID: <1121310130.4446.2.camel@localhost.localdomain>

This is probably a faq but...

What is considered to be the minimum spec for a box to run the
softdevice plugin using a Matrox g400 or g550 for output.

My current system is a celeron 400Mhz machine with a dxr3, but I would
guess this is a bit slow for software decoding.  I think I will upgrade,
possibly to an newer but still quite old motherboard/cpu

Any advise?



From stefan at lucke.in-berlin.de  Thu Jul 14 09:11:27 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 14 Jul 2005 09:11:27 +0200
Subject: [Softdevice-devel] Minimum spec for a matrox based system
In-Reply-To: <1121310130.4446.2.camel@localhost.localdomain>
References: <1121310130.4446.2.camel@localhost.localdomain>
Message-ID: <200507140911.27958.stefan@lucke.in-berlin.de>

On Donnerstag, 14. Juli 2005 05:02, Malcolm Caldwell wrote:
> This is probably a faq but...
> 
> What is considered to be the minimum spec for a box to run the
> softdevice plugin using a Matrox g400 or g550 for output.
> 
> My current system is a celeron 400Mhz machine with a dxr3, but I would
> guess this is a bit slow for software decoding.  I think I will upgrade,
> possibly to an newer but still quite old motherboard/cpu
> 
> Any advise?

That depends on which types of video you'd like to view.
- For "normal" mpeg2 (720x576) I think 800MHz PIII is enough.
- DV decodes fine (with playdv) on a 1.2 GHz Celeron (PIII). VIA C3 1GHz is to slow.
- For HDTV I can offer a guess only. P4 with > 3GHz _could_ be sufficient,
  which compares to 2GHz Pentium M.

I would also recommend to stick to complete Intel platforms with older
chipsets, as there have been some troubles with DMA (damaged files)
with VIA chipsets on PIII mobos.

PS: please subscribe. Non subscriber posts have to be appoved manually.

-- 
Stefan Lucke



From marko.makela at hut.fi  Thu Jul 14 09:50:56 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 14 Jul 2005 10:50:56 +0300
Subject: [Softdevice-devel] Minimum spec for a matrox based system
In-Reply-To: <1121310130.4446.2.camel@localhost.localdomain>
References: <1121310130.4446.2.camel@localhost.localdomain>
Message-ID: <20050714075056.GA3286@localhost.localdomain>

On Thu, Jul 14, 2005 at 12:32:10PM +0930, Malcolm Caldwell wrote:
> This is probably a faq but...
> 
> What is considered to be the minimum spec for a box to run the
> softdevice plugin using a Matrox g400 or g550 for output.

I have a 900 MHz Celeron system with 128 MB of RAM and a Matrox G450
graphics card.  The VGA output (via DirectFB 0.9.22) uses much less
CPU than the TV-out.  The system uses about 35% of the available CPU
when using the I420 color space and no deinterlacing.  You will have
to leave some room for I/O waits, scheduling and the like.  I'd expect
500 MHz to be enough, but I haven't tried underclocking my system yet.

	Marko


From seppo.ingalsuo at iki.fi  Thu Jul 14 10:54:53 2005
From: seppo.ingalsuo at iki.fi (Seppo Ingalsuo)
Date: Thu, 14 Jul 2005 11:54:53 +0300
Subject: [Softdevice-devel] Remote key press when vdr starts?
Message-ID: <42D6285D.7050501@iki.fi>

Hi,

I have been using softdevice on my desktop vdr and I'm now looking 
possibilities to replace my main vdr dxr3 system with softdevice and 
hopefully some day with a 720p capable flat panel display.

I wonder why a (lirc) remote key must be pressed each time vdr starts? 
This happens even if my runvdr sript restarts vdr due to a crash. Does 
it prevent e.g. timer recordings from start properly?

Cheers,
Seppo



From ospite at studenti.unina.it  Thu Jul 14 11:16:32 2005
From: ospite at studenti.unina.it (A.O.)
Date: Thu, 14 Jul 2005 11:16:32 +0200
Subject: [Softdevice-devel] Remote key press when vdr starts?
In-Reply-To: <42D6285D.7050501@iki.fi>
References: <42D6285D.7050501@iki.fi>
Message-ID: <20050714111632.4703a66e.ospite@studenti.unina.it>

On Thu, 14 Jul 2005 11:54:53 +0300
Seppo Ingalsuo <seppo.ingalsuo at iki.fi> wrote:

> Hi,
> 
> I have been using softdevice on my desktop vdr and I'm now looking 
> possibilities to replace my main vdr dxr3 system with softdevice and 
> hopefully some day with a 720p capable flat panel display.
> 
> I wonder why a (lirc) remote key must be pressed each time vdr starts?
> This happens even if my runvdr sript restarts vdr due to a crash. Does
>  it prevent e.g. timer recordings from start properly?

Remote does not referes necessarily to lirc. You have to re-learn keys
for softdevice having focus on vdr console. This way you can use
your keys even when the focus will be on softdevice window (i use xv
out, for example). I took days to understand that :). After re-learning
the keys the message disappeared.

Bye,
   Antonio.

-- 
Public key: http://studenti.unina.it/~ospite/aopubkey.asc
  Web Site: http://studenti.unina.it/~ospite
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050714/9de88bd4/attachment.pgp>

From anthony.hornby at cdu.edu.au  Thu Jul 14 11:55:38 2005
From: anthony.hornby at cdu.edu.au (Anthony Hornby)
Date: Thu, 14 Jul 2005 19:25:38 +0930
Subject: [Softdevice-devel] Minimum spec for a matrox based system
In-Reply-To: <20050714075056.GA3286@localhost.localdomain>
References: <1121310130.4446.2.camel@localhost.localdomain>
	 <20050714075056.GA3286@localhost.localdomain>
Message-ID: <1121334938.3398.8.camel@localhost.localdomain>

Hi Malcolm,
my system uses an Athlon barton cored 2500+ (1.5 Ghz) CPU.
Here is typical usage when watching PAL TV via TV out on Matrox G550
using DirectFB with VDR 1.3.24 and softdevice 0.1.2.

I have softdevice deinterlacing set to lavc and color YUV2 - don't know
if they are the best settings.

PID USER        PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
17371 root      15   0  242m  19m 6308 S 34.5  3.8  41:34.74 vdr
17372 root      15   0  242m  19m 6308 S  1.7  3.8   1:19.76 vdr
17373 root       0 -15  242m  19m 6308 S  1.7  3.8   3:24.12 vdr
17367 root      15   0  242m  19m 6308 S  0.3  3.8   0:26.47 vdr
17369 root      15   0  242m  19m 6308 S  0.3  3.8   0:16.90 vdr
17370 root      15   0  242m  19m 6308 S  0.3  3.8   0:13.40 vdr

Hope that is useful.

Anthony.

On Thu, 2005-07-14 at 10:50 +0300, Marko M?kel? wrote:
> On Thu, Jul 14, 2005 at 12:32:10PM +0930, Malcolm Caldwell wrote:
> > This is probably a faq but...
> > 
> > What is considered to be the minimum spec for a box to run the
> > softdevice plugin using a Matrox g400 or g550 for output.
> 
> I have a 900 MHz Celeron system with 128 MB of RAM and a Matrox G450
> graphics card.  The VGA output (via DirectFB 0.9.22) uses much less
> CPU than the TV-out.  The system uses about 35% of the available CPU
> when using the I420 color space and no deinterlacing.  You will have
> to leave some room for I/O waits, scheduling and the like.  I'd expect
> 500 MHz to be enough, but I haven't tried underclocking my system yet.
> 
> 	Marko
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/softdevice-devel
-- 
Mr Anthony Hornby RHCE BIT ALIATEC
Library Systems & Technology Coordinator
Charles Darwin University | CRICOS 300K
anthony.hornby at cdu.edu.au | office +61 8 89 466011



From felix_lists at smega.com  Thu Jul 14 13:12:47 2005
From: felix_lists at smega.com (Felix)
Date: Thu, 14 Jul 2005 13:12:47 +0200
Subject: [Softdevice-devel] softdevice 0.1.2 + vdr 1.3.27 on EPIA M10000
 - flickering or hanging
In-Reply-To: <200507082334.33499.stefan@lucke.in-berlin.de>
References: <42CE756E.4040705@smega.com> <200507082334.33499.stefan@lucke.in-berlin.de>
Message-ID: <42D648AF.3080207@smega.com>

Stefan Lucke wrote:

>On Freitag, 8. Juli 2005 14:45, Felix wrote:
>  
>
>>Hi everybody,
>>
>>after one week of trying all possibilities to get live TV running on the 
>>above setup, you are my last hope.
>>
>>With fb, Live TV output is flickering like hell, and sound his jerky. It 
>>looks like i only got a third of the framerate and the output is not in 
>>sync with screen refresh. However, for about half a second after 
>>starting vdr, the output looks good.
>>    
>>
>I think M10000 is to slow for plain (unaccelerated) output "-vo fb:"
>  
>
It seems that this is not the case. Mplayer is able to play .vdr files 
over fb with about 40% CPU usage, and vdr shows good output for about 
half a second after start. The flickering which I experience is not the 
normal "framerate too low" thing. It looks more like the writing to the 
framebuffer is not in sync with the actual screen refresh. So I don't 
see a low framerate like in a video game, but it looks more like when 
you point your videocamera on a TV screen. In addition, sound has 
multiple gaps in a second, but the OSD is shown perfectly and is also 
very responsive.

>>The kernel fb is a:
>>    VIA Graphics Intergration Chipset framebuffer 0.9 initializing
>>configured at kernel startup with
>>   append="video=viafb:720x576,bpp=16"
>><mailto:softdevice-devel at lists.berlios.de>
>>When starting with dfb, vdr just locks with a black screen after giving 
>>the following output. I have to kill -9 it.
>>
>>Any hints?
>>    
>>
>
>Did you check the following thread ?
>
>http://lists.berlios.de/pipermail/softdevice-devel/2005q2/000785.html
>  
>
Thank you, I did. His problem seems to slightly different, telling from 
his output, and the proposed solutions are already in place in my machine.

... Felix



From seppo.ingalsuo at iki.fi  Thu Jul 14 14:41:41 2005
From: seppo.ingalsuo at iki.fi (Seppo Ingalsuo)
Date: Thu, 14 Jul 2005 15:41:41 +0300
Subject: [Softdevice-devel] Remote key press when vdr starts?
In-Reply-To: <20050714111632.4703a66e.ospite@studenti.unina.it>
References: <42D6285D.7050501@iki.fi> <20050714111632.4703a66e.ospite@studenti.unina.it>
Message-ID: <42D65D85.90101@iki.fi>

A.O. wrote:

>Remote does not referes necessarily to lirc. You have to re-learn keys
>for softdevice having focus on vdr console. This way you can use
>your keys even when the focus will be on softdevice window (i use xv
>out, for example). I took days to understand that :). After re-learning
>the keys the message disappeared.
>  
>
Do you have idea how to edit setup.conf to make softdevice happy with 
already learnt lirc remote keys? I don't need PC keyboard keys to 
control vdr. Those would be reserver for normal applications such as 
www, games, etc.

I plan to run vdr softdevice with -vo xv:full on X session :0.0 and 
other applications on X session :1.0. I guess XV output method is best 
suitable for a nvidia graphics card (FX5200).

Seppo



From marko.makela at hut.fi  Thu Jul 14 14:56:11 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 14 Jul 2005 15:56:11 +0300
Subject: [Softdevice-devel] Remote key press when vdr starts?
In-Reply-To: <42D65D85.90101@iki.fi>
References: <42D6285D.7050501@iki.fi> <20050714111632.4703a66e.ospite@studenti.unina.it> <42D65D85.90101@iki.fi>
Message-ID: <20050714125611.GC4266@localhost.localdomain>

On Thu, Jul 14, 2005 at 03:41:41PM +0300, Seppo Ingalsuo wrote:
> Do you have idea how to edit setup.conf to make softdevice happy with 
> already learnt lirc remote keys?

See the window title (first three lines in the OSD output).  It should
say for which interface it is trying to learn the keys.  If it's KBD,
recompile vdr.c with make NO_KBD=1.  If it's something else, add a
dummy entry to setup.conf or change the prefix of the identifiers used
for the lirc keys, whatever is appropriate.

	Marko


From malcolm.caldwell at cdu.edu.au  Thu Jul 14 17:24:54 2005
From: malcolm.caldwell at cdu.edu.au (Malcolm Caldwell)
Date: Fri, 15 Jul 2005 00:54:54 +0930
Subject: [Softdevice-devel] softdevice and 4:2:2
In-Reply-To: <200507120935.41240.stefan@lucke.in-berlin.de>
References: <1121006262.17754.6.camel@localhost.localdomain>
	 <200507112301.38477.stefan@lucke.in-berlin.de>
	 <1121129521.4246.2.camel@localhost.localdomain>
	 <200507120935.41240.stefan@lucke.in-berlin.de>
Message-ID: <1121354695.9469.8.camel@localhost.localdomain>

On Tue, 2005-07-12 at 09:35 +0200, Stefan Lucke wrote:
> On Dienstag, 12. Juli 2005 02:52, Malcolm Caldwell wrote:
> > On Mon, 2005-07-11 at 23:01 +0200, Stefan Lucke wrote:
> > > On Montag, 11. Juli 2005 15:43, Malcolm Caldwell wrote:
> > > > On Mon, 2005-07-11 at 09:32 +0300, Vadim Catana wrote:
> > > > > Martin Wache wrote:
> > > > > > That mostly depends on if libavcodec properly decodes the samples. If it
> > > > > > does, which I currently assume since you get some kind of picture, we
> > > > > > just need to transform from YUV422 to YUV420 colourspace which should be
> > > > > > easy.
> > > > > 
> > > > > If the videocard supports YUV422 in hardware we don't need to transform
> > > > > anything. BTW, did you try to change the pixel format from softdevice menu ?
> > > > 
> > > > Is this driver dependant? On my laptop I using xv, and I don't see any
> > > > options to change the format in the menu.
> > > 
> > > Most xv driver support YUV422 too. Do you know if it is planar or
> > > packed format ? 
> > 
> > I am not sure, I guess that it is somewhat dependant on libavcodec?
> > 
> > Looking at it I would guess planer, but thats just a guess.
> 
> Yes, it is planar. That is ffmpeg's pix_fmt == 4. So the options are
> a. convert 422 planar to 422 packed,
> b. convert 422 planar to 420 planar.
> c. find a way to get ffmpeg deliver 420 planar (preferred) or 422 packed.
> 
> Option "c" is would be best way. Option "b" is less cpu intensive than "a", as
> it requires only touching the color components. Finally option "a"
> preserves the best color quality.

OK, I have had a quick look, and I can't see a way to do Option c.

Here is a first-shot at support for 422 using option b.  I have used
ffmpeg's conversion code. There is probably some optimisations to do.
(eg I think mplayer has a mmx version of the conversion code)

It should also be fairly easy to support YUV444, if that is useful to
anyone.  (See the code, all that is needed is to increase the buffer
size in case of 444)

Let me know what you think.

I have also another sample of 422 video which I can upload if anyone is
interested.

> 
> > > In the latter case, you could try to replace FOURCC_YV12
> > > by FOURCC_YUY2 in softdevice.c in line 243 and 320. But in this color
> > > mode, software alpha blending will produce some strange colored OSDs.
> > > 
> > > Having a short sample stream will be helpful.
> > 
> > A sample stream is at http://abu.ntu.edu.au/422sample.vdr
> 
> Thanks, got it.

--- softdevice/mpeg2decoder.c	2005-07-15 00:27:10.000000000 +0930
+++ softdevice-0.1.2/mpeg2decoder.c	2005-05-21 20:35:59.000000000 +0930
@@ -383,8 +383,7 @@
                                          : cStreamDecoder(Context)
 {
   width = height = -1;
-  pix_fmt = PIX_FMT_NB;
-  pic_buf_lavc = pic_buf_mirror = pic_buf_pp = pic_buf_convert = NULL;
+  pic_buf_lavc = pic_buf_mirror = pic_buf_pp = NULL;
   currentMirrorMode  = setupStore.mirror;
   currentDeintMethod = setupStore.deintMethod;
 
@@ -525,10 +524,9 @@
 #endif //FB_SUPPORT
       ppLibavcodec();
 #endif //PP_LIBAVCODEC
-    libavcodec_img_convert();
+
   width  = context->width;
   height = context->height;
-  pix_fmt = context->pix_fmt;
   /*
      if ( abs(AudioStream->GetPTS() - pts)  > 10000 ) 
      {
@@ -663,36 +661,25 @@
 
 
 //------------------------------------ postproc stuff -------------------------
-uchar *cVideoStreamDecoder::allocatePicBuf(uchar *pic_buf, PixelFormat pix_fmt)
+uchar *cVideoStreamDecoder::allocatePicBuf(uchar *pic_buf)
 {
   // (re)allocate picture buffer for deinterlaced/mirrored picture
   if (pic_buf == NULL)
     fprintf(stderr,
-            "[softdevice] allocating picture buffer for resolution %dx%d "
-	    "format %d\n",
-            context->width, context->height, context->pix_fmt);
+            "[softdevice] allocating picture buffer for resolution %dx%d\n",
+            context->width, context->height);
   else
     fprintf(stderr,
-            "[softdevice] resolution changed to %dx%d, format %d - "
+            "[softdevice] resolution changed to %dx%d - "
             "reallocating picture buffer\n",
-            context->width, context->height, context->pix_fmt);
+            context->width, context->height);
+
+  pic_buf = (uchar *)realloc(pic_buf,
+                             context->width *
+                              context->height *
+                                sizeof(uchar) *
+                                  3 / 2);
 
-  if (pix_fmt==PIX_FMT_YUV420P) {
-    pic_buf = (uchar *)realloc(pic_buf,
-			       context->width *
-			       context->height *
-			       sizeof(uchar) *
-			       3 / 2);
-  } else if (pix_fmt==PIX_FMT_YUV422P) {
-    pic_buf = (uchar *)realloc(pic_buf,
-			       context->width *
-			       context->height *
-			       sizeof(uchar) *
-			       2);
-  } else {
-    fprintf(stderr,
-            "[softdevice] cannot allocate, unknown format %d",pix_fmt);
-  }    
   return pic_buf;
 }
 
@@ -711,9 +698,8 @@
 {
   if (pic_buf_lavc == NULL ||
       context->width != width ||
-      context->height != height ||
-      context->pix_fmt != pix_fmt)
-    pic_buf_lavc = allocatePicBuf(pic_buf_lavc,context->pix_fmt);
+      context->height != height)
+    pic_buf_lavc = allocatePicBuf(pic_buf_lavc);
 
   if (pic_buf_lavc)
   {
@@ -761,60 +747,6 @@
     setupStore.deintMethod = 0;
   }
 }
-void cVideoStreamDecoder::libavcodec_img_convert(void)
-{
-  if (pic_buf_convert == NULL ||
-      context->width != width ||
-      context->height != height) 
-    pic_buf_convert = allocatePicBuf(pic_buf_convert,PIX_FMT_YUV420P);
-
-  if (pic_buf_convert)
-  {
-    avpic_dest.data[0] = pic_buf_convert;
-    avpic_dest.data[1] = avpic_dest.data[0] + context->width * context->height;
-    avpic_dest.data[2] = avpic_dest.data[1] + context->width * context->height / 4;
-
-    avpic_dest.linesize[0] = context->width;
-    avpic_dest.linesize[1] = context->width / 2;
-    avpic_dest.linesize[2] = context->width / 2;
-
-    avpic_src.data[0]     = picture->data[0];
-    avpic_src.data[1]     = picture->data[1];
-    avpic_src.data[2]     = picture->data[2];
-
-    avpic_src.linesize[0] = picture->linesize[0];
-    avpic_src.linesize[1] = picture->linesize[1];
-    avpic_src.linesize[2] = picture->linesize[2];
-    
-    if (img_convert(&avpic_dest,PIX_FMT_YUV420P,
-		    &avpic_src, context->pix_fmt,
-                              context->width, context->height) < 0)
-    {
-      fprintf(stderr,
-              "[softdevice] error, libavcodec img_convert failure\n"
-              "[softdevice] switching deinterlacing off !\n");
-      /*      setupStore.deintMethod = 0;*/
-    }
-    else
-    {
-      picture->data[0]     = avpic_dest.data[0];
-      picture->data[1]     = avpic_dest.data[1];
-      picture->data[2]     = avpic_dest.data[2];
-
-      picture->linesize[0] = avpic_dest.linesize[0];
-      picture->linesize[1] = avpic_dest.linesize[1];
-      picture->linesize[2] = avpic_dest.linesize[2];
-    }
-
-  }
-  else
-  {
-    fprintf(stderr,
-            "[softdevice] no picture buffer is allocated for img_convert !\n"
-            "[softdevice] switching img_convert off !\n");
-    /*    setupStore.deintMethod = 0;*/
-  }
-}
 
 void cVideoStreamDecoder::Mirror(void)
 {
@@ -823,9 +755,8 @@
 
   if (pic_buf_mirror == NULL ||
       context->width != width ||
-      context->height != height ||
-      context->pix_fmt != pix_fmt)
-    pic_buf_mirror = allocatePicBuf(pic_buf_mirror,context->pix_fmt);
+      context->height != height)
+    pic_buf_mirror = allocatePicBuf(pic_buf_mirror);
 
   if (pic_buf_mirror)
   {
@@ -888,9 +819,8 @@
 
   if (pic_buf_pp == NULL ||
       context->width != width ||
-      context->height != height ||
-      context->pix_fmt != pix_fmt)
-    pic_buf_pp = allocatePicBuf(pic_buf_pp,context->pix_fmt);
+      context->height != height)
+    pic_buf_pp = allocatePicBuf(pic_buf_pp);
 
   if (ppcontext == NULL ||
       context->width != width ||
@@ -975,7 +905,6 @@
   }
 }
 #endif //PP_LIBAVCODEC
-
 //----------------------------- end of postproc stuff ----------------------
 
 cVideoStreamDecoder::~cVideoStreamDecoder()
--- softdevice/mpeg2decoder.h	2005-07-15 00:27:17.000000000 +0930
+++ softdevice-0.1.2/mpeg2decoder.h	2005-05-18 05:28:06.000000000 +0930
@@ -176,9 +176,8 @@
     AVPicture           avpic_src, avpic_dest;
 
     int                 width, height;
-    PixelFormat         pix_fmt;
     int                 currentDeintMethod, currentMirrorMode;
-    uchar               *pic_buf_lavc, *pic_buf_pp, *pic_buf_mirror, *pic_buf_convert;
+    uchar               *pic_buf_lavc, *pic_buf_pp, *pic_buf_mirror;
 #ifdef PP_LIBAVCODEC
     pp_mode_t           *ppmode;
     pp_context_t        *ppcontext;
@@ -197,9 +196,8 @@
     inline int frametime() 
     {return trickspeed*default_frametime;};
 
-    uchar   *allocatePicBuf(uchar *pic_buf, PixelFormat pix_fmt);
+    uchar   *allocatePicBuf(uchar *pic_buf);
     void    deintLibavcodec(void);
-    void    libavcodec_img_convert(void);
     uchar   *freePicBuf(uchar *pic_buf);
 #ifdef PP_LIBAVCODEC
     void    ppLibavcodec(void);




From M.Wache at gmx.net  Thu Jul 14 18:17:32 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 14 Jul 2005 18:17:32 +0200
Subject: [Softdevice-devel] softdevice and 4:2:2
In-Reply-To: <1121354695.9469.8.camel@localhost.localdomain>
References: <1121006262.17754.6.camel@localhost.localdomain>	 <200507112301.38477.stefan@lucke.in-berlin.de>	 <1121129521.4246.2.camel@localhost.localdomain>	 <200507120935.41240.stefan@lucke.in-berlin.de> <1121354695.9469.8.camel@localhost.localdomain>
Message-ID: <42D6901C.90606@gmx.net>

Malcolm Caldwell schrieb:
> On Tue, 2005-07-12 at 09:35 +0200, Stefan Lucke wrote:
> 
>>On Dienstag, 12. Juli 2005 02:52, Malcolm Caldwell wrote:
>>
>>>On Mon, 2005-07-11 at 23:01 +0200, Stefan Lucke wrote:
>>>
>>>>On Montag, 11. Juli 2005 15:43, Malcolm Caldwell wrote:
>>>>
>>>>>On Mon, 2005-07-11 at 09:32 +0300, Vadim Catana wrote:
>>>>>
>>>>>>Martin Wache wrote:
>>>>>>
>>>>>>>That mostly depends on if libavcodec properly decodes the samples. If it
>>>>>>>does, which I currently assume since you get some kind of picture, we
>>>>>>>just need to transform from YUV422 to YUV420 colourspace which should be
>>>>>>>easy.
>>>>>>
>>>>>>If the videocard supports YUV422 in hardware we don't need to transform
>>>>>>anything. BTW, did you try to change the pixel format from softdevice menu ?
>>>>>
>>>>>Is this driver dependant? On my laptop I using xv, and I don't see any
>>>>>options to change the format in the menu.
>>>>
>>>>Most xv driver support YUV422 too. Do you know if it is planar or
>>>>packed format ? 
>>>
>>>I am not sure, I guess that it is somewhat dependant on libavcodec?
>>>
>>>Looking at it I would guess planer, but thats just a guess.
>>
>>Yes, it is planar. That is ffmpeg's pix_fmt == 4. So the options are
>>a. convert 422 planar to 422 packed,
>>b. convert 422 planar to 420 planar.
>>c. find a way to get ffmpeg deliver 420 planar (preferred) or 422 packed.
>>
>>Option "c" is would be best way. Option "b" is less cpu intensive than "a", as
>>it requires only touching the color components. Finally option "a"
>>preserves the best color quality.
> 
> 
> OK, I have had a quick look, and I can't see a way to do Option c.
>
There is a - to my knowledge - unfinished option in libavcodec to
request pixelformats. I guess Stefan was referring to that, but I think
ffmpeg can't do that yet.

> Here is a first-shot at support for 422 using option b.  I have used
> ffmpeg's conversion code. There is probably some optimisations to do.
> (eg I think mplayer has a mmx version of the conversion code)
> 
> It should also be fairly easy to support YUV444, if that is useful to
> anyone.  (See the code, all that is needed is to increase the buffer
> size in case of 444)
> 
> Let me know what you think.
I kind of like it, it could also be used to create for instance  RGB24
formats for plain FB-out.
However in case of YUV422 to YUV420 I would prefer to do the conversion
on the fly during the copying to the video memory. That's usually much
faster since the memory transfer is slower than the CPU so during
waiting for the next data the CPU can do the conversion. It's done
already similar for YUV420 to YV12 conversion in DirectFB and vidix out.

In the case YUV422 to YUV420 we just have to average every two lines of
U and V components to one and we're done. That's just a couple of
instructions in MMX so it shouldn't even slow down the copy process.

As far as I understood you do the conversion for all pixel formats, it
would be better to call libavcodec_img_convert() only if necessary
otherwise every frame will be copied -> that's slow!!
A minor thing, you called diff with the files in the wrong sequence...

Bye,
Martin


From M.Wache at gmx.net  Thu Jul 14 18:22:57 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 14 Jul 2005 18:22:57 +0200
Subject: [Softdevice-devel] [PATCH]
In-Reply-To: <200507131315.26223.stefan@lucke.in-berlin.de>
References: <42D20CFC.1060003@registru.md> <200507131315.26223.stefan@lucke.in-berlin.de>
Message-ID: <42D69161.7050401@gmx.net>

Stefan Lucke schrieb:
> On Montag, 11. Juli 2005 08:09, Vadim Catana wrote:
> 
>>Hi,
>>
>>This patch makes the following modifications to
>>softdevice plugin from CVS:
>>
>>1. Some channels display white dots at the top and bottom of
>>    the screen due to WSS data encoded in the picture.
>>    This problem has been mentioned on vdr, linux-dvb and
>>    dxr3 mailinglists a few times. I added two new items in
>>    the softdevice menu that allow to cut off a number of lines
>>    from top and bottom of the picture. It is implemented now
>>    only for -vo vidix and dfb with i420/YV12 format and hardware
>>    alpha blending.
>>
>>2. the video-vidix.c and video-dfb.c both contain code
>>    that converts pictures from YV12 format to YUY2. I moved
>>    this common code to a function in utils.c .
>>
>>3. fixed a couple of compiler warnings for gcc4 on x86-64.
>>    And the function fast_memcpy() from utils.c does not
>>    compile on x86-64, so I commented it. Please, somebody
>>    fix it.
> 
> 
> Sorry for late reply, but I'm busy with other things (garden work, ..).
> 
> Deactivating fast_memcopy I'd like to reject. Do you know a compiler
> flag (define) which is set when compiling on x86-64 architectures ?
> (probably ARCH_X86_64 )
> If that is true, we could try something like (from mplayer;cpudetect.h):
> #ifdef ARCH_X86_64
> # define REG_a	"rax"
> #else
> # define REG_a	"eax"
> #endif
> 
> or are there other problems with these function on x86_64 architectures.
> 
After a bit of googleing I found it, the define should be __x86_64__.
Although I didn't try it yet ;-)

By the way, did you already try to replace the memcpy in vidix and
directfb with fast_memcpy? For Xv-out this improves the time spent on
the memcpy by 20%, so I guess it's worth a try...

Bye,
Martin


From torgeir at pobox.com  Thu Jul 14 18:41:33 2005
From: torgeir at pobox.com (Torgeir Veimo)
Date: Thu, 14 Jul 2005 17:41:33 +0100
Subject: [Softdevice-devel] [PATCH]
In-Reply-To: <42D69161.7050401@gmx.net>
References: <42D20CFC.1060003@registru.md>
	 <200507131315.26223.stefan@lucke.in-berlin.de>  <42D69161.7050401@gmx.net>
Message-ID: <1121359293.17790.19.camel@africa>

On Thu, 2005-07-14 at 18:22 +0200, Martin Wache wrote:

> By the way, did you already try to replace the memcpy in vidix and
> directfb with fast_memcpy? For Xv-out this improves the time spent on
> the memcpy by 20%, so I guess it's worth a try...

This must be the reason that Xv now seems almost supersmooth without any
judder, while DirectFB output doesn't seems to have improved anything..

-- 
Torgeir Veimo <torgeir at pobox.com>



From stefan at lucke.in-berlin.de  Thu Jul 14 22:18:46 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 14 Jul 2005 22:18:46 +0200
Subject: [Softdevice-devel] softdevice and 4:2:2
In-Reply-To: <1121354695.9469.8.camel@localhost.localdomain>
References: <1121006262.17754.6.camel@localhost.localdomain> <200507120935.41240.stefan@lucke.in-berlin.de> <1121354695.9469.8.camel@localhost.localdomain>
Message-ID: <200507142218.46756.stefan@lucke.in-berlin.de>

On Donnerstag, 14. Juli 2005 17:24, Malcolm Caldwell wrote:
> On Tue, 2005-07-12 at 09:35 +0200, Stefan Lucke wrote:
> > On Dienstag, 12. Juli 2005 02:52, Malcolm Caldwell wrote:
> > > On Mon, 2005-07-11 at 23:01 +0200, Stefan Lucke wrote:
> > > > On Montag, 11. Juli 2005 15:43, Malcolm Caldwell wrote:
> > > > > On Mon, 2005-07-11 at 09:32 +0300, Vadim Catana wrote:
> > > > > > Martin Wache wrote:
> > > > > > > That mostly depends on if libavcodec properly decodes the samples. If it
> > > > > > > does, which I currently assume since you get some kind of picture, we
> > > > > > > just need to transform from YUV422 to YUV420 colourspace which should be
> > > > > > > easy.
> > > > > > 
> > > > > > If the videocard supports YUV422 in hardware we don't need to transform
> > > > > > anything. BTW, did you try to change the pixel format from softdevice menu ?
> > > > > 
> > > > > Is this driver dependant? On my laptop I using xv, and I don't see any
> > > > > options to change the format in the menu.
> > > > 
> > > > Most xv driver support YUV422 too. Do you know if it is planar or
> > > > packed format ? 
> > > 
> > > I am not sure, I guess that it is somewhat dependant on libavcodec?
> > > 
> > > Looking at it I would guess planer, but thats just a guess.
> > 
> > Yes, it is planar. That is ffmpeg's pix_fmt == 4. So the options are
> > a. convert 422 planar to 422 packed,
> > b. convert 422 planar to 420 planar.
> > c. find a way to get ffmpeg deliver 420 planar (preferred) or 422 packed.
> > 
> > Option "c" is would be best way. Option "b" is less cpu intensive than "a", as
> > it requires only touching the color components. Finally option "a"
> > preserves the best color quality.
> 
> OK, I have had a quick look, and I can't see a way to do Option c.
> 
> Here is a first-shot at support for 422 using option b.  I have used
> ffmpeg's conversion code. There is probably some optimisations to do.
> (eg I think mplayer has a mmx version of the conversion code)
> 
> It should also be fairly easy to support YUV444, if that is useful to
> anyone.  (See the code, all that is needed is to increase the buffer
> size in case of 444)
> 
> Let me know what you think.
> 
> I have also another sample of 422 video which I can upload if anyone is
> interested.
> 
> > 
> > > > In the latter case, you could try to replace FOURCC_YV12
> > > > by FOURCC_YUY2 in softdevice.c in line 243 and 320. But in this color
> > > > mode, software alpha blending will produce some strange colored OSDs.
> > > > 
> > > > Having a short sample stream will be helpful.
> > > 
> > > A sample stream is at http://abu.ntu.edu.au/422sample.vdr
> > 
> > Thanks, got it.
> 
> --- softdevice/mpeg2decoder.c	2005-07-15 00:27:10.000000000 +0930
> +++ softdevice-0.1.2/mpeg2decoder.c	2005-05-21 20:35:59.000000000 +0930
> @@ -383,8 +383,7 @@
>                                           : cStreamDecoder(Context)
>  {
>    width = height = -1;
> -  pix_fmt = PIX_FMT_NB;
> -  pic_buf_lavc = pic_buf_mirror = pic_buf_pp = pic_buf_convert = NULL;
> +  pic_buf_lavc = pic_buf_mirror = pic_buf_pp = NULL;

Looks like you swapped "old" vs. "new" on your diff. Can you send
your diff as an attachment to avoid possible line breaks of mailers ?

-- 
Stefan Lucke



From malcolm.caldwell at cdu.edu.au  Fri Jul 15 07:12:56 2005
From: malcolm.caldwell at cdu.edu.au (Malcolm Caldwell)
Date: Fri, 15 Jul 2005 14:42:56 +0930
Subject: [Softdevice-devel] softdevice and 4:2:2
In-Reply-To: <42D6901C.90606@gmx.net>
References: <1121006262.17754.6.camel@localhost.localdomain>
	 <200507112301.38477.stefan@lucke.in-berlin.de>
	 <1121129521.4246.2.camel@localhost.localdomain>
	 <200507120935.41240.stefan@lucke.in-berlin.de>
	 <1121354695.9469.8.camel@localhost.localdomain>  <42D6901C.90606@gmx.net>
Message-ID: <1121404376.4447.20.camel@localhost.localdomain>

On Thu, 2005-07-14 at 18:17 +0200, Martin Wache wrote:
> Malcolm Caldwell schrieb:
> > On Tue, 2005-07-12 at 09:35 +0200, Stefan Lucke wrote:
> > 
> >>On Dienstag, 12. Juli 2005 02:52, Malcolm Caldwell wrote:
> >>
> >>>On Mon, 2005-07-11 at 23:01 +0200, Stefan Lucke wrote:
> >>>
> >>>>On Montag, 11. Juli 2005 15:43, Malcolm Caldwell wrote:
> >>>>
> >>>>>On Mon, 2005-07-11 at 09:32 +0300, Vadim Catana wrote:
> >>>>>
> >>>>>>Martin Wache wrote:
> >>>>>>
> >>>>>>>That mostly depends on if libavcodec properly decodes the samples. If it
> >>>>>>>does, which I currently assume since you get some kind of picture, we
> >>>>>>>just need to transform from YUV422 to YUV420 colourspace which should be
> >>>>>>>easy.
> >>>>>>
> >>>>>>If the videocard supports YUV422 in hardware we don't need to transform
> >>>>>>anything. BTW, did you try to change the pixel format from softdevice menu ?
> >>>>>
> >>>>>Is this driver dependant? On my laptop I using xv, and I don't see any
> >>>>>options to change the format in the menu.
> >>>>
> >>>>Most xv driver support YUV422 too. Do you know if it is planar or
> >>>>packed format ? 
> >>>
> >>>I am not sure, I guess that it is somewhat dependant on libavcodec?
> >>>
> >>>Looking at it I would guess planer, but thats just a guess.
> >>
> >>Yes, it is planar. That is ffmpeg's pix_fmt == 4. So the options are
> >>a. convert 422 planar to 422 packed,
> >>b. convert 422 planar to 420 planar.
> >>c. find a way to get ffmpeg deliver 420 planar (preferred) or 422 packed.
> >>
> >>Option "c" is would be best way. Option "b" is less cpu intensive than "a", as
> >>it requires only touching the color components. Finally option "a"
> >>preserves the best color quality.
> > 
> > 
> > OK, I have had a quick look, and I can't see a way to do Option c.
> >
> There is a - to my knowledge - unfinished option in libavcodec to
> request pixelformats. I guess Stefan was referring to that, but I think
> ffmpeg can't do that yet.
> 
> > Here is a first-shot at support for 422 using option b.  I have used
> > ffmpeg's conversion code. There is probably some optimisations to do.
> > (eg I think mplayer has a mmx version of the conversion code)
> > 
> > It should also be fairly easy to support YUV444, if that is useful to
> > anyone.  (See the code, all that is needed is to increase the buffer
> > size in case of 444)
> > 
> > Let me know what you think.
> I kind of like it, it could also be used to create for instance  RGB24
> formats for plain FB-out.
> However in case of YUV422 to YUV420 I would prefer to do the conversion
> on the fly during the copying to the video memory. That's usually much
> faster since the memory transfer is slower than the CPU so during
> waiting for the next data the CPU can do the conversion. It's done
> already similar for YUV420 to YV12 conversion in DirectFB and vidix out.
> 
> In the case YUV422 to YUV420 we just have to average every two lines of
> U and V components to one and we're done. That's just a couple of
> instructions in MMX so it shouldn't even slow down the copy process.
> 
> As far as I understood you do the conversion for all pixel formats, it
> would be better to call libavcodec_img_convert() only if necessary
> otherwise every frame will be copied -> that's slow!!
> A minor thing, you called diff with the files in the wrong sequence...

OK.  Here is a version that only calls img_convert if needed.

TODO: think about selecting the format to convert to based on what the
hardware can do.  (Currently I just convert to YUV420 regardless).  This
will require the video subplugins telling the mpegdecoder what formats
they like.


> 
> Bye,
> Martin
--- softdevice-0.1.2/mpeg2decoder.c	2005-05-21 20:35:59.000000000 +0930
+++ softdevice/mpeg2decoder.c	2005-07-15 11:36:06.000000000 +0930
@@ -383,7 +383,8 @@
                                          : cStreamDecoder(Context)
 {
   width = height = -1;
-  pic_buf_lavc = pic_buf_mirror = pic_buf_pp = NULL;
+  pix_fmt = PIX_FMT_NB;
+  pic_buf_lavc = pic_buf_mirror = pic_buf_pp = pic_buf_convert = NULL;
   currentMirrorMode  = setupStore.mirror;
   currentDeintMethod = setupStore.deintMethod;
 
@@ -524,9 +525,16 @@
 #endif //FB_SUPPORT
       ppLibavcodec();
 #endif //PP_LIBAVCODEC
-
+    if (context->pix_fmt==PIX_FMT_YUV420P) {
+      if (pic_buf_convert) {
+	pic_buf_convert=freePicBuf(pic_buf_convert);
+      }
+    } else 
+      libavcodec_img_convert();
+    
   width  = context->width;
   height = context->height;
+  pix_fmt = context->pix_fmt;
   /*
      if ( abs(AudioStream->GetPTS() - pts)  > 10000 ) 
      {
@@ -661,25 +669,36 @@
 
 
 //------------------------------------ postproc stuff -------------------------
-uchar *cVideoStreamDecoder::allocatePicBuf(uchar *pic_buf)
+uchar *cVideoStreamDecoder::allocatePicBuf(uchar *pic_buf, PixelFormat pix_fmt)
 {
   // (re)allocate picture buffer for deinterlaced/mirrored picture
   if (pic_buf == NULL)
     fprintf(stderr,
-            "[softdevice] allocating picture buffer for resolution %dx%d\n",
-            context->width, context->height);
+            "[softdevice] allocating picture buffer for resolution %dx%d "
+	    "format %d\n",
+            context->width, context->height, context->pix_fmt);
   else
     fprintf(stderr,
-            "[softdevice] resolution changed to %dx%d - "
+            "[softdevice] resolution changed to %dx%d, format %d - "
             "reallocating picture buffer\n",
-            context->width, context->height);
-
-  pic_buf = (uchar *)realloc(pic_buf,
-                             context->width *
-                              context->height *
-                                sizeof(uchar) *
-                                  3 / 2);
+            context->width, context->height, context->pix_fmt);
 
+  if (pix_fmt==PIX_FMT_YUV420P) {
+    pic_buf = (uchar *)realloc(pic_buf,
+			       context->width *
+			       context->height *
+			       sizeof(uchar) *
+			       3 / 2);
+  } else if (pix_fmt==PIX_FMT_YUV422P) {
+    pic_buf = (uchar *)realloc(pic_buf,
+			       context->width *
+			       context->height *
+			       sizeof(uchar) *
+			       2);
+  } else {
+    fprintf(stderr,
+            "[softdevice] cannot allocate, unknown format %d",pix_fmt);
+  }    
   return pic_buf;
 }
 
@@ -698,8 +717,9 @@
 {
   if (pic_buf_lavc == NULL ||
       context->width != width ||
-      context->height != height)
-    pic_buf_lavc = allocatePicBuf(pic_buf_lavc);
+      context->height != height ||
+      context->pix_fmt != pix_fmt)
+    pic_buf_lavc = allocatePicBuf(pic_buf_lavc,context->pix_fmt);
 
   if (pic_buf_lavc)
   {
@@ -747,6 +767,61 @@
     setupStore.deintMethod = 0;
   }
 }
+void cVideoStreamDecoder::libavcodec_img_convert(void)
+{
+  if (pic_buf_convert == NULL ||
+      context->width != width ||
+      context->height != height) {
+    pic_buf_convert = allocatePicBuf(pic_buf_convert,PIX_FMT_YUV420P);
+    fprintf(stderr,"allocated convert buf\n");
+  }
+
+  if (pic_buf_convert)
+  {
+    avpic_dest.data[0] = pic_buf_convert;
+    avpic_dest.data[1] = avpic_dest.data[0] + context->width * context->height;
+    avpic_dest.data[2] = avpic_dest.data[1] + context->width * context->height / 4;
+
+    avpic_dest.linesize[0] = context->width;
+    avpic_dest.linesize[1] = context->width / 2;
+    avpic_dest.linesize[2] = context->width / 2;
+
+    avpic_src.data[0]     = picture->data[0];
+    avpic_src.data[1]     = picture->data[1];
+    avpic_src.data[2]     = picture->data[2];
+
+    avpic_src.linesize[0] = picture->linesize[0];
+    avpic_src.linesize[1] = picture->linesize[1];
+    avpic_src.linesize[2] = picture->linesize[2];
+    
+    if (img_convert(&avpic_dest,PIX_FMT_YUV420P,
+		    &avpic_src, context->pix_fmt,
+                              context->width, context->height) < 0)
+    {
+      fprintf(stderr,
+              "[softdevice] error, libavcodec img_convert failure\n"
+              "[softdevice] switching deinterlacing off !\n");
+      /*      setupStore.deintMethod = 0;*/
+    }
+    else
+    {
+      picture->data[0]     = avpic_dest.data[0];
+      picture->data[1]     = avpic_dest.data[1];
+      picture->data[2]     = avpic_dest.data[2];
+
+      picture->linesize[0] = avpic_dest.linesize[0];
+      picture->linesize[1] = avpic_dest.linesize[1];
+      picture->linesize[2] = avpic_dest.linesize[2];
+    }
+
+  }
+  else
+  {
+    fprintf(stderr,
+            "[softdevice] no picture buffer is allocated for img_convert !\n"
+            "[softdevice] switching img_convert off !\n");
+  }
+}
 
 void cVideoStreamDecoder::Mirror(void)
 {
@@ -755,8 +830,9 @@
 
   if (pic_buf_mirror == NULL ||
       context->width != width ||
-      context->height != height)
-    pic_buf_mirror = allocatePicBuf(pic_buf_mirror);
+      context->height != height ||
+      context->pix_fmt != pix_fmt)
+    pic_buf_mirror = allocatePicBuf(pic_buf_mirror,context->pix_fmt);
 
   if (pic_buf_mirror)
   {
@@ -819,8 +895,9 @@
 
   if (pic_buf_pp == NULL ||
       context->width != width ||
-      context->height != height)
-    pic_buf_pp = allocatePicBuf(pic_buf_pp);
+      context->height != height ||
+      context->pix_fmt != pix_fmt)
+    pic_buf_pp = allocatePicBuf(pic_buf_pp,context->pix_fmt);
 
   if (ppcontext == NULL ||
       context->width != width ||
@@ -905,6 +982,7 @@
   }
 }
 #endif //PP_LIBAVCODEC
+
 //----------------------------- end of postproc stuff ----------------------
 
 cVideoStreamDecoder::~cVideoStreamDecoder()
--- softdevice-0.1.2/mpeg2decoder.h	2005-05-18 05:28:06.000000000 +0930
+++ softdevice/mpeg2decoder.h	2005-07-15 00:27:17.000000000 +0930
@@ -176,8 +176,9 @@
     AVPicture           avpic_src, avpic_dest;
 
     int                 width, height;
+    PixelFormat         pix_fmt;
     int                 currentDeintMethod, currentMirrorMode;
-    uchar               *pic_buf_lavc, *pic_buf_pp, *pic_buf_mirror;
+    uchar               *pic_buf_lavc, *pic_buf_pp, *pic_buf_mirror, *pic_buf_convert;
 #ifdef PP_LIBAVCODEC
     pp_mode_t           *ppmode;
     pp_context_t        *ppcontext;
@@ -196,8 +197,9 @@
     inline int frametime() 
     {return trickspeed*default_frametime;};
 
-    uchar   *allocatePicBuf(uchar *pic_buf);
+    uchar   *allocatePicBuf(uchar *pic_buf, PixelFormat pix_fmt);
     void    deintLibavcodec(void);
+    void    libavcodec_img_convert(void);
     uchar   *freePicBuf(uchar *pic_buf);
 #ifdef PP_LIBAVCODEC
     void    ppLibavcodec(void);




From vcatana at registru.md  Fri Jul 15 07:33:20 2005
From: vcatana at registru.md (Vadim Catana)
Date: Fri, 15 Jul 2005 08:33:20 +0300
Subject: [Softdevice-devel] [PATCH]
In-Reply-To: <42D69161.7050401@gmx.net>
References: <42D20CFC.1060003@registru.md> <200507131315.26223.stefan@lucke.in-berlin.de> <42D69161.7050401@gmx.net>
Message-ID: <42D74AA0.5080501@registru.md>

Martin Wache wrote:
> 
> By the way, did you already try to replace the memcpy in vidix and
> directfb with fast_memcpy? For Xv-out this improves the time spent on
> the memcpy by 20%, so I guess it's worth a try...

I couldn't try because fast_memcpy does not compile on x86_64. I was
looking at aclib.c/aclib_template.c from MPlayer and it seems that
it supports many more CPU architectures and instruction sets for
fast_memcpy. I was thinking to include these two files in softdevice
to replace it's fast_memcpy. Also, postproc directory from MPlayer
has functions for picture format convertion with support for
MMX, MMX2, SSE, SSE2, 3Dnow, including YUV422 to YUY2. This is
usefull for the problem discused in the "softdevice and 4:2:2" thread.
So, is it possible to put aclib, rgb2rgb and yuv2rgb
from MPlayer in a subdirectory and use that code in softdevice ?
This way softdevice developers will not need to spend time maintaining
that part of the code. I'll try to do this, if there're no objections.

----------
Vadim Catana



From malcolm.caldwell at cdu.edu.au  Fri Jul 15 08:31:31 2005
From: malcolm.caldwell at cdu.edu.au (Malcolm Caldwell)
Date: Fri, 15 Jul 2005 16:01:31 +0930
Subject: [Softdevice-devel] crash after I changed the OSDAlpha mode
Message-ID: <1121409091.4447.24.camel@localhost.localdomain>

Hello,

I played with the various OSD modes last night, and after could not
restart vdr.   vdr kept segfaulting.  A bit of debuging and it would
seem that memset was used on an invalid pointer.

Here is a fix.

--- softdevice-0.1.2/video.c	2005-05-21 23:50:03.000000000 +0930
+++ softdevice/video.c	2005-07-15 00:02:27.000000000 +0930
@@ -62,6 +62,7 @@
 /*----------------------------------------------------------------------------*/
 void cVideoOut::Action() 
 {
+  OsdPy = OsdPu = OsdPv = OsdPAlphaY = OsdPAlphaUV = NULL;
   init_OsdBuffers();
   ClearOSD();
 #if VDRVERSNUM >= 10307




From stefan at lucke.in-berlin.de  Fri Jul 15 09:18:50 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 15 Jul 2005 09:18:50 +0200
Subject: [Softdevice-devel] [PATCH]
In-Reply-To: <42D74AA0.5080501@registru.md>
References: <42D20CFC.1060003@registru.md> <42D69161.7050401@gmx.net> <42D74AA0.5080501@registru.md>
Message-ID: <200507150918.50413.stefan@lucke.in-berlin.de>

On Freitag, 15. Juli 2005 07:33, Vadim Catana wrote:
> Martin Wache wrote:
> > 
> > By the way, did you already try to replace the memcpy in vidix and
> > directfb with fast_memcpy? For Xv-out this improves the time spent on
> > the memcpy by 20%, so I guess it's worth a try...
> 
> I couldn't try because fast_memcpy does not compile on x86_64. I was
> looking at aclib.c/aclib_template.c from MPlayer and it seems that
> it supports many more CPU architectures and instruction sets for
> fast_memcpy. I was thinking to include these two files in softdevice
> to replace it's fast_memcpy. Also, postproc directory from MPlayer
> has functions for picture format convertion with support for
> MMX, MMX2, SSE, SSE2, 3Dnow, including YUV422 to YUY2. This is
> usefull for the problem discused in the "softdevice and 4:2:2" thread.
> So, is it possible to put aclib, rgb2rgb and yuv2rgb
> from MPlayer in a subdirectory and use that code in softdevice ?

Before including much code from other projects we need a configure
script for checking exact capabilities of current enviroment.

For some reasons I don't like those generated by autotools. Those generated
scripts are laarge (> 100 KB).

The way ffmpeg and mplayer handle this I like more. Attached is
my current hacked script with output.

> This way softdevice developers will not need to spend time maintaining
> that part of the code. I'll try to do this, if there're no objections.

Just merged your patch in my local copy with some changes:
1. moved cutTop/cutBottom to video.h
2. REG_a define is driven by #ifdef __x86_64__

and now I*m stumbling over the following change of video-dfb.c:
@@ -600,8 +606,8 @@
       else if (setupStore->pixelFormat == 2)
       {
         dlc.pixelformat = DSPF_YUY2;
-        useStretchBlit = true;
-        OSDpseudo_alpha = false;
+//		useStretchBlit = true;
+//		OSDpseudo_alpha = false;

What's the reason for that ?
Perhaps we should make stretchBlit selectable via a separate OSD option.

-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: configure
Type: text/x-configure
Size: 1265 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050715/cb88aef6/attachment.bin>
-------------- next part --------------
/tmp/softdevice-conf-6304-2942-11640.c: In function `int main()':
/tmp/softdevice-conf-6304-2942-11640.c:3: error: `DFBGraphicsDeviceDescription' 
   undeclared (first use this function)
/tmp/softdevice-conf-6304-2942-11640.c:3: error: (Each undeclared identifier is 
   reported only once for each function it appears in.)
/tmp/softdevice-conf-6304-2942-11640.c:3: error: parse error before `;' token
dfb = yes
-D_REENTRANT -D_GNU_SOURCE -I/usr/local/include/directfb -I/usr/local/include/dfb++ -L/usr/local/lib -ldfb++ -ldirectfb -lz -lfusion -ldirect -lpthread -ldl
dfb_device_desc = no
HAVE_SetSourceLocation  1
HAVE_GraphicsDeviceDescription  0

From stefan at lucke.in-berlin.de  Fri Jul 15 09:33:11 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 15 Jul 2005 09:33:11 +0200
Subject: [Softdevice-devel] crash after I changed the OSDAlpha mode
In-Reply-To: <1121409091.4447.24.camel@localhost.localdomain>
References: <1121409091.4447.24.camel@localhost.localdomain>
Message-ID: <200507150933.11202.stefan@lucke.in-berlin.de>

On Freitag, 15. Juli 2005 08:31, Malcolm Caldwell wrote:
> Hello,
> 
> I played with the various OSD modes last night, and after could not
> restart vdr.   vdr kept segfaulting.  A bit of debuging and it would
> seem that memset was used on an invalid pointer.
> 
> Here is a fix.
> 
> --- softdevice-0.1.2/video.c	2005-05-21 23:50:03.000000000 +0930
> +++ softdevice/video.c	2005-07-15 00:02:27.000000000 +0930
> @@ -62,6 +62,7 @@
>  /*----------------------------------------------------------------------------*/
>  void cVideoOut::Action() 
>  {
> +  OsdPy = OsdPu = OsdPv = OsdPAlphaY = OsdPAlphaUV = NULL;
>    init_OsdBuffers();
>    ClearOSD();
>  #if VDRVERSNUM >= 10307

Thanks, but that should be done in constructor, as thats the same
as removing pointer checks from init_OsdBuffers() and allocating
memory always.

-- 
Stefan Lucke



From vcatana at registru.md  Fri Jul 15 09:50:16 2005
From: vcatana at registru.md (Vadim Catana)
Date: Fri, 15 Jul 2005 10:50:16 +0300
Subject: [Softdevice-devel] [PATCH]
In-Reply-To: <200507150918.50413.stefan@lucke.in-berlin.de>
References: <42D20CFC.1060003@registru.md> <42D69161.7050401@gmx.net> <42D74AA0.5080501@registru.md> <200507150918.50413.stefan@lucke.in-berlin.de>
Message-ID: <42D76AB8.4040002@registru.md>

Stefan Lucke wrote:
> Just merged your patch in my local copy with some changes:
> 1. moved cutTop/cutBottom to video.h
> 2. REG_a define is driven by #ifdef __x86_64__
> 
> and now I*m stumbling over the following change of video-dfb.c:
> @@ -600,8 +606,8 @@
>        else if (setupStore->pixelFormat == 2)
>        {
>          dlc.pixelformat = DSPF_YUY2;
> -        useStretchBlit = true;
> -        OSDpseudo_alpha = false;
> +//		useStretchBlit = true;
> +//		OSDpseudo_alpha = false;
> 
> What's the reason for that ?
> Perhaps we should make stretchBlit selectable via a separate OSD option.

the reason is that the picture was flickering when I selected YUY2
from softdevice menu. I searched why that might be and did some
changes. The flickering disappeared, but don't remember if the reason
was strechBlit or software alpha blending or changes in yv12_to_yuy2 function.
I'll test this weekend how it works with and without those lines
and report the results.

-------------
Vadim Catana


From vcatana at registru.md  Fri Jul 15 10:09:19 2005
From: vcatana at registru.md (Vadim Catana)
Date: Fri, 15 Jul 2005 11:09:19 +0300
Subject: [Softdevice-devel] [PATCH]
In-Reply-To: <200507150918.50413.stefan@lucke.in-berlin.de>
References: <42D20CFC.1060003@registru.md> <42D69161.7050401@gmx.net> <42D74AA0.5080501@registru.md> <200507150918.50413.stefan@lucke.in-berlin.de>
Message-ID: <42D76F2F.7050601@registru.md>

Stefan Lucke wrote:
> Before including much code from other projects we need a configure
> script for checking exact capabilities of current enviroment.
> 
> For some reasons I don't like those generated by autotools. Those generated
> scripts are laarge (> 100 KB).
> 
> The way ffmpeg and mplayer handle this I like more. Attached is
> my current hacked script with output.

I was thinking to put some defines in the Makefile and allow
the user to select CPU and instruction set. Something like

#define ARCH_X86
#define ARCH_X86_64

#define HAVE_MMX
#define HAVE_MMX2
#define HAVE_SSE
#define HAVE_SSE2
#define HAVE_3DNOW

but a configure script would also be fine.

--------------------
Vadim Catana


From vcatana at registru.md  Fri Jul 15 10:27:31 2005
From: vcatana at registru.md (Vadim Catana)
Date: Fri, 15 Jul 2005 11:27:31 +0300
Subject: [Softdevice-devel] [PATCH]
In-Reply-To: <200507150918.50413.stefan@lucke.in-berlin.de>
References: <42D20CFC.1060003@registru.md> <42D69161.7050401@gmx.net> <42D74AA0.5080501@registru.md> <200507150918.50413.stefan@lucke.in-berlin.de>
Message-ID: <42D77373.8090004@registru.md>

Stefan Lucke wrote:
> Before including much code from other projects we need a configure
> script for checking exact capabilities of current enviroment.

BTW, vdr and other plugins could also benefit from
fast_memcpy and fast picture format conversion.
Maybe you should propose to Klaus Schmidinger to include
that code in VDR and make it available to all plugins.

----------
Vadim Catana


From M.Wache at gmx.net  Fri Jul 15 15:58:36 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Fri, 15 Jul 2005 15:58:36 +0200
Subject: [Softdevice-devel] [PATCH]
In-Reply-To: <42D76F2F.7050601@registru.md>
References: <42D20CFC.1060003@registru.md> <42D69161.7050401@gmx.net> <42D74AA0.5080501@registru.md> <200507150918.50413.stefan@lucke.in-berlin.de> <42D76F2F.7050601@registru.md>
Message-ID: <42D7C10C.9000109@gmx.net>

Vadim Catana schrieb:
> Stefan Lucke wrote:
> 
>> Before including much code from other projects we need a configure
>> script for checking exact capabilities of current enviroment.
>>
>> For some reasons I don't like those generated by autotools. Those
>> generated
>> scripts are laarge (> 100 KB).
>>
>> The way ffmpeg and mplayer handle this I like more. Attached is
>> my current hacked script with output.
> 
> 
> I was thinking to put some defines in the Makefile and allow
> the user to select CPU and instruction set. Something like
> 
> #define ARCH_X86
> #define ARCH_X86_64
> 
> #define HAVE_MMX
> #define HAVE_MMX2
> #define HAVE_SSE
> #define HAVE_SSE2
> #define HAVE_3DNOW
> 
I would like to keep the number configure options as small as possible,
that's one of the reasons why I removed most of the architectures from
mplayer's fast_memcpy. The other reason is that the performance
differences are not that big. I didn't see a measurable effect betwen
3dnow and MMX2 on my Athlon Tbird 1Ghz, so why keep it?
The only possible use of SSE would be memory transfer, it can't be used
for instance for color space transformations, so do we really need it?
Only fast processors have SSE at all so I guess even there we don't need
it (well maybe for P3 based celeron processors and P3s...).

That way we can stay with having USE_MMX and USE_MMX2 (which is
compatible with 3Dnow! in our implementation) which can stay turned on
for almost all processors and our code remains small and simple...

Yesterday I tried to compile utils.c using the build in define
__x86_64__, it worked fine for me so I will commit this change when I
find the time this weekend. If then fast_memcpy also compiles for you,
from my point of view we can commit your patch.

Martin


From M.Wache at gmx.net  Fri Jul 15 16:15:27 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Fri, 15 Jul 2005 16:15:27 +0200
Subject: [Softdevice-devel] softdevice and 4:2:2
In-Reply-To: <1121404376.4447.20.camel@localhost.localdomain>
References: <1121006262.17754.6.camel@localhost.localdomain>	 <200507112301.38477.stefan@lucke.in-berlin.de>	 <1121129521.4246.2.camel@localhost.localdomain>	 <200507120935.41240.stefan@lucke.in-berlin.de>	 <1121354695.9469.8.camel@localhost.localdomain>  <42D6901C.90606@gmx.net> <1121404376.4447.20.camel@localhost.localdomain>
Message-ID: <42D7C4FF.20705@gmx.net>

Malcolm Caldwell schrieb:
> On Thu, 2005-07-14 at 18:17 +0200, Martin Wache wrote:

>>In the case YUV422 to YUV420 we just have to average every two lines of
>>U and V components to one and we're done. That's just a couple of
>>instructions in MMX so it shouldn't even slow down the copy process.
>>
>>As far as I understood you do the conversion for all pixel formats, it
>>would be better to call libavcodec_img_convert() only if necessary
>>otherwise every frame will be copied -> that's slow!!
>>A minor thing, you called diff with the files in the wrong sequence...
> 
> 
> OK.  Here is a version that only calls img_convert if needed.
> 
> TODO: think about selecting the format to convert to based on what the
> hardware can do.  (Currently I just convert to YUV420 regardless).  This
> will require the video subplugins telling the mpegdecoder what formats
> they like.
> 
That would be a nice feature :-)
Maybe just a function in cVideoOut called with the pixelformat returning
something like "supported in hardware", "supported with fast on the fly
conversion", and "not supported" will do. But we'll also need a reliable
way to switch the pixelformats in cVideoOut ( I think mainly Xv needs
there some work...)

If there are no objections, I will do some final tests and if every
thing works fine I will commit the patch.

Martin





From malcolm.caldwell at ntu.edu.au  Fri Jul 15 09:43:48 2005
From: malcolm.caldwell at ntu.edu.au (Malcolm Caldwell)
Date: Fri, 15 Jul 2005 17:13:48 +0930
Subject: [Softdevice-devel] crash after I changed the OSDAlpha mode
In-Reply-To: <200507150933.11202.stefan@lucke.in-berlin.de>
References: <1121409091.4447.24.camel@localhost.localdomain>
	 <200507150933.11202.stefan@lucke.in-berlin.de>
Message-ID: <1121413428.4447.38.camel@localhost.localdomain>

On Fri, 2005-07-15 at 09:33 +0200, Stefan Lucke wrote:
> On Freitag, 15. Juli 2005 08:31, Malcolm Caldwell wrote:
> > Hello,
> > 
> > I played with the various OSD modes last night, and after could not
> > restart vdr.   vdr kept segfaulting.  A bit of debuging and it would
> > seem that memset was used on an invalid pointer.
> > 
> > Here is a fix.
> > 
> > --- softdevice-0.1.2/video.c	2005-05-21 23:50:03.000000000 +0930
> > +++ softdevice/video.c	2005-07-15 00:02:27.000000000 +0930
> > @@ -62,6 +62,7 @@
> >  /*----------------------------------------------------------------------------*/
> >  void cVideoOut::Action() 
> >  {
> > +  OsdPy = OsdPu = OsdPv = OsdPAlphaY = OsdPAlphaUV = NULL;
> >    init_OsdBuffers();
> >    ClearOSD();
> >  #if VDRVERSNUM >= 10307
> 
> Thanks, but that should be done in constructor, as thats the same
> as removing pointer checks from init_OsdBuffers() and allocating
> memory always.

Sorry, should have looked more closely.  Will you fix this or do you
want me to have another go?

> 



From M.Wache at gmx.net  Fri Jul 15 16:36:48 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Fri, 15 Jul 2005 16:36:48 +0200
Subject: [Softdevice-devel] crash after I changed the OSDAlpha mode
In-Reply-To: <1121413428.4447.38.camel@localhost.localdomain>
References: <1121409091.4447.24.camel@localhost.localdomain>	 <200507150933.11202.stefan@lucke.in-berlin.de> <1121413428.4447.38.camel@localhost.localdomain>
Message-ID: <42D7CA00.7080508@gmx.net>

Malcolm Caldwell schrieb:
> On Fri, 2005-07-15 at 09:33 +0200, Stefan Lucke wrote:
> 
>>On Freitag, 15. Juli 2005 08:31, Malcolm Caldwell wrote:
>>
>>>Hello,
>>>
>>>I played with the various OSD modes last night, and after could not
>>>restart vdr.   vdr kept segfaulting.  A bit of debuging and it would
>>>seem that memset was used on an invalid pointer.
>>>
>>>Here is a fix.
>>>
>>>--- softdevice-0.1.2/video.c	2005-05-21 23:50:03.000000000 +0930
>>>+++ softdevice/video.c	2005-07-15 00:02:27.000000000 +0930
>>>@@ -62,6 +62,7 @@
>>> /*----------------------------------------------------------------------------*/
>>> void cVideoOut::Action() 
>>> {
>>>+  OsdPy = OsdPu = OsdPv = OsdPAlphaY = OsdPAlphaUV = NULL;
>>>   init_OsdBuffers();
>>>   ClearOSD();
>>> #if VDRVERSNUM >= 10307
>>
>>Thanks, but that should be done in constructor, as thats the same
>>as removing pointer checks from init_OsdBuffers() and allocating
>>memory always.
> 
> 
> Sorry, should have looked more closely.  Will you fix this or do you
> want me to have another go?
> 
Since you just will have to move the line to the constructor, you don't
need to send an other patch. I will fix it this evening. Thank you for
the bug report!

Martin


From stefan at lucke.in-berlin.de  Fri Jul 15 16:59:32 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 15 Jul 2005 16:59:32 +0200
Subject: [Softdevice-devel] [PATCH]
In-Reply-To: <42D7C10C.9000109@gmx.net>
References: <42D20CFC.1060003@registru.md> <42D76F2F.7050601@registru.md> <42D7C10C.9000109@gmx.net>
Message-ID: <200507151659.32538.stefan@lucke.in-berlin.de>

On Freitag, 15. Juli 2005 15:58, Martin Wache wrote:
> Vadim Catana schrieb:
> > Stefan Lucke wrote:
> > 
> >> Before including much code from other projects we need a configure
> >> script for checking exact capabilities of current enviroment.
> >>
> >> For some reasons I don't like those generated by autotools. Those
> >> generated
> >> scripts are laarge (> 100 KB).
> >>
> >> The way ffmpeg and mplayer handle this I like more. Attached is
> >> my current hacked script with output.
> > 
> > 
> > I was thinking to put some defines in the Makefile and allow
> > the user to select CPU and instruction set. Something like
> > 
> > #define ARCH_X86
> > #define ARCH_X86_64
> > 
> > #define HAVE_MMX
> > #define HAVE_MMX2
> > #define HAVE_SSE
> > #define HAVE_SSE2
> > #define HAVE_3DNOW
> > 
> I would like to keep the number configure options as small as possible,

Full ack, as long as endusers have to edit the Makefile by hand.

..
> 
> Yesterday I tried to compile utils.c using the build in define
> __x86_64__, it worked fine for me so I will commit this change when I
> find the time this weekend. If then fast_memcpy also compiles for you,
> from my point of view we can commit your patch.

Even if there are some issues with _64 architectures we can commit that
change. For now I included Malcolms segfault fix too.


-- 
Stefan Lucke



From M.Wache at gmx.net  Fri Jul 15 18:52:25 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Fri, 15 Jul 2005 18:52:25 +0200
Subject: [Softdevice-devel] [PATCH]
In-Reply-To: <200507151659.32538.stefan@lucke.in-berlin.de>
References: <42D20CFC.1060003@registru.md> <42D76F2F.7050601@registru.md> <42D7C10C.9000109@gmx.net> <200507151659.32538.stefan@lucke.in-berlin.de>
Message-ID: <42D7E9C9.1040701@gmx.net>

Stefan Lucke schrieb:

>>Yesterday I tried to compile utils.c using the build in define
>>__x86_64__, it worked fine for me so I will commit this change when I
>>find the time this weekend. If then fast_memcpy also compiles for you,
>>from my point of view we can commit your patch.
> 
> 
> Even if there are some issues with _64 architectures we can commit that
> change. For now I included Malcolms segfault fix too.
> 

Well, the problems with 64bit are already in the CVS, so from that point
of view we shure can commit the patch. But fast_memcpy should not be
commented since this breakes Xv. So I don't have any objections against
the patch, I just want to fix the 64bit problems as well :-)

I think we should also try to fix the 2.95 compile problem before the
next release. I think there are still many debian woody based systems
out there which use gcc-2.95. Maybe using to defines one for "eax" and
one for "%eax" can solve this...

Martin





From stefan at lucke.in-berlin.de  Fri Jul 15 22:51:42 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 15 Jul 2005 22:51:42 +0200
Subject: [Softdevice-devel] [PATCH]
In-Reply-To: <42D7E9C9.1040701@gmx.net>
References: <42D20CFC.1060003@registru.md> <200507151659.32538.stefan@lucke.in-berlin.de> <42D7E9C9.1040701@gmx.net>
Message-ID: <200507152251.42867.stefan@lucke.in-berlin.de>

On Freitag, 15. Juli 2005 18:52, Martin Wache wrote:
> Stefan Lucke schrieb:
> 
> >>Yesterday I tried to compile utils.c using the build in define
> >>__x86_64__, it worked fine for me so I will commit this change when I
> >>find the time this weekend. If then fast_memcpy also compiles for you,
> >>from my point of view we can commit your patch.
> > 
> > 
> > Even if there are some issues with _64 architectures we can commit that
> > change. For now I included Malcolms segfault fix too.
> > 
> 
> Well, the problems with 64bit are already in the CVS, so from that point
> of view we shure can commit the patch. But fast_memcpy should not be
> commented since this breakes Xv. So I don't have any objections against
> the patch, I just want to fix the 64bit problems as well :-)

As things won't went worse, ...

I did the commit. But there is still as issue wiht DFB when in strechtBlit mode.
Somtimes (most), but not always when using cropBottom, 12(24) lines
from previous picture remain fixed on screen. It does not happen
with live view from ZDF, but does happen with recordings from ZDF
and others.

> 
> I think we should also try to fix the 2.95 compile problem before the
> next release. I think there are still many debian woody based systems
> out there which use gcc-2.95. Maybe using to defines one for "eax" and
> one for "%eax" can solve this...

Hm, I'll try to trigger that string concatenation problem with a short
program. So a configure script [ ;-) ] could set a define.

-- 
Stefan Lucke



From stefan at lucke.in-berlin.de  Sat Jul 16 14:53:17 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 16 Jul 2005 14:53:17 +0200
Subject: [Softdevice-devel] [PATCH]
In-Reply-To: <200507152251.42867.stefan@lucke.in-berlin.de>
References: <42D20CFC.1060003@registru.md> <42D7E9C9.1040701@gmx.net> <200507152251.42867.stefan@lucke.in-berlin.de>
Message-ID: <200507161453.17380.stefan@lucke.in-berlin.de>

On Freitag, 15. Juli 2005 22:51, Stefan Lucke wrote:
> On Freitag, 15. Juli 2005 18:52, Martin Wache wrote:
> > Stefan Lucke schrieb:
> > 
> > >>Yesterday I tried to compile utils.c using the build in define
> > >>__x86_64__, it worked fine for me so I will commit this change when I
> > >>find the time this weekend. If then fast_memcpy also compiles for you,
> > >>from my point of view we can commit your patch.
> > > 
> > > 
> > > Even if there are some issues with _64 architectures we can commit that
> > > change. For now I included Malcolms segfault fix too.
> > > 
> > 
> > Well, the problems with 64bit are already in the CVS, so from that point
> > of view we shure can commit the patch. But fast_memcpy should not be
> > commented since this breakes Xv. So I don't have any objections against
> > the patch, I just want to fix the 64bit problems as well :-)
> 
> As things won't went worse, ...
> 
> I did the commit. But there is still as issue wiht DFB when in strechtBlit mode.
> Somtimes (most), but not always when using cropBottom, 12(24) lines
> from previous picture remain fixed on screen. It does not happen
> with live view from ZDF, but does happen with recordings from ZDF
> and others.
> 

This problem is caused by DirectFB itself. I commited a workaround,
as I could not yet locate the bug in DFB.


-- 
Stefan Lucke



From voitto.tuomainen at luukku.com  Sat Jul 16 17:52:05 2005
From: voitto.tuomainen at luukku.com (Voitto Tuomainen)
Date: Sat, 16 Jul 2005 18:52:05 +0300 (EEST)
Subject: [Softdevice-devel] blue bar on left crop patch
Message-ID: <1121529125551.voitto.tuomainen.25368.LAVpE-NTzKWsHjo6If_2qA@luukku.com>

Hi,
There seems to be now implementation for cropping top and bottom part of the picture. Is it possible to have such a feature for left side of the picture too (xv)?

If someone have created such a patch, I'd like to share it.

______
BR, Voitto


...................................................................
Luukku Plus paketilla p??set eroon tila- ja turvallisuusongelmista.
Hanki Luukku Plus ja helpotat el?m??si. http://www.mtv3.fi/luukku



From seppo.ingalsuo at iki.fi  Sat Jul 16 21:45:40 2005
From: seppo.ingalsuo at iki.fi (Seppo Ingalsuo)
Date: Sat, 16 Jul 2005 22:45:40 +0300
Subject: [Softdevice-devel] Softdevice (xv) and HDTV
Message-ID: <42D963E4.4010001@iki.fi>

Hi,

With some HDTV (1080i) demo channels found from Astras, Sirius and Thor 
I see only about 1/6 picture on top left corner. There is also some 
stuttering on sound. I'm using the S-video output of nvidia FX5200. I 
tested X resolutions 720x576 and 1024x768 (obviously resampled by tv-out 
stuff). Has anyone had success in viewing HDTV with this kind of setup?  
Does it work only in VGA/DVI graphics modes?

I'm using a couple of days old softdevice CVS version. Based on some 
mail list archive search I interpreted this kind of problem has been 
noticed earlier but it has been fixed at least for some setups.

Best regards,
Seppo



From stefan at lucke.in-berlin.de  Sun Jul 17 00:45:20 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 17 Jul 2005 00:45:20 +0200
Subject: [Softdevice-devel] [PATCH]
In-Reply-To: <200507152251.42867.stefan@lucke.in-berlin.de>
References: <42D20CFC.1060003@registru.md> <42D7E9C9.1040701@gmx.net> <200507152251.42867.stefan@lucke.in-berlin.de>
Message-ID: <200507170045.20620.stefan@lucke.in-berlin.de>

On Freitag, 15. Juli 2005 22:51, Stefan Lucke wrote:
> On Freitag, 15. Juli 2005 18:52, Martin Wache wrote:

..
> > I think we should also try to fix the 2.95 compile problem before the
> > next release. I think there are still many debian woody based systems
> > out there which use gcc-2.95. Maybe using to defines one for "eax" and
> > one for "%eax" can solve this...
> 
> Hm, I'll try to trigger that string concatenation problem with a short
> program. So a configure script [ ;-) ] could set a define.

Ok. Could be check by a small program. Commited a change that prepares
utils.c for configure.

Attached is the current version of my configure script.

-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: configure
Type: text/x-configure
Size: 3519 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050717/0859847f/attachment.bin>

From stefan at lucke.in-berlin.de  Sun Jul 17 08:32:31 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 17 Jul 2005 08:32:31 +0200
Subject: [Softdevice-devel] [PATCH]
In-Reply-To: <42D74AA0.5080501@registru.md>
References: <42D20CFC.1060003@registru.md> <42D69161.7050401@gmx.net> <42D74AA0.5080501@registru.md>
Message-ID: <200507170832.31921.stefan@lucke.in-berlin.de>

On Freitag, 15. Juli 2005 07:33, Vadim Catana wrote:
> Martin Wache wrote:
> > 
> > By the way, did you already try to replace the memcpy in vidix and
> > directfb with fast_memcpy? For Xv-out this improves the time spent on
> > the memcpy by 20%, so I guess it's worth a try...
> 
> I couldn't try because fast_memcpy does not compile on x86_64. I was
> looking at aclib.c/aclib_template.c from MPlayer and it seems that
> it supports many more CPU architectures and instruction sets for
> fast_memcpy. I was thinking to include these two files in softdevice
> to replace it's fast_memcpy. Also, postproc directory from MPlayer
> has functions for picture format convertion with support for
> MMX, MMX2, SSE, SSE2, 3Dnow, including YUV422 to YUY2. This is
> usefull for the problem discused in the "softdevice and 4:2:2" thread.
> So, is it possible to put aclib, rgb2rgb and yuv2rgb
> from MPlayer in a subdirectory and use that code in softdevice ?
> This way softdevice developers will not need to spend time maintaining
> that part of the code. I'll try to do this, if there're no objections.

There are some objections. I think we had a similar discussion a while
ago. http://lists.berlios.de/pipermail/softdevice-devel/2004q4/000103.html

The "best and correct way" (tm)  to get those sophisticated conversion
functions available for softdevice (and other projects), is to integrate
them into ffmpeg. I you want to spend time on this, a patch to ffmpeg
is welcome to the ffmpeg developers (see attached mail).

-- 
Stefan Lucke
-------------- next part --------------
An embedded message was scrubbed...
From: Michael Niedermayer <michaelni at gmx.at>
Subject: Re: swscale lib
Date: Wed, 22 Dec 2004 12:59:45 +0100
Size: 3204
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050717/5eb3308d/attachment.mht>

From M.Wache at gmx.net  Sun Jul 17 11:11:42 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 17 Jul 2005 11:11:42 +0200
Subject: [Softdevice-devel] softdevice and 4:2:2
In-Reply-To: <42D7C4FF.20705@gmx.net>
References: <1121006262.17754.6.camel@localhost.localdomain>	 <200507112301.38477.stefan@lucke.in-berlin.de>	 <1121129521.4246.2.camel@localhost.localdomain>	 <200507120935.41240.stefan@lucke.in-berlin.de>	 <1121354695.9469.8.camel@localhost.localdomain>  <42D6901C.90606@gmx.net> <1121404376.4447.20.camel@localhost.localdomain> <42D7C4FF.20705@gmx.net>
Message-ID: <42DA20CE.9050104@gmx.net>

Martin Wache schrieb:
> Malcolm Caldwell schrieb:
> 
>>On Thu, 2005-07-14 at 18:17 +0200, Martin Wache wrote:
> 
> 
>>>In the case YUV422 to YUV420 we just have to average every two lines of
>>>U and V components to one and we're done. That's just a couple of
>>>instructions in MMX so it shouldn't even slow down the copy process.
>>>
>>>As far as I understood you do the conversion for all pixel formats, it
>>>would be better to call libavcodec_img_convert() only if necessary
>>>otherwise every frame will be copied -> that's slow!!
>>>A minor thing, you called diff with the files in the wrong sequence...
>>
>>
>>OK.  Here is a version that only calls img_convert if needed.
>>
>>TODO: think about selecting the format to convert to based on what the
>>hardware can do.  (Currently I just convert to YUV420 regardless).  This
>>will require the video subplugins telling the mpegdecoder what formats
>>they like.
>>
> 
> That would be a nice feature :-)
> Maybe just a function in cVideoOut called with the pixelformat returning
> something like "supported in hardware", "supported with fast on the fly
> conversion", and "not supported" will do. But we'll also need a reliable
> way to switch the pixelformats in cVideoOut ( I think mainly Xv needs
> there some work...)
> 
> If there are no objections, I will do some final tests and if every
> thing works fine I will commit the patch.

I applied the patch to the cvs and also changed the other filters to
understand YUV422 color space, inprinciple also YUV444 should be
supported as well now.

When doing this I spent quite some time getting the mirror filter
running and I got a bit annoyed about this filter. Is the mirror filter
actually usefull for anyone? I can't really imagine this since the OSD
will not be mirrored. I was about to remove it, but then I decided to
leave it for now as example for a simple filter...

Bye,
Martin


From vcatana at registru.md  Mon Jul 18 08:22:50 2005
From: vcatana at registru.md (Vadim Catana)
Date: Mon, 18 Jul 2005 09:22:50 +0300
Subject: [Softdevice-devel] [PATCH]
In-Reply-To: <42D76AB8.4040002@registru.md>
References: <42D20CFC.1060003@registru.md> <42D69161.7050401@gmx.net> <42D74AA0.5080501@registru.md> <200507150918.50413.stefan@lucke.in-berlin.de> <42D76AB8.4040002@registru.md>
Message-ID: <42DB4ABA.90408@registru.md>

Vadim Catana wrote:
> Stefan Lucke wrote:
> 
>> Just merged your patch in my local copy with some changes:
>> 1. moved cutTop/cutBottom to video.h
>> 2. REG_a define is driven by #ifdef __x86_64__
>>
>> and now I*m stumbling over the following change of video-dfb.c:
>> @@ -600,8 +606,8 @@
>>        else if (setupStore->pixelFormat == 2)
>>        {
>>          dlc.pixelformat = DSPF_YUY2;
>> -        useStretchBlit = true;
>> -        OSDpseudo_alpha = false;
>> +//        useStretchBlit = true;
>> +//        OSDpseudo_alpha = false;
>>
>> What's the reason for that ?
>> Perhaps we should make stretchBlit selectable via a separate OSD option.
> 
> 
> the reason is that the picture was flickering when I selected YUY2
> from softdevice menu. I searched why that might be and did some
> changes. The flickering disappeared, but don't remember if the reason
> was strechBlit or software alpha blending or changes in yv12_to_yuy2 
> function.
> I'll test this weekend how it works with and without those lines
> and report the results.

I tried softevice with a radeon card and those two lines uncommented.
It doesn't work, video is not visible, sound stops every second.
I looked at the radeon driver from DirectFB and the StretchBlit
function is not implemented.
Why is useStretchBlit=true only for YUY2 pixelformat ?

--------------------------
Vadim Catana





From torgeir at pobox.com  Mon Jul 18 08:26:46 2005
From: torgeir at pobox.com (Torgeir Veimo)
Date: Mon, 18 Jul 2005 07:26:46 +0100
Subject: [Softdevice-devel] [PATCH]
In-Reply-To: <42DB4ABA.90408@registru.md>
References: <42D20CFC.1060003@registru.md> <42D69161.7050401@gmx.net>
	 <42D74AA0.5080501@registru.md>
	 <200507150918.50413.stefan@lucke.in-berlin.de>
	 <42D76AB8.4040002@registru.md>  <42DB4ABA.90408@registru.md>
Message-ID: <1121668006.3308.1.camel@africa.netenviron.com>

On Mon, 2005-07-18 at 09:22 +0300, Vadim Catana wrote:
> Vadim Catana wrote:
> > Stefan Lucke wrote:
> > 
> >> Just merged your patch in my local copy with some changes:
> >> 1. moved cutTop/cutBottom to video.h
> >> 2. REG_a define is driven by #ifdef __x86_64__
> >>
> >> and now I*m stumbling over the following change of video-dfb.c:
> >> @@ -600,8 +606,8 @@
> >>        else if (setupStore->pixelFormat == 2)
> >>        {
> >>          dlc.pixelformat = DSPF_YUY2;
> >> -        useStretchBlit = true;
> >> -        OSDpseudo_alpha = false;
> >> +//        useStretchBlit = true;
> >> +//        OSDpseudo_alpha = false;
> >>
> >> What's the reason for that ?
> >> Perhaps we should make stretchBlit selectable via a separate OSD option.
> > 
> > 
> > the reason is that the picture was flickering when I selected YUY2
> > from softdevice menu. I searched why that might be and did some
> > changes. The flickering disappeared, but don't remember if the reason
> > was strechBlit or software alpha blending or changes in yv12_to_yuy2 
> > function.
> > I'll test this weekend how it works with and without those lines
> > and report the results.
> 
> I tried softevice with a radeon card and those two lines uncommented.
> It doesn't work, video is not visible, sound stops every second.
> I looked at the radeon driver from DirectFB and the StretchBlit
> function is not implemented.
> Why is useStretchBlit=true only for YUY2 pixelformat ?

This must be a R200 based card? YUY2 is not available with the radeon
driver, only the r200 driver.

-- 
Torgeir Veimo <torgeir at pobox.com>



From stefan at lucke.in-berlin.de  Mon Jul 18 10:57:04 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 18 Jul 2005 10:57:04 +0200
Subject: [Softdevice-devel] [PATCH]
In-Reply-To: <1121668006.3308.1.camel@africa.netenviron.com>
References: <42D20CFC.1060003@registru.md> <42DB4ABA.90408@registru.md> <1121668006.3308.1.camel@africa.netenviron.com>
Message-ID: <200507181057.04537.stefan@lucke.in-berlin.de>

On Montag, 18. Juli 2005 08:26, Torgeir Veimo wrote:
> On Mon, 2005-07-18 at 09:22 +0300, Vadim Catana wrote:
> > Vadim Catana wrote:
> > > Stefan Lucke wrote:
> > > 
> > >> Just merged your patch in my local copy with some changes:
> > >> 1. moved cutTop/cutBottom to video.h
> > >> 2. REG_a define is driven by #ifdef __x86_64__
> > >>
> > >> and now I*m stumbling over the following change of video-dfb.c:
> > >> @@ -600,8 +606,8 @@
> > >>        else if (setupStore->pixelFormat == 2)
> > >>        {
> > >>          dlc.pixelformat = DSPF_YUY2;
> > >> -        useStretchBlit = true;
> > >> -        OSDpseudo_alpha = false;
> > >> +//        useStretchBlit = true;
> > >> +//        OSDpseudo_alpha = false;
> > >>
> > >> What's the reason for that ?
> > >> Perhaps we should make stretchBlit selectable via a separate OSD option.
> > > 
> > > 
> > > the reason is that the picture was flickering when I selected YUY2
> > > from softdevice menu. I searched why that might be and did some
> > > changes. The flickering disappeared, but don't remember if the reason
> > > was strechBlit or software alpha blending or changes in yv12_to_yuy2 
> > > function.
> > > I'll test this weekend how it works with and without those lines
> > > and report the results.
> > 
> > I tried softevice with a radeon card and those two lines uncommented.
> > It doesn't work, video is not visible, sound stops every second.
> > I looked at the radeon driver from DirectFB and the StretchBlit
> > function is not implemented.
> > Why is useStretchBlit=true only for YUY2 pixelformat ?

Coupling YUY2 to strechtBilt has a simple reason as it is intended
for Matrox cards TV-out and usually it should not be choosen as
it requires an additional color conversion.
- Matrox BES does not work in interlaced mode.
- Matrox cards can do pixel based alpha blend of an other surface only
  via StretchBlit from YUY2 to ARGB (and mix OSD on ARGB surface).
> 
> This must be a R200 based card? YUY2 is not available with the radeon
> driver, only the r200 driver.

Can't comment on that.

-- 
Stefan Lucke



From vcatana at registru.md  Mon Jul 18 11:01:19 2005
From: vcatana at registru.md (Vadim Catana)
Date: Mon, 18 Jul 2005 12:01:19 +0300
Subject: [Softdevice-devel] [PATCH]
In-Reply-To: <1121668006.3308.1.camel@africa.netenviron.com>
References: <42D20CFC.1060003@registru.md> <42D69161.7050401@gmx.net>	 <42D74AA0.5080501@registru.md>	 <200507150918.50413.stefan@lucke.in-berlin.de>	 <42D76AB8.4040002@registru.md>  <42DB4ABA.90408@registru.md> <1121668006.3308.1.camel@africa.netenviron.com>
Message-ID: <42DB6FDF.3030000@registru.md>

Torgeir Veimo wrote:
> On Mon, 2005-07-18 at 09:22 +0300, Vadim Catana wrote:

>>I tried softevice with a radeon card and those two lines uncommented.
>>It doesn't work, video is not visible, sound stops every second.
>>I looked at the radeon driver from DirectFB and the StretchBlit
>>function is not implemented.
>>Why is useStretchBlit=true only for YUY2 pixelformat ?
> 
> 
> This must be a R200 based card? YUY2 is not available with the radeon
> driver, only the r200 driver.
> 

No, this is a Radeon 9600 (RV350) and YUY2 is available with the
radeon driver. It works with YUY2 when useStretchBlit=false.
Why is StretchBlit used in softdevice ? Copying the picture from
videoSurface to scrSurface would only slow things down. Why osdSurface
is not blited directly to videoSurface for software alpha blending ?

--------
Vadim Catana


From vcatana at registru.md  Mon Jul 18 12:33:12 2005
From: vcatana at registru.md (Vadim Catana)
Date: Mon, 18 Jul 2005 13:33:12 +0300
Subject: [Softdevice-devel] [PATCH]
In-Reply-To: <200507181057.04537.stefan@lucke.in-berlin.de>
References: <42D20CFC.1060003@registru.md> <42DB4ABA.90408@registru.md> <1121668006.3308.1.camel@africa.netenviron.com> <200507181057.04537.stefan@lucke.in-berlin.de>
Message-ID: <42DB8568.1020506@registru.md>

Stefan Lucke wrote:
  > Coupling YUY2 to strechtBilt has a simple reason as it is intended
> for Matrox cards TV-out and usually it should not be choosen as
> it requires an additional color conversion.
> - Matrox BES does not work in interlaced mode.
> - Matrox cards can do pixel based alpha blend of an other surface only
>   via StretchBlit from YUY2 to ARGB (and mix OSD on ARGB surface).

if useStretchBlit=true is used only for Matrox TV-out than
it should be placed inside those if blocks:

	if (setupStore->useMGAtv){
		...
	}

This way YUY2 could be used for other types of cards. Should I
make a patch ?

--------------
Vadim Catana


From seppo.ingalsuo at iki.fi  Mon Jul 18 13:48:50 2005
From: seppo.ingalsuo at iki.fi (Seppo Ingalsuo)
Date: Mon, 18 Jul 2005 14:48:50 +0300
Subject: [Softdevice-devel] Softdevice (xv) and HDTV
In-Reply-To: <42D963E4.4010001@iki.fi>
References: <42D963E4.4010001@iki.fi>
Message-ID: <42DB9722.7070504@iki.fi>

Seppo Ingalsuo wrote:

>
> With some HDTV (1080i) demo channels found from Astras, Sirius and 
> Thor I see only about 1/6 picture on top left corner.

This problem seems to be present also with a VGA monitor (1024x768, 60 
Hz). The console output of softdevice shows nothing critical in my 
opinion. There is one message about allocating a 1920x1080 buffer when 
zapping to EURO1080 channel, no errors reported. My graphics card is a 
Gainward NVidia FX 5200. I'm using the latest XFree86 drivers from 
NVidia. Any help in sorting this out would be very nice.

> There is also some stuttering on sound. 

It was fixed with HDTV buffering mode in softdevice setup menu.



From seppo.ingalsuo at iki.fi  Mon Jul 18 15:40:53 2005
From: seppo.ingalsuo at iki.fi (Seppo Ingalsuo)
Date: Mon, 18 Jul 2005 16:40:53 +0300
Subject: [Softdevice-devel] Softdevice (xv) and HDTV
In-Reply-To: <42DB9722.7070504@iki.fi>
References: <42D963E4.4010001@iki.fi> <42DB9722.7070504@iki.fi>
Message-ID: <42DBB165.1090805@iki.fi>

Seppo Ingalsuo wrote:

>
> This problem seems to be present also with a VGA monitor (1024x768, 60 
> Hz). The console output of softdevice shows nothing critical in my 
> opinion. There is one message about allocating a 1920x1080 buffer when 
> zapping to EURO1080 channel, no errors reported. My graphics card is a 
> Gainward NVidia FX 5200. I'm using the latest XFree86 drivers from 
> NVidia. Any help in sorting this out would be very nice.
>
I made another test with a recorded clip from Euro1080 channel. Mplayer 
plays it with -vo xv correctly so I suspect there is an error in 
softdevice xv.

Seppo



From malcolm.caldwell at cdu.edu.au  Mon Jul 18 16:40:31 2005
From: malcolm.caldwell at cdu.edu.au (Malcolm Caldwell)
Date: Tue, 19 Jul 2005 00:10:31 +0930
Subject: [Softdevice-devel] softdevice and 4:2:2
In-Reply-To: <42DA20CE.9050104@gmx.net>
References: <1121006262.17754.6.camel@localhost.localdomain>
	 <200507112301.38477.stefan@lucke.in-berlin.de>
	 <1121129521.4246.2.camel@localhost.localdomain>
	 <200507120935.41240.stefan@lucke.in-berlin.de>
	 <1121354695.9469.8.camel@localhost.localdomain>  <42D6901C.90606@gmx.net>
	 <1121404376.4447.20.camel@localhost.localdomain> <42D7C4FF.20705@gmx.net>
	 <42DA20CE.9050104@gmx.net>
Message-ID: <1121697632.4368.0.camel@localhost.localdomain>

On Sun, 2005-07-17 at 11:11 +0200, Martin Wache wrote:
> Martin Wache schrieb:
> > Malcolm Caldwell schrieb:
> > 
> >>On Thu, 2005-07-14 at 18:17 +0200, Martin Wache wrote:
> > 
> > 
> >>>In the case YUV422 to YUV420 we just have to average every two lines of
> >>>U and V components to one and we're done. That's just a couple of
> >>>instructions in MMX so it shouldn't even slow down the copy process.
> >>>
> >>>As far as I understood you do the conversion for all pixel formats, it
> >>>would be better to call libavcodec_img_convert() only if necessary
> >>>otherwise every frame will be copied -> that's slow!!
> >>>A minor thing, you called diff with the files in the wrong sequence...
> >>
> >>
> >>OK.  Here is a version that only calls img_convert if needed.
> >>
> >>TODO: think about selecting the format to convert to based on what the
> >>hardware can do.  (Currently I just convert to YUV420 regardless).  This
> >>will require the video subplugins telling the mpegdecoder what formats
> >>they like.
> >>
> > 
> > That would be a nice feature :-)
> > Maybe just a function in cVideoOut called with the pixelformat returning
> > something like "supported in hardware", "supported with fast on the fly
> > conversion", and "not supported" will do. But we'll also need a reliable
> > way to switch the pixelformats in cVideoOut ( I think mainly Xv needs
> > there some work...)
> > 
> > If there are no objections, I will do some final tests and if every
> > thing works fine I will commit the patch.
> 
> I applied the patch to the cvs and also changed the other filters to
> understand YUV422 color space, inprinciple also YUV444 should be
> supported as well now.

Ok - I tested YUV422 and it works.  Thanks!

> When doing this I spent quite some time getting the mirror filter
> running and I got a bit annoyed about this filter. Is the mirror filter
> actually usefull for anyone? I can't really imagine this since the OSD
> will not be mirrored. I was about to remove it, but then I decided to
> leave it for now as example for a simple filter...
> 
> Bye,
> Martin
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/softdevice-devel



From stefan at lucke.in-berlin.de  Mon Jul 18 16:50:49 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 18 Jul 2005 16:50:49 +0200
Subject: [Softdevice-devel] Softdevice (xv) and HDTV
In-Reply-To: <42DBB165.1090805@iki.fi>
References: <42D963E4.4010001@iki.fi> <42DB9722.7070504@iki.fi> <42DBB165.1090805@iki.fi>
Message-ID: <200507181650.49551.stefan@lucke.in-berlin.de>

On Montag, 18. Juli 2005 15:40, Seppo Ingalsuo wrote:
> Seppo Ingalsuo wrote:
> 
> >
> > This problem seems to be present also with a VGA monitor (1024x768, 60 
> > Hz). The console output of softdevice shows nothing critical in my 
> > opinion. There is one message about allocating a 1920x1080 buffer when 
> > zapping to EURO1080 channel, no errors reported. My graphics card is a 
> > Gainward NVidia FX 5200. I'm using the latest XFree86 drivers from 
> > NVidia. Any help in sorting this out would be very nice.
> >
> I made another test with a recorded clip from Euro1080 channel. Mplayer 
> plays it with -vo xv correctly so I suspect there is an error in 
> softdevice xv.

Did you try option "-vo xv:max-area" ?


-- 
Stefan Lucke



From stefan at lucke.in-berlin.de  Mon Jul 18 17:45:17 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 18 Jul 2005 17:45:17 +0200
Subject: [Softdevice-devel] [PATCH]
In-Reply-To: <42DB8568.1020506@registru.md>
References: <42D20CFC.1060003@registru.md> <200507181057.04537.stefan@lucke.in-berlin.de> <42DB8568.1020506@registru.md>
Message-ID: <200507181745.17089.stefan@lucke.in-berlin.de>

On Montag, 18. Juli 2005 12:33, Vadim Catana wrote:
> Stefan Lucke wrote:
>   > Coupling YUY2 to strechtBilt has a simple reason as it is intended
> > for Matrox cards TV-out and usually it should not be choosen as
> > it requires an additional color conversion.
> > - Matrox BES does not work in interlaced mode.
> > - Matrox cards can do pixel based alpha blend of an other surface only
> >   via StretchBlit from YUY2 to ARGB (and mix OSD on ARGB surface).
> 
> if useStretchBlit=true is used only for Matrox TV-out than
> it should be placed inside those if blocks:
> 
> 	if (setupStore->useMGAtv){
> 		...
> 	}
> 
> This way YUY2 could be used for other types of cards. Should I
> make a patch ?

As there is demand on useing YUY2 pixelformat with out stretchBlit,
I made a patch which enables selecting the stretch blitting feature
via OSD. This patch has only been tested on matrox vga out, but
should work with TV-out too.

-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: softdevice-useStretchBlit-via-OSD.diff
Type: text/x-diff
Size: 5637 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050718/4e35730b/attachment.diff>

From seppo.ingalsuo at iki.fi  Mon Jul 18 19:43:01 2005
From: seppo.ingalsuo at iki.fi (Seppo Ingalsuo)
Date: Mon, 18 Jul 2005 20:43:01 +0300
Subject: [Softdevice-devel] Softdevice (xv) and HDTV
In-Reply-To: <200507181650.49551.stefan@lucke.in-berlin.de>
References: <42D963E4.4010001@iki.fi> <42DB9722.7070504@iki.fi> <42DBB165.1090805@iki.fi> <200507181650.49551.stefan@lucke.in-berlin.de>
Message-ID: <42DBEA25.1060303@iki.fi>

Stefan Lucke wrote:

> Did you try option "-vo xv:max-area" ?

I tried it now with a HD demo from Sirius. The result is sort of OK with 
1080i material but only in a window which looks like 720x576 window in 
top left corner of a 1024x768 X root window. I'm not running a window 
manager (to maximize with mouse the vdr window) because I want to 
dedicate the entire X desktop :0.0 for softdevice in full screen mode.

With -vo xv:full I got perfect result for DVB resolutions less than or 
equal to normal PAL resolution. Is it possible to specify the output 
window size to x desktop size in max-are mode?

BR,
Seppo



From stefan at lucke.in-berlin.de  Mon Jul 18 19:54:58 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 18 Jul 2005 19:54:58 +0200
Subject: [Softdevice-devel] Softdevice (xv) and HDTV
In-Reply-To: <42DBEA25.1060303@iki.fi>
References: <42D963E4.4010001@iki.fi> <200507181650.49551.stefan@lucke.in-berlin.de> <42DBEA25.1060303@iki.fi>
Message-ID: <200507181954.59011.stefan@lucke.in-berlin.de>

On Montag, 18. Juli 2005 19:43, Seppo Ingalsuo wrote:
> Stefan Lucke wrote:
> 
> > Did you try option "-vo xv:max-area" ?
> 
> I tried it now with a HD demo from Sirius. The result is sort of OK with 
> 1080i material but only in a window which looks like 720x576 window in 
> top left corner of a 1024x768 X root window. I'm not running a window 
> manager (to maximize with mouse the vdr window) because I want to 
> dedicate the entire X desktop :0.0 for softdevice in full screen mode.
> 
> With -vo xv:full I got perfect result for DVB resolutions less than or 
> equal to normal PAL resolution. Is it possible to specify the output 
> window size to x desktop size in max-are mode?

Doesn't the combination of both "-vo xv:max-area:full"  work ?

-- 
Stefan Lucke



From seppo.ingalsuo at iki.fi  Tue Jul 19 08:10:17 2005
From: seppo.ingalsuo at iki.fi (Seppo Ingalsuo)
Date: Tue, 19 Jul 2005 09:10:17 +0300
Subject: [Softdevice-devel] Softdevice (xv) and HDTV
In-Reply-To: <200507181954.59011.stefan@lucke.in-berlin.de>
References: <42D963E4.4010001@iki.fi> <200507181650.49551.stefan@lucke.in-berlin.de> <42DBEA25.1060303@iki.fi> <200507181954.59011.stefan@lucke.in-berlin.de>
Message-ID: <42DC9949.9080704@iki.fi>

Stefan Lucke wrote:

>Doesn't the combination of both "-vo xv:max-area:full"  work ?
>
>  
>
It works! I didn't know that the options can be combined. Thanks :^)



From stefan at lucke.in-berlin.de  Tue Jul 19 11:27:03 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 19 Jul 2005 11:27:03 +0200
Subject: [Softdevice-devel] Re: [vdr] Showing aspect ratio or providing automatic widescreen switching signals
In-Reply-To: <200503202356.15200.stefan@lucke.in-berlin.de>
References: <200503201631.23629.linuxtv@foft.fsnet.co.uk> <200503202356.15200.stefan@lucke.in-berlin.de>
Message-ID: <200507191127.03519.stefan@lucke.in-berlin.de>

On Sonntag, 20. M?rz 2005 23:56, Stefan Lucke wrote:
> On Sonntag, 20. M?rz 2005 17:31, Mark Watson wrote:
> > I just got a widescreen TV and put VDR in 16:9 mode. However there is still a 
> > lot of content still in 4:3 mode and it sometimes takes me a while to spot 
> > the short/fat people and switch the TV! It would help to see the aspect on 
> > the overlay when switching channels.
> 
> Are you thinking of something like this (left to the teletext icon) ?
> 
> http://www.lucke.in-berlin.de/vdr-aspect-info.png
> 

I modified this a bit, so that stream width and hight is shown too.
This additional info is presented in channel and recording display.

http://www.lucke.in-berlin.de/vdr-stream-info.png

vdr patch is made for vdr-1.3.22, but applies to vdr-1.3.27 too
(with some offsets).

softdevice patch is for cvs version.

-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: vdr-1.3.22.GetVideoFormat-03.diff
Type: text/x-diff
Size: 3420 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050719/d1600507/attachment.diff>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: softdevice-GetVideoFormat-03.diff
Type: text/x-diff
Size: 5061 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050719/d1600507/attachment-0001.diff>

From marko.makela at hut.fi  Tue Jul 19 12:29:04 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 19 Jul 2005 13:29:04 +0300
Subject: [Softdevice-devel] Buggy behaviour when rewinding recordings
Message-ID: <20050719102904.GH4322@localhost.localdomain>

I have a clip that crashes VDR 1.3.27 and up-to-date softdevice-cvs when
rewinding it from a certain position.  Last night, I tried to narrow down
the problem, but finally I couldn't repeat it any more.  I may have
deleted that clip now.

While troubleshooting, I noticed that quite a few errors are reported
when rewinding the stream.  Maybe something can leave ffmpeg or
mpeg2decoder.c in a bad state?

I also noticed that when rewinding a recording across a 4:3 to 16:9
transition, sometimes the aspect ratio is not quite right.  It looks
like the picture is shown as 16:9, the left part is filled with
a 4:3 picture with wrong pixel aspect ratio, and the strip at the
right alternates between two frames that were shown right before
the aspect ratio switch.  I have set CropMode to 4:3.

	Marko


From stefan at lucke.in-berlin.de  Tue Jul 19 21:40:28 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 19 Jul 2005 21:40:28 +0200
Subject: [Softdevice-devel] Live view in trickspeed mode.
Message-ID: <200507192140.28659.stefan@lucke.in-berlin.de>

Hi,

when playing a recording in slowmotion and terminating trickspeed mode
with "back" key, following live view gets the same trickspeed mode as
previous playback.

I could fix that with resetting Speed to 1 in Stop() method of cMpeg2Decoder
(see attached diff).

Martin, is this the right place for resetting Speed ?

-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: trickspeed-fix.diff
Type: text/x-diff
Size: 444 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050719/332e364f/attachment.diff>

From stefan at lucke.in-berlin.de  Wed Jul 20 21:00:09 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 20 Jul 2005 21:00:09 +0200
Subject: [Softdevice-devel] blue bar on left crop patch
In-Reply-To: <1121529125551.voitto.tuomainen.25368.LAVpE-NTzKWsHjo6If_2qA@luukku.com>
References: <1121529125551.voitto.tuomainen.25368.LAVpE-NTzKWsHjo6If_2qA@luukku.com>
Message-ID: <200507202100.09425.stefan@lucke.in-berlin.de>

On Samstag, 16. Juli 2005 17:52, Voitto Tuomainen wrote:
> Hi,
> There seems to be now implementation for cropping top and bottom part of the picture. Is it possible to have such a feature for left side of the picture too (xv)?
> 
> If someone have created such a patch, I'd like to share it.

Crop left/right for xv (only) is in cvs.

-- 
Stefan Lucke



From marko.makela at hut.fi  Wed Jul 20 21:08:33 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 20 Jul 2005 22:08:33 +0300
Subject: [Softdevice-devel] blue bar on left crop patch
In-Reply-To: <200507202100.09425.stefan@lucke.in-berlin.de>
References: <1121529125551.voitto.tuomainen.25368.LAVpE-NTzKWsHjo6If_2qA@luukku.com> <200507202100.09425.stefan@lucke.in-berlin.de>
Message-ID: <20050720190833.GA9857@localhost.localdomain>

On Wed, Jul 20, 2005 at 09:00:09PM +0200, Stefan Lucke wrote:
> Crop left/right for xv (only) is in cvs.

Is this easily doable on DirectFB?

	Marko


From stefan at lucke.in-berlin.de  Wed Jul 20 22:26:20 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 20 Jul 2005 22:26:20 +0200
Subject: [Softdevice-devel] blue bar on left crop patch
In-Reply-To: <20050720190833.GA9857@localhost.localdomain>
References: <1121529125551.voitto.tuomainen.25368.LAVpE-NTzKWsHjo6If_2qA@luukku.com> <200507202100.09425.stefan@lucke.in-berlin.de> <20050720190833.GA9857@localhost.localdomain>
Message-ID: <200507202226.20649.stefan@lucke.in-berlin.de>

On Mittwoch, 20. Juli 2005 21:08, Marko M?kel? wrote:
> On Wed, Jul 20, 2005 at 09:00:09PM +0200, Stefan Lucke wrote:
> > Crop left/right for xv (only) is in cvs.
> 
> Is this easily doable on DirectFB?

Oh, that's complicated :-) . You have to re-checkout or cvs update.


-- 
Stefan Lucke



From marko.makela at hut.fi  Fri Jul 22 16:56:19 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 22 Jul 2005 17:56:19 +0300
Subject: [Softdevice-devel] blue bar on left crop patch
In-Reply-To: <200507202226.20649.stefan@lucke.in-berlin.de>
References: <1121529125551.voitto.tuomainen.25368.LAVpE-NTzKWsHjo6If_2qA@luukku.com> <200507202100.09425.stefan@lucke.in-berlin.de> <20050720190833.GA9857@localhost.localdomain> <200507202226.20649.stefan@lucke.in-berlin.de>
Message-ID: <20050722145619.GG3496@localhost.localdomain>

On Wed, Jul 20, 2005 at 10:26:20PM +0200, Stefan Lucke wrote:
> On Mittwoch, 20. Juli 2005 21:08, Marko M?kel? wrote:
> > On Wed, Jul 20, 2005 at 09:00:09PM +0200, Stefan Lucke wrote:
> > > Crop left/right for xv (only) is in cvs.
> > 
> > Is this easily doable on DirectFB?
> 
> Oh, that's complicated :-) . You have to re-checkout or cvs update.

It wasn't that easy.  I had to add #ifdef USE_SUBPLUGINS/#endif to
softdevice.c, cSoftDevice::LoadSubPlugin().  Can you please make sure
that the function compiles without -DUSE_SUBPLUGINS?

The cropping seems to work, but for some strange reason, the live stream
didn't have a blue bar at left when I tested it.

BTW, I finally got my wake-on-LAN circuit to work.  Now I can power on
my VDR box from the Hauppauge Nova-T PCI 90002 remote.  I'll post
schematics, ATtiny12 source code and pictures on a web page shortly.
The next step is to pass the "was powered on by remote" flag from the
IR connector to VDR.  That requires a modification to the cx88 kernel
modules.

	Marko


From seppo.ingalsuo at iki.fi  Fri Jul 22 17:54:33 2005
From: seppo.ingalsuo at iki.fi (Seppo Ingalsuo)
Date: Fri, 22 Jul 2005 18:54:33 +0300
Subject: [Softdevice-devel] blue bar on left crop patch
In-Reply-To: <20050722145619.GG3496@localhost.localdomain>
References: <1121529125551.voitto.tuomainen.25368.LAVpE-NTzKWsHjo6If_2qA@luukku.com> <200507202100.09425.stefan@lucke.in-berlin.de> <20050720190833.GA9857@localhost.localdomain> <200507202226.20649.stefan@lucke.in-berlin.de> <20050722145619.GG3496@localhost.localdomain>
Message-ID: <42E116B9.9010205@iki.fi>

Marko M?kel? wrote:

>
>The cropping seems to work, but for some strange reason, the live stream
>didn't have a blue bar at left when I tested it.
>  
>
Crop one line from left works for Finnish YLE broadcasts. Thanks for 
adding the feature!

BR,
Seppo



From seppo.ingalsuo at iki.fi  Fri Jul 22 18:07:22 2005
From: seppo.ingalsuo at iki.fi (Seppo Ingalsuo)
Date: Fri, 22 Jul 2005 19:07:22 +0300
Subject: [Softdevice-devel] Softplay, DVB subtitles, one failing AVI example
Message-ID: <42E119BA.1010303@iki.fi>

Hi,

I gave it a try because it is a nice replacement for mplayer script 
hacks. It worked quite well with some xvid avi clips. Here are two 
problems I noticed:

- DVB subtitles from a previously tuned channel are shown on top of 
videos (I didn't try music only). It could be a subtitles plugin problem 
as well. Is anyone here using DVB or teletext subtitles?

- With this video there is no A/V sync at all. Audio plays at normal 
speed but video is decoded rapidly much ahead from audio. It was the 
only video which behaved badly. Mplayer plays it correctly so it 
possibly is a bug in softplay.
http://www.jorihulkkonen.com/downloads/jori_divX.avi

BR,
Seppo



From stefan at lucke.in-berlin.de  Fri Jul 22 19:10:15 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 22 Jul 2005 19:10:15 +0200
Subject: [Softdevice-devel] blue bar on left crop patch
In-Reply-To: <20050722145619.GG3496@localhost.localdomain>
References: <1121529125551.voitto.tuomainen.25368.LAVpE-NTzKWsHjo6If_2qA@luukku.com> <200507202226.20649.stefan@lucke.in-berlin.de> <20050722145619.GG3496@localhost.localdomain>
Message-ID: <200507221910.15994.stefan@lucke.in-berlin.de>

On Freitag, 22. Juli 2005 16:56, Marko M?kel? wrote:
> On Wed, Jul 20, 2005 at 10:26:20PM +0200, Stefan Lucke wrote:
> > On Mittwoch, 20. Juli 2005 21:08, Marko M?kel? wrote:
> > > On Wed, Jul 20, 2005 at 09:00:09PM +0200, Stefan Lucke wrote:
> > > > Crop left/right for xv (only) is in cvs.
> > > 
> > > Is this easily doable on DirectFB?
> > 
> > Oh, that's complicated :-) . You have to re-checkout or cvs update.
> 
> It wasn't that easy.  I had to add #ifdef USE_SUBPLUGINS/#endif to
> softdevice.c, cSoftDevice::LoadSubPlugin().  Can you please make sure
> that the function compiles without -DUSE_SUBPLUGINS?

Ah, you got the other change too. Instead of increasing the number of
#if , I'd like to reduce it by including "dlfcn.h" allways. Dynamic load
is mandatory for vdr, as it is the way to load plugins.

-- snip --
Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.35
diff -b -B -U3 -r1.35 softdevice.c
--- softdevice.c        22 Jul 2005 08:24:56 -0000      1.35
+++ softdevice.c        22 Jul 2005 17:02:43 -0000
@@ -11,9 +11,7 @@
 #include <getopt.h>
 #include <stdlib.h>

-#ifdef USE_SUBPLUGINS
 #include <dlfcn.h>
-#endif

 #if VDRVERSNUM >= 10307
 #include <vdr/osd.h>
-- snip --

> 
> The cropping seems to work, but for some strange reason, the live stream
> didn't have a blue bar at left when I tested it.

The blue bar might have an other reason too. Once I had one, on the
right side (1 pixel column). It happend with an X-window at 16:9 size
and 4:3 video source.  I did some full screen toggles and crop mode
changes and the blue bar was at the end of the 4:3 area. But I was
never able to get it again.


-- 
Stefan Lucke



From stefan at lucke.in-berlin.de  Fri Jul 22 19:59:32 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 22 Jul 2005 19:59:32 +0200
Subject: [Softdevice-devel] blue bar on left crop patch
In-Reply-To: <20050722145619.GG3496@localhost.localdomain>
References: <1121529125551.voitto.tuomainen.25368.LAVpE-NTzKWsHjo6If_2qA@luukku.com> <200507202226.20649.stefan@lucke.in-berlin.de> <20050722145619.GG3496@localhost.localdomain>
Message-ID: <200507221959.32063.stefan@lucke.in-berlin.de>

On Freitag, 22. Juli 2005 16:56, Marko M?kel? wrote:
> On Wed, Jul 20, 2005 at 10:26:20PM +0200, Stefan Lucke wrote:
> > On Mittwoch, 20. Juli 2005 21:08, Marko M?kel? wrote:
> > > On Wed, Jul 20, 2005 at 09:00:09PM +0200, Stefan Lucke wrote:
> > > > Crop left/right for xv (only) is in cvs.
> > > 
> > > Is this easily doable on DirectFB?
> > 
> > Oh, that's complicated :-) . You have to re-checkout or cvs update.
> 
> It wasn't that easy.  I had to add #ifdef USE_SUBPLUGINS/#endif to
> softdevice.c, cSoftDevice::LoadSubPlugin().  Can you please make sure
> that the function compiles without -DUSE_SUBPLUGINS?
> 

Removed ifdef'ed include of "dlfcn.h"


-- 
Stefan Lucke



From stefan at lucke.in-berlin.de  Fri Jul 22 19:59:35 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 22 Jul 2005 19:59:35 +0200
Subject: [Softdevice-devel] Softplay, DVB subtitles, one failing AVI example
In-Reply-To: <42E119BA.1010303@iki.fi>
References: <42E119BA.1010303@iki.fi>
Message-ID: <200507221959.35181.stefan@lucke.in-berlin.de>

On Freitag, 22. Juli 2005 18:07, Seppo Ingalsuo wrote:
> Hi,
> 
> I gave it a try because it is a nice replacement for mplayer script 
> hacks. It worked quite well with some xvid avi clips. Here are two 
> problems I noticed:
> 
> - DVB subtitles from a previously tuned channel are shown on top of 
> videos (I didn't try music only). It could be a subtitles plugin problem 
> as well. Is anyone here using DVB or teletext subtitles?
> 
> - With this video there is no A/V sync at all. Audio plays at normal 
> speed but video is decoded rapidly much ahead from audio. It was the 
> only video which behaved badly. Mplayer plays it correctly so it 
> possibly is a bug in softplay.
> http://www.jorihulkkonen.com/downloads/jori_divX.avi

A work around for this is in softdevice cvs. For some reason, frametime
calculation fails. In such a case, a minimum frametime of 40ms is choosen.
-- 
Stefan Lucke



From marko.makela at hut.fi  Sat Jul 23 14:12:53 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sat, 23 Jul 2005 15:12:53 +0300
Subject: [Softdevice-devel] blue bar on left crop patch
In-Reply-To: <20050722145619.GG3496@localhost.localdomain>
References: <1121529125551.voitto.tuomainen.25368.LAVpE-NTzKWsHjo6If_2qA@luukku.com> <200507202100.09425.stefan@lucke.in-berlin.de> <20050720190833.GA9857@localhost.localdomain> <200507202226.20649.stefan@lucke.in-berlin.de> <20050722145619.GG3496@localhost.localdomain>
Message-ID: <20050723121253.GA354122@kosh.hut.fi>

On Fri, Jul 22, 2005 at 05:56:19PM +0300, Marko M?kel? wrote:
> The cropping seems to work, but for some strange reason, the live stream
> didn't have a blue bar at left when I tested it.

Now I tested it with a recording.  Cropping 2 pixels makes the blue line
go fully away.

Would it be possible to crop before scaling, i.e., if I select
CropMode 4:3 and the source is 16:9, the blue bar won't be visible
to start with.  Thus, the extra cropping would remove useful pixels
from the screen.

Another thing: does anyone know what the "cx22702_set_tps: Autodetecting"
kernel messages are about?  I didn't see them on the 2.6.11.6 kernel,
but they appear very frequently on the 2.6.12.3.  The message is printed in
drivers/media/dvb/frontends/cx22702.c.

One more thing: I got some warnings and errors when compiling the source
with g++ 4.0.1 (the default in Debian GNU/Linux unstable).  They were
trivial to fix, and everything seems to work.

	Marko


From stefan at lucke.in-berlin.de  Sat Jul 23 22:27:53 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 23 Jul 2005 22:27:53 +0200
Subject: [Softdevice-devel] blue bar on left crop patch
In-Reply-To: <20050723121253.GA354122@kosh.hut.fi>
References: <1121529125551.voitto.tuomainen.25368.LAVpE-NTzKWsHjo6If_2qA@luukku.com> <20050722145619.GG3496@localhost.localdomain> <20050723121253.GA354122@kosh.hut.fi>
Message-ID: <200507232227.53886.stefan@lucke.in-berlin.de>

On Samstag, 23. Juli 2005 14:12, Marko M?kel? wrote:
> On Fri, Jul 22, 2005 at 05:56:19PM +0300, Marko M?kel? wrote:
> > The cropping seems to work, but for some strange reason, the live stream
> > didn't have a blue bar at left when I tested it.
> 
> Now I tested it with a recording.  Cropping 2 pixels makes the blue line
> go fully away.
> 
> Would it be possible to crop before scaling, i.e., if I select
> CropMode 4:3 and the source is 16:9, the blue bar won't be visible
> to start with.  Thus, the extra cropping would remove useful pixels
> from the screen.

Hm, disable crop left/right when there is already a horizontal cropping
active and make this selectable via OSD. Disable crop top/bottom
when there is another vertical cropping active and make this selectable
via OSD too. I guess the number of setup options will confuse a normal
user and reduce the WAF (Women Acceptance Factor).

[ .. ]

> One more thing: I got some warnings and errors when compiling the source
> with g++ 4.0.1 (the default in Debian GNU/Linux unstable).  They were
> trivial to fix, and everything seems to work.

Can you provide a patch ?

-- 
Stefan Lucke



From stefan at lucke.in-berlin.de  Sat Jul 23 23:52:10 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 23 Jul 2005 23:52:10 +0200
Subject: [Softdevice-devel] Next release ?!
Message-ID: <200507232352.10207.stefan@lucke.in-berlin.de>

Hi,

the last release is more than two months old. In the past few
days, there has been a new feature "cropping" (thanks to Vadim).
So I'd like to release a new version (0.2.0) soon. Hopefully cvs
version get's a bit more tests.

As there are only a few people subscribed to cvs commit list, I want
to offer the last changes (since 0.1.2) from CHANGELOG here too:

2005-07-23:
    - vidix-out:
      - some cosmetic cleanups
      - force OSD mode pseudo when YUY2 pixelformat is choosen
2005-07-22:
    - changed pause OSD handling in software drawing mode
    - work around for some *.avi files where frametime is zero
    - fix previously introduced compile fail without -DUSE_SUBPLUGINS
    - include patch from Claas Hilbrecht for "-vo dummy:"
    - some code reorg for subpluging loader
2005-07-20:
    - fix for live view at trick speed
    - stretchBlit mode for dfb-out is selectable via OSD
    - cropLeft/Right for xv-out and dfb-out
    - exclude cropTop/Bottom OSD from fb-out
    - adjusted vidix-out call of yv12_to_yuy2() to dfb-out
2005-07-17:
    - crop Top/Bottom for xv-out
    - introduce colour space conversion (by Malcom Caldwell)
    - make filters work with YUV422 color space
2005-07-16:
    - fix for cropBottom in dfb with YUY2 pixelformat
    - some preparations for configure in video-dfb.c
    - some preparations for configure in utils.c
2005-07-15:
    - by Vadim Catana:
      - fixed a couple of compiler warnings for gcc4 on x86-64
      - the video-vidix.c and video-dfb.c both contain code
        that converts pictures from YV12 format to YUY2. I moved
        this common code to a function in utils.c .
      - Some channels display white dots at the top and bottom of
        the screen due to WSS data encoded in the picture.
        This problem has been mentioned on vdr, linux-dvb and
        dxr3 mailinglists a few times. I added two new items in
        the softdevice menu that allow to cut off a number of lines
        from top and bottom of the picture. It is implemented now
        only for -vo vidix and dfb with i420/YV12 format and hardware
        alpha blending.
    - by Malcolm Caldwell: fix for vdr segfaulting
2005-07-03:
    - fix fullscreen mode for 64-bit architectures
    - improve response time for 60-sec skips
2005-06-30:
    - changed delay clamping low limit and printout "+" if we drop frames
    - dfb: report current frame duration
    - dfb: activated device specific delay handling
2005-06-28:
    - fix for loosing window dimensions upon switching from fullscreen mode to windowed mode
2005-06-26:
    - fix compile issue with recent gcc versions (patch by alexw)
2005-06-18:
    - provide error message on stderr when Xv plugin cannot connect to X server.
2005-06-12:
    - no new audio frame has been decoded when audio_size <= 0
       (reported by Antonio O.)
    - introduce fast_memcpy (gives 20-30% speed increase on copying)
    - switch xv-out to fast_memcpy
    - enable fast and default deblock postprocessing
    - make buffersizes choosable
2005-06-06:
    - fixed latest ffmpeg cvs compile issue
    - applied fix for noisy audio on some soundcards (by Antonio O.)
    - applied GetDeviceDescription() patch for video-dfb.c (by Lucian Muresan)
2005-06-05:
    - compile by default with "-g"
    - fix vidix segfault
2005-05-29:
    - changed screen aspect ratio selection (based on suggestion by Nicolas Huillard)
    - fix some segfaults on bad signal
    - fix possible segfault when called without arguments 
      (thanks to Marko M?kel?)
    - buffering is now complety signal triggered
    - made buffersizes variable

-- 
Stefan Lucke



From marko.makela at hut.fi  Sun Jul 24 00:34:02 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sun, 24 Jul 2005 01:34:02 +0300
Subject: [Softdevice-devel] blue bar on left crop patch
In-Reply-To: <200507232227.53886.stefan@lucke.in-berlin.de>
References: <1121529125551.voitto.tuomainen.25368.LAVpE-NTzKWsHjo6If_2qA@luukku.com> <20050722145619.GG3496@localhost.localdomain> <20050723121253.GA354122@kosh.hut.fi> <200507232227.53886.stefan@lucke.in-berlin.de>
Message-ID: <20050723223402.GA4052@localhost.localdomain>

On Sat, Jul 23, 2005 at 10:27:53PM +0200, Stefan Lucke wrote:
> Hm, disable crop left/right when there is already a horizontal cropping
> active and make this selectable via OSD. Disable crop top/bottom
> when there is another vertical cropping active and make this selectable
> via OSD too. I guess the number of setup options will confuse a normal
> user and reduce the WAF (Women Acceptance Factor).

Why would you need another configuration option?  The purpose of the
crop left/right/up/down settings is to remove junk from the pixel data.
If if that pixel data has already been cropped because of a CropMode
setting, why would you need this?

Is it necessary to have the crop settings (or other seldomly used
settings) on OSD?  Would it suffice to have them in the configuration
file only?

> > One more thing: I got some warnings and errors when compiling the source
> > with g++ 4.0.1 (the default in Debian GNU/Linux unstable).  They were
> > trivial to fix, and everything seems to work.
> 
> Can you provide a patch ?

If I remember correctly, all errors were in the VDR code, maybe all related
to the patches supplied with the subtitles plugin.  I didn't fix any warnings.

Doh, my wake-on-remote device still can't signal if the computer was
powered on by remote or not, and I spent several hours debugging.
I also figured out how to read the signal (the initial state of the
IR input) in the cx88 driver.  I guess the status is best passed to
user space via some special ioctl.  I don't think my patches related
to this will have any chance of getting accepted to the kernel,
softdevice or VDR.

	Marko


From babble at brainhawk.de  Sun Jul 24 01:41:00 2005
From: babble at brainhawk.de (Bjoern Adler)
Date: Sun, 24 Jul 2005 01:41:00 +0200
Subject: [Softdevice-devel] Problem compiling softdevice v0.1.2 and also CVS
Message-ID: <42E2D58C.70008@brainhawk.de>

Hi all,

I'm not really sure whether the problem is between my ears or in the 
sourcecode.

Whenn trying to compile softdevice 0.1.2 or the CVS version, it always 
stops with error.

"
mpeg2decoder.c: In member function `void cMpeg2Decoder::initStream()':
mpeg2decoder.c:1030: error: invalid conversion from `int (*)(void*, long 
long
    int, int)' to `offset_t (*)(void*, long long int, int)'
mpeg2decoder.c: In member function `void cMpeg2Decoder::QueuePacket(const
    AVFormatContext*, AVPacket&)':
mpeg2decoder.c:1100: error: request for member `codec_type' in `
 
ic->AVFormatContext::streams[pkt->AVPacket::stream_index]->AVStream::codec',
    which is of non-class type `AVCodecContext*'
mpeg2decoder.c:1112: error: no matching function for call to `
    cAudioStreamDecoder::cAudioStreamDecoder(AVCodecContext**, 
cAudioOut*&, int&
    )'
mpeg2decoder.h:136: error: candidates are:
    cAudioStreamDecoder::cAudioStreamDecoder(const cAudioStreamDecoder&)
mpeg2decoder.c:236: error:
    cAudioStreamDecoder::cAudioStreamDecoder(AVCodecContext*, 
cAudioOut*, int)
mpeg2decoder.c:1115: error: request for member `codec_type' in `
 
ic->AVFormatContext::streams[pkt->AVPacket::stream_index]->AVStream::codec',
    which is of non-class type `AVCodecContext*'
mpeg2decoder.c:1127: error: no matching function for call to `
    cVideoStreamDecoder::cVideoStreamDecoder(AVCodecContext**, cVideoOut*&,
    cClock*, int&)'
mpeg2decoder.h:162: error: candidates are:
    cVideoStreamDecoder::cVideoStreamDecoder(const cVideoStreamDecoder&)
mpeg2decoder.c:383: error:
    cVideoStreamDecoder::cVideoStreamDecoder(AVCodecContext*, cVideoOut*,
    cClock*, int)
"

My enviroment is as following:

Suse 9.3 32bit
gcc 3.3.5
kernel 2.6.11.4-21.7 (compiled with Matrox FB support)

I am no C programmer, so I have no clue, what this nice error message 
should tell me...

Any help is appreciated!

Thanks a lot in advance

Greetz

Bj?rn Adler





From marko.makela at hut.fi  Sun Jul 24 09:32:16 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sun, 24 Jul 2005 10:32:16 +0300
Subject: [Softdevice-devel] blue bar on left crop patch
In-Reply-To: <200507232227.53886.stefan@lucke.in-berlin.de>
References: <1121529125551.voitto.tuomainen.25368.LAVpE-NTzKWsHjo6If_2qA@luukku.com> <20050722145619.GG3496@localhost.localdomain> <20050723121253.GA354122@kosh.hut.fi> <200507232227.53886.stefan@lucke.in-berlin.de>
Message-ID: <20050724073216.GB503289@kosh.hut.fi>

On Sat, Jul 23, 2005 at 10:27:53PM +0200, Stefan Lucke wrote:
> > One more thing: I got some warnings and errors when compiling the source
> > with g++ 4.0.1 (the default in Debian GNU/Linux unstable).  They were
> > trivial to fix, and everything seems to work.
> 
> Can you provide a patch ?

Sorry, this was a false alarm, or the problems went away with
vdr 1.3.27 patched with subtitles-0.3.8.  There were absolutely
no warnings for softdevice with g++ -O2 -Wall.

	Marko


From claas+maillinglists.softdevice at jucs-kramkiste.de  Sun Jul 24 12:15:10 2005
From: claas+maillinglists.softdevice at jucs-kramkiste.de (Claas Hilbrecht)
Date: Sun, 24 Jul 2005 12:15:10 +0200
Subject: [Softdevice-devel] Next release ?!
In-Reply-To: <200507232352.10207.stefan@lucke.in-berlin.de>
References: <200507232352.10207.stefan@lucke.in-berlin.de>
Message-ID: <0BB60CDF901651B0C7FCAC13@[192.168.1.22]>

--Am Samstag, 23. Juli 2005 23:52 +0200 Stefan Lucke 
<stefan at lucke.in-berlin.de> schrieb:

> the last release is more than two months old. In the past few
> days, there has been a new feature "cropping" (thanks to Vadim).

Maybe it should be checked first if there is really a memory leak within 
the softdevice plugin or not. So far I didn't had time for a quick test. 
But I will not shutdown my VDR with the softdevice plugin and restart it 
with the softdevice plugin. After running 2 hours I will look at the memory 
and restart VDR with the softdevice plugin. And after 2 hours we should 
know if there's a leak or not.

-- 
 Claas Hilbrecht
 http://www.jucs-kramkiste.de



From claas+maillinglists.softdevice at jucs-kramkiste.de  Sun Jul 24 16:50:08 2005
From: claas+maillinglists.softdevice at jucs-kramkiste.de (Claas Hilbrecht)
Date: Sun, 24 Jul 2005 16:50:08 +0200
Subject: [Softdevice-devel] Next release ?!
In-Reply-To: <0BB60CDF901651B0C7FCAC13@[192.168.1.22]>
References: <200507232352.10207.stefan@lucke.in-berlin.de>
 <0BB60CDF901651B0C7FCAC13@[192.168.1.22]>
Message-ID: <E43B2879B74ED20C4DFAAFE9@[192.168.1.22]>

--Am Sonntag, 24. Juli 2005 12:15 +0200 Claas Hilbrecht 
<claas+maillinglists.softdevice at jucs-kramkiste.de> schrieb:

These are the results. It seems that something is eating memory. But I 
don't think it's the softdevice plugin.

12:37: VDR started without softdevice
top output:
  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
 4142 vdr       34  19 24848   9m 1728 S  0.7  1.0   0:00.86 vdr

13:37:
top output:
  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
 4145 vdr       34  19 46292  30m 1736 S  2.0  3.0   0:29.56 vdr
 4148 vdr       34  19 46292  30m 1736 S  2.0  3.0   0:29.96 vdr
 4142 vdr       34  19 46292  30m 1736 S  0.3  3.0   0:13.64 vdr

14:37: VDR stopped without softdevice
top output:
  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
 4142 vdr       34  19 68524  51m 1768 S  0.7  5.1   0:26.72 vdr
 4145 vdr       34  19 68524  51m 1768 S  0.7  5.1   0:59.18 vdr
 4148 vdr       34  19 68524  51m 1768 S  0.7  5.1   0:59.89 vdr

14:40: VDR with softdevice
top output:
  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
 4243 vdr       15   0 49204  15m 2660 S  1.7  1.6   0:00.35 vdr
 4231 vdr       34  19 49204  15m 2660 S  0.3  1.6   0:00.06 vdr

15:45: VDR with softdevice
top output:
  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
 4243 vdr       15   0 74488  42m 2672 S  1.7  4.2   1:17.21 vdr
 4231 vdr       34  19 74488  42m 2672 S  0.3  4.2   0:16.58 vdr

16:48: VDR with softdevice
top output:
  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
 4311 vdr       15   0 94528  62m 2704 S  2.7  6.2   0:02.92 vdr
 4234 vdr       34  19 94528  62m 2704 S  1.3  6.2   1:05.63 vdr
 4231 vdr       34  19 94528  62m 2704 S  1.0  6.2   0:32.82 vdr
 4237 vdr       34  19 94528  62m 2704 S  1.0  6.2   1:05.57 vdr

-- 
 Claas Hilbrecht
 http://www.jucs-kramkiste.de



From seppo.ingalsuo at iki.fi  Sun Jul 24 18:20:25 2005
From: seppo.ingalsuo at iki.fi (Seppo Ingalsuo)
Date: Sun, 24 Jul 2005 19:20:25 +0300
Subject: [Softdevice-devel] Next release ?!
In-Reply-To: <E43B2879B74ED20C4DFAAFE9@[192.168.1.22]>
References: <200507232352.10207.stefan@lucke.in-berlin.de> <0BB60CDF901651B0C7FCAC13@[192.168.1.22]> <E43B2879B74ED20C4DFAAFE9@[192.168.1.22]>
Message-ID: <42E3BFC9.9000408@iki.fi>

Claas Hilbrecht wrote:

>
> PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
> 4311 vdr       15   0 94528  62m 2704 S  2.7  6.2   0:02.92 vdr
> 4234 vdr       34  19 94528  62m 2704 S  1.3  6.2   1:05.63 vdr
> 4231 vdr       34  19 94528  62m 2704 S  1.0  6.2   0:32.82 vdr
> 4237 vdr       34  19 94528  62m 2704 S  1.0  6.2   1:05.57 vdr
>
My vdr also seems to grow (top output)

Swap:   473876k total,   182488k used,   291388k free,    52856k cached

  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
 9595 vdr       34  19  148m 105m  13m S  1.7 42.3   1:38.14 vdr
 9593 vdr       34  19  148m 105m  13m S  0.7 42.3   0:09.46 vdr
 9591 vdr       34  19  148m 105m  13m S  0.3 42.3   0:11.93 vdr

I just experienced vdr slowdown with lot of disk activity (swapping?) 
and then a crash. Gdb/where tells about the 208M core file this (perhaps 
not interesting but any way)

(gdb) where
#0  0xb788caaf in avcodec_flush_buffers () from /usr/local/lib/libavcodec.so
#1  0xb7cf3f69 in cStreamDecoder::Clear (this=0x9f1dc50) at 
mpeg2decoder.c:244
#2  0xb7cf6e67 in cMpeg2Decoder::ClearPacketQueue (this=0x84ed6a0) at 
mpeg2decoder.c:1174
#3  0xb7f9f53a in cSoftPlayer::Action (this=0xba7ee40) at player.h:28
#4  0x080e66b6 in cThread::StartThread (Thread=0xba7ee4c) at thread.c:233
#5  0xb7f29e51 in pthread_start_thread () from /lib/libpthread.so.0
#6  0xb7de092a in clone () from /lib/libc.so.6

My configuration is vdr 1.3.27 + softdevice + subtitles + muggle + mp3 + 
softplay + burn + femon. I  have patches for dvb subtitles and steerable 
dish. I didn't get this type of crashes with similar dxr3 setup (only 
occasional OSD mess and vdr watchdog restarts). The difference in 
configuration is softdevice and softplay, I'll try next if avoiding 
softplay would have effect to memory usage.

BR,
Seppo



From marko.makela at hut.fi  Sun Jul 24 22:54:10 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sun, 24 Jul 2005 23:54:10 +0300
Subject: [Softdevice-devel] Minor AV sync problems
Message-ID: <20050724205410.GA7329@localhost.localdomain>

It seems that in the past few weeks, something in softdevice has changed
so that audio lags behind by a couple of video frames.  I have a feeling
that an earlier CVS snapshot is performing better, but I'm not sure, since
the error is so subtle.  Has anyone else noticed problems with AV sync
lately?

	Marko


From marko.makela at hut.fi  Sun Jul 24 23:05:35 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 25 Jul 2005 00:05:35 +0300
Subject: [Softdevice-devel] Repeatable crash when rewinding a recording
Message-ID: <20050724210535.GB7329@localhost.localdomain>

I think I have reported a similar problem before.  Now I observed the
problem with another recording.  When I rewind it, softdevice passes
invalid arguments to memcpy() in the YUV conversion (see attached
gdb output).

By the way, I can't seem to get core files from my system any more,
and I have set ulimit -c unlimited.  Maybe it is a bug in kernel
2.6.12.3?

Luckily, I can run vdr inside gdb.  See the attached gdb log.  I added
the lines "(gdb)" manually, as they were not written out by "set logging on".
I hope I didn't make mistakes while doing that.

The crash cannot be due to any recent changes, because the crash also
occurs with an older snapshot (mpeg2decoder.c -r1.43, video-dfb.c -r1.31).

	Marko
-------------- next part --------------
(gdb) bt
#0  0xb7d6b07f in memcpy () from /lib/tls/libc.so.6
#1  0xb798d8aa in cDFBVideoOut::YUV (this=0xb5e49000, 
    Py=0xb3d82b30 '\200' <repeats 200 times>..., Pu=0x85dcb98 '\200' <repeats 200 times>..., 
    Pv=0x85f88e0 '\200' <repeats 200 times>..., Width=720, Height=576, Ystride=752, 
    UVstride=376) at video-dfb.c:1133
#2  0xb7983425 in cVideoStreamDecoder::DecodePacket (this=0x82b7700, pkt=0x838533c)
    at mpeg2decoder.c:606
#3  0xb7982b74 in cStreamDecoder::Action (this=0x82b7700) at mpeg2decoder.c:188
#4  0x080e6b12 in cThread::StartThread (Thread=0x82b7700) at thread.c:233
#5  0xb7f41b63 in start_thread () from /lib/tls/libpthread.so.0
#6  0xb7dc918a in clone () from /lib/tls/libc.so.6
(gdb) bt full
#0  0xb7d6b07f in memcpy () from /lib/tls/libc.so.6
No symbol table info available.
#1  0xb798d8aa in cDFBVideoOut::YUV (this=0xb5e49000, 
    Py=0xb3d82b30 '\200' <repeats 200 times>..., Pu=0x85dcb98 '\200' <repeats 200 times>..., 
    Pv=0x85f88e0 '\200' <repeats 200 times>..., Width=720, Height=576, Ystride=752, 
    UVstride=376) at video-dfb.c:1133
	dst = (uint8_t *) 0xb5e48ee0 <Address 0xb5e48ee0 out of bounds>
	pitch = 576
	hi = 287
#2  0xb7983425 in cVideoStreamDecoder::DecodePacket (this=0x82b7700, pkt=0x838533c)
    at mpeg2decoder.c:606
	findPTS = Variable "findPTS" is not available.
(gdb) up
#1  0xb798d8aa in cDFBVideoOut::YUV (this=0xb5e49000, 
    Py=0xb3d82b30 '\200' <repeats 200 times>..., Pu=0x85dcb98 '\200' <repeats 200 times>..., 
    Pv=0x85f88e0 '\200' <repeats 200 times>..., Width=720, Height=576, Ystride=752, 
    UVstride=376) at video-dfb.c:1133
1133	      memcpy(dst+cutLeft, Pv+sxoff/2+cutLeft, swidth/2-(cutLeft+cutRight));
Current language:  auto; currently c++
(gdb) p *this
$1 = {<cVideoOut> = {<cThread> = {_vptr.cThread = 0x464c457f, running = true, childTid = 0, 
      mutex = {mutex = {__m_reserved = 0, __m_count = 196611, __m_owner = 0x1, 
          __m_kind = 7808, __m_lock = {__status = 52, __spinlock = 37440}}, locked = 0}, 
      description = 0x200034 <Address 0x200034 out of bounds>, 
      static emergencyExitRequested = false}, osdMutex = {mutex = {__m_reserved = 2621444, 
        __m_count = 1703965, __m_owner = 0x1, __m_kind = 0, __m_lock = {__status = 0, 
          __spinlock = 0}}, locked = 35078}, OSDxOfs = 35078, OSDyOfs = 5, OSDw = 4096, 
    OSDh = 1, OSDpresent = 32, OSDpseudo_alpha = 137, current_osdMode = 39200, Xres = 39200, 
    Yres = 924, Bpp = 936, dx = 6, dy = 4096, dwidth = 2, dheight = 35388, old_x = 39484, 
    old_y = 39484, old_dwidth = 216, old_dheight = 216, screenPixelAspect = 6, fwidth = 4, 
    fheight = 1685382481, swidth = 0, sheight = 0, sxoff = 0, syoff = 0, lwidth = 0, 
    lheight = 6, lxoff = 4, lyoff = 97, flags = 129, display_aspect = 67, 
    current_aspect = 121, currentPixelFormat = 93, cutTop = 120, cutBottom = 112, cutLeft = 0, 
    cutRight = 0, aspect_changed = 78, current_afd = 105, displayTimeUS = 64, parValues = {
      1.5490569279184771e-312, 2.3715151000379834e-322, 3.4090529563046012e-322, 
      1.4853970536756906e-312, 1.8774494541967369e-322}, old_picture = 0x7c, old_width = 91, 
    old_height = 88, setupStore = 0x0, osd = 0x7d, active = false, OSDdirty = false, 
    freezeMode = false, PixelMask = 0x0, Osd_changed = 109, 
    OsdPy = 0x3c <Address 0x3c out of bounds>, OsdPu = 0x0, 
    OsdPv = 0x4c <Address 0x4c out of bounds>, OsdPAlphaY = 0x34 <Address 0x34 out of bounds>, 
    OsdPAlphaUV = 0x63 <Address 0x63 out of bounds>, OsdHeight = 111, OsdWidth = 0, 
    OsdRefreshCounter = 123}, osdLayer = 0x0, videoLayer = 0x0, scrDsc = {flags = 96, 
    caps = DSCAPS_NONE, width = 0, height = 117, pixelformat = 56, preallocated = {{
        data = 0x0, pitch = 0}, {data = 0x0, pitch = 0}}, palette = {entries = 0x71, 
      size = 44}}, osdDsc = {flags = 107, caps = 102, width = 81, height = 31, 
    pixelformat = 115, preallocated = {{data = 0x33, pitch = 97}, {data = 0x50, pitch = 128}}, 
    palette = {entries = 0x0, size = 0}}, vidDsc = {flags = 0, caps = DSCAPS_NONE, 
    width = 118, height = 0, pixelformat = DSPF_UNKNOWN, preallocated = {{data = 0x53, 
        pitch = 0}, {data = 0x74, pitch = 0}}, palette = {entries = 0x72, size = 126}}, 
  osdSurface = 0x0, videoSurface = 0x6e, scrSurface = 0x0, pixelformat = DSPF_UNKNOWN, 
  dfbRemote = 0x0, events = 0x52, deinterlace = false, alphablend = false, 
  useStretchBlit = false, osdClrBack = false, isVIAUnichrome = 59, clearAlpha = 127, 
  clearBackCount = 0, clearBackground = 63, dfb = 0x3a}
(gdb) up
#2  0xb7983425 in cVideoStreamDecoder::DecodePacket (this=0x82b7700, pkt=0x838533c)
    at mpeg2decoder.c:606
606	        picture->linesize[0],picture->linesize[1]);
(gdb) p *this
$2 = {<cStreamDecoder> = {<cThread> = {_vptr.cThread = 0xb7c2a0e8, running = true, 
      childTid = 2979732400, mutex = {mutex = {__m_reserved = 0, __m_count = 0, 
          __m_owner = 0x0, __m_kind = 2, __m_lock = {__status = 0, __spinlock = 0}}, 
        locked = 0}, description = 0x0, static emergencyExitRequested = false}, PacketQueue = {
      MaxPackets = 150, queue = 0x8384f48, FirstPacket = 23, LastPacket = 145, 
      EnablePut = {<cRelTimer> = {_vptr.cRelTimer = 0xb7c2bb88, lastTime = 1974258280}, 
        mutex = {__m_reserved = 0, __m_count = 0, __m_owner = 0x0, __m_kind = 0, __m_lock = {
            __status = 0, __spinlock = 0}}, cond = {__c_lock = {__status = 0, __spinlock = 0}, 
          __c_waiting = 0x79, 
          __padding = "\000\000\000\000y\000\000\000\000\000\000\000y\000\000\000\000\000\000\000Hw+\b?\235*\b", __align = 8299696943243293742}, got_signal = false}, 
      EnableGet = {<cRelTimer> = {_vptr.cRelTimer = 0xb7c2bb88, lastTime = 1956706938}, 
        mutex = {__m_reserved = 0, __m_count = 0, __m_owner = 0x0, __m_kind = 0, __m_lock = {
            __status = 0, __spinlock = 0}}, cond = {__c_lock = {__status = 0, __spinlock = 0}, 
          __c_waiting = 0x26, 
          __padding = "\000\000\000\000&\000\000\000\000\000\000\000&\000\000\000\000\000\000\000?w+\b\2108??", __align = 68719476752}, got_signal = true}}, syncTimer = 0x838b138, 
    freezeMode = false, pts = 41803298, frame = 1879, codec = 0xb7c8c9e0, context = 0x838b388, 
    mutex = {mutex = {__m_reserved = 1, __m_count = 0, __m_owner = 0xa78, __m_kind = 2, 
        __m_lock = {__status = 1, __spinlock = 0}}, locked = 1}, active = true, 
    running = true}, clock = 0x82b75f4, pts_values = {{coded_frame_no = 1879, pts = 41836898, 
      duration = 0}, {coded_frame_no = 1880, pts = 41832098, duration = 0}, {
      coded_frame_no = 1881, pts = 41827298, duration = 0}, {coded_frame_no = 1882, 
      pts = 41822498, duration = 0}, {coded_frame_no = 1883, pts = 41817698, duration = 0}, {
      coded_frame_no = 1884, pts = 41812898, duration = 0}, {coded_frame_no = 1885, 
      pts = 41808098, duration = 0}, {coded_frame_no = 1886, pts = 41803298, duration = 0}, {
      coded_frame_no = 1887, pts = 41798498, duration = 0}, {coded_frame_no = 1878, 
      pts = 41841698, duration = 0}}, lastPTSidx = 9, lastCodedPictNo = 1887, 
  lastPTS = 41793698, lastDuration = 0, picture = 0x84458e0, avpic_src = {data = {
      0x28 <Address 0x28 out of bounds>, 0x82b7880 "?\003~\002", 
      0x3 <Address 0x3 out of bounds>, 0x82a9c30 "_snd_pcm_dmix_open"}, linesize = {0, 0, 
      137066804, 137066680}}, avpic_dest = {data = {0x82b78b0 "b?}\002", 0x0, 
      0x111 <Address 0x111 out of bounds>, 0x82b76f8 "("}, linesize = {-1209911160, 16, 40, 
      137066720}}, width = 720, height = 576, pix_fmt = PIX_FMT_YUV420P, 
  currentDeintMethod = 0, currentMirrorMode = 0, currentppMethod = 0, currentppQuality = 0, 
  pic_buf_lavc = 0x0, pic_buf_pp = 0x0, pic_buf_mirror = 0x0, pic_buf_convert = 0x0, 
  ppmode = 0x0, ppcontext = 0x0, videoOut = 0x8255098, hurry_up = 1, offset = 3067278, 
  delay = -27219, trickspeed = 1, default_frametime = 400}
(gdb) p *pkt
$3 = {pts = 41793698, dts = 376132482, data = 0x8334d20 "", size = 2029, stream_index = 0, 
  flags = 0, duration = 0, destruct = 0xb7bde440 <av_destruct_packet>, priv = 0x7}
(gdb) up
#3  0xb7982b74 in cStreamDecoder::Action (this=0x82b7700) at mpeg2decoder.c:188
188	         DecodePacket(pkt);
(gdb) up
#4  0x080e6b12 in cThread::StartThread (Thread=0x82b7700) at thread.c:233
233	  Thread->Action();
Kill the program being debugged? (y or n) y

From claas+maillinglists.softdevice at jucs-kramkiste.de  Mon Jul 25 08:19:20 2005
From: claas+maillinglists.softdevice at jucs-kramkiste.de (Claas Hilbrecht)
Date: Mon, 25 Jul 2005 08:19:20 +0200
Subject: [Softdevice-devel] Next release ?!
In-Reply-To: <42E3BFC9.9000408@iki.fi>
References: <200507232352.10207.stefan@lucke.in-berlin.de>
 <0BB60CDF901651B0C7FCAC13@[192.168.1.22]>
 <E43B2879B74ED20C4DFAAFE9@[192.168.1.22]> <42E3BFC9.9000408@iki.fi>
Message-ID: <23AB84DDB2AB1B25A510F15F@[192.168.1.22]>

--Am Sonntag, 24. Juli 2005 19:20 +0300 Seppo Ingalsuo 
<seppo.ingalsuo at iki.fi> schrieb:

> My vdr also seems to grow (top output)

This is my output from 08:10. As you see my VDR grows continusly. I'm 
running stock vdr 1.3.27 with an EPG patch (hmm, maybe this is the problem) 
and the softdevice plugin. The system is a recording only server with three 
low budget DVB-S cards.

  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
 4497 vdr       15   0  439m 410m 2716 S  4.0 40.6   2:14.40 vdr
 3862 vdr       34  19  439m 410m 2716 R  2.0 40.6   7:38.71 vdr

-- 
 Claas Hilbrecht
 http://www.jucs-kramkiste.de



From marko.makela at hut.fi  Mon Jul 25 12:30:49 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 25 Jul 2005 13:30:49 +0300
Subject: [Softdevice-devel] WORC5 works
Message-ID: <20050725103049.GA5588@localhost.localdomain>

Hi all,

I released the source code and documentation of my Wake-on-RC5 project.
This will allow me to power on my computer from the bundled remote
control unit of my Hauppauge Nova-T PCI 90002 card.

See http://www.funet.fi/~msmakela/electronics/worc5/ if you are
interested.

My runvdr script will rewrite the softdevice.Suspended setting based on
dmesg output from the modified cx88 driver.  Ugly, but it works.

I could not figure out how to make vdr enter non-interactive mode
whenever softdevice.Suspended changes, so that VDR would shut down
automatically when a timed recording ends after output has been
suspended by the user.  I'll try to convince VDR developers to introduce
a Suspended flag for cDevice and VDR.

	Marko


From torgeir at pobox.com  Mon Jul 25 13:30:25 2005
From: torgeir at pobox.com (Torgeir Veimo)
Date: Mon, 25 Jul 2005 12:30:25 +0100
Subject: [Softdevice-devel] WORC5 works
In-Reply-To: <20050725103049.GA5588@localhost.localdomain>
References: <20050725103049.GA5588@localhost.localdomain>
Message-ID: <1122291025.31588.1.camel@africa.netenviron.com>

On Mon, 2005-07-25 at 13:30 +0300, Marko M?kel? wrote:

> I released the source code and documentation of my Wake-on-RC5 project.
> This will allow me to power on my computer from the bundled remote
> control unit of my Hauppauge Nova-T PCI 90002 card.
> 
> See http://www.funet.fi/~msmakela/electronics/worc5/ if you are
> interested.

Very interesting. What linux distro are you using? 

This is probably a bit more releavant to discuss on the main vdr ml..?

-- 
Torgeir Veimo <torgeir at pobox.com>



From marko.makela at hut.fi  Mon Jul 25 13:45:46 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 25 Jul 2005 14:45:46 +0300
Subject: [Softdevice-devel] WORC5 works
In-Reply-To: <1122291025.31588.1.camel@africa.netenviron.com>
References: <20050725103049.GA5588@localhost.localdomain> <1122291025.31588.1.camel@africa.netenviron.com>
Message-ID: <20050725114546.GE5700@localhost.localdomain>

On Mon, Jul 25, 2005 at 12:30:25PM +0100, Torgeir Veimo wrote:
> On Mon, 2005-07-25 at 13:30 +0300, Marko M?kel? wrote:
> 
> > I released the source code and documentation of my Wake-on-RC5 project.
> > This will allow me to power on my computer from the bundled remote
> > control unit of my Hauppauge Nova-T PCI 90002 card.
> > 
> > See http://www.funet.fi/~msmakela/electronics/worc5/ if you are
> > interested.
> 
> Very interesting. What linux distro are you using? 

Debian GNU/Linux unstable, although I'm considering something along
the lines of BusyBox and uClibc.  Start-up takes 10-15 seconds in
BIOS and 45 seconds in Debian GNU/Linux space.  Shutdown takes
10 seconds.

> This is probably a bit more releavant to discuss on the main vdr ml..?

Yes, I just subscribed there and posted about this.  I'm sorry for the
off-topic post, but I'm so happy that I finally got this to work.

	Marko


From seppo.ingalsuo at iki.fi  Tue Jul 26 10:34:58 2005
From: seppo.ingalsuo at iki.fi (Seppo Ingalsuo)
Date: Tue, 26 Jul 2005 11:34:58 +0300
Subject: [Softdevice-devel] Softdevice crash
Message-ID: <42E5F5B2.3010104@iki.fi>

Hi,

Here is core file information about a softdevice-cvs (2005-07-23) crash

(gdb) where
#0  0x087fd768 in ?? ()
#1  0xb7c6fc53 in cMpeg2Decoder::BufferFill (this=0x84edbe8) at 
mpeg2decoder.c:1492
#2  0xb7c67d43 in cSoftDevice::Poll (this=0x848b3f8, Poller=@0xbdbffa04, 
TimeoutMs=100)
    at softdevice.c:516
#3  0x080985da in cDvbPlayer::Action (this=0xb575b4a0) at dvbplayer.c:493
#4  0x080e66b6 in cThread::StartThread (Thread=0xb575b4ac) at thread.c:233
#5  0xb7ea1e51 in pthread_start_thread () from /lib/libpthread.so.0
#6  0xb7d5892a in clone () from /lib/libc.so.6

If I recall right vdr got stuck when attempting to resume paused 
recording playback. I'm currently running vdr with 
LD_ASSUME_KERNEL=2.4.1. There was nothing interesting in vdr log files 
when crash happened.

BR,
Seppo



From seppo.ingalsuo at iki.fi  Tue Jul 26 10:56:14 2005
From: seppo.ingalsuo at iki.fi (Seppo Ingalsuo)
Date: Tue, 26 Jul 2005 11:56:14 +0300
Subject: [Softdevice-devel] Softdevice and ac3
Message-ID: <42E5FAAE.3060003@iki.fi>

Hi,

Sorry for spamming this list - should ac3 output work? I noticed that in 
vdr mailing list Stefan mentions some preparations for ac3 but I didn't 
get yet if support exist in cvs version or not. I heard that there has 
been some kind of success (AV sync problems) with 
softdevice+bitstreamout plugin. Is that the required configuration?

I noticed that normal dvb mpeg stereo over spdif works as well as 
stereo-downmixed ac3 mode. AC3 stream output doesn't work. I also get 
these messages to log file "ERROR: unknown config parameter: 
softdevice.AlsaSPDIFDevice = hw:0,2". I think I once edited the 
insulting line manually out from setup.conf but it reappeared there.

My motherboard has NForce3 audio and mplayer plays ac3 with mplayer 
settings ao="alsa:device=spdif" ac="hwac3,a52". I'm not familiar with 
alsa but is "hw:0,2" generic to alsa or does it depend on some 
particular PC hardware?

Seppo



From marko.makela at HUT.FI  Tue Jul 26 11:29:49 2005
From: marko.makela at HUT.FI (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 26 Jul 2005 12:29:49 +0300
Subject: [Softdevice-devel] Minor AV sync problems
In-Reply-To: <20050724205410.GA7329@localhost.localdomain>
References: <20050724205410.GA7329@localhost.localdomain>
Message-ID: <20050726092949.GD397816@kosh.hut.fi>

On Sun, Jul 24, 2005 at 11:54:10PM +0300, Marko M?kel? wrote:
> It seems that in the past few weeks, something in softdevice has changed
> so that audio lags behind by a couple of video frames.  I have a feeling
> that an earlier CVS snapshot is performing better, but I'm not sure, since
> the error is so subtle.  Has anyone else noticed problems with AV sync
> lately?

I was able to compensate this by setting AV delay to 2 or 3.  Has some
internal delay been introduced lately?

	Marko

P.S.: My relay switch (connected to the "suspended" flag) is now documented
at <http://www.funet.fi/~msmakela/electronics/relay/>.


From stefan at lucke.in-berlin.de  Tue Jul 26 23:08:10 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 26 Jul 2005 23:08:10 +0200
Subject: [Softdevice-devel] Problem compiling softdevice v0.1.2 and also CVS
In-Reply-To: <42E2D58C.70008@brainhawk.de>
References: <42E2D58C.70008@brainhawk.de>
Message-ID: <200507262308.10692.stefan@lucke.in-berlin.de>

On Sonntag, 24. Juli 2005 01:41, Bjoern Adler wrote:
> Hi all,
> 
> I'm not really sure whether the problem is between my ears or in the 
> sourcecode.
> 
> Whenn trying to compile softdevice 0.1.2 or the CVS version, it always 
> stops with error.
> 
> "
> mpeg2decoder.c: In member function `void cMpeg2Decoder::initStream()':
> mpeg2decoder.c:1030: error: invalid conversion from `int (*)(void*, long 
> long
>     int, int)' to `offset_t (*)(void*, long long int, int)'


From stefan at lucke.in-berlin.de  Tue Jul 26 23:10:36 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 26 Jul 2005 23:10:36 +0200
Subject: [Softdevice-devel] Softdevice crash
In-Reply-To: <42E5F5B2.3010104@iki.fi>
References: <42E5F5B2.3010104@iki.fi>
Message-ID: <200507262310.36765.stefan@lucke.in-berlin.de>

On Dienstag, 26. Juli 2005 10:34, Seppo Ingalsuo wrote:
> Hi,
> 
> Here is core file information about a softdevice-cvs (2005-07-23) crash
> 
> (gdb) where
> #0  0x087fd768 in ?? ()
> #1  0xb7c6fc53 in cMpeg2Decoder::BufferFill (this=0x84edbe8) at 
> mpeg2decoder.c:1492
> #2  0xb7c67d43 in cSoftDevice::Poll (this=0x848b3f8, Poller=@0xbdbffa04, 
> TimeoutMs=100)
>     at softdevice.c:516
> #3  0x080985da in cDvbPlayer::Action (this=0xb575b4a0) at dvbplayer.c:493
> #4  0x080e66b6 in cThread::StartThread (Thread=0xb575b4ac) at thread.c:233
> #5  0xb7ea1e51 in pthread_start_thread () from /lib/libpthread.so.0
> #6  0xb7d5892a in clone () from /lib/libc.so.6
> 
> If I recall right vdr got stuck when attempting to resume paused 
> recording playback. I'm currently running vdr with 
> LD_ASSUME_KERNEL=2.4.1. There was nothing interesting in vdr log files 
> when crash happened.

I guess it's a locking problem when accessing aout/vout objects.
-> TODO
-- 
Stefan Lucke



From stefan at lucke.in-berlin.de  Tue Jul 26 23:22:09 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 26 Jul 2005 23:22:09 +0200
Subject: [Softdevice-devel] Repeatable crash when rewinding a recording
In-Reply-To: <20050724210535.GB7329@localhost.localdomain>
References: <20050724210535.GB7329@localhost.localdomain>
Message-ID: <200507262322.09917.stefan@lucke.in-berlin.de>

On Sonntag, 24. Juli 2005 23:05, Marko M?kel? wrote:
> I think I have reported a similar problem before.  Now I observed the
> problem with another recording.  When I rewind it, softdevice passes
> invalid arguments to memcpy() in the YUV conversion (see attached
> gdb output).

Some parts of yout gdb output looks strange:
(gdb) p *this
    current_aspect = 121, currentPixelFormat = 93, cutTop = 120, cutBottom = 112, cutLeft = 0,

cut values should be in the range 0 .. 100. currentPixelFormat and 
current_aspect are bogous too.

Those cut parameter set via OSD should be limited in an other way
as they count by 2. So cutTop + cutBottom should not exceed frame
high ( 100 + 100) * 2 = 400 lines. I've a test stream which is of size
352x288 .

> 
> By the way, I can't seem to get core files from my system any more,
> and I have set ulimit -c unlimited.  Maybe it is a bug in kernel
> 2.6.12.3?
> 
> Luckily, I can run vdr inside gdb.  See the attached gdb log.  I added
> the lines "(gdb)" manually, as they were not written out by "set logging on".
> I hope I didn't make mistakes while doing that.
> 
> The crash cannot be due to any recent changes, because the crash also
> occurs with an older snapshot (mpeg2decoder.c -r1.43, video-dfb.c -r1.31).
> 
> 	Marko
> 

-- 
Stefan Lucke



From marko.makela at hut.fi  Tue Jul 26 23:37:01 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 27 Jul 2005 00:37:01 +0300
Subject: [Softdevice-devel] Repeatable crash when rewinding a recording
In-Reply-To: <200507262322.09917.stefan@lucke.in-berlin.de>
References: <20050724210535.GB7329@localhost.localdomain> <200507262322.09917.stefan@lucke.in-berlin.de>
Message-ID: <20050726213701.GA3524@localhost.localdomain>

On Tue, Jul 26, 2005 at 11:22:09PM +0200, Stefan Lucke wrote:
> On Sonntag, 24. Juli 2005 23:05, Marko M?kel? wrote:
> > I think I have reported a similar problem before.  Now I observed the
> > problem with another recording.  When I rewind it, softdevice passes
> > invalid arguments to memcpy() in the YUV conversion (see attached
> > gdb output).
> 
> Some parts of yout gdb output looks strange:
> (gdb) p *this
>     current_aspect = 121, currentPixelFormat = 93, cutTop = 120, cutBottom = 112, cutLeft = 0,
> 
> cut values should be in the range 0 .. 100. currentPixelFormat and 
> current_aspect are bogous too.

In the OSD, all cut parameters are zero (the default), but CropMode is
4:3.  It is strange that the cutTop and cutBottom values are nonzero,
because 4:3 mode should only cut from the sides.  The crash also occurs
with an earlier CVS snapshot that does not yet feature the numeric cut
parameters in the OSD.  The recording begins at 4:3 and continues at
16:9.  When I was rewinding it, it was initially 16:9.

Could I perhaps add an assertion somewhere?

	Marko


From stefan at lucke.in-berlin.de  Wed Jul 27 09:18:24 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 27 Jul 2005 09:18:24 +0200
Subject: [Softdevice-devel] Repeatable crash when rewinding a recording
In-Reply-To: <20050726213701.GA3524@localhost.localdomain>
References: <20050724210535.GB7329@localhost.localdomain> <200507262322.09917.stefan@lucke.in-berlin.de> <20050726213701.GA3524@localhost.localdomain>
Message-ID: <1122448704.42e7354074451@webmail.in-berlin.de>

Quoting Marko M?kel? <marko.makela at hut.fi>:

> On Tue, Jul 26, 2005 at 11:22:09PM +0200, Stefan Lucke wrote:
> > On Sonntag, 24. Juli 2005 23:05, Marko M?kel? wrote:
> > > I think I have reported a similar problem before.  Now I observed the
> > > problem with another recording.  When I rewind it, softdevice passes
> > > invalid arguments to memcpy() in the YUV conversion (see attached
> > > gdb output).
> >
> > Some parts of yout gdb output looks strange:
> > (gdb) p *this
> >     current_aspect = 121, currentPixelFormat = 93, cutTop = 120, cutBottom = 112, cutLeft = 0,
> >
> > cut values should be in the range 0 .. 100. currentPixelFormat and
> > current_aspect are bogous too.
>
> In the OSD, all cut parameters are zero (the default), but CropMode is
> 4:3.  It is strange that the cutTop and cutBottom values are nonzero,
> because 4:3 mode should only cut from the sides.  The crash also occurs
> with an earlier CVS snapshot that does not yet feature the numeric cut
> parameters in the OSD.  The recording begins at 4:3 and continues at
> 16:9.  When I was rewinding it, it was initially 16:9.
>
> Could I perhaps add an assertion somewhere?

I don't know which one and at which place. I think we had a report,
that during wind operations aspect changes are sometime not correct
detected. Copying is handled different for directfb when we have an
active crop mode (source frame is copy to layer with sxoff).

There is a compile switch at the beginning of video-dfb.c:

HAVE_SetSourceLocation 0

When this is set to 1, other parts of code are used in a logic which
is similar to xv-out: copy the complete frame and specify later the section
of the frame which should be displayed scaled at given screen coordinates.

So please try HAVE_SetSourceLocation 1


Stefan Lucke


From seppo.ingalsuo at iki.fi  Wed Jul 27 10:29:41 2005
From: seppo.ingalsuo at iki.fi (Seppo Ingalsuo)
Date: Wed, 27 Jul 2005 11:29:41 +0300
Subject: [Softdevice-devel] Problem compiling softdevice v0.1.2 and also
 CVS
In-Reply-To: <200507262308.10692.stefan@lucke.in-berlin.de>
References: <42E2D58C.70008@brainhawk.de> <200507262308.10692.stefan@lucke.in-berlin.de>
Message-ID: <42E745F5.5000103@iki.fi>

Stefan Lucke wrote:

>>mpeg2decoder.c: In member function `void cMpeg2Decoder::QueuePacket(const
>>    AVFormatContext*, AVPacket&)':
>>mpeg2decoder.c:1100: error: request for member `codec_type' in `
>> 
>>ic->AVFormatContext::streams[pkt->AVPacket::stream_index]->AVStream::codec',
>>    which is of non-class type `AVCodecContext*'
>>mpeg2decoder.c:1112: error: no matching function for call to `
>>    cAudioStreamDecoder::cAudioStreamDecoder(AVCodecContext**, 
>>cAudioOut*&, int&
>>    )'
>>mpeg2decoder.h:136: error: candidates are:
>>    cAudioStreamDecoder::cAudioStreamDecoder(const cAudioStreamDecoder&)
>>mpeg2decoder.c:236: error:
>>    cAudioStreamDecoder::cAudioStreamDecoder(AVCodecContext*, 
>>cAudioOut*, int)
>>mpeg2decoder.c:1115: error: request for member `codec_type' in `
>> 
>>ic->AVFormatContext::streams[pkt->AVPacket::stream_index]->AVStream::codec',
>>    which is of non-class type `AVCodecContext*'
>>mpeg2decoder.c:1127: error: no matching function for call to `
>>    cVideoStreamDecoder::cVideoStreamDecoder(AVCodecContext**, cVideoOut*&,
>>    cClock*, int&)'
>>mpeg2decoder.h:162: error: candidates are:
>>    cVideoStreamDecoder::cVideoStreamDecoder(const cVideoStreamDecoder&)
>>mpeg2decoder.c:383: error:
>>    cVideoStreamDecoder::cVideoStreamDecoder(AVCodecContext*, cVideoOut*,
>>    cClock*, int)
>>"
>>    
>>
>
>Just don't know whats wrong here. Please give a newer ffmpeg version a try.
>  
>
I tried yesterday with ffmpeg cvs from yesterday and I got this same 
compilation error. I reverted back to an old ffmpeg copy from around May.

However I didn't check properly if I had some mixed old and new include 
files lying around.

BR,
Seppo



From ospite at studenti.unina.it  Wed Jul 27 10:44:11 2005
From: ospite at studenti.unina.it (A.O.)
Date: Wed, 27 Jul 2005 10:44:11 +0200
Subject: [Softdevice-devel] Problem compiling softdevice v0.1.2 and also
 CVS
In-Reply-To: <42E745F5.5000103@iki.fi>
References: <42E2D58C.70008@brainhawk.de>
	<200507262308.10692.stefan@lucke.in-berlin.de>
	<42E745F5.5000103@iki.fi>
Message-ID: <20050727104411.7d914d81.ospite@studenti.unina.it>

On Wed, 27 Jul 2005 11:29:41 +0300
Seppo Ingalsuo <seppo.ingalsuo at iki.fi> wrote:

> >
> >Just don't know whats wrong here. Please give a newer ffmpeg version
> >a try.
> >  
> >
> I tried yesterday with ffmpeg cvs from yesterday and I got this same 
> compilation error. I reverted back to an old ffmpeg copy from around
> May.
> 
> However I didn't check properly if I had some mixed old and new
> include  files lying around.

Some struct definitions have changed in ffmpeg, i attach a really
_crude_ patch to compile with latest ffmpeg (that means no backward
compatibility).

The patch is against softdevice CVS.

Bye,
   Antonio. 

-- 
Public key: http://studenti.unina.it/~ospite/aopubkey.asc
  Web Site: http://studenti.unina.it/~ospite
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: sd_ffmpeg_cvs.diff
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050727/383b4bd2/attachment.ksh>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050727/383b4bd2/attachment.pgp>

From ospite at studenti.unina.it  Wed Jul 27 10:52:21 2005
From: ospite at studenti.unina.it (A.O.)
Date: Wed, 27 Jul 2005 10:52:21 +0200
Subject: [Softdevice-devel] xv output and fullscreen issue: almost
 SOLVED.
In-Reply-To: <200506282014.57955.stefan@lucke.in-berlin.de>
References: <20050622231346.0099dcf3.ospite@studenti.unina.it>
	<1119513402.42ba6b3a89a10@webmail.in-berlin.de>
	<200506282014.57955.stefan@lucke.in-berlin.de>
Message-ID: <20050727105221.2f00cc89.ospite@studenti.unina.it>

On Tue, 28 Jun 2005 20:14:57 +0200
Stefan Lucke <stefan at lucke.in-berlin.de> wrote:

> On Donnerstag, 23. Juni 2005 09:56, Stefan Lucke wrote:
> > Quoting "A.O." <ospite at studenti.unina.it>:
> > 
> > > Hi,
> > >
> > > it seems i was able to solve the problem i had when going in and
> > > out of fullscreen mode very fast. The effect was that from time to
> > > time vdr stopped because of a buffering problem.
> > >
> > > I commented the call that sets the window Focus explicitly in
> > > xv-video.c, now the focus handling is demanded to the windows
> > > manager (i use blackbox, and my videocard is a savage IX/MX
> > > ARGH!). But.. there is always a "but", playing insanely with the
> > > f-key now brings to another issue: sometimes when coming back to
> > > windowed mode the window size is not restored properly, the window
> > > seems to have the correct position but it has the "fullscreen"
> > > size. Maybe a locking problem? Should softdevice allow a
> > > fullscreen request when serving a fullscreen request?
> > 
> > Noticed that too when holding 'f' key, so that toggling is done at
> > keyrepeat rate. Perhaps we have to ignore (count) toggle request
> > until we get the corresponding ConfigureNotify event. I guess that
> > counting toggle requests should solve your initial problem too.
> > 
> 
> A fix for loosing window dimension is in cvs now. By this sometimes
> a toggle is ignored (while already in progress). In addition to this
> we may define a "min toggle repeat intervall" to reduce amount
> of toggle requests if you still get sometimes in trouble.
> Toggleing fullscreen, windowed mode at keyrepeat rate is not a 
> typical "use case" of softdevice.
> 

The fix does not worked as expected for me, after several fullscreen
requests softdevice crashes. To have a stable behaviour I have always
to comment the XSetInputFocus call, but at this point i'm inclined to
think to a WM's problem, so i will not bother you anymore on that.

Thanks again,
   Antonio.

-- 
Public key: http://studenti.unina.it/~ospite/aopubkey.asc
  Web Site: http://studenti.unina.it/~ospite
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050727/59536215/attachment.pgp>

From stefan at lucke.in-berlin.de  Wed Jul 27 13:16:27 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 27 Jul 2005 13:16:27 +0200
Subject: [Softdevice-devel] Problem compiling softdevice v0.1.2 and also CVS
In-Reply-To: <20050727104411.7d914d81.ospite@studenti.unina.it>
References: <42E2D58C.70008@brainhawk.de> <200507262308.10692.stefan@lucke.in-berlin.de> <42E745F5.5000103@iki.fi> <20050727104411.7d914d81.ospite@studenti.unina.it>
Message-ID: <1122462987.42e76d0b3b102@webmail.in-berlin.de>

Quoting "A.O." <ospite at studenti.unina.it>:

> On Wed, 27 Jul 2005 11:29:41 +0300
> Seppo Ingalsuo <seppo.ingalsuo at iki.fi> wrote:
>
> > >
> > >Just don't know whats wrong here. Please give a newer ffmpeg version
> > >a try.
> > >
> > >
> > I tried yesterday with ffmpeg cvs from yesterday and I got this same
> > compilation error. I reverted back to an old ffmpeg copy from around
> > May.
> >
> > However I didn't check properly if I had some mixed old and new
> > include  files lying around.
>
> Some struct definitions have changed in ffmpeg, i attach a really
> _crude_ patch to compile with latest ffmpeg (that means no backward
> compatibility).
>
> The patch is against softdevice CVS.

Thanks for your patch. The modifications should be protected by
#if LIBAVFORMAT_BUILD > 4628

Stefan Lucke


From stefan at lucke.in-berlin.de  Wed Jul 27 23:08:43 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 27 Jul 2005 23:08:43 +0200
Subject: [Softdevice-devel] Problem compiling softdevice v0.1.2 and also CVS
In-Reply-To: <1122462987.42e76d0b3b102@webmail.in-berlin.de>
References: <42E2D58C.70008@brainhawk.de> <20050727104411.7d914d81.ospite@studenti.unina.it> <1122462987.42e76d0b3b102@webmail.in-berlin.de>
Message-ID: <200507272308.43672.stefan@lucke.in-berlin.de>

On Mittwoch, 27. Juli 2005 13:16, Stefan Lucke wrote:
> Quoting "A.O." <ospite at studenti.unina.it>:
> 
> > On Wed, 27 Jul 2005 11:29:41 +0300
> > Seppo Ingalsuo <seppo.ingalsuo at iki.fi> wrote:
> >
> > > >
> > > >Just don't know whats wrong here. Please give a newer ffmpeg version
> > > >a try.
> > > >
> > > >
> > > I tried yesterday with ffmpeg cvs from yesterday and I got this same
> > > compilation error. I reverted back to an old ffmpeg copy from around
> > > May.
> > >
> > > However I didn't check properly if I had some mixed old and new
> > > include  files lying around.
> >
> > Some struct definitions have changed in ffmpeg, i attach a really
> > _crude_ patch to compile with latest ffmpeg (that means no backward
> > compatibility).
> >
> > The patch is against softdevice CVS.
> 
> Thanks for your patch. The modifications should be protected by
> #if LIBAVFORMAT_BUILD > 4628

Thats now in cvs. Can you check if it still compiles for you ?


-- 
Stefan Lucke



From seppo.ingalsuo at iki.fi  Wed Jul 27 23:27:47 2005
From: seppo.ingalsuo at iki.fi (Seppo Ingalsuo)
Date: Thu, 28 Jul 2005 00:27:47 +0300
Subject: [Softdevice-devel] Problem compiling softdevice v0.1.2 and also
 CVS
In-Reply-To: <200507272308.43672.stefan@lucke.in-berlin.de>
References: <42E2D58C.70008@brainhawk.de> <20050727104411.7d914d81.ospite@studenti.unina.it> <1122462987.42e76d0b3b102@webmail.in-berlin.de> <200507272308.43672.stefan@lucke.in-berlin.de>
Message-ID: <42E7FC53.5050707@iki.fi>

Stefan Lucke wrote:

> Thats now in cvs. Can you check if it still compiles for you ?

Thanks, it compiles. It seems that softplay requires as well a similar 
modification.



From ospite at studenti.unina.it  Thu Jul 28 19:29:12 2005
From: ospite at studenti.unina.it (A.O.)
Date: Thu, 28 Jul 2005 19:29:12 +0200
Subject: [Softdevice-devel] Problem compiling softdevice v0.1.2 and also
 CVS
In-Reply-To: <200507272308.43672.stefan@lucke.in-berlin.de>
References: <42E2D58C.70008@brainhawk.de>
	<20050727104411.7d914d81.ospite@studenti.unina.it>
	<1122462987.42e76d0b3b102@webmail.in-berlin.de>
	<200507272308.43672.stefan@lucke.in-berlin.de>
Message-ID: <20050728192912.1370d0b4.ospite@studenti.unina.it>

On Wed, 27 Jul 2005 23:08:43 +0200
Stefan Lucke <stefan at lucke.in-berlin.de> wrote:

> On Mittwoch, 27. Juli 2005 13:16, Stefan Lucke wrote:
> > Quoting "A.O." <ospite at studenti.unina.it>:
> > 
> > > On Wed, 27 Jul 2005 11:29:41 +0300
> > > Seppo Ingalsuo <seppo.ingalsuo at iki.fi> wrote:
> > >
> > > > >
> > > > >Just don't know whats wrong here. Please give a newer ffmpeg
> > > > >version a try.
> > > > >
> > > > >
> > > > I tried yesterday with ffmpeg cvs from yesterday and I got this
> > > > same compilation error. I reverted back to an old ffmpeg copy
> > > > from around May.
> > > >
> > > > However I didn't check properly if I had some mixed old and new
> > > > include  files lying around.
> > >
> > > Some struct definitions have changed in ffmpeg, i attach a really
> > > _crude_ patch to compile with latest ffmpeg (that means no
> > > backward compatibility).
> > >
> > > The patch is against softdevice CVS.
> > 
> > Thanks for your patch. The modifications should be protected by
> > #if LIBAVFORMAT_BUILD > 4628
> 
> Thats now in cvs. Can you check if it still compiles for you ?
> 

Ok, also with ffmpeg-cvs.
Slightly OT (just to not open another thread): I think a little
change is needed to setup-softdevice.c, see attachment.

Goodbye,
   Antonio.

-- 
Public key: http://studenti.unina.it/~ospite/aopubkey.asc
  Web Site: http://studenti.unina.it/~ospite
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: sd_pp_setup.diff
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050728/1717d692/attachment.ksh>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050728/1717d692/attachment.pgp>

From marko.makela at hut.fi  Thu Jul 28 15:36:14 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 28 Jul 2005 16:36:14 +0300
Subject: [Softdevice-devel] Repeatable crash when rewinding a recording
In-Reply-To: <1122448704.42e7354074451@webmail.in-berlin.de>
References: <20050724210535.GB7329@localhost.localdomain> <200507262322.09917.stefan@lucke.in-berlin.de> <20050726213701.GA3524@localhost.localdomain> <1122448704.42e7354074451@webmail.in-berlin.de>
Message-ID: <20050728133614.GA4656@localhost.localdomain>

On Wed, Jul 27, 2005 at 09:18:24AM +0200, Stefan Lucke wrote:
> I don't know which one and at which place. I think we had a report,
> that during wind operations aspect changes are sometime not correct
> detected.

I have experienced that, i.e., when the rewinding starts at 16:9, a
4:3 picture copied to a 12:9 window on the left, leaving the 4:9 part
on the right of the frame buffer uninitialized.

> There is a compile switch at the beginning of video-dfb.c:
> 
> HAVE_SetSourceLocation 0
> 
> When this is set to 1, other parts of code are used in a logic which
> is similar to xv-out: copy the complete frame and specify later the section
> of the frame which should be displayed scaled at given screen coordinates.
> 
> So please try HAVE_SetSourceLocation 1

It won't crash, but it won't always detect aspect ratio changes when
rewinding from 16:9 to 4:3.  The 4:3 picture would be shown as if it
were a 16:9 picture (black bars on top and bottom when CropMode=none).

By the way, playback of recordings consumes 50..60 percent of CPU, while
live playback takes 30..40 percent.

	Marko


From seppo.ingalsuo at iki.fi  Fri Jul 29 12:25:36 2005
From: seppo.ingalsuo at iki.fi (Seppo Ingalsuo)
Date: Fri, 29 Jul 2005 13:25:36 +0300
Subject: [Softdevice-devel] Problem compiling softdevice v0.1.2 and also
 CVS
In-Reply-To: <200507272308.43672.stefan@lucke.in-berlin.de>
References: <42E2D58C.70008@brainhawk.de> <20050727104411.7d914d81.ospite@studenti.unina.it> <1122462987.42e76d0b3b102@webmail.in-berlin.de> <200507272308.43672.stefan@lucke.in-berlin.de>
Message-ID: <42EA0420.9080805@iki.fi>

Stefan Lucke wrote:

> Thats now in cvs. Can you check if it still compiles for you ?

It is perhaps not related to this modification but something related to 
ffmpeg postprocessing configurations is now broken:

(gdb) where
#0  0xb7d1c980 in strcmp () from /lib/libc.so.6
#1  0xb7c97e66 in cSetupStore::getPPValue (this=0xb7ca6800) at 
setup-softdevice.c:291
#2  0xb7c93beb in cVideoStreamDecoder::ppLibavcodec (this=0x856b9b0) at 
mpeg2decoder.c:917
#3  0xb7c92f4d in cVideoStreamDecoder::DecodePacket (this=0x856b9b0, 
pkt=0x856c684) at mpeg2decoder.c:565
#4  0xb7c91f4b in cStreamDecoder::Action (this=0x856b9b0) at 
mpeg2decoder.c:187
#5  0x080e66b6 in cThread::StartThread (Thread=0x856b9b0) at thread.c:233
#6  0xb7ec8e51 in pthread_start_thread () from /lib/libpthread.so.0
#7  0xb7d7f92a in clone () from /lib/libc.so.6

Softdevice works with defaults (i.e. setup.conf cleared) but not e.g. 
when deinterlace is set to linipol.

BR,
Seppo



From seppo.ingalsuo at iki.fi  Fri Jul 29 12:28:24 2005
From: seppo.ingalsuo at iki.fi (Seppo Ingalsuo)
Date: Fri, 29 Jul 2005 13:28:24 +0300
Subject: [Softdevice-devel] Problem compiling softdevice v0.1.2 and also
 CVS
In-Reply-To: <42E7FC53.5050707@iki.fi>
References: <42E2D58C.70008@brainhawk.de> <20050727104411.7d914d81.ospite@studenti.unina.it> <1122462987.42e76d0b3b102@webmail.in-berlin.de> <200507272308.43672.stefan@lucke.in-berlin.de> <42E7FC53.5050707@iki.fi>
Message-ID: <42EA04C8.7030000@iki.fi>

Seppo Ingalsuo wrote:

> It seems that softplay requires as well a similar modification.

Here is a patch for softplay to match with new ffmpeg cvs. I hope I got 
it right. It seems to work with the new ffmpeg version.

BR,
Seppo

-------------- next part --------------
A non-text attachment was scrubbed...
Name: vdr-softplay-ffmpeg-2005-07-29.diff
Type: text/x-patch
Size: 2259 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050729/4c3cd4ab/attachment.bin>

From stefan at lucke.in-berlin.de  Fri Jul 29 21:59:00 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 29 Jul 2005 21:59:00 +0200
Subject: [Softdevice-devel] Problem compiling softdevice v0.1.2 and also CVS
In-Reply-To: <20050728192912.1370d0b4.ospite@studenti.unina.it>
References: <42E2D58C.70008@brainhawk.de> <200507272308.43672.stefan@lucke.in-berlin.de> <20050728192912.1370d0b4.ospite@studenti.unina.it>
Message-ID: <200507292159.00261.stefan@lucke.in-berlin.de>

On Donnerstag, 28. Juli 2005 19:29, A.O. wrote:
> On Wed, 27 Jul 2005 23:08:43 +0200
> Stefan Lucke <stefan at lucke.in-berlin.de> wrote:
> 
> > On Mittwoch, 27. Juli 2005 13:16, Stefan Lucke wrote:
> > > Quoting "A.O." <ospite at studenti.unina.it>:
> > > 
> > > > On Wed, 27 Jul 2005 11:29:41 +0300
> > > > Seppo Ingalsuo <seppo.ingalsuo at iki.fi> wrote:
> > > >
> > > > > >
> > > > > >Just don't know whats wrong here. Please give a newer ffmpeg
> > > > > >version a try.
> > > > > >
> > > > > >
> > > > > I tried yesterday with ffmpeg cvs from yesterday and I got this
> > > > > same compilation error. I reverted back to an old ffmpeg copy
> > > > > from around May.
> > > > >
> > > > > However I didn't check properly if I had some mixed old and new
> > > > > include  files lying around.
> > > >
> > > > Some struct definitions have changed in ffmpeg, i attach a really
> > > > _crude_ patch to compile with latest ffmpeg (that means no
> > > > backward compatibility).
> > > >
> > > > The patch is against softdevice CVS.
> > > 
> > > Thanks for your patch. The modifications should be protected by
> > > #if LIBAVFORMAT_BUILD > 4628
> > 
> > Thats now in cvs. Can you check if it still compiles for you ?
> > 
> 
> Ok, also with ffmpeg-cvs.
> Slightly OT (just to not open another thread): I think a little
> change is needed to setup-softdevice.c, see attachment.

No. pp_str should be present allways. There is another error, which
may cause segfaults and which I'm trying to fix.

-- 
Stefan Lucke



From stefan at lucke.in-berlin.de  Fri Jul 29 22:47:11 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 29 Jul 2005 22:47:11 +0200
Subject: [Softdevice-devel] Problem compiling softdevice v0.1.2 and also CVS
In-Reply-To: <42EA0420.9080805@iki.fi>
References: <42E2D58C.70008@brainhawk.de> <200507272308.43672.stefan@lucke.in-berlin.de> <42EA0420.9080805@iki.fi>
Message-ID: <200507292247.11542.stefan@lucke.in-berlin.de>

On Freitag, 29. Juli 2005 12:25, Seppo Ingalsuo wrote:
> Stefan Lucke wrote:
> 
> > Thats now in cvs. Can you check if it still compiles for you ?
> 
> It is perhaps not related to this modification but something related to 
> ffmpeg postprocessing configurations is now broken:
> 
> (gdb) where
> #0  0xb7d1c980 in strcmp () from /lib/libc.so.6
> #1  0xb7c97e66 in cSetupStore::getPPValue (this=0xb7ca6800) at 
> setup-softdevice.c:291
> #2  0xb7c93beb in cVideoStreamDecoder::ppLibavcodec (this=0x856b9b0) at 
> mpeg2decoder.c:917
> #3  0xb7c92f4d in cVideoStreamDecoder::DecodePacket (this=0x856b9b0, 
> pkt=0x856c684) at mpeg2decoder.c:565
> #4  0xb7c91f4b in cStreamDecoder::Action (this=0x856b9b0) at 
> mpeg2decoder.c:187
> #5  0x080e66b6 in cThread::StartThread (Thread=0x856b9b0) at thread.c:233
> #6  0xb7ec8e51 in pthread_start_thread () from /lib/libpthread.so.0
> #7  0xb7d7f92a in clone () from /lib/libc.so.6
> 
> Softdevice works with defaults (i.e. setup.conf cleared) but not e.g. 
> when deinterlace is set to linipol.

There are/were some other issues too, but that should be fixed now
[setup-softdevice] cropping mode set to 0 ((null))
[setup-softdevice] cropping mode toggle key set to 3 ((null))

-- 
Stefan Lucke



From stefan at lucke.in-berlin.de  Sat Jul 30 16:56:13 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 30 Jul 2005 16:56:13 +0200
Subject: [Softdevice-devel] Softdevice crash
In-Reply-To: <42E5F5B2.3010104@iki.fi>
References: <42E5F5B2.3010104@iki.fi>
Message-ID: <200507301656.13625.stefan@lucke.in-berlin.de>

On Dienstag, 26. Juli 2005 10:34, Seppo Ingalsuo wrote:
> Hi,
> 
> Here is core file information about a softdevice-cvs (2005-07-23) crash
> 
> (gdb) where
> #0  0x087fd768 in ?? ()
> #1  0xb7c6fc53 in cMpeg2Decoder::BufferFill (this=0x84edbe8) at 
> mpeg2decoder.c:1492
> #2  0xb7c67d43 in cSoftDevice::Poll (this=0x848b3f8, Poller=@0xbdbffa04, 
> TimeoutMs=100)
>     at softdevice.c:516
> #3  0x080985da in cDvbPlayer::Action (this=0xb575b4a0) at dvbplayer.c:493
> #4  0x080e66b6 in cThread::StartThread (Thread=0xb575b4ac) at thread.c:233
> #5  0xb7ea1e51 in pthread_start_thread () from /lib/libpthread.so.0
> #6  0xb7d5892a in clone () from /lib/libc.so.6
> 
> If I recall right vdr got stuck when attempting to resume paused 
> recording playback. I'm currently running vdr with 
> LD_ASSUME_KERNEL=2.4.1. There was nothing interesting in vdr log files 
> when crash happened.
> 

If that crash is reproducable you (doesn't happen for me), please try
attached patch, which protects aout and vout access by a mutex.

-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: softdevice-avMutex.diff
Type: text/x-diff
Size: 5507 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050730/d4b8a12f/attachment.diff>

From seppo.ingalsuo at iki.fi  Sat Jul 30 18:41:39 2005
From: seppo.ingalsuo at iki.fi (Seppo Ingalsuo)
Date: Sat, 30 Jul 2005 19:41:39 +0300
Subject: [Softdevice-devel] Softdevice crash
In-Reply-To: <200507301656.13625.stefan@lucke.in-berlin.de>
References: <42E5F5B2.3010104@iki.fi> <200507301656.13625.stefan@lucke.in-berlin.de>
Message-ID: <42EBADC3.6040508@iki.fi>

Hi,

Stefan Lucke wrote:

>If that crash is reproducable you (doesn't happen for me), please try
>attached patch, which protects aout and vout access by a mutex.
>
>  
>
Thanks, I'll try the patch! It has happened only 2-3 times for me so it 
is hard to repeat. I've seen in similar playback resume case also 
freezing which has been "handled" by vdr's watchdog restart.

Seppo



From M.Wache at gmx.net  Sun Jul 31 11:03:09 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 31 Jul 2005 11:03:09 +0200
Subject: [Softdevice-devel] Minor AV sync problems
In-Reply-To: <20050726092949.GD397816@kosh.hut.fi>
References: <20050724205410.GA7329@localhost.localdomain> <20050726092949.GD397816@kosh.hut.fi>
Message-ID: <42EC93CD.4000109@gmx.net>

Marko M?kel? schrieb:
> On Sun, Jul 24, 2005 at 11:54:10PM +0300, Marko M?kel? wrote:
> 
>>It seems that in the past few weeks, something in softdevice has changed
>>so that audio lags behind by a couple of video frames.  I have a feeling
>>that an earlier CVS snapshot is performing better, but I'm not sure, since
>>the error is so subtle.  Has anyone else noticed problems with AV sync
>>lately?
> 
> 
> I was able to compensate this by setting AV delay to 2 or 3.  Has some
> internal delay been introduced lately?
> 

Well, not on purpose. I changed the way the audio delay is accessed.
Prevously it was a call to the audio out, now just a offset to the
system clock is stored. The call to audio out was a bit unpredictable
since the call was from the video thread while the audio thread has been
running at the same time, so we got a few threading problems.

Your not the first one to report this, I think Patrick Boetcher also
reported it. I already looked for mistakes in that change but up to now
everything looks ok :-/

Martin


From marko.makela at hut.fi  Sun Jul 31 14:17:25 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sun, 31 Jul 2005 15:17:25 +0300
Subject: [Softdevice-devel] Minor AV sync problems
In-Reply-To: <42EC93CD.4000109@gmx.net>
References: <20050724205410.GA7329@localhost.localdomain> <20050726092949.GD397816@kosh.hut.fi> <42EC93CD.4000109@gmx.net>
Message-ID: <20050731121725.GB3337@localhost.localdomain>

Martin,

> >>It seems that in the past few weeks, something in softdevice has changed
> >>so that audio lags behind by a couple of video frames.  I have a feeling
> >>that an earlier CVS snapshot is performing better, but I'm not sure, since
> >>the error is so subtle.  Has anyone else noticed problems with AV sync
> >>lately?
> > 
> > 
> > I was able to compensate this by setting AV delay to 2 or 3.  Has some
> > internal delay been introduced lately?
> > 
> 
> Well, not on purpose. I changed the way the audio delay is accessed.
> Prevously it was a call to the audio out, now just a offset to the
> system clock is stored. The call to audio out was a bit unpredictable
> since the call was from the video thread while the audio thread has been
> running at the same time, so we got a few threading problems.

Thank you for confirming this.  For me, the delay seems unpredictable
now.  Or perhaps my eye is just not trained enough to see how many
video frames the audio is ahead or behind.  Maybe I should record some
soap opera junk like The Bold and the Beautiful.  Then I'd have enough
lip-synced material.

> Your not the first one to report this, I think Patrick Boetcher also
> reported it. I already looked for mistakes in that change but up to now
> everything looks ok :-/

Patrick, are you using DirectFB output?

Martin, can you post the change you made in diff -u format?

	Marko


From patrick.boettcher at desy.de  Sun Jul 31 14:55:59 2005
From: patrick.boettcher at desy.de (Patrick Boettcher)
Date: Sun, 31 Jul 2005 14:55:59 +0200 (CEST)
Subject: [Softdevice-devel] Minor AV sync problems
In-Reply-To: <20050731121725.GB3337@localhost.localdomain>
References: <20050724205410.GA7329@localhost.localdomain>    
 <20050726092949.GD397816@kosh.hut.fi> <42EC93CD.4000109@gmx.net>
 <20050731121725.GB3337@localhost.localdomain>
Message-ID: <Pine.LNX.4.61.0507311431400.7531@pub6.ifh.de>

Hi,

On Sun, 31 Jul 2005, Marko M?kel? wrote:
>> Well, not on purpose. I changed the way the audio delay is accessed.
>> Prevously it was a call to the audio out, now just a offset to the
>> system clock is stored. The call to audio out was a bit unpredictable
>> since the call was from the video thread while the audio thread has been
>> running at the same time, so we got a few threading problems.
>
> Thank you for confirming this.  For me, the delay seems unpredictable
> now.

For me too. I was wrong stating to be able to compensate it with modifying 
AV delay. In fact it is different everytime when tuning to a new channel 
or starting a recording.

>> Your not the first one to report this, I think Patrick Boetcher also
>> reported it. I already looked for mistakes in that change but up to now
>> everything looks ok :-/
>
> Patrick, are you using DirectFB output?

Yes, with a Matrox G550.

I'm using vdr-1.3.27, DirectFB, ffmpeg and softdevice from CVS 
(2005-06-26).

I will update to recent cvs checkouts today, maybe.

best regards,
Patrick.

--
   Mail: patrick.boettcher at desy.de
   WWW:  http://www.wi-bw.tfh-wildau.de/~pboettch/

From voitto.tuomainen at luukku.com  Sun Jul 31 19:25:50 2005
From: voitto.tuomainen at luukku.com (Voitto Tuomainen)
Date: Sun, 31 Jul 2005 20:25:50 +0300 (EEST)
Subject: [Softdevice-devel] SkyStar2 module, device 3 has no lock
Message-ID: <1122830750135.voitto.tuomainen.53421.Z3cMtYWhAGLl62RphmshlA@luukku.com>

Hi,
I'm not very sure were to email this, but let's start here because I think, I've seen the author (Vadim Catana) of the skystar2 driver emailing here.

My system:
- two Technisat Airstar2 PCI card (budget cards)
- one Technisat Skystar2
- gentoo (latest snapshot)
- kernel 2.6.12-gentoo-r6
- udev 064
- vdr 1.3.27
- softdevice cvs latest (31.7.)

The problem is that while I record one program, and change channel to another, which is not in the same channel bunch as the one is recorded, I get the error: device 3 has no lock, can't attach receiver. 

I've increased TUNER_LOCK_TIMEOUT value of device.c in vdr directory (one note that I found from google search), but that does not change anything else, than that I got the error after the time defined in that file.

If I run two channels from different bunch with tzap at the same time, there is no errors messages in /var/log/message.

I've expirienced this with all vdr, softdevice and kernel 2.6.11/12 combinations, which I have had during half a year.

________
Voitto Tuomainen

...................................................................
Luukku Plus paketilla p??set eroon tila- ja turvallisuusongelmista.
Hanki Luukku Plus ja helpotat el?m??si. http://www.mtv3.fi/luukku



From listaccount at e-tobi.net  Sun Jul 31 20:14:23 2005
From: listaccount at e-tobi.net (Tobias Grimm)
Date: Sun, 31 Jul 2005 20:14:23 +0200
Subject: [Softdevice-devel] Work on Debian package still in progress...
Message-ID: <42ED14FF.1040806@e-tobi.net>

Hi!

Guillem Jover now has packaged dfb++, so I thought it's time to continue
working on the vdr-plugin-softdevice package. I've sucessfully built the
package with directFB support, but could need some help with getting it
up and running.

I have a board (GA-K8VM800M) with a VIA K8M800 chipset and an on-board
graphics card, which I would like to use. A quick test brought the
attached error messages. Where should I start?

Regards,

Tobias


Warning! VDR started with root privileges
[softdevice] processing args
[softdevice]   argv [0] = softdevice
[softdevice] initializing Plugin
[softdevice] Initializing Video Out
[softdevice] ffmpeg version(0.4.9-pre1) build(4756)
[dfb] init

       ---------------------- DirectFB v0.9.22 ---------------------
             (c) 2000-2002  convergence integrated media GmbH
             (c) 2002-2004  convergence GmbH
        -----------------------------------------------------------

(*) DirectFB/Core: Single Application Core. (2005-07-31 15:28)
(*) Direct/Memcpy: Using MMXEXT optimized memcpy()
(*) Direct/Thread: Running 'VT Switcher' (CRITICAL, 12963)...
(!) Direct/Modules: Unable to dlopen
`/usr/lib/directfb-0.9.22/inputdrivers/libdirectfb_ps2mouse.so'!
    --> /usr/lib/directfb-0.9.22/inputdrivers/libdirectfb_ps2mouse.so:
undefined symbol: direct_free
(*) Direct/Thread: Running 'LiRC Input' (INPUT, 12964)...
 (!!!)  *** UNIMPLEMENTED [fusion_reactor_set_lock] ***
[../../../lib/fusion/reactor.c:802]
(*) DirectFB/Input: LIRC Device 0.2 (convergence integrated media GmbH)
(*) Direct/Thread: Running 'Keyboard Input' (INPUT, 12965)...
(*) DirectFB/Input: Keyboard 0.9 (convergence integrated media GmbH)
(*) DirectFB/Genefx: MMX detected and enabled
(*) DirectFB/Graphics: MMX Software Rasterizer 0.6 (convergence
integrated media GmbH)
(*) DirectFB/Core/WM: Default 0.2 (Convergence GmbH)
[dfb] Supported video Modes are: 640x480 at 8 640x480 at 8 640x480 at 8 640x480 at 8
640x480 at 8
[dfb] Enumeratig display Layers
Layer 0 FBDev Primary Layer  Type: graphics
  Caps: brightness contrast saturation surface
(!) [12950:    0.000] --> Caught signal 6 (sent by pid 12950, uid 0) <--
/usr/sbin/runvdr: line 1: 12950 Get?tet                
LD_ASSUME_KERNEL=2.4.1 /usr/bin/vdr -v /var/lib/video.00 -c /var/lib/vdr
-L /usr/lib/vdr/plugins -r


From marko.makela at hut.fi  Sun Jul 31 21:24:07 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sun, 31 Jul 2005 22:24:07 +0300
Subject: [Softdevice-devel] Progress with DirectFB (Work on Debian package still in progress...)
In-Reply-To: <42ED14FF.1040806@e-tobi.net>
References: <42ED14FF.1040806@e-tobi.net>
Message-ID: <20050731192407.GA433171@kosh.hut.fi>

On Sun, Jul 31, 2005 at 08:14:23PM +0200, Tobias Grimm wrote:
> Guillem Jover now has packaged dfb++, so I thought it's time to continue
> working on the vdr-plugin-softdevice package. I've sucessfully built the
> package with directFB support, but could need some help with getting it
> up and running.

> [dfb] Enumeratig display Layers
> Layer 0 FBDev Primary Layer  Type: graphics
>   Caps: brightness contrast saturation surface
> (!) [12950:    0.000] --> Caught signal 6 (sent by pid 12950, uid 0) <--
> /usr/sbin/runvdr: line 1: 12950 Get?tet                

Search for the mailing list archive for SIGABRT (that's what signal 6 is
on GNU/Linux).  I reported that a few months ago.  If I remember correctly,
it was a permissions problem.  Try to run as root, or try adding
no-vt-switch, no-vt-switching, and perhaps other options to your /etc/directfbrc.
You could also try building vdr.o with make NO_KBD=1.

> LD_ASSUME_KERNEL=2.4.1 /usr/bin/vdr -v /var/lib/video.00 -c /var/lib/vdr
> -L /usr/lib/vdr/plugins -r

Try adding "strace" before /usr/bin/vdr.  Then you should get an idea where it
fails.

By the way, under kernel 2.6.12.3 and DirectFB 0.9.22, vdr-softdevice works
pretty nicely, apart from the fact that I had to add a few infrared key
mappings for the new Hauppauge Nova-T PCI 90002 RCU to the kernel and to
the DirectFB.  (These mappings should now be in the development trees.)
There were far more glitches in 2.6.8 or maybe even 2.6.11.6.

I'm able to use virtual consoles while softdevice is running.  Apparently,
the consoles share the display layer with the OSD (at least on my
Matrox G450).  If I want to hide the text of the virtual consoles, I just
switch back to the virtual console "owned" by VDR and trigger OSD output.

If I'm on a different virtual console than where VDR was started from,
VDR occasionally crashes when trying to update the OSD.  I haven't tracked
this down, because for some reason, my system doesn't usually create core
dumps despite ulimit -c unlimited.  This would be nice to fix, because
the subtitles plugin initiates OSD events regularly.  In order to be able
to use the screen as a terminal without crashing VDR, I have to first
switch to a channel that won't display subtitles.  Suspending softdevice
won't help, because subtitles will be displayed independent of softdevice's
MPEG decoder.

	Marko


From stefan at lucke.in-berlin.de  Sun Jul 31 21:29:51 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 31 Jul 2005 21:29:51 +0200
Subject: [Softdevice-devel] Work on Debian package still in progress...
In-Reply-To: <42ED14FF.1040806@e-tobi.net>
References: <42ED14FF.1040806@e-tobi.net>
Message-ID: <200507312129.51538.stefan@lucke.in-berlin.de>

On Sonntag, 31. Juli 2005 20:14, Tobias Grimm wrote:
> Hi!
> 
> Guillem Jover now has packaged dfb++, so I thought it's time to continue
> working on the vdr-plugin-softdevice package. I've sucessfully built the
> package with directFB support, but could need some help with getting it
> up and running.
> 
> I have a board (GA-K8VM800M) with a VIA K8M800 chipset and an on-board
> graphics card, which I would like to use. A quick test brought the
> attached error messages. Where should I start?
> 

With your /etc/directfbrc and your /etc/fb.modes.

> (*) DirectFB/Core: Single Application Core. (2005-07-31 15:28)
> (*) Direct/Memcpy: Using MMXEXT optimized memcpy()
> (*) Direct/Thread: Running 'VT Switcher' (CRITICAL, 12963)...
> (!) Direct/Modules: Unable to dlopen
> `/usr/lib/directfb-0.9.22/inputdrivers/libdirectfb_ps2mouse.so'!
>     --> /usr/lib/directfb-0.9.22/inputdrivers/libdirectfb_ps2mouse.so:
> undefined symbol: direct_free

This error message is odd too. Do directfb samples work (like dfbinfo) ?

> (*) Direct/Thread: Running 'LiRC Input' (INPUT, 12964)...
>  (!!!)  *** UNIMPLEMENTED [fusion_reactor_set_lock] ***
> [../../../lib/fusion/reactor.c:802]

> [dfb] Supported video Modes are: 640x480 at 8 640x480 at 8 640x480 at 8 640x480 at 8
> 640x480 at 8

By default directfb uses the first mode specified in fb.modes. I you
want a higher resolution and/or color depth (you will) you should
specify them in directfbrc.

> [dfb] Enumeratig display Layers
> Layer 0 FBDev Primary Layer  Type: graphics
>   Caps: brightness contrast saturation surface
> (!) [12950:    0.000] --> Caught signal 6 (sent by pid 12950, uid 0) <--
> /usr/sbin/runvdr: line 1: 12950 Get?tet                

Thats to my opinion caused by insufficient resolution / color depth.
> LD_ASSUME_KERNEL=2.4.1 /usr/bin/vdr -v /var/lib/video.00 -c /var/lib/vdr
> -L /usr/lib/vdr/plugins -r


-- 
Stefan Lucke



From M.Wache at gmx.net  Sun Jul 31 21:47:12 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 31 Jul 2005 21:47:12 +0200
Subject: memory leak, was: Re: [Softdevice-devel] Next release ?!
Message-ID: <42ED2AC0.50107@gmx.net>

Claas Hilbrecht schrieb:
> --Am Sonntag, 24. Juli 2005 19:20 +0300 Seppo Ingalsuo
> <seppo.ingalsuo at iki.fi> schrieb:
>
>> My vdr also seems to grow (top output)
>
>
> This is my output from 08:10. As you see my VDR grows continusly. I'm
> running stock vdr 1.3.27 with an EPG patch (hmm, maybe this is the
> problem) and the softdevice plugin. The system is a recording only
> server with three low budget DVB-S cards.
>
>  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
> 4497 vdr       15   0  439m 410m 2716 S  4.0 40.6   2:14.40 vdr
> 3862 vdr       34  19  439m 410m 2716 R  2.0 40.6   7:38.71 vdr
>

Sorry for the late answer. Unfortunatly I can confirm this - my vdr also
grows :-(
First I checked the source files for obvious things and found a memory
leak when useing libpostproc, I fixed this in the CVS, but unfortunatly
my vdr still groes. Even worse valgrind doesn't run on AMD64, so I used
mtrace - with some difficulties because of the run-time loading of the
softdevice.

In fact I found quite a lot of memory leaks - but only one of them in
the softdevice. And this one I already knew, the OSD memory is not freed
correctly on exit, but that shouldn't matter since they are only
malloced once.
Allmost all of those memory leaks I found are from within libc6 or vdr
(from tools.c strcpyrealloc and epg.c cComponents::Realloc) and the
sizes are between 0x1-0x70. Both locations are calls to realloc, so
maybe something is wrong there? Or is mtrace wrong here?

My other suspect is the use of UTF-8, but that's more or less a wild
guess. Are you also using UTF-8? Is there anyone whose vdr/softdevice
doesn't grow?

I'm using NTPL and UTF-8 on AMD64 and my vdr grows with about 1kB/second...

Bye,
Martin


From M.Wache at gmx.net  Sun Jul 31 21:57:15 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 31 Jul 2005 21:57:15 +0200
Subject: [Softdevice-devel] Minor AV sync problems
In-Reply-To: <Pine.LNX.4.61.0507311431400.7531@pub6.ifh.de>
References: <20050724205410.GA7329@localhost.localdomain>     <20050726092949.GD397816@kosh.hut.fi> <42EC93CD.4000109@gmx.net> <20050731121725.GB3337@localhost.localdomain> <Pine.LNX.4.61.0507311431400.7531@pub6.ifh.de>
Message-ID: <42ED2D1B.4060008@gmx.net>

Patrick Boettcher schrieb:
> Hi,
> 
> On Sun, 31 Jul 2005, Marko M?kel? wrote:
> 
>>> Well, not on purpose. I changed the way the audio delay is accessed.
>>> Prevously it was a call to the audio out, now just a offset to the
>>> system clock is stored. The call to audio out was a bit unpredictable
>>> since the call was from the video thread while the audio thread has been
>>> running at the same time, so we got a few threading problems.
>>
>>
>> Thank you for confirming this.  For me, the delay seems unpredictable
>> now.
> 
> 
> For me too. I was wrong stating to be able to compensate it with
> modifying AV delay. In fact it is different everytime when tuning to a
> new channel or starting a recording.
> 
That is bad news :-(. Maybe the new mechanism isn't as stable as I
thought...
Can you tell me if the AV delay changes only when changeing a station? I
mean if you correct the delay once for one station and watch TV without
changeing the station, is it still okay after some (preferably a long )
time? I know that this is probably not easy to say for those small
delays... I guess I will prepare a patch with debug outputs to test the
stability of the new delay mechanism when I find the time.

@Marko:
The change of the access of the audio delay was on the 29. May 05, you
can get the diff from cvs web access, the relevant files are
mpegdecoder.c and .h. There are some more changes in this commit, look
only for those which concern cClock and the PTS handling.

Bye,
Martin


From marko.makela at hut.fi  Sun Jul 31 21:58:24 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sun, 31 Jul 2005 22:58:24 +0300
Subject: memory leak, was: Re: [Softdevice-devel] Next release ?!
In-Reply-To: <42ED2AC0.50107@gmx.net>
References: <42ED2AC0.50107@gmx.net>
Message-ID: <20050731195824.GB102185@kosh.hut.fi>

On Sun, Jul 31, 2005 at 09:47:12PM +0200, Martin Wache wrote:
> My other suspect is the use of UTF-8, but that's more or less a wild
> guess. Are you also using UTF-8? Is there anyone whose vdr/softdevice
> doesn't grow?

Well, I just gave this a try.  I'm using latin1 and NPTL, and I
unsuspended softdevice for a few seconds.  ps -l reported
SZ=33958 both before and after the test.  I also browsed the
details of a random EPG entry, and SZ didn't grow.  Of course,
this doesn't prove the absence of leaks.  I guess the brk(2)
granularity is 4 kilobytes, and libc does have a malloc pool,
so all mallocs won't show immediately in SZ.

I have never noticed that vdr would consume too much memory.
Of course, there is pretty much room to grow from 32 megabytes
to about 240 (the system has 256 MB of memory and no swap).

	Marko


From listaccount at e-tobi.net  Sun Jul 31 23:35:03 2005
From: listaccount at e-tobi.net (Tobias Grimm)
Date: Sun, 31 Jul 2005 23:35:03 +0200
Subject: [Softdevice-devel] Progress with DirectFB (Work on Debian package
 still in progress...)
In-Reply-To: <20050731192407.GA433171@kosh.hut.fi>
References: <42ED14FF.1040806@e-tobi.net> <20050731192407.GA433171@kosh.hut.fi>
Message-ID: <42ED4407.1080807@e-tobi.net>

Marko M?kel? schrieb:

>Search for the mailing list archive for SIGABRT (that's what signal 6 is
>on GNU/Linux).  I reported that a few months ago.  If I remember correctly,
>it was a permissions problem.  Try to run as root,
>

vdr is running as root.

>or try adding
>no-vt-switch, no-vt-switching,
>

didn't work.

>You could also try building vdr.o with make NO_KBD=1.
>  
>

Haven't tried this yet.

>Try adding "strace" before /usr/bin/vdr.  Then you should get an idea where it
>fails.
>  
>

Mmm... not really:

----------
write(2, "[dfb] Enumeratig display Layers\n", 32[dfb] Enumeratig display
Layers
) = 32
ioctl(11, FBIOPUT_VSCREENINFO, 0xbffff530) = 0
write(13, "\33[?1;0;0c", 9)             = 9
write(13, "\33[9;0]", 6)                = 6
ioctl(11, FBIOPUT_VSCREENINFO, 0xbffff510) = 0
write(13, "\33[?1;0;0c", 9)             = 9
write(13, "\33[9;0]", 6)                = 6
ioctl(11, FBIOPUT_VSCREENINFO, 0xbffff470) = 0
write(13, "\33[?1;0;0c", 9)             = 9
write(13, "\33[9;0]", 6)                = 6
write(2, "Layer 0 FBDev Primary Layer", 27Layer 0 FBDev Primary Layer) = 27
write(2, "  Type: ", 8  Type: )                 = 8
write(2, "graphics ", 9graphics )                = 9
write(2, "\n", 1
)                       = 1
write(2, "  Caps: ", 8  Caps: )                 = 8
write(2, "brightness ", 11brightness )             = 11
write(2, "contrast ", 9contrast )                = 9
write(2, "saturation ", 11saturation )             = 11
write(2, "surface ", 8surface )                 = 8
write(2, "\n", 1
)                       = 1
ioctl(11, FBIOPUT_VSCREENINFO, 0xbffff520) = -1 EINVAL (Invalid argument)
write(13, "\33[?1;0;0c", 9)             = 9
write(13, "\33[9;0]", 6)                = 6
rt_sigprocmask(SIG_UNBLOCK, [ABRT], NULL, 8) = 0
kill(6515, SIGABRT)                     = 0
--- SIGABRT (Aborted) @ 0 (0) ---
gettid()                                = 6515
gettimeofday({1122845106, 858056}, NULL) = 0
write(2, "(!) [ 6515:    0.000] --> Caught"..., 41(!) [ 6515:    0.000]
--> Caught signal 6) = 41
write(2, " (sent by pid 6515, uid 0) <--\n", 31 (sent by pid 6515, uid
0) <--
) = 31
----------


I feel more comfortable with gdb:

----------
Layer 0 FBDev Primary Layer  Type: graphics
  Caps: brightness contrast saturation surface

Program received signal SIGABRT, Aborted.
[Switching to Thread 16384 (LWP 5978)]
0x401a37c1 in kill () from /lib/libc.so.6
(gdb) bt
#0  0x401a37c1 in kill () from /lib/libc.so.6
#1  0x40044771 in pthread_kill () from /lib/libpthread.so.0
#2  0x40044a7b in raise () from /lib/libpthread.so.0
#3  0x401a3554 in raise () from /lib/libc.so.6
#4  0x401a4a88 in abort () from /lib/libc.so.6
#5  0x40126f57 in __cxa_call_unexpected () from /usr/lib/libstdc++.so.5
#6  0x40126f94 in std::terminate () from /usr/lib/libstdc++.so.5
#7  0x40127106 in __cxa_throw () from /usr/lib/libstdc++.so.5
#8  0x40f5dd37 in IDirectFB::CreateSurface () from
/usr/lib/libdfb++-0.9.so.22
#9  0x40ac5642 in cDFBVideoOut (this=0xa050f58, setupStore=0x40e4a1e0)
at video-dfb.c:357
#10 0x40ab5fd3 in cSoftDevice (this=0xa050368, method=3, audioMethod=1,
    pluginPath=0x40daabf4 "./PLUGINS/lib") at softdevice.c:335
#11 0x40ab76d6 in cPluginSoftDevice::Initialize (this=0x820f468) at
softdevice.c:819
#12 0x080f205b in cPluginManager::InitializePlugins (this=0xbffffaa0) at
plugin.c:312
#13 0x0812d8d8 in main (argc=34, argv=0xbffffba4) at vdr.c:589
----------


But this doesn't help me at the moment either. I may need to debug directfb.

>By the way, under kernel 2.6.12.3 and DirectFB 0.9.22, vdr-softdevice works
>  
>

I'm using 2.4.31 with vesafb.

Tobias


From listaccount at e-tobi.net  Sun Jul 31 23:45:55 2005
From: listaccount at e-tobi.net (Tobias Grimm)
Date: Sun, 31 Jul 2005 23:45:55 +0200
Subject: [Softdevice-devel] Work on Debian package still in progress...
In-Reply-To: <200507312129.51538.stefan@lucke.in-berlin.de>
References: <42ED14FF.1040806@e-tobi.net> <200507312129.51538.stefan@lucke.in-berlin.de>
Message-ID: <42ED4693.6070702@e-tobi.net>

Stefan Lucke schrieb:

>With your /etc/directfbrc and your /etc/fb.modes.
>  
>

Ok - but these seem to be ok for the moment. This is the directfbrc:


mode=1024x768
depth=16
no-vt-switch
no-vt-switching

Is there anything I should take care of in fb.modes? (BTW: I'm running
2.4.31 with vesafb)

>>(!) Direct/Modules: Unable to dlopen
>>`/usr/lib/directfb-0.9.22/inputdrivers/libdirectfb_ps2mouse.so'!
>>    --> /usr/lib/directfb-0.9.22/inputdrivers/libdirectfb_ps2mouse.so:
>>undefined symbol: direct_free
>>    
>>
>
>This error message is odd too. Do directfb samples work (like dfbinfo) ?
>  
>

Yes. dfbinfo, df_neo and so on do work, but print the same error message.

> [dfb] Supported video Modes are: 640x480 at 8 640x480 at 8 640x480 at 8 640x480 at 8
>
>>640x480 at 8
>>    
>>
>
>By default directfb uses the first mode specified in fb.modes. I you
>want a higher resolution and/or color depth (you will) you should
>specify them in directfbrc.
>  
>

I've changed this to 1024x768 now. See the new stderr printout et the
end of the mail.

>>[dfb] Enumeratig display Layers
>>Layer 0 FBDev Primary Layer  Type: graphics
>>  Caps: brightness contrast saturation surface
>>(!) [12950:    0.000] --> Caught signal 6 (sent by pid 12950, uid 0) <--
>>/usr/sbin/runvdr: line 1: 12950 Get?tet                
>>    
>>
>
>Thats to my opinion caused by insufficient resolution / color depth.
>  
>

I have 102x769 at 16 now. Should be enough, but doesn't work either.

Tobias

This is the new stderr printout:

Warning! VDR started with root privileges
[softdevice] processing args
[softdevice]   argv [0] = softdevice
[softdevice] initializing Plugin
[softdevice] Initializing Video Out
[softdevice] ffmpeg version(0.4.9-pre1) build(4756)
[dfb] init
(*) DirectFB/Config: Parsing config file '/etc/directfbrc'.

       ---------------------- DirectFB v0.9.22 ---------------------
             (c) 2000-2002  convergence integrated media GmbH
             (c) 2002-2004  convergence GmbH
        -----------------------------------------------------------

(*) DirectFB/Core: Single Application Core. (2005-07-31 15:28)
(*) Direct/Memcpy: Using MMXEXT optimized memcpy()
(!) Direct/Modules: Unable to dlopen
`/usr/lib/directfb-0.9.22/inputdrivers/libdirectfb_ps2mouse.so'!
    --> /usr/lib/directfb-0.9.22/inputdrivers/libdirectfb_ps2mouse.so:
undefined symbol: direct_free
(*) Direct/Thread: Running 'LiRC Input' (INPUT, 7275)...
 (!!!)  *** UNIMPLEMENTED [fusion_reactor_set_lock] ***
[../../../lib/fusion/reactor.c:802]
(*) DirectFB/Input: LIRC Device 0.2 (convergence integrated media GmbH)
(*) Direct/Thread: Running 'Keyboard Input' (INPUT, 7276)...
(*) DirectFB/Input: Keyboard 0.9 (convergence integrated media GmbH)
(*) DirectFB/Genefx: MMX detected and enabled
(*) DirectFB/Graphics: MMX Software Rasterizer 0.6 (convergence
integrated media GmbH)
(*) DirectFB/Core/WM: Default 0.2 (Convergence GmbH)
[dfb] Supported video Modes are: 1024x768 at 16
[dfb] Enumeratig display Layers
Layer 0 FBDev Primary Layer  Type: graphics
  Caps: brightness contrast saturation surface
(!) [ 7265:    0.000] --> Caught signal 6 (sent by pid 7265, uid 0) <--
/usr/sbin/runvdr: line 1:  7265 Get?tet                
LD_ASSUME_KERNEL=2.4.1 /usr/bin/vdr -v /var/lib/video.00 -c /var/lib/vdr
-L /usr/lib/vdr/plugins -r /usr/lib/vdr/vdr-recordingaction -s
/usr/lib/vdr/vdr-shutdown.wrapper -E /var/cache/vdr/epg.data -u root -g
root --port 2001 --lirc -P "sc " -P "image -m
/usr/lib/vdr-plugin-image/mount.sh -C
/usr/lib/vdr-plugin-image/imageplugin.sh" -P "softdevice -vo dfb:" -P
femon -P epgsearch -P "tvonscreen -v /var/lib/vdradmin/vdradmind.at" -P
"dvd -C /var/cache/vdr/dvd" -P radio -P "autotimeredit " -w 60 --allow-root



From M.Wache at gmx.net  Mon Aug  1 00:06:39 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 01 Aug 2005 00:06:39 +0200
Subject: [Softdevice-devel] Work on Debian package still in progress...
In-Reply-To: <42ED4693.6070702@e-tobi.net>
References: <42ED14FF.1040806@e-tobi.net> <200507312129.51538.stefan@lucke.in-berlin.de> <42ED4693.6070702@e-tobi.net>
Message-ID: <42ED4B6F.3000209@gmx.net>

Tobias Grimm schrieb:

> Is there anything I should take care of in fb.modes? (BTW: I'm running
> 2.4.31 with vesafb)
> 

This is the problem, with vesafb you don't have access to the
accelerated video functions. You need to use the specialized fb modules
like matroxfb, rage128fb or viafb.
Your mainboard has a UnichromePro chipset, doesn't it? I know that
Unichrome is well supported, but I'm not so sure about UnichromePro...
If I remember correctly there are two alternative fb drivers for
Unichrome, the pros and cons of them where discussed here on this list
some time ago, but I don't remember any details...

Martin


From listaccount at e-tobi.net  Mon Aug  1 01:20:34 2005
From: listaccount at e-tobi.net (Tobias Grimm)
Date: Mon, 01 Aug 2005 01:20:34 +0200
Subject: [Softdevice-devel] Work on Debian package still in progress...
In-Reply-To: <42ED4B6F.3000209@gmx.net>
References: <42ED14FF.1040806@e-tobi.net> <200507312129.51538.stefan@lucke.in-berlin.de> <42ED4693.6070702@e-tobi.net> <42ED4B6F.3000209@gmx.net>
Message-ID: <42ED5CC2.8000505@e-tobi.net>

Martin Wache schrieb:

>You need to use the specialized fb modules
>like matroxfb, rage128fb or viafb.
>  
>

>Your mainboard has a UnichromePro chipset, doesn't it?
>

Yes.

>I know that Unichrome is well supported, but I'm not so sure about UnichromePro...
>  
>

Work on the K8M800 in the unichrome project seems to be in progress.
Xorg drivers in CVS should work, but I haven't tested it yet.

>If I remember correctly there are two alternative fb drivers for
>Unichrome, the pros and cons of them where discussed here on this list
>some time ago, but I don't remember any details...
>  
>

I only know of the viafb driver, offered by VIA - I couldn't test it
yet, because I failed to create a Debian kernel module package for it.

I searched this list, but couldn't find a another fb driver for the VIA
chipset. Does anyone know which alternative driver this may be?

If I can't get viafb to work, I will probably install a  Nvidia card.
This souldn't make any problems, should it?

Tobias



From vcatana at registru.md  Mon Aug  1 07:53:33 2005
From: vcatana at registru.md (Vadim Catana)
Date: Mon, 01 Aug 2005 08:53:33 +0300
Subject: [Softdevice-devel] SkyStar2 module, device 3 has no lock
In-Reply-To: <1122830750135.voitto.tuomainen.53421.Z3cMtYWhAGLl62RphmshlA@luukku.com>
References: <1122830750135.voitto.tuomainen.53421.Z3cMtYWhAGLl62RphmshlA@luukku.com>
Message-ID: <42EDB8DD.5090507@registru.md>

Voitto Tuomainen wrote:
> Hi,
> I'm not very sure were to email this, but let's start here because I think, I've seen the author (Vadim Catana) of the skystar2 driver emailing here.

The skystar2 driver was rewritten by Patrick Boettcher, please use the new driver,
the old driver is not supported any more.

> My system:
> - two Technisat Airstar2 PCI card (budget cards)
> - one Technisat Skystar2
> - gentoo (latest snapshot)
> - kernel 2.6.12-gentoo-r6
> - udev 064
> - vdr 1.3.27
> - softdevice cvs latest (31.7.)

I'm using only one Skystar2 card, so I can't say how VDR behaves in multicard
setups. I don't think this is caused by the skystar2 driver or softdevice
plugin. You should probably ask on the VDR mailing list.

------------------
Regards,
Vadim Catana


From linuxtvmaker at yahoo.es  Mon Aug  1 12:27:55 2005
From: linuxtvmaker at yahoo.es (Rose M)
Date: Mon, 1 Aug 2005 12:27:55 +0200 (CEST)
Subject: [Softdevice-devel] VDR with DirectFB & Softdevice
Message-ID: <20050801102756.98240.qmail@web26302.mail.ukl.yahoo.com>

Hello list, 

I've compiled DirectFB like in VDR wiki is post to use
softdevice with a matrox G550 card. All seems to be
ok, but when I run vdr with softdevice plugin the only
output I got is that:

[softdevice] processing args
[softdevice]   argv [0] = softdevice
[softdevice] initializing Plugin
[softdevice] Initializing Video Out
[softdevice] ffmpeg version(0.4.9-pre1) build(4718)

my /var/log/messages:

Aug  1 12:22:57 sony-42d550fe10 vdr[12876]: VDR
version 1.3.17 started
Aug  1 12:22:57 sony-42d550fe10 vdr[12876]: loading
plugin: ./PLUGINS/lib/libvdr-softdevice.so.1.3.17
Aug  1 12:22:57 sony-42d550fe10 vdr[12876]: loading
/video/sources.conf
Aug  1 12:22:57 sony-42d550fe10 vdr[12876]: loading
/video/diseqc.conf
Aug  1 12:22:57 sony-42d550fe10 vdr[12876]: loading
/video/channels.conf
Aug  1 12:22:57 sony-42d550fe10 vdr[12876]: loading
/video/svdrphosts.conf
Aug  1 12:22:57 sony-42d550fe10 vdr[12876]: loading
/video/ca.conf
Aug  1 12:22:57 sony-42d550fe10 vdr[12876]: loading
/video/keymacros.conf
Aug  1 12:22:57 sony-42d550fe10 vdr[12876]: found 1
video device
Aug  1 12:22:57 sony-42d550fe10 vdr[12876]:
initializing plugin: softdevice (0.1.1): A software
emulated MPEG2 device
Aug  1 12:22:57 sony-42d550fe10 vdr[12876]:
[softdevice] could not load
(./PLUGINS/lib/libvdr-softdevice-dfb.so.1.3.17)[./PLUGINS/lib/libvdr-softdevice-dfb.so.1.3.17:
cannot open shared object file: No such file or
directory] exiting

But my question is: How this lib is created?
Softdevice only creates libvdr-softdevice.so.1.3.17!

Is it caused by Ffmpeg?

Any idea would be well-comed! (Sorry for my English)

Rose M


		
______________________________________________ 
Renovamos el Correo Yahoo! 
Nuevos servicios, m?s seguridad 
http://correo.yahoo.es


From stefan at lucke.in-berlin.de  Mon Aug  1 22:37:20 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 1 Aug 2005 22:37:20 +0200
Subject: [Softdevice-devel] VDR with DirectFB & Softdevice
In-Reply-To: <20050801102756.98240.qmail@web26302.mail.ukl.yahoo.com>
References: <20050801102756.98240.qmail@web26302.mail.ukl.yahoo.com>
Message-ID: <200508012237.20538.stefan@lucke.in-berlin.de>

On Montag, 1. August 2005 12:27, Rose M wrote:
> Hello list, 
> 
> I've compiled DirectFB like in VDR wiki is post to use
> softdevice with a matrox G550 card. All seems to be
> ok, but when I run vdr with softdevice plugin the only
> output I got is that:
> 
> [softdevice] processing args
> [softdevice]   argv [0] = softdevice
> [softdevice] initializing Plugin
> [softdevice] Initializing Video Out
> [softdevice] ffmpeg version(0.4.9-pre1) build(4718)
> 
> my /var/log/messages:
> 
> Aug  1 12:22:57 sony-42d550fe10 vdr[12876]: VDR
> version 1.3.17 started
> Aug  1 12:22:57 sony-42d550fe10 vdr[12876]: loading
> plugin: ./PLUGINS/lib/libvdr-softdevice.so.1.3.17

[ .. ]
> Aug  1 12:22:57 sony-42d550fe10 vdr[12876]: found 1
> video device
> Aug  1 12:22:57 sony-42d550fe10 vdr[12876]:
> initializing plugin: softdevice (0.1.1): A software
> emulated MPEG2 device

Version 0.1.1 is a bit outdated.

> Aug  1 12:22:57 sony-42d550fe10 vdr[12876]:
> [softdevice] could not load
> (./PLUGINS/lib/libvdr-softdevice-dfb.so.1.3.17)[./PLUGINS/lib/libvdr-softdevice-dfb.so.1.3.17:
> cannot open shared object file: No such file or
> directory] exiting

Did you change something (option USE_SUBPLUGINS) in your Makefile _without_ "make clean" in
softdevice directory or "make plugins-clean" in vdr directory ?

> 
> But my question is: How this lib is created?
> Softdevice only creates libvdr-softdevice.so.1.3.17!
> 
> Is it caused by Ffmpeg?

No.


-- 
Stefan Lucke



From linuxtvmaker at yahoo.es  Tue Aug  2 10:22:05 2005
From: linuxtvmaker at yahoo.es (Rose M)
Date: Tue, 2 Aug 2005 10:22:05 +0200 (CEST)
Subject: [Softdevice-devel] VDR with DirectFB & Softdevice
In-Reply-To: <200508012237.20538.stefan@lucke.in-berlin.de>
Message-ID: <20050802082205.95907.qmail@web26303.mail.ukl.yahoo.com>

Hello Stefan (& all), 

 --- Stefan Lucke <stefan at lucke.in-berlin.de>
escribi?:

> On Montag, 1. August 2005 12:27, Rose M wrote:
> > Hello list, 
> > 
> > I've compiled DirectFB like in VDR wiki is post to
> use
> > softdevice with a matrox G550 card. All seems to
> be
> > ok, but when I run vdr with softdevice plugin the
> only
> > output I got is that:
> > 
> > [softdevice] processing args
> > [softdevice]   argv [0] = softdevice
> > [softdevice] initializing Plugin
> > [softdevice] Initializing Video Out
> > [softdevice] ffmpeg version(0.4.9-pre1)
> build(4718)
> > 
> > my /var/log/messages:
> > 
> > Aug  1 12:22:57 sony-42d550fe10 vdr[12876]: VDR
> > version 1.3.17 started
> > Aug  1 12:22:57 sony-42d550fe10 vdr[12876]:
> loading
> > plugin: ./PLUGINS/lib/libvdr-softdevice.so.1.3.17
> 
> [ .. ]
> > Aug  1 12:22:57 sony-42d550fe10 vdr[12876]: found
> 1
> > video device
> > Aug  1 12:22:57 sony-42d550fe10 vdr[12876]:
> > initializing plugin: softdevice (0.1.1): A
> software
> > emulated MPEG2 device
> 
> Version 0.1.1 is a bit outdated.
> 
> > Aug  1 12:22:57 sony-42d550fe10 vdr[12876]:
> > [softdevice] could not load
> >
>
(./PLUGINS/lib/libvdr-softdevice-dfb.so.1.3.17)[./PLUGINS/lib/libvdr-softdevice-dfb.so.1.3.17:
> > cannot open shared object file: No such file or
> > directory] exiting
> 
> Did you change something (option USE_SUBPLUGINS) in
> your Makefile _without_ "make clean" in
> softdevice directory or "make plugins-clean" in vdr
> directory ?
> 

If this means change vdr Makefile, no. I only changed
softdevice Makefile to comment the lines that refers
to FB_SUPPORT, VIDIX_SUPPORT, etc. leaving only the
DFB_SUPPORT.
I've tried compiling with FB and DFB but I've done
make clean before anything. I will repeat it now cause
maybe it's possible that I make something wrong. If
you think in another thing, let me know. I would reply
in short.

Thanks anyway!

> > 
> > But my question is: How this lib is created?
> > Softdevice only creates
> libvdr-softdevice.so.1.3.17!
> > 
> > Is it caused by Ffmpeg?
> No.
> -- 
> Stefan Lucke




		
______________________________________________ 
Renovamos el Correo Yahoo! 
Nuevos servicios, m?s seguridad 
http://correo.yahoo.es


From marko.makela at hut.fi  Tue Aug  2 10:36:07 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 2 Aug 2005 11:36:07 +0300
Subject: [Softdevice-devel] VDR with DirectFB & Softdevice
In-Reply-To: <20050802082205.95907.qmail@web26303.mail.ukl.yahoo.com>
References: <200508012237.20538.stefan@lucke.in-berlin.de> <20050802082205.95907.qmail@web26303.mail.ukl.yahoo.com>
Message-ID: <20050802083607.GC3864@localhost.localdomain>

On Tue, Aug 02, 2005 at 10:22:05AM +0200, Rose M wrote:
> > Did you change something (option USE_SUBPLUGINS) in
> > your Makefile _without_ "make clean" in
> > softdevice directory or "make plugins-clean" in vdr
> > directory ?
> > 
> 
> If this means change vdr Makefile, no. I only changed
> softdevice Makefile to comment the lines that refers
> to FB_SUPPORT, VIDIX_SUPPORT, etc. leaving only the
> DFB_SUPPORT.

The USE_SUBPLUGINS definition is in the softdevice Makefile.
If you edit the softdevice Makefile, it is best to rebuild
softdevice from the scratch.

> I've tried compiling with FB and DFB but I've done
> make clean before anything.

In my experience, "make clean" does not remove plugin objects.
I have done explicit rm PLUGINS/src/softdevice/*.o, because
I was not aware of "make plugins-clean", which Stefan mentioned.
Please run "make plugins-clean" and "make plugins".

	Marko


From linuxtvmaker at yahoo.es  Tue Aug  2 11:26:38 2005
From: linuxtvmaker at yahoo.es (Rose M)
Date: Tue, 2 Aug 2005 11:26:38 +0200 (CEST)
Subject: [Softdevice-devel] VDR with DirectFB & Softdevice
In-Reply-To: <20050802083607.GC3864@localhost.localdomain>
Message-ID: <20050802092638.86509.qmail@web26305.mail.ukl.yahoo.com>

Ok,
 --- Marko M?kel? <marko.makela at hut.fi> escribi?:

> On Tue, Aug 02, 2005 at 10:22:05AM +0200, Rose M
> wrote:
> > > Did you change something (option USE_SUBPLUGINS)
> in
> > > your Makefile _without_ "make clean" in
> > > softdevice directory or "make plugins-clean" in
> vdr
> > > directory ?
> > > 
> > 
> > If this means change vdr Makefile, no. I only
> changed
> > softdevice Makefile to comment the lines that
> refers
> > to FB_SUPPORT, VIDIX_SUPPORT, etc. leaving only
> the
> > DFB_SUPPORT.
> 
> The USE_SUBPLUGINS definition is in the softdevice
> Makefile.
> If you edit the softdevice Makefile, it is best to
> rebuild
> softdevice from the scratch.
> 
> > I've tried compiling with FB and DFB but I've done
> > make clean before anything.
> 
> In my experience, "make clean" does not remove
> plugin objects.
> I have done explicit rm PLUGINS/src/softdevice/*.o,
> because
> I was not aware of "make plugins-clean", which
> Stefan mentioned.
> Please run "make plugins-clean" and "make plugins".
> 
> 	Marko
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
>
http://lists.berlios.de/mailman/listinfo/softdevice-devel
> 



		
______________________________________________ 
Renovamos el Correo Yahoo! 
Nuevos servicios, m?s seguridad 
http://correo.yahoo.es


From linuxtvmaker at yahoo.es  Tue Aug  2 11:33:07 2005
From: linuxtvmaker at yahoo.es (Rose M)
Date: Tue, 2 Aug 2005 11:33:07 +0200 (CEST)
Subject: [Softdevice-devel] VDR with DirectFB & Softdevice
In-Reply-To: <20050802083607.GC3864@localhost.localdomain>
Message-ID: <20050802093307.6486.qmail@web26307.mail.ukl.yahoo.com>

I've done that but anything changes.
I've cleaned plugins and vdr and compiled them but I
obtained the same results.
I didn't change USE_SUBPLUGINS, it is set, but the
library continues without being created.
Now, I will try with last softdevice version. Any more
help? 
Very grateful,

Rose M

 --- Marko M?kel? <marko.makela at hut.fi> escribi?:

> On Tue, Aug 02, 2005 at 10:22:05AM +0200, Rose M
> wrote:
> > > Did you change something (option USE_SUBPLUGINS)
> in
> > > your Makefile _without_ "make clean" in
> > > softdevice directory or "make plugins-clean" in
> vdr
> > > directory ?
> > > 
> > 
> > If this means change vdr Makefile, no. I only
> changed
> > softdevice Makefile to comment the lines that
> refers
> > to FB_SUPPORT, VIDIX_SUPPORT, etc. leaving only
> the
> > DFB_SUPPORT.
> 
> The USE_SUBPLUGINS definition is in the softdevice
> Makefile.
> If you edit the softdevice Makefile, it is best to
> rebuild
> softdevice from the scratch.
> 
> > I've tried compiling with FB and DFB but I've done
> > make clean before anything.
> 
> In my experience, "make clean" does not remove
> plugin objects.
> I have done explicit rm PLUGINS/src/softdevice/*.o,
> because
> I was not aware of "make plugins-clean", which
> Stefan mentioned.
> Please run "make plugins-clean" and "make plugins".
> 
> 	Marko
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
>
http://lists.berlios.de/mailman/listinfo/softdevice-devel
> 



		
______________________________________________ 
Renovamos el Correo Yahoo! 
Nuevos servicios, m?s seguridad 
http://correo.yahoo.es


From linuxtvmaker at yahoo.es  Tue Aug  2 12:36:26 2005
From: linuxtvmaker at yahoo.es (Rose M)
Date: Tue, 2 Aug 2005 12:36:26 +0200 (CEST)
Subject: [Softdevice-devel] VDR with DirectFB & Softdevice
In-Reply-To: <20050802093307.6486.qmail@web26307.mail.ukl.yahoo.com>
Message-ID: <20050802103627.72202.qmail@web26306.mail.ukl.yahoo.com>

Good and bad news,
I compiled last version of softdevice and libs has
been created.
But... vdr doesn't work, it crash with a segfault.
This is the output:

./vdr -Psoftdevice
[softdevice] processing args
[softdevice]   argv [0] = softdevice
Segmentation fault

in var/log/messages anything seems to be wrong:

Aug  2 12:35:43 esbcntinlt002 vdr[4835]: VDR version
1.3.17 started
Aug  2 12:35:43 esbcntinlt002 vdr[4835]: loading
plugin: ./PLUGINS/lib/libvdr-softdevice.so.1.3.17

Any idea about this problem with segmentation fault?
Thanks in advance!

Rose M

 --- Rose M <linuxtvmaker at yahoo.es> escribi?:

> I've done that but anything changes.
> I've cleaned plugins and vdr and compiled them but I
> obtained the same results.
> I didn't change USE_SUBPLUGINS, it is set, but the
> library continues without being created.
> Now, I will try with last softdevice version. Any
> more
> help? 
> Very grateful,
> 
> Rose M
> 
>  --- Marko M?kel? <marko.makela at hut.fi> escribi?:
> 
> > On Tue, Aug 02, 2005 at 10:22:05AM +0200, Rose M
> > wrote:
> > > > Did you change something (option
> USE_SUBPLUGINS)
> > in
> > > > your Makefile _without_ "make clean" in
> > > > softdevice directory or "make plugins-clean"
> in
> > vdr
> > > > directory ?
> > > > 
> > > 
> > > If this means change vdr Makefile, no. I only
> > changed
> > > softdevice Makefile to comment the lines that
> > refers
> > > to FB_SUPPORT, VIDIX_SUPPORT, etc. leaving only
> > the
> > > DFB_SUPPORT.
> > 
> > The USE_SUBPLUGINS definition is in the softdevice
> > Makefile.
> > If you edit the softdevice Makefile, it is best to
> > rebuild
> > softdevice from the scratch.
> > 
> > > I've tried compiling with FB and DFB but I've
> done
> > > make clean before anything.
> > 
> > In my experience, "make clean" does not remove
> > plugin objects.
> > I have done explicit rm
> PLUGINS/src/softdevice/*.o,
> > because
> > I was not aware of "make plugins-clean", which
> > Stefan mentioned.
> > Please run "make plugins-clean" and "make
> plugins".
> > 
> > 	Marko



		
______________________________________________ 
Renovamos el Correo Yahoo! 
Nuevos servicios, m?s seguridad 
http://correo.yahoo.es


From marko.makela at hut.fi  Tue Aug  2 13:56:40 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 2 Aug 2005 14:56:40 +0300
Subject: [Softdevice-devel] VDR with DirectFB & Softdevice
In-Reply-To: <20050802103627.72202.qmail@web26306.mail.ukl.yahoo.com>
References: <20050802093307.6486.qmail@web26307.mail.ukl.yahoo.com> <20050802103627.72202.qmail@web26306.mail.ukl.yahoo.com>
Message-ID: <20050802115640.GE3864@localhost.localdomain>

On Tue, Aug 02, 2005 at 12:36:26PM +0200, Rose M wrote:
> I compiled last version of softdevice and libs has
> been created.
> But... vdr doesn't work, it crash with a segfault.
> This is the output:
> 
> ./vdr -Psoftdevice
> [softdevice] processing args
> [softdevice]   argv [0] = softdevice
> Segmentation fault

Have you checked that the file PLUGINS/lib/libvdr-softdevice*
(or something like that) has a recent modification date?  It
should have been built by the most recent "make plugins".

Hmm, was my patch a couple of months ago (crash on start) committed to CVS?
Which one are you using: the last released version of softdevice or the most
recent CVS snapshot?  That bug might be present in the last released
version of softdevice.

> Any idea about this problem with segmentation fault?
> Thanks in advance!

Run vdr inside gdb:
$ gdb vdr
(gdb) run -Psoftdevice

When it crashes, type "bt" or "bt full" at the "(gdb) " prompt
and post the resulting stack trace.

	Marko


From stefan at lucke.in-berlin.de  Tue Aug  2 15:51:23 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue,  2 Aug 2005 15:51:23 +0200
Subject: [Softdevice-devel] VDR with DirectFB & Softdevice
In-Reply-To: <20050802115640.GE3864@localhost.localdomain>
References: <20050802093307.6486.qmail@web26307.mail.ukl.yahoo.com> <20050802103627.72202.qmail@web26306.mail.ukl.yahoo.com> <20050802115640.GE3864@localhost.localdomain>
Message-ID: <1122990683.42ef7a5b5241d@webmail.in-berlin.de>

Quoting Marko M?kel? <marko.makela at hut.fi>:

> On Tue, Aug 02, 2005 at 12:36:26PM +0200, Rose M wrote:
> > I compiled last version of softdevice and libs has
> > been created.
> > But... vdr doesn't work, it crash with a segfault.
> > This is the output:
> >
> > ./vdr -Psoftdevice
> > [softdevice] processing args
> > [softdevice]   argv [0] = softdevice
> > Segmentation fault
>
> Have you checked that the file PLUGINS/lib/libvdr-softdevice*
> (or something like that) has a recent modification date?  It
> should have been built by the most recent "make plugins".
>
> Hmm, was my patch a couple of months ago (crash on start) committed to CVS?

The "continue" fix for command line parsing is in cvs (but not in 0.1.2).

Stefan Lucke


From M.Wache at gmx.net  Tue Aug  2 21:50:15 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 02 Aug 2005 21:50:15 +0200
Subject: [Softdevice-devel] Work on Debian package still in progress...
In-Reply-To: <42ED5CC2.8000505@e-tobi.net>
References: <42ED14FF.1040806@e-tobi.net> <200507312129.51538.stefan@lucke.in-berlin.de> <42ED4693.6070702@e-tobi.net> <42ED4B6F.3000209@gmx.net> <42ED5CC2.8000505@e-tobi.net>
Message-ID: <42EFCE77.6010706@gmx.net>

Tobias Grimm schrieb:

> Work on the K8M800 in the unichrome project seems to be in progress.
> Xorg drivers in CVS should work, but I haven't tested it yet.
> 
The Xorg driver works but it is dead slow on video output... And I fear
that the unichrome project is in danger to die. Some of the developers
left the project and only want to contribute directly to Xorg, and there
have been almost no commits since this time.

> 
>>If I remember correctly there are two alternative fb drivers for
>>Unichrome, the pros and cons of them where discussed here on this list
>>some time ago, but I don't remember any details...
>> 
> 
> I only know of the viafb driver, offered by VIA - I couldn't test it
> yet, because I failed to create a Debian kernel module package for it.
> 
> I searched this list, but couldn't find a another fb driver for the VIA
> chipset. Does anyone know which alternative driver this may be?
> 
Hmm, maybe I remember the discussion from somewhere else, or I'm
completly mistaken :-/

> If I can't get viafb to work, I will probably install a  Nvidia card.
> This souldn't make any problems, should it?

I'm sorry, but I don't really know. I guess it should work, but I only
remember people reporting useing Xv with Nvidias.

Bye,
Martin


From marko.makela at hut.fi  Wed Aug  3 14:07:56 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 3 Aug 2005 15:07:56 +0300
Subject: [Softdevice-devel] Missing catch statements in video-dfb.c cause crashes
In-Reply-To: <20050731192407.GA433171@kosh.hut.fi>
References: <42ED14FF.1040806@e-tobi.net> <20050731192407.GA433171@kosh.hut.fi>
Message-ID: <20050803120756.GB5127@localhost.localdomain>

On Sun, Jul 31, 2005 at 10:24:07PM +0300, Marko M?kel? wrote:
> If I'm on a different virtual console than where VDR was started from,
> VDR occasionally crashes when trying to update the OSD.

I got a stack trace by attaching gdb (running on an OpenSSH connection)
to the running vdr process, then switching virtual consoles and pressing
OK two times to trigger OSD updates.  The first press of OK displayed
the information window as expected, but the second press of OK caused
vdr to crash:

Program received signal SIGABRT, Aborted.
[Switching to Thread -1210542208 (LWP 980)]
0xb7db283b in raise () from /lib/tls/libc.so.6
(gdb) bt
#0  0xb7db283b in raise () from /lib/tls/libc.so.6
#1  0xb7db3fa2 in abort () from /lib/tls/libc.so.6
#2  0xb784ada7 in __cxa_call_unexpected () from /usr/lib/libstdc++.so.5
#3  0xb784ade4 in std::terminate () from /usr/lib/libstdc++.so.5
#4  0xb784af56 in __cxa_throw () from /usr/lib/libstdc++.so.5
#5  0xb78d662a in IDirectFBSurface::Flip (this=0x6, region=0x0,
    flags=DSFLIP_NONE) at idirectfbsurface.cpp:128
#6  0xb7a25170 in cDFBVideoOut::CloseOSD (this=0x8249c70) at video-dfb.c:1006
#7  0xb7a139a4 in ~cSoftOsd (this=0x86754f8) at softdevice.c:117
#8  0x080d7be4 in ~cSkinSTTNGDisplayChannel (this=0x868cd08) at skinsttng.c:224
#9  0x080b2fcf in ~cDisplayChannel (this=0x8691af8) at menu.c:2707
#10 0x080f05ac in main (argc=7, argv=0xbfcfd534) at vdr.c:802

It looks like cDFBVideoOut::CloseOSD() is invoking tmpSurface->Flip()
on an invalid tmpSurface object, or it is not catching the exception.
I added some diagnostics to catch the exception:

diff -u -r1.36 video-dfb.c
--- video-dfb.c 27 Jul 2005 20:57:00 -0000      1.36
+++ video-dfb.c 3 Aug 2005 12:02:04 -0000
@@ -998,12 +1002,17 @@
   }
   else
   {
+fprintf(stderr, "CloseOSD(): tmpSurface=%p\n", tmpSurface);
+    try {
     tmpSurface->Clear(COLORKEY,clearAlpha); //clear and
     tmpSurface->Flip(); // Flip the field
     if (!isVIAUnichrome)
     {
       tmpSurface->Clear(COLORKEY,clearAlpha); //clear and
       tmpSurface->Flip(); // Flip the field
+    }
+    } catch (DFBException *ex){
+      fprintf(stderr,"--- CloseOSD failed: tmpSurface=%p\n", tmpSurface);
     }
   }

By the way, does the DFBException need to be freed?  I have always
avoided exceptions in my C++ code to avoid memory leaks.

Here's the relevant snip from stderr on the new test run:

[surface capabilities] videoSurface: videoonly double-buffered flipping
[dfb] (re)configured 0x08100609
CloseOSD(): tmpSurface=0x82a7930
++CloseOSD(): tmpSurface=0x82a7930
(!) DirectFB/FBDev: Panning display failed!
    --> Invalid argument
--- CloseOSD failed: tmpSurface=0x82a7930
(!) DirectFB/FBDev: Panning display failed!
    --> Invalid argument

At this point, I got another crash:

#0  0xb7d1c83b in raise () from /lib/tls/libc.so.6
#1  0xb7d1dfa2 in abort () from /lib/tls/libc.so.6
#2  0xb77b4da7 in __cxa_call_unexpected () from /usr/lib/libstdc++.so.5
#3  0xb77b4de4 in std::terminate () from /usr/lib/libstdc++.so.5
#4  0xb77b4f56 in __cxa_throw () from /usr/lib/libstdc++.so.5
#5  0xb784062a in IDirectFBSurface::Flip (this=0x6, region=0x0,
    flags=DSFLIP_NONE) at idirectfbsurface.cpp:128
#6  0xb798f089 in cDFBVideoOut::OpenOSD (this=0x8253bd0, x=0, y=0)
    at video-dfb.c:899
#7  0xb797d917 in cSoftOsd (this=0x85166f8, VideoOut=0x8253bd0, X=54, Y=45)
    at softdevice.c:108
#8  0xb797db5a in cSoftOsdProvider::CreateOsd (this=0x82af630, Left=0, Top=0)
    at softdevice.c:163
#9  0x080dd585 in cSkinSTTNGDisplayChannel (this=0x8528d68, WithInfo=true)
    at skinsttng.c:178
#10 0x080dd9bd in cSkinSTTNG::DisplayChannel (this=0x82b6b90, WithInfo=true)
    at skinsttng.c:1087
#11 0x080b2d70 in cDisplayChannel (this=0x831fd00, Number=0, Switched=false)
    at menu.c:2681
#12 0x080efb0d in main (argc=7, argv=0xbf966c44) at vdr.c:590

It looks like all DirectFB operations should be governed by catch
statements.  Is someone working on video-dfb.c right now?  If not,
I may give this a try.  (We are about to get our 2nd baby in these
days, so this can happen in a few days or weeks, depending on the
timing.)

	Marko


From leo at calidae.net  Wed Aug  3 18:14:46 2005
From: leo at calidae.net (=?ISO-8859-1?Q?Leo_M=E1rquez?=)
Date: Wed, 03 Aug 2005 18:14:46 +0200
Subject: [Softdevice-devel] libavcodec does not match avcodec.h
Message-ID: <42F0ED76.4050804@calidae.net>

Hi!,

After having my vdr with dvb output I have decide try softdevice and use 
the svideo out of my epia (unichrome).
I have directfb, ffmpeg and (I think) have all the stuff to run ok. But 
in the vdr output appears some warnings that I can't understand.
And finally appears an error that hangs vdr.
I think the problem is between libavcodec, avcodec.h and ffmpeg???? 
because seems to be diferent incompatible builds (4753-4752).
Anyone knows how solve the problem?
I have kernel 2.6.11, one ff card and one budget and debian as distribution.
Thanks!!!!
I put all the putput here:

[softdevice] processing args
[softdevice]   argv [0] = softdevice
[softdevice] initializing Plugin
[softdevice] Initializing Video Out
[softdevice] ffmpeg version(cvs) build(4752)
[dfb] init

       ---------------------- DirectFB v0.9.22 ---------------------
             (c) 2000-2002  convergence integrated media GmbH
             (c) 2002-2004  convergence GmbH
        -----------------------------------------------------------

(*) DirectFB/Core: Single Application Core. (2005-05-27 21:18)
(*) Direct/Memcpy: Using SSE optimized memcpy()
(*) Direct/Thread: Running 'VT Switcher' (CRITICAL, 3178)...
(*) Direct/Thread: Running 'PS/2 Input' (INPUT, 3179)...
 (!!!)  *** UNIMPLEMENTED [fusion_reactor_set_lock] *** [reactor.c:802]
(*) DirectFB/Input: IMPS/2 Mouse 1.0 (Convergence GmbH)
(*) Direct/Thread: Running 'Keyboard Input' (INPUT, 3180)...
(*) DirectFB/Input: Keyboard 0.9 (convergence integrated media GmbH)
(*) DirectFB/Genefx: MMX detected and enabled
(*) DirectFB/Graphics: VIA/S3G UniChrome 0.4 (-)
(*) DirectFB/Core/WM: Default 0.2 (Convergence GmbH)
[dfb] Supported video Modes are: 640x480 at 32 640x480 at 32 640x480 at 32 
640x480 at 32 640x480 at 32 720x480 at 32 720x576 at 32 800x600 at 32 800x600 at 32 
800x600 at 32 800x600 at 32 800x600 at 32 848x480 at 32 856x480 at 32 1024x512 at 32 
1024x768 at 32 1024x768 at 32 1024x768 at 32 1024x768 at 32 1152x864 at 32 1152x864 at 32 
1280x768 at 32 1280x960 at 32 1280x1024 at 32 1280x1024 at 32 1280x1024 at 32 
1600x1200 at 32 1600x1200 at 32 1400x1050 at 32
[dfb] Enumeratig display Layers
Layer 0 FBDev Primary Layer  Type: graphics
  Caps: brightness contrast saturation surface
Layer 1 VIA Unichrome Video  Type: graphics picture video
  Caps: deinterlacing dst_colorkey opacity screen_location surface
uc_overlay: color-keying is disabled
[surface capabilities] scrSurface: primary videoonly double-buffered 
flipping
[dfb] width = 640, height = 480
[dfb] got fmt = 0x00418c04 bpp = 32
[dfb] Using this layer for OSD: (FBDev Primary Layer - [640x480])
[surface capabilities] osdSurface: videoonly double-buffered flipping
 (!!!)  *** WARNING [letting unprivileged 
IDirectFBDisplayLayer::GetSurface() call pass until cooperative level 
handling is finished] *** [idirectfbdisplaylayer.c:170 in 
IDirectFBDisplayLayer_GetSurface()]
[surface capabilities] videoSurface: videoonly
[dfb] Configuring CooperativeLevel for Overlay
[dfb] Configuring CooperativeLevel for OSD
[dfb] Using this layer for OSD: FBDev Primary Layer
[dfb] Using this layer for Video out: VIA Unichrome Video
[dfb] (re)configuring Videolayer to 720 x 576 (720x576)
Caught: action=IDirectFBDisplayLayer::SetLevel(int), result=Not 
supported! Failed: SetLevel()
uc_overlay: color-keying is enabled
uc_overlay: color-keying is enabled
uc_overlay: color-keying is enabled
uc_overlay: color-keying is enabled
[surface capabilities] videoSurface: videoonly double-buffered flipping
[dfb] (re)configured 0x08100609
Subplugin successfully opend
[softdevice] Video Out seems to be OK
[softdevice] Initializing Audio Out
[softdevice] Audio out seems to be OK
[softdevice] A/V devices initialized, now initializing MPEG2 Decoder
Fatal Error! Libavcodec library build(4753) doesn't match avcodec.h 
build(4752)!!!
Check your ffmpeg installation / the pathes in the Makefile!!!
 (!!!)  *** WARNING [Application exited without deinitialization of 
DirectFB!] *** [core.c:628 in dfb_core_deinit_check()]




From marko.makela at hut.fi  Wed Aug  3 19:38:15 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 3 Aug 2005 20:38:15 +0300
Subject: [Softdevice-devel] [PATCH] Added catch statements to video-dfb.c
In-Reply-To: <20050803120756.GB5127@localhost.localdomain>
References: <42ED14FF.1040806@e-tobi.net> <20050731192407.GA433171@kosh.hut.fi> <20050803120756.GB5127@localhost.localdomain>
Message-ID: <20050803173814.GA477552@kosh.hut.fi>

On Wed, Aug 03, 2005 at 03:07:56PM +0300, Marko M?kel? wrote:
> By the way, does the DFBException need to be freed?  I have always
> avoided exceptions in my C++ code to avoid memory leaks.

Based on a quick Google search and a look at the DFB++ source code,
it seems that the exception object indeed needs to be freed.

DFB++ appears to be a wrapper over DirectFB that maps nonzero
values to exceptions.  I'd rather use the DirectFB C interface
and perhaps add __attribute__((warn_unused_result)) to the
functions.  However, when used properly, exceptions can make
the code more readable (no "if this fails, do that" clutter).

> It looks like all DirectFB operations should be governed by catch
> statements.  Is someone working on video-dfb.c right now?  If not,
> I may give this a try.

Oh well, I decided that it is not too much work.  I hope
I caught all cases (I have a stripped-down system on my VDR
box, and I edited the file with vi).

I think that the code could be simplified further.  There
are several try-catch blocks in the SetParams method, because
I was not sure if some of the errors can be ignored.

While writing the patch, I also fixed some formatting things.
It found two indentation styles and tried to follow the one
that seemed more frequent.  But I didn't at first notice that
variable declarations are indented by one extra level.

I also corrected a few spelling mistakes in output messages
and replaced the only non-ASCII character in the file with
the string "micro".  (I think that latin1 characters should
be avoided in output messages, because UTF-8 is becoming
more and more common.)

Please apply this patch, as it greatly increases the stability
of softdevice and makes it possible to use text console
on top of the vdr screen (which is very useful if you want
to check something quickly on the box while watching TV).

I tested the patch by leaning on the OK key on my RCU
(which causes the cx88 driver to generate keypress events
several times per second) while flipping virtual consoles
with Alt-F1 through Alt-F6 and by cat'ing a 25,000-line text
file to console while a show with subtitles was running.
Both acts would crash softdevice immediately without this
patch.

	Marko
-------------- next part --------------
A non-text attachment was scrubbed...
Name: video-dfb-catch.patch.gz
Type: application/x-gunzip
Size: 6248 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050803/69905c7c/attachment.bin>

From listaccount at e-tobi.net  Wed Aug  3 20:17:50 2005
From: listaccount at e-tobi.net (Tobias Grimm)
Date: Wed, 03 Aug 2005 20:17:50 +0200
Subject: [Softdevice-devel] Work on Debian package still in progress...
In-Reply-To: <42EFCE77.6010706@gmx.net>
References: <42ED14FF.1040806@e-tobi.net> <200507312129.51538.stefan@lucke.in-berlin.de> <42ED4693.6070702@e-tobi.net> <42ED4B6F.3000209@gmx.net> <42ED5CC2.8000505@e-tobi.net> <42EFCE77.6010706@gmx.net>
Message-ID: <42F10A4E.5000608@e-tobi.net>

Martin Wache schrieb:

>>I searched this list, but couldn't find a another fb driver for the VIA
>>chipset. Does anyone know which alternative driver this may be?
>>
>>    
>>
>Hmm, maybe I remember the discussion from somewhere else, or I'm
>completly mistaken :-/
>  
>

After digging around some more, I found a kernel patch from patcher2k:

http://patcher2k.012webpages.com/

But it doesn't realy work. At least not with the KM800M. I'll get the
VIA driver another try,
if I can get it to compile with a kernel 2.4.31.

Meanwhile I did a test with a ATI Radeon 9600 and I could finally get it
to work with directfb and
softdevice - Hurray! :-) Only when switching to a HDTV channel, it fires
some errors and kills the system. HDTV with normal FB output worked (but
was far too slow).

I also solved the problem with the "undefined symbol: direct_free". The
directfb tarball wasn't "distcleaned", which broke the Debian package,
which expected a clean tarball.

bye,

Tobias


From M.Wache at gmx.net  Thu Aug  4 10:52:55 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 04 Aug 2005 10:52:55 +0200
Subject: [Softdevice-devel] Problem compiling softdevice v0.1.2 and also
 CVS
In-Reply-To: <42EA04C8.7030000@iki.fi>
References: <42E2D58C.70008@brainhawk.de> <20050727104411.7d914d81.ospite@studenti.unina.it> <1122462987.42e76d0b3b102@webmail.in-berlin.de> <200507272308.43672.stefan@lucke.in-berlin.de> <42E7FC53.5050707@iki.fi> <42EA04C8.7030000@iki.fi>
Message-ID: <42F1D767.5060003@gmx.net>

Seppo Ingalsuo schrieb:
> Seppo Ingalsuo wrote:
> 
>> It seems that softplay requires as well a similar modification.
> 
> 
> Here is a patch for softplay to match with new ffmpeg cvs. I hope I got
> it right. It seems to work with the new ffmpeg version.
> 
> BR,
> Seppo
> 
I finally found some time to work on sofplay and I applied your patch.
Thank you very much for the patch!

Martin


From seppo.ingalsuo at iki.fi  Thu Aug  4 11:41:16 2005
From: seppo.ingalsuo at iki.fi (Seppo Ingalsuo)
Date: Thu, 04 Aug 2005 12:41:16 +0300
Subject: [Softdevice-devel] Automatic softdevice suspension?
Message-ID: <42F1E2BC.9070708@iki.fi>

Hi,

As far as I know suspended mode is only controllable trough setup menu 
and xv keyboard? Setup menu is not very practical and I'm using LIRC 
instead of keyboard so usually I don't bother to suspend the system when 
not watching TV. Also in a multiple card DVB system EIT scan won't stop 
live tv display.

I wonder if would make sense to have a configurable timer to activate 
suspension after e.g. 3 hours of vdr user remote/key inactivity or 
whatever suitable timeout. It would save power and e.g. in my vdr box 
enable entering passive cooled mode with CPU fan switched off when CPU 
load is very low. It could also help in avoiding timer based recording 
failures if softdevice would for some reason crash.

Xv part of softdevice has some interaction with xscreensaver but it is 
not clear to me what it does (I had to add "xset -dpms s off" to my 
.xsession script to disable screen blanking). In a very much X output 
method related idea an active xscreensaver could perhaps trigger 
suspended mode in softdevice. If the VGA/DVI display understands DPMS it 
would bring the benefit of automatic monitor power switching. What do 
you think?

BR,
Seppo



From marko.makela at hut.fi  Thu Aug  4 12:50:55 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 4 Aug 2005 13:50:55 +0300
Subject: [Softdevice-devel] Automatic softdevice suspension?
In-Reply-To: <42F1E2BC.9070708@iki.fi>
References: <42F1E2BC.9070708@iki.fi>
Message-ID: <20050804105055.GC3420@localhost.localdomain>

On Thu, Aug 04, 2005 at 12:41:16PM +0300, Seppo Ingalsuo wrote:
> I wonder if would make sense to have a configurable timer to activate 
> suspension after e.g. 3 hours of vdr user remote/key inactivity or 
> whatever suitable timeout. It would save power and e.g. in my vdr box 
> enable entering passive cooled mode with CPU fan switched off when CPU 
> load is very low. It could also help in avoiding timer based recording 
> failures if softdevice would for some reason crash.

Exactly that is why I patched video-dfb.c to capture an otherwise
unmapped remote control key (see
http://www.funet.fi/~msmakela/electronics/worc5/).  That is of course
an ugly hack.

The right thing to do would be to add a "suspended" flag to VDR's
cDevice class, and perhaps introduce a kSleep key as well, in case
you temporarily need to shut down VDR playback to answer phone or
to free some CPU cycles to transcode recordings or burn CDs or DVDs.

In any case, the kPower key should be modified to suspend playback
if VDR cannot be shut down because it is recording something.

I'm going to make these modifications.  However, our second son was
just born this morning, and it will probably take some time before
I will have time for any hacking.  I'll try if I manage to do something
tonight, as my wife and the little son won't return to home today.

> Xv part of softdevice has some interaction with xscreensaver but it is 
> not clear to me what it does (I had to add "xset -dpms s off" to my 
> .xsession script to disable screen blanking). In a very much X output 
> method related idea an active xscreensaver could perhaps trigger 
> suspended mode in softdevice. If the VGA/DVI display understands DPMS it 
> would bring the benefit of automatic monitor power switching. What do 
> you think?

I think it was supposed to work already.  Shortly after some work was
done on the DPMS stuff in video-xv.c, I used the Suspend and Resume
hooks (in mpeg2decoder.c I think) to flip the RS-232 TxD line that
controls the power supply of my ancient VGA monitor.  (See
http://www.funet.fi/~msmakela/electronics/relay/).

	Marko


From seppo.ingalsuo at iki.fi  Fri Aug  5 18:10:56 2005
From: seppo.ingalsuo at iki.fi (Seppo Ingalsuo)
Date: Fri, 05 Aug 2005 19:10:56 +0300
Subject: [Softdevice-devel] Automatic softdevice suspension?
In-Reply-To: <20050804105055.GC3420@localhost.localdomain>
References: <42F1E2BC.9070708@iki.fi> <20050804105055.GC3420@localhost.localdomain>
Message-ID: <42F38F90.5020409@iki.fi>

Marko M?kel? wrote:

>The right thing to do would be to add a "suspended" flag to VDR's
>cDevice class, and perhaps introduce a kSleep key as well, in case
>you temporarily need to shut down VDR playback to answer phone or
>to free some CPU cycles to transcode recordings or burn CDs or DVDs.
>
>In any case, the kPower key should be modified to suspend playback
>if VDR cannot be shut down because it is recording something.
>
>I'm going to make these modifications.  
>
That would be very nice :^) I'm too confused with overall vdr 
architecture to achieve from scratch anything usable.

>However, our second son was
>just born this morning, and it will probably take some time before
>I will have time for any hacking.  
>  
>
Congratulations!

>>Xv part of softdevice has some interaction with xscreensaver but it is 
>>not clear to me what it does (I had to add "xset -dpms s off" to my 
>>.xsession script to disable screen blanking). In a very much X output 
>>method related idea an active xscreensaver could perhaps trigger 
>>suspended mode in softdevice. If the VGA/DVI display understands DPMS it 
>>would bring the benefit of automatic monitor power switching. What do 
>>you think?
>>    
>>
>
>I think it was supposed to work already.  Shortly after some work was
>done on the DPMS stuff in video-xv.c, 
>
It was probably a false alert. I'm now running xscreensaver in the 
background and it seems to work now without the xset commands I 
mentioned earlier. Perhaps that was needed to avoid the default built-in 
X11 screensaver to blank the screen in the middle of tv watching.

Seppo



From marko.makela at hut.fi  Sat Aug  6 09:19:50 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sat, 6 Aug 2005 10:19:50 +0300
Subject: [Softdevice-devel] Automatic softdevice suspension?
In-Reply-To: <42F38F90.5020409@iki.fi>
References: <42F1E2BC.9070708@iki.fi> <20050804105055.GC3420@localhost.localdomain> <42F38F90.5020409@iki.fi>
Message-ID: <20050806071949.GA3461@localhost.localdomain>

On Fri, Aug 05, 2005 at 07:10:56PM +0300, Seppo Ingalsuo wrote:
> >However, our second son was
> >just born this morning, and it will probably take some time before
> >I will have time for any hacking.  
> > 
> >
> Congratulations!

Thanks! My wife and baby got back from clinic yesterday, and I've been
busy with other things.  I wasted that evening of the birth by trying
to migrate my VDR setup to an Asus P2-99 mainboard in the hope of being
able to use LinuxBIOS to shorten the total startup time from 40 seconds.
Somehow, that system very often hanged after pushing the reset button
or at power-on.  I think I'll live with that 40-second startup time
for now.

	Marko


From listaccount at e-tobi.net  Sun Aug  7 13:06:48 2005
From: listaccount at e-tobi.net (Tobias Grimm)
Date: Sun, 07 Aug 2005 13:06:48 +0200
Subject: [Softdevice-devel] Initial version of Debian packag vdr-plugin-softdevice released
Message-ID: <42F5EB48.8060203@e-tobi.net>

Hi!

After testing for a while with more or less success, I thought it is
time to release the package. It is available here:


deb http://www.e-tobi.net/vdr/sarge/experimental/binary vdr/standard/
deb http://www.e-tobi.net/vdr/sarge/experimental/binary backports/

deb-src http://www.e-tobi.net/vdr/sarge/experimental/source vdr/
deb-src http://www.e-tobi.net/vdr/sarge/experimental/source backports/


Please note, that alle necessary backports for sarge are included in my
backports repository. But you will need this repository for Sid too,
because dfb++ hasn't been uploaded to Sid yet. You will also need the
libdirectfb from my repository, because the latest Debian version
0.9.22-5 contains a bug.

The binary package in vdr/standard/ does only work with the vdr package
in there. You have to recompile vdr-plugin-softdevice, if you are using
different patches.

bye,

Tobias


From claas+maillinglists.softdevice at jucs-kramkiste.de  Mon Aug  8 11:20:51 2005
From: claas+maillinglists.softdevice at jucs-kramkiste.de (Claas Hilbrecht)
Date: Mon, 08 Aug 2005 11:20:51 +0200
Subject: [Softdevice-devel] xrun problems
Message-ID: <01DD10EE5785AB9A4335C4CC@[192.168.1.22]>

Sometimes I have xrun messages in my syslog. Every few minutes there are 
one or several xrun syslog entries. I know that xrun problems are generally 
related to high latency. I'm running 2.6.12.1 with

CONFIG_PREEMPT=y
CONFIG_PREEMPT_BKL=y

and I can't image that a Pentium 2.4 GHz system that is idle is not able to 
run vdr with only audio without xruns. I know that latency and 
CONFIG_PREEMPT=y are not the same. Are there any other hints where to start 
looking? Or should I try a low latency patch before? If yes, which low 
latency patch is recommeneded?

I'm running VDR 1.3.27 with a softdevice CVS version from 22.07.2005. These 
are the startup messages:

Aug  8 11:07:39 funfix vdr[7101]: [softdevice-audio] samplerate: 48000Hz, 
channels: #2
Aug  8 11:07:39 funfix vdr[7101]: [softdevice-audio] Period size 1152 
Buffer size 9216
Aug  8 11:07:39 funfix vdr[7101]: [softdevice-audio] Hardware initialized

-- 
 Claas Hilbrecht
 http://www.jucs-kramkiste.de



From M.Wache at gmx.net  Mon Aug  8 11:59:43 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 08 Aug 2005 11:59:43 +0200
Subject: [Softdevice-devel] xrun problems
In-Reply-To: <01DD10EE5785AB9A4335C4CC@[192.168.1.22]>
References: <01DD10EE5785AB9A4335C4CC@[192.168.1.22]>
Message-ID: <42F72D0F.8040302@gmx.net>

Claas Hilbrecht schrieb:
> Sometimes I have xrun messages in my syslog. Every few minutes there are
> one or several xrun syslog entries. I know that xrun problems are
> generally related to high latency. I'm running 2.6.12.1 with
> 
> CONFIG_PREEMPT=y
> CONFIG_PREEMPT_BKL=y
> 
> and I can't image that a Pentium 2.4 GHz system that is idle is not able
> to run vdr with only audio without xruns.
Currently, if you use "-vo dummy:" video is still decoded, but not
displayed! To not decode the video there are still some changes in
mpeg2decoder necessary...

> I know that latency and
> CONFIG_PREEMPT=y are not the same. Are there any other hints where to
> start looking? Or should I try a low latency patch before? If yes, which
> low latency patch is recommeneded?
> 

Are these audio Xruns audible? Do you hear some clicks or does the audio
stop sometimes for a short period, or do you just see the messages in
the syslog?
The reason I'm asking is that the softdevice doesn't stop the audio
properly on channel change, so you'll get an audio Xrun message every
time you change the channel. Up to now I've been to lazy to implement
this correctly ( and I don't think it would make a difference expect
that the Xrun messages would disapear...)

If you really hear these Xruns then you should try the different  buffer
settings from the OSD menu, the HDTV setting is the savest against
buffer underruns, but the seeking in video will behave completly crazy.
The "good seeking" setting should be avoided if you have problems with
buffer underruns.

I don't think that low latency patches are necessary on a system with
low load, but they may improve the situation...

Martin


From M.Wache at gmx.net  Mon Aug  8 12:19:16 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 08 Aug 2005 12:19:16 +0200
Subject: [Softdevice-devel] [PATCH] Added catch statements to video-dfb.c
In-Reply-To: <20050803173814.GA477552@kosh.hut.fi>
References: <42ED14FF.1040806@e-tobi.net> <20050731192407.GA433171@kosh.hut.fi> <20050803120756.GB5127@localhost.localdomain> <20050803173814.GA477552@kosh.hut.fi>
Message-ID: <42F731A4.6060602@gmx.net>

Marko M?kel? schrieb:

> 
> Please apply this patch, as it greatly increases the stability
> of softdevice and makes it possible to use text console
> on top of the vdr screen (which is very useful if you want
> to check something quickly on the box while watching TV).
> 

I hoped that Stefan would answer you or apply the patch, I guess he is
busy or on holidays or ...

I think the patch should be applied, but since I never use DirectFB I
would prefer if Stefan has a look at it and applies it.
So I hope you don't mind if we wait for Stefan...

Martin


From claas+maillinglists.softdevice at jucs-kramkiste.de  Mon Aug  8 12:20:24 2005
From: claas+maillinglists.softdevice at jucs-kramkiste.de (Claas Hilbrecht)
Date: Mon, 08 Aug 2005 12:20:24 +0200
Subject: [Softdevice-devel] xrun problems
In-Reply-To: <42F72D0F.8040302@gmx.net>
References: <01DD10EE5785AB9A4335C4CC@[192.168.1.22]>
 <42F72D0F.8040302@gmx.net>
Message-ID: <60F73C3E8E511499363F28E7@[192.168.1.22]>

--Am Montag, 8. August 2005 11:59 +0200 Martin Wache <M.Wache at gmx.net> 
schrieb:

> Currently, if you use "-vo dummy:" video is still decoded, but not
> displayed! To not decode the video there are still some changes in
> mpeg2decoder necessary...

My fault. I thought that using the dummy output disables video handling. 
But maybe this is really something that could be improved.

> Are these audio Xruns audible? Do you hear some clicks or does the audio
> stop sometimes for a short period, or do you just see the messages in
> the syslog?

Yes, you will hear "nothing", that means from a few tens of seconds silence 
up to approx. two seconds silence.

> The reason I'm asking is that the softdevice doesn't stop the audio
> properly on channel change, so you'll get an audio Xrun message every
> time you change the channel. Up to now I've been to lazy to implement
> this correctly ( and I don't think it would make a difference expect
> that the Xrun messages would disapear...)

The system has 3 low bugdet DVB-S cards that are not used while listing to 
radio. At daytime the system is used to distrubute a radio signal to 
several clients. So I don't think a channel change is the problem.

> If you really hear these Xruns then you should try the different  buffer
> settings from the OSD menu, the HDTV setting is the savest against
> buffer underruns, but the seeking in video will behave completly crazy.
> The "good seeking" setting should be avoided if you have problems with
> buffer underruns.

I never used the box to watch anything. It is only used as a vdr server. 
But I'm not sure how to use the OSD since there is no full featured card in 
the system and so far I didn't configure the softdevice plugin for diplay 
so far. I which the "make DEBUG_OSD=1" switch will work again :)

> I don't think that low latency patches are necessary on a system with
> low load, but they may improve the situation...

dito. I will try to increase buffer sizes first.

-- 
 Claas Hilbrecht
 http://www.jucs-kramkiste.de



From stefan at lucke.in-berlin.de  Mon Aug  8 13:04:23 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon,  8 Aug 2005 13:04:23 +0200
Subject: [Softdevice-devel] [PATCH] Added catch statements to video-dfb.c
In-Reply-To: <42F731A4.6060602@gmx.net>
References: <42ED14FF.1040806@e-tobi.net> <20050731192407.GA433171@kosh.hut.fi> <20050803120756.GB5127@localhost.localdomain> <20050803173814.GA477552@kosh.hut.fi> <42F731A4.6060602@gmx.net>
Message-ID: <1123499063.42f73c3761fbe@webmail.in-berlin.de>

Quoting Martin Wache <M.Wache at gmx.net>:

> Marko M?kel? schrieb:
>
> >
> > Please apply this patch, as it greatly increases the stability
> > of softdevice and makes it possible to use text console
> > on top of the vdr screen (which is very useful if you want
> > to check something quickly on the box while watching TV).
> >
>
> I hoped that Stefan would answer you or apply the patch, I guess he is
> busy or on holidays or ...
>
> I think the patch should be applied, but since I never use DirectFB I
> would prefer if Stefan has a look at it and applies it.
> So I hope you don't mind if we wait for Stefan...


Was busy. There is one minor change and of some others I've to think
on, since try{} covers some more code as just dfb operations. Have to
check if all necessary other statements are processed.
Hopefully it is done this evening.

Stefan Lucke


From M.Wache at gmx.net  Mon Aug  8 17:03:01 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 08 Aug 2005 17:03:01 +0200
Subject: [Softdevice-devel] xrun problems
In-Reply-To: <60F73C3E8E511499363F28E7@[192.168.1.22]>
References: <01DD10EE5785AB9A4335C4CC@[192.168.1.22]> <42F72D0F.8040302@gmx.net> <60F73C3E8E511499363F28E7@[192.168.1.22]>
Message-ID: <42F77425.8050700@gmx.net>

Claas Hilbrecht schrieb:

> Yes, you will hear "nothing", that means from a few tens of seconds
> silence up to approx. two seconds silence.
> 
Hmm, two seconds silence is really a long time...
You can try to switch on the BUFDEB (by uncommenting the define in
mpeg2decoder.c), recompile and pipe the output into a file. In the
output you will find lines saying "aout buffer fill" followed by the
fill percentage of the undecoded audio buffer. Is this buffer filled
when Xruns happen?

Martin


From marko.makela at hut.fi  Tue Aug  9 18:24:56 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 9 Aug 2005 19:24:56 +0300
Subject: [Softdevice-devel] [PATCH] Added catch statements to video-dfb.c
In-Reply-To: <1123499063.42f73c3761fbe@webmail.in-berlin.de>
References: <42ED14FF.1040806@e-tobi.net> <20050731192407.GA433171@kosh.hut.fi> <20050803120756.GB5127@localhost.localdomain> <20050803173814.GA477552@kosh.hut.fi> <42F731A4.6060602@gmx.net> <1123499063.42f73c3761fbe@webmail.in-berlin.de>
Message-ID: <20050809162456.GB3272@localhost.localdomain>

On Mon, Aug 08, 2005 at 01:04:23PM +0200, Stefan Lucke wrote:
> Was busy. There is one minor change and of some others I've to think
> on, since try{} covers some more code as just dfb operations. Have to
> check if all necessary other statements are processed.
> Hopefully it is done this evening.

I noticed only one essential omission of my patch (see attachment
for the relevant snip from diff -wu): In cDFBVideoOut::Refresh()
for VDRVERSNUM < 10307, the DirectFB++ exceptions will not be caught.
Is that on purpose?  It could also be that I made the modification
after preparing the patch.

	Marko
-------------- next part --------------
@@ -1004,0 +1004,0 @@

   tmpSurface = (useStretchBlit) ? osdSurface : scrSurface;

+  try
+  {
   tmpSurface->Clear(0,0,0,clearAlpha);
   tmpSurface->Lock(DSLF_WRITE, (void **)&dst, &pitch) ;
   for (int i = 0; i < MAXNUMWINDOWS; i++)
@@ -1018,0 +1020,0 @@

   tmpSurface->Flip();
 }
+  catch (DFBException *ex)
+  {
+    fprintf (stderr,"[dfb] Refresh: action=%s, result=%s\n",
+             ex->GetAction(), ex->GetResult());
+    delete ex;
+  }
+}
 #endif

 /* ---------------------------------------------------------------------------

From stefan at lucke.in-berlin.de  Wed Aug 10 14:59:46 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 10 Aug 2005 14:59:46 +0200
Subject: [Softdevice-devel] [PATCH] Added catch statements to video-dfb.c
In-Reply-To: <20050809162456.GB3272@localhost.localdomain>
References: <42ED14FF.1040806@e-tobi.net> <20050731192407.GA433171@kosh.hut.fi> <20050803120756.GB5127@localhost.localdomain> <20050803173814.GA477552@kosh.hut.fi> <42F731A4.6060602@gmx.net> <1123499063.42f73c3761fbe@webmail.in-berlin.de> <20050809162456.GB3272@localhost.localdomain>
Message-ID: <1123678786.42f9fa4211a2f@webmail.in-berlin.de>

Quoting Marko M?kel?:

> On Mon, Aug 08, 2005 at 01:04:23PM +0200, Stefan Lucke wrote:
> > Was busy. There is one minor change and of some others I've to think
> > on, since try{} covers some more code as just dfb operations. Have to
> > check if all necessary other statements are processed.
> > Hopefully it is done this evening.
>
> I noticed only one essential omission of my patch (see attachment
> for the relevant snip from diff -wu): In cDFBVideoOut::Refresh()
> for VDRVERSNUM < 10307, the DirectFB++ exceptions will not be caught.
> Is that on purpose?

Not intentionally.

> It could also be that I made the modification
> after preparing the patch.

I'll check that later, thanks.

Stefan


From stefan at lucke.in-berlin.de  Wed Aug 10 19:32:06 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 10 Aug 2005 19:32:06 +0200
Subject: [Softdevice-devel] [PATCH] Added catch statements to video-dfb.c
In-Reply-To: <20050809162456.GB3272@localhost.localdomain>
References: <42ED14FF.1040806@e-tobi.net> <1123499063.42f73c3761fbe@webmail.in-berlin.de> <20050809162456.GB3272@localhost.localdomain>
Message-ID: <200508101932.06521.stefan@lucke.in-berlin.de>

On Dienstag, 9. August 2005 18:24, Marko M?kel? wrote:
> On Mon, Aug 08, 2005 at 01:04:23PM +0200, Stefan Lucke wrote:
> > Was busy. There is one minor change and of some others I've to think
> > on, since try{} covers some more code as just dfb operations. Have to
> > check if all necessary other statements are processed.
> > Hopefully it is done this evening.
> 
> I noticed only one essential omission of my patch (see attachment
> for the relevant snip from diff -wu): In cDFBVideoOut::Refresh()
> for VDRVERSNUM < 10307, the DirectFB++ exceptions will not be caught.
> Is that on purpose?  It could also be that I made the modification
> after preparing the patch.

commited.

-- 
Stefan Lucke



From marko.makela at hut.fi  Thu Aug 11 19:20:32 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 11 Aug 2005 20:20:32 +0300
Subject: [Softdevice-devel] [PATCH] Added catch statements to video-dfb.c
In-Reply-To: <200508101932.06521.stefan@lucke.in-berlin.de>
References: <42ED14FF.1040806@e-tobi.net> <1123499063.42f73c3761fbe@webmail.in-berlin.de> <20050809162456.GB3272@localhost.localdomain> <200508101932.06521.stefan@lucke.in-berlin.de>
Message-ID: <20050811172032.GA443738@kosh.hut.fi>

On Wed, Aug 10, 2005 at 07:32:06PM +0200, Stefan Lucke wrote:
> > I noticed only one essential omission of my patch (see attachment
> > for the relevant snip from diff -wu): In cDFBVideoOut::Refresh()
> > for VDRVERSNUM < 10307, the DirectFB++ exceptions will not be caught.
> > Is that on purpose?  It could also be that I made the modification
> > after preparing the patch.
> 
> commited.

Thanks!

	Marko


From marko.makela at hut.fi  Thu Aug 11 19:49:12 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 11 Aug 2005 20:49:12 +0300
Subject: [Softdevice-devel] Minor AV sync problems
In-Reply-To: <42ED2D1B.4060008@gmx.net>
References: <20050724205410.GA7329@localhost.localdomain> <20050726092949.GD397816@kosh.hut.fi> <42EC93CD.4000109@gmx.net> <20050731121725.GB3337@localhost.localdomain> <Pine.LNX.4.61.0507311431400.7531@pub6.ifh.de> <42ED2D1B.4060008@gmx.net>
Message-ID: <20050811174912.GB443738@kosh.hut.fi>

On Sun, Jul 31, 2005 at 09:57:15PM +0200, Martin Wache wrote:
> The change of the access of the audio delay was on the 29. May 05, you
> can get the diff from cvs web access, the relevant files are
> mpegdecoder.c and .h. There are some more changes in this commit, look
> only for those which concern cClock and the PTS handling.

I see that there are very many committed changes since that May 29 commit,
and I'd expect to have a few merge conflicts when trying to revert those
changes only.  I'll give it a short try.  I'm not too knowledgeable in
the internals of MPEG decoding, so don't count on me.

So far, this bug was confirmed by another DirectFB and Matrox G[45][50]0
user.  What about DirectFB users having other than Matrox cards?

	Marko


From marko.makela at hut.fi  Thu Aug 11 20:38:06 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 11 Aug 2005 21:38:06 +0300
Subject: [Softdevice-devel] Minor AV sync problems
In-Reply-To: <20050811174912.GB443738@kosh.hut.fi>
References: <20050724205410.GA7329@localhost.localdomain> <20050726092949.GD397816@kosh.hut.fi> <42EC93CD.4000109@gmx.net> <20050731121725.GB3337@localhost.localdomain> <Pine.LNX.4.61.0507311431400.7531@pub6.ifh.de> <42ED2D1B.4060008@gmx.net> <20050811174912.GB443738@kosh.hut.fi>
Message-ID: <20050811183806.GD443738@kosh.hut.fi>

On Thu, Aug 11, 2005 at 08:49:12PM +0300, Marko M?kel? wrote:
> I see that there are very many committed changes since that May 29 commit,
> and I'd expect to have a few merge conflicts when trying to revert those
> changes only.  I'll give it a short try.  I'm not too knowledgeable in
> the internals of MPEG decoding, so don't count on me.

I gave up, it'd take too much time with the archaic development
environment (vi, patch, diff, no X11) that is installed on my
VDR box.  Even if I had GNU Emacs installed, I couldn't really
tell which lines in the diff between mpeg2decoder.c -r1.37 and
-r1.38 are relevant.

> So far, this bug was confirmed by another DirectFB and Matrox G[45][50]0
> user.  What about DirectFB users having other than Matrox cards?

Furthermore, could it be that Xv output is not double or triple buffered?
I saw a comment that said that the A-V delay is best computed after
displaying the frame.  Does that refer to the cathode ray actually
drawing the last visible line on the screen, or to blitting the bitmap
to the screen memory?  If the latter and if Xv doesn't have any double
buffering or synchronization to the output video signal, this could
well be the reason why A-V sync has gone bad on DirectFB.  (I have the
impression that DirectFB does double or triple buffering.)

One more thing: would it be helpful to enable MPGDEB in mpeg2decoder.c
and send you the output?  Is it normal to have audio pts offset floating
around 0x80000000?  Examples: -2454882835, -2454882862, -2454882889.

	Marko


From stefan at lucke.in-berlin.de  Sun Aug 14 14:30:29 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 14 Aug 2005 14:30:29 +0200
Subject: [Softdevice-devel] DFB with Matrox G450 cable?
In-Reply-To: <20050814090720.GA8207@seneca.muc.de>
References: <20050814090720.GA8207@seneca.muc.de>
Message-ID: <200508141430.29141.stefan@lucke.in-berlin.de>

On Sonntag, 14. August 2005 11:07, Harald Milz wrote:
> Hi,
> 
> I'm new to this list so please bear with me ;-) 
> 
> I would like to try using softdevice with DirectFB and my Matrox G450DH.
> The directfb and fb.modes hints on the softdevice web page are
> straightforward enough. The question is, which cable does the directfb
> setting correspond to? Is it the one at
> http://forum.matrox.com/mga/viewtopic.php?t=4385 ? For now, ffmpeg keeps me
> busy :-( 

That one looks like the default s-video/composite adapter which is shipped with
matrox cards and I use that one with a composite connection on my
development box. You should specify "matrox-cable-type=composite" .

> 
> 
> As for AC3 out, my board is an Asus A7V8X with a VT8235 and ALC650 codec.
> Does anybody have the proper settings for AC3 and PCM passthrough via
> SPDIF? 

Grr, direct AC3 passthrough by softdevice means, is still on the TODO list.
Some weks ago, there was a success report on this list by using bitstreamout.
http://lists.berlios.de/pipermail/softdevice-devel/2005q3/000949.html

> 
> I may use a G55+ adapter in the future which has a DVI and VGA out. The
> question concerning HDTV is, is it correct that the DVI supports only up to
> 1280x1024 as written on the Matrox web page? Or is that a Windows driver
> limitation? Does anybody have DirectFB settings for this card and DVI? I'd
> rather use DVI than VGA for HDTV ... :-) 

For DVI with larger resolutions than 1280x1024 DirectFB list should be asked.

From stefan at lucke.in-berlin.de  Sun Aug 14 14:43:26 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 14 Aug 2005 14:43:26 +0200
Subject: [Softdevice-devel] DFB with Matrox G450 cable?
In-Reply-To: <20050814090720.GA8207@seneca.muc.de>
References: <20050814090720.GA8207@seneca.muc.de>
Message-ID: <200508141443.26952.stefan@lucke.in-berlin.de>

On Sonntag, 14. August 2005 11:07, Harald Milz wrote:

> 
> I may use a G55+ adapter in the future which has a DVI and VGA out. The
> question concerning HDTV is, is it correct that the DVI supports only up to
> 1280x1024 as written on the Matrox web page? Or is that a Windows driver
> limitation? Does anybody have DirectFB settings for this card and DVI? I'd
> rather use DVI than VGA for HDTV ... :-) 

When talking about DVI connections, I think using a matrox card which
has good analog out capabilities, has no advantage in comparison
to other DVI cards with more memory onboard.

-- 
Stefan Lucke



From claas+maillinglists.softdevice at jucs-kramkiste.de  Sun Aug 14 18:02:52 2005
From: claas+maillinglists.softdevice at jucs-kramkiste.de (Claas Hilbrecht)
Date: Sun, 14 Aug 2005 18:02:52 +0200
Subject: [Softdevice-devel] xrun problems
In-Reply-To: <42F77425.8050700@gmx.net>
References: <01DD10EE5785AB9A4335C4CC@[192.168.1.22]>
 <42F72D0F.8040302@gmx.net> <60F73C3E8E511499363F28E7@[192.168.1.22]>
 <42F77425.8050700@gmx.net>
Message-ID: <9117607D75DD1BB013E81E19@[192.168.1.22]>

--Am Montag, 8. August 2005 17:03 +0200 Martin Wache <M.Wache at gmx.net> 
schrieb:

> You can try to switch on the BUFDEB (by uncommenting the define in
[...]
> when Xruns happen?

Sorry, I was busy the last days. Here's the log. But I didn't see the 
message you mentioned.


mpegdec[3281]:Frame# 132459  aPTS: 515560352 offset: 59 delay 35239
mpegdec[3315]:audio: count: 220784  Length: 2034 len: 576 a_size: 4608 
a_delay: 1119
mpegdec[3315]:audio pts 515562511 pkt->PTS : 515562511 pts - valid PTS: 0
mpegdec[3315]:audio pts offset -93341632
mpegdec[3315]:audio: count: 220785  Length: 2034 len: 576 a_size: 4608 
a_delay: 1352
mpegdec[3315]:audio pts offset -93341632
mpegdec[3316]:audio: count: 220786  Length: 2034 len: 576 a_size: 4608 
a_delay: 1585
mpegdec[3316]:audio pts offset -93341632
mpegdec[3316]:audio: count: 220787  Length: 2034 len: 306 a_size: 0 
a_delay: 1824
mpegdec[3316]:a_delay 1824 at end of decode
mpegdec[3316]:Frame# 132459 A-V(ms) 73    delay 35247 FrameT: I_t, 
dispTime(ms): 0,01
mpegdec[3321]:Got pts: pictno 132461  pts: 515561093 lastIdx 2
mpegdec[3321]:video pts: 515561093, values.pkt : 515561093 pts - valid PTS: 
0 pictno: 132461 idx: 1
mpegdec[3321]:Frame# 132460  aPTS: 515561166 offset: 473 delay 30381
mpegdec[3353]:Frame# 132460 A-V(ms) -327  delay 37776 FrameT: B_t, 
dispTime(ms): 0,00
mpegdec[3358]:Got pts: pictno 132462  pts: 515561493 lastIdx 3
mpegdec[3358]:video pts: 515561493, values.pkt : 515561493 pts - valid PTS: 
0 pictno: 132462 idx: 2
mpegdec[3358]:Frame# 132461  aPTS: 515561166 offset: 73 delay 32975
mpegdec[3389]:Frame# 132461 A-V(ms) -727  delay 44974 FrameT: B_t, 
dispTime(ms): 0,00
mpegdec[3397]:Got pts: pictno 132463  pts: 515563093 lastIdx 4
mpegdec[3397]:video pts: 515561893, values.pkt : 515561893 pts - valid PTS: 
0 pictno: 132460 idx: 0
mpegdec[3397]:Frame# 132462  aPTS: 515561166 offset: -327 delay 37055
mpegdec[3420]:audio: count: 220787  Length: 1422 len: 270 a_size: 4608 
a_delay: 789
mpegdec[3420]:audio pts offset -93341632
mpegdec[3420]:audio: count: 220788  Length: 1422 len: 576 a_size: 4608 
a_delay: 1022
mpegdec[3420]:audio pts offset -93341632
mpegdec[3421]:audio: count: 220789  Length: 1422 len: 576 a_size: 4608 
a_delay: 1255
mpegdec[3421]:audio pts offset -93341632
mpegdec[3421]:a_delay 1495 at end of decode
mpegdec[3433]:Frame# 132462 A-V(ms) -77   delay 37796 FrameT: P_t, 
dispTime(ms): 0,00
mpegdec[3440]:Got pts: pictno 132464  pts: 515562293 lastIdx 5
mpegdec[3440]:video pts: 515562293, values.pkt : 515562293 pts - valid PTS: 
0 pictno: 132464 idx: 4
mpegdec[3440]:Frame# 132463  aPTS: 515562216 offset: 323 delay 30917
mpegdec[3471]:Frame# 132463 A-V(ms) -477  delay 40505 FrameT: B_t, 
dispTime(ms): 0,00
mpegdec[3477]:Got pts: pictno 132465  pts: 515562693 lastIdx 6
mpegdec[3477]:video pts: 515562693, values.pkt : 515562693 pts - valid PTS: 
0 pictno: 132465 idx: 5
mpegdec[3477]:Frame# 132464  aPTS: 515562216 offset: -77 delay 34568
mpegdec[3513]:Frame# 132464 A-V(ms) -877  delay 43432 FrameT: B_t, 
dispTime(ms): 0,01
mpegdec[3519]:Got pts: pictno 132466  pts: 515564293 lastIdx 7
mpegdec[3519]:video pts: 515563093, values.pkt : 515563093 pts - valid PTS: 
0 pictno: 132463 idx: 3
mpegdec[3519]:Frame# 132465  aPTS: 515562216 offset: -477 delay 37366
mpegdec[3558]:Frame# 132465 A-V(ms) -1277 delay 46229 FrameT: I_t, 
dispTime(ms): 0,01
mpegdec[3563]:Got pts: pictno 132467  pts: 515563493 lastIdx 8
mpegdec[3563]:video pts: 515563493, values.pkt : 515563493 pts - valid PTS: 
0 pictno: 132467 idx: 7
mpegdec[3563]:Frame# 132466  aPTS: 515562216 offset: -877 delay 40823
mpegdec[3575]:audio: count: 220790  Length: 2034 len: 576 a_size: 4608 
a_delay: 0
audio: xrun
mpegdec[3575]:audio pts 515563951 pkt->PTS : 515563951 pts - valid PTS: 0
mpegdec[3575]:audio pts offset -93341592
mpegdec[3576]:audio: count: 220791  Length: 2034 len: 576 a_size: 4608 
a_delay: 231
mpegdec[3576]:audio pts offset -93341592
mpegdec[3576]:audio: count: 220792  Length: 2034 len: 576 a_size: 4608 
a_delay: 464
mpegdec[3576]:audio pts offset -93341591
mpegdec[3576]:audio: count: 220793  Length: 2034 len: 306 a_size: 0 
a_delay: 703



-- 
 Claas Hilbrecht
 http://www.jucs-kramkiste.de



From marko.makela at hut.fi  Sun Aug 14 19:37:38 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sun, 14 Aug 2005 20:37:38 +0300
Subject: [Softdevice-devel] Playback suspended at end of recording
Message-ID: <20050814173738.GA3657@localhost.localdomain>

I think I've reported this earlier, but now I got a little more
information.

At the end of a recording, the screen sometimes remains black, and no
MPEG decoding seems to take place from the currently selected channel.
Flipping the IsSuspended flag doesn't have any effect.  Output will
be restored after switching channels.

This bug does not occur every week for me.  The probability of it
occurring at the end of a recording can be at most a few percent.
This time, I'm rather sure that it is a softdevice bug, because
subtitles were displayed although the display was otherwise black.
I was viewing YLE TV1, and I'm using vdr 1.3.27, softdevice-cvs
and subtitles-0.3.8.

Another rare bug I mentioned earlier happened again some time ago.  At
startup, vdr used only a few percent of CPU time (normal is 30-40 %)
and showed a very small frame rate (at most one or two frames per
second).  I have the feeling that it is some race condition that could
be solved by additional locking.  I believe that this bug could probably
be made repeatable by adding some delay to the startup of one of the
threads.  I would try this myself if I were familiar with the thread
structure of vdr.

	Marko


From M.Wache at gmx.net  Sun Aug 14 20:38:35 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 14 Aug 2005 20:38:35 +0200
Subject: [Softdevice-devel] xrun problems
In-Reply-To: <9117607D75DD1BB013E81E19@[192.168.1.22]>
References: <01DD10EE5785AB9A4335C4CC@[192.168.1.22]> <42F72D0F.8040302@gmx.net> <60F73C3E8E511499363F28E7@[192.168.1.22]> <42F77425.8050700@gmx.net> <9117607D75DD1BB013E81E19@[192.168.1.22]>
Message-ID: <42FF8FAB.8060903@gmx.net>

Claas Hilbrecht schrieb:
> --Am Montag, 8. August 2005 17:03 +0200 Martin Wache <M.Wache at gmx.net>
> schrieb:
> 
>> You can try to switch on the BUFDEB (by uncommenting the define in
> 
> [...]
> 
>> when Xruns happen?
> 
> 
> Sorry, I was busy the last days. Here's the log. But I didn't see the
> message you mentioned.
> 
> 

> mpegdec[3563]:Got pts: pictno 132467  pts: 515563493 lastIdx 8
> mpegdec[3563]:video pts: 515563493, values.pkt : 515563493 pts - valid
> PTS: 0 pictno: 132467 idx: 7
> mpegdec[3563]:Frame# 132466  aPTS: 515562216 offset: -877 delay 40823
> mpegdec[3575]:audio: count: 220790  Length: 2034 len: 576 a_size: 4608
> a_delay: 0
> audio: xrun
> mpegdec[3575]:audio pts 515563951 pkt->PTS : 515563951 pts - valid PTS: 0
> mpegdec[3575]:audio pts offset -93341592
> mpegdec[3576]:audio: count: 220791  Length: 2034 len: 576 a_size: 4608
> a_delay: 231
> mpegdec[3576]:audio pts offset -93341592
> mpegdec[3576]:audio: count: 220792  Length: 2034 len: 576 a_size: 4608
> a_delay: 464
> mpegdec[3576]:audio pts offset -93341591
> mpegdec[3576]:audio: count: 220793  Length: 2034 len: 306 a_size: 0
> a_delay: 703
> 
> 

That's the wrong debug output, you've activated MPGDEB, not BUFDEB.
Unfortunatly I can't see much from this log....


Bye,
Martin


From M.Wache at gmx.net  Sun Aug 14 21:09:14 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 14 Aug 2005 21:09:14 +0200
Subject: [Softdevice-devel] Minor AV sync problems
In-Reply-To: <20050811183806.GD443738@kosh.hut.fi>
References: <20050724205410.GA7329@localhost.localdomain> <20050726092949.GD397816@kosh.hut.fi> <42EC93CD.4000109@gmx.net> <20050731121725.GB3337@localhost.localdomain> <Pine.LNX.4.61.0507311431400.7531@pub6.ifh.de> <42ED2D1B.4060008@gmx.net> <20050811174912.GB443738@kosh.hut.fi> <20050811183806.GD443738@kosh.hut.fi>
Message-ID: <42FF96DA.6010407@gmx.net>

Marko M?kel? schrieb:
> On Thu, Aug 11, 2005 at 08:49:12PM +0300, Marko M?kel? wrote:
> 
>>I see that there are very many committed changes since that May 29 commit,
>>and I'd expect to have a few merge conflicts when trying to revert those
>>changes only.  I'll give it a short try.  I'm not too knowledgeable in
>>the internals of MPEG decoding, so don't count on me.
> 
> 
> I gave up, it'd take too much time with the archaic development
> environment (vi, patch, diff, no X11) that is installed on my
> VDR box.  Even if I had GNU Emacs installed, I couldn't really
> tell which lines in the diff between mpeg2decoder.c -r1.37 and
> -r1.38 are relevant.
>
I just had a look at what I did back then. Actually it should not be too
difficult to take the changes back, you just need a pointer to the
AudioDecoder in the VideoDecoder.
Maybe you can just introduce a static variable for the pointer, but make
sure to set it to NULL in the AudioDecoder destructor and check for not
NULL before you dereference it ( the AudioDecoder is deleted everytime
the channel is changed).
If you have the pointer you just need to replace
 uint64_t aPTS = clock->GetPTS();
with the call to cAudioDecoder::GetPTS()

> 
>>So far, this bug was confirmed by another DirectFB and Matrox G[45][50]0
>>user.  What about DirectFB users having other than Matrox cards?
> 
> 
> Furthermore, could it be that Xv output is not double or triple buffered?
> I saw a comment that said that the A-V delay is best computed after
> displaying the frame.  Does that refer to the cathode ray actually
> drawing the last visible line on the screen, or to blitting the bitmap
> to the screen memory?  If the latter and if Xv doesn't have any double
> buffering or synchronization to the output video signal, this could
> well be the reason why A-V sync has gone bad on DirectFB.  (I have the
> impression that DirectFB does double or triple buffering.)
> 
Hmm, I don't know for shure, but I think double or tripple buffering
should not affect the A-V sync.

> One more thing: would it be helpful to enable MPGDEB in mpeg2decoder.c
> and send you the output?  Is it normal to have audio pts offset floating
> around 0x80000000?  Examples: -2454882835, -2454882862, -2454882889.
I guess that's it. For me the offset changes only slowly in time and
only at the last digit. Can you please send me the debug output produced
be the attached patch?

Thanks,
Martin
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: PTSdebug.diff
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050814/9493f1e9/attachment.ksh>

From patrick.boettcher at desy.de  Sun Aug 14 21:27:27 2005
From: patrick.boettcher at desy.de (Patrick Boettcher)
Date: Sun, 14 Aug 2005 21:27:27 +0200 (CEST)
Subject: [Softdevice-devel] Minor AV sync problems
In-Reply-To: <42FF96DA.6010407@gmx.net>
References: <20050724205410.GA7329@localhost.localdomain>
 <20050726092949.GD397816@kosh.hut.fi> <42EC93CD.4000109@gmx.net>
 <20050731121725.GB3337@localhost.localdomain> <Pine.LNX.4.61.0507311431400.7531@pub6.ifh.de>
 <42ED2D1B.4060008@gmx.net> <20050811174912.GB443738@kosh.hut.fi>
 <20050811183806.GD443738@kosh.hut.fi> <42FF96DA.6010407@gmx.net>
Message-ID: <Pine.LNX.4.61.0508142125230.17851@pub4.ifh.de>

Hi Martin,

I think as I have the same problem I can produce the the debug-log as 
well. See the attached bzip2-compressed file. It is done while watching 
Das Erste two minutes ago (DVB-T Berlin).

I hope this helps.

On Sun, 14 Aug 2005, Martin Wache wrote:
>> One more thing: would it be helpful to enable MPGDEB in mpeg2decoder.c
>> and send you the output?  Is it normal to have audio pts offset floating
>> around 0x80000000?  Examples: -2454882835, -2454882862, -2454882889.
> I guess that's it. For me the offset changes only slowly in time and
> only at the last digit. Can you please send me the debug output produced
> be the attached patch?

Thanks in advance,
Patrick.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: PTSdebug.bz2
Type: application/x-bzip2
Size: 5377 bytes
Desc: 
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050814/873596b5/attachment.bin>

From M.Wache at gmx.net  Sun Aug 14 23:09:49 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 14 Aug 2005 23:09:49 +0200
Subject: [Softdevice-devel] Minor AV sync problems
In-Reply-To: <Pine.LNX.4.61.0508142125230.17851@pub4.ifh.de>
References: <20050724205410.GA7329@localhost.localdomain> <20050726092949.GD397816@kosh.hut.fi> <42EC93CD.4000109@gmx.net> <20050731121725.GB3337@localhost.localdomain> <Pine.LNX.4.61.0507311431400.7531@pub6.ifh.de> <42ED2D1B.4060008@gmx.net> <20050811174912.GB443738@kosh.hut.fi> <20050811183806.GD443738@kosh.hut.fi> <42FF96DA.6010407@gmx.net> <Pine.LNX.4.61.0508142125230.17851@pub4.ifh.de>
Message-ID: <42FFB31D.8010805@gmx.net>

Patrick Boettcher schrieb:
> Hi Martin,
> 
> I think as I have the same problem I can produce the the debug-log as
> well. See the attached bzip2-compressed file. It is done while watching
> Das Erste two minutes ago (DVB-T Berlin).
> 
> I hope this helps.
Yes it helps, thank you!

audioPTS[7208]:delay 0 audio pts offset 66453061 pts 478705143
audioPTS[7253]:new chunk 240
audioPTS[7253]:delay 0 audio pts offset 66453271 pts 478705383
audioPTS[7268]:new chunk 240
audioPTS[7268]:delay 0 audio pts offset 66453181 pts 478705623
audioPTS[7297]:new chunk 240
audioPTS[7297]:delay 0 audio pts offset 66453231 pts 478705863
audioPTS[7311]:new chunk 240
audioPTS[7311]:delay 0 audio pts offset 66453127 pts 478706103

The audio delay is always zero, no wonder that there are problems with
the A-V sync. The audio delay is the time the actual playback is behind
the sound buffer top.
We get this value almost directly from the alsa driver, did you change
something in the alsa setup recently? A new kernel, or alsa libraries?
Which driver are you useing?

I wonder how the A-V sync could be okay before without a propoper audio
delay... Maybe my last change just made this problem more important. Did
you try to revert back to softdevice-0.1.2 and check if the A-V sync is
better there?

It would also be nice to know if Marco has really the same problem, or
just the same symptons.

Thank you very much,

Martin


From stefan at lucke.in-berlin.de  Mon Aug 15 07:47:19 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 15 Aug 2005 07:47:19 +0200
Subject: [Softdevice-devel] Minor AV sync problems
In-Reply-To: <42FFB31D.8010805@gmx.net>
References: <20050724205410.GA7329@localhost.localdomain> <Pine.LNX.4.61.0508142125230.17851@pub4.ifh.de> <42FFB31D.8010805@gmx.net>
Message-ID: <200508150747.19841.stefan@lucke.in-berlin.de>

On Sonntag, 14. August 2005 23:09, Martin Wache wrote:
> Patrick Boettcher schrieb:
> > Hi Martin,
> > 
> > I think as I have the same problem I can produce the the debug-log as
> > well. See the attached bzip2-compressed file. It is done while watching
> > Das Erste two minutes ago (DVB-T Berlin).
> > 
> > I hope this helps.
> Yes it helps, thank you!
> 
> audioPTS[7208]:delay 0 audio pts offset 66453061 pts 478705143
> audioPTS[7253]:new chunk 240
> audioPTS[7253]:delay 0 audio pts offset 66453271 pts 478705383
> audioPTS[7268]:new chunk 240
> audioPTS[7268]:delay 0 audio pts offset 66453181 pts 478705623
> audioPTS[7297]:new chunk 240
> audioPTS[7297]:delay 0 audio pts offset 66453231 pts 478705863
> audioPTS[7311]:new chunk 240
> audioPTS[7311]:delay 0 audio pts offset 66453127 pts 478706103
> 
> The audio delay is always zero, no wonder that there are problems with
> the A-V sync. The audio delay is the time the actual playback is behind
> the sound buffer top.
> We get this value almost directly from the alsa driver, did you change
> something in the alsa setup recently? A new kernel, or alsa libraries?

With some combination of alsa output filter chain (dmix plugin - from
our bug tracker #2971) there are audio delays problems.

> Which driver are you useing?

I did a short test with DVB-T berlin with a cinergy-t2 too ARD + ZDF + mbb.
Audio increase after chan switch to 1920.  kernel 2.4.31,
(new chunk removed)

CMD[4362]:new Audio stream index.. old -1 new 1
CMD[4362]:Neuer StreamDecoder Pid: 2596 context 0x859bf58 type 1
CMD[4414]:Neuer Thread gestartet: pid:2598 type 1
audioPTS[4764]:new chunk 240
audioPTS[4764]:delay 238 audio pts offset 912134015 pts 240
audioPTS[4765]:delay 472 audio pts offset 912134015 pts 480
audioPTS[4766]:delay 707 audio pts offset 912134015 pts 720
audioPTS[4766]:delay 942 audio pts offset 912134015 pts 960
audioPTS[4767]:delay 1176 audio pts offset 66458791 pts 845676423
audioPTS[4767]:delay 1411 audio pts offset 66458792 pts 845676663
audioPTS[4768]:delay 1645 audio pts offset 66458791 pts 845676903
audioPTS[4768]:delay 1880 audio pts offset 66458791 pts 845677143
audioPTS[4788]:delay 1919 audio pts offset 66458792 pts 845677383
audioPTS[4812]:delay 1919 audio pts offset 66458793 pts 845677623
audioPTS[4836]:delay 1919 audio pts offset 66458792 pts 845677863
audioPTS[4860]:delay 1919 audio pts offset 66458792 pts 845678103


-- 
Stefan Lucke



From marko.makela at hut.fi  Mon Aug 15 14:40:41 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 15 Aug 2005 15:40:41 +0300
Subject: [Softdevice-devel] Minor AV sync problems
In-Reply-To: <42FFB31D.8010805@gmx.net>
References: <20050726092949.GD397816@kosh.hut.fi> <42EC93CD.4000109@gmx.net> <20050731121725.GB3337@localhost.localdomain> <Pine.LNX.4.61.0507311431400.7531@pub6.ifh.de> <42ED2D1B.4060008@gmx.net> <20050811174912.GB443738@kosh.hut.fi> <20050811183806.GD443738@kosh.hut.fi> <42FF96DA.6010407@gmx.net> <Pine.LNX.4.61.0508142125230.17851@pub4.ifh.de> <42FFB31D.8010805@gmx.net>
Message-ID: <20050815124041.GA3213@localhost.localdomain>

Martin, Patrick,

> audioPTS[7208]:delay 0 audio pts offset 66453061 pts 478705143
> audioPTS[7253]:new chunk 240
> audioPTS[7253]:delay 0 audio pts offset 66453271 pts 478705383
> audioPTS[7268]:new chunk 240
> audioPTS[7268]:delay 0 audio pts offset 66453181 pts 478705623
> audioPTS[7297]:new chunk 240
> audioPTS[7297]:delay 0 audio pts offset 66453231 pts 478705863
> audioPTS[7311]:new chunk 240
> audioPTS[7311]:delay 0 audio pts offset 66453127 pts 478706103
> 
> The audio delay is always zero, no wonder that there are problems with
> the A-V sync. The audio delay is the time the actual playback is behind
> the sound buffer top.
> We get this value almost directly from the alsa driver, did you change
> something in the alsa setup recently? A new kernel, or alsa libraries?
> Which driver are you useing?

I have the same symptoms:

audioPTS[1312]:new chunk 240
audioPTS[1312]:delay 0 audio pts offset 408435107 pts 753064385
audioPTS[1328]:new chunk 240
audioPTS[1328]:delay 0 audio pts offset 408435032 pts 753064625
audioPTS[1353]:new chunk 240
audioPTS[1353]:delay 0 audio pts offset 408435036 pts 753064865
audioPTS[1372]:new chunk 240

It could well be that the problems appeared after I upgraded the kernel
from 2.6.11.6 to 2.6.12.3.  I haven't tried the old kernel.

I use Debian GNU/Linux, DirectFB 0.9.22, ffmpeg CVS from May or June,
alsa-utils 1.0.9a-4, alsa-base 1.0.9b-4 as packaged by Debian.
(Is alsa-utils needed?  Does softdevice program the mixer settings as
required?)

Next, I'll try to downgrade the kernel and softdevice, one at a time.

	Marko


From marko.makela at hut.fi  Mon Aug 15 15:02:33 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 15 Aug 2005 16:02:33 +0300
Subject: [Softdevice-devel] Minor AV sync problems
In-Reply-To: <20050815124041.GA3213@localhost.localdomain>
References: <42EC93CD.4000109@gmx.net> <20050731121725.GB3337@localhost.localdomain> <Pine.LNX.4.61.0507311431400.7531@pub6.ifh.de> <42ED2D1B.4060008@gmx.net> <20050811174912.GB443738@kosh.hut.fi> <20050811183806.GD443738@kosh.hut.fi> <42FF96DA.6010407@gmx.net> <Pine.LNX.4.61.0508142125230.17851@pub4.ifh.de> <42FFB31D.8010805@gmx.net> <20050815124041.GA3213@localhost.localdomain>
Message-ID: <20050815130233.GB3213@localhost.localdomain>

On Mon, Aug 15, 2005 at 03:40:41PM +0300, Marko M?kel? wrote:
> Next, I'll try to downgrade the kernel and softdevice, one at a time.

With kernel 2.6.11.6, I get delay=0 as well, but I feel that the lip
sync is better than with kernel 2.6.12.3.  With softdevice 0.1.2
on kernel 2.6.12.3, the lip sync is better than with softdevice-cvs.
On kernel 2.6.11.6, there is a slightly visible sync problem with
softdevice-cvs, but softdevice-0.1.2 looks perfect.

How can we debug this further?  Should I try a sound card (ES1371)
instead of the onboard via82xx?

	Marko


From M.Wache at gmx.net  Mon Aug 15 16:48:34 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 15 Aug 2005 16:48:34 +0200
Subject: [Softdevice-devel] Minor AV sync problems
In-Reply-To: <20050815130233.GB3213@localhost.localdomain>
References: <42EC93CD.4000109@gmx.net> <20050731121725.GB3337@localhost.localdomain> <Pine.LNX.4.61.0507311431400.7531@pub6.ifh.de> <42ED2D1B.4060008@gmx.net> <20050811174912.GB443738@kosh.hut.fi> <20050811183806.GD443738@kosh.hut.fi> <42FF96DA.6010407@gmx.net> <Pine.LNX.4.61.0508142125230.17851@pub4.ifh.de> <42FFB31D.8010805@gmx.net> <20050815124041.GA3213@localhost.localdomain> <20050815130233.GB3213@localhost.localdomain>
Message-ID: <4300AB42.3010306@gmx.net>

Marko M?kel? schrieb:
> On Mon, Aug 15, 2005 at 03:40:41PM +0300, Marko M?kel? wrote:
> 
>>Next, I'll try to downgrade the kernel and softdevice, one at a time.
> 
> 
> With kernel 2.6.11.6, I get delay=0 as well, but I feel that the lip
> sync is better than with kernel 2.6.12.3.  With softdevice 0.1.2
> on kernel 2.6.12.3, the lip sync is better than with softdevice-cvs.
> On kernel 2.6.11.6, there is a slightly visible sync problem with
> softdevice-cvs, but softdevice-0.1.2 looks perfect.
> 
Hmm so it is not the kernel which did the change but the softdevice
version.
I attached another patch which is for the softdevice cvs but I think it
should apply as well to softdevice-0.1.2, it prints the raw delay like
the softdevice gets it from libasound as well as the delay like it is
used for the A-V synchronisation.
Maybe there is an integer overflow in the calculation of the delay, but
I doubt that, I would not expect to get 0 in that case...
Are you using MPlayer? I'm just a bit curious, maybe you can try to
check if MPlayer is getting the audio delay correctly. To do this you
have to edit libao2/ao_alsa.c in MPlayer's source directory. Search for
get_delay and print out the result of their delay calculation, please
note that they are useing floats for the delay.

> How can we debug this further?  Should I try a sound card (ES1371)
> instead of the onboard via82xx?
Strange, I'm useing also a via82xx, kernel 2.6.12 without any problems.
But I'm useing an older alsa-library: 1.0.3b.

I'm not so shure what to do. If MPlayer has the correct audio delay,
maybe the softdevice queries the audio delay the wrong way. But there is
hardly anything which one could do wrong.
So I suspect the alsa library or the alsa driver is buggy, but I would
like to have that verified with some other program.
You can also try another soundcard, maybe it's the driver after all...

I wonder how many people have this problems, as Stefan already stated if
you build some alsa filter chains the delay is not reported correctly.
Do you use by any chance some alsa filters?

I guess we can try to work around that by just using the system clock to
calculate the audio delay, but then we wouldn't be able to detect drifts
of the sound clock.

Thanks for you reports!
Martin
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: audio_delay_debug.diff
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050815/9816a092/attachment.ksh>

From marko.makela at hut.fi  Mon Aug 15 21:54:21 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 15 Aug 2005 22:54:21 +0300
Subject: [Softdevice-devel] Minor AV sync problems
In-Reply-To: <4300AB42.3010306@gmx.net>
References: <Pine.LNX.4.61.0507311431400.7531@pub6.ifh.de> <42ED2D1B.4060008@gmx.net> <20050811174912.GB443738@kosh.hut.fi> <20050811183806.GD443738@kosh.hut.fi> <42FF96DA.6010407@gmx.net> <Pine.LNX.4.61.0508142125230.17851@pub4.ifh.de> <42FFB31D.8010805@gmx.net> <20050815124041.GA3213@localhost.localdomain> <20050815130233.GB3213@localhost.localdomain> <4300AB42.3010306@gmx.net>
Message-ID: <20050815195421.GC3176@localhost.localdomain>

On Mon, Aug 15, 2005 at 04:48:34PM +0200, Martin Wache wrote:
> > With kernel 2.6.11.6, I get delay=0 as well, but I feel that the lip
> > sync is better than with kernel 2.6.12.3.  With softdevice 0.1.2
> > on kernel 2.6.12.3, the lip sync is better than with softdevice-cvs.
> > On kernel 2.6.11.6, there is a slightly visible sync problem with
> > softdevice-cvs, but softdevice-0.1.2 looks perfect.
> > 
> Hmm so it is not the kernel which did the change but the softdevice
> version.

I would say that it is both, but I'm not good at estimating how much the
audio is out of sync.

> I attached another patch which is for the softdevice cvs but I think it
> should apply as well to softdevice-0.1.2, it prints the raw delay like
> the softdevice gets it from libasound as well as the delay like it is
> used for the A-V synchronisation.

Thanks, I'll try the patch later when my system is not recording
anything.

> Strange, I'm useing also a via82xx, kernel 2.6.12 without any problems.
> But I'm useing an older alsa-library: 1.0.3b.

Can you try to update your ALSA library?

> I wonder how many people have this problems, as Stefan already stated if
> you build some alsa filter chains the delay is not reported correctly.
> Do you use by any chance some alsa filters?

I don't think so.  I have installed alsa-utils and alsa-base.  On startup,
alsa-utils restores the mixer levels by executing alsactl and amixer.
There are no other alsa related startup scripts.

	Marko


From stefan at lucke.in-berlin.de  Tue Aug 16 20:57:13 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 16 Aug 2005 20:57:13 +0200
Subject: [Softdevice-devel] Minor AV sync problems
In-Reply-To: <20050815195421.GC3176@localhost.localdomain>
References: <Pine.LNX.4.61.0507311431400.7531@pub6.ifh.de> <4300AB42.3010306@gmx.net> <20050815195421.GC3176@localhost.localdomain>
Message-ID: <200508162057.13134.stefan@lucke.in-berlin.de>

On Montag, 15. August 2005 21:54, Marko M?kel? wrote:
> On Mon, Aug 15, 2005 at 04:48:34PM +0200, Martin Wache wrote:

> 
> > Strange, I'm useing also a via82xx, kernel 2.6.12 without any problems.
> > But I'm useing an older alsa-library: 1.0.3b.
> 
> Can you try to update your ALSA library?

I gave alsa-1.0.9 a try which resulted in no sound at all. vdr startup
reported a error:
ALSA lib pcm_dmix.c:802:(snd_pcm_dmix_open) unable to open slave

So I'm now back on alsa-1.0.5(a) [with sound ;-) ].

My soundcard is using alsa driver "cmipci", info KAMix: CMI8738-MC6

> 
> > I wonder how many people have this problems, as Stefan already stated if
> > you build some alsa filter chains the delay is not reported correctly.
> > Do you use by any chance some alsa filters?
> 
> I don't think so.  I have installed alsa-utils and alsa-base.  On startup,
> alsa-utils restores the mixer levels by executing alsactl and amixer.
> There are no other alsa related startup scripts.

Can you show us your /etc/asound.state ?


-- 
Stefan Lucke



From marko.makela at hut.fi  Tue Aug 16 21:25:33 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 16 Aug 2005 22:25:33 +0300
Subject: [Softdevice-devel] Minor AV sync problems
In-Reply-To: <200508162057.13134.stefan@lucke.in-berlin.de>
References: <Pine.LNX.4.61.0507311431400.7531@pub6.ifh.de> <4300AB42.3010306@gmx.net> <20050815195421.GC3176@localhost.localdomain> <200508162057.13134.stefan@lucke.in-berlin.de>
Message-ID: <20050816192533.GE3163@localhost.localdomain>

On Tue, Aug 16, 2005 at 08:57:13PM +0200, Stefan Lucke wrote:
> Can you show us your /etc/asound.state ?

There is no such file.  However, there is /var/lib/alsa/asound.state,
modification date today (attached).

	Marko
-------------- next part --------------
state.rev50 {
	control.1 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 1
		iface MIXER
		name 'Master Playback Switch'
		value true
	}
	control.2 {
		comment.access 'read write'
		comment.type INTEGER
		comment.count 2
		comment.range '0 - 31'
		iface MIXER
		name 'Master Playback Volume'
		value.0 31
		value.1 31
	}
	control.3 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 1
		iface MIXER
		name 'Headphone Playback Switch'
		value true
	}
	control.4 {
		comment.access 'read write'
		comment.type INTEGER
		comment.count 2
		comment.range '0 - 31'
		iface MIXER
		name 'Headphone Playback Volume'
		value.0 23
		value.1 23
	}
	control.5 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 1
		iface MIXER
		name 'Master Mono Playback Switch'
		value false
	}
	control.6 {
		comment.access 'read write'
		comment.type INTEGER
		comment.count 1
		comment.range '0 - 31'
		iface MIXER
		name 'Master Mono Playback Volume'
		value 0
	}
	control.7 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 1
		iface MIXER
		name 'PC Speaker Playback Switch'
		value false
	}
	control.8 {
		comment.access 'read write'
		comment.type INTEGER
		comment.count 1
		comment.range '0 - 15'
		iface MIXER
		name 'PC Speaker Playback Volume'
		value 6
	}
	control.9 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 1
		iface MIXER
		name 'Phone Playback Switch'
		value false
	}
	control.10 {
		comment.access 'read write'
		comment.type INTEGER
		comment.count 1
		comment.range '0 - 31'
		iface MIXER
		name 'Phone Playback Volume'
		value 0
	}
	control.11 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 1
		iface MIXER
		name 'Mic Playback Switch'
		value false
	}
	control.12 {
		comment.access 'read write'
		comment.type INTEGER
		comment.count 1
		comment.range '0 - 31'
		iface MIXER
		name 'Mic Playback Volume'
		value 0
	}
	control.13 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 1
		iface MIXER
		name 'Mic Boost (+20dB)'
		value false
	}
	control.14 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 1
		iface MIXER
		name 'Line Playback Switch'
		value false
	}
	control.15 {
		comment.access 'read write'
		comment.type INTEGER
		comment.count 2
		comment.range '0 - 31'
		iface MIXER
		name 'Line Playback Volume'
		value.0 0
		value.1 0
	}
	control.16 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 1
		iface MIXER
		name 'CD Playback Switch'
		value true
	}
	control.17 {
		comment.access 'read write'
		comment.type INTEGER
		comment.count 2
		comment.range '0 - 31'
		iface MIXER
		name 'CD Playback Volume'
		value.0 28
		value.1 28
	}
	control.18 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 1
		iface MIXER
		name 'Video Playback Switch'
		value false
	}
	control.19 {
		comment.access 'read write'
		comment.type INTEGER
		comment.count 2
		comment.range '0 - 31'
		iface MIXER
		name 'Video Playback Volume'
		value.0 0
		value.1 0
	}
	control.20 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 1
		iface MIXER
		name 'Aux Playback Switch'
		value false
	}
	control.21 {
		comment.access 'read write'
		comment.type INTEGER
		comment.count 2
		comment.range '0 - 31'
		iface MIXER
		name 'Aux Playback Volume'
		value.0 0
		value.1 0
	}
	control.22 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 1
		iface MIXER
		name 'PCM Playback Switch'
		value true
	}
	control.23 {
		comment.access 'read write'
		comment.type INTEGER
		comment.count 2
		comment.range '0 - 31'
		iface MIXER
		name 'PCM Playback Volume'
		value.0 31
		value.1 31
	}
	control.24 {
		comment.access 'read write'
		comment.type ENUMERATED
		comment.count 2
		comment.item.0 Mic
		comment.item.1 CD
		comment.item.2 Video
		comment.item.3 Aux
		comment.item.4 Line
		comment.item.5 Mix
		comment.item.6 'Mix Mono'
		comment.item.7 Phone
		iface MIXER
		name 'Capture Source'
		value.0 Mic
		value.1 Mic
	}
	control.25 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 1
		iface MIXER
		name 'Capture Switch'
		value true
	}
	control.26 {
		comment.access 'read write'
		comment.type INTEGER
		comment.count 2
		comment.range '0 - 15'
		iface MIXER
		name 'Capture Volume'
		value.0 0
		value.1 0
	}
	control.27 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 1
		iface MIXER
		name '3D Control - Switch'
		value false
	}
	control.28 {
		comment.access 'read write'
		comment.type ENUMERATED
		comment.count 1
		comment.item.0 Mix
		comment.item.1 Mic
		iface MIXER
		name 'Mono Output Select'
		value Mix
	}
	control.29 {
		comment.access 'read write'
		comment.type ENUMERATED
		comment.count 1
		comment.item.0 Mic1
		comment.item.1 Mic2
		iface MIXER
		name 'Mic Select'
		value Mic1
	}
	control.30 {
		comment.access 'read write'
		comment.type INTEGER
		comment.count 1
		comment.range '0 - 15'
		iface MIXER
		name '3D Control - Center'
		value 0
	}
	control.31 {
		comment.access 'read write'
		comment.type INTEGER
		comment.count 1
		comment.range '0 - 15'
		iface MIXER
		name '3D Control - Depth'
		value 0
	}
	control.32 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 1
		iface MIXER
		name 'External Amplifier'
		value true
	}
}

From marko.makela at hut.fi  Tue Aug 16 21:45:55 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 16 Aug 2005 22:45:55 +0300
Subject: [Softdevice-devel] Minor AV sync problems
In-Reply-To: <4300AB42.3010306@gmx.net>
References: <Pine.LNX.4.61.0507311431400.7531@pub6.ifh.de> <42ED2D1B.4060008@gmx.net> <20050811174912.GB443738@kosh.hut.fi> <20050811183806.GD443738@kosh.hut.fi> <42FF96DA.6010407@gmx.net> <Pine.LNX.4.61.0508142125230.17851@pub4.ifh.de> <42FFB31D.8010805@gmx.net> <20050815124041.GA3213@localhost.localdomain> <20050815130233.GB3213@localhost.localdomain> <4300AB42.3010306@gmx.net>
Message-ID: <20050816194555.GF3163@localhost.localdomain>

On Mon, Aug 15, 2005 at 04:48:34PM +0200, Martin Wache wrote:
> Are you using MPlayer? I'm just a bit curious, maybe you can try to
> check if MPlayer is getting the audio delay correctly. To do this you
> have to edit libao2/ao_alsa.c in MPlayer's source directory. Search for
> get_delay and print out the result of their delay calculation, please
> note that they are useing floats for the delay.

I'm not using MPlayer regularly, and not at all on my VDR box.  The box
where I'm occasionally using it has an I82801DBICH4 (Intel ICH4).

> I guess we can try to work around that by just using the system clock to
> calculate the audio delay, but then we wouldn't be able to detect drifts
> of the sound clock.

With your patch, softdevice reported the line
Raw audio delay 0 audio delay 0
several times (both values always zero).

I'll try to compile vdr and softdevice on my laptop to see if it is any
different.

	Marko


From marko.makela at hut.fi  Tue Aug 16 22:19:43 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 16 Aug 2005 23:19:43 +0300
Subject: [Softdevice-devel] Minor AV sync problems
In-Reply-To: <20050816194555.GF3163@localhost.localdomain>
References: <42ED2D1B.4060008@gmx.net> <20050811174912.GB443738@kosh.hut.fi> <20050811183806.GD443738@kosh.hut.fi> <42FF96DA.6010407@gmx.net> <Pine.LNX.4.61.0508142125230.17851@pub4.ifh.de> <42FFB31D.8010805@gmx.net> <20050815124041.GA3213@localhost.localdomain> <20050815130233.GB3213@localhost.localdomain> <4300AB42.3010306@gmx.net> <20050816194555.GF3163@localhost.localdomain>
Message-ID: <20050816201943.GG3163@localhost.localdomain>

On Tue, Aug 16, 2005 at 10:45:55PM +0300, Marko M?kel? wrote:
> With your patch, softdevice reported the line
> Raw audio delay 0 audio delay 0
> several times (both values always zero).

Same thing on the laptop, with Xv output.  The audio is out of sync,
and the delays are reported as 0.  This was on the ICH4 chipset.

I think the next step is to downgrade libasound2 or the alsa kernel
modules.  Currently, /proc/asound/version says 1.0.9rc2, as I've
compiled ALSA as monolithic part of the kernel.

	Marko


From stefan at lucke.in-berlin.de  Tue Aug 16 22:57:25 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 16 Aug 2005 22:57:25 +0200
Subject: [Softdevice-devel] Minor AV sync problems
In-Reply-To: <200508162057.13134.stefan@lucke.in-berlin.de>
References: <Pine.LNX.4.61.0507311431400.7531@pub6.ifh.de> <20050815195421.GC3176@localhost.localdomain> <200508162057.13134.stefan@lucke.in-berlin.de>
Message-ID: <200508162257.25449.stefan@lucke.in-berlin.de>

On Dienstag, 16. August 2005 20:57, Stefan Lucke wrote:
> On Montag, 15. August 2005 21:54, Marko M?kel? wrote:
> > On Mon, Aug 15, 2005 at 04:48:34PM +0200, Martin Wache wrote:
> 
> > 
> > > Strange, I'm useing also a via82xx, kernel 2.6.12 without any problems.
> > > But I'm useing an older alsa-library: 1.0.3b.
> > 
> > Can you try to update your ALSA library?
> 
> I gave alsa-1.0.9 a try which resulted in no sound at all. vdr startup
> reported a error:
> ALSA lib pcm_dmix.c:802:(snd_pcm_dmix_open) unable to open slave
> 
> So I'm now back on alsa-1.0.5(a) [with sound ;-) ].

I tried alsa-1.0.9 a 2'nd time and this was more successful no more error
messages from pcm_dmix.c.
But guess what happens:

CMD[0903]:new Audio stream index.. old -1 new 1
CMD[0903]:Neuer StreamDecoder Pid: 5763 context 0x8569208 type 1
CMD[0903]:Neuer Thread gestartet: pid:5765 type 0
CMD[0931]:Neuer Thread gestartet: pid:5766 type 1
[softdevice] allocating picture buffer for resolution 704x576 format 0
audioPTS[1047]:delay 0 audio pts offset -1975670690 pts 240
audioPTS[1048]:delay 0 audio pts offset -1975670922 pts 480
audioPTS[1049]:delay 0 audio pts offset -1975671154 pts 720
audioPTS[1050]:delay 0 audio pts offset -1975671386 pts 960

NOOO audio delay any more :-((. That happens when using "default" as
alsa device name (fromerly I changed the wrong one, we have two of
them in setup.conf. one for PCM out and the other for the still missing
ac3 out feature).

When using (from vdr setup.conf)
softdevice.AlsaDevice = hw:0,2
audio delay is back :-)) .

audioPTS[4892]:delay 1919 audio pts offset -2197036978 pts 225206895
audioPTS[4916]:delay 1920 audio pts offset -2197036978 pts 225207135

> 
> My soundcard is using alsa driver "cmipci", info KAMix: CMI8738-MC6
> 
> > 
> > > I wonder how many people have this problems, as Stefan already stated if
> > > you build some alsa filter chains the delay is not reported correctly.
> > > Do you use by any chance some alsa filters?
> > 
> > I don't think so.  I have installed alsa-utils and alsa-base.  On startup,
> > alsa-utils restores the mixer levels by executing alsactl and amixer.
> > There are no other alsa related startup scripts.
> 
> Can you show us your /etc/asound.state ?

Saw no obvious strange thing in Marko's asound.state.

-- 
Stefan Lucke



From torgeir at pobox.com  Wed Aug 17 01:39:33 2005
From: torgeir at pobox.com (Torgeir Veimo)
Date: Wed, 17 Aug 2005 00:39:33 +0100
Subject: [Softdevice-devel] Minor AV sync problems
In-Reply-To: <20050816201943.GG3163@localhost.localdomain>
References: <42ED2D1B.4060008@gmx.net> <20050811174912.GB443738@kosh.hut.fi>
	 <20050811183806.GD443738@kosh.hut.fi> <42FF96DA.6010407@gmx.net>
	 <Pine.LNX.4.61.0508142125230.17851@pub4.ifh.de> <42FFB31D.8010805@gmx.net>
	 <20050815124041.GA3213@localhost.localdomain>
	 <20050815130233.GB3213@localhost.localdomain> <4300AB42.3010306@gmx.net>
	 <20050816194555.GF3163@localhost.localdomain>
	 <20050816201943.GG3163@localhost.localdomain>
Message-ID: <1124235573.10732.0.camel@africa.netenviron.com>

On Tue, 2005-08-16 at 23:19 +0300, Marko M?kel? wrote:
> On Tue, Aug 16, 2005 at 10:45:55PM +0300, Marko M?kel? wrote:
> > With your patch, softdevice reported the line
> > Raw audio delay 0 audio delay 0
> > several times (both values always zero).
> 
> Same thing on the laptop, with Xv output.  The audio is out of sync,
> and the delays are reported as 0.  This was on the ICH4 chipset.

What is your /etc/asound.conf like?

-- 
Torgeir Veimo <torgeir at pobox.com>



From marko.makela at hut.fi  Wed Aug 17 08:59:08 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 17 Aug 2005 09:59:08 +0300
Subject: [Softdevice-devel] Minor AV sync problems
In-Reply-To: <1124235573.10732.0.camel@africa.netenviron.com>
References: <20050811183806.GD443738@kosh.hut.fi> <42FF96DA.6010407@gmx.net> <Pine.LNX.4.61.0508142125230.17851@pub4.ifh.de> <42FFB31D.8010805@gmx.net> <20050815124041.GA3213@localhost.localdomain> <20050815130233.GB3213@localhost.localdomain> <4300AB42.3010306@gmx.net> <20050816194555.GF3163@localhost.localdomain> <20050816201943.GG3163@localhost.localdomain> <1124235573.10732.0.camel@africa.netenviron.com>
Message-ID: <20050817065908.GA3187@localhost.localdomain>

On Wed, Aug 17, 2005 at 12:39:33AM +0100, Torgeir Veimo wrote:
> > Same thing on the laptop, with Xv output.  The audio is out of sync,
> > and the delays are reported as 0.  This was on the ICH4 chipset.
> 
> What is your /etc/asound.conf like?

I don't have any such file.  If you mean asound.state, here's the
/var/lib/alsa/asound.state from my laptop.  (I'm using Debian
GNU/Linux packaged libalsa2, alsa-base, alsa-utils, and the kernel
drivers bundled with 2.6.12.3.)

	Marko
-------------- next part --------------
state.I82801DBICH4 {
	control.1 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 2
		iface MIXER
		name 'Master Playback Switch'
		value.0 true
		value.1 true
	}
	control.2 {
		comment.access 'read write'
		comment.type INTEGER
		comment.count 2
		comment.range '0 - 31'
		iface MIXER
		name 'Master Playback Volume'
		value.0 21
		value.1 21
	}
	control.3 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 2
		iface MIXER
		name 'Headphone Playback Switch'
		value.0 true
		value.1 true
	}
	control.4 {
		comment.access 'read write'
		comment.type INTEGER
		comment.count 2
		comment.range '0 - 31'
		iface MIXER
		name 'Headphone Playback Volume'
		value.0 23
		value.1 23
	}
	control.5 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 1
		iface MIXER
		name 'Master Mono Playback Switch'
		value false
	}
	control.6 {
		comment.access 'read write'
		comment.type INTEGER
		comment.count 1
		comment.range '0 - 31'
		iface MIXER
		name 'Master Mono Playback Volume'
		value 0
	}
	control.7 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 1
		iface MIXER
		name 'Phone Playback Switch'
		value false
	}
	control.8 {
		comment.access 'read write'
		comment.type INTEGER
		comment.count 1
		comment.range '0 - 31'
		iface MIXER
		name 'Phone Playback Volume'
		value 0
	}
	control.9 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 1
		iface MIXER
		name 'Mic Playback Switch'
		value false
	}
	control.10 {
		comment.access 'read write'
		comment.type INTEGER
		comment.count 1
		comment.range '0 - 31'
		iface MIXER
		name 'Mic Playback Volume'
		value 0
	}
	control.11 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 1
		iface MIXER
		name 'Mic Boost (+20dB)'
		value false
	}
	control.12 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 2
		iface MIXER
		name 'Line Playback Switch'
		value.0 false
		value.1 false
	}
	control.13 {
		comment.access 'read write'
		comment.type INTEGER
		comment.count 2
		comment.range '0 - 31'
		iface MIXER
		name 'Line Playback Volume'
		value.0 0
		value.1 0
	}
	control.14 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 2
		iface MIXER
		name 'CD Playback Switch'
		value.0 true
		value.1 true
	}
	control.15 {
		comment.access 'read write'
		comment.type INTEGER
		comment.count 2
		comment.range '0 - 31'
		iface MIXER
		name 'CD Playback Volume'
		value.0 28
		value.1 28
	}
	control.16 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 2
		iface MIXER
		name 'Aux Playback Switch'
		value.0 false
		value.1 false
	}
	control.17 {
		comment.access 'read write'
		comment.type INTEGER
		comment.count 2
		comment.range '0 - 31'
		iface MIXER
		name 'Aux Playback Volume'
		value.0 0
		value.1 0
	}
	control.18 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 2
		iface MIXER
		name 'PCM Playback Switch'
		value.0 true
		value.1 true
	}
	control.19 {
		comment.access 'read write'
		comment.type INTEGER
		comment.count 2
		comment.range '0 - 31'
		iface MIXER
		name 'PCM Playback Volume'
		value.0 31
		value.1 31
	}
	control.20 {
		comment.access 'read write'
		comment.type ENUMERATED
		comment.count 2
		comment.item.0 Mic
		comment.item.1 CD
		comment.item.2 Video
		comment.item.3 Aux
		comment.item.4 Line
		comment.item.5 Mix
		comment.item.6 'Mix Mono'
		comment.item.7 Phone
		iface MIXER
		name 'Capture Source'
		value.0 Mic
		value.1 Mic
	}
	control.21 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 2
		iface MIXER
		name 'Capture Switch'
		value.0 true
		value.1 true
	}
	control.22 {
		comment.access 'read write'
		comment.type INTEGER
		comment.count 2
		comment.range '0 - 15'
		iface MIXER
		name 'Capture Volume'
		value.0 0
		value.1 0
	}
	control.23 {
		comment.access 'read write'
		comment.type ENUMERATED
		comment.count 1
		comment.item.0 Mix
		comment.item.1 Mic
		iface MIXER
		name 'Mono Output Select'
		value Mix
	}
	control.24 {
		comment.access 'read write'
		comment.type ENUMERATED
		comment.count 1
		comment.item.0 Mic1
		comment.item.1 Mic2
		iface MIXER
		name 'Mic Select'
		value Mic1
	}
	control.25 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 1
		iface MIXER
		name 'Stereo Mic'
		value false
	}
	control.26 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 1
		iface MIXER
		name 'Headphone Jack Sense'
		value false
	}
	control.27 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 1
		iface MIXER
		name 'Line Jack Sense'
		value false
	}
	control.28 {
		comment.access 'read write'
		comment.type BOOLEAN
		comment.count 1
		iface MIXER
		name 'External Amplifier'
		value true
	}
}

From stefan at lucke.in-berlin.de  Wed Aug 17 19:17:09 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 17 Aug 2005 19:17:09 +0200
Subject: [Softdevice-devel] Minor AV sync problems
In-Reply-To: <200508162257.25449.stefan@lucke.in-berlin.de>
References: <Pine.LNX.4.61.0507311431400.7531@pub6.ifh.de> <200508162057.13134.stefan@lucke.in-berlin.de> <200508162257.25449.stefan@lucke.in-berlin.de>
Message-ID: <200508171917.09607.stefan@lucke.in-berlin.de>

On Dienstag, 16. August 2005 22:57, Stefan Lucke wrote:
> On Dienstag, 16. August 2005 20:57, Stefan Lucke wrote:
> > On Montag, 15. August 2005 21:54, Marko M?kel? wrote:
> > > On Mon, Aug 15, 2005 at 04:48:34PM +0200, Martin Wache wrote:
> > 
> > > 
> > > > Strange, I'm useing also a via82xx, kernel 2.6.12 without any problems.
> > > > But I'm useing an older alsa-library: 1.0.3b.
> > > 
> > > Can you try to update your ALSA library?
> > 
> > I gave alsa-1.0.9 a try which resulted in no sound at all. vdr startup
> > reported a error:
> > ALSA lib pcm_dmix.c:802:(snd_pcm_dmix_open) unable to open slave
> > 
> > So I'm now back on alsa-1.0.5(a) [with sound ;-) ].
> 
> I tried alsa-1.0.9 a 2'nd time and this was more successful no more error
> messages from pcm_dmix.c.
> But guess what happens:
> 
> CMD[0903]:new Audio stream index.. old -1 new 1
> CMD[0903]:Neuer StreamDecoder Pid: 5763 context 0x8569208 type 1
> CMD[0903]:Neuer Thread gestartet: pid:5765 type 0
> CMD[0931]:Neuer Thread gestartet: pid:5766 type 1
> [softdevice] allocating picture buffer for resolution 704x576 format 0
> audioPTS[1047]:delay 0 audio pts offset -1975670690 pts 240
> audioPTS[1048]:delay 0 audio pts offset -1975670922 pts 480
> audioPTS[1049]:delay 0 audio pts offset -1975671154 pts 720
> audioPTS[1050]:delay 0 audio pts offset -1975671386 pts 960
> 
> NOOO audio delay any more :-((. That happens when using "default" as
> alsa device name (fromerly I changed the wrong one, we have two of
> them in setup.conf. one for PCM out and the other for the still missing
> ac3 out feature).
> 
> When using (from vdr setup.conf)
> softdevice.AlsaDevice = hw:0,2
> audio delay is back :-)) .
> 
> audioPTS[4892]:delay 1919 audio pts offset -2197036978 pts 225206895
> audioPTS[4916]:delay 1920 audio pts offset -2197036978 pts 225207135
> 

I found a way to get a audio delay with alsa-1.0.9 and default device.
Please try attached patch. There are additional fprintfs which will be
removed before committing. The messages now look like:

(0 - 3115)  (0 - 3115)  audioPTS[2853]:delay 3115 audio pts offset -2197034010 pts 951384735
(0 - 3142)  (0 - 3142)  audioPTS[2875]:delay 3142 audio pts offset -2197034008 pts 951384975
(0 - 3169)  (0 - 3169)  audioPTS[2898]:delay 3169 audio pts offset -2197033992 pts 951385215
(0 - 3195)  (0 - 3195)  audioPTS[2918]:delay 3195 audio pts offset -2197034004 pts 951385455

Patch will return the alternate value if primay value is zero. When I use
-ao alsa:hw:0,0 option, reported delays are in both cases similar but lower:

(1916 - 1916)  (1915 - 1915)  audioPTS[9074]:delay 1915 audio pts offset -1242591583 pts 7603318
(1916 - 1916)  (1915 - 1915)  audioPTS[9098]:delay 1915 audio pts offset -1242591583 pts 7603558
(1915 - 1915)  (1915 - 1915)  audioPTS[9122]:delay 1915 audio pts offset -1242591584 pts 7603798
(1913 - 1913)  (1912 - 1912)  audioPTS[9147]:delay 1912 audio pts offset -1242591583 pts 7604038
(1920 - 1920)  (1919 - 1919)  audioPTS[9170]:delay 1919 audio pts offset -1242591583 pts 7604278

-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: audio_delay_fix_01.diff
Type: text/x-diff
Size: 1332 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050817/369b0f53/attachment.diff>

From marko.makela at hut.fi  Wed Aug 17 21:04:21 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 17 Aug 2005 22:04:21 +0300
Subject: [Softdevice-devel] Minor AV sync problems
In-Reply-To: <200508171917.09607.stefan@lucke.in-berlin.de>
References: <Pine.LNX.4.61.0507311431400.7531@pub6.ifh.de> <200508162057.13134.stefan@lucke.in-berlin.de> <200508162257.25449.stefan@lucke.in-berlin.de> <200508171917.09607.stefan@lucke.in-berlin.de>
Message-ID: <20050817190421.GC3273@localhost.localdomain>

Stefan,

> I found a way to get a audio delay with alsa-1.0.9 and default device.
> Please try attached patch. There are additional fprintfs which will be
> removed before committing. The messages now look like:
> 
> (0 - 3115)  (0 - 3115)  audioPTS[2853]:delay 3115 audio pts offset -2197034010 pts 951384735

On my laptop (pretty much vanilla CVS + this most recent patch), the
output for a recorded stream (there is no DVB tuner) looks like this:

(0 - 2703)  (0 - 2943)  (0 - 3183)  (0 - 3210)  (0 - 3023)  (0 - 3050)
(0 - 2863)  (0 - 3103)  (0 - 3130)  (0 - 3157)  (0 - 3183)  ...

(all in a single line, no linefeeds)

The lip sync is perfect now, thank you!  I believe that this patch will
fix the sync problems on my VDR box as well.

	Marko


From marko.makela at hut.fi  Wed Aug 17 21:51:14 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 17 Aug 2005 22:51:14 +0300
Subject: [Softdevice-devel] Minor AV sync problems - fix works!
In-Reply-To: <200508171917.09607.stefan@lucke.in-berlin.de>
References: <Pine.LNX.4.61.0507311431400.7531@pub6.ifh.de> <200508162057.13134.stefan@lucke.in-berlin.de> <200508162257.25449.stefan@lucke.in-berlin.de> <200508171917.09607.stefan@lucke.in-berlin.de>
Message-ID: <20050817195114.GF3273@localhost.localdomain>

On Wed, Aug 17, 2005 at 07:17:09PM +0200, Stefan Lucke wrote:
> I found a way to get a audio delay with alsa-1.0.9 and default device.
> Please try attached patch. There are additional fprintfs which will be
> removed before committing.

I applied the patch to my vdr box as well and removed the fprintfs
before compiling.  The AV sync is perfect now.  Thank you again!

	Marko


From marko.makela at hut.fi  Wed Aug 17 23:12:55 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 18 Aug 2005 00:12:55 +0300
Subject: [Softdevice-devel] Remarks about cSoftDevice::SetPlayMode()
Message-ID: <20050817211255.GA5205@localhost.localdomain>

I'm trying to figure out how to introduce a "suspended" flag to VDR.
That would make softdevice's "suspended" flag largely redundant
except for testing purposes.  When VDR would be suspended, it would
stop sending any MPEG data to the active cDevice.

While searching for a place for my hooks, I noticed the method
cDevice::SetPlayMode().  In softdevice.c, there's a comment
"FIXME - Implement audio or video only Playmode".  However, it
looks like these modes have already been implemented.  The
"XXX hack" assignment AudioIdx=DONT_PLAY in cMpeg2Decoder::StillPicture()
looks like it could be from the era when the video only playmode
was not implemented.  Same thing in cMpeg2Decoder::TrickSpeed().

By the way, I think that the VDR "suspended" flag would have to be
examined in cDevice::PlayPesPacket().  I believe that it is best to
make the flag independent of the play mode, like the softdevice
suspended flag currently is.

	Marko


From noreply at berlios.de  Wed Aug 17 23:27:50 2005
From: noreply at berlios.de (noreply at berlios.de)
Date: Wed, 17 Aug 2005 23:27:50 +0200 (CEST)
Subject: [Softdevice-devel] [Bug #2971] Short gaps in audio output
Message-ID: <200508172127.j7HLRon3004297@unicorn.berlios.de>

Bug #2971, was updated on 2004-Dec-29 22:35
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: audio-out
Status: Closed
Resolution: Fixed
Bug Group: None
Priority: 5
Submitted by: vesuri
Assigned to : none
Summary: Short gaps in audio output

Details: The audio output in vdr-softdevice-0.0.8pre1 seems to suffer from severe buffering problems. There are short gaps in the audio output and the gaps occur repeatedly so that there is a constant buzz in the sound. It sounds like multiplying the audio signal by 1 for a short while and then by 0 for a short while and then again by 1 etc.

Setup:

- vdr-1.3.17
- vdr-softdevice-0.0.8pre1
- GCC 3.4.2
- glibc 2.3.4
- Linux 2.6.9-mh3
- ALSA 1.0.7
- Current FFMPEG CVS as of 20041229


Follow-Ups:

Date: 2005-Aug-17 23:27
By: lucke

Comment:
Changed audio delay retrieval from snd_pcm_status_get_delay() to snd_pcm_delay(). That fixes delay with alsa-1.0.9 on "default" device and should fix dmix sync problems too.
-------------------------------------------------------

Date: 2004-Dec-30 20:37
By: iampivot

Comment:
The reason for the dropouts with dmix is that the alsa function snd_pcm_status_get_delay(status) returns 0, and the delay is important for syncing up audio and video. It might be an idea to look at what other media players do to sync in these cases.
-------------------------------------------------------

Date: 2004-Dec-30 20:27
By: vesuri

Comment:
Actually this turned out to be a problem with the ALSA dmix (software mixing) plugin since I have configured the default device to go through it. Both the internal intel8x0 card and the Audiophile work fine when used without dmix - no xruns, samplerate 48000Hz, channels 2. I need to use a slave device with only 2 channels with the Audiophile though (the hardware device has 10 channels) but it's the same with virtually all other programs as well.

I haven't had problems with the dmix device with other programs though.
-------------------------------------------------------

Date: 2004-Dec-30 15:33
By: vesuri

Comment:
Motherboard: ABit IS7
CPU: Pentium 4 2,8GHz
Soundcards: intel8x0 (integrated on the motherboard), ice1712 (M-Audio Audiophile 2496)

VDR 1.2.6 and softdevice 0.0.7 had the same effect.

I'll get back to you about the possible xruns and sample rates later today (I'm not using the computer just now).
-------------------------------------------------------

Date: 2004-Dec-30 12:41
By: lucke

Comment:
Which hardware do you use (mobo & cpu & soundcard/chips) ?
Did you use previous softdevice versions too with same effect ?
Do you get messages like:
Dec 30 11:31:03 jarada vdr[3351]: [softdevice-audio]: xrun
Whats the sound sample rate ?
Dec 30 11:26:26 jarada vdr[3230]: [softdevice-audio] samplerate: 48000Hz, channels: #2
-------------------------------------------------------

For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=2971&group_id=2051


From M.Wache at gmx.net  Thu Aug 18 11:54:52 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 18 Aug 2005 11:54:52 +0200
Subject: [Softdevice-devel] Remarks about cSoftDevice::SetPlayMode()
In-Reply-To: <20050817211255.GA5205@localhost.localdomain>
References: <20050817211255.GA5205@localhost.localdomain>
Message-ID: <43045AEC.8080307@gmx.net>

Marko M?kel? schrieb:
> While searching for a place for my hooks, I noticed the method
> cDevice::SetPlayMode().  In softdevice.c, there's a comment
> "FIXME - Implement audio or video only Playmode".  However, it
> looks like these modes have already been implemented. The
> "XXX hack" assignment AudioIdx=DONT_PLAY in cMpeg2Decoder::StillPicture()
> looks like it could be from the era when the video only playmode
> was not implemented.  Same thing in cMpeg2Decoder::TrickSpeed().

It's true that audio and video only modes are present in the softdevice,
 but they are a corrupted. The reason is exactly the "XXX hack" parts,
we need this since vdr sends, when sending only video I-Frames for
StillPicture or TrickSpeed mode, sometimes audio junk. So the hack is to
turn off audio playback while displaying a StillPicture or in trickspeed
mode.
The drawback of this hack is that if you've requested video only, you
will get audio after a still picture or trickspeed mode. Up to now noone
complained about that...

> 
> By the way, I think that the VDR "suspended" flag would have to be
> examined in cDevice::PlayPesPacket().  I believe that it is best to
> make the flag independent of the play mode, like the softdevice
> suspended flag currently is.

This would only work in transfer and replay mode. I'm not sure about
this since I don't own a FF card, but as far as I know FF cards usually
don't use transfer mode while watching TV. So in case you want to ask
Klaus to introduce the patch into mainline vdr I guess you have to do it
differently, or take extra care of the FF cards.
But I don't know how to switch off the non-transfer mode for FF card,
however I guess it should not be difficult.

Martin



From marko.makela at hut.fi  Thu Aug 18 21:24:32 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 18 Aug 2005 22:24:32 +0300
Subject: [Softdevice-devel] Remarks about cSoftDevice::SetPlayMode()
In-Reply-To: <43045AEC.8080307@gmx.net>
References: <20050817211255.GA5205@localhost.localdomain> <43045AEC.8080307@gmx.net>
Message-ID: <20050818192432.GD3271@localhost.localdomain>

On Thu, Aug 18, 2005 at 11:54:52AM +0200, Martin Wache wrote:
> The drawback of this hack is that if you've requested video only, you
> will get audio after a still picture or trickspeed mode. Up to now noone
> complained about that...

How can one request the different play modes?  I just surfed the setup
menus of vdr 1.3.27 and didn't notice anything relevant.

> > By the way, I think that the VDR "suspended" flag would have to be
> > examined in cDevice::PlayPesPacket().  I believe that it is best to
> > make the flag independent of the play mode, like the softdevice
> > suspended flag currently is.
> 
> This would only work in transfer and replay mode. I'm not sure about
> this since I don't own a FF card, but as far as I know FF cards usually
> don't use transfer mode while watching TV. So in case you want to ask
> Klaus to introduce the patch into mainline vdr I guess you have to do it
> differently, or take extra care of the FF cards.

Well, I guess the patch simply wouldn't suspend live playback on FF
cards.  It shouldn't break anything; it'd just make the user experience
a bit inconsistent.  I don't have high hopes of getting the patch
accepted to VDR, but we'll see.

> But I don't know how to switch off the non-transfer mode for FF card,
> however I guess it should not be difficult.

I wouldn't be too sure about that.  It depends on how the proprietary
firmware of the cards has been written.

	Marko


From M.Wache at gmx.net  Fri Aug 19 21:25:17 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Fri, 19 Aug 2005 21:25:17 +0200
Subject: [Softdevice-devel] Remarks about cSoftDevice::SetPlayMode()
In-Reply-To: <20050818192432.GD3271@localhost.localdomain>
References: <20050817211255.GA5205@localhost.localdomain> <43045AEC.8080307@gmx.net> <20050818192432.GD3271@localhost.localdomain>
Message-ID: <4306321D.7030402@gmx.net>

Marko M?kel? schrieb:
> On Thu, Aug 18, 2005 at 11:54:52AM +0200, Martin Wache wrote:
> 
>>The drawback of this hack is that if you've requested video only, you
>>will get audio after a still picture or trickspeed mode. Up to now noone
>>complained about that...
> 
> 
> How can one request the different play modes?  I just surfed the setup
> menus of vdr 1.3.27 and didn't notice anything relevant.
> 
Playmodes are requested by the cPlayer class which open the output
devices for playback. Usually the user doesn't have to care about that
and usually if a player requests audio/video only it also sends only
audio/video, so I don't think we will get into trouble with this hack.

> 
>>>By the way, I think that the VDR "suspended" flag would have to be
>>>examined in cDevice::PlayPesPacket().  I believe that it is best to
>>>make the flag independent of the play mode, like the softdevice
>>>suspended flag currently is.
>>
>>This would only work in transfer and replay mode. I'm not sure about
>>this since I don't own a FF card, but as far as I know FF cards usually
>>don't use transfer mode while watching TV. So in case you want to ask
>>Klaus to introduce the patch into mainline vdr I guess you have to do it
>>differently, or take extra care of the FF cards.
> 
> 
> Well, I guess the patch simply wouldn't suspend live playback on FF
> cards.  It shouldn't break anything; it'd just make the user experience
> a bit inconsistent.  I don't have high hopes of getting the patch
> accepted to VDR, but we'll see.
> 
I would appreaciate a feature like suspend in main vdr, and the better
the patch is made, the better are the chances to get it accepted.


> 
>>But I don't know how to switch off the non-transfer mode for FF card,
>>however I guess it should not be difficult.
> 
> 
> I wouldn't be too sure about that.  It depends on how the proprietary
> firmware of the cards has been written.
> 
For replay of recordings the stream directly from the tuner to the
decoder has to be stopped, so it has to be possible. If you now just
don't anything of to replay the decoding should be stopped :-)
Well, I don't know for sure I don't own a FF card...

Martin


From marko.makela at hut.fi  Tue Aug 23 21:56:44 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 23 Aug 2005 22:56:44 +0300
Subject: [Softdevice-devel] Remarks about cSoftDevice::SetPlayMode()
In-Reply-To: <4306321D.7030402@gmx.net>
References: <20050817211255.GA5205@localhost.localdomain> <43045AEC.8080307@gmx.net> <20050818192432.GD3271@localhost.localdomain> <4306321D.7030402@gmx.net>
Message-ID: <20050823195644.GA251888@kosh.hut.fi>

On Fri, Aug 19, 2005 at 09:25:17PM +0200, Martin Wache wrote:
> For replay of recordings the stream directly from the tuner to the
> decoder has to be stopped, so it has to be possible. If you now just
> don't anything of to replay the decoding should be stopped :-)

You've convinced me.

Alas, it looks like making cDevice::PlayPesPacket() simply return
Length when playback is suspended won't cut it.  If I make the
method return 0 when suspended, it seems to cause a busy loop.

Playback will be suspended in both cases, but I believe that
the decoder should be reset when suspending (or resuming)
playback.  Now, at resume it'll take some time until the
decoder has re-synchronized on the stream.  Also, the screen
should be blanked immediately at suspend.  Are there some
methods for resetting the decoder and blanking the screen?

One more thing: the stream reader won't be suspended.  It'd be
nice if the DVB tuner were shut down during suspend, or if
the suspend key could be used as a "pause" key while playing
back recordings.  I think that the latter could be achieved by
catching the kSuspend key in menu.c and by making it work like
kPause or kPlay after flipping the flag.  However, I have to
figure out how to avoid a conflict between vdr.c and menu.c
reading this key.

Given that I'm such a novice when it comes to the VDR code base,
I think it's best I'll post the patch here first and wait for
some comments before presenting it on the main VDR list.  But
I'm not there yet.  Can you give me a few hints?

	Marko


From M.Wache at gmx.net  Wed Aug 24 17:54:58 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Wed, 24 Aug 2005 17:54:58 +0200
Subject: [Softdevice-devel] Remarks about cSoftDevice::SetPlayMode()
In-Reply-To: <20050823195644.GA251888@kosh.hut.fi>
References: <20050817211255.GA5205@localhost.localdomain> <43045AEC.8080307@gmx.net> <20050818192432.GD3271@localhost.localdomain> <4306321D.7030402@gmx.net> <20050823195644.GA251888@kosh.hut.fi>
Message-ID: <430C9852.2000307@gmx.net>

Marko M?kel? schrieb:

> Playback will be suspended in both cases, but I believe that
> the decoder should be reset when suspending (or resuming)
> playback.  Now, at resume it'll take some time until the
> decoder has re-synchronized on the stream.  Also, the screen
> should be blanked immediately at suspend.  Are there some
> methods for resetting the decoder and blanking the screen?
> 
I guess setting a Playmode resets the decoder, and the playMode
AudioOnlyBlack should blank the screen?

> One more thing: the stream reader won't be suspended.  It'd be
> nice if the DVB tuner were shut down during suspend, or if
> the suspend key could be used as a "pause" key while playing
> back recordings.  I think that the latter could be achieved by
> catching the kSuspend key in menu.c and by making it work like
> kPause or kPlay after flipping the flag.  However, I have to
> figure out how to avoid a conflict between vdr.c and menu.c
> reading this key.
> 
> Given that I'm such a novice when it comes to the VDR code base,
> I think it's best I'll post the patch here first and wait for
> some comments before presenting it on the main VDR list.  But
> I'm not there yet.  Can you give me a few hints?
> 
I fear I don't enough of the VDR code to be able to tell you a way a
suspend works without any problems. And I also don't know enough about
the FF cards....


But I searched again for the Suspendoutput-plugin and I found it:

http://www.vdr-wiki.de/wiki/index.php/Suspendoutput-plugin


This plugin works by just starting a playback without playing anything.
Maybe it the code gives you some new ideas...
But feel free to send a patch when you are ready, I will surely give it
a try.

Martin


From marko.makela at hut.fi  Wed Aug 24 21:27:58 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 24 Aug 2005 22:27:58 +0300
Subject: [Softdevice-devel] Remarks about cSoftDevice::SetPlayMode()
In-Reply-To: <430C9852.2000307@gmx.net>
References: <20050817211255.GA5205@localhost.localdomain> <43045AEC.8080307@gmx.net> <20050818192432.GD3271@localhost.localdomain> <4306321D.7030402@gmx.net> <20050823195644.GA251888@kosh.hut.fi> <430C9852.2000307@gmx.net>
Message-ID: <20050824192758.GB3349@localhost.localdomain>

On Wed, Aug 24, 2005 at 05:54:58PM +0200, Martin Wache wrote:
> But I searched again for the Suspendoutput-plugin and I found it:
> 
> http://www.vdr-wiki.de/wiki/index.php/Suspendoutput-plugin
> 
> 
> This plugin works by just starting a playback without playing anything.
> Maybe it the code gives you some new ideas...

Thanks, I contacted the author.  There are many interesting patches on
his vdr page and also a xineliboutput plugin.  I'd expect him to be able
to give some useful advice.

	Marko


From kim.patovaara at kolumbus.fi  Thu Aug 25 10:49:32 2005
From: kim.patovaara at kolumbus.fi (Kim Patovaara)
Date: Thu, 25 Aug 2005 11:49:32 +0300
Subject: [Softdevice-devel] Softdevice 0.1.2 and cvs compiling problems
Message-ID: <430D861C.50301@kolumbus.fi>

Hi,

I get following kinf orror if I try to compile with latest ffmpeg 
version. (with 0.4.9pre1 there is no problems errors)

make[1]: Entering directory 
`/usr/vdr-1.3.30/PLUGINS/src/softdevice_cvs_240805'
g++ -fPIC -g -O2 -Wall -Woverloaded-virtual -c -DUSE_MMX 
-DPLUGIN_NAME_I18N='"softdevice"' -D_GNU_SOURCE 
-DPLUGINLIBDIR='"./PLUGINS/lib"' -DUSE_SUBPLUGINS -DDFB_SUPPORT 
-DXV_SUPPORT -DPP_LIBAVCODEC -I../../../include -I../DVB/include 
-I/usr/local/include/ffmpeg/ -I/usr/include/dfb++ 
-I/usr/include/directfb softdevice.c
g++ -fPIC -g -O2 -Wall -Woverloaded-virtual -c -DUSE_MMX 
-DPLUGIN_NAME_I18N='"softdevice"' -D_GNU_SOURCE 
-DPLUGINLIBDIR='"./PLUGINS/lib"' -DUSE_SUBPLUGINS -DDFB_SUPPORT 
-DXV_SUPPORT -DPP_LIBAVCODEC -I../../../include -I../DVB/include 
-I/usr/local/include/ffmpeg/ -I/usr/include/dfb++ 
-I/usr/include/directfb utils.c
utils.c: In function `void* fast_memcpy(void*, const void*, size_t)':
utils.c:560: error: PIC register `%ebx' clobbered in `asm'
make[1]: *** [utils.o] Error 1

Versions:
gcc version 3.4.4 20050209 (prerelease) (Debian 3.4.3-9ubuntu4)
(Same problem also gcc 3.3.5)
Softdevice: CVS Aug 25 2005 or 0.1.2
ffmpeg: CVS Aug 25

Regards,
Kim


From nhuillard at e-dition.fr  Thu Aug 25 10:56:40 2005
From: nhuillard at e-dition.fr (Nicolas Huillard)
Date: Thu, 25 Aug 2005 10:56:40 +0200
Subject: [Softdevice-devel] viafb kernel frame buffer vs. 720x576 tvout no-scale update...
Message-ID: <430D87C8.1010101@e-dition.fr>

Just a little note :
I finally got the kernel frame-buffer driver from viaarena to work with
DirectFB. I can provide a patch against that viafb code to anyone
(change accelerator ID to match DirectFB + yvirtres reporting).
Drawback is that that viafb doesnt seem to handle virtual Y resolution
correctly, thus no double-buffering can work.

On the tv-out 720x576 no-scale front, I'm stuck... I understood a lot
about that VT1622 registers and their behaviour, but I still need advice
about the CRTC registers.
For what I know : I need to adjust CRTC (Unichrome chip) registers to
generate a 720x576 or 800x600 timing at 50hz, 28.000Mhz dotclock,
non-interlaced. Then the VT1622 will drive the Unichrome chip clock and
convert the VGA signal into S-Video signals, merging pixels vertically
(lines) or horizontally), to fit exact PAL timing (keeping one line out
of two to generate an interlaced signal).
Since the VT1622 does not have a frame buffer, it must receive at the
input a similar timing than the PAL output.

What I have with various sort of CRTC timing is a "out-of-range scan" on
the VGA monitor (thus black screen), and a totally disturbed "image" on
the TV (when it does not blank the screen the same way the monitor does).
I'm nearly giving-up... Any advice regarding CRTC registers, docs about
them, different variant of chips in the VIA Unichrome line, is welcome.

(I have an EPIA M10k with a CLE266 + VT1622)

(end of "little" note)

-- 
NH


From mark147m at gmail.com  Thu Aug 25 12:22:38 2005
From: mark147m at gmail.com (Mark Adams)
Date: Thu, 25 Aug 2005 11:22:38 +0100
Subject: [Softdevice-devel] Re: viafb kernel frame buffer vs. 720x576 tvout no-scale update...
In-Reply-To: <430D87C8.1010101@e-dition.fr>
References: <430D87C8.1010101@e-dition.fr>
Message-ID: <b7f6d73705082503227c876b6f@mail.gmail.com>

On 8/25/05, Nicolas Huillard <nhuillard at e-dition.fr> wrote:

> I finally got the kernel frame-buffer driver from viaarena to work with
> DirectFB. I can provide a patch against that viafb code to anyone
> (change accelerator ID to match DirectFB + yvirtres reporting).
> Drawback is that that viafb doesnt seem to handle virtual Y resolution
> correctly, thus no double-buffering can work.

I'm using the 'patcher2k' version of viafb (with some enhancements for
interlace) and can use double buffering or triple buffering in
DirectFB with no problems.

> On the tv-out 720x576 no-scale front, I'm stuck... I understood a lot
> about that VT1622 registers and their behaviour, but I still need advice
> about the CRTC registers.
> For what I know : I need to adjust CRTC (Unichrome chip) registers to
> generate a 720x576 or 800x600 timing at 50hz, 28.000Mhz dotclock,
> non-interlaced. Then the VT1622 will drive the Unichrome chip clock and
> convert the VGA signal into S-Video signals, merging pixels vertically
> (lines) or horizontally), to fit exact PAL timing (keeping one line out
> of two to generate an interlaced signal).
> Since the VT1622 does not have a frame buffer, it must receive at the
> input a similar timing than the PAL output.

I believe my setup has the CLE266 generating a 720x576/50 Hz
progressive picture with 27 MHz clock (28 will give you incorrect
horizontal scaling but shouldn't cause the problems you describe). 
The VT1622A (in my case) is then programmed with suitable PLL settings
to sync to this picture and generate the 625 line PAL picture. 
Scaling and filtering is turned off in the VT1622A.

I think you're probably right that the VT1622/1622A does not have a
frame buffer but it must have a buffer of a few lines in order to do
the filtering and scaling.

> What I have with various sort of CRTC timing is a "out-of-range scan" on
> the VGA monitor (thus black screen), and a totally disturbed "image" on
> the TV (when it does not blank the screen the same way the monitor does).

Many VGA monitors will not like the 50 Hz frame rate (and maybe not
the 31.25 kHz line rate either).  I've mainly been using flat panel
displays: some of them are happy, some are not.

You should get a nice picture on the TV screen though.  Is the TV
locked but the image disturbed (and possibly
scrolling/flickering/sheared/duplicated) or is it unlocked (if you're
ears are young enough, you'd hear a different tone from the TV than
when it was getting a good signal)?  If the latter, your configuration
of the TV chip must be incorrect for the picture that the CLE266 is
putting out such that the TV chip can't generate a valid signal.  If
the former, your problem is more likely to be in the CLE266 or the
input-side parameters of the VT1622.

> I'm nearly giving-up... Any advice regarding CRTC registers, docs about
> them, different variant of chips in the VIA Unichrome line, is welcome.

Try posting the output from the vt1622 utility from the unichrome
project when you type 'D' and I'll see if I can spot anything obvious.

Regards,

Mark


From nhuillard at e-dition.fr  Thu Aug 25 13:29:25 2005
From: nhuillard at e-dition.fr (Nicolas Huillard)
Date: Thu, 25 Aug 2005 13:29:25 +0200
Subject: [Softdevice-devel] Re: [directfb-users] Re: viafb kernel frame buffer vs. 720x576 tvout
 no-scale update...
In-Reply-To: <b7f6d73705082503227c876b6f@mail.gmail.com>
References: <430D87C8.1010101@e-dition.fr> <b7f6d73705082503227c876b6f@mail.gmail.com>
Message-ID: <430DAB95.9090203@e-dition.fr>

Thank you for your fast and helpful answer. See below.

Mark Adams a ?crit :
> On 8/25/05, Nicolas Huillard <nhuillard at e-dition.fr> wrote:
> 
>>I finally got the kernel frame-buffer driver from viaarena to work with
>>DirectFB. I can provide a patch against that viafb code to anyone
>>(change accelerator ID to match DirectFB + yvirtres reporting).
>>Drawback is that that viafb doesnt seem to handle virtual Y resolution
>>correctly, thus no double-buffering can work.
> 
> I'm using the 'patcher2k' version of viafb (with some enhancements for
> interlace) and can use double buffering or triple buffering in
> DirectFB with no problems.

This patch is simply a side-effect of my researches for perfect 720x576
(I first tried with this driver because it has 3 modes : overscan,
undersan and fit-to-screen, which should have been quite noscale, but in
fact isn't).
I tried tuning both the patcher2k and the viaarena drivers, WRT TV-out.
BTW, the correspondance between TV tables of both drivers are not so
difficult to understand.

>>On the tv-out 720x576 no-scale front, I'm stuck... I understood a lot
>>about that VT1622 registers and their behaviour, but I still need advice
>>about the CRTC registers.
>>For what I know : I need to adjust CRTC (Unichrome chip) registers to
>>generate a 720x576 or 800x600 timing at 50hz, 28.000Mhz dotclock,
>>non-interlaced. Then the VT1622 will drive the Unichrome chip clock and
>>convert the VGA signal into S-Video signals, merging pixels vertically
>>(lines) or horizontally), to fit exact PAL timing (keeping one line out
>>of two to generate an interlaced signal).
>>Since the VT1622 does not have a frame buffer, it must receive at the
>>input a similar timing than the PAL output.
> 
> I believe my setup has the CLE266 generating a 720x576/50 Hz
> progressive picture with 27 MHz clock (28 will give you incorrect
> horizontal scaling but shouldn't cause the problems you describe). 

I got the 28Mhz figure from the VT1622 spec sheet, found by Googling (I
can provide the PDF if needed).
You also sent me an fb.modes section stating 28Mhz. fbset -s currently
report the following (with the patcher2k driver) :

mode "720x576-50"
    # D: 28.000 MHz, H: 31.250 kHz, V: 50.000 Hz
    geometry 720 576 720 1152 32
    timings 35714 32 8 46 0 136 3
    rgba 8/16,8/8,8/0,8/24
endmode

> The VT1622A (in my case) is then programmed with suitable PLL settings
> to sync to this picture and generate the 625 line PAL picture. 
> Scaling and filtering is turned off in the VT1622A.
> 
> I think you're probably right that the VT1622/1622A does not have a
> frame buffer but it must have a buffer of a few lines in order to do
> the filtering and scaling.

That's my understanding.

>>What I have with various sort of CRTC timing is a "out-of-range scan" on
>>the VGA monitor (thus black screen), and a totally disturbed "image" on
>>the TV (when it does not blank the screen the same way the monitor does).
> 
> Many VGA monitors will not like the 50 Hz frame rate (and maybe not
> the 31.25 kHz line rate either).  I've mainly been using flat panel
> displays: some of them are happy, some are not.

The above timing currently show a stable image on the SOny monitor (but
width/height do not fit the screen and adjusting them is not possible
because even 0% or 100% adjustment is not enough -- depending on the
scale to be adjustement).
The CRTC timings modified by the vt1622 tool (either the original one
from the unichrome project, or your modified one) do not provide a
timing suitable for the monitor.

> You should get a nice picture on the TV screen though.  Is the TV
> locked but the image disturbed (and possibly
> scrolling/flickering/sheared/duplicated) or is it unlocked (if you're
> ears are young enough, you'd hear a different tone from the TV than
> when it was getting a good signal)?  If the latter, your configuration
> of the TV chip must be incorrect for the picture that the CLE266 is
> putting out such that the TV chip can't generate a valid signal.  If
> the former, your problem is more likely to be in the CLE266 or the
> input-side parameters of the VT1622.

Depending on the parameters set (I'll make new tests and report exact
values), I have either case. The worst is that the TV set also decides
to blank the screen depending on the type of errors in the signal.
Even with a disturbed image on screen, I don't know which register to
adjust to change the image the right way (many adjustments switch the TV
to blanking mode...)

>>I'm nearly giving-up... Any advice regarding CRTC registers, docs about
>>them, different variant of chips in the VIA Unichrome line, is welcome.
> 
> Try posting the output from the vt1622 utility from the unichrome
> project when you type 'D' and I'll see if I can spot anything obvious.

I'll do. Thanks.

> Regards,
> 
> Mark

-- 
NH


From mark147m at gmail.com  Thu Aug 25 14:46:09 2005
From: mark147m at gmail.com (Mark Adams)
Date: Thu, 25 Aug 2005 13:46:09 +0100
Subject: [Softdevice-devel] Re: [directfb-users] Re: viafb kernel frame buffer vs. 720x576 tvout no-scale update...
In-Reply-To: <430DAB95.9090203@e-dition.fr>
References: <430D87C8.1010101@e-dition.fr>
	 <b7f6d73705082503227c876b6f@mail.gmail.com>
	 <430DAB95.9090203@e-dition.fr>
Message-ID: <b7f6d7370508250546263254f5@mail.gmail.com>

> This patch is simply a side-effect of my researches for perfect 720x576
> (I first tried with this driver because it has 3 modes : overscan,
> undersan and fit-to-screen, which should have been quite noscale, but in
> fact isn't).

That got me interested too when I saw it but reading the documentation
it was clear that what they called 'fit-to-screen' was not what I
would have called 'fit-to-screen'!

> I got the 28Mhz figure from the VT1622 spec sheet, found by Googling (I
> can provide the PDF if needed).

I haven't seen that (have got it now though).  I'd found details of
the VT1621 but not the 1622.  Broadcast digital TV and DVDs are,
however, most definitely sampled at 27 MHz and it seems to me that a
28 MHz dot clock will give a horizontal squeeze to the picture (but
nothing worse).

> You also sent me an fb.modes section stating 28Mhz. fbset -s currently
> report the following (with the patcher2k driver) :

True but little of the information in fb.modes is used when TVout is
enabled: the timings all come from the TVout tables and are looked up
by the resolution (and the broadcast flag from fb.modes).

> > Try posting the output from the vt1622 utility from the unichrome
> > project when you type 'D' and I'll see if I can spot anything obvious.
> 
> I'll do. Thanks.

What you could also do is make yourself some kind of test card and
take a few pics of the result.  Something like a maximum sized diamond
would be good so you can see how much of the picture you're missing at
either side and top and bottom and whether there's any scaling going
on.

Regards,

Mark


From nhuillard at e-dition.fr  Thu Aug 25 15:15:47 2005
From: nhuillard at e-dition.fr (Nicolas Huillard)
Date: Thu, 25 Aug 2005 15:15:47 +0200
Subject: [Softdevice-devel] Re: [directfb-users] Re: viafb kernel frame buffer vs. 720x576 tvout
 no-scale update...
In-Reply-To: <b7f6d7370508250546263254f5@mail.gmail.com>
References: <430D87C8.1010101@e-dition.fr>	 <b7f6d73705082503227c876b6f@mail.gmail.com>	 <430DAB95.9090203@e-dition.fr> <b7f6d7370508250546263254f5@mail.gmail.com>
Message-ID: <430DC483.6060303@e-dition.fr>

Mark Adams a ?crit :
>>You also sent me an fb.modes section stating 28Mhz. fbset -s currently
>>report the following (with the patcher2k driver) :
> 
> True but little of the information in fb.modes is used when TVout is
> enabled: the timings all come from the TVout tables and are looked up
> by the resolution (and the broadcast flag from fb.modes).

bcast is not set in my fb.modes. I'll also check that.

>>>Try posting the output from the vt1622 utility from the unichrome
>>>project when you type 'D' and I'll see if I can spot anything obvious.
>>
>>I'll do. Thanks.
> 
> What you could also do is make yourself some kind of test card and
> take a few pics of the result.  Something like a maximum sized diamond
> would be good so you can see how much of the picture you're missing at
> either side and top and bottom and whether there's any scaling going
> on.

I use http://nicolas.huillard.net/vdr/tv_test/tig_all_res/720x576/
(thanks to Michael Reinelt)
The circle in main.png is good for that, but your diamond idea is better.

> Regards,
> 
> Mark

-- 
NH


From claas+maillinglists.softdevice at jucs-kramkiste.de  Thu Aug 25 16:32:01 2005
From: claas+maillinglists.softdevice at jucs-kramkiste.de (Claas Hilbrecht)
Date: Thu, 25 Aug 2005 16:32:01 +0200
Subject: [Softdevice-devel] xrun problems
In-Reply-To: <42FF8FAB.8060903@gmx.net>
References: <01DD10EE5785AB9A4335C4CC@[192.168.1.22]>
 <42F72D0F.8040302@gmx.net> <60F73C3E8E511499363F28E7@[192.168.1.22]>
 <42F77425.8050700@gmx.net> <9117607D75DD1BB013E81E19@[192.168.1.22]>
 <42FF8FAB.8060903@gmx.net>
Message-ID: <A89163DB6316FF5604CF2591@[192.168.1.22]>

--Am Sonntag, 14. August 2005 20:38 +0200 Martin Wache <M.Wache at gmx.net> 
schrieb:

> That's the wrong debug output, you've activated MPGDEB, not BUFDEB.
> Unfortunatly I can't see much from this log....

Sorry, it takes some time due to another problem. Here's the log.

BUF[1593]:PacketQueue.EnableGet.Sleep start pid: 25951
BUF[1599]:buffer fill
BUF[1599]:vout buffer fill: 0
BUF[1599]:aout buffer fill: 0
BUF[1599]:Decode a7472a0, Length 2048
BUF[1600]:Decode finished
BUF[1600]:Decode a747aa0, Length 736
BUF[1600]:Decode finished
BUF[1600]:Decode a747d80, Length 2048
BUF[1600]:Decode finished
BUF[1604]:PacketQueue.EnableGet.Sleep stop pid: 25951
BUF[1616]:while loop start StreamDecoder  pid:25951 type 1
BUF[1617]:PacketQueue.EnablePut.Signal pid: 25951
BUF[1617]:PacketQueue.EnableGet.Sleep start pid: 25951
BUF[1627]:PacketQueue.EnableGet.Sleep stop pid: 25951
BUF[1639]:while loop start StreamDecoder  pid:25951 type 1
BUF[1639]:PacketQueue.EnablePut.Signal pid: 25951
BUF[1639]:PacketQueue.EnableGet.Sleep start pid: 25951
BUF[1641]:read_packet EnableGet.Sleep end
BUF[1641]:read_packet: got 1888 bytes
BUF[1641]:read_packet Del 1888
BUF[1641]:read_packet Available()2944 < buf_size EnablePut.Signal
BUF[1641]:read_packet EnableGet.Sleep start
BUF[1650]:PacketQueue.EnableGet.Sleep stop pid: 25951
BUF[1662]:while loop start StreamDecoder  pid:25951 type 1
BUF[1662]:PacketQueue.EnablePut.Signal pid: 25951
BUF[1662]:PacketQueue.EnableGet.Sleep start pid: 25951
BUF[1673]:PacketQueue.EnableGet.Sleep stop pid: 25951
BUF[1685]:while loop start StreamDecoder  pid:25951 type 1
BUF[1685]:PacketQueue.EnablePut.Signal pid: 25951
BUF[1685]:PacketQueue.EnableGet.Sleep start pid: 25951
BUF[1693]:read_packet EnableGet.Sleep end
BUF[1693]:read_packet: got 2944 bytes
BUF[1693]:got packet from av_read_frame!
BUF[1693]:QueuePacket AudioIdx: 0 VideoIdx -1 pkt.stream_index: 0
BUF[1693]:QueuePacket audio stream
BUF[1693]:QueuePacket finished...
BUF[1693]:av_read_frame start
BUF[1693]:got packet from av_read_frame!
BUF[1693]:QueuePacket AudioIdx: 0 VideoIdx -1 pkt.stream_index: 0
BUF[1693]:QueuePacket audio stream
BUF[1694]:QueuePacket finished...
BUF[1694]:av_read_frame start
BUF[1694]:got packet from av_read_frame!
BUF[1694]:QueuePacket AudioIdx: 0 VideoIdx -1 pkt.stream_index: 0
BUF[1694]:QueuePacket audio stream
BUF[1694]:QueuePacket finished...
BUF[1694]:av_read_frame start
BUF[1694]:read_packet Del 2944
BUF[1694]:read_packet Available()0 < buf_size EnablePut.Signal
BUF[1694]:read_packet EnableGet.Sleep start
BUF[1696]:PacketQueue.EnableGet.Sleep stop pid: 25951
BUF[1696]:got packet PTS: -9223372036854775808 pid: 25951 type 1
BUF[1696]:start decode audio. pkt size: 2039
BUF[1697]:end decode audio
audio: xrun
BUF[1697]:start decode audio. pkt size: 1193
BUF[1698]:end decode audio
BUF[1698]:start decode audio. pkt size: 233


-- 
 Claas Hilbrecht
 http://www.jucs-kramkiste.de



From claas+maillinglists.softdevice at jucs-kramkiste.de  Thu Aug 25 16:34:54 2005
From: claas+maillinglists.softdevice at jucs-kramkiste.de (Claas Hilbrecht)
Date: Thu, 25 Aug 2005 16:34:54 +0200
Subject: [Softdevice-devel] buffer overflow caused by softdevice plugin
Message-ID: <7514712B83EF22337F52D847@[192.168.1.22]>

A few days ago I posted my xrun problem report to the list. After playing 
around I got another problem. If I use the softdevice plugin for some time 
sooner or later I get buffer overflows (see log below) as you can see in 
the log. If the buffer overflow occurs I can kill the VDR only with 
"killall -9". A normal kill won't work. Sometimes it takes only several 
minutes, sometime it takes several hours to trigger the problem. I don't 
know how to reproduce the problem by hand. Running the VDR without the 
softdevice plugin (I just remove -P softdevice from VDR) the VDR system 
runs the last four days without any problem. So I'm pretty sure the 
softdevice is the problem.

I'm running VDR 1.3.30 with 4 DVB-S budget cards. The softdevice plugin is 
called with "-P'softdevice -ao alsa:hw:0,0 -vo dummy:'". The VDR is running 
on a Pentium IV with 1.7 GHz and 256 MB Ram.

Aug 25 16:19:21 xxx vdr[25821]: closing SVDRP connection
Aug 25 16:20:47 xxx vdr[25947]: clearing device because of consecutive poll 
timeouts
Aug 25 16:21:22 xxx vdr[25948]: buffer usage: 70% (tid=425995)
Aug 25 16:21:27 xxx vdr[25948]: buffer usage: 80% (tid=425995)
Aug 25 16:21:32 xxx vdr[25948]: buffer usage: 90% (tid=425995)
Aug 25 16:21:37 xxx vdr[25948]: buffer usage: 100% (tid=425995)
Aug 25 16:21:37 xxx vdr[25948]: ERROR: 1 ring buffer overflow (177 bytes 
dropped)
Aug 25 16:21:43 xxx vdr[25948]: ERROR: 1329 ring buffer overflows (249852 
bytes dropped)
Aug 25 16:21:49 xxx vdr[25948]: ERROR: 1351 ring buffer overflows (253988 
bytes dropped)
Aug 25 16:21:55 xxx vdr[25948]: ERROR: 1355 ring buffer overflows (254740 
bytes dropped)

-- 
 Claas Hilbrecht
 http://www.jucs-kramkiste.de



From marko.makela at hut.fi  Thu Aug 25 19:13:43 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 25 Aug 2005 20:13:43 +0300
Subject: [Softdevice-devel] Remarks about cSoftDevice::SetPlayMode()
In-Reply-To: <430C9852.2000307@gmx.net>
References: <20050817211255.GA5205@localhost.localdomain> <43045AEC.8080307@gmx.net> <20050818192432.GD3271@localhost.localdomain> <4306321D.7030402@gmx.net> <20050823195644.GA251888@kosh.hut.fi> <430C9852.2000307@gmx.net>
Message-ID: <20050825171343.GF3135@localhost.localdomain>

On Wed, Aug 24, 2005 at 05:54:58PM +0200, Martin Wache wrote:
> Marko M?kel? schrieb:
> 
> > Playback will be suspended in both cases, but I believe that
> > the decoder should be reset when suspending (or resuming)
> > playback.  Now, at resume it'll take some time until the
> > decoder has re-synchronized on the stream.  Also, the screen
> > should be blanked immediately at suspend.  Are there some
> > methods for resetting the decoder and blanking the screen?
> > 
> I guess setting a Playmode resets the decoder, and the playMode
> AudioOnlyBlack should blank the screen?

I wonder where SetPlayMode() is normally called.

I figured out a solution for pausing/resuming recorded playback
when pressing the suspend key.  It is simple: the keypress is first
processed in vdr.c and then in menu.c.

I encountered the method cDvbDevice::TurnOffLiveMode().  I got the
impression that audio will always be decoded by the main processor, and
full-featured tuner cards will only decode video, similar to the dxr3
a.k.a. Hollywood+ card.  This method is called from
cDvbDevice::SetChannelDevice() and cDvbDevice::SetPlayMode().  It looks
like the high-level method is cDevice::SwitchChannel().  The LiveView
parameter is set to false in eitscan.c in cRecordControls::Start().
In other places, LiveView=true.

I'm afraid that setting LiveView=false would only be a partial solution:
it would probably stop the MPEG stream to the device and thus reduce
the CPU consumption of vdr, but the tuner would still be active.
Is there any way to release the tuner?  It'd save some power and reduce
heat (in case someone wants to use their vdr box as an always-on appliance,
e.g., file server, router, firewall, whatever).

I guess I'm better off asking these questions on the main vdr mailing
list.

	Marko


From M.Wache at gmx.net  Thu Aug 25 20:43:14 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 25 Aug 2005 20:43:14 +0200
Subject: [Softdevice-devel] Softdevice 0.1.2 and cvs compiling problems
In-Reply-To: <430D861C.50301@kolumbus.fi>
References: <430D861C.50301@kolumbus.fi>
Message-ID: <430E1142.8070805@gmx.net>

Kim Patovaara schrieb:

> g++ -fPIC -g -O2 -Wall -Woverloaded-virtual -c -DUSE_MMX
> -DPLUGIN_NAME_I18N='"softdevice"' -D_GNU_SOURCE
> -DPLUGINLIBDIR='"./PLUGINS/lib"' -DUSE_SUBPLUGINS -DDFB_SUPPORT
> -DXV_SUPPORT -DPP_LIBAVCODEC -I../../../include -I../DVB/include
> -I/usr/local/include/ffmpeg/ -I/usr/include/dfb++
> -I/usr/include/directfb utils.c
> utils.c: In function `void* fast_memcpy(void*, const void*, size_t)':
> utils.c:560: error: PIC register `%ebx' clobbered in `asm'
> make[1]: *** [utils.o] Error 1
> 
> Versions:
> gcc version 3.4.4 20050209 (prerelease) (Debian 3.4.3-9ubuntu4)
> (Same problem also gcc 3.3.5)
> Softdevice: CVS Aug 25 2005 or 0.1.2
> ffmpeg: CVS Aug 25
> 

I commented a part from fast_memcpy which doesn't give much speed
advantage, and made continously problems with compilers.
Please try the latest CVS version, it should work now.

Martin


From M.Wache at gmx.net  Thu Aug 25 21:28:50 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 25 Aug 2005 21:28:50 +0200
Subject: [Softdevice-devel] buffer overflow caused by softdevice plugin
In-Reply-To: <7514712B83EF22337F52D847@[192.168.1.22]>
References: <7514712B83EF22337F52D847@[192.168.1.22]>
Message-ID: <430E1BF2.2070307@gmx.net>

Claas Hilbrecht schrieb:
> A few days ago I posted my xrun problem report to the list. After
> playing around I got another problem. If I use the softdevice plugin for
> some time sooner or later I get buffer overflows (see log below) as you
> can see in the log. If the buffer overflow occurs I can kill the VDR
> only with "killall -9". A normal kill won't work. Sometimes it takes
> only several minutes, sometime it takes several hours to trigger the
> problem. I don't know how to reproduce the problem by hand. Running the
> VDR without the softdevice plugin (I just remove -P softdevice from VDR)
> the VDR system runs the last four days without any problem. So I'm
> pretty sure the softdevice is the problem.
> 
> I'm running VDR 1.3.30 with 4 DVB-S budget cards. The softdevice plugin
> is called with "-P'softdevice -ao alsa:hw:0,0 -vo dummy:'". The VDR is
> running on a Pentium IV with 1.7 GHz and 256 MB Ram.
> 
> Aug 25 16:19:21 xxx vdr[25821]: closing SVDRP connection
> Aug 25 16:20:47 xxx vdr[25947]: clearing device because of consecutive
> poll timeouts
> Aug 25 16:21:22 xxx vdr[25948]: buffer usage: 70% (tid=425995)
> Aug 25 16:21:27 xxx vdr[25948]: buffer usage: 80% (tid=425995)
> Aug 25 16:21:32 xxx vdr[25948]: buffer usage: 90% (tid=425995)
> Aug 25 16:21:37 xxx vdr[25948]: buffer usage: 100% (tid=425995)
> Aug 25 16:21:37 xxx vdr[25948]: ERROR: 1 ring buffer overflow (177 bytes
> dropped)
> Aug 25 16:21:43 xxx vdr[25948]: ERROR: 1329 ring buffer overflows
> (249852 bytes dropped)
> Aug 25 16:21:49 xxx vdr[25948]: ERROR: 1351 ring buffer overflows
> (253988 bytes dropped)
> Aug 25 16:21:55 xxx vdr[25948]: ERROR: 1355 ring buffer overflows
> (254740 bytes dropped)
> 

I guess the two problems you reported are related, there seems to be
something wrong with the buffering.
Usually the video buffer is more filled than the audio buffer, in your
case when only listening to radio that's different.

The debug output you send in the other mail was a bit short, and now
seeing this problem I would like to see what happens internally in the
softdevice during these hangs.
Can you please send me a zipped debug output of BUFDEB in a personal
e-mail, if possible when one of these buffer overflows happend and
containing about the last 1-2 minutes before the buffer overflow?

Do these problems also occur when replaying a recorded stream?

Bye,
Martin


From kim.patovaara at kolumbus.fi  Fri Aug 26 08:20:53 2005
From: kim.patovaara at kolumbus.fi (Kim Patovaara)
Date: Fri, 26 Aug 2005 09:20:53 +0300
Subject: [Softdevice-devel] Softdevice 0.1.2 and cvs compiling problems
In-Reply-To: <430E1142.8070805@gmx.net>
References: <430D861C.50301@kolumbus.fi> <430E1142.8070805@gmx.net>
Message-ID: <430EB4C5.3090701@kolumbus.fi>

Martin Wache wrote:

>
>I commented a part from fast_memcpy which doesn't give much speed
>advantage, and made continously problems with compilers.
>Please try the latest CVS version, it should work now.
>
>Martin
>_____________________________________________
>  
>
Hi,

Now it is working fine. Thanks for fix.

Regards,
Kim


From claas+maillinglists.softdevice at jucs-kramkiste.de  Fri Aug 26 08:34:10 2005
From: claas+maillinglists.softdevice at jucs-kramkiste.de (Claas Hilbrecht)
Date: Fri, 26 Aug 2005 08:34:10 +0200
Subject: [Softdevice-devel] buffer overflow caused by softdevice plugin
In-Reply-To: <430E1BF2.2070307@gmx.net>
References: <7514712B83EF22337F52D847@[192.168.1.22]>
 <430E1BF2.2070307@gmx.net>
Message-ID: <00A56D305E0E254048A12F11@[192.168.1.22]>

--Am Donnerstag, 25. August 2005 21:28 +0200 Martin Wache <M.Wache at gmx.net> 
schrieb:

> I guess the two problems you reported are related, there seems to be
> something wrong with the buffering.

Maybe due to the dummy video output?

> Can you please send me a zipped debug output of BUFDEB in a personal
> e-mail, if possible when one of these buffer overflows happend and
> containing about the last 1-2 minutes before the buffer overflow?

Will come in a few minutes. I need to restart VDR with the softdevice 
plugin and wait until the problem occurs.

> Do these problems also occur when replaying a recorded stream?

I've never tried this but I can try this.

-- 
 Claas Hilbrecht
 http://www.jucs-kramkiste.de



From claas+maillinglists.softdevice at jucs-kramkiste.de  Fri Aug 26 09:10:25 2005
From: claas+maillinglists.softdevice at jucs-kramkiste.de (Claas Hilbrecht)
Date: Fri, 26 Aug 2005 09:10:25 +0200
Subject: [Softdevice-devel] buffer overflow caused by softdevice plugin
In-Reply-To: <00A56D305E0E254048A12F11@[192.168.1.22]>
References: <7514712B83EF22337F52D847@[192.168.1.22]>
 <430E1BF2.2070307@gmx.net> <00A56D305E0E254048A12F11@[192.168.1.22]>
Message-ID: <EEFCEF79733C20D20EF86CAA@[192.168.1.22]>

--Am Freitag, 26. August 2005 08:34 +0200 Claas Hilbrecht 
<claas+maillinglists.softdevice at jucs-kramkiste.de> schrieb:

>> Do these problems also occur when replaying a recorded stream?
>
> I've never tried this but I can try this.

Since I didn't have any video output from my VDR I use telnet to control 
the VDR so far. But I seems that there is no SVDRP command to play a 
recording. Has anyone an idea how to replay a recording without using the 
menu?

-- 
 Claas Hilbrecht
 http://www.jucs-kramkiste.de



From marko.makela at hut.fi  Fri Aug 26 10:47:14 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 26 Aug 2005 11:47:14 +0300
Subject: [Softdevice-devel] buffer overflow caused by softdevice plugin
In-Reply-To: <EEFCEF79733C20D20EF86CAA@[192.168.1.22]>
References: <7514712B83EF22337F52D847@[192.168.1.22]> <430E1BF2.2070307@gmx.net> <00A56D305E0E254048A12F11@[192.168.1.22]> <EEFCEF79733C20D20EF86CAA@[192.168.1.22]>
Message-ID: <20050826084714.GA3090@localhost.localdomain>

On Fri, Aug 26, 2005 at 09:10:25AM +0200, Claas Hilbrecht wrote:
> the VDR so far. But I seems that there is no SVDRP command to play a 
> recording. Has anyone an idea how to replay a recording without using the 
> menu?

HITK Recordings
HITK OK
HITK OK
HITK OK

or something like that?

	Marko


From marko.makela at hut.fi  Fri Aug 26 18:06:28 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 26 Aug 2005 19:06:28 +0300
Subject: [Softdevice-devel] Suspend patch for vdr
In-Reply-To: <430C9852.2000307@gmx.net>
References: <20050817211255.GA5205@localhost.localdomain> <43045AEC.8080307@gmx.net> <20050818192432.GD3271@localhost.localdomain> <4306321D.7030402@gmx.net> <20050823195644.GA251888@kosh.hut.fi> <430C9852.2000307@gmx.net>
Message-ID: <20050826160628.GA245307@kosh.hut.fi>

On Wed, Aug 24, 2005 at 05:54:58PM +0200, Martin Wache wrote:
> But feel free to send a patch when you are ready, I will surely give it
> a try.

Here's my initial patch against vdr-1.3.30.  This patch also contains my fix
to the bug that the Power key is ignored during playback.  (With my patch,
the Power key will stop playback before asking any questions.  Admittedly,
it's not a very clean solution, but better than outright ignoring the
key.)

I also had to patch the subtitles plugin in order to prevent subtitles from
appearing during live playback.  It'd be better to stop the stream from
the tuner (in cDevice::Action()), but that would require some more logic,
i.e., some way to notify cDevice when instances of cRecorder are created or
destroyed, and perhaps also some extra logic to re-tune.  I believe that
a similar patch will be needed for the ttxtsubs (sp?) plugin.

To try out the patch, you will have to map some key to "Suspend" in
remote.conf, e.g., softdevice.Suspend in my case.  For instance,
temporarily rename some less frequently needed key, e.g.,
softdevice-dfb.Mute to softdevice-dfb.Suspend.

Next, I'm going to move my solid-state relay patch from softdevice to vdr.
I will keep these two patches independent, as I don't think the relay
control will ever make it to mainline vdr.

The timeout mechanism in softdevice seems to work nicely.  Also when
viewing recordings, video-dfb.c will blank the screen after a few
seconds of displaying paused picture.  (When the Pause key is pressed
instead of Suspend, the still picture will remain on the screen.)
I don't know if video-xv.c will turn off the monitor, but I hope you
can test that (and patch softdevice if necessary).

Please let me know if there are any problems.  If everything seems
fine, I'll post this to the main vdr mailing list.

	Marko
-------------- next part --------------
diff -pu vdr-1.3.30/device.c vdr-1.3.30/device.c
--- vdr-1.3.30/device.c	2005-08-21 11:56:49.000000000 +0300
+++ vdr-1.3.30/device.c	2005-08-25 20:32:50.000000000 +0300
@@ -147,6 +147,17 @@ int cDevice::nextCardIndex = 0;
 int cDevice::currentChannel = 1;
 cDevice *cDevice::device[MAXDEVICES] = { NULL };
 cDevice *cDevice::primaryDevice = NULL;
+#ifdef SUSPEND_PATCH
+// TODO: setupStore
+bool cDevice::isSuspended = false;
+void
+cDevice::ToggleSuspend(void)
+{
+  // TODO: setupStore (better: command line option in vdr.c:main())
+  // TODO: flip relay
+  isSuspended = !isSuspended;
+}
+#endif // SUSPEND_PATCH
 
 cDevice::cDevice(void)
 {
@@ -926,6 +937,10 @@ int cDevice::PlayAudio(const uchar *Data
 
 int cDevice::PlayPesPacket(const uchar *Data, int Length, bool VideoOnly)
 {
+#ifdef SUSPEND_PATCH
+  if (isSuspended)
+     return Length;
+#endif // SUSPEND_PATCH
   bool FirstLoop = true;
   uchar c = Data[3];
   const uchar *Start = Data;
diff -pu vdr-1.3.30/device.h vdr-1.3.30/device.h
--- vdr-1.3.30/device.h	2005-08-21 11:52:20.000000000 +0300
+++ vdr-1.3.30/device.h	2005-08-26 18:21:08.000000000 +0300
@@ -10,6 +10,10 @@
 #ifndef __DEVICE_H
 #define __DEVICE_H
 
+#ifndef SUSPEND_PATCH
+# define SUSPEND_PATCH
+#endif
+
 #include "ci.h"
 #include "eit.h"
 #include "filter.h"
@@ -139,6 +143,15 @@ public:
 private:
   static int nextCardIndex;
   int cardIndex;
+#ifdef SUSPEND_PATCH
+  static bool isSuspended;
+         ///< Flag: has audio/video playback been suspended?
+public:
+  static bool IsSuspended(void) { return isSuspended; }
+         ///< Determine if audio/video playback has been suspended
+  static void ToggleSuspend(void);
+         ///< Suspend or resume audio/video playback
+#endif // SUSPEND_PATCH
 protected:
   cDevice(void);
   virtual ~cDevice();
diff -pu vdr-1.3.30/keys.c vdr-1.3.30/keys.c
--- vdr-1.3.30/keys.c	2004-12-27 13:08:34.000000000 +0200
+++ vdr-1.3.30/keys.c	2005-08-23 21:24:55.000000000 +0300
@@ -39,6 +39,9 @@ static tKey keyTable[] = { // "Up" and "
                     { kFastFwd,       "FastFwd"    },
                     { kFastRew,       "FastRew"    },
                     { kPower,         "Power"      },
+#ifdef SUSPEND_PATCH
+                    { kSuspend,       "Suspend"    },
+#endif // SUSPEND_PATCH
                     { kChanUp,        "Channel+"   },
                     { kChanDn,        "Channel-"   },
                     { kVolUp,         "Volume+"    },
diff -pu vdr-1.3.30/keys.h vdr-1.3.30/keys.h
--- vdr-1.3.30/keys.h	2004-12-27 13:10:59.000000000 +0200
+++ vdr-1.3.30/keys.h	2005-08-23 21:25:16.000000000 +0300
@@ -33,6 +33,9 @@ enum eKeys { // "Up" and "Down" must be 
              kFastFwd,
              kFastRew,
              kPower,
+#ifdef SUSPEND_PATCH
+             kSuspend,
+#endif // SUSPEND_PATCH
              kChanUp,
              kChanDn,
              kVolUp,
diff -pu vdr-1.3.30/menu.c vdr-1.3.30/menu.c
--- vdr-1.3.30/menu.c	2005-08-14 18:14:29.000000000 +0300
+++ vdr-1.3.30/menu.c	2005-08-25 18:55:28.000000000 +0300
@@ -3538,8 +3538,16 @@ void cReplayControl::TimeSearchProcess(e
     case kUp:
     case kPause:
     case kDown:
+#ifdef SUSPEND_PATCH
+    case kSuspend:
+#endif // SUSPEND_PATCH
          Seconds = min(Total - STAY_SECONDS_OFF_END, Seconds);
+#ifdef SUSPEND_PATCH
+         Goto(Seconds * FRAMESPERSEC,
+              Key == kDown || Key == kPause || cDevice::IsSuspended());
+#else // SUSPEND_PATCH
          Goto(Seconds * FRAMESPERSEC, Key == kDown || Key == kPause);
+#endif // SUSPEND_PATCH
          timeSearchActive = false;
          break;
     default:
@@ -3695,6 +3703,9 @@ eOSState cReplayControl::ProcessKey(eKey
     case kUp:      Play(); break;
     case kPause:
     case kDown:    Pause(); break;
+#ifdef SUSPEND_PATCH
+    case kSuspend: if (cDevice::IsSuspended()) Pause(); else Play(); break;
+#endif // SUSPEND_PATCH
     case kFastRew|k_Release:
     case kLeft|k_Release:
                    if (Setup.MultiSpeedMode) break;
diff -pu vdr-1.3.30/transfer.c vdr-1.3.30/transfer.c
--- vdr-1.3.30/transfer.c	2005-08-14 13:55:03.000000000 +0300
+++ vdr-1.3.30/transfer.c	2005-08-26 17:49:32.000000000 +0300
@@ -41,6 +41,10 @@ void cTransfer::Activate(bool On)
 
 void cTransfer::Receive(uchar *Data, int Length)
 {
+#ifdef SUSPEND_PATCH
+  if (cDevice::IsSuspended())
+     return;
+#endif // SUSPEND_PATCH
   if (IsAttached() && Running()) {
      int p = ringBuffer->Put(Data, Length);
      if (p != Length && Running())
diff -pu vdr-1.3.30/vdr.c vdr-1.3.30/vdr.c
--- vdr-1.3.30/vdr.c	2005-08-21 11:47:06.000000000 +0300
+++ vdr-1.3.30/vdr.c	2005-08-26 16:30:41.000000000 +0300
@@ -779,12 +779,26 @@ int main(int argc, char *argv[])
                           break;
                           }
                        if (cRecordControls::Active()) {
-                          if (Interface->Confirm(tr("Recording - shut down anyway?")))
+                          if (Interface->Confirm(tr("Recording - shut down anyway?"))) {
                              ForceShutdown = true;
+                             cControl::Shutdown();
+                             }
                           }
+                       else
+                          cControl::Shutdown();
                        LastActivity = 1; // not 0, see below!
                        UserShutdown = true;
                        break;
+#ifdef SUSPEND_PATCH
+          // Suspend/resume:
+          case kSuspend:
+               cDevice::ToggleSuspend();
+               if (cDevice::IsSuspended()) {
+                  LastActivity = 0;
+                  cDevice::PrimaryDevice()->Clear();
+                  }
+               break;
+#endif // SUSPEND_PATCH
           default: break;
           }
         Interact = Menu ? Menu : cControl::Control(); // might have been closed in the mean time
-------------- next part --------------
--- receiver.c	2005-02-15 12:08:00.000000000 +0200
+++ receiver.c	2005-08-26 18:33:17.000000000 +0300
@@ -66,6 +66,10 @@
 
 void cSubtitlesReceiver::Receive(uchar *Data, int Length){
 
+#ifdef SUSPEND_PATCH
+  if (cDevice::IsSuspended())
+    return;
+#endif // SUSPEND_PATCH
   if (!active || Length < 188)
     return;
   int p = ringBuffer->Put( Data, Length );

From marko.makela at hut.fi  Sat Aug 27 00:31:32 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sat, 27 Aug 2005 01:31:32 +0300
Subject: [Softdevice-devel] Suspend patch for vdr
In-Reply-To: <20050826160628.GA245307@kosh.hut.fi>
References: <20050817211255.GA5205@localhost.localdomain> <43045AEC.8080307@gmx.net> <20050818192432.GD3271@localhost.localdomain> <4306321D.7030402@gmx.net> <20050823195644.GA251888@kosh.hut.fi> <430C9852.2000307@gmx.net> <20050826160628.GA245307@kosh.hut.fi>
Message-ID: <20050826223132.GA235005@kosh.hut.fi>

On Fri, Aug 26, 2005 at 07:06:28PM +0300, Marko M?kel? wrote:
> On Wed, Aug 24, 2005 at 05:54:58PM +0200, Martin Wache wrote:
> > But feel free to send a patch when you are ready, I will surely give it
> > a try.
> 
> Here's my initial patch against vdr-1.3.30.  This patch also contains my fix
> to the bug that the Power key is ignored during playback.

Please get the improved patch
http://www.funet.fi/~msmakela/electronics/relay/suspend-relay.patch
instead.  For clarity, I removed the Power key patch and ran diff
on vanilla vdr-1.3.30 sources (before applying any other patches).

The improved patch fixes a few things:

* In suspend mode, if you started playing a recording, it would keep
  reading data from the disk.  The improved patch will start playing
  recordings in Pause mode if playback is suspended.

* There is a commented-out assignment "LastActivity = 1" in the kSuspend
  handler of vdr.c.  If you enable it, the Suspend key will initiate a
  timeout mechanism (default 60+300 seconds after the key has been pressed,
  or 300 seconds after all timers have completed).  The timeout will be
  canceled if any other button is pressed.  In other words, you will be
  able to use the Suspend key as an intelligent power button.  Usage
  scenario: You're interrupted while watching a recording, and you hit
  Suspend.  If you get back in less than 6 minutes, you will be able to
  continue watching.  Otherwise, the system will power off and wait for
  the next nvram-wakeup event or power-on request by user.

I would appreciate prompt feedback, because I would like to announce
this patch on the vdr mailing list in a few days.

	Marko


From nhuillard at e-dition.fr  Sat Aug 27 19:39:16 2005
From: nhuillard at e-dition.fr (Nicolas Huillard)
Date: Sat, 27 Aug 2005 19:39:16 +0200
Subject: [Softdevice-devel] Re: [directfb-users] Re: viafb kernel frame buffer vs. 720x576 tvout
 no-scale update...
In-Reply-To: <b7f6d73705082503227c876b6f@mail.gmail.com>
References: <430D87C8.1010101@e-dition.fr> <b7f6d73705082503227c876b6f@mail.gmail.com>
Message-ID: <4310A544.5080104@e-dition.fr>

Mark Adams a ?crit :
> Try posting the output from the vt1622 utility from the unichrome
> project when you type 'D' and I'll see if I can spot anything obvious.

Please see attached a log file of some tests I just made.
Summary :
* dfbshow main.png on /dev/fb0
* fbset -i + directfbrc included
* monitor + TV connected (S-video, PAL)
* viafb patcher2k (patch 3), no mods, or patched tables
* vt1622 program, modified by me, or modified by Mark Adams
* before or after setting registers for 720x576 PAL

TIA

-- 
NH
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: notes_de_tests.txt
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050827/e0ef12ab/attachment.txt>

From marko.makela at hut.fi  Sat Aug 27 22:45:41 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sat, 27 Aug 2005 23:45:41 +0300
Subject: [Softdevice-devel] Suspend patch for vdr
In-Reply-To: <20050826223132.GA235005@kosh.hut.fi>
References: <20050817211255.GA5205@localhost.localdomain> <43045AEC.8080307@gmx.net> <20050818192432.GD3271@localhost.localdomain> <4306321D.7030402@gmx.net> <20050823195644.GA251888@kosh.hut.fi> <430C9852.2000307@gmx.net> <20050826160628.GA245307@kosh.hut.fi> <20050826223132.GA235005@kosh.hut.fi>
Message-ID: <20050827204541.GB3638@localhost.localdomain>

On Sat, Aug 27, 2005 at 01:31:32AM +0300, Marko M?kel? wrote:
> Please get the improved patch
> http://www.funet.fi/~msmakela/electronics/relay/suspend-relay.patch
> instead.  For clarity, I removed the Power key patch and ran diff
> on vanilla vdr-1.3.30 sources (before applying any other patches).

Please get
http://www.funet.fi/~msmakela/electronics/relay/vdr-suspend-relay.patch
instead.  That patch suspends the DVB streams at the source
(cDevice::Action() and cDvbPlayer::Action()).  Thus, no patch will be
necessary in the subtitles plugin.  Also, the play mode (play, pause,
rewind, fast forward, trickspeed, etc.) will be preserved across
suspend/resume.

> * There is a commented-out assignment "LastActivity = 1" in the kSuspend
>   handler of vdr.c.  If you enable it, the Suspend key will initiate a
>   timeout mechanism (default 60+300 seconds after the key has been pressed,
>   or 300 seconds after all timers have completed).

Sorry, it's 300 seconds in the first case.  Now this works also when
watching recordings.

> I would appreciate prompt feedback, because I would like to announce
> this patch on the vdr mailing list in a few days.

This still holds.  I got some feedback from a DXR3 user.  The DXR3 will
keep displaying the last image when playback is suspended.  I'm
currently just calling cDevice::PrimaryDevice()->Clear(), and that
won't do the trick.  (Also in softdevice, it is the "out of stream"
timeout that kicks in.)

	Marko


From M.Wache at gmx.net  Sun Aug 28 09:34:42 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 28 Aug 2005 09:34:42 +0200
Subject: [Softdevice-devel] Suspend patch for vdr
In-Reply-To: <20050827204541.GB3638@localhost.localdomain>
References: <20050817211255.GA5205@localhost.localdomain> <43045AEC.8080307@gmx.net> <20050818192432.GD3271@localhost.localdomain> <4306321D.7030402@gmx.net> <20050823195644.GA251888@kosh.hut.fi> <430C9852.2000307@gmx.net> <20050826160628.GA245307@kosh.hut.fi> <20050826223132.GA235005@kosh.hut.fi> <20050827204541.GB3638@localhost.localdomain>
Message-ID: <43116912.4090806@gmx.net>

Marko M?kel? schrieb:
> On Sat, Aug 27, 2005 at 01:31:32AM +0300, Marko M?kel? wrote:
> 
>>Please get the improved patch
>>http://www.funet.fi/~msmakela/electronics/relay/suspend-relay.patch
>>instead.  For clarity, I removed the Power key patch and ran diff
>>on vanilla vdr-1.3.30 sources (before applying any other patches).
> 
> 
> Please get
> http://www.funet.fi/~msmakela/electronics/relay/vdr-suspend-relay.patch
> instead.  That patch suspends the DVB streams at the source
> (cDevice::Action() and cDvbPlayer::Action()).  Thus, no patch will be
> necessary in the subtitles plugin.  Also, the play mode (play, pause,
> rewind, fast forward, trickspeed, etc.) will be preserved across
> suspend/resume.

I just tried to get the new version of your patch, but the link seems to
be broken :-(.
So I will report on the older one. I installed it yesterday evening and
it works great. Good work!

> 
> 
>>* There is a commented-out assignment "LastActivity = 1" in the kSuspend
>>  handler of vdr.c.  If you enable it, the Suspend key will initiate a
>>  timeout mechanism (default 60+300 seconds after the key has been pressed,
>>  or 300 seconds after all timers have completed).
> 
Actually this is the prefered mode for me. So my personal suggestion
would be just to use the power key, and extend it's features. If the
power key is pressed, shutdown in case of no recording and the -s option
was given, otherwise just suspend the mpeg2 decoding.
That would be the natural behaviour for me.


> This still holds.  I got some feedback from a DXR3 user.  The DXR3 will
> keep displaying the last image when playback is suspended.  I'm
> currently just calling cDevice::PrimaryDevice()->Clear(), and that
> won't do the trick.  (Also in softdevice, it is the "out of stream"
> timeout that kicks in.)
> 
cDevice->Clear() just clears the input buffers, so I guess it is not
meant to clear the screen. Maybe a call to SetPlayMode(pmNone) would
help, if I understand dvbplayer.c correctly that would work even for FF
cards. Of course you'll have to restore the playmode on resume...

Bye,
Martin


From marko.makela at hut.fi  Sun Aug 28 14:38:19 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sun, 28 Aug 2005 15:38:19 +0300
Subject: [Softdevice-devel] Suspend patch for vdr
In-Reply-To: <43116912.4090806@gmx.net>
References: <20050817211255.GA5205@localhost.localdomain> <43045AEC.8080307@gmx.net> <20050818192432.GD3271@localhost.localdomain> <4306321D.7030402@gmx.net> <20050823195644.GA251888@kosh.hut.fi> <430C9852.2000307@gmx.net> <20050826160628.GA245307@kosh.hut.fi> <20050826223132.GA235005@kosh.hut.fi> <20050827204541.GB3638@localhost.localdomain> <43116912.4090806@gmx.net>
Message-ID: <20050828123819.GA3084@localhost.localdomain>

On Sun, Aug 28, 2005 at 09:34:42AM +0200, Martin Wache wrote:
> > Please get
> > http://www.funet.fi/~msmakela/electronics/relay/vdr-suspend-relay.patch
> > instead.  That patch suspends the DVB streams at the source
> > (cDevice::Action() and cDvbPlayer::Action()).  Thus, no patch will be
> > necessary in the subtitles plugin.  Also, the play mode (play, pause,
> > rewind, fast forward, trickspeed, etc.) will be preserved across
> > suspend/resume.
> 
> I just tried to get the new version of your patch, but the link seems to
> be broken :-(.
> So I will report on the older one. I installed it yesterday evening and
> it works great. Good work!

Sorry, the correct link is
http://www.funet.fi/~msmakela/electronics/relay/vdr-suspend.patch
Please see also the discussion at
http://www.funet.fi/~msmakela/electronics/relay/

There are a few glitches in the old patch you tried.  The new one is
simpler.  I'm happy that even the old patch worked for you.

> Actually this is the prefered mode for me. So my personal suggestion
> would be just to use the power key, and extend it's features. If the
> power key is pressed, shutdown in case of no recording and the -s option
> was given, otherwise just suspend the mpeg2 decoding.
> That would be the natural behaviour for me.

Yes, I'll probably map my Power key to Suspend.  I don't think that the
behaviour of the Power key can be changed; I got some negative feedback
for my patch to obey the Power key during playback.  We can make this
happen by calling the key something else. :-)

There is one glitch though, maybe related to DirectFB or the cx88-input
driver: Repeated keypresses (with the RC5 toggle bit not toggling) are
reported as new ones.  So, I would have to be very very careful to press
the Suspend key exactly once.  If I keep it pressed down longer, vdr would
cycle between suspended/active, or worse still, suspended/confirm/active.
If no recording is going on, vdr will display the "Press any key to
cancel shutdown" message.  If vdr gets two keypresses from the Suspend
key, playback will remain suspended, but the shutdown timeout will be
cancelled without any visual feedback to the user.

> cDevice->Clear() just clears the input buffers, so I guess it is not
> meant to clear the screen. Maybe a call to SetPlayMode(pmNone) would
> help, if I understand dvbplayer.c correctly that would work even for FF
> cards. Of course you'll have to restore the playmode on resume...

Thanks, I'll try that.  Can SetPlayMode be called from any thread?

I noticed that it'd be better not to call cDevice::Clear() when playing
recordings, because then Suspend will better act as Pause (it won't
drop any B or P frames).

Can you or someone else help me to introduce a menu item for the suspend
timeout to the vdr setup/playback menu?  The timeout would be given in
seconds, and the value zero would disable the shutdown timeout.  Also
the logic in vdr.c needs to be changed a little.  It'd be better to
keep the inactivity timeout and the suspend shutdown timeout distinct
from each other.

	Marko


From marko.makela at hut.fi  Sun Aug 28 15:54:05 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sun, 28 Aug 2005 16:54:05 +0300
Subject: [Softdevice-devel] Suspend patch for vdr; DirectFB keyrepeat bug
In-Reply-To: <20050828123819.GA3084@localhost.localdomain>
References: <43045AEC.8080307@gmx.net> <20050818192432.GD3271@localhost.localdomain> <4306321D.7030402@gmx.net> <20050823195644.GA251888@kosh.hut.fi> <430C9852.2000307@gmx.net> <20050826160628.GA245307@kosh.hut.fi> <20050826223132.GA235005@kosh.hut.fi> <20050827204541.GB3638@localhost.localdomain> <43116912.4090806@gmx.net> <20050828123819.GA3084@localhost.localdomain>
Message-ID: <20050828135405.GA3604@localhost.localdomain>

On Sun, Aug 28, 2005 at 03:38:19PM +0300, Marko M?kel? wrote:
> There is one glitch though, maybe related to DirectFB or the cx88-input
> driver: Repeated keypresses (with the RC5 toggle bit not toggling) are
> reported as new ones.

This is a DirectFB bug.  In inputdrivers/linux_input.c, function
key_event() maps all nonzero struct input_event::value to a keypress
event, while according to evtest, value==0 is key release, 1 is
key press and 2 is key repeat.  I'll file a DirectFB bug report,
and I'll have a look if I can prepare a patch to DirectFB, DirectFB++
and video-dfb.c.

	Marko


From marko.makela at hut.fi  Sun Aug 28 23:02:45 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 29 Aug 2005 00:02:45 +0300
Subject: [Softdevice-devel] Suspend patch for vdr; DirectFB keyrepeat bug
In-Reply-To: <20050828135405.GA3604@localhost.localdomain>
References: <20050818192432.GD3271@localhost.localdomain> <4306321D.7030402@gmx.net> <20050823195644.GA251888@kosh.hut.fi> <430C9852.2000307@gmx.net> <20050826160628.GA245307@kosh.hut.fi> <20050826223132.GA235005@kosh.hut.fi> <20050827204541.GB3638@localhost.localdomain> <43116912.4090806@gmx.net> <20050828123819.GA3084@localhost.localdomain> <20050828135405.GA3604@localhost.localdomain>
Message-ID: <20050828210245.GA4047@localhost.localdomain>

On Sun, Aug 28, 2005 at 04:54:05PM +0300, Marko M?kel? wrote:
> On Sun, Aug 28, 2005 at 03:38:19PM +0300, Marko M?kel? wrote:
> > There is one glitch though, maybe related to DirectFB or the cx88-input
> > driver: Repeated keypresses (with the RC5 toggle bit not toggling) are
> > reported as new ones.
> 
> This is a DirectFB bug.  In inputdrivers/linux_input.c, function
> key_event() maps all nonzero struct input_event::value to a keypress
> event, while according to evtest, value==0 is key release, 1 is
> key press and 2 is key repeat.  I'll file a DirectFB bug report,
> and I'll have a look if I can prepare a patch to DirectFB, DirectFB++
> and video-dfb.c.

I had to patch vdr a little as well to get it to work flawlessly.  See
http://www.funet.fi/~msmakela/software/vdr/index.en.html#dfb-repeat
for the patches and discussion.

	Marko


From marko.makela at hut.fi  Tue Aug 30 00:01:20 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 30 Aug 2005 01:01:20 +0300
Subject: [Softdevice-devel] Suspend patch for vdr
In-Reply-To: <43116912.4090806@gmx.net>
References: <20050817211255.GA5205@localhost.localdomain> <43045AEC.8080307@gmx.net> <20050818192432.GD3271@localhost.localdomain> <4306321D.7030402@gmx.net> <20050823195644.GA251888@kosh.hut.fi> <430C9852.2000307@gmx.net> <20050826160628.GA245307@kosh.hut.fi> <20050826223132.GA235005@kosh.hut.fi> <20050827204541.GB3638@localhost.localdomain> <43116912.4090806@gmx.net>
Message-ID: <20050829220120.GB3341@localhost.localdomain>

On Sun, Aug 28, 2005 at 09:34:42AM +0200, Martin Wache wrote:
> >>* There is a commented-out assignment "LastActivity = 1" in the kSuspend
> >>  handler of vdr.c.  If you enable it, the Suspend key will initiate a
> >>  timeout mechanism (default 60+300 seconds after the key has been pressed,
> >>  or 300 seconds after all timers have completed).
> > 
> Actually this is the prefered mode for me. So my personal suggestion
> would be just to use the power key, and extend it's features. If the
> power key is pressed, shutdown in case of no recording and the -s option
> was given, otherwise just suspend the mpeg2 decoding.
> That would be the natural behaviour for me.

I made another patch tonight:

http://www.funet.fi/~msmakela/software/vdr/vdr-1.3.30-suspend-0.1.patch

See also http://www.funet.fi/~msmakela/software/vdr/ for related patches.

In the new vdr-suspend patch, suspend-to-shutdown can be enabled by
setting a timeout in the Setup/Replay menu.  I would appreciate new
or improved translations for that menu item, in i18n.c.

Another thing I improved is that cDevice::Clear() will only be invoked when
viewing live stream.  Thus, the Suspend key can pause a recording without
dropping any frames.

> cDevice->Clear() just clears the input buffers, so I guess it is not
> meant to clear the screen. Maybe a call to SetPlayMode(pmNone) would
> help, if I understand dvbplayer.c correctly that would work even for FF
> cards. Of course you'll have to restore the playmode on resume...

I didn't try this out yet, because I'm afraid it would cause race
conditions.  I'd have to study the thread architecture of vdr a bit deeper.
The current solution works for softdevice users, as the built-in timeout
in softdevice will clear the screen, and for those whose monitor's power
switch is controlled by vdr (http://www.funet.fi/~msmakela/electronics/relay/).

	Marko


From leo at calidae.net  Wed Aug 31 08:28:13 2005
From: leo at calidae.net (=?ISO-8859-1?Q?Leo_M=E1rquez?=)
Date: Wed, 31 Aug 2005 08:28:13 +0200
Subject: [Softdevice-devel] definitive configuration
Message-ID: <43154DFD.1040502@calidae.net>

Hi!,

Few months ago I asked to the list about to set up a VDR in a epia 
m10000 board using the s-video out connector.
Actually I'm using the video out of a ff card but I have problems with 
mplayer scaling. I want to try the softdevice plugin but I don't want 
have to compile components continually, I want see the TV. I have 
installed in my debian: dfb, softdevice and the viafb (from viaarena). I 
can't get it work (see the topic in the list 'libavcodec does not match 
avcodec.h').
But my question is:

Could you say me the actual software and versions you recommend me to 
set up the system and enjoy, with the minimum maintance? I want use vdr 
to see and record tv, see dvd, divx, play mp3.
My tv is a standard 16/9 (no lcd). Can I have problems with the tv out? 
For example with dvb output and mplayer divx movies are not centered and 
I lose some screen. With some movies I lose near 50%.
There are debian packages to do this? I like compile vdr myself and 
plugins but is more confortable use apt.
But I dont' know if with debian packages I can install the bitstreamout 
plugin for example.

Thank you.



From nhuillard at e-dition.fr  Wed Aug 31 11:05:23 2005
From: nhuillard at e-dition.fr (Nicolas Huillard)
Date: Wed, 31 Aug 2005 11:05:23 +0200
Subject: [Softdevice-devel] definitive configuration
In-Reply-To: <43154DFD.1040502@calidae.net>
References: <43154DFD.1040502@calidae.net>
Message-ID: <431572D3.1@e-dition.fr>

Leo M?rquez a ?crit :
> Hi!,
> 
> Few months ago I asked to the list about to set up a VDR in a epia
> m10000 board using the s-video out connector.

That's a thread for me !

> Actually I'm using the video out of a ff card but I have problems with
> mplayer scaling. I want to try the softdevice plugin but I don't want
> have to compile components continually, I want see the TV. I have
> installed in my debian: dfb, softdevice and the viafb (from viaarena). I
> can't get it work (see the topic in the list 'libavcodec does not match
> avcodec.h').

I just finished tuning the tv-out tables of the VT1622 present on the
EPIA M10k board (see thread "viafb kernel frame buffer vs. 720x576 tvout
no-scale update..." on the directfb-users ML).
See attached patch. This is a patch against the patcher2k version of the
viafb kernel frame-buffer driver. Download it on
http://patcher2k.012webpages.com/, then apply my patch to have correct
TV-out.
You should also use the following /etc/fb.modes :
-----------------
mode "720x576-50"
    geometry 720 576 720 576 16
    timings 35714 32 8 46 0 136 3
endmode
-----------------
Once you have this, you can go with vdr + softdevice et al.

> But my question is:
> 
> Could you say me the actual software and versions you recommend me to
> set up the system and enjoy, with the minimum maintance? I want use vdr
> to see and record tv, see dvd, divx, play mp3.
> My tv is a standard 16/9 (no lcd). Can I have problems with the tv out?
> For example with dvb output and mplayer divx movies are not centered and
> I lose some screen. With some movies I lose near 50%.
> There are debian packages to do this? I like compile vdr myself and
> plugins but is more confortable use apt.
> But I dont' know if with debian packages I can install the bitstreamout
> plugin for example.

I'd recommend e-tobi's repository, which is the feed for the official
Debian repository. There is the nearly latest VDR there, softdevice, and
many other plugins and add-ons.
See http://www.e-tobi.net/
I am going to upgrade to the vdr-experimental flavour (latest VDR and
plugins) precompiled on the sarge base.
If you don't need patches not present on this repository, you could go
without recompiling.

> Thank you.
> 
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/softdevice-devel

-- 
NH
-------------- next part --------------
A non-text attachment was scrubbed...
Name: via_tv3-720x576noscale.diff
Type: text/x-patch
Size: 4634 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050831/7f99e5ee/attachment.bin>

From leo at calidae.net  Wed Aug 31 13:57:35 2005
From: leo at calidae.net (=?ISO-8859-1?Q?Leo_M=E1rquez?=)
Date: Wed, 31 Aug 2005 13:57:35 +0200
Subject: [Softdevice-devel] definitive configuration
In-Reply-To: <431572D3.1@e-dition.fr>
References: <43154DFD.1040502@calidae.net> <431572D3.1@e-dition.fr>
Message-ID: <43159B2F.4080803@calidae.net>

Thank you for your answer Nicolas

>>Actually I'm using the video out of a ff card but I have problems with
>>mplayer scaling. I want to try the softdevice plugin but I don't want
>>have to compile components continually, I want see the TV. I have
>>installed in my debian: dfb, softdevice and the viafb (from viaarena). I
>>can't get it work (see the topic in the list 'libavcodec does not match
>>avcodec.h').
>>    
>>
>
>I just finished tuning the tv-out tables of the VT1622 present on the
>EPIA M10k board (see thread "viafb kernel frame buffer vs. 720x576 tvout
>no-scale update..." on the directfb-users ML).
>See attached patch. This is a patch against the patcher2k version of the
>viafb kernel frame-buffer driver. Download it on
>http://patcher2k.012webpages.com/, then apply my patch to have correct
>TV-out.
>You should also use the following /etc/fb.modes :
>-----------------
>mode "720x576-50"
>    geometry 720 576 720 576 16
>    timings 35714 32 8 46 0 136 3
>endmode
>-----------------
>  
>
This mode is especific for a 16/9 tv? If I use a 4/6 tv have to change it?

>
>I'd recommend e-tobi's repository, which is the feed for the official
>Debian repository. There is the nearly latest VDR there, softdevice, and
>many other plugins and add-ons.
>See http://www.e-tobi.net/
>  
>
I don't understand german :-(
What are the apt sources?

thanks you again

Leo


From marko.makela at hut.fi  Wed Aug 31 15:13:33 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 31 Aug 2005 16:13:33 +0300
Subject: [Softdevice-devel] definitive configuration
In-Reply-To: <43159B2F.4080803@calidae.net>
References: <43154DFD.1040502@calidae.net> <431572D3.1@e-dition.fr> <43159B2F.4080803@calidae.net>
Message-ID: <20050831131333.GB3149@localhost.localdomain>

On Wed, Aug 31, 2005 at 01:57:35PM +0200, Leo M?rquez wrote:
> I don't understand german :-(
> What are the apt sources?

At http://www.e-tobi.net/blog/, see the Section "Der sources.list-Eintrag".

For the record, I'm using Debian unstable, but compiled ffmpeg, DirectFB,
vdr, vdr-softdevice, and vdr-subtitles from source.

	Marko


From nhuillard at e-dition.fr  Wed Aug 31 15:09:37 2005
From: nhuillard at e-dition.fr (Nicolas Huillard)
Date: Wed, 31 Aug 2005 15:09:37 +0200
Subject: [Softdevice-devel] definitive configuration
In-Reply-To: <43159B2F.4080803@calidae.net>
References: <43154DFD.1040502@calidae.net> <431572D3.1@e-dition.fr> <43159B2F.4080803@calidae.net>
Message-ID: <4315AC11.7030703@e-dition.fr>

Leo M?rquez a ?crit :
> Thank you for your answer Nicolas
> 
>>> Actually I'm using the video out of a ff card but I have problems with
>>> mplayer scaling. I want to try the softdevice plugin but I don't want
>>> have to compile components continually, I want see the TV. I have
>>> installed in my debian: dfb, softdevice and the viafb (from viaarena). I
>>> can't get it work (see the topic in the list 'libavcodec does not match
>>> avcodec.h').
>>
>> I just finished tuning the tv-out tables of the VT1622 present on the
>> EPIA M10k board (see thread "viafb kernel frame buffer vs. 720x576 tvout
>> no-scale update..." on the directfb-users ML).
>> See attached patch. This is a patch against the patcher2k version of the
>> viafb kernel frame-buffer driver. Download it on
>> http://patcher2k.012webpages.com/, then apply my patch to have correct
>> TV-out.
>> You should also use the following /etc/fb.modes :
>> -----------------
>> mode "720x576-50"
>>    geometry 720 576 720 576 16
>>    timings 35714 32 8 46 0 136 3
>> endmode
>> -----------------
>>
> This mode is especific for a 16/9 tv? If I use a 4/6 tv have to change it?

This is the standard DVD/digital TV format. It fits either 4/3 or 16/9
TV's. The image is just wider on a 16/9 TV (rectangular pixels).
softdevice has all the scaling stuff to get proper square aspect on any
TV, with any resolution.
Just a little bug above (I didn't copy it from the actual updated file).
Read :
	geometry 720 576 720 1152 32
(1152 virtual height, to get double buffering for the OSD, and 32bpp)

>> I'd recommend e-tobi's repository, which is the feed for the official
>> Debian repository. There is the nearly latest VDR there, softdevice, and
>> many other plugins and add-ons.
>> See http://www.e-tobi.net/
>>  
> I don't understand german :-(

Neither do I...

> What are the apt sources?

wget -O - http://www.e-tobi.net/blog/ | grep -v 'german wording'

This result in something like this :

#
# Tobi's Experimental VDR Repository
#
deb http://e-tobi.net/vdr-experimental sarge base backports addons vdr
deb-src http://e-tobi.net/vdr-experimental sarge base backports addons vdr

-- 
NH


From stefan at lucke.in-berlin.de  Sun Sep  4 08:53:11 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 4 Sep 2005 08:53:11 +0200
Subject: [Softdevice-devel] [ANNOUNCE] vdr-softdevice-0.1.3
Message-ID: <200509040853.11131.stefan@lucke.in-berlin.de>

Hello,

softdevice team (Torgeir Veimo, Martin Wache and me, Stefan Lucke)
is pleased to announce a new release of vdr softdevice plugin.

Softdevice plugin enables vdr to run on your desktop with
so called budget cards. You'll get vdr output via framebuffer or X11-Xv or
DirectFB or vidix to your screen. Decoding is done via ffmpeg.

For compile options, please read the Makefile carefully and decide which of
the available output methods fit to your system.

Plugin's homepage is located at: http://softdevice.berlios.de/

Changelog since last release:
2005-09-04: softdevice-0.1.3
    - dfb-out: applied dfb-key-repeat handling patch (by Marko M?kel?)
2005-08-19:
    - change #ifdefs to contain closing brackets
        (stops my editor from complaining...)
    - fix possible segfault in ToYUV()
2005-08-17:
    - audio-out: changed retrieval of audio delay with newer alsa versions on
                 "default" device. should fix bug #2971 too.
2005-08-08:
    - dfb-out: enclose all dfb calls by try{}catch{} by Marko M?kel?
2005-07-31:
    - remove Deactivate(), instead deactive at start of Stop()
    - stop playback in Clear() while clearing the packet buffer
    - introduce SOFTDEB, more checks agains NULL dereferences
    - call decoder->Clear in Clear
    - return NULL in getPPValue when compiled without postproc lib
      (suggested by Antonio)
2005-07-29:
    - some small changes on finnish translations by Rolf Ahrenberg
    - fix for segfaults in setup-softdevice.c by previous change
2005-07-27:
    - compile fix for newer ffmpeg versions (> 2005-07-17 22:24:35) by Antonio
    - fix for video-dfb.c change from 2005-07-16 by Rolf Ahrenberg
    - more OSD entries translateable by Rolf Ahrenberg
    - more finnish translations by Rolf Ahrenberg
    - limit cropping amount to 50 each
2005-07-24:
    - finnish translations by Rolf Ahrenberg
2005-07-23:
    - vidix-out:
      - some cosmetic cleanups
      - force OSD mode pseudo when YUY2 pixelformat is choosen
2005-07-22:
    - changed pause OSD handling in software drawing mode
    - work around for some *.avi files where frametime is zero
    - fix previously introduced compile fail without -DUSE_SUBPLUGINS
    - include patch from Claas Hilbrecht for "-vo dummy:"
    - some code reorg for subpluging loader
2005-07-20:
    - fix for live view at trick speed
    - stretchBlit mode for dfb-out is selectable via OSD
    - cropLeft/Right for xv-out and dfb-out
    - exclude cropTop/Bottom OSD from fb-out
    - adjusted vidix-out call of yv12_to_yuy2() to dfb-out
2005-07-17:
    - crop Top/Bottom for xv-out
    - introduce colour space conversion (by Malcom Caldwell)
    - make filters work with YUV422 color space
2005-07-16:
    - fix for cropBottom in dfb with YUY2 pixelformat
    - some preparations for configure in video-dfb.c
    - some preparations for configure in utils.c
2005-07-15:
    - by Vadim Catana:
      - fixed a couple of compiler warnings for gcc4 on x86-64
      - the video-vidix.c and video-dfb.c both contain code
        that converts pictures from YV12 format to YUY2. I moved
        this common code to a function in utils.c .
      - Some channels display white dots at the top and bottom of
        the screen due to WSS data encoded in the picture.
        This problem has been mentioned on vdr, linux-dvb and
        dxr3 mailinglists a few times. I added two new items in
        the softdevice menu that allow to cut off a number of lines
        from top and bottom of the picture. It is implemented now
        only for -vo vidix and dfb with i420/YV12 format and hardware
        alpha blending.
    - by Malcolm Caldwell: fix for vdr segfaulting
2005-07-03:
    - fix fullscreen mode for 64-bit architectures
    - improve response time for 60-sec skips
2005-06-30:
    - changed delay clamping low limit and printout "+" if we drop frames
    - dfb: report current frame duration
    - dfb: activated device specific delay handling
2005-06-28:
    - fix for loosing window dimensions upon switching from fullscreen mode to windowed mode
2005-06-26:
    - fix compile issue with recent gcc versions (patch by alexw)
2005-06-18:
    - provide error message on stderr when Xv plugin cannot connect to X server.
2005-06-12:
    - no new audio frame has been decoded when audio_size <= 0 
       (reported by Antonio O.)
    - introduce fast_memcpy (gives 20-30% speed increase on copying)
    - switch xv-out to fast_memcpy
    - enable fast and default deblock postprocessing
    - make buffersizes choosable
2005-06-06:
    - fixed latest ffmpeg cvs compile issue
    - applied fix for noisy audio on some soundcards (by Antonio O.)
    - applied GetDeviceDescription() patch for video-dfb.c (by Lucian Muresan)
2005-06-05:
    - compile by default with "-g"
    - fix vidix segfault
2005-05-29:
    - changed screen aspect ratio selection (based on suggestion by Nicolas Huillard)
    - fix some segfaults on bad signal
    - fix possible segfault when called without arguments 
      (thanks to Marko M?kel?)
    - buffering is now complety signal triggered
    - made buffersizes variable

-- 
Stefan Lucke



From marko.makela at hut.fi  Sun Sep  4 21:03:22 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sun, 4 Sep 2005 22:03:22 +0300
Subject: [Softdevice-devel] key-repeat fixes; Re: [vdr] [ANNOUNCE] vdr-softdevice-0.1.3
In-Reply-To: <200509040853.11131.stefan@lucke.in-berlin.de>
References: <200509040853.11131.stefan@lucke.in-berlin.de>
Message-ID: <20050904190322.GA3134@localhost.localdomain>

On Sun, Sep 04, 2005 at 08:53:11AM +0200, Stefan Lucke wrote:
> 2005-09-04: softdevice-0.1.3
>     - dfb-out: applied dfb-key-repeat handling patch (by Marko M?kel?)

Thank you very much, Stefan!

Are you participating in the development of DirectFB?  I would love to
see the corresponding patch in DirectFB 0.9.23.  I just updated the
DirectFB bug report #24 (http://directfb.org/mantis/view.php?id=24)
to mention the softdevice 0.1.3 release.

On a related note, I noticed a bug in cx88-input.c in video4linux.  If
the driver misses an RC5 frame from the remote control while a key is
being pressed down, it will send a key-release event followed by a key-press
event and further key-repeat events.  This is not nice if you have
a bad infrared connection and are trying to press a key exactly once.
My patch tries to address this, but it is not a perfect solution yet.
I'm trying to get this fixed in cooperation with the video4linux developers.

All my VDR-related patches are available at
<http://www.funet.fi/~msmakela/software/vdr/>.

	Marko


From marko.makela at hut.fi  Sun Sep  4 21:09:51 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sun, 4 Sep 2005 22:09:51 +0300
Subject: [Softdevice-devel] On my vdr suspend patch
Message-ID: <20050904190951.GB3134@localhost.localdomain>

I have used my patch for suspending vdr playback
<http://www.funet.fi/~msmakela/software/vdr/#suspend>
for over a week now, without any problems.

Users of nvram-wakeup may find the configurable suspend-to-shutdown
feature useful.  Those whose boxes run 24?7 may just appreciate the
reduced power consumption and heat production.

If anyone finds the patch useful, I would appreciate some supporting
replies on the vdr mailing list to get the patch applied to mainline vdr.
I understand that users of MPEG decoder cards do not care much about
suspending playback, as it would not benefit anything (perhaps apart from
saving a few watts worth of electricity, and avoiding firmware hangs when
recording a bad input signal).

	Marko


From marko.makela at hut.fi  Sun Sep  4 21:20:00 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sun, 4 Sep 2005 22:20:00 +0300
Subject: [Softdevice-devel] Crashes or bugs when rewinding over an aspect ratio change
Message-ID: <20050904192000.GC3134@localhost.localdomain>

Sometimes, rewinding a recording so that the aspect ratio will switch
from 16:9 to 4:3 (i.e., the recording contains a 4:3->16:9 transition)
does not work properly.  I have noticed two kinds of buggy behaviour
on DirectFB output:

(1) The 4:3 picture will be displayed at the pixel aspect ratio of the
16:9 picture.  The right-hand part of the screen remains uninitialized;
e.g., it will keep flipping between the two last 16:9 fields that were
displayed previously.

(2) vdr crashes.

Are others seeing these?  I'm happy to provide test recordings to make
this repeatable.  I've got multiple crashes in the past few days, and
I'd hate to learn to avoid rewinding recordings when a timed recording
is active.

	Marko


From torgeir at pobox.com  Sun Sep  4 21:38:07 2005
From: torgeir at pobox.com (Torgeir Veimo)
Date: Sun, 04 Sep 2005 20:38:07 +0100
Subject: [Softdevice-devel] [ANNOUNCE] vdr-softdevice-0.1.3
In-Reply-To: <200509040853.11131.stefan@lucke.in-berlin.de>
References: <200509040853.11131.stefan@lucke.in-berlin.de>
Message-ID: <1125862687.3080.66.camel@africa.netenviron.com>

On Sun, 2005-09-04 at 08:53 +0200, Stefan Lucke wrote:

> softdevice team (Torgeir Veimo, Martin Wache and me, Stefan Lucke)
> is pleased to announce a new release of vdr softdevice plugin.

Ho hum, am flattered, but I think my last cvs commit longer than two
lines was a long time ago.. :) 

-- 
Torgeir Veimo <torgeir at pobox.com>



From stefan at lucke.in-berlin.de  Sun Sep  4 23:00:39 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 4 Sep 2005 23:00:39 +0200
Subject: [Softdevice-devel] Crashes or bugs when rewinding over an aspect ratio change
In-Reply-To: <20050904192000.GC3134@localhost.localdomain>
References: <20050904192000.GC3134@localhost.localdomain>
Message-ID: <200509042300.39822.stefan@lucke.in-berlin.de>

On Sonntag, 4. September 2005 21:20, Marko M?kel? wrote:
> Sometimes, rewinding a recording so that the aspect ratio will switch
> from 16:9 to 4:3 (i.e., the recording contains a 4:3->16:9 transition)
> does not work properly.  I have noticed two kinds of buggy behaviour
> on DirectFB output:
> 
> (1) The 4:3 picture will be displayed at the pixel aspect ratio of the
> 16:9 picture.  The right-hand part of the screen remains uninitialized;
> e.g., it will keep flipping between the two last 16:9 fields that were
> displayed previously.

Maybe that happens here too upon A/R switches. But most of my recordings
are cut, so the A/R switch is only a GOP from start/end. Thats what I've
seen sometimes on toggeling screen A/R selection at key repeat rate,
was perhaps similar: 
- a portion of the screen from the previous A/R remains active: 
	- left/right when final A/R is 4:3, left/right flipping at half
	  frame rate on 16:9 screen.
	- top/bottom kept flipping with half frame rate when final
	  A/R is 16:9 on a 4:3 screen.
  but both symptoms dissappeared when OSD went off.

> 
> (2) vdr crashes.

That's the one I've not yet seen.

> 
> Are others seeing these?  I'm happy to provide test recordings to make
> this repeatable.  

So I'd like to ask for a short (but long enough) link to dig into.

> I've got multiple crashes in the past few days, and
> I'd hate to learn to avoid rewinding recordings when a timed recording
> is active.

That's bad usability :-( . 
OT: Like my dxr3 prod view system which is a playback only one.
    Don't touch FF from pause mode.

-- 
Stefan Lucke



From lucianm at users.sourceforge.net  Mon Sep  5 00:39:29 2005
From: lucianm at users.sourceforge.net (Lucian Muresan)
Date: Mon, 05 Sep 2005 00:39:29 +0200
Subject: [Softdevice-devel] vdr-softdevice-0.1.3 DFB Matrox G400 TVout, judder again
Message-ID: <431B77A1.6020902@users.sourceforge.net>

Hi folks,

thanks for the new softdevice version! Unfortunately I'm getting judder
again (field parity? buffering?) on my TV-out. My configuration is:
DirectFB-0.9.23, Matrox G400 DH (deinterlacing turned off, pixel format
is YUY2 with stretchblit activated. Anyone else having this issues? Do
any relevant code changes in this area since version 0.1.2 come to mind?

Lucian

P.S. I don't know if you addressed some audio related stuff from last
version, or it's just my newer ALSA version, but now it seems that mono
broadcasting channels are audible through SPDIF ;-)


From lucianm at users.sourceforge.net  Mon Sep  5 00:43:26 2005
From: lucianm at users.sourceforge.net (Lucian Muresan)
Date: Mon, 05 Sep 2005 00:43:26 +0200
Subject: [Softdevice-devel] [PATCH] DirectFB install locations in the Makefile
Message-ID: <431B788E.9090302@users.sourceforge.net>

Hi,

please consider this patch for the softdevice Makefile, it makes
compilation with DFB support succeed easier on systems where DirectFB is
installed under the prefix /usr (like it's standard under Gentoo for
excample, whith builds managed by the portage system).

Lucian
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: softdevice-0.1.3-dfb_locations.diff
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050905/d27743e7/attachment.ksh>

From stefan at lucke.in-berlin.de  Mon Sep  5 07:36:54 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 5 Sep 2005 07:36:54 +0200
Subject: [Softdevice-devel] Re: key-repeat fixes; Re: [vdr] [ANNOUNCE] vdr-softdevice-0.1.3
In-Reply-To: <20050904190322.GA3134@localhost.localdomain>
References: <200509040853.11131.stefan@lucke.in-berlin.de> <20050904190322.GA3134@localhost.localdomain>
Message-ID: <200509050736.54346.stefan@lucke.in-berlin.de>

On Sonntag, 4. September 2005 21:03, Marko M?kel? wrote:
> On Sun, Sep 04, 2005 at 08:53:11AM +0200, Stefan Lucke wrote:
> > 2005-09-04: softdevice-0.1.3
> >     - dfb-out: applied dfb-key-repeat handling patch (by Marko M?kel?)
> 
> Thank you very much, Stefan!
> 
> Are you participating in the development of DirectFB?

Active no, I've no possibility to commit. Did you report that issue on
directfb-dev list ?

> I would love to
> see the corresponding patch in DirectFB 0.9.23.  I just updated the
> DirectFB bug report #24 (http://directfb.org/mantis/view.php?id=24)
> to mention the softdevice 0.1.3 release.

Oh, that's new to me, that they've such a bug tracker.

> 
> On a related note, I noticed a bug in cx88-input.c in video4linux.  If
> the driver misses an RC5 frame from the remote control while a key is
> being pressed down, it will send a key-release event followed by a key-press
> event and further key-repeat events. 

I don't know RC5 protocoll. But this is hard to address, if the 
transmission protocoll itself has _no_ flag indicating a repeated key.
On the other side, if there is a repeat flag in RC5, it should be fixable.

> This is not nice if you have
> a bad infrared connection and are trying to press a key exactly once.
> My patch tries to address this, but it is not a perfect solution yet.
> I'm trying to get this fixed in cooperation with the video4linux developers.

-- 
Stefan Lucke



From stefan at lucke.in-berlin.de  Mon Sep  5 07:51:46 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 5 Sep 2005 07:51:46 +0200
Subject: [Softdevice-devel] [PATCH] DirectFB install locations in the Makefile
In-Reply-To: <431B788E.9090302@users.sourceforge.net>
References: <431B788E.9090302@users.sourceforge.net>
Message-ID: <200509050751.46402.stefan@lucke.in-berlin.de>

On Montag, 5. September 2005 00:43, Lucian Muresan wrote:
> Hi,
> 
> please consider this patch for the softdevice Makefile, it makes
> compilation with DFB support succeed easier on systems where DirectFB is
> installed under the prefix /usr (like it's standard under Gentoo for
> excample, whith builds managed by the portage system).

I would prefer a configure approach to get the right paths
and output methods to build. But unfortunately it breaks our
current Makefile. I think I have to rename it to Makefile.vanilla
(including your patch) for backup purpose.

Do the following commands produce the needed paths on your system ?

pkg-config --cflags directfb dfb++
pkg-config --libs directfb dfb++

-- 
Stefan Lucke



From lucianm at users.sourceforge.net  Mon Sep  5 08:20:31 2005
From: lucianm at users.sourceforge.net (Lucian Muresan)
Date: Mon, 05 Sep 2005 08:20:31 +0200
Subject: [Softdevice-devel] [PATCH] DirectFB install locations in the
 Makefile
In-Reply-To: <200509050751.46402.stefan@lucke.in-berlin.de>
References: <431B788E.9090302@users.sourceforge.net> <200509050751.46402.stefan@lucke.in-berlin.de>
Message-ID: <431BE3AF.2050609@users.sourceforge.net>

Stefan Lucke wrote:
> On Montag, 5. September 2005 00:43, Lucian Muresan wrote:
>> Hi,
>> 
>> please consider this patch for the softdevice Makefile, it makes
>> compilation with DFB support succeed easier on systems where DirectFB is
>> installed under the prefix /usr (like it's standard under Gentoo for
>> excample, whith builds managed by the portage system).
> 
> I would prefer a configure approach to get the right paths
> and output methods to build. But unfortunately it breaks our
> current Makefile. I think I have to rename it to Makefile.vanilla
> (including your patch) for backup purpose.
> 
> Do the following commands produce the needed paths on your system ?
> 
> pkg-config --cflags directfb dfb++
> pkg-config --libs directfb dfb++

The first one does (I don't know if the second one also should have
providede a path, or the fact that after every library build, ldconfig
is executed, is enough):

htpc ~ # pkg-config --cflags directfb dfb++
-D_REENTRANT -D_GNU_SOURCE -I/usr/include/directfb -I/usr/include/dfb++
htpc ~ # pkg-config --libs directfb dfb++
-ldfb++ -ldirectfb -lz -lfusion -ldirect -lpthread -ldl
htpc ~ #


From nhuillard at e-dition.fr  Mon Sep  5 11:15:04 2005
From: nhuillard at e-dition.fr (Nicolas Huillard)
Date: Mon, 05 Sep 2005 11:15:04 +0200
Subject: [Softdevice-devel] [ANNOUNCE] vdr-softdevice-0.1.3
In-Reply-To: <1125862687.3080.66.camel@africa.netenviron.com>
References: <200509040853.11131.stefan@lucke.in-berlin.de> <1125862687.3080.66.camel@africa.netenviron.com>
Message-ID: <431C0C98.1040906@e-dition.fr>

Torgeir Veimo a ?crit :
> On Sun, 2005-09-04 at 08:53 +0200, Stefan Lucke wrote:
> 
>>softdevice team (Torgeir Veimo, Martin Wache and me, Stefan Lucke)
>>is pleased to announce a new release of vdr softdevice plugin.
> 
> Ho hum, am flattered, but I think my last cvs commit longer than two
> lines was a long time ago.. :) 

You're a great addition to the team : congratulations !
Contribution doesn't only count in lines of CVS commits ;-)

-- 
NH


From nhuillard at e-dition.fr  Mon Sep  5 11:21:44 2005
From: nhuillard at e-dition.fr (Nicolas Huillard)
Date: Mon, 05 Sep 2005 11:21:44 +0200
Subject: [Softdevice-devel] On my vdr suspend patch
In-Reply-To: <20050904190951.GB3134@localhost.localdomain>
References: <20050904190951.GB3134@localhost.localdomain>
Message-ID: <431C0E28.9080501@e-dition.fr>

Marko M?kel? a ?crit :
> I have used my patch for suspending vdr playback
> <http://www.funet.fi/~msmakela/software/vdr/#suspend>
> for over a week now, without any problems.
> 
> Users of nvram-wakeup may find the configurable suspend-to-shutdown
> feature useful.  Those whose boxes run 24?7 may just appreciate the
> reduced power consumption and heat production.

cpu-freq can also be a great addition WRT power consumption. Did anyone
tested that yet ?
Longhaul on VIA C3 seems to be well supported. I'll try after when time
comes.

> If anyone finds the patch useful, I would appreciate some supporting
> replies on the vdr mailing list to get the patch applied to mainline vdr.
> I understand that users of MPEG decoder cards do not care much about
> suspending playback, as it would not benefit anything (perhaps apart from
> saving a few watts worth of electricity, and avoiding firmware hangs when
> recording a bad input signal).

I'll try that, since I nearly finished my VT1622 TV-out tuning. Once
I've upgraded the whole VDR software : core + plugins, starting with
softdevice.
Softdevice release comes at the right time.
Keep up the good work, everyone, and thanks for your hard and *very*
useful work.

-- 
NH


From nhuillard at e-dition.fr  Mon Sep  5 11:29:55 2005
From: nhuillard at e-dition.fr (Nicolas Huillard)
Date: Mon, 05 Sep 2005 11:29:55 +0200
Subject: [Softdevice-devel] [PATCH] DirectFB install locations in the
 Makefile
In-Reply-To: <200509050751.46402.stefan@lucke.in-berlin.de>
References: <431B788E.9090302@users.sourceforge.net> <200509050751.46402.stefan@lucke.in-berlin.de>
Message-ID: <431C1013.2080302@e-dition.fr>

Stefan Lucke a ?crit :
> On Montag, 5. September 2005 00:43, Lucian Muresan wrote:
> 
>>please consider this patch for the softdevice Makefile, it makes
>>compilation with DFB support succeed easier on systems where DirectFB is
>>installed under the prefix /usr (like it's standard under Gentoo for
>>excample, whith builds managed by the portage system).
> 
> I would prefer a configure approach to get the right paths
> and output methods to build. But unfortunately it breaks our
> current Makefile. I think I have to rename it to Makefile.vanilla
> (including your patch) for backup purpose.
> 
> Do the following commands produce the needed paths on your system ?
> 
> pkg-config --cflags directfb dfb++
> pkg-config --libs directfb dfb++

On my vdr box with Debian self-packaged DFB++ :

nhuillard at vdr:nhuillard$ pkg-config --cflags directfb dfb++
-D_REENTRANT -D_GNU_SOURCE -I/usr/include/directfb -I/usr/include/dfb++
nhuillard at vdr:nhuillard$ pkg-config --libs directfb dfb++
-ldfb++ -ldirectfb -lz -lfusion -ldirect -lpthread -ldl

-- 
NH


From stefan at lucke.in-berlin.de  Mon Sep  5 13:10:34 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon,  5 Sep 2005 13:10:34 +0200
Subject: [Softdevice-devel] Softplay *.jpg
Message-ID: <1125918634.431c27aacdbf0@webmail.in-berlin.de>

Does someone know if it is possible to play/decode jpeg image files via
ffmpeg ? When I tried that, I got error -6 (AVERROR_NOFMT format not
supported).

Stefan Lucke


From jori.hamalainen at teliasonera.com  Mon Sep  5 15:29:42 2005
From: jori.hamalainen at teliasonera.com (jori.hamalainen at teliasonera.com)
Date: Mon, 5 Sep 2005 16:29:42 +0300
Subject: [Softdevice-devel] RE: [vdr] [ANNOUNCE] vdr-softdevice-0.1.3
Message-ID: <333A0A4FF2FA7E4D9528E127824C218402C711D3@FITMS200MB.tcad.telia.se>

> Softdevice plugin enables vdr to run on your desktop with
> so called budget cards. You'll get vdr output via framebuffer or X11-Xv or
> DirectFB or vidix to your screen. Decoding is done via ffmpeg.

Is this soon HDTV capable? There are commercial MPEG2 HDTV channels available, and last time I checked vdr-softdevice was unable to decode those.

It decoded the stream (1920x1080) but displayed on screen something like 720x576 window of the original stream.

This might have changed but I haven't checked recent soft devices because release notes doesn't mention anything about fixing it.

Best regards, Jori





From torgeir at pobox.com  Mon Sep  5 16:39:09 2005
From: torgeir at pobox.com (Torgeir Veimo)
Date: Mon, 05 Sep 2005 15:39:09 +0100
Subject: [Softdevice-devel] RE: [vdr] [ANNOUNCE] vdr-softdevice-0.1.3
In-Reply-To: <333A0A4FF2FA7E4D9528E127824C218402C711D3@FITMS200MB.tcad.telia.se>
References: 	 <333A0A4FF2FA7E4D9528E127824C218402C711D3@FITMS200MB.tcad.telia.se>
Message-ID: <1125931150.3057.1.camel@africa.netenviron.com>

On Mon, 2005-09-05 at 16:29 +0300, jori.hamalainen at teliasonera.com
wrote:
> > Softdevice plugin enables vdr to run on your desktop with
> > so called budget cards. You'll get vdr output via framebuffer or X11-Xv or
> > DirectFB or vidix to your screen. Decoding is done via ffmpeg.
> 
> Is this soon HDTV capable? There are commercial MPEG2 HDTV channels available, and last time I checked vdr-softdevice was unable to decode those.
> 
> It decoded the stream (1920x1080) but displayed on screen something like 720x576 window of the original stream.

XvMC support would help reduce cpu load for such streams, and there will
soon be more incentives to work on just that;
http://www.livejournal.com/users/airlied/13057.html

-- 
Torgeir Veimo <torgeir at pobox.com>



From marko.makela at hut.fi  Mon Sep  5 17:20:24 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 5 Sep 2005 18:20:24 +0300
Subject: [Softdevice-devel] Re: key-repeat fixes; Re: [vdr] [ANNOUNCE] vdr-softdevice-0.1.3
In-Reply-To: <200509050736.54346.stefan@lucke.in-berlin.de>
References: <200509040853.11131.stefan@lucke.in-berlin.de> <20050904190322.GA3134@localhost.localdomain> <200509050736.54346.stefan@lucke.in-berlin.de>
Message-ID: <20050905152024.GA3137@localhost.localdomain>

Hi Stefan,

> Active no, I've no possibility to commit. Did you report that issue on
> directfb-dev list ?

No, I'm not subscribing to that list.  I only reported it in the bug
tracking system.  Can you mention the bug report on the list?  If not,
I'll subscribe.

> > On a related note, I noticed a bug in cx88-input.c in video4linux.  If
> > the driver misses an RC5 frame from the remote control while a key is
> > being pressed down, it will send a key-release event followed by a key-press
> > event and further key-repeat events. 
> 
> I don't know RC5 protocoll. But this is hard to address, if the 
> transmission protocoll itself has _no_ flag indicating a repeated key.
> On the other side, if there is a repeat flag in RC5, it should be fixable.

There's a toggle bit that is flipped when a key is pressed down.  A
keypress will send identical rc5 frames every 64*T (T=16/9 ms) until
the key is released.  When a key is pressed again, the toggle bit will
be inverted.  My patch to cx88-input.c simply discards repeated
keypresses (identical rc5 frames) if a key-release event was already
delivered.  This could be improved further by increasing the key-release
timeout from 120 ms (which is only a little over 64*T).

	Marko


From M.Wache at gmx.net  Mon Sep  5 19:43:48 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 05 Sep 2005 19:43:48 +0200
Subject: [Softdevice-devel] Softplay *.jpg
In-Reply-To: <1125918634.431c27aacdbf0@webmail.in-berlin.de>
References: <1125918634.431c27aacdbf0@webmail.in-berlin.de>
Message-ID: <431C83D4.3000300@gmx.net>

Stefan Lucke schrieb:
> Does someone know if it is possible to play/decode jpeg image files via
> ffmpeg ? When I tried that, I got error -6 (AVERROR_NOFMT format not
> supported).

I guess one would have to use av_read_image instead of the standard AV
open/close routines. So it doesn't work out of the box currently.

I did not look into this deeply but I think changes to the softdevice
are needed to display pictures with softplay... Or maybe one can trick
ffmpeg to use "mjpeg"????

Bye,
Martin


From marko.makela at hut.fi  Mon Sep  5 21:05:21 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 5 Sep 2005 22:05:21 +0300
Subject: [Softdevice-devel] On my vdr suspend patch
In-Reply-To: <431C0E28.9080501@e-dition.fr>
References: <20050904190951.GB3134@localhost.localdomain> <431C0E28.9080501@e-dition.fr>
Message-ID: <20050905190521.GA3197@localhost.localdomain>

On Mon, Sep 05, 2005 at 11:21:44AM +0200, Nicolas Huillard wrote:
> > Users of nvram-wakeup may find the configurable suspend-to-shutdown
> > feature useful.  Those whose boxes run 24?7 may just appreciate the
> > reduced power consumption and heat production.
> 
> cpu-freq can also be a great addition WRT power consumption. Did anyone
> tested that yet ?

I'm using cpufreq and the 'ondemand' or 'conservative' scaling governor
on this IBM Thinkpad T41.  The fan makes less noise when the system is
running at the lowest clock frequency, but it usually still does make noise.
The lowest clock frequency is 600 MHz, and the highest is 1400 MHz.  I'm
only using 'userspace' scaling governor (i.e., manual clock rate
selection) when I want to make repeatable performance measurements.
I don't have a power meter, so I haven't made any exact measurements.

My VDR box doesn't support frequency scaling, but it's running very
quiet now, considering that it is an air-cooled system.

> Longhaul on VIA C3 seems to be well supported. I'll try after when time
> comes.

It should be a matter of recompiling the kernel or loading the right
modules.  No changes to the software should be needed.  I would expect
the 'conservative' scaling governor to be better than 'ondemand' when
the frequency switching is slow or the 'ondemand' scaling governor
would oscillate between two settings, causing jitter in the application.

	Marko


From stefan at lucke.in-berlin.de  Mon Sep  5 21:26:53 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 5 Sep 2005 21:26:53 +0200
Subject: [Softdevice-devel] Softplay *.jpg
In-Reply-To: <431C83D4.3000300@gmx.net>
References: <1125918634.431c27aacdbf0@webmail.in-berlin.de> <431C83D4.3000300@gmx.net>
Message-ID: <200509052126.53953.stefan@lucke.in-berlin.de>

On Montag, 5. September 2005 19:43, Martin Wache wrote:
> Stefan Lucke schrieb:
> > Does someone know if it is possible to play/decode jpeg image files via
> > ffmpeg ? When I tried that, I got error -6 (AVERROR_NOFMT format not
> > supported).
> 
> I guess one would have to use av_read_image instead of the standard AV
> open/close routines. So it doesn't work out of the box currently.
> 
> I did not look into this deeply but I think changes to the softdevice
> are needed to display pictures with softplay... Or maybe one can trick
> ffmpeg to use "mjpeg"????

I have to explain a bit more what my intension is. In the past days I
did an journey into the world of UPnP and associated media players
and servers:
http://www.twonkyvision.de/

Still have to try the free mediaserver MediaTomb:
http://sourceforge.net/projects/mediatomb

At least it is possible to play MP3 from an url connecting to a UPnP
mediaserver, filename hard coded set to :
http://192.x.y.z:9000/disk/music/O962.mp3"

That info was transferred in the following document:
  <DIDL-Lite>
    <item id="962" refID="960" parentID="709" restricted="1">
      <dc:title>What Do You Want The Girl To Do</dc:title>
      <dc:creator>Lowell George</dc:creator>
      <upnp:artist>Lowell George</upnp:artist>
      <upnp:album>Thanks I'll Eat It Here</upnp:album>
      <upnp:genre>Rock</upnp:genre>
      <upnp:playlist></upnp:playlist>
      <dc:date>1999-01-01</dc:date>
      <upnp:originalTrackNumber>1</upnp:originalTrackNumber>
      <upnp:albumArtURI></upnp:albumArtURI>
      <res size="4629639" duration="0:04:49.340" protocolInfo="http-get:*:audio/mpeg:*">http://192.x.y.z:9000/disk/music/O962.mp3</res>
      <upnp:class>object.item.audioItem.musicTrack</upnp:class>
    </item>
.. 
  </DIDL-Lite>

Thats part of a trace from a java UPnP controll point Cidero:
http://www.cidero.com/

-- 
Stefan Lucke



From marko.makela at hut.fi  Tue Sep  6 08:21:03 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 6 Sep 2005 09:21:03 +0300
Subject: [Softdevice-devel] Crashes or bugs when rewinding over an aspect ratio change
In-Reply-To: <200509042300.39822.stefan@lucke.in-berlin.de>
References: <20050904192000.GC3134@localhost.localdomain> <200509042300.39822.stefan@lucke.in-berlin.de>
Message-ID: <20050906062103.GB3177@localhost.localdomain>

On Sun, Sep 04, 2005 at 11:00:39PM +0200, Stefan Lucke wrote:
> Maybe that happens here too upon A/R switches. But most of my recordings
> are cut, so the A/R switch is only a GOP from start/end. Thats what I've
> seen sometimes on toggeling screen A/R selection at key repeat rate,
> was perhaps similar: 
> - a portion of the screen from the previous A/R remains active: 
> 	- left/right when final A/R is 4:3, left/right flipping at half
> 	  frame rate on 16:9 screen.
> 	- top/bottom kept flipping with half frame rate when final
> 	  A/R is 16:9 on a 4:3 screen.
>   but both symptoms dissappeared when OSD went off.

It could be the same.  I haven't mapped a key to switching the aspect
ratio.  It's fixed at 4:3, clipping the sides of 16:9 program.

I haven't tried to switch on/off the OSD when this happens.  It's so
rarely.

> > (2) vdr crashes.
> 
> That's the one I've not yet seen.

Here's a backtrace from the clip where the crash occurred.  I managed
to repeat it several times, but not after I cut a sample for you.
I think I was able to repeat it once from the short clip.

Program received signal SIGSEGV, Segmentation fault.
[Switching to Thread -1287173200 (LWP 729)]
0xb7d1a5ef in memcpy () from /lib/tls/libc.so.6
(gdb) bt full
#0  0xb7d1a5ef in memcpy () from /lib/tls/libc.so.6
No symbol table info available.
#1  0xb7946d6a in cDFBVideoOut::YUV (this=0xb5eac000,
    Py=0xb12e2008 '\200' <repeats 200 times>...,
    Pu=0xb12fac08 '\200' <repeats 200 times>...,
    Pv=0xb13136a8 '\200' <repeats 200 times>..., Width=704, Height=576,
    Ystride=704, UVstride=352) at video-dfb.c:1194
        dst = (uint8_t *) 0xb5eabee0 <Address 0xb5eabee0 out of bounds>
        pitch = 576
        hi = 287
#2  0xb793c205 in cVideoStreamDecoder::DecodePacket (this=0x84cecc8,
    pkt=0x84ec518) at mpeg2decoder.c:615
        findPTS = Variable "findPTS" is not available.
(gdb) detach

> > Are others seeing these?  I'm happy to provide test recordings to make
> > this repeatable.  
> 
> So I'd like to ask for a short (but long enough) link to dig into.

You'll get it privately.

	Marko


From stefan at lucke.in-berlin.de  Tue Sep  6 09:42:07 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue,  6 Sep 2005 09:42:07 +0200
Subject: [Softdevice-devel] Crashes or bugs when rewinding over an aspect ratio change
In-Reply-To: <20050906062103.GB3177@localhost.localdomain>
References: <20050904192000.GC3134@localhost.localdomain> <200509042300.39822.stefan@lucke.in-berlin.de> <20050906062103.GB3177@localhost.localdomain>
Message-ID: <1125992527.431d484f0ae38@webmail.in-berlin.de>

Quoting Marko M?kel?:

> On Sun, Sep 04, 2005 at 11:00:39PM +0200, Stefan Lucke wrote:

> Program received signal SIGSEGV, Segmentation fault.
> [Switching to Thread -1287173200 (LWP 729)]
> 0xb7d1a5ef in memcpy () from /lib/tls/libc.so.6
> (gdb) bt full
> #0  0xb7d1a5ef in memcpy () from /lib/tls/libc.so.6
> No symbol table info available.
> #1  0xb7946d6a in cDFBVideoOut::YUV (this=0xb5eac000,
>     Py=0xb12e2008 '\200' <repeats 200 times>...,
>     Pu=0xb12fac08 '\200' <repeats 200 times>...,
>     Pv=0xb13136a8 '\200' <repeats 200 times>..., Width=704, Height=576,
>     Ystride=704, UVstride=352) at video-dfb.c:1194
>         dst = (uint8_t *) 0xb5eabee0 <Address 0xb5eabee0 out of bounds>
>         pitch = 576
>         hi = 287

Doh, we are just copying the last line of Pv colour information.
When that crash happens, is the last line of aspect change information written
to syslog ([VideoOut]: %dx%d [%d,%d %dx%d] -> %dx%d [%d,%d %dx%d]) ?
Are there odd numbers ?
Maybe thats a rounding issue, when placing the desired protion of the layer.
If that idea is true, it should by avoided by using the newer directfb
interface for that purpose. This newer interface can be activated by
changing line 20 in video-dfb.c from:
# define HAVE_SetSourceLocation 0
to:
# define HAVE_SetSourceLocation 1

> #2  0xb793c205 in cVideoStreamDecoder::DecodePacket (this=0x84cecc8,
>     pkt=0x84ec518) at mpeg2decoder.c:615
>         findPTS = Variable "findPTS" is not available.
> (gdb) detach
>
> > > Are others seeing these?  I'm happy to provide test recordings to make
> > > this repeatable.
> >
> > So I'd like to ask for a short (but long enough) link to dig into.
>
> You'll get it privately.

I'll check that later.

Stefan Lucke


From marko.makela at hut.fi  Tue Sep  6 10:08:13 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 6 Sep 2005 11:08:13 +0300
Subject: [Softdevice-devel] Crashes or bugs when rewinding over an aspect ratio change
In-Reply-To: <1125992527.431d484f0ae38@webmail.in-berlin.de>
References: <20050904192000.GC3134@localhost.localdomain> <200509042300.39822.stefan@lucke.in-berlin.de> <20050906062103.GB3177@localhost.localdomain> <1125992527.431d484f0ae38@webmail.in-berlin.de>
Message-ID: <20050906080813.GD3177@localhost.localdomain>

On Tue, Sep 06, 2005 at 09:42:07AM +0200, Stefan Lucke wrote:
> Doh, we are just copying the last line of Pv colour information.
> When that crash happens, is the last line of aspect change information written
> to syslog ([VideoOut]: %dx%d [%d,%d %dx%d] -> %dx%d [%d,%d %dx%d]) ?
> Are there odd numbers ?

Nope, but I have disabled CMDDEB if that makes a difference.  Here's
the output from the log after a couple of f.fwd and rewind.  The last
one lead to the crash:

[softdevice] picture buffer released
[softdevice] allocating picture buffer for resolution 704x576 format 0
[softdevice] picture buffer released
[softdevice] allocating picture buffer for resolution 704x576 format 0
+++++++++++++++++++++++++++++++++++++++++[dfb] (re)configuring
Videolayer to 704 x 576 (704x576)
[surface capabilities] videoSurface: videoonly double-buffered flipping
[dfb] (re)configured 0x08100609
++++++++++++++++++++++++[softdevice] picture buffer released
[softdevice] allocating picture buffer for resolution 704x576 format 0
[softdevice] picture buffer released
[softdevice] allocating picture buffer for resolution 704x576 format 0
[dfb] (re)configuring Videolayer to 704 x 576 (528x576)
[surface capabilities] videoSurface: videoonly double-buffered flipping
[dfb] (re)configured 0x08100609
[softdevice] picture buffer released
[softdevice] allocating picture buffer for resolution 704x576 format 0
[softdevice] picture buffer released
[softdevice] allocating picture buffer for resolution 704x576 format 0
++++++++++++++++++++++++

(no newline at the end of the '+++' line)

> Maybe thats a rounding issue, when placing the desired protion of the layer.
> If that idea is true, it should by avoided by using the newer directfb
> interface for that purpose. This newer interface can be activated by
> changing line 20 in video-dfb.c from:
> # define HAVE_SetSourceLocation 0
> to:
> # define HAVE_SetSourceLocation 1

Yes, I recall that suggestion from a few weeks ago, and I think that the
modification made the crashes go away earlier.  However, I recall there
were other problems the last time I tried it.  I think I'll have to keep
using that setting longer now.  It seems to make the crash go away.

Is there a reason why this cannot be made the default?  Does DirectFB
define any version symbol that could be checked with ifdef?

It looks like softdevice won't always detect aspect ratio changes during
rewind.  It'll display 4:3 footage as 16:9, even after pressing Stop and Play.
Skipping stream in 1-minute steps sometimes makes it detect the correct aspect
ratio, but only if the skipping will switch from 4:3 to 16:9 and back.
Isn't the aspect ratio setting included in every GOP?

	Marko


From stefan at lucke.in-berlin.de  Tue Sep  6 10:26:27 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue,  6 Sep 2005 10:26:27 +0200
Subject: [Softdevice-devel] Crashes or bugs when rewinding over an aspect ratio change
In-Reply-To: <20050906080813.GD3177@localhost.localdomain>
References: <20050904192000.GC3134@localhost.localdomain> <200509042300.39822.stefan@lucke.in-berlin.de> <20050906062103.GB3177@localhost.localdomain> <1125992527.431d484f0ae38@webmail.in-berlin.de> <20050906080813.GD3177@localhost.localdomain>
Message-ID: <1125995187.431d52b3cb8cb@webmail.in-berlin.de>

Quoting Marko M?kel? <marko.makela at hut.fi>:

> On Tue, Sep 06, 2005 at 09:42:07AM +0200, Stefan Lucke wrote:
> > Doh, we are just copying the last line of Pv colour information.
> > When that crash happens, is the last line of aspect change information written
> > to syslog ([VideoOut]: %dx%d [%d,%d %dx%d] -> %dx%d [%d,%d %dx%d]) ?
> > Are there odd numbers ?
>
> Nope, but I have disabled CMDDEB if that makes a difference.  Here's
> the output from the log after a couple of f.fwd and rewind.  The last
> one lead to the crash:
>
> [softdevice] picture buffer released
> [softdevice] allocating picture buffer for resolution 704x576 format 0

Thats stdout/stderr. That aspect changeinformation I asked for is written
to syslog with dsyslog().

> ++++++++++++++++++++++++
>
> (no newline at the end of the '+++' line)

This are single '+' written when we are a bit late in sync ;-( .

>
> > Maybe thats a rounding issue, when placing the desired protion of the layer.
> > If that idea is true, it should by avoided by using the newer directfb
> > interface for that purpose. This newer interface can be activated by
> > changing line 20 in video-dfb.c from:
> > # define HAVE_SetSourceLocation 0
> > to:
> > # define HAVE_SetSourceLocation 1
>
> Yes, I recall that suggestion from a few weeks ago, and I think that the
> modification made the crashes go away earlier.  However, I recall there
> were other problems the last time I tried it.  I think I'll have to keep
> using that setting longer now.  It seems to make the crash go away.
>
> Is there a reason why this cannot be made the default?  Does DirectFB
> define any version symbol that could be checked with ifdef?

It can be detected via configure :-) .

>
> It looks like softdevice won't always detect aspect ratio changes during
> rewind.  It'll display 4:3 footage as 16:9, even after pressing Stop and Play.
> Skipping stream in 1-minute steps sometimes makes it detect the correct aspect
> ratio, but only if the skipping will switch from 4:3 to 16:9 and back.
> Isn't the aspect ratio setting included in every GOP?
>

Aspect changes should be detected immediate, but it is done in ffmpeg.
Which exact version do you use ?

I'll have to do some rewind training.


Stefan Lucke


From marko.makela at hut.fi  Tue Sep  6 13:29:20 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 6 Sep 2005 14:29:20 +0300
Subject: [Softdevice-devel] Crashes or bugs when rewinding over an aspect ratio change
In-Reply-To: <1125995187.431d52b3cb8cb@webmail.in-berlin.de>
References: <20050904192000.GC3134@localhost.localdomain> <200509042300.39822.stefan@lucke.in-berlin.de> <20050906062103.GB3177@localhost.localdomain> <1125992527.431d484f0ae38@webmail.in-berlin.de> <20050906080813.GD3177@localhost.localdomain> <1125995187.431d52b3cb8cb@webmail.in-berlin.de>
Message-ID: <20050906112920.GA3206@localhost.localdomain>

On Tue, Sep 06, 2005 at 10:26:27AM +0200, Stefan Lucke wrote:
> > [softdevice] picture buffer released
> > [softdevice] allocating picture buffer for resolution 704x576 format 0
> 
> Thats stdout/stderr. That aspect changeinformation I asked for is written
> to syslog with dsyslog().

I don't have syslogd.  I guess the output won't go to stderr in that case.
I'll #define dsyslog() to something that outputs to stderr.

> Aspect changes should be detected immediate, but it is done in ffmpeg.
> Which exact version do you use ?

It's some CVS snapshot I took last spring.  I'll update it; maybe that is
an ffmpeg bug after all.  I remember that when I started using
softdevice, the aspect ratio changes were not always detected even when
playing at normal speed.  That may have been fixed by updating ffmpeg.

	Marko


From stefan at lucke.in-berlin.de  Tue Sep  6 14:46:57 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue,  6 Sep 2005 14:46:57 +0200
Subject: [Softdevice-devel] Crashes or bugs when rewinding over an aspect ratio change
In-Reply-To: <20050906112920.GA3206@localhost.localdomain>
References: <20050904192000.GC3134@localhost.localdomain> <200509042300.39822.stefan@lucke.in-berlin.de> <20050906062103.GB3177@localhost.localdomain> <1125992527.431d484f0ae38@webmail.in-berlin.de> <20050906080813.GD3177@localhost.localdomain> <1125995187.431d52b3cb8cb@webmail.in-berlin.de> <20050906112920.GA3206@localhost.localdomain>
Message-ID: <1126010817.431d8fc121338@webmail.in-berlin.de>

Quoting Marko M?kel? <marko.makela at hut.fi>:

> On Tue, Sep 06, 2005 at 10:26:27AM +0200, Stefan Lucke wrote:
> > > [softdevice] picture buffer released
> > > [softdevice] allocating picture buffer for resolution 704x576 format 0
> >
> > Thats stdout/stderr. That aspect changeinformation I asked for is written
> > to syslog with dsyslog().

Do you know that syslogd can be configured in a way that it does't write
to local disk, but sends all messages to a remote 7/24 uptime server instead?

>
> I don't have syslogd.  I guess the output won't go to stderr in that case.
> I'll #define dsyslog() to something that outputs to stderr.
>
> > Aspect changes should be detected immediate, but it is done in ffmpeg.
> > Which exact version do you use ?
>
> It's some CVS snapshot I took last spring.

There were some difficulties in ffmpeg with A/R detection (and segfaults upon
A/R change). A snapshot taken after May 14th would be ok.

>  I'll update it; maybe that is
> an ffmpeg bug after all.  I remember that when I started using
> softdevice, the aspect ratio changes were not always detected even when
> playing at normal speed.  That may have been fixed by updating ffmpeg.
>

Stefan Lucke


From per at mellander.org  Tue Sep  6 17:04:37 2005
From: per at mellander.org (Per Mellander)
Date: Tue, 6 Sep 2005 18:04:37 +0300
Subject: [Softdevice-devel] Compile against ffmpeg CVS
Message-ID: <20050906150037.M8796@mellander.org>

I don't know if this is common knowledge around you guys. But I had to add 
libavutil in the Makefile to get it to compile against ffmpeg CVS of 
yesterday.

#
# DON'T touch this:
FFMPEGLIBS = -lavcodec -lavformat -lavutil
#

/Mel




From marko.makela at hut.fi  Tue Sep  6 21:27:09 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 6 Sep 2005 22:27:09 +0300
Subject: [Softdevice-devel] Crashes or bugs when rewinding over an aspect ratio change
In-Reply-To: <1126010817.431d8fc121338@webmail.in-berlin.de>
References: <20050904192000.GC3134@localhost.localdomain> <200509042300.39822.stefan@lucke.in-berlin.de> <20050906062103.GB3177@localhost.localdomain> <1125992527.431d484f0ae38@webmail.in-berlin.de> <20050906080813.GD3177@localhost.localdomain> <1125995187.431d52b3cb8cb@webmail.in-berlin.de> <20050906112920.GA3206@localhost.localdomain> <1126010817.431d8fc121338@webmail.in-berlin.de>
Message-ID: <20050906192709.GB3152@localhost.localdomain>

Stefan,

I've now updated ffmpeg to current CVS.  I restored
HAVE_SetSourceLocation to 0, and it still crashes, but not always.

At the most recent crash (triple-speed rewind from 16:9 to 4:3 footage),
the screen shows a 4:3 image stretched as a 16:9 image (sides clipped,
because I have set the softdevice clipping to 4:3).  The stack trace is
a bit longer now:

#0  0xb7d135ef in memcpy () from /lib/tls/libc.so.6
#1  0xb793fd3a in cDFBVideoOut::YUV (this=0xb5ea5000,
    Py=0xb11ce008 '\200' <repeats 200 times>...,
    Pu=0xb11e6c08 (I guess you are not interested in the contents)
    Pv=0xb11ff6a8
    Width=704, Height=576, Ystride=704, UVstride=352)
    at video-dfb.c:1194
#2  0xb79351d5 in cVideoStreamDecoder::DecodePacket (this=0x84d7730,
    pkt=0x8363d18) at mpeg2decoder.c:615
#3  0xb7934843 in cStreamDecoder::Action (this=0x84d7730) at mpeg2decoder.c:188
#4  0x080f1c32 in cThread::StartThread (Thread=0x84d7730) at thread.c:234
#5  0xb7efdccd in start_thread () from /lib/tls/libpthread.so.0
#6  0xb7d75b0e in clone () from /lib/tls/libc.so.6

Here's the stderr (including dsyslog output from video.c):

++++++++++++++[softdevice] picture buffer released
[softdevice] allocating picture buffer for resolution 704x576 format 0
[softdevice] picture buffer released
[softdevice] allocating picture buffer for resolution 704x576 format 0
[VideoOut]: aspect changed (8 -> 8 ; 1.333333 -> 1.777778)[VideoOut]:
704x576 [88,0 528x576] -> 768x576 [0,0 768x576][dfb] (re)configuring
Videolayer to 704 x 576 (528x576)
[surface capabilities] videoSurface: videoonly double-buffered flipping
[dfb] (re)configured 0x08100609
[softdevice] picture buffer released
[softdevice] allocating picture buffer for resolution 704x576 format 0
[softdevice] picture buffer released
[softdevice] allocating picture buffer for resolution 704x576 format 0
+++++++++++[VideoOut]: aspect changed (8 -> 8 ; 1.777778 ->
1.333333)[VideoOut]: 704x576 [0,0 704x576] -> 768x576 [0,0 768x576]++(!)
[10164:    0.000] --> Caught signal 11 (at 0xb5ea5000, invalid
permissions) <--

It looks like the 4:3 -> 16:9 and 16:9 -> 4:3 switches were recognized
by softdevice but not used when decoding.  Could this be a race
condition?  How many threads does softdevice start?

> Do you know that syslogd can be configured in a way that it does't write
> to local disk, but sends all messages to a remote 7/24 uptime server instead?

Yes, I know it that syslog can be redirected to a remote server, but I
don't have one.  Some day, if I need to replace my ADSL bridge, I will
consider setting up a Linux-based one that could serve Wake-on-LAN
packets and monitor a few things.

> There were some difficulties in ffmpeg with A/R detection (and segfaults upon
> A/R change). A snapshot taken after May 14th would be ok.

My previous ffmpeg checkout was from that time frame.

	Marko


From marko.makela at hut.fi  Tue Sep  6 21:37:15 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 6 Sep 2005 22:37:15 +0300
Subject: [Softdevice-devel] Crashes or bugs when rewinding over an aspect ratio change
In-Reply-To: <20050906192709.GB3152@localhost.localdomain>
References: <20050904192000.GC3134@localhost.localdomain> <200509042300.39822.stefan@lucke.in-berlin.de> <20050906062103.GB3177@localhost.localdomain> <1125992527.431d484f0ae38@webmail.in-berlin.de> <20050906080813.GD3177@localhost.localdomain> <1125995187.431d52b3cb8cb@webmail.in-berlin.de> <20050906112920.GA3206@localhost.localdomain> <1126010817.431d8fc121338@webmail.in-berlin.de> <20050906192709.GB3152@localhost.localdomain>
Message-ID: <20050906193715.GC3152@localhost.localdomain>

On Tue, Sep 06, 2005 at 10:27:09PM +0300, Marko M?kel? wrote:
> I've now updated ffmpeg to current CVS.  I restored
> HAVE_SetSourceLocation to 0, and it still crashes, but not always.
> 
> At the most recent crash (triple-speed rewind from 16:9 to 4:3 footage),
> the screen shows a 4:3 image stretched as a 16:9 image (sides clipped,
> because I have set the softdevice clipping to 4:3).

With HAVE_SetSourceLocation defined as 1, the 16:9 to 4:3 transition
during rewind or skip-back-1-minute is always reported by video.c but
sometimes ignored by the decoder, i.e., the 4:3 image is stretched
horizontally and the sides are clipped.  There is no crash.

	Marko


From M.Wache at gmx.net  Tue Sep  6 22:20:28 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 06 Sep 2005 22:20:28 +0200
Subject: [Softdevice-devel] Softplay *.jpg
In-Reply-To: <200509052126.53953.stefan@lucke.in-berlin.de>
References: <1125918634.431c27aacdbf0@webmail.in-berlin.de> <431C83D4.3000300@gmx.net> <200509052126.53953.stefan@lucke.in-berlin.de>
Message-ID: <431DFA0C.7020903@gmx.net>

Stefan Lucke schrieb:
> 
> I have to explain a bit more what my intension is. In the past days I
> did an journey into the world of UPnP and associated media players
> and servers:
> http://www.twonkyvision.de/
> 
> Still have to try the free mediaserver MediaTomb:
> http://sourceforge.net/projects/mediatomb
> 
> At least it is possible to play MP3 from an url connecting to a UPnP
> mediaserver, filename hard coded set to :
> http://192.x.y.z:9000/disk/music/O962.mp3"
> 
> That info was transferred in the following document:
>   <DIDL-Lite>
>     <item id="962" refID="960" parentID="709" restricted="1">
>       <dc:title>What Do You Want The Girl To Do</dc:title>
>       <dc:creator>Lowell George</dc:creator>
>       <upnp:artist>Lowell George</upnp:artist>
>       <upnp:album>Thanks I'll Eat It Here</upnp:album>
>       <upnp:genre>Rock</upnp:genre>
>       <upnp:playlist></upnp:playlist>
>       <dc:date>1999-01-01</dc:date>
>       <upnp:originalTrackNumber>1</upnp:originalTrackNumber>
>       <upnp:albumArtURI></upnp:albumArtURI>
>       <res size="4629639" duration="0:04:49.340" protocolInfo="http-get:*:audio/mpeg:*">
>http://192.x.y.z:9000/disk/music/O962.mp3</res>
>       <upnp:class>object.item.audioItem.musicTrack</upnp:class>
>     </item>
> .. 
>   </DIDL-Lite>
> 
> Thats part of a trace from a java UPnP controll point Cidero:
> http://www.cidero.com/
> 

If softplay can already play the http stream I think it should be not
very difficult to add support for the controll stream and so support the
UPnP protocol. What bothers me is just that we would have to parse xml
and I would not like to add the dependency to another library to parse
xml. On the other hand parsing xml is not a matter of a few lines.
I'm still working on some major changes in sofplay, I want to use the
new Service interface of vdr to comunicate and I also improved the
playlist support. If you want to integrate UPnP support into softplay
and you find a simple and easy way to parse the xml without the use of
an external library I certainly wont object.
By the way, I want add the possiblity to show background pictures while
playing audio files at some point, but up to now I think there are more
important missing features.


Martin


From M.Wache at gmx.net  Tue Sep  6 22:29:18 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 06 Sep 2005 22:29:18 +0200
Subject: [Softdevice-devel] Compile against ffmpeg CVS
In-Reply-To: <20050906150037.M8796@mellander.org>
References: <20050906150037.M8796@mellander.org>
Message-ID: <431DFC1E.9020709@gmx.net>

Per Mellander schrieb:
> I don't know if this is common knowledge around you guys. But I had to add 
> libavutil in the Makefile to get it to compile against ffmpeg CVS of 
> yesterday.
> 
> #
> # DON'T touch this:
> FFMPEGLIBS = -lavcodec -lavformat -lavutil
> #
> 
> /Mel

Yes, we are aware of this, unfortunatly it is not easy to find a way to
find out the ffmpeg version in the Makefile. The ffmpeg guys changed the
build numbering scheme at the same time, so extracting the ffmpeg build
number is very difficult.
Currently we try to find a simple and reliable solution for this, maybe
we will add a simple configure script soon.

Martin


From stefan at lucke.in-berlin.de  Tue Sep  6 23:56:48 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 6 Sep 2005 23:56:48 +0200
Subject: [Softdevice-devel] Crashes or bugs when rewinding over an aspect ratio change
In-Reply-To: <20050906062103.GB3177@localhost.localdomain>
References: <20050904192000.GC3134@localhost.localdomain> <200509042300.39822.stefan@lucke.in-berlin.de> <20050906062103.GB3177@localhost.localdomain>
Message-ID: <200509062356.48310.stefan@lucke.in-berlin.de>

On Dienstag, 6. September 2005 08:21, Marko M?kel? wrote:
> On Sun, Sep 04, 2005 at 11:00:39PM +0200, Stefan Lucke wrote:
> > Maybe that happens here too upon A/R switches. But most of my recordings
> > are cut, so the A/R switch is only a GOP from start/end. Thats what I've
> > seen sometimes on toggeling screen A/R selection at key repeat rate,
> > was perhaps similar: 
> > - a portion of the screen from the previous A/R remains active: 
> > 	- left/right when final A/R is 4:3, left/right flipping at half
> > 	  frame rate on 16:9 screen.
> > 	- top/bottom kept flipping with half frame rate when final
> > 	  A/R is 16:9 on a 4:3 screen.
> >   but both symptoms dissappeared when OSD went off.
> 
> It could be the same.  I haven't mapped a key to switching the aspect
> ratio.  It's fixed at 4:3, clipping the sides of 16:9 program.
> 
> I haven't tried to switch on/off the OSD when this happens.  It's so
> rarely.
> 
> > > (2) vdr crashes.
> > 
> > That's the one I've not yet seen.

> > So I'd like to ask for a short (but long enough) link to dig into.
> 
> You'll get it privately.

Thanks, got it.
My tests were fastest forward to end, fastest rewind to start and so on,
and made a strange observation:

- I got no crash, neither with xv-out nor with dfb-out.
- With xv-out (4:3 and 16:9 window) aspect ratio change is allways
  correct shown :-), but that was pure luck.
- With dfb-out a/r change is allways detected correct from 4:3 -> 16:9 FF,
  upon FREW 16:9 -> 4:3 is only shown when speed was set to
  slowest reverse and never shown in fastest reverse ;-(( .
  That a/r change is allways correct reported in syslog but displayed w r o n g .

Sep  6 23:13:43 jarada vdr[4405]: [VideoOut]: resolution changed: W(720 -> 704); H(576 ->576)
Sep  6 23:13:43 jarada vdr[4405]: [VideoOut]: aspect changed (0 -> 8 ; 1,333333 -> 1,333333)
Sep  6 23:13:43 jarada vdr[4405]: [VideoOut]: 704x576 [0,0 704x576] -> 1280x1024 [0,32 1280x960]
from live view to recording, shown correct,

Sep  6 23:13:44 jarada vdr[4406]: [softdevice-audio]: xrun
Sep  6 23:14:00 jarada vdr[4405]: [VideoOut]: aspect changed (8 -> 8 ; 1,333333 -> 1,777778)
Sep  6 23:14:00 jarada vdr[4405]: [VideoOut]: 704x576 [0,0 704x576] -> 1280x1024 [0,152 1280x720]
switch to 16:9 fast forward, shown correct,

Sep  6 23:14:06 jarada vdr[4409]: [softdevice-audio]: xrun
Sep  6 23:14:10 jarada vdr[4411]: [VideoOut]: aspect changed (8 -> 8 ; 1,777778 -> 1,333333)
Sep  6 23:14:10 jarada vdr[4411]: [VideoOut]: 704x576 [0,0 704x576] -> 1280x1024 [0,32 1280x960]
fastest rewind, falsly shown as 16:9 

Wait .., there are '+' chars printed as we are in a hurry, so we skip the YUV() processing and aspect calculation
is done before ... dfb reconfigure message is missing too.

Fix is in cvs.

-- 
Stefan Lucke



From torgeir at pobox.com  Wed Sep  7 00:01:21 2005
From: torgeir at pobox.com (Torgeir Veimo)
Date: Tue, 06 Sep 2005 23:01:21 +0100
Subject: [Softdevice-devel] Softplay *.jpg
In-Reply-To: <431DFA0C.7020903@gmx.net>
References: <1125918634.431c27aacdbf0@webmail.in-berlin.de>
	 <431C83D4.3000300@gmx.net> <200509052126.53953.stefan@lucke.in-berlin.de>
	 <431DFA0C.7020903@gmx.net>
Message-ID: <1126044081.12197.9.camel@africa.netenviron.com>

On Tue, 2005-09-06 at 22:20 +0200, Martin Wache wrote:

> What bothers me is just that we would have to parse xml
> and I would not like to add the dependency to another library to parse
> xml. 

libxml(2) is present on all gnome based systems, and I think all kde
based systems as well. ogle uses that library, and it's not a too
uncommon dependency..

-- 
Torgeir Veimo <torgeir at pobox.com>



From stefan at lucke.in-berlin.de  Wed Sep  7 06:45:19 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 7 Sep 2005 06:45:19 +0200
Subject: [Softdevice-devel] Softplay *.jpg
In-Reply-To: <431DFA0C.7020903@gmx.net>
References: <1125918634.431c27aacdbf0@webmail.in-berlin.de> <200509052126.53953.stefan@lucke.in-berlin.de> <431DFA0C.7020903@gmx.net>
Message-ID: <200509070645.20078.stefan@lucke.in-berlin.de>

On Dienstag, 6. September 2005 22:20, Martin Wache wrote:
> Stefan Lucke schrieb:
> > 
> > I have to explain a bit more what my intension is. In the past days I
> > did an journey into the world of UPnP and associated media players
> > and servers:
> > http://www.twonkyvision.de/
> > 
> > Still have to try the free mediaserver MediaTomb:
> > http://sourceforge.net/projects/mediatomb
> > 
> > At least it is possible to play MP3 from an url connecting to a UPnP
> > mediaserver, filename hard coded set to :
> > http://192.x.y.z:9000/disk/music/O962.mp3"
> > 
> > 
> > Thats part of a trace from a java UPnP controll point Cidero:
> > http://www.cidero.com/
> > 
> 
> If softplay can already play the http stream I think it should be not
> very difficult to add support for the controll stream and so support the
> UPnP protocol. What bothers me is just that we would have to parse xml
> and I would not like to add the dependency to another library to parse
> xml. On the other hand parsing xml is not a matter of a few lines.
> I'm still working on some major changes in sofplay, I want to use the
> new Service interface of vdr to comunicate and I also improved the
> playlist support. If you want to integrate UPnP support into softplay
> and you find a simple and easy way to parse the xml without the use of
> an external library I certainly wont object.

It's a bit more than just parsing xml. An new external lib would be
required: libupnp http://upnp.sourceforge.net/

> By the way, I want add the possiblity to show background pictures while
> playing audio files at some point, but up to now I think there are more
> important missing features.

Yes we have enough todos of our own. So I keep playing separately
until code looks better and does some more things.

-- 
Stefan Lucke



From stefan at lucke.in-berlin.de  Wed Sep  7 06:48:17 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 7 Sep 2005 06:48:17 +0200
Subject: [Softdevice-devel] Re: key-repeat fixes; Re: [vdr] [ANNOUNCE] vdr-softdevice-0.1.3
In-Reply-To: <20050905152024.GA3137@localhost.localdomain>
References: <200509040853.11131.stefan@lucke.in-berlin.de> <200509050736.54346.stefan@lucke.in-berlin.de> <20050905152024.GA3137@localhost.localdomain>
Message-ID: <200509070648.17920.stefan@lucke.in-berlin.de>

On Montag, 5. September 2005 17:20, Marko M?kel? wrote:
> Hi Stefan,
> 
> > Active no, I've no possibility to commit. Did you report that issue on
> > directfb-dev list ?
> 
> No, I'm not subscribing to that list.  I only reported it in the bug
> tracking system.  Can you mention the bug report on the list?  If not,
> I'll subscribe.

I think it's better, that you th author of changes report that
yourself, as you can explain that more detailed.


-- 
Stefan Lucke



From per at mellander.org  Wed Sep  7 12:17:22 2005
From: per at mellander.org (Per Mellander)
Date: Wed, 7 Sep 2005 13:17:22 +0300
Subject: [Softdevice-devel] Softplay issue ( ie. ffmpeg )
Message-ID: <20050907095121.M96473@mellander.org>

I'm running vdr-1.3.31 with softdevice (xv ) and softplay. ffmpeg and the 
plugins are from CVS 20050905. ffmpeg is compiled with:

./configure  --enable-pp \
             --enable-xvid \  # xvidcore-1.1.0-beta2
             --enable-shared \
             --enable-shared-pp \
             --enable-gpl \
             --enable-mp3lame # lame-devel-0.lvn.1.3.rpm

I have a mpeg movie that plays well with MPlayer but not with softplay. It 
starts ok with softplay and I can stop the replay by pressing 'stop'. The 
problem is that the sound is all messed ( cracks 'n pops ) and I only get a 
black picture. I'm not that great at ffmpeg but I really would like to know 
what I'm missing to get this movie running under softplay.

As I see it mplayer is using libmpeg2 for this but I understood it as ffmpeg 
would be able to handle this?

[root at ponton ~]# more softplay.log 
PLDBG: Thread started: SoftPlayer
CMD[8821]:SetPlayMode PmAudioOnly
CMD[8821]:Start IsSuspended 0
CMD[8822]:init put byte finished
CMD[8832]:new Audio stream index.. old -1 new 0
CMD[8832]:Neuer StreamDecoder Pid: 4494 context 0x8321420 type 1
Streams: 1
Codec 0 ID: 69640
CMD[8837]:Neuer Thread gestartet: pid:4494 type 1
Input #0, psxstr, from 'test':
  Duration: N/A, bitrate: N/A
  Stream #0.0: Audio: adpcm_xa, 18900 Hz, stereo

[root at ponton ~]# more mplayer.log 
MPEG-PS file format detected.
VIDEO:  MPEG2  480x576  (aspect 2)  25.000 fps  2530.0 kbps (316.2 kbyte/s)
==========================================================================
Opening audio decoder: [mp3lib] MPEG layer-2, layer-3
AUDIO: 44100 Hz, 2 ch, s16le, 224.0 kbit/15.87% (ratio: 28000->176400)
Selected audio codec: [mp3] afm:mp3lib (mp3lib MPEG layer-2, layer-3)
==========================================================================
vo: X11 running at 1280x1024 with depth 16 and 16 bpp (":0.0" => local 
display)
==========================================================================
Opening video decoder: [mpegpes] MPEG 1/2 Video passthrough
VDec: vo config request - 480 x 576 (preferred csp: Mpeg PES)
Could not find matching colorspace - retrying with -vf scale...
Opening video filter: [scale]
The selected video_out device is incompatible with this codec.
VDecoder init failed :(
Opening video decoder: [libmpeg2] MPEG 1/2 Video decoder libmpeg2-v0.4.0b
Selected video codec: [mpeg12] vfm:libmpeg2 (MPEG-1 or 2 (libmpeg2))
==========================================================================


BTW!

Thanks for a very good software, soft[play|device].

/Mel







From nhuillard at e-dition.fr  Wed Sep  7 12:20:48 2005
From: nhuillard at e-dition.fr (Nicolas Huillard)
Date: Wed, 07 Sep 2005 12:20:48 +0200
Subject: [Softdevice-devel] Softplay *.jpg
In-Reply-To: <200509070645.20078.stefan@lucke.in-berlin.de>
References: <1125918634.431c27aacdbf0@webmail.in-berlin.de> <200509052126.53953.stefan@lucke.in-berlin.de> <431DFA0C.7020903@gmx.net> <200509070645.20078.stefan@lucke.in-berlin.de>
Message-ID: <431EBF00.3070901@e-dition.fr>

Stefan Lucke a ?crit :
> Yes we have enough todos of our own. So I keep playing separately
> until code looks better and does some more things.

Dolby Digital on S/PDIF ?

-- 
NH


From lucianm at users.sourceforge.net  Wed Sep  7 12:35:01 2005
From: lucianm at users.sourceforge.net (Lucian Muresan)
Date: Wed, 07 Sep 2005 12:35:01 +0200
Subject: [Softdevice-devel] Softplay *.jpg
In-Reply-To: <431EBF00.3070901@e-dition.fr>
References: <1125918634.431c27aacdbf0@webmail.in-berlin.de> <200509052126.53953.stefan@lucke.in-berlin.de> <431DFA0C.7020903@gmx.net> <200509070645.20078.stefan@lucke.in-berlin.de> <431EBF00.3070901@e-dition.fr>
Message-ID: <431EC255.9020604@users.sourceforge.net>

Nicolas Huillard wrote:
> Stefan Lucke a ?crit :
> 
>>Yes we have enough todos of our own. So I keep playing separately
>>until code looks better and does some more things.
> 
> 
> Dolby Digital on S/PDIF ?
> 

Heh, I was about to ask the same thing ;-)



From M.Wache at gmx.net  Wed Sep  7 19:45:04 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Wed, 07 Sep 2005 19:45:04 +0200
Subject: [Softdevice-devel] Softplay issue ( ie. ffmpeg )
In-Reply-To: <20050907095121.M96473@mellander.org>
References: <20050907095121.M96473@mellander.org>
Message-ID: <431F2720.40302@gmx.net>

Per Mellander schrieb:
> I'm running vdr-1.3.31 with softdevice (xv ) and softplay. ffmpeg and the 
> plugins are from CVS 20050905. ffmpeg is compiled with:
> 
> ./configure  --enable-pp \
>              --enable-xvid \  # xvidcore-1.1.0-beta2
>              --enable-shared \
>              --enable-shared-pp \
>              --enable-gpl \
>              --enable-mp3lame # lame-devel-0.lvn.1.3.rpm
> 
> I have a mpeg movie that plays well with MPlayer but not with softplay. It 
> starts ok with softplay and I can stop the replay by pressing 'stop'. The 
> problem is that the sound is all messed ( cracks 'n pops ) and I only get a 
> black picture. I'm not that great at ffmpeg but I really would like to know 
> what I'm missing to get this movie running under softplay.
> 
> As I see it mplayer is using libmpeg2 for this but I understood it as ffmpeg 
> would be able to handle this?
> 
> [root at ponton ~]# more softplay.log 
> PLDBG: Thread started: SoftPlayer
> CMD[8821]:SetPlayMode PmAudioOnly
> CMD[8821]:Start IsSuspended 0
> CMD[8822]:init put byte finished
> CMD[8832]:new Audio stream index.. old -1 new 0
> CMD[8832]:Neuer StreamDecoder Pid: 4494 context 0x8321420 type 1
> Streams: 1
> Codec 0 ID: 69640
> CMD[8837]:Neuer Thread gestartet: pid:4494 type 1
> Input #0, psxstr, from 'test':
>   Duration: N/A, bitrate: N/A
>   Stream #0.0: Audio: adpcm_xa, 18900 Hz, stereo
> 
> [root at ponton ~]# more mplayer.log 
> MPEG-PS file format detected.
> VIDEO:  MPEG2  480x576  (aspect 2)  25.000 fps  2530.0 kbps (316.2 kbyte/s)
> ==========================================================================
> Opening audio decoder: [mp3lib] MPEG layer-2, layer-3
> AUDIO: 44100 Hz, 2 ch, s16le, 224.0 kbit/15.87% (ratio: 28000->176400)
> Selected audio codec: [mp3] afm:mp3lib (mp3lib MPEG layer-2, layer-3)
> ==========================================================================
> vo: X11 running at 1280x1024 with depth 16 and 16 bpp (":0.0" => local 
> display)
> ==========================================================================
> Opening video decoder: [mpegpes] MPEG 1/2 Video passthrough
> VDec: vo config request - 480 x 576 (preferred csp: Mpeg PES)
> Could not find matching colorspace - retrying with -vf scale...
> Opening video filter: [scale]
> The selected video_out device is incompatible with this codec.
> VDecoder init failed :(
> Opening video decoder: [libmpeg2] MPEG 1/2 Video decoder libmpeg2-v0.4.0b
> Selected video codec: [mpeg12] vfm:libmpeg2 (MPEG-1 or 2 (libmpeg2))
> ==========================================================================
> 
It seems that softplay uses the wrong file format, instead of MPEG-PS it
uses psxstr. Your configuration should be fine, just the autodetection
of the file format failed.

Please try to play the file with ffplay, the player which comes with
ffmpeg and if it also fails please report that to the ffmpeg mailling
list. If ffplay plays the file properly it is a bug in softplay and I
will have a look at it.

Bye,
Martin


From marko.makela at hut.fi  Wed Sep  7 20:09:19 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 7 Sep 2005 21:09:19 +0300
Subject: [Softdevice-devel] Crash when video stream is suspended or resumed
In-Reply-To: <200509062356.48310.stefan@lucke.in-berlin.de>
References: <20050904192000.GC3134@localhost.localdomain> <200509042300.39822.stefan@lucke.in-berlin.de> <20050906062103.GB3177@localhost.localdomain> <200509062356.48310.stefan@lucke.in-berlin.de>
Message-ID: <20050907180919.GB352807@kosh.hut.fi>

On Tue, Sep 06, 2005 at 11:56:48PM +0200, Stefan Lucke wrote:
> Wait .., there are '+' chars printed as we are in a hurry, so we skip the YUV()
> processing and aspect calculation is done before ... dfb reconfigure message
> is missing too.
> 
> Fix is in cvs.

Thanks, the aspect ratio is correctly detected now.  I didn't test if the
crash goes away if I restore HAVE_SetSourceLocation to 0, but I believe so.

However, I've got another crash to report.  When I suspend playback with
my own vdr patch, vdr will sometimes crash, either by itself or when
I switch channels with playback suspended.  softdevice.IsSuspended == 0
all the time.

My vdr-suspend patch (http://www.funet.fi/~msmakela/software/vdr/#suspend)
essentially calls cDevice::Clear() and stops the MPEG PES stream at the
source (for live stream, cDevice::Action() will only pass the packets to
cRecorder, and for recordings, dvbplayer.c will act as if playback is
paused).  I believe that a similar crash could occur when pulling the
aerial cable.  As a matter of fact, vdr has crashed previously when I
have plugged in the DVB-T aerial cable while vdr was trying to view
live stream.

Here is a stack trace:

#0  0xb7d755ef in memcpy () from /lib/tls/libc.so.6
No symbol table info available.
#1  0xb79a1daf in cDFBVideoOut::YUV (this=0x827c410, Py=0xb4ef8808 "", Pu=0x829bbb8 "", 
    Pv=0x82b5858 '\177' <repeats 200 times>..., Width=736, Height=576, Ystride=736, 
    UVstride=368) at video-dfb.c:1166
	dst = (uint8_t *) 0xb5f06ea0 <Address 0xb5f06ea0 out of bounds>
	pitch = 704
	hi = 137058744
#2  0xb799315f in cVideoOut::Action (this=0x827c410) at video.c:107
	newOsdWidth = 736
	newOsdHeight = 576
	changeMode = false
#3  0x080f1c32 in cThread::StartThread (Thread=0x827c410) at thread.c:234
No locals.
#4  0xb7f5fccd in start_thread () from /lib/tls/libpthread.so.0
No symbol table info available.
#5  0xb7dd7b0e in clone () from /lib/tls/libc.so.6
No symbol table info available.

Any ideas?

	Marko


From stefan at lucke.in-berlin.de  Wed Sep  7 21:27:14 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 7 Sep 2005 21:27:14 +0200
Subject: [Softdevice-devel] Crash when video stream is suspended or resumed
In-Reply-To: <20050907180919.GB352807@kosh.hut.fi>
References: <20050904192000.GC3134@localhost.localdomain> <200509062356.48310.stefan@lucke.in-berlin.de> <20050907180919.GB352807@kosh.hut.fi>
Message-ID: <200509072127.14997.stefan@lucke.in-berlin.de>

On Mittwoch, 7. September 2005 20:09, Marko M?kel? wrote:
> On Tue, Sep 06, 2005 at 11:56:48PM +0200, Stefan Lucke wrote:
> > Wait .., there are '+' chars printed as we are in a hurry, so we skip the YUV()
> > processing and aspect calculation is done before ... dfb reconfigure message
> > is missing too.
> > 
> > Fix is in cvs.
> 
> Thanks, the aspect ratio is correctly detected now.  I didn't test if the
> crash goes away if I restore HAVE_SetSourceLocation to 0, but I believe so.

I believe that too, as previously there could be changes to area offsets
or size and we did not readjust the surface ('+' char written YUV() 
call skipped).

> 
> However, I've got another crash to report.

Did expect that kind of report :-) .

>  When I suspend playback with
> my own vdr patch, vdr will sometimes crash, either by itself or when
> I switch channels with playback suspended.  softdevice.IsSuspended == 0
> all the time.
> 
> My vdr-suspend patch (http://www.funet.fi/~msmakela/software/vdr/#suspend)
> essentially calls cDevice::Clear() and stops the MPEG PES stream at the
> source (for live stream, cDevice::Action() will only pass the packets to
> cRecorder, and for recordings, dvbplayer.c will act as if playback is
> paused).  I believe that a similar crash could occur when pulling the
> aerial cable.  As a matter of fact, vdr has crashed previously when I
> have plugged in the DVB-T aerial cable while vdr was trying to view
> live stream.
> 
> Here is a stack trace:
> 
> #0  0xb7d755ef in memcpy () from /lib/tls/libc.so.6
> No symbol table info available.
> #1  0xb79a1daf in cDFBVideoOut::YUV (this=0x827c410, Py=0xb4ef8808 "", Pu=0x829bbb8 "", 
>     Pv=0x82b5858 '\177' <repeats 200 times>..., Width=736, Height=576, Ystride=736, 
>     UVstride=368) at video-dfb.c:1166
> 	dst = (uint8_t *) 0xb5f06ea0 <Address 0xb5f06ea0 out of bounds>
> 	pitch = 704
> 	hi = 137058744

'hi' is bogous.

> #2  0xb799315f in cVideoOut::Action (this=0x827c410) at video.c:107
> 	newOsdWidth = 736
> 	newOsdHeight = 576
> 	changeMode = false

Thats now an other situation. YUV() is now called from an other thread
(OSD-refresh/blanker). Locking ??

> Any ideas?

Actually no.

-- 
Stefan Lucke



From peter at legio.mine.nu  Wed Sep  7 22:34:51 2005
From: peter at legio.mine.nu (Peter Andersson)
Date: Wed, 7 Sep 2005 22:34:51 +0200 (CEST)
Subject: [Softdevice-devel] Whats the deal with the xv option?
Message-ID: <37314.192.168.1.241.1126125291.squirrel@192.168.1.241>

Hi!

I have just downloaded and installed the softdevice plugin (version 0.1.3)
and can't get it to work properly. Whenever i start vdr (vdr -P"softdevice
-vo xv:") all i get is a black screen. When i move the window around the
black screen within the window lags behind and sometimes i can just make
out the yellow gui of vdr. It is like the plugin produces a black square
on top of the actual vdr screen. And when i move the vdr window i move it
out of the way of the black square for an instance. Sorry i don't know how
to describe this any better, hope you understand what i mean.

I have confirmed that xv works properly with other software, like xine for
example.
Sorry about this noob question but i have no where else to turn. Any ideas
you might have are most welcome.

/Peter

More info:

hardware/software

      Kernel 2.6.13
      Xorg   6.8.2
      Vdr 1.3.23
      Metacity windowmanager (gnome desktop)
      Intel PIII 1000mhz
      512mb ram 133mhz
      Graphics Prosavage 3D

output from vdr:

 vdr -l 3 -P "softdevice -vo xv:"
[softdevice] processing args
[softdevice]   argv [0] = softdevice
[softdevice]   argv [1] = -vo
vo_argv: xv:
[softdevice] initializing Plugin
[softdevice] Initializing Video Out
[softdevice] ffmpeg version(CVS) build(3211265)
[XvVideoOut]: displayAspect = 1.334559, displayRatio = 1.333333, PAR =
1.000919
[XvVideoOut]: max area size 1024 x 1024
[XvVideoOut]: using area size 736 x 576
[softdevice] Xv out OK !
[softdevice] Video Out seems to be OK
[softdevice] Initializing Audio Out
[softdevice] Audio out seems to be OK
[softdevice] A/V devices initialized, now initializing MPEG2 Decoder
cSoftDevice::MakePrimaryDevice




From ospite at studenti.unina.it  Wed Sep  7 23:05:40 2005
From: ospite at studenti.unina.it (Antonio Ospite)
Date: Wed, 7 Sep 2005 23:05:40 +0200
Subject: [Softdevice-devel] Whats the deal with the xv option?
In-Reply-To: <37314.192.168.1.241.1126125291.squirrel@192.168.1.241>
References: <37314.192.168.1.241.1126125291.squirrel@192.168.1.241>
Message-ID: <20050907230540.4e368eff.ospite@studenti.unina.it>

On Wed, 7 Sep 2005 22:34:51 +0200 (CEST)
"Peter Andersson" <peter at legio.mine.nu> wrote:

> Hi!
> 
> I have just downloaded and installed the softdevice plugin (version
> 0.1.3) and can't get it to work properly. Whenever i start vdr (vdr
> -P"softdevice -vo xv:") all i get is a black screen. When i move the
> window around the black screen within the window lags behind and
> sometimes i can just make out the yellow gui of vdr. It is like the
> plugin produces a black square on top of the actual vdr screen. And
> when i move the vdr window i move it out of the way of the black
> square for an instance. Sorry i don't know how to describe this any
> better, hope you understand what i mean.
[...]
> More info:
> 
> hardware/software
> 
>       Kernel 2.6.13
>       Xorg   6.8.2
>       Vdr 1.3.23
>       Metacity windowmanager (gnome desktop)
>       Intel PIII 1000mhz
>       512mb ram 133mhz
>       Graphics Prosavage 3D
                    ^^^^^^
Here's the problem, savage driver is broken till xorg 6.8.2 (maybe is
has been fixed in 6.9/7.0).

So you need a little patch (so do I):

diff -ruN softdevice/video-xv.c softdevice_tp/video-xv.c
--- softdevice/video-xv.c	2005-07-26 19:56:53.000000000 +0200
+++ softdevice_tp/video-xv.c	2005-07-26 22:06:13.000000000 +0200
@@ -949,7 +949,8 @@
 
   attributeStore.SetXInfo(dpy,port);
   attributeStore.Save();
-  attributeStore.SetColorkey(0x00000000);
+  //attributeStore.SetColorkey(0x00000000);
+  attributeStore.SetColorkey(0x01000000);
   attributeStore.SetValue("XV_AUTOPAINT_COLORKEY",1);
 
   /*

Hope this helps.

Have a nice time,
   Antonio.

-- 
Public key: http://shell.studenti.unina.it/~ospite/aopubkey.asc
  Web Site: http://shell.studenti.unina.it/~ospite
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050907/2274793e/attachment.pgp>

From peter at legio.mine.nu  Wed Sep  7 23:36:59 2005
From: peter at legio.mine.nu (Peter Andersson)
Date: Wed, 7 Sep 2005 23:36:59 +0200 (CEST)
Subject: [Softdevice-devel] Whats the deal with the xv option?
In-Reply-To: <20050907230540.4e368eff.ospite@studenti.unina.it>
References: <37314.192.168.1.241.1126125291.squirrel@192.168.1.241>
    <20050907230540.4e368eff.ospite@studenti.unina.it>
Message-ID: <56476.192.168.1.241.1126129019.squirrel@192.168.1.241>

Wow! that was quick!
Thanks for the patch, it didn't quite work for me. Vdr spits out an error
message:

vdr: invalid port number: softdevice -vo xv:

Could this have to do with the following messages during patching:

patching file softdevice/video-xv.c
Hunk #1 succeeded at 974 with fuzz 2 (offset 25 lines).

Again, thanks for your help.

/Peter


> On Wed, 7 Sep 2005 22:34:51 +0200 (CEST)
> "Peter Andersson" <peter at legio.mine.nu> wrote:
>
>> Hi!
>>
>> I have just downloaded and installed the softdevice plugin (version
>> 0.1.3) and can't get it to work properly. Whenever i start vdr (vdr
>> -P"softdevice -vo xv:") all i get is a black screen. When i move the
>> window around the black screen within the window lags behind and
>> sometimes i can just make out the yellow gui of vdr. It is like the
>> plugin produces a black square on top of the actual vdr screen. And
>> when i move the vdr window i move it out of the way of the black
>> square for an instance. Sorry i don't know how to describe this any
>> better, hope you understand what i mean.
> [...]
>> More info:
>>
>> hardware/software
>>
>>       Kernel 2.6.13
>>       Xorg   6.8.2
>>       Vdr 1.3.23
>>       Metacity windowmanager (gnome desktop)
>>       Intel PIII 1000mhz
>>       512mb ram 133mhz
>>       Graphics Prosavage 3D
>                     ^^^^^^
> Here's the problem, savage driver is broken till xorg 6.8.2 (maybe is
> has been fixed in 6.9/7.0).
>
> So you need a little patch (so do I):
>
> diff -ruN softdevice/video-xv.c softdevice_tp/video-xv.c
> --- softdevice/video-xv.c	2005-07-26 19:56:53.000000000 +0200
> +++ softdevice_tp/video-xv.c	2005-07-26 22:06:13.000000000 +0200
> @@ -949,7 +949,8 @@
>
>    attributeStore.SetXInfo(dpy,port);
>    attributeStore.Save();
> -  attributeStore.SetColorkey(0x00000000);
> +  //attributeStore.SetColorkey(0x00000000);
> +  attributeStore.SetColorkey(0x01000000);
>    attributeStore.SetValue("XV_AUTOPAINT_COLORKEY",1);
>
>    /*
>
> Hope this helps.
>
> Have a nice time,
>    Antonio.
>
> --
> Public key: http://shell.studenti.unina.it/~ospite/aopubkey.asc
>   Web Site: http://shell.studenti.unina.it/~ospite
>




From ospite at studenti.unina.it  Wed Sep  7 23:46:42 2005
From: ospite at studenti.unina.it (Antonio Ospite)
Date: Wed, 7 Sep 2005 23:46:42 +0200
Subject: [Softdevice-devel] Whats the deal with the xv option?
In-Reply-To: <56476.192.168.1.241.1126129019.squirrel@192.168.1.241>
References: <37314.192.168.1.241.1126125291.squirrel@192.168.1.241>
	<20050907230540.4e368eff.ospite@studenti.unina.it>
	<56476.192.168.1.241.1126129019.squirrel@192.168.1.241>
Message-ID: <20050907234642.4490c44f.ospite@studenti.unina.it>

On Wed, 7 Sep 2005 23:36:59 +0200 (CEST)
"Peter Andersson" <peter at legio.mine.nu> wrote:

> Wow! that was quick!
> Thanks for the patch, it didn't quite work for me. Vdr spits out an
> error message:
> 
> vdr: invalid port number: softdevice -vo xv:
>

Did you quote properly the plugin parameters in runvdr?
 -P\"softdevice -vo xv:\"
Ah, use -P and NOT -p 
:)
 
> Could this have to do with the following messages during patching:
> 
> patching file softdevice/video-xv.c
> Hunk #1 succeeded at 974 with fuzz 2 (offset 25 lines).
> 
> Again, thanks for your help.
> 
> /Peter

The patch was applied correctly.

Take care,
   Antonio.

-- 
Public key: http://shell.studenti.unina.it/~ospite/aopubkey.asc
  Web Site: http://shell.studenti.unina.it/~ospite
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050907/41c28170/attachment.pgp>

From stefan at lucke.in-berlin.de  Wed Sep  7 23:45:52 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 7 Sep 2005 23:45:52 +0200
Subject: [Softdevice-devel] Whats the deal with the xv option?
In-Reply-To: <20050907230540.4e368eff.ospite@studenti.unina.it>
References: <37314.192.168.1.241.1126125291.squirrel@192.168.1.241> <20050907230540.4e368eff.ospite@studenti.unina.it>
Message-ID: <200509072345.52719.stefan@lucke.in-berlin.de>

On Mittwoch, 7. September 2005 23:05, Antonio Ospite wrote:
> On Wed, 7 Sep 2005 22:34:51 +0200 (CEST)
> "Peter Andersson" <peter at legio.mine.nu> wrote:
> 
> > Hi!
> > 
> > I have just downloaded and installed the softdevice plugin (version
> > 0.1.3) and can't get it to work properly. Whenever i start vdr (vdr
> > -P"softdevice -vo xv:") all i get is a black screen. When i move the
> > window around the black screen within the window lags behind and
> > sometimes i can just make out the yellow gui of vdr. It is like the
> > plugin produces a black square on top of the actual vdr screen. And
> > when i move the vdr window i move it out of the way of the black
> > square for an instance. Sorry i don't know how to describe this any
> > better, hope you understand what i mean.
> [...]
> > More info:
> > 
> > hardware/software
> > 
> >       Kernel 2.6.13
> >       Xorg   6.8.2
> >       Vdr 1.3.23
> >       Metacity windowmanager (gnome desktop)
> >       Intel PIII 1000mhz
> >       512mb ram 133mhz
> >       Graphics Prosavage 3D
>                     ^^^^^^
> Here's the problem, savage driver is broken till xorg 6.8.2 (maybe is
> has been fixed in 6.9/7.0).

They still have that bug ? I think its really a long time since we discovered
that one. Looked at my archive: it was  2004-04-28 when I reported that
on devel at XFree86.Org .


-- 
Stefan Lucke



From stefan at lucke.in-berlin.de  Wed Sep  7 23:51:03 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 7 Sep 2005 23:51:03 +0200
Subject: [Softdevice-devel] Whats the deal with the xv option?
In-Reply-To: <56476.192.168.1.241.1126129019.squirrel@192.168.1.241>
References: <37314.192.168.1.241.1126125291.squirrel@192.168.1.241> <20050907230540.4e368eff.ospite@studenti.unina.it> <56476.192.168.1.241.1126129019.squirrel@192.168.1.241>
Message-ID: <200509072351.03635.stefan@lucke.in-berlin.de>

On Mittwoch, 7. September 2005 23:36, Peter Andersson wrote:
> Wow! that was quick!
> Thanks for the patch, it didn't quite work for me. Vdr spits out an error
> message:
> 
> vdr: invalid port number: softdevice -vo xv:
> 

No, thats a plain vdr error message issued from vdr.c.
Maybe you typed small 'p' instead of capital 'P' for plugins specification.

> Could this have to do with the following messages during patching:

Don't think so.

-- 
Stefan Lucke



From ospite at studenti.unina.it  Wed Sep  7 23:54:43 2005
From: ospite at studenti.unina.it (Antonio Ospite)
Date: Wed, 7 Sep 2005 23:54:43 +0200
Subject: [Softdevice-devel] Whats the deal with the xv option?
In-Reply-To: <200509072345.52719.stefan@lucke.in-berlin.de>
References: <37314.192.168.1.241.1126125291.squirrel@192.168.1.241>
	<20050907230540.4e368eff.ospite@studenti.unina.it>
	<200509072345.52719.stefan@lucke.in-berlin.de>
Message-ID: <20050907235443.3308e596.ospite@studenti.unina.it>

On Wed, 7 Sep 2005 23:45:52 +0200
Stefan Lucke <stefan at lucke.in-berlin.de> wrote:

> > >       Graphics Prosavage 3D
> >                     ^^^^^^
> > Here's the problem, savage driver is broken till xorg 6.8.2 (maybe
> > is has been fixed in 6.9/7.0).
> 
> They still have that bug ? I think its really a long time since we
> discovered that one. Looked at my archive: it was  2004-04-28 when I
> reported that on devel at XFree86.Org .
>

If i remember correctly it was during XFree86 4.4 licensing problems, so
maybe the bug got fixed in XFree86 (4.5) but not in Xorg and people
forgot the issue?
I read somewhere that next Xorg release has a quite revamped savage
driver, expecially regarding dri support, but i did not check if this
particular issue has been addressed. We shall see.

Bye,
   Antonio Ospite.

-- 
Public key: http://shell.studenti.unina.it/~ospite/aopubkey.asc
  Web Site: http://shell.studenti.unina.it/~ospite
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050907/2dbd6753/attachment.pgp>

From peter at legio.mine.nu  Thu Sep  8 00:04:24 2005
From: peter at legio.mine.nu (Peter Andersson)
Date: Thu, 8 Sep 2005 00:04:24 +0200 (CEST)
Subject: [Softdevice-devel] Whats the deal with the xv option?
In-Reply-To: <20050907234642.4490c44f.ospite@studenti.unina.it>
References: <37314.192.168.1.241.1126125291.squirrel@192.168.1.241>
    <20050907230540.4e368eff.ospite@studenti.unina.it>
    <56476.192.168.1.241.1126129019.squirrel@192.168.1.241>
    <20050907234642.4490c44f.ospite@studenti.unina.it>
Message-ID: <2363.192.168.1.252.1126130664.squirrel@192.168.1.252>

Man, do i feel stupid. You are right, i wrote "-p" instead of "-P". Your
patch works great! Thanks a bunch, you really made my day.

/Peter

> On Wed, 7 Sep 2005 23:36:59 +0200 (CEST)
> "Peter Andersson" <peter at legio.mine.nu> wrote:
>
>> Wow! that was quick!
>> Thanks for the patch, it didn't quite work for me. Vdr spits out an
>> error message:
>>
>> vdr: invalid port number: softdevice -vo xv:
>>
>
> Did you quote properly the plugin parameters in runvdr?
>  -P\"softdevice -vo xv:\"
> Ah, use -P and NOT -p
> :)
>
>> Could this have to do with the following messages during patching:
>>
>> patching file softdevice/video-xv.c
>> Hunk #1 succeeded at 974 with fuzz 2 (offset 25 lines).
>>
>> Again, thanks for your help.
>>
>> /Peter
>
> The patch was applied correctly.
>
> Take care,
>    Antonio.
>
> --
> Public key: http://shell.studenti.unina.it/~ospite/aopubkey.asc
>   Web Site: http://shell.studenti.unina.it/~ospite
>




From marko.makela at hut.fi  Thu Sep  8 10:03:52 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 8 Sep 2005 11:03:52 +0300
Subject: [Softdevice-devel] Crash when video stream is suspended or resumed
In-Reply-To: <200509072127.14997.stefan@lucke.in-berlin.de>
References: <20050904192000.GC3134@localhost.localdomain> <200509062356.48310.stefan@lucke.in-berlin.de> <20050907180919.GB352807@kosh.hut.fi> <200509072127.14997.stefan@lucke.in-berlin.de>
Message-ID: <20050908080352.GC3095@localhost.localdomain>

On Wed, Sep 07, 2005 at 09:27:14PM +0200, Stefan Lucke wrote:
> > However, I've got another crash to report.
> 
> Did expect that kind of report :-) .

What could I do to troubleshoot that bug?  When exactly are softdevice
threads created and terminated?

	Marko


From stefan at lucke.in-berlin.de  Thu Sep  8 11:00:22 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu,  8 Sep 2005 11:00:22 +0200
Subject: [Softdevice-devel] Crash when video stream is suspended or resumed
In-Reply-To: <20050908080352.GC3095@localhost.localdomain>
References: <20050904192000.GC3134@localhost.localdomain> <200509062356.48310.stefan@lucke.in-berlin.de> <20050907180919.GB352807@kosh.hut.fi> <200509072127.14997.stefan@lucke.in-berlin.de> <20050908080352.GC3095@localhost.localdomain>
Message-ID: <1126170022.431ffda6b02ee@webmail.in-berlin.de>

Quoting Marko M?kel? <marko.makela at hut.fi>:

> On Wed, Sep 07, 2005 at 09:27:14PM +0200, Stefan Lucke wrote:
> > > However, I've got another crash to report.
> >
> > Did expect that kind of report :-) .

I tried joking.

>
> What could I do to troubleshoot that bug?  When exactly are softdevice
> threads created and terminated?

After a second thought, I don't think it's thread synching related
(don't know excatly when they are created :-( ).

The code from video.c when YUV() is called (line 106/107, annotated cvs view):
  97                  osdMutex.Lock();

  98 lucke 1.27       if (old_picture)
  99                  {
 100                    YUV(old_picture->data[0], old_picture->data[1], old_picture->data[2],
 101                        old_width,old_height,
 102                        old_picture->linesize[0],old_picture->linesize[1]);
 103                  }
 104                  else
 105                  {
 106                    YUV(OsdPy,OsdPu, OsdPv, OsdWidth, OsdHeight,
 107                        OSD_FULL_WIDTH, OSD_FULL_WIDTH/2);
 108                  }

 109 lucke 1.22       Osd_changed=0;
 110                  osdMutex.Unlock();


and yout original crash report should be enough:
#0  0xb7d755ef in memcpy () from /lib/tls/libc.so.6
No symbol table info available.
#1  0xb79a1daf in cDFBVideoOut::YUV (this=0x827c410, Py=0xb4ef8808 "", Pu=0x829bbb8 "",
    Pv=0x82b5858 '\177' <repeats 200 times>..., Width=736, Height=576, Ystride=736,
    UVstride=368) at video-dfb.c:1166
	dst = (uint8_t *) 0xb5f06ea0 <Address 0xb5f06ea0 out of bounds>
	pitch = 704
	hi = 137058744
#2  0xb799315f in cVideoOut::Action (this=0x827c410) at video.c:107
	newOsdWidth = 736
	newOsdHeight = 576
	changeMode = false

That's what happend:
We have been suspended for a while and the desired drawing area just does not fit
into our current surface area. We are called with WidthxHeight = 736x576 but
pitch is 704, that's the width of current surface.
A segfault in that case should be expected :-( .

Stefan Lucke


From marko.makela at hut.fi  Thu Sep  8 12:01:28 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 8 Sep 2005 13:01:28 +0300
Subject: [Softdevice-devel] Crash when video stream is suspended or resumed
In-Reply-To: <1126170022.431ffda6b02ee@webmail.in-berlin.de>
References: <20050904192000.GC3134@localhost.localdomain> <200509062356.48310.stefan@lucke.in-berlin.de> <20050907180919.GB352807@kosh.hut.fi> <200509072127.14997.stefan@lucke.in-berlin.de> <20050908080352.GC3095@localhost.localdomain> <1126170022.431ffda6b02ee@webmail.in-berlin.de>
Message-ID: <20050908100128.GA3182@localhost.localdomain>

On Thu, Sep 08, 2005 at 11:00:22AM +0200, Stefan Lucke wrote:
> Quoting Marko M?kel? <marko.makela at hut.fi>:
> 
> > On Wed, Sep 07, 2005 at 09:27:14PM +0200, Stefan Lucke wrote:
> > > > However, I've got another crash to report.
> > >
> > > Did expect that kind of report :-) .
> 
> I tried joking.

Sure, I would have understand it as a joke even without the smiley.

> That's what happend:
> We have been suspended for a while and the desired drawing area just does not fit
> into our current surface area. We are called with WidthxHeight = 736x576 but
> pitch is 704, that's the width of current surface.
> A segfault in that case should be expected :-( .

Does the OSD use the same dimensions as the video stream?  Should there
maybe be a cDevice method for setting the dimensions?

I wonder how VDR could possibly detect the changes in dimensions,
because the MPEG PES stream will be dropped in cDevice::Action().
It will only be passed to instances of cRecorder.

Could it be that after the "end of video stream" timeout, softdevice
somehow requests the dimensions of the surface area to be changed?
Note that within softdevice, playback is running; it just won't receive
anything from vdr due to my suspend patch.

	Marko


From stefan at lucke.in-berlin.de  Thu Sep  8 12:45:08 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu,  8 Sep 2005 12:45:08 +0200
Subject: [Softdevice-devel] Crash when video stream is suspended or resumed
In-Reply-To: <20050908100128.GA3182@localhost.localdomain>
References: <20050904192000.GC3134@localhost.localdomain> <200509062356.48310.stefan@lucke.in-berlin.de> <20050907180919.GB352807@kosh.hut.fi> <200509072127.14997.stefan@lucke.in-berlin.de> <20050908080352.GC3095@localhost.localdomain> <1126170022.431ffda6b02ee@webmail.in-berlin.de> <20050908100128.GA3182@localhost.localdomain>
Message-ID: <1126176308.432016347bfc1@webmail.in-berlin.de>

Quoting Marko M?kel? <marko.makela at hut.fi>:

> On Thu, Sep 08, 2005 at 11:00:22AM +0200, Stefan Lucke wrote:
> > Quoting Marko M?kel? <marko.makela at hut.fi>:
> >
> > > On Wed, Sep 07, 2005 at 09:27:14PM +0200, Stefan Lucke wrote:
> > > > > However, I've got another crash to report.
> > > >
> > > > Did expect that kind of report :-) .
> >
> > I tried joking.
>
> Sure, I would have understand it as a joke even without the smiley.
>
> > That's what happend:
> > We have been suspended for a while and the desired drawing area just does not fit
> > into our current surface area. We are called with WidthxHeight = 736x576 but
> > pitch is 704, that's the width of current surface.
> > A segfault in that case should be expected :-( .
>
> Does the OSD use the same dimensions as the video stream?

No.

>  Should there
> maybe be a cDevice method for setting the dimensions?

No. We should call a separate CheckAspectdimensions() so that ouput
methods can adjust.

>
> I wonder how VDR could possibly detect the changes in dimensions,
> because the MPEG PES stream will be dropped in cDevice::Action().
> It will only be passed to instances of cRecorder.
>
> Could it be that after the "end of video stream" timeout, softdevice
> somehow requests the dimensions of the surface area to be changed?
> Note that within softdevice, playback is running; it just won't receive
> anything from vdr due to my suspend patch.

And screen blanker kicks in, with its own size.

Stefan Lucke


From marko.makela at hut.fi  Thu Sep  8 12:56:26 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 8 Sep 2005 13:56:26 +0300
Subject: [Softdevice-devel] Crash when video stream is suspended or resumed
In-Reply-To: <1126176308.432016347bfc1@webmail.in-berlin.de>
References: <20050904192000.GC3134@localhost.localdomain> <200509062356.48310.stefan@lucke.in-berlin.de> <20050907180919.GB352807@kosh.hut.fi> <200509072127.14997.stefan@lucke.in-berlin.de> <20050908080352.GC3095@localhost.localdomain> <1126170022.431ffda6b02ee@webmail.in-berlin.de> <20050908100128.GA3182@localhost.localdomain> <1126176308.432016347bfc1@webmail.in-berlin.de>
Message-ID: <20050908105626.GE3182@localhost.localdomain>

On Thu, Sep 08, 2005 at 12:45:08PM +0200, Stefan Lucke wrote:
> >  Should there
> > maybe be a cDevice method for setting the dimensions?
> 
> No. We should call a separate CheckAspectdimensions() so that ouput
> methods can adjust.

I can give it a try, but I will have to study the code first.

> > Could it be that after the "end of video stream" timeout, softdevice
> > somehow requests the dimensions of the surface area to be changed?
> > Note that within softdevice, playback is running; it just won't receive
> > anything from vdr due to my suspend patch.
> 
> And screen blanker kicks in, with its own size.

Could the screen blanker just fill the existing video surface instead of
creating a new one?

	Marko


From stefan at lucke.in-berlin.de  Thu Sep  8 13:40:01 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu,  8 Sep 2005 13:40:01 +0200
Subject: [Softdevice-devel] Crash when video stream is suspended or resumed
In-Reply-To: <20050908105626.GE3182@localhost.localdomain>
References: <20050904192000.GC3134@localhost.localdomain> <200509062356.48310.stefan@lucke.in-berlin.de> <20050907180919.GB352807@kosh.hut.fi> <200509072127.14997.stefan@lucke.in-berlin.de> <20050908080352.GC3095@localhost.localdomain> <1126170022.431ffda6b02ee@webmail.in-berlin.de> <20050908100128.GA3182@localhost.localdomain> <1126176308.432016347bfc1@webmail.in-berlin.de> <20050908105626.GE3182@localhost.localdomain>
Message-ID: <1126179601.43202311d38b6@webmail.in-berlin.de>

Quoting Marko M?kel? <marko.makela at hut.fi>:

> On Thu, Sep 08, 2005 at 12:45:08PM +0200, Stefan Lucke wrote:
> > >  Should there
> > > maybe be a cDevice method for setting the dimensions?
> >
> > No. We should call a separate CheckAspectdimensions() so that ouput
> > methods can adjust.
>
> I can give it a try, but I will have to study the code first.
>
> > > Could it be that after the "end of video stream" timeout, softdevice
> > > somehow requests the dimensions of the surface area to be changed?
> > > Note that within softdevice, playback is running; it just won't receive
> > > anything from vdr due to my suspend patch.
> >
> > And screen blanker kicks in, with its own size.
>
> Could the screen blanker just fill the existing video surface instead of
> creating a new one?

Hm, yes thats just implementing method GetOSDDimension() in video-dfb.c like
(with some small differences) in video-xv.c .

Guess thats easier.

Stefan Lucke


From marko.makela at hut.fi  Thu Sep  8 16:37:05 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 8 Sep 2005 17:37:05 +0300
Subject: [Softdevice-devel] Crash when video stream is suspended or resumed
In-Reply-To: <1126179601.43202311d38b6@webmail.in-berlin.de>
References: <20050904192000.GC3134@localhost.localdomain> <200509062356.48310.stefan@lucke.in-berlin.de> <20050907180919.GB352807@kosh.hut.fi> <200509072127.14997.stefan@lucke.in-berlin.de> <20050908080352.GC3095@localhost.localdomain> <1126170022.431ffda6b02ee@webmail.in-berlin.de> <20050908100128.GA3182@localhost.localdomain> <1126176308.432016347bfc1@webmail.in-berlin.de> <20050908105626.GE3182@localhost.localdomain> <1126179601.43202311d38b6@webmail.in-berlin.de>
Message-ID: <20050908143705.GA2724@kosh.hut.fi>

On Thu, Sep 08, 2005 at 01:40:01PM +0200, Stefan Lucke wrote:
> > Could the screen blanker just fill the existing video surface instead of
> > creating a new one?
> 
> Hm, yes thats just implementing method GetOSDDimension() in video-dfb.c like
> (with some small differences) in video-xv.c .

I copied the method body verbatim to video-dfb.c.  All referenced member
variables are defined in video.h.  I wonder why video-fb.c implements the
method differently.

With the attached patch, I was unable to crash softdevice.  I'll test
a bit further with and without this patch.  I'll also test the rewind
crash bug without HAVE_SetSourceLocation.

	Marko
-------------- next part --------------
Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.39
diff -p -u -r1.39 video-dfb.c
--- video-dfb.c	4 Sep 2005 05:49:18 -0000	1.39
+++ video-dfb.c	8 Sep 2005 14:32:20 -0000
@@ -1033,6 +1033,22 @@ void cDFBVideoOut::Refresh()
 
 /* ---------------------------------------------------------------------------
  */
+
+void cDFBVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight) {
+   switch (current_osdMode) {
+      case OSDMODE_PSEUDO :
+                OsdWidth=lwidth;//*9/10;
+                OsdHeight=lheight;//*9/10;
+             break;
+      case OSDMODE_SOFTWARE:
+                OsdWidth=swidth;//*9/10;
+                OsdHeight=sheight;//*9/10;
+             break;
+    };
+};
+
+/* ---------------------------------------------------------------------------
+ */
 void cDFBVideoOut::CloseOSD()
 {
     IDirectFBSurface  *tmpSurface;
Index: video-dfb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.h,v
retrieving revision 1.10
diff -p -u -r1.10 video-dfb.h
--- video-dfb.h	4 Sep 2005 05:49:18 -0000	1.10
+++ video-dfb.h	8 Sep 2005 14:32:20 -0000
@@ -54,6 +54,7 @@ class cDFBVideoOut : public cVideoOut {
     virtual void OpenOSD(int x, int y);
 
 #if VDRVERSNUM >= 10307
+    virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight);
     virtual void Refresh(cBitmap *Bitmap);
     virtual void OSDStart();
     virtual void OSDCommit();

From marko.makela at hut.fi  Thu Sep  8 16:51:18 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 8 Sep 2005 17:51:18 +0300
Subject: [Softdevice-devel] Crash when video stream is suspended or resumed
In-Reply-To: <20050908143705.GA2724@kosh.hut.fi>
References: <200509062356.48310.stefan@lucke.in-berlin.de> <20050907180919.GB352807@kosh.hut.fi> <200509072127.14997.stefan@lucke.in-berlin.de> <20050908080352.GC3095@localhost.localdomain> <1126170022.431ffda6b02ee@webmail.in-berlin.de> <20050908100128.GA3182@localhost.localdomain> <1126176308.432016347bfc1@webmail.in-berlin.de> <20050908105626.GE3182@localhost.localdomain> <1126179601.43202311d38b6@webmail.in-berlin.de> <20050908143705.GA2724@kosh.hut.fi>
Message-ID: <20050908145118.GB2724@kosh.hut.fi>

On Thu, Sep 08, 2005 at 05:37:05PM +0300, Marko M?kel? wrote:
> With the attached patch, I was unable to crash softdevice.  I'll test
> a bit further with and without this patch.  I'll also test the rewind
> crash bug without HAVE_SetSourceLocation.

I have been unable to repeat the crash today, with or without the
patch.  I keep trying.  Hopefully it will crash straight after a
reboot.

The rewind crash does not occur in either state of
HAVE_SetSourceLocation.

	Marko


From stefan at lucke.in-berlin.de  Thu Sep  8 17:04:59 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu,  8 Sep 2005 17:04:59 +0200
Subject: [Softdevice-devel] Crash when video stream is suspended or resumed
In-Reply-To: <20050908143705.GA2724@kosh.hut.fi>
References: <20050904192000.GC3134@localhost.localdomain> <200509062356.48310.stefan@lucke.in-berlin.de> <20050907180919.GB352807@kosh.hut.fi> <200509072127.14997.stefan@lucke.in-berlin.de> <20050908080352.GC3095@localhost.localdomain> <1126170022.431ffda6b02ee@webmail.in-berlin.de> <20050908100128.GA3182@localhost.localdomain> <1126176308.432016347bfc1@webmail.in-berlin.de> <20050908105626.GE3182@localhost.localdomain> <1126179601.43202311d38b6@webmail.in-berlin.de> <20050908143705.GA2724@kosh.hut.fi>
Message-ID: <1126191899.4320531b8d1e0@webmail.in-berlin.de>

Quoting Marko M?kel? <marko.makela at hut.fi>:

> On Thu, Sep 08, 2005 at 01:40:01PM +0200, Stefan Lucke wrote:
> > > Could the screen blanker just fill the existing video surface instead of
> > > creating a new one?
> >
> > Hm, yes thats just implementing method GetOSDDimension() in video-dfb.c like
> > (with some small differences) in video-xv.c .
>
> I copied the method body verbatim to video-dfb.c.  All referenced member
> variables are defined in video.h.  I wonder why video-fb.c implements the
> method differently.
>
> With the attached patch, I was unable to crash softdevice.  I'll test
> a bit further with and without this patch.  I'll also test the rewind
> crash bug without HAVE_SetSourceLocation.

Without HAVE_SetSourceLocation your version my crash again. Thats what I ment
by "some small differences":
-- snip --
#if VDRVERSNUM >= 10307
/* ---------------------------------------------------------------------------
 */
void cDFBVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight)
{
#if HAVE_SetSourceLocation
      OsdWidth   = fwidth;
      OsdHeight  = fheight;
#else
      if (useStretchBlit)
      {
        OsdWidth   = fwidth;
        OsdHeight  = fheight;
      }
      else
      {
        OsdWidth   = swidth;
        OsdHeight  = sheight;
      }
#endif
}

#endif
-- snip --


Stefan Lucke


From marko.makela at hut.fi  Thu Sep  8 17:45:44 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 8 Sep 2005 18:45:44 +0300
Subject: [Softdevice-devel] Crash when video stream is suspended or resumed
In-Reply-To: <1126191899.4320531b8d1e0@webmail.in-berlin.de>
References: <20050907180919.GB352807@kosh.hut.fi> <200509072127.14997.stefan@lucke.in-berlin.de> <20050908080352.GC3095@localhost.localdomain> <1126170022.431ffda6b02ee@webmail.in-berlin.de> <20050908100128.GA3182@localhost.localdomain> <1126176308.432016347bfc1@webmail.in-berlin.de> <20050908105626.GE3182@localhost.localdomain> <1126179601.43202311d38b6@webmail.in-berlin.de> <20050908143705.GA2724@kosh.hut.fi> <1126191899.4320531b8d1e0@webmail.in-berlin.de>
Message-ID: <20050908154544.GA12566@kosh.hut.fi>

On Thu, Sep 08, 2005 at 05:04:59PM +0200, Stefan Lucke wrote:
> Without HAVE_SetSourceLocation your version my crash again. Thats what I ment
> by "some small differences":
> -- snip --
> #if VDRVERSNUM >= 10307
> /* ---------------------------------------------------------------------------
>  */
> void cDFBVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight)
> {
> #if HAVE_SetSourceLocation
>       OsdWidth   = fwidth;
>       OsdHeight  = fheight;
> #else
>       if (useStretchBlit)
>       {
>         OsdWidth   = fwidth;
>         OsdHeight  = fheight;
>       }
>       else
>       {
>         OsdWidth   = swidth;
>         OsdHeight  = sheight;
>       }
> #endif
> }
> 
> #endif
> -- snip --

Thanks! Meanwhile, I figured out a way to repeat the bug. It never crashed
today until I mapped DIET_KEYREPEAT to a keypress event. I then hit
Suspend and pushed OK (to make OSD go on and off at about 177 ms
intervals; I'm using the classic skin) until softdevice blanked the screen.
Without my patch, it always crashed (well, 3 out of 3 tries).  I'll try
again without HAVE_SetSourceLocation on my patch, and then your patch with
both settings.

	Marko


From marko.makela at hut.fi  Thu Sep  8 18:13:51 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 8 Sep 2005 19:13:51 +0300
Subject: [Softdevice-devel] Crash when video stream is suspended or resumed
In-Reply-To: <1126191899.4320531b8d1e0@webmail.in-berlin.de>
References: <20050907180919.GB352807@kosh.hut.fi> <200509072127.14997.stefan@lucke.in-berlin.de> <20050908080352.GC3095@localhost.localdomain> <1126170022.431ffda6b02ee@webmail.in-berlin.de> <20050908100128.GA3182@localhost.localdomain> <1126176308.432016347bfc1@webmail.in-berlin.de> <20050908105626.GE3182@localhost.localdomain> <1126179601.43202311d38b6@webmail.in-berlin.de> <20050908143705.GA2724@kosh.hut.fi> <1126191899.4320531b8d1e0@webmail.in-berlin.de>
Message-ID: <20050908161351.GB12566@kosh.hut.fi>

On Thu, Sep 08, 2005 at 05:04:59PM +0200, Stefan Lucke wrote:
> Without HAVE_SetSourceLocation your version my crash again. Thats what I ment
> by "some small differences":

I was unable to get my patched version to crash, but I didn't try
with useStretchBlit.  Of course, you know better than me the
purpose of all the cVideoOut member variables.

However, your patched version always crashes in cVideoOut::Action(),
on the line osd->Flush(), presumably when the OSD (showing the
information of the current program) is to be closed.  The command
line for repeating this is "vdr --suspend -Psoftdevice" (obviously,
with my suspend patch applied to vdr), or just "vdr -Psoftdevice".
In both cases, the video overlay will remain black.  The crash
occurs both with and without HAVE_SetSourceLocation.

I'm running vdr 1.3.31 with my suspend patch as well as the
patches from subtitles-0.3.8 and the avoid-trashing patch.

My version of your patch is attached.  I moved the method
definition to an existing #if VDRVERSNUM >= 10307 block.

	Marko
-------------- next part --------------
Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.39
diff -p -u -r1.39 video-dfb.c
--- video-dfb.c	4 Sep 2005 05:49:18 -0000	1.39
+++ video-dfb.c	8 Sep 2005 16:00:53 -0000
@@ -945,6 +945,27 @@ void cDFBVideoOut::OSDCommit()
 {
   OSDdirty=false;
   OSDpresent = true;
+}
+
+/* ---------------------------------------------------------------------------
+ */
+void cDFBVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight)
+{
+#if HAVE_SetSourceLocation
+      OsdWidth   = fwidth;
+      OsdHeight  = fheight;
+#else
+      if (useStretchBlit)
+      {
+        OsdWidth   = fwidth;
+        OsdHeight  = fheight;
+      }
+      else
+      {
+        OsdWidth   = swidth;
+        OsdHeight  = sheight;
+      }
+#endif
 }
 
 /* ---------------------------------------------------------------------------
Index: video-dfb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.h,v
retrieving revision 1.10
diff -p -u -r1.10 video-dfb.h
--- video-dfb.h	4 Sep 2005 05:49:18 -0000	1.10
+++ video-dfb.h	8 Sep 2005 16:00:53 -0000
@@ -54,6 +54,7 @@ class cDFBVideoOut : public cVideoOut {
     virtual void OpenOSD(int x, int y);
 
 #if VDRVERSNUM >= 10307
+    virtual void GetOSDDimension(int &OsdWidth,int &OsdHeight);
     virtual void Refresh(cBitmap *Bitmap);
     virtual void OSDStart();
     virtual void OSDCommit();

From marko.makela at HUT.FI  Thu Sep  8 18:20:51 2005
From: marko.makela at HUT.FI (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 8 Sep 2005 19:20:51 +0300
Subject: [Softdevice-devel] Crash when video stream is suspended or resumed
In-Reply-To: <1126191899.4320531b8d1e0@webmail.in-berlin.de>
References: <20050907180919.GB352807@kosh.hut.fi> <200509072127.14997.stefan@lucke.in-berlin.de> <20050908080352.GC3095@localhost.localdomain> <1126170022.431ffda6b02ee@webmail.in-berlin.de> <20050908100128.GA3182@localhost.localdomain> <1126176308.432016347bfc1@webmail.in-berlin.de> <20050908105626.GE3182@localhost.localdomain> <1126179601.43202311d38b6@webmail.in-berlin.de> <20050908143705.GA2724@kosh.hut.fi> <1126191899.4320531b8d1e0@webmail.in-berlin.de>
Message-ID: <20050908162051.GC12566@kosh.hut.fi>

On Thu, Sep 08, 2005 at 05:04:59PM +0200, Stefan Lucke wrote:
> -- snip --
> #if VDRVERSNUM >= 10307
> /* ---------------------------------------------------------------------------
>  */
> void cDFBVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight)
> {
> #if HAVE_SetSourceLocation
>       OsdWidth   = fwidth;
>       OsdHeight  = fheight;
> #else
>       if (useStretchBlit)
>       {
>         OsdWidth   = fwidth;
>         OsdHeight  = fheight;
>       }
>       else
>       {
>         OsdWidth   = swidth;
>         OsdHeight  = sheight;
>       }
> #endif
> }
> 
> #endif
> -- snip --

On my system, the f and s dimensions are 720x576 while
the l dimensions are 768x576.  (I used OSDMODE_PSEUDO
when testing my patch.)  We have a lot of 16:9 footage.
Maybe this explains the crash on your patch?

	Marko


From marko.makela at hut.fi  Thu Sep  8 21:03:13 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 8 Sep 2005 22:03:13 +0300
Subject: [Softdevice-devel] Crash when video stream is suspended or resumed
In-Reply-To: <20050908162051.GC12566@kosh.hut.fi>
References: <200509072127.14997.stefan@lucke.in-berlin.de> <20050908080352.GC3095@localhost.localdomain> <1126170022.431ffda6b02ee@webmail.in-berlin.de> <20050908100128.GA3182@localhost.localdomain> <1126176308.432016347bfc1@webmail.in-berlin.de> <20050908105626.GE3182@localhost.localdomain> <1126179601.43202311d38b6@webmail.in-berlin.de> <20050908143705.GA2724@kosh.hut.fi> <1126191899.4320531b8d1e0@webmail.in-berlin.de> <20050908162051.GC12566@kosh.hut.fi>
Message-ID: <20050908190313.GA3122@localhost.localdomain>

On Thu, Sep 08, 2005 at 07:20:51PM +0300, Marko M?kel? wrote:
> On my system, the f and s dimensions are 720x576 while
> the l dimensions are 768x576.  (I used OSDMODE_PSEUDO
> when testing my patch.)  We have a lot of 16:9 footage.
> Maybe this explains the crash on your patch?

When I tried to shut down my vdr box, I got two crashes and
restarts.  On the third time, when I had attached gdb to the vdr
process, the shutdown by suspend worked. :-(  I wish I
knew why core files are very rarely created.

The almost only way for me to get a core file is "make plugins"
while vdr is running.  I guess that those crashes could be avoided
by rm PLUGINS/lib/libvdr-* before make, so that the new libraries
will have different inode numbers.

	Marko


From M.Wache at gmx.net  Fri Sep  9 08:40:26 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Fri, 09 Sep 2005 08:40:26 +0200
Subject: [Softdevice-devel] Crash when video stream is suspended or resumed
In-Reply-To: <1126191899.4320531b8d1e0@webmail.in-berlin.de>
References: <20050904192000.GC3134@localhost.localdomain> <200509062356.48310.stefan@lucke.in-berlin.de> <20050907180919.GB352807@kosh.hut.fi> <200509072127.14997.stefan@lucke.in-berlin.de> <20050908080352.GC3095@localhost.localdomain> <1126170022.431ffda6b02ee@webmail.in-berlin.de> <20050908100128.GA3182@localhost.localdomain> <1126176308.432016347bfc1@webmail.in-berlin.de> <20050908105626.GE3182@localhost.localdomain> <1126179601.43202311d38b6@webmail.in-berlin.de> <20050908143705.GA2724@kosh.hut.fi> <1126191899.4320531b8d1e0@webmail.in-berlin.de>
Message-ID: <43212E5A.1020406@gmx.net>

Stefan Lucke schrieb:

> Without HAVE_SetSourceLocation your version my crash again. Thats what I ment
> by "some small differences":
> -- snip --
> #if VDRVERSNUM >= 10307
> /* ---------------------------------------------------------------------------
>  */
> void cDFBVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight)
> {
> #if HAVE_SetSourceLocation
>       OsdWidth   = fwidth;
>       OsdHeight  = fheight;
> #else
>       if (useStretchBlit)
>       {
>         OsdWidth   = fwidth;
>         OsdHeight  = fheight;
>       }
>       else
>       {
>         OsdWidth   = swidth;
>         OsdHeight  = sheight;
>       }
> #endif
> }
> 
> #endif
> -- snip --
> 

I don't like this fix very much, since it may have side effects.
GetOSDDimension is used to determine the dimensions to which the OSD is
scaled, and I don't think you want to have a scaled OSD.
I think the better way would be to check the dimensions of the video
layer in YUV() and be shure only to copy that part of the picture which
fits.
That would also prevent crashes when the signal qualtiy is bad and
ffmpeg decodes var too big images. I had a few of these crashed some
time ago but the latest ffmpeg version seems to be more stable now.

Martin


From stefan at lucke.in-berlin.de  Fri Sep  9 09:42:42 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri,  9 Sep 2005 09:42:42 +0200
Subject: [Softdevice-devel] Crash when video stream is suspended or resumed
In-Reply-To: <43212E5A.1020406@gmx.net>
References: <20050904192000.GC3134@localhost.localdomain> <200509062356.48310.stefan@lucke.in-berlin.de> <20050907180919.GB352807@kosh.hut.fi> <200509072127.14997.stefan@lucke.in-berlin.de> <20050908080352.GC3095@localhost.localdomain> <1126170022.431ffda6b02ee@webmail.in-berlin.de> <20050908100128.GA3182@localhost.localdomain> <1126176308.432016347bfc1@webmail.in-berlin.de> <20050908105626.GE3182@localhost.localdomain> <1126179601.43202311d38b6@webmail.in-berlin.de> <20050908143705.GA2724@kosh.hut.fi> <1126191899.4320531b8d1e0@webmail.in-berlin.de> <43212E5A.1020406@gmx.net>
Message-ID: <1126251762.43213cf2366de@webmail.in-berlin.de>

Quoting Martin Wache <M.Wache at gmx.net>:

> Stefan Lucke schrieb:
>
> > Without HAVE_SetSourceLocation your version my crash again. Thats what I ment
> > by "some small differences":
> > -- snip --
> > #if VDRVERSNUM >= 10307
> > /* ---------------------------------------------------------------------------
> >  */
> > void cDFBVideoOut::GetOSDDimension(int &OsdWidth,int &OsdHeight)
> > {
> > #if HAVE_SetSourceLocation
> >       OsdWidth   = fwidth;
> >       OsdHeight  = fheight;
> > #else
> >       if (useStretchBlit)
> >       {
> >         OsdWidth   = fwidth;
> >         OsdHeight  = fheight;
> >       }
> >       else
> >       {
> >         OsdWidth   = swidth;
> >         OsdHeight  = sheight;
> >       }
> > #endif
> > }
> >
> > #endif
> > -- snip --
> >
>
> I don't like this fix very much, since it may have side effects.
> GetOSDDimension is used to determine the dimensions to which the OSD is
> scaled, and I don't think you want to have a scaled OSD.

Yes, I think the original idea of having a separate CheckAspectDimensions()
is better. This check function is essential for calling YUV().
There is another point that is not ok to my opinion.
osdMutex is held to long.

There should be a separate mutex which protects area specific stuff

> I think the better way would be to check the dimensions of the video
> layer in YUV() and be shure only to copy that part of the picture which
> fits.

The sequence from CheckAspectDimensions() to YUV belongs together.

> That would also prevent crashes when the signal qualtiy is bad and
> ffmpeg decodes var too big images. I had a few of these crashed some
> time ago but the latest ffmpeg version seems to be more stable now.
>
> Martin

Stefan Lucke


From marko.makela at hut.fi  Fri Sep  9 10:32:01 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 9 Sep 2005 11:32:01 +0300
Subject: [Softdevice-devel] Crash when video stream is suspended or resumed
In-Reply-To: <1126251762.43213cf2366de@webmail.in-berlin.de>
References: <20050908080352.GC3095@localhost.localdomain> <1126170022.431ffda6b02ee@webmail.in-berlin.de> <20050908100128.GA3182@localhost.localdomain> <1126176308.432016347bfc1@webmail.in-berlin.de> <20050908105626.GE3182@localhost.localdomain> <1126179601.43202311d38b6@webmail.in-berlin.de> <20050908143705.GA2724@kosh.hut.fi> <1126191899.4320531b8d1e0@webmail.in-berlin.de> <43212E5A.1020406@gmx.net> <1126251762.43213cf2366de@webmail.in-berlin.de>
Message-ID: <20050909083201.GB3591@localhost.localdomain>

On Fri, Sep 09, 2005 at 09:42:42AM +0200, Stefan Lucke wrote:
> Quoting Martin Wache <M.Wache at gmx.net>:
> > I don't like this fix very much, since it may have side effects.
> > GetOSDDimension is used to determine the dimensions to which the OSD is
> > scaled, and I don't think you want to have a scaled OSD.
> 
> Yes, I think the original idea of having a separate CheckAspectDimensions()
> is better. This check function is essential for calling YUV().
> There is another point that is not ok to my opinion.
> osdMutex is held to long.
> 
> There should be a separate mutex which protects area specific stuff

This sounds like I will have to trust you to make the necessary
modifications.  If there is anything I can do to help (e.g., testing),
please let me know.

It would be nice to have a high-level description of the thread
architecture.  The verbal description could be translated into a
abstract formal model, which could be examined by a model checking tool
to locate deadlocks, race conditions and other hard-to-reproduce
bugs.  I became familiar with this area in my post-graduate studies.

	Marko


From marko.makela at hut.fi  Fri Sep  9 20:54:14 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 9 Sep 2005 21:54:14 +0300
Subject: [Softdevice-devel] [PATCH] Avoid vdr crash in "make plugins"
Message-ID: <20050909185414.GC279751@kosh.hut.fi>

The attached patch fixes the Makefile so that existing softdevice
library files in PLUGINS/lib will not be overwritten but replaced.

On my system, if the plugin library files change while vdr is running,
vdr will crash at seemingly random places that do not seem to have anything
to do with the plugins.  I think that it is better to explicitly restart
vdr in order to load the new plugins, because in that way vdr will warn if
there are active timed recordings.

You may want to write @- instead of grouping the statements, but I wanted
to save one /bin/sh invocation per rule.

	Marko
-------------- next part --------------
Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.14
diff -u -r1.14 Makefile
--- Makefile	15 Jul 2005 20:42:16 -0000	1.14
+++ Makefile	9 Sep 2005 18:28:21 -0000
@@ -245,25 +245,25 @@
 
 libvdr-$(PLUGIN).so: $(OBJS)
 	$(CXX) $(CXXFLAGS) -shared $(OBJS) $(LIBS) -o $@
-	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
+	@rm -f $(LIBDIR)/$@.$(VDRVERSION); cp $@ $(LIBDIR)/$@.$(VDRVERSION)
 
 ifdef USE_SUBPLUGINS
 
 libvdr-$(PLUGIN)-dfb.so: $(DFB_OBJS)
 	$(CXX) $(CXXFLAGS) -shared $(DFB_OBJS) $(DFB_LIBS) -o $@
-	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
+	@rm -f $(LIBDIR)/$@.$(VDRVERSION); cp $@ $(LIBDIR)/$@.$(VDRVERSION)
 
 libvdr-$(PLUGIN)-fb.so: $(FB_OBJS)
 	$(CXX) $(CXXFLAGS) -shared $(FB_OBJS) $(FB_LIBS) -o $@
-	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
+	@rm -f $(LIBDIR)/$@.$(VDRVERSION); cp $@ $(LIBDIR)/$@.$(VDRVERSION)
 
 libvdr-$(PLUGIN)-xv.so: $(XV_OBJS)
 	$(CXX) $(CXXFLAGS) -shared $(XV_OBJS) $(XV_LIBS) -o $@
-	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
+	@rm -f $(LIBDIR)/$@.$(VDRVERSION); cp $@ $(LIBDIR)/$@.$(VDRVERSION)
 
 libvdr-$(PLUGIN)-vidix.so: $(VIDIX_OBJS)
 	$(CXX) $(CXXFLAGS) -shared $(VIDIX_OBJS) $(VIDIX_LIBS) -o $@
-	@cp $@ $(LIBDIR)/$@.$(VDRVERSION)
+	@rm -f $(LIBDIR)/$@.$(VDRVERSION); cp $@ $(LIBDIR)/$@.$(VDRVERSION)
 
 endif
 

From marko.makela at hut.fi  Sat Sep 10 08:44:45 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sat, 10 Sep 2005 09:44:45 +0300
Subject: [Softdevice-devel] Crash when fast-skipping a recording
Message-ID: <20050910064445.GA409179@kosh.hut.fi>

It seems that the crash bug that disturbs the use of my
vdr-suspend patch can also be triggered by skipping a
88-minute 16:9 recording in 1-minute steps at 33 ms
keyrepeat rate.  (After some kernel hacking last night,
I found out that ir-common.ko uses the default input.ko
keyrepeat timer instead of mapping RC5 frames (which are
sent every 177 ms) to keyrepeat events.)

If I press OK to activate the timestamp display on the
"classic vdr" theme and then keep the Yellow or Green key
pressed down while watching this particular 16:9 recording,
softdevice will often crash.

First time, I didn't get a stack trace, but the second
time I got one.  Third time, I wasn't able to repeat.
Interestingly, after some 5 or 10 seconds of skipping
going on at the 33 ms keyrepeat rate, softdevice would
only play audio frames every now and then.  It would stop
updating the video and eventually blank the video overlay.
Maybe this is what caused the crash in the first place?
(Sorry, this bug doesn't always occur, and I don't remember
exactly what the screen looked like during the crashes.)

The aspect ratio remains constant throughout this recording.

In case it makes any difference: softdevice is unable to
open /dev/rtc.

Here is the stack trace:

#0  0xb7cfd5ef in memcpy () from /lib/tls/libc.so.6
No symbol table info available.
#1  0xb7929daf in cDFBVideoOut::YUV (this=0x8296df8, Py=0xb4e90808 "", Pu=0x82b4ab0 "", 
    Pv=0x82ce750 '\177' <repeats 200 times>..., Width=736, Height=576, Ystride=736, 
    UVstride=368) at video-dfb.c:1166
	dst = (uint8_t *) 0xb5e94ea0 <Address 0xb5e94ea0 out of bounds>
	pitch = 704
	hi = 137160880
#2  0xb791b15f in cVideoOut::Action (this=0x8296df8) at video.c:107
	newOsdWidth = 736
	newOsdHeight = 576
	changeMode = false
#3  0x080f1c32 in cThread::StartThread (Thread=0x8296df8) at thread.c:234
No locals.
#4  0xb7ee7ccd in start_thread () from /lib/tls/libpthread.so.0
No symbol table info available.
#5  0xb7d5fb0e in clone () from /lib/tls/libc.so.6
No symbol table info available.

Compare it to a previous stack trace that occurred after hitting the
Suspend key (of my vdr-suspend patch):

#0  0xb7d755ef in memcpy () from /lib/tls/libc.so.6
No symbol table info available.
#1  0xb79a1daf in cDFBVideoOut::YUV (this=0x827c410, Py=0xb4ef8808 "", Pu=0x829bbb8 "", 
    Pv=0x82b5858 '\177' <repeats 200 times>..., Width=736, Height=576, Ystride=736, 
    UVstride=368) at video-dfb.c:1166
	dst = (uint8_t *) 0xb5f06ea0 <Address 0xb5f06ea0 out of bounds>
	pitch = 704
	hi = 137058744
#2  0xb799315f in cVideoOut::Action (this=0x827c410) at video.c:107
	newOsdWidth = 736
	newOsdHeight = 576
	changeMode = false
#3  0x080f1c32 in cThread::StartThread (Thread=0x827c410) at thread.c:234
No locals.
#4  0xb7f5fccd in start_thread () from /lib/tls/libpthread.so.0
No symbol table info available.
#5  0xb7dd7b0e in clone () from /lib/tls/libc.so.6
No symbol table info available.

Note that in cDFBVideoOut::YUV(), the local variable "hi" is garbage
in both cases.

One more thing: I have got some crashes when starting to view a
recording while the disk containing it is spun down.  VDR would crash
while the disk is spinning up.  This occurs quite rarely, and I have
been unable to get a stack trace.  I believe that those crashes could
be due to this same bug.

	Marko


From stefan at lucke.in-berlin.de  Sat Sep 10 14:43:45 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 10 Sep 2005 14:43:45 +0200
Subject: [Softdevice-devel] Crash when fast-skipping a recording
In-Reply-To: <20050910064445.GA409179@kosh.hut.fi>
References: <20050910064445.GA409179@kosh.hut.fi>
Message-ID: <200509101443.45684.stefan@lucke.in-berlin.de>

On Samstag, 10. September 2005 08:44, Marko M?kel? wrote:

Short form :

Both crashes are caused by the same bug. So I really should fix this.
In both cases YUV() is called from video.c line 107 with dimensions
that do not fit into the current surface size :-( .

-- 
Stefan Lucke



From marko.makela at hut.fi  Sat Sep 10 15:41:08 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sat, 10 Sep 2005 16:41:08 +0300
Subject: [Softdevice-devel] Crash when fast-skipping a recording
In-Reply-To: <200509101443.45684.stefan@lucke.in-berlin.de>
References: <20050910064445.GA409179@kosh.hut.fi> <200509101443.45684.stefan@lucke.in-berlin.de>
Message-ID: <20050910134108.GC3147@localhost.localdomain>

On Sat, Sep 10, 2005 at 02:43:45PM +0200, Stefan Lucke wrote:
> On Samstag, 10. September 2005 08:44, Marko M?kel? wrote:
> 
> Short form :
> 
> Both crashes are caused by the same bug. So I really should fix this.
> In both cases YUV() is called from video.c line 107 with dimensions
> that do not fit into the current surface size :-( .

Thanks, I look forward to testing your fix.  I'll then report another
crash bug on the following day. :-)

	Marko


From stefan at lucke.in-berlin.de  Sat Sep 10 16:37:45 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 10 Sep 2005 16:37:45 +0200
Subject: [Softdevice-devel] Crash when fast-skipping a recording
In-Reply-To: <20050910134108.GC3147@localhost.localdomain>
References: <20050910064445.GA409179@kosh.hut.fi> <200509101443.45684.stefan@lucke.in-berlin.de> <20050910134108.GC3147@localhost.localdomain>
Message-ID: <200509101637.45529.stefan@lucke.in-berlin.de>

On Samstag, 10. September 2005 15:41, Marko M?kel? wrote:
> On Sat, Sep 10, 2005 at 02:43:45PM +0200, Stefan Lucke wrote:
> > On Samstag, 10. September 2005 08:44, Marko M?kel? wrote:
> > 
> > Short form :
> > 
> > Both crashes are caused by the same bug. So I really should fix this.
> > In both cases YUV() is called from video.c line 107 with dimensions
> > that do not fit into the current surface size :-( .
> 
> Thanks, I look forward to testing your fix.  I'll then report another
> crash bug on the following day. :-)
> 

Ok, here we go.

-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: crash-line-107-fix-00.diff
Type: text/x-diff
Size: 6238 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050910/3f5c9597/attachment.diff>

From stefan at lucke.in-berlin.de  Sat Sep 10 22:24:10 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 10 Sep 2005 22:24:10 +0200
Subject: [Softdevice-devel] configure now in cvs (WAS: Re: Softdevice-0.1.3 & i18n fix)
In-Reply-To: <Pine.OSF.4.61.0509102105170.321305@kosh.hut.fi>
References: <200507242253.52865.stefan@lucke.in-berlin.de> <200509101816.02891.stefan@lucke.in-berlin.de> <Pine.OSF.4.61.0509102105170.321305@kosh.hut.fi>
Message-ID: <200509102224.10610.stefan@lucke.in-berlin.de>

On Samstag, 10. September 2005 20:08, Rolf Ahrenberg wrote:
> On Sat, 10 Sep 2005, Stefan Lucke wrote:
> 
> Thanks. BTW, any news about Makefile rewrite? I'd like to use
> SOFTDEVICE_USE_DFB/FB/VIDIX/XV define in my Make.config and library
> paths detected automatically by pkg-config.

A simple configure script is now in cvs.
With vidix there is no vidix.pc file whitch could be checked for. So 
a path to vidix is hard coded int configure too.

There are some TODOS like the whole --enable / -- disable stuff.

DirectFB and ffmpeg stuff is done via pkg-config.

The rule is, and should be to be my opinion, that all available
output methods which present at the build system, should be build when
not explict disabled (TODO). But this has to be done via configure.

Hopefully we get some comments, that is bug reports including a fix/patch,
on this :-) .

-- 
Stefan Lucke



From marko.makela at hut.fi  Sun Sep 11 10:14:36 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sun, 11 Sep 2005 11:14:36 +0300
Subject: [Softdevice-devel] Crash while recording and playing live program
In-Reply-To: <20050910134108.GC3147@localhost.localdomain>
References: <20050910064445.GA409179@kosh.hut.fi> <200509101443.45684.stefan@lucke.in-berlin.de> <20050910134108.GC3147@localhost.localdomain>
Message-ID: <20050911081436.GA441501@kosh.hut.fi>

On Sat, Sep 10, 2005 at 04:41:08PM +0300, Marko M?kel? wrote:
> Thanks, I look forward to testing your fix.  I'll then report another
> crash bug on the following day. :-)

As promised, here it is.  vdr was recording and viewing the same program.
Before the crash, a recording was watched for maybe 30 minutes.  Then
vdr was suspended for maybe an hour.  During that time, the timed recording
started.  Then I resumed vdr playback and switched to the program.  The
program was shown for about 5 minutes.  I didn't touch the remote control
during that time, so it shouldn't be OSD related at this time.

Luckily, I got a core dump this time.  See the attached two dumps of
the stack trace.  For some reason, "bt full" truncates the trace.
Could it be a double free() call?  Has anyone run softdevice under
Valgrind?  (Should I try, or will it be hopelessly slow?)

I have saved the stderr output in case it will help troubleshooting.
I normally log stderr to /tmp, which lives on shmfs.

	Marko
-------------- next part --------------
(gdb) bt full
#0  0xb7d15e8c in free () from /lib/tls/libc.so.6
No symbol table info available.
#1  0xb77a3b0d in fusion_shfree () from /usr/local/lib/libfusion-0.9.so.22
No symbol table info available.
#2  0xb77e2dd1 in dfb_surfacemanager_destroy () from /usr/local/lib/libdirectfb-0.9.so.22
No symbol table info available.
#3  0xb77d40a3 in dfb_gfxcard_shutdown () from /usr/local/lib/libdirectfb-0.9.so.22
No symbol table info available.
#4  0xb77d38e0 in dfb_core_part_shutdown () from /usr/local/lib/libdirectfb-0.9.so.22
No symbol table info available.
#5  0xb77d336c in dfb_core_shutdown () from /usr/local/lib/libdirectfb-0.9.so.22
No symbol table info available.
#6  0xb77d3522 in dfb_core_arena_shutdown () from /usr/local/lib/libdirectfb-0.9.so.22
No symbol table info available.
#7  0xb77a3901 in fusion_arena_exit () from /usr/local/lib/libfusion-0.9.so.22
No symbol table info available.
#8  0xb77d2c79 in dfb_core_destroy () from /usr/local/lib/libdirectfb-0.9.so.22
No symbol table info available.
#9  0xb77d3316 in dfb_core_signal_handler () from /usr/local/lib/libdirectfb-0.9.so.22
No symbol table info available.
#10 0xb779e8b7 in signal_handler () from /usr/local/lib/libdirect-0.9.so.22
No symbol table info available.
#11 <signal handler called>
No symbol table info available.
#12 0xb77e11ad in dfb_surface_soft_lock () from /usr/local/lib/libdirectfb-0.9.so.22
No symbol table info available.
#13 0xb77b3cc0 in IDirectFBSurface_Lock () from /usr/local/lib/libdirectfb-0.9.so.22
No symbol table info available.
#14 0xb77fb45e in IDirectFBSurface::Lock (this=0x2, flags=2998006340, ptr=0xb2b1f244, 
    pitch=0xb2b1f244) at idirectfbsurface.cpp:116
	ret = 48758540
#15 0xb7949e00 in cDFBVideoOut::YUV (this=0x8286050, 
    Py=0xb0e89008 "\021\021\021\020\020\020\020\020\020\020\020\020\020\021\021\022\017\016\017\020\021\017\020\021\020\017\020\020\021\023\024\023\022\022\023\022\021\021\020\020\020\020\020\017\017\017\020\020\021\021\021\020\020\017\017\016\016\017\020\022\023\023\022\022\020\017\017\017\017\020\020\020\021\021\020\021\022\022\022\022\020\021\020\020\021\021\021\022\022\022\022\022\023\023\023\022\023\023\022", '\021' <repeats 11 times>, "\020\020\021\021\021\021\021\022\022\022\022\021\020\020\021\021\022\022\021\021\022\021\022\022\021\020\020\020\021\021\021\021\020\020\020\020\020\020\021\021\020\017\020\021\022\022\021\020\021\021\021\020\017\017\017\r\016\r\017\017\016\r\r\r\r\016\020\021\021\020\020\020\020\021\021\021\021\021\020\020\020\020\017\r\r\016\016\016\r\r"..., 
    Pu=0xb0eec008 "\200\200\200\200\200\201\201\201\201\201\201\201\201\201\200~\200~\177\177\200\200\200\200\201\201\200\200\177\177\177\177~\177\177\200\200\201\200\201\200\200\200\200\200\200\200", '\201' <repeats 17 times>, "\200\200\200\177\200\200\201\200\200\200\200\201\201\201\200\177\202\202\201\201\201\201\202\202", '\200' <repeats 17 times>, "\177\177\200\200\200\201\200~}~~\177~\200~\200\177\177\200\201\200\201\202\200\200\200\200\200\201\200\200\177\200\200\200\200\200\200\200\201\201\201\201\201\201\201\200\200\200\200\200\200\200\201\201\201\201\201\200\200", '\201' <repeats 19 times>, "\200\200\200\200\201\201\201\200\201\201\200\200\200\200\200\200"..., 
    Pv=0xb0f04c08 "\200\200\200\200\200\200\200\200\201\201\201\201\201\200\200\200", '\201' <repeats 23 times>, "\200\177\177\177\177\177\177\177\177\200\200\200\200\200\200\200\177\177\200\177\200\177\177\177\200\200\200\200\200\200\200\200\200\201\201\201\201\202\202\202\202~~\177\200\200\200\201\201\200\200\200\200\201\201\200\201\201\200\201\200\201\200\201\201\200\200\200\200\200\200\177\200\200\201\201\201\201\201\201\201\177\177\200\200\200\200\200\200\177~\177~\177~\177~\200\200\200\201\201\201\201\201\177\200\177\200\177\200\200\200\200\200\200\200\201\200\200\200\200\177\200\200\200\200\200\177\200\200\200\200\200\200\200\200\177\177\177\177\200\200\200\200\201\200\177\177\177\177\177\177\177\200\200\201\200\200\200\200"..., Width=-833902112, 
    Height=124435387, Ystride=704, UVstride=352) at video-dfb.c:1139
	dst = Variable "dst" is not available.

(gdb) bt
#0  0xb7d15e8c in free () from /lib/tls/libc.so.6
#1  0xb77a3b0d in fusion_shfree () from /usr/local/lib/libfusion-0.9.so.22
#2  0xb77e2dd1 in dfb_surfacemanager_destroy () from /usr/local/lib/libdirectfb-0.9.so.22
#3  0xb77d40a3 in dfb_gfxcard_shutdown () from /usr/local/lib/libdirectfb-0.9.so.22
#4  0xb77d38e0 in dfb_core_part_shutdown () from /usr/local/lib/libdirectfb-0.9.so.22
#5  0xb77d336c in dfb_core_shutdown () from /usr/local/lib/libdirectfb-0.9.so.22
#6  0xb77d3522 in dfb_core_arena_shutdown () from /usr/local/lib/libdirectfb-0.9.so.22
#7  0xb77a3901 in fusion_arena_exit () from /usr/local/lib/libfusion-0.9.so.22
#8  0xb77d2c79 in dfb_core_destroy () from /usr/local/lib/libdirectfb-0.9.so.22
#9  0xb77d3316 in dfb_core_signal_handler () from /usr/local/lib/libdirectfb-0.9.so.22
#10 0xb779e8b7 in signal_handler () from /usr/local/lib/libdirect-0.9.so.22
#11 <signal handler called>
#12 0xb77e11ad in dfb_surface_soft_lock () from /usr/local/lib/libdirectfb-0.9.so.22
#13 0xb77b3cc0 in IDirectFBSurface_Lock () from /usr/local/lib/libdirectfb-0.9.so.22
#14 0xb77fb45e in IDirectFBSurface::Lock (this=0x2, flags=2998006340, ptr=0xb2b1f244, pitch=0xb2b1f244) at idirectfbsurface.cpp:116
#15 0xb7949e00 in cDFBVideoOut::YUV (this=0x8286050, Py=0xb0e89008 "\021\021\021\020\020\020\020\020\020\020\020\020\020\021\021\022\017\016\017\020\021\017\020\021\020\017\020\020\021\023\024\023\022\022\023\022\021\021\020\020\020\020\020\017\017\017\020\020\021\021\021\020\020\017\017\016\016\017\020\022\023\023\022\022\020\017\017\017\017\020\020\020\021\021\020\021\022\022\022\022\020\021\020\020\021\021\021\022\022\022\022\022\023\023\023\022\023\023\022", '\021' <repeats 11 times>, "\020\020\021\021\021\021\021\022\022\022\022\021\020\020\021\021\022\022\021\021\022\021\022\022\021\020\020\020\021\021\021\021\020\020\020\020\020\020\021\021\020\017\020\021\022\022\021\020\021\021\021\020\017\017\017\r\016\r\017\017\016\r\r\r\r\016\020\021\021\020\020\020\020\021\021\021\021\021\020\020\020\020\017\r\r\016\016\016\r\r"..., Pu=0xb0eec008 "\200\200\200\200\200\201\201\201\201\201\201\201\201\201\200~\200~\177\177\200\200\200\200\201\201\200\200\177\177\177\177~\177\177\200\200\201\200\201\200\200\200\200\200\200\200", '\201' <repeats 17 times>, "\200\200\200\177\200\200\201\200\200\200\200\201\201\201\200\177\202\202\201\201\201\201\202\202", '\200' <repeats 17 times>, "\177\177\200\200\200\201\200~}~~\177~\200~\200\177\177\200\201\200\201\202\200\200\200\200\200\201\200\200\177\200\200\200\200\200\200\200\201\201\201\201\201\201\201\200\200\200\200\200\200\200\201\201\201\201\201\200\200", '\201' <repeats 19 times>, "\200\200\200\200\201\201\201\200\201\201\200\200\200\200\200\200"..., Pv=0xb0f04c08 "\200\200\200\200\200\200\200\200\201\201\201\201\201\200\200\200", '\201' <repeats 23 times>, "\200\177\177\177\177\177\177\177\177\200\200\200\200\200\200\200\177\177\200\177\200\177\177\177\200\200\200\200\200\200\200\200\200\201\201\201\201\202\202\202\202~~\177\200\200\200\201\201\200\200\200\200\201\201\200\201\201\200\201\200\201\200\201\201\200\200\200\200\200\200\177\200\200\201\201\201\201\201\201\201\177\177\200\200\200\200\200\200\177~\177~\177~\177~\200\200\200\201\201\201\201\201\177\200\177\200\177\200\200\200\200\200\200\200\201\200\200\200\200\177\200\200\200\200\200\177\200\200\200\200\200\200\200\200\177\177\177\177\200\200\200\200\201\200\177\177\177\177\177\177\177\200\200\201\200\200\200\200"..., Width=-833902112, Height=124435387, Ystride=704, UVstride=352) at video-dfb.c:1139
#16 0xb793bc14 in cVideoOut::DrawVideo_420pl (this=0x8286050, syncTimer=0x8645630, delay=0x84ae80c, picture=0x838dcc0, context=0x8558328) at video.c:397
#17 0xb793f5f5 in cVideoStreamDecoder::DecodePacket (this=0x84ae5a8, pkt=0x83afdd4) at mpeg2decoder.c:603
#18 0xb793ed03 in cStreamDecoder::Action (this=0x84ae5a8) at mpeg2decoder.c:188
#19 0x080f1c32 in cThread::StartThread (Thread=0x84ae5a8) at thread.c:234
#20 0xb7f08ccd in start_thread () from /lib/tls/libpthread.so.0
#21 0xb7d80b0e in clone () from /lib/tls/libc.so.6

From stefan at lucke.in-berlin.de  Sun Sep 11 10:26:52 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 11 Sep 2005 10:26:52 +0200
Subject: [Softdevice-devel] configure now in cvs (WAS: Re: Softdevice-0.1.3 & i18n fix)
In-Reply-To: <200509102224.10610.stefan@lucke.in-berlin.de>
References: <200507242253.52865.stefan@lucke.in-berlin.de> <Pine.OSF.4.61.0509102105170.321305@kosh.hut.fi> <200509102224.10610.stefan@lucke.in-berlin.de>
Message-ID: <200509111026.52336.stefan@lucke.in-berlin.de>

On Samstag, 10. September 2005 22:24, Stefan Lucke wrote:
> On Samstag, 10. September 2005 20:08, Rolf Ahrenberg wrote:
> > On Sat, 10 Sep 2005, Stefan Lucke wrote:
> > 
> > Thanks. BTW, any news about Makefile rewrite? I'd like to use
> > SOFTDEVICE_USE_DFB/FB/VIDIX/XV define in my Make.config and library
> > paths detected automatically by pkg-config.
> 
> A simple configure script is now in cvs.
> With vidix there is no vidix.pc file whitch could be checked for. So 
> a path to vidix is hard coded int configure too.

Thats now changed. configure has now the following options:

Usage: configure [options]
available options are:
  --disable-vidix
  --disable-dfb
  --disable-xv
  --with-vidix-path YOUR_VIDIX_PATH
  --help


-- 
Stefan Lucke



From stefan at lucke.in-berlin.de  Sun Sep 11 10:57:59 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 11 Sep 2005 10:57:59 +0200
Subject: [Softdevice-devel] Crash while recording and playing live program
In-Reply-To: <20050911081436.GA441501@kosh.hut.fi>
References: <20050910064445.GA409179@kosh.hut.fi> <20050910134108.GC3147@localhost.localdomain> <20050911081436.GA441501@kosh.hut.fi>
Message-ID: <200509111057.59914.stefan@lucke.in-berlin.de>

On Sonntag, 11. September 2005 10:14, Marko M?kel? wrote:
> On Sat, Sep 10, 2005 at 04:41:08PM +0300, Marko M?kel? wrote:
> > Thanks, I look forward to testing your fix.  I'll then report another
> > crash bug on the following day. :-)
> 
> As promised, here it is.  

I'd like to get softdevice reliable as your promises.

> vdr was recording and viewing the same program.
> Before the crash, a recording was watched for maybe 30 minutes.  Then
> vdr was suspended for maybe an hour.  During that time, the timed recording
> started.  Then I resumed vdr playback and switched to the program.  The
> program was shown for about 5 minutes.  I didn't touch the remote control
> during that time, so it shouldn't be OSD related at this time.

Yes, as it doesn't seem to be the original OSD crash, I'm going
to commit that change.

> 
> Luckily, I got a core dump this time.  See the attached two dumps of
> the stack trace.  For some reason, "bt full" truncates the trace.
> Could it be a double free() call?  Has anyone run softdevice under
> Valgrind?  (Should I try, or will it be hopelessly slow?)

I tried valgrind once on my 2.2GHz box but it was terrible. Recommened
cpu is something like a 6GHz P4 :-) .

> 
> I have saved the stderr output in case it will help troubleshooting.
> I normally log stderr to /tmp, which lives on shmfs.

Is there a caught exception message like:
"[dfb] YUV: action=%s, result=%s\n"

The messages just before the crash happend, would be interesting.

Hm, Width and Height values are bogous.

-- 
Stefan Lucke



From marko.makela at hut.fi  Sat Sep 10 22:17:29 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sat, 10 Sep 2005 23:17:29 +0300
Subject: [Softdevice-devel] Crash when fast-skipping a recording
In-Reply-To: <200509101637.45529.stefan@lucke.in-berlin.de>
References: <20050910064445.GA409179@kosh.hut.fi> <200509101443.45684.stefan@lucke.in-berlin.de> <20050910134108.GC3147@localhost.localdomain> <200509101637.45529.stefan@lucke.in-berlin.de>
Message-ID: <20050910201729.GA3338@localhost.localdomain>

On Sat, Sep 10, 2005 at 04:37:45PM +0200, Stefan Lucke wrote:
> Ok, here we go.

Thanks, the crashes seem to be gone now, based on some short
tests before a timed recording started.

BTW, I noticed the new configure script in cvs.  It's nice that
you stay away of the bulky autotools; vdr isn't supposed to be very
portable anyway.  I have some problems with the script, though:
I don't have pkg-config, and the script would enable all output methods
except DFB, which is the only method I have libraries for.  Of
course, I understand this is work in progress.  Deleting config.mak
made things good again.

I hope I will have to break my promise about reporting a new
crash bug tomorrow.

	Marko


From marko.makela at hut.fi  Sun Sep 11 14:30:30 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sun, 11 Sep 2005 15:30:30 +0300
Subject: [Softdevice-devel] Crash while recording and playing live program
In-Reply-To: <200509111057.59914.stefan@lucke.in-berlin.de>
References: <20050910064445.GA409179@kosh.hut.fi> <20050910134108.GC3147@localhost.localdomain> <20050911081436.GA441501@kosh.hut.fi> <200509111057.59914.stefan@lucke.in-berlin.de>
Message-ID: <20050911123030.GA3129@localhost.localdomain>

On Sun, Sep 11, 2005 at 10:57:59AM +0200, Stefan Lucke wrote:
> > As promised, here it is.  
> 
> I'd like to get softdevice reliable as your promises.

It really is quite reliable already.  The vdr box is our only TV
receiver and recorder in our household since about 6 months.  I
wonder why I started getting these crashes now.  Maybe it's just
pure coincidence, like the recent aviation accidents.  Now that
you fixed the bug that affected my vdr-suspend patch, I'm completely
happy with the performance of softdevice again.  I don't believe
that proprietary DVB set-top boxes are any better, even the high-end
ones.

> I tried valgrind once on my 2.2GHz box but it was terrible. Recommened
> cpu is something like a 6GHz P4 :-) .

Have you tried LD_PRELOAD=libefence.so.0 (Electric Fence)?  My box only
runs at 900 MHz and it only has 256 MB of RAM, so I'm afraid it would
be too tight (it'd only run a few seconds).

> Is there a caught exception message like:
> "[dfb] YUV: action=%s, result=%s\n"

No.

> The messages just before the crash happend, would be interesting.

[dfb] (re)configuring Videolayer to 736 x 576 (704x576)
[surface capabilities] videoSurface: videoonly double-buffered flipping
[dfb] (re)configured 0x08100609
[dfb] (re)configuring Videolayer to 736 x 576 (704x576)
[surface capabilities] videoSurface: videoonly double-buffered flipping
[dfb] (re)configured 0x08100609
[dfb] (re)configuring Videolayer to 736 x 576 (704x576)
[surface capabilities] videoSurface: videoonly double-buffered flipping
[dfb] (re)configured 0x08100609
Could not open /dev/rtc
[softdevice] allocating picture buffer for resolution 704x576 format 0
[dfb] (re)configuring Videolayer to 704 x 576 (704x576)
[surface capabilities] videoSurface: videoonly double-buffered flipping
[dfb] (re)configured 0x08100609
[softdevice] picture buffer released
Could not open /dev/rtc
[softdevice] allocating picture buffer for resolution 704x576 format 0
(!) [  809:    0.000] --> Caught signal 11 (at 0x2e7ffe0, invalid address) <--

The (re)configuring/(re)configured messages were displayed from stderr
line 122 to 2535, occasionally interleaved with "Could not open /dev/rtc".

It would be helpful to have time stamps in the output.  Maybe the
messages were logged in a burst, or maybe over a long time; I hope
you have some ideas.  Before these lines, the following lines were
repeated from line 86 to line 121:

Could not open /dev/rtc
[softdevice] allocating picture buffer for resolution 704x576 format 0
[softdevice] picture buffer released

Here's a snip from immediately before that:

Could not open /dev/rtc
[softdevice] allocating picture buffer for resolution 704x576 format 0
++++++++++++++++++++++++++++++++++[softdevice] picture buffer released
Could not open /dev/rtc
[softdevice] allocating picture buffer for resolution 704x576 format 0
[softdevice] picture buffer released
[dfb] (re)configuring Videolayer to 736 x 576 (704x576)
[surface capabilities] videoSurface: videoonly double-buffered flipping
[dfb] (re)configured 0x08100609
Could not open /dev/rtc
[softdevice] allocating picture buffer for resolution 704x576 format 0
[dfb] (re)configuring Videolayer to 704 x 576 (704x576)
[surface capabilities] videoSurface: videoonly double-buffered flipping
[dfb] (re)configured 0x08100609
[softdevice] picture buffer released

I hope you can make sense out of this.

	Marko


From stefan at lucke.in-berlin.de  Mon Sep 12 14:21:43 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 12 Sep 2005 14:21:43 +0200
Subject: [Softdevice-devel] softieee1394, fighting with pts values
Message-ID: <200509121421.43700.stefan@lucke.in-berlin.de>

Hi,
at the moment I'm just wondering why softieee1394 goes in sync 
with audio and video for a few seconds. Then it just starts dropping
every 2nd frame ("+" chars written).
Looking at the pts values used for syncing, I realized they are just 0.
Thats not the only odd thing. I added some tracing and it shows like
the coded picture number is always 0 too, and so the pts lookup
mechanism may fail.

video pts: 400, values.pkt : 0 pts - valid PTS: 400 pictno: 0 idx: 0
-120 (-120 0) xxx - Got pts: pictno 0  pts: 1 lastIdx 1 (- 1 1 25 -)
video pts: 400, values.pkt : 0 pts - valid PTS: 400 pictno: 0 idx: 0
-120 (-120 0) xxx - Got pts: pictno 0  pts: 1 lastIdx 1 (- 1 1 25 -)

    size-=len;
    data+=len;
    if(context->coded_frame)
      fprintf(stderr,"xxx - Got pts: pictno %d  pts: %lld lastIdx %d ",
        context->coded_frame->coded_picture_number,
        lastPTS,
        lastPTSidx);
    // save coded picture number together with corresponding pts

-- 
Stefan Lucke



From marko.makela at hut.fi  Wed Sep 14 23:41:49 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 15 Sep 2005 00:41:49 +0300
Subject: [Softdevice-devel] [PATCH] video-dfb.c: handle key-repeat events
Message-ID: <20050914214149.GB71839@kosh.hut.fi>

My patch to DirectFB was not accepted as such, but the feature was
implemented in a slightly different way, by introducing a DIEF_REPEAT
event flag.  (Note that it is an enum constant, not a #define.)
The attached patch works against current DirectFB CVS.  A 0.9.23
release should occur soon.

I wish the video4linux developers were as responsive.  It looks like
all video4linux remotes implement key-repeat asynchronously to the
actual code frames sent by the remote control unit.  My remarks about
this appear to have been ignored on the mailing list.

	Marko
-------------- next part --------------
Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.39
diff -p -u -r1.39 video-dfb.c
--- video-dfb.c	4 Sep 2005 05:49:18 -0000	1.39
+++ video-dfb.c	14 Sep 2005 20:59:54 -0000
@@ -562,33 +562,24 @@ void cDFBVideoOut::ProcessEvents ()
 
   while (events->GetEvent( DFB_EVENT(&event) ))
   {
-    switch (event.type)
+    if (event.type == DIET_KEYPRESS && dfbRemote)
     {
-      case DIET_KEYPRESS:
-#ifdef DFB_SUPPORTS_REPEAT
-      case DIET_KEYREPEAT:
-#endif /* DFB_SUPPORTS_REPEAT */
-        if (dfbRemote)
-        {
-          switch (event.key_symbol)
-          {
-            case DIKS_SHIFT: case DIKS_CONTROL: case DIKS_ALT:
-            case DIKS_ALTGR: case DIKS_META: case DIKS_SUPER: case DIKS_HYPER:
-              break;
-            default:
-              if (event.type != DIET_KEYPRESS ||
-                  !setupStore->CatchRemoteKey(dfbRemote->Name(),
-                                              event.key_symbol))
-              {
-                dfbRemote->PutKey(event.key_symbol,
-                                  event.type != DIET_KEYPRESS);
-              }
-              break;
-          }
-        }
+      switch (event.key_symbol)
+      {
+      case DIKS_SHIFT: case DIKS_CONTROL: case DIKS_ALT:
+      case DIKS_ALTGR: case DIKS_META: case DIKS_SUPER: case DIKS_HYPER:
         break;
       default:
+        if (!setupStore->CatchRemoteKey(dfbRemote->Name(), event.key_symbol))
+        {
+#if DIRECTFB_MAJOR_VERSION > 0 || DIRECTFB_MINOR_VERSION > 9 || DIRECTFB_MICRO_VERSION >= 23
+          dfbRemote->PutKey(event.key_symbol, event.flags & DIEF_REPEAT);
+#else
+          dfbRemote->PutKey(event.key_symbol, false);
+#endif
+        }
         break;
+      }
     }
   }
 }

From marko.makela at hut.fi  Thu Sep 15 20:05:28 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 15 Sep 2005 21:05:28 +0300
Subject: [Softdevice-devel] [PATCH] video-dfb.c: handle key-repeat events
In-Reply-To: <20050914214149.GB71839@kosh.hut.fi>
References: <20050914214149.GB71839@kosh.hut.fi>
Message-ID: <20050915180528.GA326087@kosh.hut.fi>

On Thu, Sep 15, 2005 at 12:41:49AM +0300, Marko M?kel? wrote:
> My patch to DirectFB was not accepted as such, but the feature was
> implemented in a slightly different way, by introducing a DIEF_REPEAT
> event flag.  (Note that it is an enum constant, not a #define.)
> The attached patch works against current DirectFB CVS.  A 0.9.23
> release should occur soon.

As Stefan suggested on the DirectFB list, it's better to make a
configure test, to allow the code compile against older DirectFB CVS
snapshots.

Here is a better patch.  While I was at it, I fixed a few minor things
in the configure script.  I only tested the patch with a DirectFB CVS
snapshot that defines DIEF_REPEAT, but I see no reason why it wouldn't
work on older DirectFB versions.

	Marko
-------------- next part --------------
Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.2
diff -p -u -r1.2 configure
--- configure	11 Sep 2005 08:22:39 -0000	1.2
+++ configure	15 Sep 2005 17:53:28 -0000
@@ -40,6 +40,7 @@ while [ $# -gt 0 ]
 do
   case $1 in
     --disable-vidix) shift; vidix="no" ;;
+    --disable-fb) shift; with_fb="no" ;;
     --disable-dfb) shift; dfb="no" ;;
     --disable-xv) shift; xv="no" ;;
     --with-vidix-path) shift;
@@ -76,6 +77,7 @@ dfb_opts="${dfb_cflags} ${dfb_libs}"
 dfb_device_desc="yes"
 dfb_sourcelocation="yes"
 dfb_dscaps_double="yes"
+dfb_dief_repeat="yes"
 
 cat > ${TMPC} << EOF
 #include <directfb.h>
@@ -115,6 +117,15 @@ int main(void) {
 EOF
 $cc $CFLAGS $dfb_opts -o $TMPE $TMPC > /dev/null 2>&1 || dfb_dscaps_double="no"
 
+cat > ${TMPC} << EOF
+#include <directfb.h>
+int main(void) {
+    DFBInputEventFlags flags = DIEF_REPEAT;
+  return 0;
+}
+EOF
+$cc $CFLAGS $dfb_opts -o $TMPE $TMPC > /dev/null 2>&1 || dfb_dief_repeat="no"
+
   fi
 fi
 # end of DirectFB specific tests
@@ -163,7 +174,7 @@ EOF
 $cc $CFLAGS -o $TMPE $TMPC > /dev/null 2>&1 || broken_gcc_cpp="yes"
 ###########
 
-echo "Creating temporay config.h and config.mak"
+echo "Creating temporary config.h and config.mak"
 echo "/* Generated by configure - do not modify */" > $TMPH
 echo "# Generated by configure - do not modify" > $TMPM
 echo "WITH_CONFIGURE = 1" >> $TMPM
@@ -212,6 +223,12 @@ if test "${dfb}" = "yes" ; then
     echo "#define HAVE_DSCAPS_DOUBLE              1" >> $TMPH
   else
     echo "#define HAVE_DSCAPS_DOUBLE              0" >> $TMPH
+  fi
+
+  if test "${dfb_dief_repeat}" = "yes" ; then
+    echo "#define HAVE_DIEF_REPEAT                1" >> $TMPH
+  else
+    echo "#define HAVE_DIEF_REPEAT                0" >> $TMPH
   fi
 fi
 
Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.39
diff -p -u -r1.39 video-dfb.c
--- video-dfb.c	4 Sep 2005 05:49:18 -0000	1.39
+++ video-dfb.c	15 Sep 2005 17:53:28 -0000
@@ -18,6 +18,7 @@
 # include "config.h"
 #else
 # define HAVE_SetSourceLocation 0
+# define HAVE_DIEF_REPEAT 0
 # if (DIRECTFB_MAJOR_VERSION == 0) && (DIRECTFB_MINOR_VERSION == 9) && (DIRECTFB_MICRO_VERSION < 23)
 #   define HAVE_GraphicsDeviceDescription 0
 # else
@@ -562,33 +563,24 @@ void cDFBVideoOut::ProcessEvents ()
 
   while (events->GetEvent( DFB_EVENT(&event) ))
   {
-    switch (event.type)
+    if (event.type == DIET_KEYPRESS && dfbRemote)
     {
-      case DIET_KEYPRESS:
-#ifdef DFB_SUPPORTS_REPEAT
-      case DIET_KEYREPEAT:
-#endif /* DFB_SUPPORTS_REPEAT */
-        if (dfbRemote)
-        {
-          switch (event.key_symbol)
-          {
-            case DIKS_SHIFT: case DIKS_CONTROL: case DIKS_ALT:
-            case DIKS_ALTGR: case DIKS_META: case DIKS_SUPER: case DIKS_HYPER:
-              break;
-            default:
-              if (event.type != DIET_KEYPRESS ||
-                  !setupStore->CatchRemoteKey(dfbRemote->Name(),
-                                              event.key_symbol))
-              {
-                dfbRemote->PutKey(event.key_symbol,
-                                  event.type != DIET_KEYPRESS);
-              }
-              break;
-          }
-        }
+      switch (event.key_symbol)
+      {
+      case DIKS_SHIFT: case DIKS_CONTROL: case DIKS_ALT:
+      case DIKS_ALTGR: case DIKS_META: case DIKS_SUPER: case DIKS_HYPER:
         break;
       default:
+        if (!setupStore->CatchRemoteKey(dfbRemote->Name(), event.key_symbol))
+        {
+#if HAVE_DIEF_REPEAT
+          dfbRemote->PutKey(event.key_symbol, event.flags & DIEF_REPEAT);
+#else
+          dfbRemote->PutKey(event.key_symbol, false);
+#endif
+        }
         break;
+      }
     }
   }
 }

From stefan at lucke.in-berlin.de  Thu Sep 15 21:22:39 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 15 Sep 2005 21:22:39 +0200
Subject: [Softdevice-devel] [PATCH] video-dfb.c: handle key-repeat events
In-Reply-To: <20050915180528.GA326087@kosh.hut.fi>
References: <20050914214149.GB71839@kosh.hut.fi> <20050915180528.GA326087@kosh.hut.fi>
Message-ID: <200509152122.39547.stefan@lucke.in-berlin.de>

On Donnerstag, 15. September 2005 20:05, Marko M?kel? wrote:
> On Thu, Sep 15, 2005 at 12:41:49AM +0300, Marko M?kel? wrote:
> > My patch to DirectFB was not accepted as such, but the feature was
> > implemented in a slightly different way, by introducing a DIEF_REPEAT
> > event flag.  (Note that it is an enum constant, not a #define.)
> > The attached patch works against current DirectFB CVS.  A 0.9.23
> > release should occur soon.
> 
> As Stefan suggested on the DirectFB list, it's better to make a
> configure test, to allow the code compile against older DirectFB CVS
> snapshots.
> 
> Here is a better patch.  While I was at it, I fixed a few minor things
> in the configure script.  I only tested the patch with a DirectFB CVS
> snapshot that defines DIEF_REPEAT, but I see no reason why it wouldn't
> work on older DirectFB versions.

Oh, that was some overlapping work. I adopted your previous version
to configure. Thats now in cvs.

-- 
Stefan Lucke



From marko.makela at hut.fi  Thu Sep 15 22:17:15 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 15 Sep 2005 23:17:15 +0300
Subject: [Softdevice-devel] [PATCH] video-dfb.c: handle key-repeat events
In-Reply-To: <200509152122.39547.stefan@lucke.in-berlin.de>
References: <20050914214149.GB71839@kosh.hut.fi> <20050915180528.GA326087@kosh.hut.fi> <200509152122.39547.stefan@lucke.in-berlin.de>
Message-ID: <20050915201715.GA3150@localhost.localdomain>

On Thu, Sep 15, 2005 at 09:22:39PM +0200, Stefan Lucke wrote:
> Oh, that was some overlapping work. I adopted your previous version
> to configure. Thats now in cvs.

I'm sorry; as a father of two small children, it's always hard
to estimate when time is available for hacking.

You seem to have overlooked the typo fix in configure:
s/temporay/temporary.  Speaking of typos, there are a few
in the softdevice output messages.  In softdevice.c, there
is s/opend/opened.  Hmm, I can't find any more with a quick
grep, except s/cant/can't.  Maybe the typos I vaguely remember
from a few months ago have been corrected already.

	Marko


From M.Wache at gmx.net  Fri Sep 16 17:59:02 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Fri, 16 Sep 2005 17:59:02 +0200
Subject: [Softdevice-devel] softieee1394, fighting with pts values
In-Reply-To: <200509121421.43700.stefan@lucke.in-berlin.de>
References: <200509121421.43700.stefan@lucke.in-berlin.de>
Message-ID: <432AEBC6.9070106@gmx.net>

Stefan Lucke schrieb:
> Hi,
> at the moment I'm just wondering why softieee1394 goes in sync 
> with audio and video for a few seconds. Then it just starts dropping
> every 2nd frame ("+" chars written).
> Looking at the pts values used for syncing, I realized they are just 0.
> Thats not the only odd thing. I added some tracing and it shows like
> the coded picture number is always 0 too, and so the pts lookup
> mechanism may fail.
> 
This a bad news... I think we should try to figure out how MPlayer or
Xine solves this problem. I know that the pts value in the AVPacket
belongs to the coded frame which starts in the packet, but since the
order of the coded frames is not necesarily the order to display the
frames, how should we find out the correct frame for the pts value?
Maybe we can ask this question on the ffmpeg mailling list...

Martin


From marko.makela at hut.fi  Sat Sep 17 01:09:55 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sat, 17 Sep 2005 02:09:55 +0300
Subject: [Softdevice-devel] [ANNOUNCE] vdr suspend patch and vdr-relay plugin
Message-ID: <20050916230955.GC3908@localhost.localdomain>

To those who are not subscribers of the vdr mailing list,
I am proud to announce the vdr-suspend patch
(tested with 1.3.30, 1.3.31 and 1.3.32) and the vdr-relay plugin
(which requires the vdr-suspend patch).

The vdr-suspend patch allows the Power button to toggle a
"Suspended" flag.  When the flag is set, the MPEG PES streams
to anything else than recorder functions will be stopped.

This is better than the softdevice suspend flag, for two reasons:
First, if you are watching a recording, the playback will
effectively be paused during the suspension.  On softdevice suspend,
VDR would fast-forward the recording.  Second, users of the
vdr-subtitles plugin will be happy to notice that the subtitles
will not keep playing during the suspension.

When the Power button is pressed to suspend playback, a user-selectable
timeout can kick in.  If no button is pressed during this timeout,
vdr will shut down (unless, of course, timed recordings are running
or about to start; then, vdr would shut down after completing the
recordings).

With the vdr-relay plugin controlling an easy-to-build solid-state
relay box, you can power off the speakers and monitor when playback
is suspended.  On my system, the monitor and speakers will only be
powered on when the computer is started by remote control; for instance,
if it is started by nvram-wakeup for timed recordings, the equipment
will remain powered off.

Read more at http://www.funet.fi/~msmakela/software/vdr/
and get the most recent packages:
http://www.funet.fi/~msmakela/software/vdr/vdr-1.3.32-suspend-0.4.1.patch.gz
http://www.funet.fi/~msmakela/software/vdr/vdr-relay-0.0.1.tgz

Note that you will have to configure the added variables in the
Setup/Miscellanous menu in order to enable the
"resume/suspend/smart-power-off" behaviour of the Power button.

Translation strings for the Setup/Miscellanous menu (file i18n.c in
vdr-1.3.32-suspend-0.4.1.patch.gz) are appreciated.  I could perhaps
come up with some more or less broken strings for Swedish and Estonian
and give Babelfish a try for further languages, but I think it's better
left to native speakers.  I hope that the German strings are not too broken.

	Marko


From stefan at lucke.in-berlin.de  Sat Sep 17 10:57:44 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 17 Sep 2005 10:57:44 +0200
Subject: [Softdevice-devel] softieee1394, fighting with pts values
In-Reply-To: <432AEBC6.9070106@gmx.net>
References: <200509121421.43700.stefan@lucke.in-berlin.de> <432AEBC6.9070106@gmx.net>
Message-ID: <200509171057.44943.stefan@lucke.in-berlin.de>

On Freitag, 16. September 2005 17:59, Martin Wache wrote:
> Stefan Lucke schrieb:
> > Hi,
> > at the moment I'm just wondering why softieee1394 goes in sync 
> > with audio and video for a few seconds. Then it just starts dropping
> > every 2nd frame ("+" chars written).
> > Looking at the pts values used for syncing, I realized they are just 0.
> > Thats not the only odd thing. I added some tracing and it shows like
> > the coded picture number is always 0 too, and so the pts lookup
> > mechanism may fail.
> > 
> This a bad news... I think we should try to figure out how MPlayer or
> Xine solves this problem. I know that the pts value in the AVPacket
> belongs to the coded frame which starts in the packet, but since the
> order of the coded frames is not necesarily the order to display the
> frames, how should we find out the correct frame for the pts value?

In my case, playing DV video, the order of decoded pictures is
allways the same as the frames that should be decoded. In DV
there are only full frames (no intermediate frames).  And that is
the reason I guess, for both coded_frame_number and coded_picture_number
are not set (both are  0).
I'll check if that situation could be handled without harm for other
video sequences.

> Maybe we can ask this question on the ffmpeg mailling list...

I guess I'll get an harsh answer.


-- 
Stefan Lucke



From laz at club-burniston.co.uk  Tue Sep 20 19:36:50 2005
From: laz at club-burniston.co.uk (Laz)
Date: Tue, 20 Sep 2005 18:36:50 +0100
Subject: [Softdevice-devel] Transparent skins with text2skin and softdevice
Message-ID: <200509201836.50951.laz@club-burniston.co.uk>

Hi,

I've just been setting up an Epia system and finally got softdevice going 
relatively well with DirectFB output (using patches for the patcher2k kernel 
module and DirectFB from Mark Adams on the directfb-users list).

So far, it seems to work quite well, especially in terms of the OSD compared 
with the xine plugin because the OSD is on a separate layer for softdevice. 
The main problem I can see at the moment is that A-V sync seems to drift 
about quite a bit but I know that this is under further development form 
monitoring this list.

One other thing I have found is that if I use a skin using text2skin, I get no 
transparent backgrounds to the OSD. This is the case for at least the enElchi 
and Deep Blue, and Enigma skins, although the EgalSimple skin does have  a 
transparent background. The standard vdr skin and the ST:TNG panels skins 
both have transparent backgrounds and work fine! All of these skins do have 
transparent backgrounds with the xine plugin.

Is this a know problem? I had thought it was just the text2skin ones which 
lost their transparency until I found that the EgalSimple skin is 
transparent! Having said that, the skins do render without other artifacts, 
unlike with the xine plugin where OSD colours didn't always appear as 
expected.

This is with vdr-1.3.30, softdevice-0.1.3, and text2skin cvs from 14/8/05.

Cheers,

Laz


From stefan at lucke.in-berlin.de  Tue Sep 20 23:39:27 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 20 Sep 2005 23:39:27 +0200
Subject: [Softdevice-devel] Transparent skins with text2skin and softdevice
In-Reply-To: <200509201836.50951.laz@club-burniston.co.uk>
References: <200509201836.50951.laz@club-burniston.co.uk>
Message-ID: <200509202339.27440.stefan@lucke.in-berlin.de>

On Dienstag, 20. September 2005 19:36, Laz wrote:
> 
> Hi,
> 
> I've just been setting up an Epia system and finally got softdevice going 
> relatively well with DirectFB output (using patches for the patcher2k kernel 
> module and DirectFB from Mark Adams on the directfb-users list).
> 
> So far, it seems to work quite well, especially in terms of the OSD compared 
> with the xine plugin because the OSD is on a separate layer for softdevice. 
> The main problem I can see at the moment is that A-V sync seems to drift 
> about quite a bit but I know that this is under further development form 
> monitoring this list.

And I'm following the discussion on the directfb lists very interested.
On epia I only did a video out (no audio) with a vga connected monitor.
So there are some A/V sync test pending.

> 
> One other thing I have found is that if I use a skin using text2skin, I get no 
> transparent backgrounds to the OSD. This is the case for at least the enElchi 
> and Deep Blue, and Enigma skins, although the EgalSimple skin does have  a 
> transparent background. The standard vdr skin and the ST:TNG panels skins 
> both have transparent backgrounds and work fine! All of these skins do have 
> transparent backgrounds with the xine plugin.
> 
> Is this a know problem?

I think it's a hardware limitation. Once I saw  (directfb code ?) that there
is only a 4bit alpha value for hw blending available. By this alpha
values less 0x10 are transparent and those greater 0xf0 are solid.
I don't know if it is possible to change the used alpha values of skins.

I did a search through current directfb code (on my some months 
old cvs version) but didn't find that location again.

> I had thought it was just the text2skin ones which 
> lost their transparency until I found that the EgalSimple skin is 
> transparent! Having said that, the skins do render without other artifacts, 
> unlike with the xine plugin where OSD colours didn't always appear as 
> expected.
> 
> This is with vdr-1.3.30, softdevice-0.1.3, and text2skin cvs from 14/8/05.
> 
> Cheers,
> 
> Laz
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/softdevice-devel
> 

-- 
Stefan Lucke



From laz at club-burniston.co.uk  Wed Sep 21 00:30:30 2005
From: laz at club-burniston.co.uk (Laz)
Date: Tue, 20 Sep 2005 23:30:30 +0100
Subject: [Softdevice-devel] Transparent skins with text2skin and softdevice
In-Reply-To: <200509202339.27440.stefan@lucke.in-berlin.de>
References: <200509201836.50951.laz@club-burniston.co.uk> <200509202339.27440.stefan@lucke.in-berlin.de>
Message-ID: <200509202330.31055.laz@club-burniston.co.uk>

On Tuesday 20 September 2005 22:39, Stefan Lucke wrote:
> On Dienstag, 20. September 2005 19:36, Laz wrote:
> > I've just been setting up an Epia system and finally got softdevice going
> > relatively well with DirectFB output (using patches for the patcher2k
> > kernel module and DirectFB from Mark Adams on the directfb-users list).
> >
> > So far, it seems to work quite well, especially in terms of the OSD
> > compared with the xine plugin because the OSD is on a separate layer for
> > softdevice. The main problem I can see at the moment is that A-V sync
> > seems to drift about quite a bit but I know that this is under further
> > development form monitoring this list.
>
> And I'm following the discussion on the directfb lists very interested.

Good good. I had this system going quite well with the xine plugin but 
starting X is an extra complexity and it slowed right down when the OSD was 
visible!

> On epia I only did a video out (no audio) with a vga connected monitor.
> So there are some A/V sync test pending.

I've just upgraded to vdr-1.3.32 and softdevice from cvs. It seems better than 
it was with softdevice-1.3.0 but I may be imagining that! At the moment, A-V 
sync drifts about a bit on live TV and on recordings; first impressions are 
that it is in sync more for live TV than for recordings. With the previous 
version of softdevice, recordings were out of sync most of the time and the 
video went jittery, presumably as it tried to resync. I don't think it is 
jittery with the cvs version I just checked out but I haven't tested it fully 
yet!

If you can suggest anything for me to test, please do.

> > One other thing I have found is that if I use a skin using text2skin, I
> > get no transparent backgrounds to the OSD. This is the case for at least
> > the enElchi and Deep Blue, and Enigma skins, although the EgalSimple skin
> > does have  a transparent background. The standard vdr skin and the ST:TNG
> > panels skins both have transparent backgrounds and work fine! All of
> > these skins do have transparent backgrounds with the xine plugin.
> >
> > Is this a know problem?
>
> I think it's a hardware limitation. Once I saw  (directfb code ?) that
> there is only a 4bit alpha value for hw blending available. By this alpha
> values less 0x10 are transparent and those greater 0xf0 are solid. I don't
> know if it is possible to change the used alpha values of skins.
>
> I did a search through current directfb code (on my some months
> old cvs version) but didn't find that location again.

Ahhh...that would make sense. I will look at the actual alpha values used in 
the various skins: the colours are defines as ARGB quartets so can easily be 
changed.

Cheers,

Laz


From noreply at berlios.de  Wed Sep 21 22:53:19 2005
From: noreply at berlios.de (noreply at berlios.de)
Date: Wed, 21 Sep 2005 22:53:19 +0200 (CEST)
Subject: [Softdevice-devel] [Feature #1291] OSD does not scale
Message-ID: <200509212053.j8LKrJQl002979@unicorn.berlios.de>

Feature Request #1291, was updated on 2005-Sep-21 22:53
You can respond by visiting: 
http://developer.berlios.de/feature/?func=detailfeature&feature_id=1291&group_id=2051

Category: None
Status: Open
Priority: 5
Summary: OSD does not scale

By: thorsten
Date: 2005-Sep-21 22:53

Message:
Logged In: YES 
user_id=19783
Browser: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.7.8) Gecko/20050521

I use a TerraTec Cinergy T2 USB DVB-T with VDR 1.2.6
and softdevice. Unfortunately, when switching to
fullscreen mode the OSD is not scaled (it stays 7xx*5xx
while the picture itself is scaled to 1400x1050).
Therefore one cannot use the OSD to control the TV from
more than 1-2 meters.

----------------------------------------------------------------------
You can respond by visiting: 
http://developer.berlios.de/feature/?func=detailfeature&feature_id=1291&group_id=2051


From noreply at berlios.de  Wed Sep 21 22:56:45 2005
From: noreply at berlios.de (noreply at berlios.de)
Date: Wed, 21 Sep 2005 22:56:45 +0200 (CEST)
Subject: [Softdevice-devel] [Feature #1292] VDR: REcordings w/ AC3 do not play right
Message-ID: <200509212056.j8LKuj1Q003086@unicorn.berlios.de>

Feature Request #1292, was updated on 2005-Sep-21 22:56
You can respond by visiting: 
http://developer.berlios.de/feature/?func=detailfeature&feature_id=1292&group_id=2051

Category: None
Status: Open
Priority: 5
Summary: VDR: REcordings w/ AC3 do not play right

By: thorsten
Date: 2005-Sep-21 22:56

Message:
Logged In: YES 
user_id=19783
Browser: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.7.8) Gecko/20050521

I copied over a handful of recordings I did with my
DVB-S card. All of them do play pretty nice on my
notebook when using a USB DVB-T device and softdevice
but recordings containing AC3. The sound is broken (
Xrun() is being called due to -EPIPE). I could not find
out the reason but any other encoding does not show
this behavior.

----------------------------------------------------------------------
You can respond by visiting: 
http://developer.berlios.de/feature/?func=detailfeature&feature_id=1292&group_id=2051


From noreply at berlios.de  Wed Sep 21 22:58:00 2005
From: noreply at berlios.de (noreply at berlios.de)
Date: Wed, 21 Sep 2005 22:58:00 +0200 (CEST)
Subject: [Softdevice-devel] [Feature #1293] VDR mplayer-plugin support
Message-ID: <200509212058.j8LKw026003143@unicorn.berlios.de>

Feature Request #1293, was updated on 2005-Sep-21 22:58
You can respond by visiting: 
http://developer.berlios.de/feature/?func=detailfeature&feature_id=1293&group_id=2051

Category: None
Status: Open
Priority: 5
Summary: VDR mplayer-plugin support

By: thorsten
Date: 2005-Sep-21 22:58

Message:
Logged In: YES 
user_id=19783
Browser: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.7.8) Gecko/20050521

Even if softplay exists, it would be very useful to
have the option to play videos using the mplayer plugin
as well...

----------------------------------------------------------------------
You can respond by visiting: 
http://developer.berlios.de/feature/?func=detailfeature&feature_id=1293&group_id=2051


From laz at club-burniston.co.uk  Thu Sep 22 12:28:25 2005
From: laz at club-burniston.co.uk (Laurence Abbott)
Date: Thu, 22 Sep 2005 11:28:25 +0100
Subject: [Softdevice-devel] A-V sync problems with directfb on unichrome...
Message-ID: <1127384905.27018.27.camel@laser2.york.ac.uk>

I'm trying to debug the A-V sync problems I'm seeing with directfb
output from softdevice on an Epia MII system. This is with CVS DirectFB
from a couple of days ago, and the viafb module from pather2k (both
patched to give correct field sync), softdevice CVS from a couple of
days ago, and vdr-1.3.32.

For me, A-V sync wanders about a lot, both for live TV and for
recordings (not tried playing back vdr recordings with softplay yet, as
others have mentioned). I'm currently enabling various debugging bits in
mpeg2decoder.c and I'm seeing quite a lot of 'nan' in the output!

#define MPGDEB:

(after a few seconds to stabilise itself):
mpegdec[8621]:Frame# 241   A-V(ms) -394  delay 11874 FrameT: B_t,
dispTime(ms): n
an
mpegdec[8633]:Got pts: pictno 243  pts: 641653059 lastIdx 4
mpegdec[8633]:video pts: 641653059, values.pkt : 641653059 pts - valid
PTS: 0 pic
tno: 243 idx: 3
mpegdec[8634]:audio pts 641654803 pkt->PTS : 641654803 pts - valid PTS:
0
mpegdec[8634]:audio pts offset -1103818638
mpegdec[8634]:a_delay 1823 at end of decode
mpegdec[8635]:audio: count: 423  Length: 576 len: 576 a_size: 4608
a_delay: 1811
mpegdec[8648]:audio pts offset -1103818638
mpegdec[8648]:a_delay 1918 at end of decode
mpegdec[8661]:Frame# 242   A-V(ms) -334  delay 11289 FrameT: B_t,
dispTime(ms): n
an
mpegdec[8674]:Got pts: pictno 244  pts: 641654659 lastIdx 5
mpegdec[8674]:video pts: 641653459, values.pkt : 641653459 pts - valid
PTS: 0 pic
tno: 241 idx: 1
mpegdec[8698]:audio: count: 424  Length: 576 len: 576 a_size: 4608
a_delay: 1421
mpegdec[8698]:audio pts offset -1103818638
mpegdec[8698]:a_delay 1661 at end of decode
mpegdec[8699]:audio: count: 425  Length: 576 len: 576 a_size: 4608
a_delay: 1650
mpegdec[8699]:audio pts offset -1103818637
mpegdec[8699]:a_delay 1890 at end of decode
mpegdec[8700]:audio: count: 426  Length: 576 len: 576 a_size: 4608
a_delay: 1878
mpegdec[8703]:Frame# 243   A-V(ms) -226  delay 7577 FrameT: P_t,
dispTime(ms): nan
mpegdec[8714]:Got pts: pictno 245  pts: 641653859 lastIdx 6
mpegdec[8714]:video pts: 641653859, values.pkt : 641653859 pts - valid
PTS: 0 pic
tno: 245 idx: 5
mpegdec[8724]:audio pts offset -1103818638
mpegdec[8724]:a_delay 1876 at end of decode
mpegdec[8726]:audio: count: 427  Length: 576 len: 576 a_size: 4608
a_delay: 1863
mpegdec[8741]:Frame# 244   A-V(ms) -372  delay 9394 FrameT: B_t,
dispTime(ms): na
n
mpegdec[8751]:audio pts offset -1103818638
mpegdec[8751]:a_delay 1853 at end of decode
mpegdec[8752]:Got pts: pictno 246  pts: 641654259 lastIdx 7
mpegdec[8752]:video pts: 641654259, values.pkt : 641654259 pts - valid
PTS: 0 pic
tno: 246 idx: 6
mpegdec[8781]:Frame# 245   A-V(ms) -509  delay 10405 FrameT: B_t,
dispTime(ms): n
an
mpegdec[8796]:Got pts: pictno 247  pts: 641655859 lastIdx 8
mpegdec[8796]:video pts: 641654659, values.pkt : 641654659 pts - valid
PTS: 0 pic
tno: 244 idx: 4
mpegdec[8805]:audio: count: 428  Length: 576 len: 576 a_size: 4608
a_delay: 1311
mpegdec[8805]:audio pts 641656243 pkt->PTS : 641656243 pts - valid PTS:
0
mpegdec[8805]:audio pts offset -1103818638
mpegdec[8805]:a_delay 1551 at end of decode
mpegdec[8806]:audio: count: 429  Length: 576 len: 576 a_size: 4608
a_delay: 1540

(I can't work out why dispTime always comes out as 'nan' because it
should just be (float)dispTime/1000 and it's happy with delay which is
-=dispTime.)

#define AV_STATS:

A-V: nan+-nan ms DispTime: nan ms hurry_up: 0
A-V: nan+-nan ms DispTime: nan ms hurry_up: 0
A-V: nan+-nan ms DispTime: nan ms hurry_up: 0
A-V: nan+-nan ms DispTime: nan ms hurry_up: 0
A-V: nan+-nan ms DispTime: nan ms hurry_up: 0
A-V: nan+-nan ms DispTime: nan ms hurry_up: 0
etc.

Should this one work or is it hanging around from a previous version, or
something?

Looking through the source, I can't see why I should be getting nan,
unless offset is being set to nan by:
(mpeg2decoder.c, line 620):

  uint64_t aPTS = clock->GetPTS();
  // update video pts
  cClock::AdjustVideoPTS(pts);

  if ( aPTS )
    offset = aPTS - pts ;
  else offset = 0;

Could this be the source of my problems, or am I barking up the wrong
tree here?!

Cheers,

Laz



From laz at club-burniston.co.uk  Thu Sep 22 18:07:19 2005
From: laz at club-burniston.co.uk (Laurence Abbott)
Date: Thu, 22 Sep 2005 17:07:19 +0100
Subject: [Softdevice-devel] Transparent skins with text2skin and
	softdevice
In-Reply-To: <200509202339.27440.stefan@lucke.in-berlin.de>
References: <200509201836.50951.laz@club-burniston.co.uk>
	 <200509202339.27440.stefan@lucke.in-berlin.de>
Message-ID: <1127405239.27018.62.camel@laser2.york.ac.uk>

On Tue, 2005-09-20 at 23:39 +0200, Stefan Lucke wrote:
> On Dienstag, 20. September 2005 19:36, Laz wrote:
> > One other thing I have found is that if I use a skin using text2skin, I get no 
> > transparent backgrounds to the OSD. This is the case for at least the enElchi 
> > and Deep Blue, and Enigma skins, although the EgalSimple skin does have  a 
> > transparent background. The standard vdr skin and the ST:TNG panels skins 
> > both have transparent backgrounds and work fine! All of these skins do have 
> > transparent backgrounds with the xine plugin.
> > 
> > Is this a know problem?
> 
> I think it's a hardware limitation. Once I saw  (directfb code ?) that there
> is only a 4bit alpha value for hw blending available. By this alpha
> values less 0x10 are transparent and those greater 0xf0 are solid.
> I don't know if it is possible to change the used alpha values of skins.
> 
> I did a search through current directfb code (on my some months 
> old cvs version) but didn't find that location again.

I'm just looking through the DirectFB code and have found the following
in DirectFB/gfxdrivers/unichrome/uc_ovl_hwmap.c:
Ca. line 403:
/**
 * Map alpha mode and opacity.
 *
 * @param opacity   Alpha opacity: 0 = transparent, 255 = opaque.
 *                  -1 = Use alpha from underlying graphics.
 *
 * @returns alpha control register setting.
 *
 * @note: Unfortunately, if using alpha from underlying graphics,
 *        the video is opaque if alpha = 255 and transparent if = 0.
 *        The inverse would have made more sense ...
 *
 * @note: The hardware supports a separate alpha plane as well,
 *        but it is not implemented here.
 *
 * @note: Derived from ddmpeg.c, VIAAlphaWin()
 */

__u32 uc_ovl_map_alpha(int opacity)
{
    __u32 ctrl = 0x00080000;    // Not sure what this number is,
supposedly
                                // it is the "expire number divided by
4".

    if (opacity > 255) opacity = 255;

    if (opacity < 0) {
        ctrl |= ALPHA_WIN_BLENDING_GRAPHIC;
    }
    else {
        opacity = opacity >> 4; // Throw away bits 0 - 3
        ctrl |= (opacity << 12) | ALPHA_WIN_BLENDING_CONSTANT;
    }

    return ctrl; // V_ALPHA_CONTROL
}

This must be what you saw: shifting by 4 bits to reduce the alpha value
to 4 bits.

The original and ST:TNG skins of vdr use the colour clrGray50 for the
background which corresponds to 0x7F000000, i.e. 50% grey. The enElchi
skin used an alpha value of #C8, and this appears as opaque. The
EgalSimple skin uses and alpha values of #AF and #DF, and has a
transparent background! I don't think this is simply a case of a reduced
number of bits in the alpha channel. It may have to do with how the
relevant windows are defined in the skins and their depths. This is a
total guess but I'll try to test this theory!

Cheers,

Laz



From laz at club-burniston.co.uk  Thu Sep 22 18:16:04 2005
From: laz at club-burniston.co.uk (Laz)
Date: Thu, 22 Sep 2005 17:16:04 +0100
Subject: [Softdevice-devel] Documentation / manual for softdevice?
Message-ID: <1127405764.27018.67.camel@laser2.york.ac.uk>

Is there any documentation available for the setup options for
softdevice? I mean things like which pixel format allows use of pseudo
and software alpha blending, stretchblit, etc. I know this can be worked
out by looking through the source but it would make life so much easier
if a bit more detail was added to the README or a MANUAL file added.

I don't think I've missed such a file or section on the web page!

:-)

Cheers,

Laz



From M.Wache at gmx.net  Thu Sep 22 19:03:42 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 22 Sep 2005 19:03:42 +0200
Subject: [Softdevice-devel] A-V sync problems with directfb on unichrome...
In-Reply-To: <1127384905.27018.27.camel@laser2.york.ac.uk>
References: <1127384905.27018.27.camel@laser2.york.ac.uk>
Message-ID: <4332E3EE.6060401@gmx.net>

Laurence Abbott schrieb:


> Should this one work or is it hanging around from a previous version, or
> something?
> 
> Looking through the source, I can't see why I should be getting nan,
> unless offset is being set to nan by:
> (mpeg2decoder.c, line 620):
> 
>   uint64_t aPTS = clock->GetPTS();
>   // update video pts
>   cClock::AdjustVideoPTS(pts);
> 
>   if ( aPTS )
>     offset = aPTS - pts ;
>   else offset = 0;
> 
> Could this be the source of my problems, or am I barking up the wrong
> tree here?!
> 
If offset is nan, then you surely have a problem with the A-V sync.
However I think that the nans you see are just because I was a bit lazy
with the conversions: (float)dispTime/1000  is not necessarly of type
float again. Probably an additional conversion or replacing 1000 by
1000.0 helps, I think I remember that some compilers didn't like these
constructs.

About the source of the bad A-V sync I'm not sure... As far as I
remember DireftFB out tries to sync to the refreshrate of the TV. Are
you using a TV for output? What is the refreshrate of the videomode?
Could you please check if you see a line
[dfb] Display frame time is XXX microseconds
on the stdout and report that time?

Bye,
Martin


From laz at club-burniston.co.uk  Fri Sep 23 10:51:49 2005
From: laz at club-burniston.co.uk (Laurence Abbott)
Date: Fri, 23 Sep 2005 09:51:49 +0100
Subject: [Softdevice-devel] A-V sync problems with directfb on
	unichrome...
In-Reply-To: <4332E3EE.6060401@gmx.net>
References: <1127384905.27018.27.camel@laser2.york.ac.uk>
	 <4332E3EE.6060401@gmx.net>
Message-ID: <1127465509.2670.12.camel@laser2.york.ac.uk>

On Thu, 2005-09-22 at 19:03 +0200, Martin Wache wrote:
> Laurence Abbott schrieb:
> > Should this one work or is it hanging around from a previous version, or
> > something?
> > 
> > Looking through the source, I can't see why I should be getting nan,
> > unless offset is being set to nan by:
> > (mpeg2decoder.c, line 620):
> > 
> >   uint64_t aPTS = clock->GetPTS();
> >   // update video pts
> >   cClock::AdjustVideoPTS(pts);
> > 
> >   if ( aPTS )
> >     offset = aPTS - pts ;
> >   else offset = 0;
> > 
> > Could this be the source of my problems, or am I barking up the wrong
> > tree here?!
> > 
> If offset is nan, then you surely have a problem with the A-V sync.

Will it be using these nan values for the timing or is it just for the
printing?

> However I think that the nans you see are just because I was a bit lazy
> with the conversions: (float)dispTime/1000  is not necessarly of type
> float again. Probably an additional conversion or replacing 1000 by
> 1000.0 helps, I think I remember that some compilers didn't like these
> constructs.

I'll add a few more '.0' bits and see if it makes any difference. I
could see the /1000 giving an int and rounding errors but not nan!
Looking at mpeg2decoder.c, these are only used in the printfs so it
can't affect the actual behaviour.

> About the source of the bad A-V sync I'm not sure... As far as I
> remember DireftFB out tries to sync to the refreshrate of the TV. Are
> you using a TV for output? What is the refreshrate of the videomode?
> Could you please check if you see a line
> [dfb] Display frame time is XXX microseconds
> on the stdout and report that time?

I have both a (PAL) TV and monitor attached. Both are running at 50 Hz
(TV because it's PAL, and monitor reports as such on it's OSD). The
output shows:

[dfb] Display frame time is 19994 microseconds

which I work out to be 50 Hz.

The A-V sync is correct for some of the time but it does wander a lot.
Let me know if there are any things I can do to try to track down the
source of the problem.

How good is A-V sync on unichrome with directfb output when it hasn't
been patched for field-sync? Looking through the list archives, most of
the development seems to be done on Matrox cards. Is unichrome output
known to be less good at present because not many people are using /
testing it?

Cheers,

Laz



From laz at club-burniston.co.uk  Fri Sep 23 11:17:52 2005
From: laz at club-burniston.co.uk (Laurence Abbott)
Date: Fri, 23 Sep 2005 10:17:52 +0100
Subject: [Softdevice-devel] A-V sync problems with directfb on
	unichrome...
In-Reply-To: <4332E3EE.6060401@gmx.net>
References: <1127384905.27018.27.camel@laser2.york.ac.uk>
	 <4332E3EE.6060401@gmx.net>
Message-ID: <1127467072.2670.20.camel@laser2.york.ac.uk>

On Thu, 2005-09-22 at 19:03 +0200, Martin Wache wrote:
> However I think that the nans you see are just because I was a bit lazy
> with the conversions: (float)dispTime/1000  is not necessarly of type
> float again. Probably an additional conversion or replacing 1000 by
> 1000.0 helps, I think I remember that some compilers didn't like these
> constructs.

Here are is some output from added '.0' with both BPGDEb and AV_STATS
defined:

(short section posted here: full log from ca. 20 s run at
http://vdr.club-burniston.co.uk/vdr_MPGDEB.log.gz):

mpegdec[6592]:Frame# 469   A-V(ms) 2243  delay -86981 FrameT: B_t, dispTime(ms):
56.21
A-V: 232.45+-44.66 ms DispTime: 33.64 ms hurry_up: 1
mpegdec[6602]:audio: count: 815  Length: 576 len: 576 a_size: 4608 a_delay: 1045
mpegdec[6602]:audio pts offset -149357278
mpegdec[6602]:a_delay 1285 at end of decode
mpegdec[6603]:audio: count: 816  Length: 576 len: 576 a_size: 4608 a_delay: 1273
mpegdec[6603]:audio pts offset -149357278
mpegdec[6603]:a_delay 1513 at end of decode
mpegdec[6604]:audio: count: 817  Length: 576 len: 576 a_size: 4608 a_delay: 1501
mpegdec[6604]:audio pts offset -149357279
mpegdec[6604]:a_delay 1741 at end of decode
mpegdec[6607]:Got pts: pictno 471  pts: 518268682 lastIdx 2
mpegdec[6607]:video pts: 518268682, values.pkt : 518268682 pts - valid PTS: 0 pic
tno: 471 idx: 1
mpegdec[6607]:Frame# 470   A-V(ms) 2243  delay -54891 FrameT: B_t, dispTime(ms):
14.89
mpegdec[6620]:Got pts: pictno 472  pts: 518270282 lastIdx 3
mpegdec[6620]:video pts: 518269082, values.pkt : 518269082 pts - valid PTS: 0 pic
tno: 469 idx: 9
mpegdec[6672]:Frame# 471   A-V(ms) 1843  delay -87974 FrameT: P_t, dispTime(ms):
52.05
mpegdec[6685]:Got pts: pictno 473  pts: 518269482 lastIdx 4
mpegdec[6685]:video pts: 518269482, values.pkt : 518269482 pts - valid PTS: 0 pic

tno: 473 idx: 3
mpegdec[6685]:Frame# 472   A-V(ms) 1443  delay -52707 FrameT: B_t, dispTime(ms):
12.71
mpegdec[6701]:Got pts: pictno 474  pts: 518269882 lastIdx 5
mpegdec[6701]:video pts: 518269882, values.pkt : 518269882 pts - valid PTS: 0 pic
tno: 474 idx: 4
mpegdec[6708]:audio: count: 818  Length: 576 len: 576 a_size: 4608 a_delay: 705
mpegdec[6708]:audio pts 518273306 pkt->PTS : 518273306 pts - valid PTS: 0
mpegdec[6708]:audio pts offset -149357277
mpegdec[6708]:a_delay 943 at end of decode
mpegdec[6709]:audio: count: 819  Length: 576 len: 576 a_size: 4608 a_delay: 933
mpegdec[6709]:audio pts offset -149357279
mpegdec[6709]:a_delay 1171 at e+++nd of decode
mpegdec[6710]:audio: count: 820  Length: 576 len: 576 a_size: 4608 a_delay: 1160
mpegdec[6710]:audio pts offset -149357277
mpegdec[6710]:a_delay 1400 at end of decode
mpegdec[6712]:audio: count: 821  Length: 576 len: 576 a_size: 4608 a_delay: 1388
mpegdec[6712]:audio pts offset -149357278
mpegdec[6712]:a_delay 1628 at end of decode
mpegdec[6721]:audio: count: 822  Length: 576 len: 576 a_size: 4608 a_delay: 1533
mpegdec[6721]:audio pts offset -149357279
mpegdec[6721]:a_delay 1771 at end of decode
mpegdec[6722]:audio: count: 823  Length: 576 len: 576 a_size: 4608 a_delay: 1760
mpegdec[6731]:audio pts offset -149357278
mpegdec[6731]:a_delay 1918 at end of decode
mpegdec[6752]:Frame# 473   A-V(ms) 2306  delay -87989 FrameT: B_t, dispTime(ms):
51.19
mpegdec[6764]:Got pts: pictno 475  pts: 518271482 lastIdx 6
mpegdec[6765]:video pts: 518270282, values.pkt : 518270282 pts - valid PTS: 0 pic
tno: 472 idx: 2
mpegdec[6765]:Frame# 474   A-V(ms) 1906  delay -52279 FrameT: P_t, dispTime(ms):
12.28
mpegdec[6776]:Got pts: pictno 476  pts: 518270682 lastIdx 7
mpegdec[6776]:video pts: 518270682, values.pkt : 518270682 pts - valid PTS: 0 pic
tno: 476 idx: 6
mpegdec[6802]:audio: count: 824  Length: 576 len: 576 a_size: 4608 a_delay: 1201
mpegdec[6802]:audio pts 518274746 pkt->PTS : 518274746 pts - valid PTS: 0
mpegdec[6802]:audio pts offset -149357279
mpegdec[6802]:a_delay 1438 at end of decode
mpegdec[6804]:audio: count: 825  Length: 576 len: 576 a_size: 4608 a_delay: 1426
mpegdec[6804]:audio pts offset -149357279
mpegdec[6804]:a_delay 1666 at end of decode
mpegdec[6805]:audio: count: 826  Length: 576 len: 576 a_size: 4608 a_delay: 1656
mpegdec[6805]:audio pts offset -149357279
mpegdec[6805]:a_delay 1895 at end of decode
mpegdec[6832]:Frame# 475   A-V(ms) 2249  delay -87990 FrameT: B_t, dispTime(ms):
56.33
mpegdec[6843]:Got pts: pictno 477  pts: 518271082 lastIdx 8

Here's how the A-V stats vary during this run:

A-V: -363.95+-126.88 ms DispTime: 46.92 ms hurry_up: 0
A-V: -320.03+-5.31 ms DispTime: 25.35 ms hurry_up: 0
A-V: -265.41+-29.26 ms DispTime: 30.98 ms hurry_up: 0
A-V: -215.44+-21.94 ms DispTime: 29.21 ms hurry_up: 0
A-V: -146.47+-41.71 ms DispTime: 32.29 ms hurry_up: 0
A-V: -57.05+-20.41 ms DispTime: 31.66 ms hurry_up: 0
A-V: -10.97+-35.52 ms DispTime: 32.56 ms hurry_up: 0
A-V: 36.95+-17.40 ms DispTime: 28.26 ms hurry_up: 0
A-V: 69.53+-24.34 ms DispTime: 31.95 ms hurry_up: 0
A-V: 97.60+-20.05 ms DispTime: 32.36 ms hurry_up: 0
A-V: 132.35+-26.70 ms DispTime: 31.38 ms hurry_up: 0
A-V: 154.51+-17.61 ms DispTime: 27.99 ms hurry_up: 0
A-V: 184.90+-21.34 ms DispTime: 33.56 ms hurry_up: 0
A-V: 257.59+-29.15 ms DispTime: 31.72 ms hurry_up: 0
A-V: 276.72+-30.43 ms DispTime: 31.34 ms hurry_up: 1
A-V: 289.41+-30.70 ms DispTime: 33.70 ms hurry_up: 1
A-V: 285.66+-44.36 ms DispTime: 33.11 ms hurry_up: 1
A-V: 254.77+-38.49 ms DispTime: 28.44 ms hurry_up: 1
A-V: 228.08+-42.72 ms DispTime: 29.19 ms hurry_up: 1
A-V: 204.85+-26.24 ms DispTime: 33.07 ms hurry_up: 1
A-V: 220.18+-25.49 ms DispTime: 33.59 ms hurry_up: 1
A-V: 203.31+-35.22 ms DispTime: 33.13 ms hurry_up: 1
A-V: 206.08+-24.27 ms DispTime: 32.99 ms hurry_up: 1
A-V: 256.04+-28.92 ms DispTime: 36.72 ms hurry_up: 1
A-V: 259.60+-18.55 ms DispTime: 31.84 ms hurry_up: 1
A-V: 255.12+-26.27 ms DispTime: 34.00 ms hurry_up: 1
A-V: 247.73+-26.92 ms DispTime: 33.57 ms hurry_up: 1
A-V: 275.72+-36.65 ms DispTime: 34.50 ms hurry_up: 1
A-V: 285.67+-33.00 ms DispTime: 33.62 ms hurry_up: 1
A-V: 288.99+-34.04 ms DispTime: 33.19 ms hurry_up: 1
A-V: 307.00+-9.51 ms DispTime: 33.02 ms hurry_up: 1
A-V: 281.63+-29.35 ms DispTime: 29.73 ms hurry_up: 1
A-V: 270.43+-21.91 ms DispTime: 33.20 ms hurry_up: 1
A-V: 221.02+-31.85 ms DispTime: 29.36 ms hurry_up: 1
A-V: 208.27+-35.88 ms DispTime: 32.31 ms hurry_up: 1
A-V: 214.67+-29.64 ms DispTime: 37.29 ms hurry_up: 1
A-V: 251.75+-30.69 ms DispTime: 34.73 ms hurry_up: 1
A-V: 258.38+-28.08 ms DispTime: 32.32 ms hurry_up: 1
A-V: 254.00+-21.50 ms DispTime: 32.42 ms hurry_up: 1
A-V: 267.78+-17.05 ms DispTime: 32.77 ms hurry_up: 1
A-V: 263.08+-18.45 ms DispTime: 32.35 ms hurry_up: 1
A-V: 249.49+-34.94 ms DispTime: 32.39 ms hurry_up: 1
A-V: 257.46+-21.21 ms DispTime: 33.45 ms hurry_up: 1
A-V: 223.41+-52.65 ms DispTime: 33.30 ms hurry_up: 1
A-V: 260.07+-22.31 ms DispTime: 32.97 ms hurry_up: 1
A-V: 259.14+-17.84 ms DispTime: 32.69 ms hurry_up: 1
A-V: 232.45+-44.66 ms DispTime: 33.64 ms hurry_up: 1
A-V: 246.41+-28.99 ms DispTime: 32.78 ms hurry_up: 1

Cheers,

Laz



From nhuillard at e-dition.fr  Fri Sep 23 14:57:00 2005
From: nhuillard at e-dition.fr (Nicolas Huillard)
Date: Fri, 23 Sep 2005 14:57:00 +0200
Subject: [Softdevice-devel] A-V sync problems with directfb on	unichrome...
In-Reply-To: <1127465509.2670.12.camel@laser2.york.ac.uk>
References: <1127384905.27018.27.camel@laser2.york.ac.uk>	 <4332E3EE.6060401@gmx.net> <1127465509.2670.12.camel@laser2.york.ac.uk>
Message-ID: <4333FB9C.10409@e-dition.fr>

Laurence Abbott a ?crit :
> On Thu, 2005-09-22 at 19:03 +0200, Martin Wache wrote:
>>About the source of the bad A-V sync I'm not sure... As far as I
>>remember DireftFB out tries to sync to the refreshrate of the TV. Are
>>you using a TV for output? What is the refreshrate of the videomode?
>>Could you please check if you see a line
>>[dfb] Display frame time is XXX microseconds
>>on the stdout and report that time?
> 
> I have both a (PAL) TV and monitor attached. Both are running at 50 Hz
> (TV because it's PAL, and monitor reports as such on it's OSD). The
> output shows:

When TV is connected, the monitor wollows the same refresh rate (but
non-interlaced). So 50Hz is right.

> How good is A-V sync on unichrome with directfb output when it hasn't
> been patched for field-sync? Looking through the list archives, most of
> the development seems to be done on Matrox cards. Is unichrome output
> known to be less good at present because not many people are using /
> testing it?

Unichrome is perfect for me, without the field-sync patches (I abuse of
image scaling, so respecting fields is not mandatory).

-- 
NH


From laz at club-burniston.co.uk  Fri Sep 23 15:22:23 2005
From: laz at club-burniston.co.uk (Laurence Abbott)
Date: Fri, 23 Sep 2005 14:22:23 +0100
Subject: [Softdevice-devel] A-V sync problems with directfb on
	unichrome...
In-Reply-To: <4333FB9C.10409@e-dition.fr>
References: <1127384905.27018.27.camel@laser2.york.ac.uk>
	 <4332E3EE.6060401@gmx.net> <1127465509.2670.12.camel@laser2.york.ac.uk>
	 <4333FB9C.10409@e-dition.fr>
Message-ID: <1127481743.5281.10.camel@laser2.york.ac.uk>

On Fri, 2005-09-23 at 14:57 +0200, Nicolas Huillard wrote:
> Laurence Abbott a ?crit :
> > How good is A-V sync on unichrome with directfb output when it hasn't
> > been patched for field-sync? Looking through the list archives, most of
> > the development seems to be done on Matrox cards. Is unichrome output
> > known to be less good at present because not many people are using /
> > testing it?
> 
> Unichrome is perfect for me, without the field-sync patches (I abuse of
> image scaling, so respecting fields is not mandatory).

Is this with a vt1622 or vt1622a? I'm not sure whether that would make
any difference for this or not but you never know! The picture I'm
getting is really good with the field-sync and NoScale mode patches,
apart from the A-V sync problems I'm having.

What pixel format and buffer mode are you using? Both I420 and YUY2 work
for me but YV12 gives the wrong colour. I420 encoding prints lots of '+'
in the output, whereas I don't think YUY2 does. I've had a couple of
SEGVs with YUY2 in yv12_to_yuy2:

Program received signal SIGSEGV, Segmentation fault.
[Switching to Thread 1949713 (LWP 16448)]
yv12_to_yuy2 (ysrc=0x9941550 '\020' <repeats 200 times>...,
    usrc=0x96d2e88 '\200' <repeats 200 times>...,
    vsrc=0x96f5d98 '\200' <repeats 200 times>...,
    dst=0xb6804bc0 <Address 0xb6804bc0 out of bounds>, width=704, height=576,
    lumStride=736, chromStride=368, dstStride=1088) at utils.c:81
81            movntq(mm0,*srfc);        // Am Meisten brauchen die Speicherzugri
ffe
Current language:  auto; currently c++
(gdb) bt
#0  yv12_to_yuy2 (ysrc=0x9941550 '\020' <repeats 200 times>...,
    usrc=0x96d2e88 '\200' <repeats 200 times>...,
    vsrc=0x96f5d98 '\200' <repeats 200 times>...,
    dst=0xb6804bc0 <Address 0xb6804bc0 out of bounds>, width=704, height=576,
    lumStride=736, chromStride=368, dstStride=1088) at utils.c:81
#1  0xb728a82e in cDFBVideoOut::YUV (this=0x8581c50,
    Py=0x98da030 '\020' <repeats 200 times>...,
    Pu=0x96b91f8 '\200' <repeats 200 times>...,
    Pv=0x96dc108 '\200' <repeats 200 times>..., Width=0, Height=0, Ystride=0,
    UVstride=368) at video-dfb.c:1194
#2  0xb727bfb4 in cVideoOut::DrawVideo_420pl (this=0x8581c50, syncTimer=0x96f736
0,
    delay=0x934fd54, picture=0x94b80d0, context=0x95ac138) at video.c:397
#3  0xb727f38b in cVideoStreamDecoder::DecodePacket (this=0x934faf0, pkt=0x8f1a7
80)
    at mpeg2decoder.c:603
#4  0xb727e199 in cStreamDecoder::Action (this=0x934faf0) at mpeg2decoder.c:188
#5  0x08100366 in cThread::StartThread (Thread=0x934faf0) at thread.c:234
#6  0xb7f6af3c in pthread_start_thread () from /lib/libpthread.so.0
#7  0xb7f6afca in pthread_start_thread_event () from /lib/libpthread.so.0
#8  0xb7e158ba in clone () from /lib/libc.so.6

Now, this _may_ have been before I commented out the USE_MMX2 define, so
it may have been trying to use instructions that weren't available,
although it did take a few hours of use before the SEGV so maybe not.
Not really tested YUY2 at any length since.

I just did some more tests over lunch and can report that although both
live TV and recordings have wandering A-V sync (although there was about
20 s when it was perfect!), playing back vdr recordings with softplay
seems perfect, apart from a few seconds out of sync when I skip about in
recordings.

Using softplay for playback may suffice as a stop-gap for now: I'm
trying to migrate over to this Epia machine as my main vdr box because
my other vdr box has a hardare fault somewhere which stops it booting
from time to time missing timed events!

Cheers,

Laz



From M.Wache at gmx.net  Sat Sep 24 12:44:16 2005
From: M.Wache at gmx.net (Martin Wache)
Date: Sat, 24 Sep 2005 12:44:16 +0200
Subject: [Softdevice-devel] A-V sync problems with directfb on	unichrome...
In-Reply-To: <1127467072.2670.20.camel@laser2.york.ac.uk>
References: <1127384905.27018.27.camel@laser2.york.ac.uk>	 <4332E3EE.6060401@gmx.net> <1127467072.2670.20.camel@laser2.york.ac.uk>
Message-ID: <43352E00.7030206@gmx.net>

Laurence Abbott schrieb:
> On Thu, 2005-09-22 at 19:03 +0200, Martin Wache wrote:
> 
>>However I think that the nans you see are just because I was a bit lazy
>>with the conversions: (float)dispTime/1000  is not necessarly of type
>>float again. Probably an additional conversion or replacing 1000 by
>>1000.0 helps, I think I remember that some compilers didn't like these
>>constructs.
> 
> 
> Here are is some output from added '.0' with both BPGDEb and AV_STATS
> defined:
> 
> (short section posted here: full log from ca. 20 s run at
> http://vdr.club-burniston.co.uk/vdr_MPGDEB.log.gz):

> mpegdec[6765]:Frame# 474   A-V(ms) 1906  delay -52279 FrameT: P_t, dispTime(ms):
> 12.28
> mpegdec[6776]:Got pts: pictno 476  pts: 518270682 lastIdx 7
> mpegdec[6776]:video pts: 518270682, values.pkt : 518270682 pts - valid PTS: 0 pic
> tno: 476 idx: 6
> mpegdec[6802]:audio: count: 824  Length: 576 len: 576 a_size: 4608 a_delay: 1201
> mpegdec[6802]:audio pts 518274746 pkt->PTS : 518274746 pts - valid PTS: 0
> mpegdec[6802]:audio pts offset -149357279
> mpegdec[6802]:a_delay 1438 at end of decode
> mpegdec[6804]:audio: count: 825  Length: 576 len: 576 a_size: 4608 a_delay: 1426
> mpegdec[6804]:audio pts offset -149357279
> mpegdec[6804]:a_delay 1666 at end of decode
> mpegdec[6805]:audio: count: 826  Length: 576 len: 576 a_size: 4608 a_delay: 1656
> mpegdec[6805]:audio pts offset -149357279
> mpegdec[6805]:a_delay 1895 at end of decode
> mpegdec[6832]:Frame# 475   A-V(ms) 2249  delay -87990 FrameT: B_t, dispTime(ms):
> 56.33
> mpegdec[6843]:Got pts: pictno 477  pts: 518271082 lastIdx 8
> 
Ok, so the problem was not the nan's, but still I can not see anything
wrong in mpeg2decoder. Unfortunatly some of the a-v sync debuging output
has been removed by Stefan when he moved the waiting to the video out,
and also the dispTime is meaningless.
What I can say is that mpeg2decoder nows quite well that the A-V sync is
bad and tries to compensate, in you log the video is behind the audio,
and thus the delay is even negative which means there should be no delay
at all. But still it takes more than 40 ms between two frames.
I currently see two options: first, your computer is too slow, or second
the video-out waits at some point even though the requested delay is
negative.
Probably you should try to switch of the wait on sync in the directFB-out.
Stefan, is this easily possible?

Unfortunalty I'm a bit short on time right now otherwise I would add
some more debugging to be able to distinguish between the two options.
But I will be away the next week, so I wont be able to read my e-mails
until the next weekend :-/

Bye,
Martin


From stefan at lucke.in-berlin.de  Sat Sep 24 13:09:25 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 24 Sep 2005 13:09:25 +0200
Subject: [Softdevice-devel] A-V sync problems with directfb =?iso-8859-15?q?on=09unichrome=2E=2E=2E?=
In-Reply-To: <43352E00.7030206@gmx.net>
References: <1127384905.27018.27.camel@laser2.york.ac.uk> <1127467072.2670.20.camel@laser2.york.ac.uk> <43352E00.7030206@gmx.net>
Message-ID: <200509241309.25991.stefan@lucke.in-berlin.de>

On Samstag, 24. September 2005 12:44, Martin Wache wrote:
> Laurence Abbott schrieb:
> > On Thu, 2005-09-22 at 19:03 +0200, Martin Wache wrote:
> > 
> >>However I think that the nans you see are just because I was a bit lazy
> >>with the conversions: (float)dispTime/1000  is not necessarly of type
> >>float again. Probably an additional conversion or replacing 1000 by
> >>1000.0 helps, I think I remember that some compilers didn't like these
> >>constructs.
> > 
> > 
> > Here are is some output from added '.0' with both BPGDEb and AV_STATS
> > defined:
> > 
> > (short section posted here: full log from ca. 20 s run at
> > http://vdr.club-burniston.co.uk/vdr_MPGDEB.log.gz):
> 
> > mpegdec[6765]:Frame# 474   A-V(ms) 1906  delay -52279 FrameT: P_t, dispTime(ms):
> > 12.28
> > mpegdec[6776]:Got pts: pictno 476  pts: 518270682 lastIdx 7
> > mpegdec[6776]:video pts: 518270682, values.pkt : 518270682 pts - valid PTS: 0 pic
> > tno: 476 idx: 6
> > mpegdec[6802]:audio: count: 824  Length: 576 len: 576 a_size: 4608 a_delay: 1201
> > mpegdec[6802]:audio pts 518274746 pkt->PTS : 518274746 pts - valid PTS: 0
> > mpegdec[6802]:audio pts offset -149357279
> > mpegdec[6802]:a_delay 1438 at end of decode
> > mpegdec[6804]:audio: count: 825  Length: 576 len: 576 a_size: 4608 a_delay: 1426
> > mpegdec[6804]:audio pts offset -149357279
> > mpegdec[6804]:a_delay 1666 at end of decode
> > mpegdec[6805]:audio: count: 826  Length: 576 len: 576 a_size: 4608 a_delay: 1656
> > mpegdec[6805]:audio pts offset -149357279
> > mpegdec[6805]:a_delay 1895 at end of decode
> > mpegdec[6832]:Frame# 475   A-V(ms) 2249  delay -87990 FrameT: B_t, dispTime(ms):
> > 56.33
> > mpegdec[6843]:Got pts: pictno 477  pts: 518271082 lastIdx 8
> > 
> Ok, so the problem was not the nan's, but still I can not see anything
> wrong in mpeg2decoder. Unfortunatly some of the a-v sync debuging output
> has been removed by Stefan when he moved the waiting to the video out,
> and also the dispTime is meaningless.
> What I can say is that mpeg2decoder nows quite well that the A-V sync is
> bad and tries to compensate, in you log the video is behind the audio,
> and thus the delay is even negative which means there should be no delay
> at all. But still it takes more than 40 ms between two frames.
> I currently see two options: first, your computer is too slow, or second
> the video-out waits at some point even though the requested delay is
> negative.
> Probably you should try to switch of the wait on sync in the directFB-out.
> Stefan, is this easily possible?

That should be easy. For I420 and YV12 modes, it's around line 1260.
videoSurface->Flip(NULL, DSFLIP_ONSYNC);
could be changed to:
videoSurface->Flip();
or:
videoSurface->Flip(NULL, DSFLIP_WAITFORSYNC);

The actual handling and meaning of displaydelay handling is, that in
case we are a bit early there is is not nedd to sleep. "A bit early" should
be translated we arrived between display_time and display_time - 1_frametime.

For following the mails on the directfb lists, there was one thing which makes
me puzzeld: the cpu load dropped after some kernel/directfb patches
were applied, from around 70% to 30% percent, and that is too low.

Currently I'm on the way to upgrade my epia test system. That is now on:
	kernel: 2.6.13.2
		epia-patch from patcher2k: patcher2k.viafb_03.diff
	directfb:
		cvs from today (2005-09-23).


-- 
Stefan Lucke



From laz at club-burniston.co.uk  Sat Sep 24 14:26:53 2005
From: laz at club-burniston.co.uk (Laz)
Date: Sat, 24 Sep 2005 13:26:53 +0100
Subject: [Softdevice-devel] A-V sync problems with directfb =?iso-8859-15?q?on=09unichrome=2E=2E=2E?=
In-Reply-To: <200509241309.25991.stefan@lucke.in-berlin.de>
References: <1127384905.27018.27.camel@laser2.york.ac.uk> <43352E00.7030206@gmx.net> <200509241309.25991.stefan@lucke.in-berlin.de>
Message-ID: <200509241326.53901.laz@club-burniston.co.uk>

On Saturday 24 September 2005 12:09, Stefan Lucke wrote:
> On Samstag, 24. September 2005 12:44, Martin Wache wrote:

> > Ok, so the problem was not the nan's, but still I can not see anything
> > wrong in mpeg2decoder. Unfortunatly some of the a-v sync debuging output
> > has been removed by Stefan when he moved the waiting to the video out,
> > and also the dispTime is meaningless.
> > What I can say is that mpeg2decoder nows quite well that the A-V sync is
> > bad and tries to compensate, in you log the video is behind the audio,
> > and thus the delay is even negative which means there should be no delay
> > at all. But still it takes more than 40 ms between two frames.
> > I currently see two options: first, your computer is too slow, or second
> > the video-out waits at some point even though the requested delay is
> > negative.

The speed shouldn't be a problem because I think it works fine without the 
field-sync patches.

> > Probably you should try to switch of the wait on sync in the
> > directFB-out. Stefan, is this easily possible?
>
> That should be easy. For I420 and YV12 modes, it's around line 1260.
> videoSurface->Flip(NULL, DSFLIP_ONSYNC);
> could be changed to:
> videoSurface->Flip();
> or:
> videoSurface->Flip(NULL, DSFLIP_WAITFORSYNC);

I've just tried both of them and I don't see any real differences between 
them!

Does StretchBlit work on Unichrome? Should I try enabling that? I think it 
bailed out when I tried it before.

> The actual handling and meaning of displaydelay handling is, that in
> case we are a bit early there is is not nedd to sleep. "A bit early" should
> be translated we arrived between display_time and display_time -
> 1_frametime.
>
> For following the mails on the directfb lists, there was one thing which
> makes me puzzeld: the cpu load dropped after some kernel/directfb patches
> were applied, from around 70% to 30% percent, and that is too low.

I'm not sure how I was getting those low values but that was before I'd got it 
working properly. As I have it now (df_xine works fine but softdevice A-V 
sync bad and variable) I'm generally seeing about 50% CPU usage for vdr + 
softdevice.

> Currently I'm on the way to upgrade my epia test system. That is now on:
> 	kernel: 2.6.13.2
> 		epia-patch from patcher2k: patcher2k.viafb_03.diff
> 	directfb:
> 		cvs from today (2005-09-23).

Denis Oliver Kropp is working on patching that patch(!) and submitting the 
changes back to patcher2k. See 
http://mail.directfb.org/pipermail/directfb-users/2005-September/000660.html

He's also working on implementing hardware MPEG decoding into DirectFB.

Cheers,

Laz


From leo at calidae.net  Mon Sep 26 14:32:51 2005
From: leo at calidae.net (=?ISO-8859-1?Q?Leo_M=E1rquez?=)
Date: Mon, 26 Sep 2005 14:32:51 +0200
Subject: [Softdevice-devel] definitive configuration
In-Reply-To: <431572D3.1@e-dition.fr>
References: <43154DFD.1040502@calidae.net> <431572D3.1@e-dition.fr>
Message-ID: <4337EA73.9070002@calidae.net>

Hi!,

>I just finished tuning the tv-out tables of the VT1622 present on the
>EPIA M10k board (see thread "viafb kernel frame buffer vs. 720x576 tvout
>no-scale update..." on the directfb-users ML).
>See attached patch. This is a patch against the patcher2k version of the
>viafb kernel frame-buffer driver. Download it on
>http://patcher2k.012webpages.com/, then apply my patch to have correct
>TV-out.
>You should also use the following /etc/fb.modes :
>-----------------
>mode "720x576-50"
>    geometry 720 576 720 576 16
>    timings 35714 32 8 46 0 136 3
>endmode
>-----------------
>Once you have this, you can go with vdr + softdevice et al.
>
I'm trying to patch viafb_03.diff with your patch but I get:

vdr:/usr/src/patcher_cle266# patch -p1 < via_tv3-720x576noscale.diff
missing header for unified diff at line 3 of patch
can't find file to patch at input line 3
Perhaps you used the wrong -p or --strip option?
The text leading up to this was:
--------------------------
|--- via_tv3.h.orig     2005-08-21 18:04:11.000000000 +0200
|+++ via_tv3.h  2005-08-30 23:38:34.000000000 +0200
--------------------------
File to patch: viafb_03.diff
patching file viafb_03.diff
Hunk #1 FAILED at 350.
1 out of 1 hunk FAILED -- saving rejects to file viafb_03.diff.rej

What command do you do to apply the patch correctly?

Thanks

Leo


From stefan at lucke.in-berlin.de  Tue Sep 27 01:28:41 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 27 Sep 2005 01:28:41 +0200
Subject: [Softdevice-devel] A-V sync problems with directfb =?iso-8859-15?q?on=09unichrome=2E=2E=2E?=
In-Reply-To: <200509241326.53901.laz@club-burniston.co.uk>
References: <1127384905.27018.27.camel@laser2.york.ac.uk> <200509241309.25991.stefan@lucke.in-berlin.de> <200509241326.53901.laz@club-burniston.co.uk>
Message-ID: <200509270128.41707.stefan@lucke.in-berlin.de>

On Samstag, 24. September 2005 14:26, Laz wrote:
> On Saturday 24 September 2005 12:09, Stefan Lucke wrote:
> > On Samstag, 24. September 2005 12:44, Martin Wache wrote:
> 
> > > Ok, so the problem was not the nan's, but still I can not see anything
> > > wrong in mpeg2decoder. Unfortunatly some of the a-v sync debuging output
> > > has been removed by Stefan when he moved the waiting to the video out,
> > > and also the dispTime is meaningless.
> > > What I can say is that mpeg2decoder nows quite well that the A-V sync is
> > > bad and tries to compensate, in you log the video is behind the audio,
> > > and thus the delay is even negative which means there should be no delay
> > > at all. But still it takes more than 40 ms between two frames.
> > > I currently see two options: first, your computer is too slow, or second
> > > the video-out waits at some point even though the requested delay is
> > > negative.
> 
> The speed shouldn't be a problem because I think it works fine without the 
> field-sync patches.
> 
> > > Probably you should try to switch of the wait on sync in the
> > > directFB-out. Stefan, is this easily possible?
> >
> > That should be easy. For I420 and YV12 modes, it's around line 1260.
> > videoSurface->Flip(NULL, DSFLIP_ONSYNC);
> > could be changed to:
> > videoSurface->Flip();
> > or:
> > videoSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
> 
> I've just tried both of them and I don't see any real differences between 
> them!
> 
> Does StretchBlit work on Unichrome? Should I try enabling that? I think it 
> bailed out when I tried it before.

Stretchblit doesn't work accelerated I think.

So for now I did a short test on my gentoo epia system. My old gentoo
does not like my new kernel. No sound device available. With the old kernel
2.6.7, there is a strange A/V sync behavior vieable. Recordings started at
full speed, ways too fast. Video is not throttled to audio. Could it be
that rtc timer does not work ? My main systems cannot use /dev/rtc
for syncing as chrony has this device. But on my epia box, there is no chrony.

Can you try to choose another sync timer ? mpeg2decoder line 463:
syncTimer = new cSyncTimer (emRtcTimer);

change emRtcTimer to emSigTimer or emUsleepTimer .
Shouldn't that be emSigTimer always ?

Let's see when emerge -e world finishs .


-- 
Stefan Lucke



From laz at club-burniston.co.uk  Tue Sep 27 10:29:14 2005
From: laz at club-burniston.co.uk (Laz)
Date: Tue, 27 Sep 2005 09:29:14 +0100 (BST)
Subject: [Softdevice-devel] A-V sync problems with directfb
In-Reply-To: <200509270128.41707.stefan@lucke.in-berlin.de>
References: <1127384905.27018.27.camel@laser2.york.ac.uk>
    <200509241309.25991.stefan@lucke.in-berlin.de>
    <200509241326.53901.laz@club-burniston.co.uk>
    <200509270128.41707.stefan@lucke.in-berlin.de>
Message-ID: <1066.144.32.52.69.1127809754.squirrel@webmail.projectmeerkat.co.uk>

Hmmmm...I've rebuilt vdr and all plugins from scratch and not it seems to
behave itself more. If I set A-V Delay to -1 I get almost perfect A-V sync
 (this didn't seem to have any effect before!). Unfortunately, I'm getting
lots of clicks and dropouts in the sound (before, the sounds was fine...).
The video is relatively smooth but dropps the odd frame every few seconds.
Sometimes it seems to skip forward about a second or so! Similar effects
with both live TV and replaying recordings.

I've no idea what I've done to make it get to this stage but it is quite
watchable, once you get used to the sound dropouts!

>> I've just tried both of them and I don't see any real differences
>> between
>> them!

Tried again, and changing the Flip to WAITFORSYNC made it replay stuff in
slow motion, somehow.

>> Does StretchBlit work on Unichrome? Should I try enabling that? I think
>> it
>> bailed out when I tried it before.
>
> Stretchblit doesn't work accelerated I think.

I'm now in the process of comparing the source of df_xine and video-dfb.c.
I get perfect playback from df_xine which, as far as I can tell, is using
StretchBlit (although I've only tested with 720x576 video on a 720x576
framebuffer so far). It also uses the WAITFORSYNC flag for the Flip.

If df_xine can do it, I'm sure softdevice can be convinced to give me
smooth video and audio!

:-)

> So for now I did a short test on my gentoo epia system. My old gentoo
> does not like my new kernel. No sound device available. With the old
> kernel
> 2.6.7, there is a strange A/V sync behavior vieable. Recordings started at
> full speed, ways too fast. Video is not throttled to audio. Could it be
> that rtc timer does not work ? My main systems cannot use /dev/rtc
> for syncing as chrony has this device. But on my epia box, there is no
> chrony.
>
> Can you try to choose another sync timer ? mpeg2decoder line 463:
> syncTimer = new cSyncTimer (emRtcTimer);
>
> change emRtcTimer to emSigTimer or emUsleepTimer .
> Shouldn't that be emSigTimer always ?

I'll look into rtc and timer issues this evening.

> Let's see when emerge -e world finishs .

I gave up on gentoo because it always used to drag in packages which
required a rebuild of loads of stuff!

Cheers,

Laz


From stefan at lucke.in-berlin.de  Wed Sep 28 00:04:06 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 28 Sep 2005 00:04:06 +0200
Subject: [Softdevice-devel] A-V sync problems with directfb =?iso-8859-15?q?on=09unichrome=2E=2E=2E?=
In-Reply-To: <200509270128.41707.stefan@lucke.in-berlin.de>
References: <1127384905.27018.27.camel@laser2.york.ac.uk> <200509241326.53901.laz@club-burniston.co.uk> <200509270128.41707.stefan@lucke.in-berlin.de>
Message-ID: <200509280004.07054.stefan@lucke.in-berlin.de>

On Dienstag, 27. September 2005 01:28, Stefan Lucke wrote:
> On Samstag, 24. September 2005 14:26, Laz wrote:
> > On Saturday 24 September 2005 12:09, Stefan Lucke wrote:
> > > On Samstag, 24. September 2005 12:44, Martin Wache wrote:
> > 
> > > > Ok, so the problem was not the nan's, but still I can not see anything
> > > > wrong in mpeg2decoder. Unfortunatly some of the a-v sync debuging output
> > > > has been removed by Stefan when he moved the waiting to the video out,
> > > > and also the dispTime is meaningless.
> > > > What I can say is that mpeg2decoder nows quite well that the A-V sync is
> > > > bad and tries to compensate, in you log the video is behind the audio,
> > > > and thus the delay is even negative which means there should be no delay
> > > > at all. But still it takes more than 40 ms between two frames.
> > > > I currently see two options: first, your computer is too slow, or second
> > > > the video-out waits at some point even though the requested delay is
> > > > negative.
> > 
> > The speed shouldn't be a problem because I think it works fine without the 
> > field-sync patches.
> > 
> > > > Probably you should try to switch of the wait on sync in the
> > > > directFB-out. Stefan, is this easily possible?
> > >
> > > That should be easy. For I420 and YV12 modes, it's around line 1260.
> > > videoSurface->Flip(NULL, DSFLIP_ONSYNC);
> > > could be changed to:
> > > videoSurface->Flip();
> > > or:
> > > videoSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
> > 
> > I've just tried both of them and I don't see any real differences between 
> > them!
> > 
> > Does StretchBlit work on Unichrome? Should I try enabling that? I think it 
> > bailed out when I tried it before.
> 
> Stretchblit doesn't work accelerated I think.


From laz at club-burniston.co.uk  Wed Sep 28 10:52:42 2005
From: laz at club-burniston.co.uk (Laz)
Date: Wed, 28 Sep 2005 09:52:42 +0100 (BST)
Subject: [Softdevice-devel] A-V sync problems with directfb on
In-Reply-To: <200509280004.07054.stefan@lucke.in-berlin.de>
References: <1127384905.27018.27.camel@laser2.york.ac.uk>
    <200509241326.53901.laz@club-burniston.co.uk>
    <200509270128.41707.stefan@lucke.in-berlin.de>
    <200509280004.07054.stefan@lucke.in-berlin.de>
Message-ID: <47841.144.32.128.73.1127897562.squirrel@webmail.projectmeerkat.co.uk>

> On Dienstag, 27. September 2005 01:28, Stefan Lucke wrote:
>> Stretchblit doesn't work accelerated I think.
>
> From directfb web page: stretchbilt is supported, but not from
> an YV12, YUY2 surface ton an rgb surface.

Ahhhh...if I enable it, the OSD goes really transparent and weird colours!

>> So for now I did a short test on my gentoo epia system. My old gentoo
>> does not like my new kernel. No sound device available. With the old
>> kernel
>> 2.6.7, there is a strange A/V sync behavior vieable. Recordings started
>> at
>> full speed, ways too fast. Video is not throttled to audio. Could it be
>> that rtc timer does not work ? My main systems cannot use /dev/rtc
>> for syncing as chrony has this device. But on my epia box, there is no
>> chrony.
>
> Found the reason, but not the fault :-) .
> Reported display time is very strange:
>
> [dfb] Display frame time is 99949 microseconds
>
> As a hack I set that to 16667. There should be some bounds check or some
> more measurement points.
>
> This strange display time is reproducable after each reconfigure.
>
> [dfb] (re)configured 0x08100609
> [dfb] Display frame time is 99949 microseconds
> [dfb] Display frame time is 99950 microseconds

Hmmmmm...I saw this and thought it might be my problem too. Just checked,
and I see: [dfb] Display frame time is 19997 microseconds, which works out
as about 50 Hz (PAL). Did you mean this value or are you using NTSC?

> I cannot say very much about sync as audio out seems to broken.
> Both active speaker sets are nearly and almost silent. But there
> are no '+' chars written for skipping frames.

I'm not currently seeing any '+' in the output. I think there must be a
race condition or something because I sometimes get loads of them under
the same conditions!

> Cpu load is around 45% for recordings (no tuner connected) 1GHz Nehemia.
>>
>> Can you try to choose another sync timer ? mpeg2decoder line 463:
>> syncTimer = new cSyncTimer (emRtcTimer);
>>
>> change emRtcTimer to emSigTimer or emUsleepTimer .
>> Shouldn't that be emSigTimer always ?

Tried both last night:
emSigTimer: one frame about every 3 seconds! CPU usage ca. 3%! ;-)
emUsleepTimer: played about half speed.

I've enabled more debug statements in sync-timer.c and get lots of 'Set up
to use linux RTC' messages. I saw about 5 'Could not open /dev/rtc'
messages over about 5 h. Maybe I have a cron job that's grabbing it or
something but it can't be the cause of my problems.

Cheers,

Laz


From marko.makela at hut.fi  Wed Sep 28 18:46:22 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 28 Sep 2005 19:46:22 +0300
Subject: [Softdevice-devel] very wide aspect ratio
Message-ID: <20050928164622.GB269465@kosh.hut.fi>

I came across to a recording that misleads softdevice to display some very weird
aspect ratio, something like 4:1 instead of the correct 16:9.

I sent a link to the clip privately to Stefan Lucke.

Suggested fix: if the aspect ratio is reported as wider than 16:9 or narrower than
4:3, clamp it to these values.

If you can't repeat this, please let me know.  I haven't updated softdevice or
ffmpeg cvs for a couple of weeks now.  I'm using vdr 1.3.33.

	Marko


From stefan at lucke.in-berlin.de  Thu Sep 29 00:38:27 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 29 Sep 2005 00:38:27 +0200
Subject: [Softdevice-devel] A-V sync problems with directfb on
In-Reply-To: <47841.144.32.128.73.1127897562.squirrel@webmail.projectmeerkat.co.uk>
References: <1127384905.27018.27.camel@laser2.york.ac.uk> <200509280004.07054.stefan@lucke.in-berlin.de> <47841.144.32.128.73.1127897562.squirrel@webmail.projectmeerkat.co.uk>
Message-ID: <200509290038.27585.stefan@lucke.in-berlin.de>

On Mittwoch, 28. September 2005 10:52, Laz wrote:
> > On Dienstag, 27. September 2005 01:28, Stefan Lucke wrote:

> > As a hack I set that to 16667. There should be some bounds check or some
> > more measurement points.
> >
> > This strange display time is reproducable after each reconfigure.
> >
> > [dfb] (re)configured 0x08100609
> > [dfb] Display frame time is 99949 microseconds
> > [dfb] Display frame time is 99950 microseconds
> 
> Hmmmmm...I saw this and thought it might be my problem too. Just checked,
> and I see: [dfb] Display frame time is 19997 microseconds, which works out
> as about 50 Hz (PAL). Did you mean this value or are you using NTSC?

I'm using the VGA out, and the LCD monitor needs 60Hz (16667 us).

> 
> > I cannot say very much about sync as audio out seems to broken.
> > Both active speaker sets are nearly and almost silent. But there
> > are no '+' chars written for skipping frames.
> 
> I'm not currently seeing any '+' in the output. I think there must be a
> race condition or something because I sometimes get loads of them under
> the same conditions!
> 

> 
> Tried both last night:
> emSigTimer: one frame about every 3 seconds! CPU usage ca. 3%! ;-)
> emUsleepTimer: played about half speed.

When I set the Flip parameter to DSFLIP_WAITFORSYNC I see many '+'
chars -> frame dropping.

But I'm in a way lost in all those patches floating around.  And searching
information from several list is a real pain. Perhaps we should use our wiki
to collect some facts about each system and symptoms.

I guess the source of your problem is in the unichrome-directfb.diff from
Mark Adams 2005-09-07 on directfb-user list (if you are using that).
Won't say that it is faulty or wrong, but from reading I guess it does
wait always for frame change to happen.

Other applications have a separate thread, which does only the flip.
So they are not affected by that change. 

If someone has the spec sheet for the epia video chip, he should sent
me that via private mail.
I can't believe that this chip has no possibility to report current field.

A real problem for me is that, I don't get any sound out of my epia board.
Would be nice if some could help with a working asound.state for such a
board or required module parms for via82xx. I tried ac97_quirk=[0,1]
but that made no difference.


-- 
Stefan Lucke



From stefan at lucke.in-berlin.de  Thu Sep 29 07:52:51 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 29 Sep 2005 07:52:51 +0200
Subject: [Softdevice-devel] very wide aspect ratio
In-Reply-To: <20050928164622.GB269465@kosh.hut.fi>
References: <20050928164622.GB269465@kosh.hut.fi>
Message-ID: <200509290752.51616.stefan@lucke.in-berlin.de>

On Mittwoch, 28. September 2005 18:46, Marko M?kel? wrote:
> I came across to a recording that misleads softdevice to display some very weird
> aspect ratio, something like 4:1 instead of the correct 16:9.
> 
> I sent a link to the clip privately to Stefan Lucke.
> 
> Suggested fix: if the aspect ratio is reported as wider than 16:9 or narrower than
> 4:3, clamp it to these values.

Stream starts in 4:3 when first mark is
set to 00:00:00.06. Thats the point a can set the first marker (vdr-1.3.32) to.
Videorepacker or ffmpeg. Do jou have some more contend which starts earlier ?
It strange that when starting at the beginning, not further transition is recognized.

> 
> If you can't repeat this, please let me know.  I haven't updated softdevice or
> ffmpeg cvs for a couple of weeks now.  I'm using vdr 1.3.33.


-- 
Stefan Lucke



From marko.makela at hut.fi  Thu Sep 29 08:59:01 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 29 Sep 2005 09:59:01 +0300
Subject: [Softdevice-devel] very wide aspect ratio
In-Reply-To: <200509290752.51616.stefan@lucke.in-berlin.de>
References: <20050928164622.GB269465@kosh.hut.fi> <200509290752.51616.stefan@lucke.in-berlin.de>
Message-ID: <20050929065901.GA3228@localhost.localdomain>

On Thu, Sep 29, 2005 at 07:52:51AM +0200, Stefan Lucke wrote:
> Stream starts in 4:3 when first mark is
> set to 00:00:00.06. Thats the point a can set the first marker (vdr-1.3.32) to.
> Videorepacker or ffmpeg. Do jou have some more contend which starts earlier ?

Sorry, I have never seen this earlier, and I had already deleted the
original recording when I started viewing the cut one.  For the
originally cut recording, marks.vdr is as follows:

0:00:00.01
0:00:16.24
0:08:37.03
0:08:37.15
0:23:57.07
0:23:57.19
0:46:49.15

The second mark, 0:00:16.24 is the mark I added for making the shortened
clip for you.

	Marko


From nhuillard at e-dition.fr  Thu Sep 29 11:23:03 2005
From: nhuillard at e-dition.fr (Nicolas Huillard)
Date: Thu, 29 Sep 2005 11:23:03 +0200
Subject: [Softdevice-devel] A-V sync problems with directfb on
In-Reply-To: <200509290038.27585.stefan@lucke.in-berlin.de>
References: <1127384905.27018.27.camel@laser2.york.ac.uk> <200509280004.07054.stefan@lucke.in-berlin.de> <47841.144.32.128.73.1127897562.squirrel@webmail.projectmeerkat.co.uk> <200509290038.27585.stefan@lucke.in-berlin.de>
Message-ID: <433BB277.8010706@e-dition.fr>

Stefan Lucke a ?crit :
> I guess the source of your problem is in the unichrome-directfb.diff from
> Mark Adams 2005-09-07 on directfb-user list (if you are using that).
> Won't say that it is faulty or wrong, but from reading I guess it does
> wait always for frame change to happen.

Mark doesn't use softdevice, so it might be that softdevice and that
patch do not agree on something.

> Other applications have a separate thread, which does only the flip.
> So they are not affected by that change. 
> 
> If someone has the spec sheet for the epia video chip, he should sent
> me that via private mail.

I have the specs of the VT1622 and VT1622a TV encoders, which are
separate from the CLE266. I didn't find specs of the CLE266, apart from
a PDF describing the setup of the Windows drivers.

> I can't believe that this chip has no possibility to report current field.

I can be understood :
* the CLE266 emits both a digital signal and a VGA output, based on the
same timings
* the TV encoder converts that digital signal to a PAL signal
* when you use both TV and VGA screen, you see 50Hz non-interlaced on
the VGA, and proper PAL on the TV
* thus the CLE266 emits 50Hz full frame non-interlaced
* and the TV encoder drop one field on each frame, alternatively : first
frame, transmit only even lines to the TV / next frame, transmit only
odd lines to the TV
* the TV encoder is only synchronized with the CLE266 on this digital
signal, but does not return field information
* it can only be programmed using I2C, and I didn't see any IRQ line
getting out of the chip

I don't even know how Mark can report proper field, except by counting
each and every frame out from the CLE266, and making sure the TV encoder
starts with the right field upon setup. Any frame miss will lead to the
wrong field identification, until the next frame miss...

> A real problem for me is that, I don't get any sound out of my epia board.
> Would be nice if some could help with a working asound.state for such a
> board or required module parms for via82xx. I tried ac97_quirk=[0,1]
> but that made no difference.

Please see mine attached. I didn't ever edited that file and don't even
know what it contains. I got it from /var/lib/alsa/asound.state on my
EPIA M10k, Debian sarge with an old history. It worked from the beginning.

-- 
NH
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: asound.state
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20050929/a260f497/attachment.ksh>

From laz at club-burniston.co.uk  Thu Sep 29 19:53:31 2005
From: laz at club-burniston.co.uk (Laz)
Date: Thu, 29 Sep 2005 18:53:31 +0100 (BST)
Subject: [Softdevice-devel] A-V sync problems with directfb on
In-Reply-To: <433BB277.8010706@e-dition.fr>
References: <1127384905.27018.27.camel@laser2.york.ac.uk>
    <200509280004.07054.stefan@lucke.in-berlin.de>
    <47841.144.32.128.73.1127897562.squirrel@webmail.projectmeerkat.co.uk>
    <200509290038.27585.stefan@lucke.in-berlin.de>
    <433BB277.8010706@e-dition.fr>
Message-ID: <57089.144.32.128.75.1128016411.squirrel@webmail.projectmeerkat.co.uk>

> Stefan Lucke a ?crit :
>> I guess the source of your problem is in the unichrome-directfb.diff
>> from
>> Mark Adams 2005-09-07 on directfb-user list (if you are using that).
>> Won't say that it is faulty or wrong, but from reading I guess it does
>> wait always for frame change to happen.
>
> Mark doesn't use softdevice, so it might be that softdevice and that
> patch do not agree on something.

That's the gist of it, I think. I get perfect playback with df_xine using
Marks's patches for viafb and DirectFB.

The output I'm getting from softdevice is almost there... I get quite a
smooth picture with the odd dropped frame (or dropped several frames) but
the audio contains a dropout / glitch every second or so! It's justa bout
watchable, once you get used to it!

;-)

>> Other applications have a separate thread, which does only the flip.
>> So they are not affected by that change.

My current feeling is that it is a timing problem somewhere: there is the
frame time determined from two WaitForSync calls (not quite worked out
what this is used for: is this used for timing the Flip calls?).

> I don't even know how Mark can report proper field, except by counting
> each and every frame out from the CLE266, and making sure the TV encoder
> starts with the right field upon setup. Any frame miss will lead to the
> wrong field identification, until the next frame miss...

I think his patch to viafb does make it keep count of the number of fields!

>> A real problem for me is that, I don't get any sound out of my epia
>> board.
>> Would be nice if some could help with a working asound.state for such a
>> board or required module parms for via82xx. I tried ac97_quirk=[0,1]
>> but that made no difference.
>
> Please see mine attached. I didn't ever edited that file and don't even
> know what it contains. I got it from /var/lib/alsa/asound.state on my
> EPIA M10k, Debian sarge with an old history. It worked from the beginning.

I might give it a go, too, to see if it sorts out my bizarre stuttering!

Cheers,

Laz


From stefan at lucke.in-berlin.de  Thu Sep 29 20:59:44 2005
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 29 Sep 2005 20:59:44 +0200
Subject: Epia sound oddity (WAS: Re: [Softdevice-devel] A-V sync problems with directfb on)
Message-ID: <200509292059.44899.stefan@lucke.in-berlin.de>

On Donnerstag, 29. September 2005 11:23, Nicolas Huillard wrote:
> Stefan Lucke a ?crit :

> > A real problem for me is that, I don't get any sound out of my epia board.
> > Would be nice if some could help with a working asound.state for such a
> > board or required module parms for via82xx. I tried ac97_quirk=[0,1]
> > but that made no difference.
> 
> Please see mine attached. I didn't ever edited that file and don't even
> know what it contains. I got it from /var/lib/alsa/asound.state on my
> EPIA M10k, Debian sarge with an old history. It worked from the beginning.

Thank you very much, but this did not work for me either. But it 
brought me to the idea, that it must be a real wired thing.
And it is really brain dead.

So now I can control master volume, without ac97_quirk specified, by the
headphone control. That could be changed by ac97_quirk=1. But with
this quirk set, there was an error message that conlrol.9 is missing.

The total brain dead think is: I have to connect the speakers to the
upper, blue colored connector (usually line in /or 6ch rear out) and
unmute control "Alternate Level to Surround Out"

-- 
Stefan Lucke



From nhuillard at e-dition.fr  Fri Sep 30 11:04:37 2005
From: nhuillard at e-dition.fr (Nicolas Huillard)
Date: Fri, 30 Sep 2005 11:04:37 +0200
Subject: Epia sound oddity (WAS: Re: [Softdevice-devel] A-V sync problems
 with directfb on)
In-Reply-To: <200509292059.44899.stefan@lucke.in-berlin.de>
References: <200509292059.44899.stefan@lucke.in-berlin.de>
Message-ID: <433CFFA5.6030604@e-dition.fr>

Stefan Lucke a ?crit :
> Thank you very much, but this did not work for me either. But it 
> brought me to the idea, that it must be a real wired thing.
> And it is really brain dead.
> 
> So now I can control master volume, without ac97_quirk specified, by the
> headphone control. That could be changed by ac97_quirk=1. But with
> this quirk set, there was an error message that conlrol.9 is missing.
> 
> The total brain dead think is: I have to connect the speakers to the
> upper, blue colored connector (usually line in /or 6ch rear out) and
> unmute control "Alternate Level to Surround Out"

I don't know enough about Alsa to be of very much help, but :

nhuillard at vdr:nhuillard$ dpkg -l '*alsa*' | grep '^ii'
ii  alsa-base      1.0.7-2        ALSA driver configuration files
ii  alsa-headers   1.0.7-2        transitional package that can be
safely remo
ii  alsa-source    1.0.7-2        ALSA driver sources
ii  alsa-utils     1.0.7-2        ALSA utilities
ii  alsaplayer     0.99.76-0.2    PCM player designed for ALSA
ii  alsaplayer-als 0.99.76-0.2    PCM player designed for ALSA (ALSA
output mo
ii  alsaplayer-com 0.99.76-0.2    PCM player designed for ALSA (common
files)
ii  alsaplayer-tex 0.99.76-0.2    PCM player designed for ALSA (text
version)

nhuillard at vdr:nhuillard$ uname -a
Linux vdr 2.6.11 #1 Thu Aug 11 00:21:40 CEST 2005 i686 GNU/Linux

This is a kernel with Debian patches, seld-compiled.

I can send you any conf file you would like to check.

-- 
NH


From marko.makela at hut.fi  Fri Sep 30 20:29:40 2005
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 30 Sep 2005 21:29:40 +0300
Subject: [Softdevice-devel] [PATCH] undefined variables in configure script
Message-ID: <20050930182940.GA339687@kosh.hut.fi>

Hi,

I wondered how my DirectFB key-repeat patch suddenly didn't work.
The configure test worked, albeit with a warning, but config.h
somehow defined HAVE_DIEF_REPEAT 0.  It turned out to be a
misspelled variable.

To prevent this in the future, I suggest that the script
defines "set -eu" to report undefined variables.

	Marko
-------------- next part --------------
Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.4
diff -u -r1.4 configure
--- configure	17 Sep 2005 16:17:15 -0000	1.4
+++ configure	30 Sep 2005 18:22:40 -0000
@@ -5,13 +5,16 @@
 # $Id: configure,v 1.4 2005/09/17 16:17:15 lucke Exp $
 #
 
+set -eu
+
 TMPDIR1="/tmp"
 TMPC="${TMPDIR1}/softdevice-conf-${RANDOM}-$$-${RANDOM}.c"
 TMPE="${TMPDIR1}/softdevice-conf-${RANDOM}-$$-${RANDOM}"
 TMPH="${TMPDIR1}/softdevice-conf-${RANDOM}-$$-${RANDOM}.h"
 TMPM="${TMPDIR1}/softdevice-conf-${RANDOM}-$$-${RANDOM}.mak"
 
-PKG_CONFIG_PATH=$PKG_CONFIG_PATH:/usr/local/lib/pkgconfig/
+: ${PKG_CONFIG_PATH=/usr/local/lib/pkgconfig/}
+: ${CFLAGS=""}
 
 dfb="yes"
 libpostproc="no"
@@ -124,7 +127,7 @@
 #include <directfb.h>
 int main(void) {
     DFBInputEvent event;
-  event.flags |= DIEF_REPEAT;
+  event.flags = DIEF_REPEAT;
   return 0;
 }
 EOF
@@ -243,7 +246,7 @@
     echo "#define HAVE_DSCAPS_DOUBLE              0" >> $TMPH
   fi
 
-  if test "${dfb_dfb_dief_repeat}" = "yes" ; then
+  if test "${dfb_dief_repeat}" = "yes" ; then
     echo "#define HAVE_DIEF_REPEAT                1" >> $TMPH
   else
     echo "#define HAVE_DIEF_REPEAT                0" >> $TMPH

