From hm at seneca.muc.de  Mon Jan  2 23:13:19 2006
From: hm at seneca.muc.de (Harald Milz)
Date: Mon, 2 Jan 2006 23:13:19 +0100
Subject: [Softdevice-devel] MPEG4/H.264 w/ softdevice?
In-Reply-To: <FB3B5DB3197CEA429E5FB8E83D01D0390B0CB8@sbs2003.do-net.de>
References: <FB3B5DB3197CEA429E5FB8E83D01D0390B0CB8@sbs2003.do-net.de>
Message-ID: <20060102221319.GA1703@seneca.muc.de>

On Wed, Dec 28, 2005 at 08:33:12AM +0100, Andre Neumann wrote:
> 
> MPEG4/H.264 decoding is supported by ffmpeg, but i think you muste use
> some dual xeon system or better to get 720p/1080i H.264 material
> decoded.

Does softdevice make use of multiple cores directly? Has anyone tried a
dual-core A64? 

-- 
A real person has two reasons for doing anything ... a good reason and
the real reason.


From Neumann at do-net.de  Tue Jan  3 08:40:02 2006
From: Neumann at do-net.de (Andre Neumann)
Date: Tue, 3 Jan 2006 08:40:02 +0100
Subject: [Softdevice-devel] MPEG4/H.264 w/ softdevice?
Message-ID: <FB3B5DB3197CEA429E5FB8E83D01D0390B0CD1@sbs2003.do-net.de>

The Question is if ffmpeg supports multiple cores. I never tested it,
but i think
you will get better performance with dual-core A64, Intel or Intel HT
CPU.

-------------
Andre Neumann

> -----Original Message-----
> From: softdevice-devel-admin at berlios.de 
> [mailto:softdevice-devel-admin at berlios.de] On Behalf Of Harald Milz
> Sent: Monday, January 02, 2006 11:13 PM
> To: softdevice-devel at berlios.de
> Subject: Re: [Softdevice-devel] MPEG4/H.264 w/ softdevice?
> 
> On Wed, Dec 28, 2005 at 08:33:12AM +0100, Andre Neumann wrote:
> > 
> > MPEG4/H.264 decoding is supported by ffmpeg, but i think 
> you muste use
> > some dual xeon system or better to get 720p/1080i H.264 material
> > decoded.
> 
> Does softdevice make use of multiple cores directly? Has 
> anyone tried a
> dual-core A64? 
> 
> -- 
> A real person has two reasons for doing anything ... a good reason and
> the real reason.
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/softdevice-devel
> 
> 
> 



From M.Wache at gmx.net  Tue Jan  3 18:01:31 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 03 Jan 2006 18:01:31 +0100
Subject: [Softdevice-devel] MPEG4/H.264 w/ softdevice?
In-Reply-To: <20060102221319.GA1703@seneca.muc.de>
References: <FB3B5DB3197CEA429E5FB8E83D01D0390B0CB8@sbs2003.do-net.de> <20060102221319.GA1703@seneca.muc.de>
Message-ID: <43BAADEB.3050200@gmx.net>

Harald Milz schrieb:
> On Wed, Dec 28, 2005 at 08:33:12AM +0100, Andre Neumann wrote:
> 
>>MPEG4/H.264 decoding is supported by ffmpeg, but i think you muste use
>>some dual xeon system or better to get 720p/1080i H.264 material
>>decoded.
> 
> 
> Does softdevice make use of multiple cores directly? Has anyone tried a
> dual-core A64? 
> 
The softdevice uses multiple threads so it make use of multiple cores.
However the decoding of the video is currently done in one thread, so
the gain would be small.
To my knowledge ffmpeg supports decoding in mutliple threads so it
should be not that difficult to use more than one video decoding thread
in the softdevice, but I never had a closer look at that.

Bye,
Martin



From hm at seneca.muc.de  Fri Jan  6 00:14:50 2006
From: hm at seneca.muc.de (Harald Milz)
Date: Fri, 6 Jan 2006 00:14:50 +0100
Subject: [Softdevice-devel] Hint: SPDIF out with SUSE 9.3 / 10.0
Message-ID: <20060105231450.GB2532@seneca.muc.de>

Hi,

a while ago I upgraded my VDR to SL10 just for the heck of it. (more
exactly: to be able to use dvb-kernel with the SL kernel for the Skystar2
card). 

After upgrading, ALSA over SPDIF stopped completely. (mind you, it's both
1.0.9). 

I use

softdevice -ao "alsa:pcm=plug:spdif#ac3=plug:spdif#" -vo dfb:

because I don't want to fiddle with my receiver all the time. 

With SL10, I couldn't even use aplay to play a normal .wav file (S16_LE,
44100) over SPDIF. 

Guess what: After re-installing SL93 everything worked again out of the
box. I have no idea why. 

Hardware: Via VT8235 w/ ALC650. 

Maybe this helps save someone a couple of hours. 


-- 
Those who educate children well are more to be honored than parents,
for these only gave life, those the art of living well.
		-- Aristotle


From hm at seneca.muc.de  Fri Jan  6 00:05:26 2006
From: hm at seneca.muc.de (Harald Milz)
Date: Fri, 6 Jan 2006 00:05:26 +0100
Subject: [Softdevice-devel] MPEG4/H.264 w/ softdevice?
In-Reply-To: <FB3B5DB3197CEA429E5FB8E83D01D0390B0CD1@sbs2003.do-net.de>
References: <FB3B5DB3197CEA429E5FB8E83D01D0390B0CD1@sbs2003.do-net.de>
Message-ID: <20060105230526.GA2532@seneca.muc.de>

On Tue, Jan 03, 2006 at 08:40:02AM +0100, Andre Neumann wrote:
> The Question is if ffmpeg supports multiple cores. I never tested it,
> but i think
> you will get better performance with dual-core A64, Intel or Intel HT
> CPU.

Hmmm - I'd really like to give this a test sooner or later. Currently
I am still somewhat puzzled about vdr/softdevice always using about 55
+/- 5 % CPU on my machine, no matter what clock rate I use (Asus A7V8X,
Athlon XP-M 2400+ @ 1800, G55 DVI, 1280x720p). Could it be that there
is a busy wait somewhere? What I want to say is - how do I see "better
performance" when the machine always uses the same CPU %. 

-- 
Moon, n.:
	1. A celestial object whose phase is very important to
hackers.  See PHASE OF THE MOON.  2. Dave Moon (MOON at MC).


From marko.makela at hut.fi  Fri Jan  6 10:06:57 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 6 Jan 2006 11:06:57 +0200
Subject: [Softdevice-devel] MPEG4/H.264 w/ softdevice?
In-Reply-To: <20060105230526.GA2532@seneca.muc.de>
References: <FB3B5DB3197CEA429E5FB8E83D01D0390B0CD1@sbs2003.do-net.de> <20060105230526.GA2532@seneca.muc.de>
Message-ID: <20060106090648.GA3594@localhost.localdomain>

On Fri, Jan 06, 2006 at 12:05:26AM +0100, Harald Milz wrote:
> On Tue, Jan 03, 2006 at 08:40:02AM +0100, Andre Neumann wrote:
> > The Question is if ffmpeg supports multiple cores. I never tested it,
> > but i think
> > you will get better performance with dual-core A64, Intel or Intel HT
> > CPU.
> 
> Hmmm - I'd really like to give this a test sooner or later. Currently
> I am still somewhat puzzled about vdr/softdevice always using about 55
> +/- 5 % CPU on my machine, no matter what clock rate I use (Asus A7V8X,
> Athlon XP-M 2400+ @ 1800, G55 DVI, 1280x720p). Could it be that there
> is a busy wait somewhere?

Is this with recordings or with live stream?  When I did some OProfile
measurements on my 900 MHz Celeron system last summer or spring, I noticed
that the synchronisation primitives (mutex operations) took much more time
when playing back recordings than when displaying live DVB-T stream.

Have you given OProfile a try?

	Marko


From torgeir at pobox.com  Sat Jan  7 04:42:19 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Sat, 07 Jan 2006 13:42:19 +1000
Subject: [Softdevice-devel] MPEG4/H.264 w/ softdevice?
In-Reply-To: <20060106090648.GA3594@localhost.localdomain>
References: <FB3B5DB3197CEA429E5FB8E83D01D0390B0CD1@sbs2003.do-net.de>
	 <20060105230526.GA2532@seneca.muc.de>
	 <20060106090648.GA3594@localhost.localdomain>
Message-ID: <1136605342.19313.4.camel@localhost.localdomain>

On Fri, 2006-01-06 at 11:06 +0200, Marko M?kel? wrote:
> On Fri, Jan 06, 2006 at 12:05:26AM +0100, Harald Milz wrote:
> > On Tue, Jan 03, 2006 at 08:40:02AM +0100, Andre Neumann wrote:
> > > The Question is if ffmpeg supports multiple cores. I never tested it,
> > > but i think
> > > you will get better performance with dual-core A64, Intel or Intel HT
> > > CPU.
> > 
> > Hmmm - I'd really like to give this a test sooner or later. Currently
> > I am still somewhat puzzled about vdr/softdevice always using about 55
> > +/- 5 % CPU on my machine, no matter what clock rate I use (Asus A7V8X,
> > Athlon XP-M 2400+ @ 1800, G55 DVI, 1280x720p). Could it be that there
> > is a busy wait somewhere?
> 
> Is this with recordings or with live stream?  When I did some OProfile
> measurements on my 900 MHz Celeron system last summer or spring, I noticed
> that the synchronisation primitives (mutex operations) took much more time
> when playing back recordings than when displaying live DVB-T stream.

It's probably some fishyness in dvbplayer.c when playing back
recordings. It probably doesn't happen if playback of the same material
is done using softplay. 

-- 
Torgeir Veimo <torgeir at pobox.com>



From M.Wache at gmx.net  Sat Jan  7 15:49:09 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sat, 07 Jan 2006 15:49:09 +0100
Subject: [Softdevice-devel] new OSD support
Message-ID: <43BFD4E5.8040804@gmx.net>

Hi all,

I just committed the new OSD, which supports up- and down-scaleing,
fixes some problems with software alpha blending mode and should also
fix the shifted menu problem with the dvd-plugin. In most cases it is
also much faster than the old OSD, and hopefully easier to maintain
since it uses less global variables.

I had to modify all four video-out methods, I tested them but of course
I could have missed some new bugs. So please check out the latest
cvs-version and test the softdevice with your favourite video-out methods.

Have fun,

Martin


From Neumann at do-net.de  Sat Jan  7 20:38:50 2006
From: Neumann at do-net.de (Andre Neumann)
Date: Sat, 7 Jan 2006 20:38:50 +0100
Subject: AW: [Softdevice-devel] new OSD support
Message-ID: <FB3B5DB3197CEA429E5FB8E83D01D039D144@sbs2003.do-net.de>

Hi Martin,

Wow, this really sounds good. 2006 is starting great :)

I checked out cvs und compiled the new version, but on startup vdr crashes. Here is the output.
Im using dfb output with a matrox g550.

vdr:/usr/local/bin # ./runvdr
tzap: no process killed
[softdevice] processing args
[softdevice]   argv [0] = softdevice
[softdevice]   argv [1] = -ao
[softdevice] using PCM alsa device spdif
[softdevice] using AC3 alsa device spdif
[softdevice]   argv [3] = -vo
vo_argv: dfb:
[softdevice] initializing Plugin
[softdevice] Initializing Video Out
[softdevice] ffmpeg version(CVS) build(3342336)
[dfb] init
(*) DirectFB/Config: Parsing config file '/etc/directfbrc'.

       ---------------------- DirectFB v0.9.25 ---------------------
             (c) 2000-2002  convergence integrated media GmbH
             (c) 2002-2004  convergence GmbH
        -----------------------------------------------------------

(*) DirectFB/Core: Single Application Core. (2006-01-04 18:36)
(*) Direct/Memcpy: Using MMXEXT optimized memcpy()
(*) Direct/Thread: Running 'VT Switcher' (CRITICAL, 7197)...
(!) Direct/Modules: Could not open module directory `/usr/local/lib/directfb-0.9.25/inputdrivers'!
    --> No such file or directory
(*) DirectFB/Genefx: MMX detected and enabled
(*) DirectFB/Graphics: Matrox G550 0.7 (directfb.org)
(*) DirectFB/Core/WM: Default 0.2 (Convergence GmbH)
 (!!!)  *** UNIMPLEMENTED [fusion_reactor_set_lock] *** [reactor.c:853]
[dfb] RAM: 33554432 bytes
[dfb] Accellerated Functions: FillRectange DrawRectange DrawLine FillTriangle Blit StretchBlit All
[dfb] Drawing Flags: Blend Src.premultiply
[dfb] Surface Blitting Flags: BlendAlpha BlendColorAlpha Colorize SrcColorkey SrcPremultiply Deinterlace
[dfb] Supported video Modes are: 1280x720 at 16 720x576 at 16 1920x1080 at 32
[dfb] Enumerating display Layers
Layer 0 FBDev Primary Layer  Type: graphics
  Caps: brightness contrast saturation surface
Layer 1 Matrox Backend Scaler  Type: graphics picture video
  Caps: brightness contrast deinterlacing dst_colorkey screen_location surface
[surface capabilities] scrSurface: primary videoonly double-buffered flipping
[dfb] width = 1280, height = 720
[dfb] got fmt = 0x00418c04 bpp = 32
[dfb] Using this layer for OSD: (FBDev Primary Layer - [1280x720])
[surface capabilities] osdSurface: videoonly double-buffered flipping
 (!!!)  *** WARNING [letting unprivileged IDirectFBDisplayLayer::GetSurface() call pass until cooperative level handling is finished] *** [idirectfbdisplaylayer.c:170 in IDirectFBDisplayLayer_GetSurface()]
[surface capabilities] videoSurface: videoonly
[dfb] Configuring CooperativeLevel for Overlay
[dfb] Configuring CooperativeLevel for OSD
[dfb] Using this layer for OSD: FBDev Primary Layer
[dfb] Using this layer for Video out: Matrox Backend Scaler
[dfb] Display frame time is 19974 microseconds
[dfb] (re)configuring Videolayer to 720 x 576 (720x576)
[surface capabilities] videoSurface: videoonly double-buffered flipping
[dfb] (re)configured 0x08100609
[softdevice] Video Out seems to be OK
[softdevice] Initializing Audio Out
[softdevice] Audio out seems to be OK
[softdevice] A/V devices initialized, now initializing MPEG2 Decoder
mp3: filesource /opt/music includes (count=3): '*.mp3' '*.ogg' '*.wav'
mp3: filesource /media/cdrom has no includes set
mp3: filesource /mnt/cdfs includes (count=1): '*.wav'
mp3: using MPEG Audio Decoder 0.15.1 (beta)
mp3: compiled with 0.15.1 (beta)
mp3: filesource /opt/videos has no includes set
mp3: filesource /media/cdrom has no includes set
Read list from /etc/vdr/plugins/softplay/Liste 1
cSoftDevice::MakePrimaryDevice
CMD[0375]:SetAudioMode 0
status: volume=255 mute=0
CMD[0376]:SetPlayMode PmAudioVideo
CMD[0376]:Mpeg2Decoder Start IsSuspended 0  GetMutex 1
CMD[0376]:init put byte finished
CMD[0376]:mpeg2Decoder Start finishedCMD[0384]:Neuer Thread gestartet: Mpeg2Decoder pid 7206
(!) [ 7207:    0.000] --> Caught signal 11 (at 0xd9293ba9, invalid address) <--
Killed

-------------
Andre Neumann 

-----Urspr?ngliche Nachricht-----
Von: softdevice-devel-admin at berlios.de [mailto:softdevice-devel-admin at berlios.de] Im Auftrag von Martin Wache
Gesendet: Samstag, 7. Januar 2006 15:49
An: Softdevice Maillinglist
Betreff: [Softdevice-devel] new OSD support

Hi all,

I just committed the new OSD, which supports up- and down-scaleing, fixes some problems with software alpha blending mode and should also fix the shifted menu problem with the dvd-plugin. In most cases it is also much faster than the old OSD, and hopefully easier to maintain since it uses less global variables.

I had to modify all four video-out methods, I tested them but of course I could have missed some new bugs. So please check out the latest cvs-version and test the softdevice with your favourite video-out methods.

Have fun,

Martin
_______________________________________________
Softdevice-devel mailing list
Softdevice-devel at lists.berlios.de
http://lists.berlios.de/mailman/listinfo/softdevice-devel






From M.Wache at gmx.net  Sat Jan  7 22:49:41 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sat, 07 Jan 2006 22:49:41 +0100
Subject: AW: [Softdevice-devel] new OSD support
In-Reply-To: <FB3B5DB3197CEA429E5FB8E83D01D039D144@sbs2003.do-net.de>
References: <FB3B5DB3197CEA429E5FB8E83D01D039D144@sbs2003.do-net.de>
Message-ID: <43C03775.8060509@gmx.net>

Andre Neumann schrieb:
> Hi Martin,
> 
> Wow, this really sounds good. 2006 is starting great :)
> 
> I checked out cvs und compiled the new version, but on startup vdr crashes. Here is the output.
> Im using dfb output with a matrox g550.
> 
Thank you for your report :-)

Usually the easiest way to debug a crash is to use a core dump. Could
you please try to generate one?

If you don't know how, here is a short instruction:
Type "ulimit -c unlimited" your a shell (assuming you're useing bash),
then start vdr so that it crashes, you should get a message like "Core
dumped" when it crashes. The core dump is a file in the current working
directory which is usualy named core.XXXX, the XXXX is some number which
is not always there (depends on your system). Now open the core dump in
gdb (start gdb "gdb vdr", then type "core-file core.XXXX") and type "bt
full" which generates a human readable output of the core dump.

Without a core dump I'll have to try to guess the reason for the crash,
but right now nothing comes to my mind :-(

Bye,

Martin


From Neumann at do-net.de  Sun Jan  8 00:05:37 2006
From: Neumann at do-net.de (Andre Neumann)
Date: Sun, 8 Jan 2006 00:05:37 +0100
Subject: AW: AW: [Softdevice-devel] new OSD support
Message-ID: <FB3B5DB3197CEA429E5FB8E83D01D039D145@sbs2003.do-net.de>

I've tried your instructions, but i cannot get it to work. When i do a ulimit -c unlimited before i call vdr,
I do not get core.xx files, even if is try to run 

gdb ./vdr 

and then

run -c /etc/vdr -v /video0 -P'softdevice -vo dfb:'

Vdr do not crash when running with gdb. Really strange. When running vdr normal it always crashes.

What can i do more ?

-------------
Andre Neumann 

-----Urspr?ngliche Nachricht-----
Von: softdevice-devel-admin at berlios.de [mailto:softdevice-devel-admin at berlios.de] Im Auftrag von Martin Wache
Gesendet: Samstag, 7. Januar 2006 22:50
An: softdevice-devel at berlios.de
Betreff: Re: AW: [Softdevice-devel] new OSD support

Andre Neumann schrieb:
> Hi Martin,
> 
> Wow, this really sounds good. 2006 is starting great :)
> 
> I checked out cvs und compiled the new version, but on startup vdr crashes. Here is the output.
> Im using dfb output with a matrox g550.
> 
Thank you for your report :-)

Usually the easiest way to debug a crash is to use a core dump. Could you please try to generate one?

If you don't know how, here is a short instruction:
Type "ulimit -c unlimited" your a shell (assuming you're useing bash), then start vdr so that it crashes, you should get a message like "Core dumped" when it crashes. The core dump is a file in the current working directory which is usualy named core.XXXX, the XXXX is some number which is not always there (depends on your system). Now open the core dump in gdb (start gdb "gdb vdr", then type "core-file core.XXXX") and type "bt full" which generates a human readable output of the core dump.

Without a core dump I'll have to try to guess the reason for the crash, but right now nothing comes to my mind :-(

Bye,

Martin
_______________________________________________
Softdevice-devel mailing list
Softdevice-devel at lists.berlios.de
http://lists.berlios.de/mailman/listinfo/softdevice-devel






From M.Wache at gmx.net  Sun Jan  8 10:57:36 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 08 Jan 2006 10:57:36 +0100
Subject: AW: AW: [Softdevice-devel] new OSD support
In-Reply-To: <FB3B5DB3197CEA429E5FB8E83D01D039D145@sbs2003.do-net.de>
References: <FB3B5DB3197CEA429E5FB8E83D01D039D145@sbs2003.do-net.de>
Message-ID: <43C0E210.1010803@gmx.net>

Andre Neumann schrieb:
> I've tried your instructions, but i cannot get it to work. When i do a ulimit -c unlimited before i call vdr,
> I do not get core.xx files, even if is try to run 
> 
> gdb ./vdr 
> 
> and then
> 
> run -c /etc/vdr -v /video0 -P'softdevice -vo dfb:'
> 
> Vdr do not crash when running with gdb. Really strange. When running vdr normal it always crashes.
> 
> What can i do more ?
> 
Is Vdr running within gdb or does it stop at some point?

Strange that you don't get a core dump... Maybe someone else knows if
there is something more one has to do to get a core dump with DFB?

But if you want you can try again. Yesterday I committed a slightly
outdated version of the dfb-out part, I just committed a new version.
Maybe this fixes your problem, but I will also investigate it further.
Maybe I find something...

Oh, by the way what is your g++-Version? Maybe it is related to
different g++-Version...

Martin




From laz at club-burniston.co.uk  Sun Jan  8 11:27:21 2006
From: laz at club-burniston.co.uk (Laz)
Date: Sun, 8 Jan 2006 10:27:21 +0000
Subject: [Softdevice-devel] new OSD support
In-Reply-To: <43BFD4E5.8040804@gmx.net>
References: <43BFD4E5.8040804@gmx.net>
Message-ID: <200601081027.21604.laz@club-burniston.co.uk>

On Saturday 07 January 2006 14:49, Martin Wache wrote:
> Hi all,
>
> I just committed the new OSD, which supports up- and down-scaleing,
> fixes some problems with software alpha blending mode and should also
> fix the shifted menu problem with the dvd-plugin. In most cases it is
> also much faster than the old OSD, and hopefully easier to maintain
> since it uses less global variables.
>
> I had to modify all four video-out methods, I tested them but of course
> I could have missed some new bugs. So please check out the latest
> cvs-version and test the softdevice with your favourite video-out methods.

I've just checked out softdevice CVS and it seems to work fine for me with a 
dfb output and a Matrox G450. The OSD had always been relatively quick on 
that system but I think it does react quicker.

I'll try to test it later with dfb output on my epia system where the OSD is 
sluggish...

Cheers,

Laz


From laz at club-burniston.co.uk  Sun Jan  8 12:13:56 2006
From: laz at club-burniston.co.uk (Laz)
Date: Sun, 8 Jan 2006 11:13:56 +0000
Subject: [Softdevice-devel] new OSD support
In-Reply-To: <43BFD4E5.8040804@gmx.net>
References: <43BFD4E5.8040804@gmx.net>
Message-ID: <200601081113.58830.laz@club-burniston.co.uk>

On Saturday 07 January 2006 14:49, Martin Wache wrote:
> Hi all,
>
> I just committed the new OSD, which supports up- and down-scaleing,
> fixes some problems with software alpha blending mode and should also
> fix the shifted menu problem with the dvd-plugin. In most cases it is
> also much faster than the old OSD, and hopefully easier to maintain
> since it uses less global variables.
>
> I had to modify all four video-out methods, I tested them but of course
> I could have missed some new bugs. So please check out the latest
> cvs-version and test the softdevice with your favourite video-out methods.

It seems to work fine with my epia system using dfb tv-out. The OSD is still a 
bit sluggish but then I think it always will be on there until someone 
manages to incorporate hardware MPEG decoding into softdevice!

Cheers,

Laz


From Neumann at do-net.de  Sun Jan  8 12:10:02 2006
From: Neumann at do-net.de (Andre Neumann)
Date: Sun, 8 Jan 2006 12:10:02 +0100
Subject: AW: [Softdevice-devel] new OSD support
Message-ID: <FB3B5DB3197CEA429E5FB8E83D01D039D146@sbs2003.do-net.de>

I tried you new version, same problem. I also tried a different cvs version (i'm using cvs
from some days ago), no luck at all.

G++ is version 3.3.3.

Maybe gdb does not work because vdr do not crash really. I see no segfault or something like this.

cSoftDevice::MakePrimaryDevice
CMD[4892]:SetAudioMode 0
status: volume=255 mute=0
CMD[4910]:SetPlayMode PmAudioVideo
CMD[4910]:Mpeg2Decoder Start IsSuspended 0  GetMutex 1
CMD[4910]:init put byte finished
(!) [18263:    0.000] --> Caught signal 11 (at 0xbf931000, invalid address) <--
CMD[4910]:mpeg2Decoder Start finishedCMD[4933]:Neuer Thread gestartet: Mpeg2Decoder pid 18374
Sun Jan  8 12:11:35 CET 2006
restarting VDR

Is it maybe related to ffmpeg?

-------------
Andre Neumann

-----Urspr?ngliche Nachricht-----
Von: softdevice-devel-admin at berlios.de [mailto:softdevice-devel-admin at berlios.de] Im Auftrag von Martin Wache
Gesendet: Sonntag, 8. Januar 2006 10:58
An: softdevice-devel at berlios.de
Betreff: Re: AW: AW: [Softdevice-devel] new OSD support

Andre Neumann schrieb:
> I've tried your instructions, but i cannot get it to work. When i do a 
> ulimit -c unlimited before i call vdr, I do not get core.xx files, 
> even if is try to run
> 
> gdb ./vdr
> 
> and then
> 
> run -c /etc/vdr -v /video0 -P'softdevice -vo dfb:'
> 
> Vdr do not crash when running with gdb. Really strange. When running vdr normal it always crashes.
> 
> What can i do more ?
> 
Is Vdr running within gdb or does it stop at some point?

Strange that you don't get a core dump... Maybe someone else knows if there is something more one has to do to get a core dump with DFB?

But if you want you can try again. Yesterday I committed a slightly outdated version of the dfb-out part, I just committed a new version.
Maybe this fixes your problem, but I will also investigate it further.
Maybe I find something...

Oh, by the way what is your g++-Version? Maybe it is related to different g++-Version...

Martin


_______________________________________________
Softdevice-devel mailing list
Softdevice-devel at lists.berlios.de
http://lists.berlios.de/mailman/listinfo/softdevice-devel






From M.Wache at gmx.net  Sun Jan  8 12:39:02 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 08 Jan 2006 12:39:02 +0100
Subject: AW: [Softdevice-devel] new OSD support
In-Reply-To: <FB3B5DB3197CEA429E5FB8E83D01D039D146@sbs2003.do-net.de>
References: <FB3B5DB3197CEA429E5FB8E83D01D039D146@sbs2003.do-net.de>
Message-ID: <43C0F9D6.5070008@gmx.net>

Andre Neumann schrieb:
> I tried you new version, same problem. I also tried a different cvs version (i'm using cvs
> from some days ago), no luck at all.
> 
Did you do a "make clean" in the softdevice directory between the builds
of the different version?
Hmm, do I understand that correctly, before my update of the OSD the
softdevice worked for you, but now the current version and the version
from some days ago don't work anymore?

> G++ is version 3.3.3.
>
That's almost the same version I use, mine is 3.3.6, so that should not
make a big difference.

> Maybe gdb does not work because vdr do not crash really. I see no segfault or something like this.
> 
A signal 11 is a segmentation fault, DirectFB just seems to have an own
signal handler installed. I guess that is the reason why you don't get a
core dump. Could you please recompile DirectFB useing the configure
options "--enable-debug" ( and maybe "--enable-trace" )? This should
at least print out some more information.


> 
> Is it maybe related to ffmpeg?
>
Did you change something in ffmpeg?

Bye,
Martin



From M.Wache at gmx.net  Sun Jan  8 12:52:52 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 08 Jan 2006 12:52:52 +0100
Subject: [Softdevice-devel] new OSD support
In-Reply-To: <200601081113.58830.laz@club-burniston.co.uk>
References: <43BFD4E5.8040804@gmx.net> <200601081113.58830.laz@club-burniston.co.uk>
Message-ID: <43C0FD14.5020903@gmx.net>

Laz schrieb:
> On Saturday 07 January 2006 14:49, Martin Wache wrote:
> 
>>Hi all,
>>
>>I just committed the new OSD, which supports up- and down-scaleing,
>>fixes some problems with software alpha blending mode and should also
>>fix the shifted menu problem with the dvd-plugin. In most cases it is
>>also much faster than the old OSD, and hopefully easier to maintain
>>since it uses less global variables.
>>
>>I had to modify all four video-out methods, I tested them but of course
>>I could have missed some new bugs. So please check out the latest
>>cvs-version and test the softdevice with your favourite video-out methods.
> 
> 
> It seems to work fine with my epia system using dfb tv-out. The OSD is still a 
> bit sluggish but then I think it always will be on there until someone 
> manages to incorporate hardware MPEG decoding into softdevice!
> 
Thank you for your report, nice to hear that it works for you!
What processor do you use? Is it a Nehemiah or earlier? The new OSD is
useing MMX quite heavily so the gain is probably not that big on earlier
processors than Nehemiah because the MMX unit is quite slow on them.

Bye,
Martin


From Neumann at do-net.de  Sun Jan  8 12:56:15 2006
From: Neumann at do-net.de (Andre Neumann)
Date: Sun, 8 Jan 2006 12:56:15 +0100
Subject: AW: AW: [Softdevice-devel] new OSD support
Message-ID: <FB3B5DB3197CEA429E5FB8E83D01D039D147@sbs2003.do-net.de>

Hi,

Andre Neumann schrieb:
> I tried you new version, same problem. I also tried a different cvs 
> version (i'm using cvs from some days ago), no luck at all.
> 

Sorry, i wanted to say i tested your new cvs version also with different ffmpeg builds.

I now changed /etc/directfbrc mode=1280x720 to mode=720x576 and now it works. 

When using 1280x720 it did not work. Have you tested it with bigger resolutions than 576 ?

-------------
Andre Neumann
 

-----Urspr?ngliche Nachricht-----
Von: softdevice-devel-admin at berlios.de [mailto:softdevice-devel-admin at berlios.de] Im Auftrag von Martin Wache
Gesendet: Sonntag, 8. Januar 2006 12:39
An: softdevice-devel at berlios.de
Betreff: Re: AW: [Softdevice-devel] new OSD support

Andre Neumann schrieb:
> I tried you new version, same problem. I also tried a different cvs 
> version (i'm using cvs from some days ago), no luck at all.
> 
Did you do a "make clean" in the softdevice directory between the builds of the different version?
Hmm, do I understand that correctly, before my update of the OSD the softdevice worked for you, but now the current version and the version from some days ago don't work anymore?

> G++ is version 3.3.3.
>
That's almost the same version I use, mine is 3.3.6, so that should not make a big difference.

> Maybe gdb does not work because vdr do not crash really. I see no segfault or something like this.
> 
A signal 11 is a segmentation fault, DirectFB just seems to have an own signal handler installed. I guess that is the reason why you don't get a core dump. Could you please recompile DirectFB useing the configure options "--enable-debug" ( and maybe "--enable-trace" )? This should at least print out some more information.


> 
> Is it maybe related to ffmpeg?
>
Did you change something in ffmpeg?

Bye,
Martin

_______________________________________________
Softdevice-devel mailing list
Softdevice-devel at lists.berlios.de
http://lists.berlios.de/mailman/listinfo/softdevice-devel






From laz at club-burniston.co.uk  Sun Jan  8 13:35:11 2006
From: laz at club-burniston.co.uk (Laz)
Date: Sun, 8 Jan 2006 12:35:11 +0000
Subject: [Softdevice-devel] new OSD support
In-Reply-To: <43C0FD14.5020903@gmx.net>
References: <43BFD4E5.8040804@gmx.net> <200601081113.58830.laz@club-burniston.co.uk> <43C0FD14.5020903@gmx.net>
Message-ID: <200601081235.11749.laz@club-burniston.co.uk>

On Sunday 08 January 2006 11:52, Martin Wache wrote:
> Laz schrieb:
> > It seems to work fine with my epia system using dfb tv-out. The OSD is
> > still a bit sluggish but then I think it always will be on there until
> > someone manages to incorporate hardware MPEG decoding into softdevice!
>
> Thank you for your report, nice to hear that it works for you!
> What processor do you use? Is it a Nehemiah or earlier? The new OSD is
> useing MMX quite heavily so the gain is probably not that big on earlier
> processors than Nehemiah because the MMX unit is quite slow on them.

It's an Epia MII-12000 with a Nehemiah processor. I'll test that system more 
later on. The CPU usage sits between ca. 65% and 85%, depending on the 
bitrate of the channel, so it isn't totally ideal! With the xine plugin and 
hardware MPEG2 decoding, it is down at about 35% (from memory) but the OSD 
wasn't as good (software blended, and really sluggish unless it was opaque), 
and that also requires the extra overhead of X running!

Don't get me wrong here: the OSD is still really good just not as responsive 
as on my other Matrox system! E.g. on the Matrox system, if I hold down the 
'down' key on a menu, the selection tracks down smoothly. On the epia system, 
the selection skips lines as it moves down, looking as if the OSD isn't 
updated as quickly, or something.

I've just noticed that MMX2 is enabled by default in softdevice; this CPU 
doesn't have this: not sure whether disabling that would make any difference 
but I'll give it a go!

:)

Cheers,

Laz


From M.Wache at gmx.net  Sun Jan  8 13:47:40 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 08 Jan 2006 13:47:40 +0100
Subject: AW: AW: [Softdevice-devel] new OSD support
In-Reply-To: <FB3B5DB3197CEA429E5FB8E83D01D039D147@sbs2003.do-net.de>
References: <FB3B5DB3197CEA429E5FB8E83D01D039D147@sbs2003.do-net.de>
Message-ID: <43C109EC.7070601@gmx.net>

Andre Neumann schrieb:
> Hi,
> 
> Andre Neumann schrieb:
> 
>>I tried you new version, same problem. I also tried a different cvs 
>>version (i'm using cvs from some days ago), no luck at all.
>>
> 
> 
> Sorry, i wanted to say i tested your new cvs version also with different ffmpeg builds.
> 
> I now changed /etc/directfbrc mode=1280x720 to mode=720x576 and now it works. 
> 
That is a very good hint! Thank you!

> When using 1280x720 it did not work. Have you tested it with bigger resolutions than 576 ?
> 
Yes, I tested them, but only to resolutions with a x-resolution up to
1024 (my old monitor doesn't do much more :-(). I found a small bug in
the code which causes a crash one higher resolutions, so I guess that's
your problem :-)

Please try the attatched patch.
Martin
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: OSD_crash.patch
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060108/cce83eca/attachment.ksh>

From M.Wache at gmx.net  Sun Jan  8 14:03:35 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 08 Jan 2006 14:03:35 +0100
Subject: [Softdevice-devel] new OSD support
In-Reply-To: <200601081235.11749.laz@club-burniston.co.uk>
References: <43BFD4E5.8040804@gmx.net> <200601081113.58830.laz@club-burniston.co.uk> <43C0FD14.5020903@gmx.net> <200601081235.11749.laz@club-burniston.co.uk>
Message-ID: <43C10DA7.8090706@gmx.net>

Laz schrieb:

> 
> It's an Epia MII-12000 with a Nehemiah processor. I'll test that system more 
> later on. The CPU usage sits between ca. 65% and 85%, depending on the 
> bitrate of the channel, so it isn't totally ideal! With the xine plugin and 
> hardware MPEG2 decoding, it is down at about 35% (from memory) but the OSD 
> wasn't as good (software blended, and really sluggish unless it was opaque), 
> and that also requires the extra overhead of X running!
>
Since you mention it, is hardware MPEG2 decoding for the epias now in
DirectFB? I think I read somewhere that this feature is planned...

> Don't get me wrong here: the OSD is still really good just not as responsive 
> as on my other Matrox system! E.g. on the Matrox system, if I hold down the 
> 'down' key on a menu, the selection tracks down smoothly. On the epia system, 
> the selection skips lines as it moves down, looking as if the OSD isn't 
> updated as quickly, or something.
> 
> I've just noticed that MMX2 is enabled by default in softdevice; this CPU 
> doesn't have this: not sure whether disabling that would make any difference 
> but I'll give it a go!

Don't worry, if you processor would not support MMX2 the softdevice
would crash ;-). What the softdevice calls MMX2 is actually a small set
of instructions which is also part of 3Dnow! and is also sometimes
called mmxext. In fact it is only is only PREFETCH and MOVQNT. As far as
I know all Via processors from Erza onwards support these instructions.

Bye,
Martin


From laz at club-burniston.co.uk  Sun Jan  8 14:20:29 2006
From: laz at club-burniston.co.uk (Laz)
Date: Sun, 8 Jan 2006 13:20:29 +0000
Subject: [Softdevice-devel] new OSD support
In-Reply-To: <43C10DA7.8090706@gmx.net>
References: <43BFD4E5.8040804@gmx.net> <200601081235.11749.laz@club-burniston.co.uk> <43C10DA7.8090706@gmx.net>
Message-ID: <200601081320.30107.laz@club-burniston.co.uk>

On Sunday 08 January 2006 13:03, Martin Wache wrote:
> Laz schrieb:
> > It's an Epia MII-12000 with a Nehemiah processor. I'll test that system
> > more later on. The CPU usage sits between ca. 65% and 85%, depending on
> > the bitrate of the channel, so it isn't totally ideal! With the xine
> > plugin and hardware MPEG2 decoding, it is down at about 35% (from memory)
> > but the OSD wasn't as good (software blended, and really sluggish unless
> > it was opaque), and that also requires the extra overhead of X running!
>
> Since you mention it, is hardware MPEG2 decoding for the epias now in
> DirectFB? I think I read somewhere that this feature is planned...

As far as I know, a couple of people have mentioned the idea but so far no one 
has managed it (unless it has sneaked into DirectFB when I wasn't looking!). 
The main problem is that the xvmc implementation in Xorg is very tied in to X 
and looks like it would be a nightmare to extract the relevant bits. I might 
have another look, though...

> > I've just noticed that MMX2 is enabled by default in softdevice; this CPU
> > doesn't have this: not sure whether disabling that would make any
> > difference but I'll give it a go!
>
> Don't worry, if you processor would not support MMX2 the softdevice
> would crash ;-). What the softdevice calls MMX2 is actually a small set
> of instructions which is also part of 3Dnow! and is also sometimes
> called mmxext. In fact it is only is only PREFETCH and MOVQNT. As far as
> I know all Via processors from Erza onwards support these instructions.

Ahhhh...I was wondering why it wasn't crashing with some random error message 
about unsupported processor features! I might as well rebuild it: I've just 
applied your resolution patch (not that I use anything above 720x576!).

Cheers,

Laz


From Neumann at do-net.de  Sun Jan  8 14:46:42 2006
From: Neumann at do-net.de (Andre Neumann)
Date: Sun, 8 Jan 2006 14:46:42 +0100
Subject: AW: [Softdevice-devel] new OSD support
Message-ID: <FB3B5DB3197CEA429E5FB8E83D01D039D148@sbs2003.do-net.de>

Works great here now :)

Thank you.

A big thanks to you and all the other programmers of this project. Without you, my homecinema would not
exist :)

The only thing now we all waiting for is a good deinterlacer :)

-------------
Andre Neumann 

-----Urspr?ngliche Nachricht-----
Von: softdevice-devel-admin at berlios.de [mailto:softdevice-devel-admin at berlios.de] Im Auftrag von Martin Wache
Gesendet: Sonntag, 8. Januar 2006 13:48
An: softdevice-devel at berlios.de
Betreff: Re: AW: AW: [Softdevice-devel] new OSD support

Andre Neumann schrieb:
> Hi,
> 
> Andre Neumann schrieb:
> 
>>I tried you new version, same problem. I also tried a different cvs 
>>version (i'm using cvs from some days ago), no luck at all.
>>
> 
> 
> Sorry, i wanted to say i tested your new cvs version also with different ffmpeg builds.
> 
> I now changed /etc/directfbrc mode=1280x720 to mode=720x576 and now it works. 
> 
That is a very good hint! Thank you!

> When using 1280x720 it did not work. Have you tested it with bigger resolutions than 576 ?
> 
Yes, I tested them, but only to resolutions with a x-resolution up to
1024 (my old monitor doesn't do much more :-(). I found a small bug in the code which causes a crash one higher resolutions, so I guess that's your problem :-)

Please try the attatched patch.
Martin





From stefan at lucke.in-berlin.de  Sun Jan  8 15:12:14 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 8 Jan 2006 15:12:14 +0100
Subject: [Softdevice-devel] new OSD support
In-Reply-To: <43BFD4E5.8040804@gmx.net>
References: <43BFD4E5.8040804@gmx.net>
Message-ID: <200601081512.14273.stefan@lucke.in-berlin.de>

On Samstag, 7. Januar 2006 15:49, Martin Wache wrote:
> Hi all,
> 
> I just committed the new OSD, which supports up- and down-scaleing,
> fixes some problems with software alpha blending mode and should also
> fix the shifted menu problem with the dvd-plugin. In most cases it is
> also much faster than the old OSD, and hopefully easier to maintain
> since it uses less global variables.
> 
> I had to modify all four video-out methods, I tested them but of course
> I could have missed some new bugs. So please check out the latest
> cvs-version and test the softdevice with your favourite video-out methods.

Just checked the new OSD with X11 and pseudo mode. The pseudo background
seems to use vertical stripes as pseudo instead of altering mask before.

old pattern:
	x 0 x 0
	0 x 0 x
	x 0 x 0

new pattern:
	x 0 x 0
	x 0 x 0
	x 0 x 0

-- 
Stefan Lucke



From M.Wache at gmx.net  Sun Jan  8 15:27:47 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 08 Jan 2006 15:27:47 +0100
Subject: [Softdevice-devel] new OSD support
In-Reply-To: <200601081512.14273.stefan@lucke.in-berlin.de>
References: <43BFD4E5.8040804@gmx.net> <200601081512.14273.stefan@lucke.in-berlin.de>
Message-ID: <43C12163.6000007@gmx.net>

Stefan Lucke schrieb:
> On Samstag, 7. Januar 2006 15:49, Martin Wache wrote:
> 
>>Hi all,
>>
>>I just committed the new OSD, which supports up- and down-scaleing,
>>fixes some problems with software alpha blending mode and should also
>>fix the shifted menu problem with the dvd-plugin. In most cases it is
>>also much faster than the old OSD, and hopefully easier to maintain
>>since it uses less global variables.
>>
>>I had to modify all four video-out methods, I tested them but of course
>>I could have missed some new bugs. So please check out the latest
>>cvs-version and test the softdevice with your favourite video-out methods.
> 
> 
> Just checked the new OSD with X11 and pseudo mode. The pseudo background
> seems to use vertical stripes as pseudo instead of altering mask before.
> 
> old pattern:
> 	x 0 x 0
> 	0 x 0 x
> 	x 0 x 0
> 
> new pattern:
> 	x 0 x 0
> 	x 0 x 0
> 	x 0 x 0
> 
Yes, that's true. The reason is that stripes are a lot simpler to do in
MMX (and it's faster too ;-). I think the difference in the look is not
that big, so I implemented the lines.

Bye,
Martin


From M.Wache at gmx.net  Sun Jan  8 15:31:32 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 08 Jan 2006 15:31:32 +0100
Subject: AW: [Softdevice-devel] new OSD support
In-Reply-To: <FB3B5DB3197CEA429E5FB8E83D01D039D148@sbs2003.do-net.de>
References: <FB3B5DB3197CEA429E5FB8E83D01D039D148@sbs2003.do-net.de>
Message-ID: <43C12244.2090706@gmx.net>

Andre Neumann schrieb:
> Works great here now :)
> 
The fix is in the CVS now

Thank you for testing :-)

Bye,

Martin


From malcolm.caldwell at cdu.edu.au  Sun Jan  8 16:17:06 2006
From: malcolm.caldwell at cdu.edu.au (Malcolm Caldwell)
Date: Mon, 09 Jan 2006 00:47:06 +0930
Subject: AW: [Softdevice-devel] new OSD support
In-Reply-To: <FB3B5DB3197CEA429E5FB8E83D01D039D148@sbs2003.do-net.de>
References: <FB3B5DB3197CEA429E5FB8E83D01D039D148@sbs2003.do-net.de>
Message-ID: <1136733427.4459.12.camel@localhost.localdomain>

On Sun, 2006-01-08 at 14:46 +0100, Andre Neumann wrote:
> Works great here now :)
> 
> Thank you.
> 
> A big thanks to you and all the other programmers of this project. Without you, my homecinema would not
> exist :)
> 
> The only thing now we all waiting for is a good deinterlacer :)

Since you said the ONLY thing we are ALL waiting for I had to join in:

I am also waiting for stretchblits that honor field parity in dfb so I
can view letterboxed 16:9 content on my 4:3 TV (using dfb and g450 tv
out).  It would also allow ntsc material to look correct.  And softplay
material.  And...

Not that I am complaining at all.  I have been meaning to chip in and
work on the code myself but have not got the time to do it.  (Plus my
vdr is in production here at home) ;)


> -------------
> Andre Neumann 
> 
> -----Urspr?ngliche Nachricht-----
> Von: softdevice-devel-admin at berlios.de [mailto:softdevice-devel-admin at berlios.de] Im Auftrag von Martin Wache
> Gesendet: Sonntag, 8. Januar 2006 13:48
> An: softdevice-devel at berlios.de
> Betreff: Re: AW: AW: [Softdevice-devel] new OSD support
> 
> Andre Neumann schrieb:
> > Hi,
> > 
> > Andre Neumann schrieb:
> > 
> >>I tried you new version, same problem. I also tried a different cvs 
> >>version (i'm using cvs from some days ago), no luck at all.
> >>
> > 
> > 
> > Sorry, i wanted to say i tested your new cvs version also with different ffmpeg builds.
> > 
> > I now changed /etc/directfbrc mode=1280x720 to mode=720x576 and now it works. 
> > 
> That is a very good hint! Thank you!
> 
> > When using 1280x720 it did not work. Have you tested it with bigger resolutions than 576 ?
> > 
> Yes, I tested them, but only to resolutions with a x-resolution up to
> 1024 (my old monitor doesn't do much more :-(). I found a small bug in the code which causes a crash one higher resolutions, so I guess that's your problem :-)
> 
> Please try the attatched patch.
> Martin
> 
> 
> 
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/softdevice-devel



From marko.makela at hut.fi  Sun Jan  8 18:03:36 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sun, 8 Jan 2006 19:03:36 +0200
Subject: [Softdevice-devel] new OSD support
In-Reply-To: <43BFD4E5.8040804@gmx.net>
References: <43BFD4E5.8040804@gmx.net>
Message-ID: <20060108170336.GA3602@localhost.localdomain>

On Sat, Jan 07, 2006 at 03:49:09PM +0100, Martin Wache wrote:
> I just committed the new OSD, which supports up- and down-scaleing,
> fixes some problems with software alpha blending mode and should also
> fix the shifted menu problem with the dvd-plugin. In most cases it is
> also much faster than the old OSD, and hopefully easier to maintain
> since it uses less global variables.

Thanks, I just tried it out, and it works great on the G450 DFB output.

Unfortunately, I couldn't test the dvd-plugin, because my snapshot of
it did not compile with vdr-1.3.38.

	Marko


From Neumann at do-net.de  Mon Jan  9 18:00:08 2006
From: Neumann at do-net.de (Andre Neumann)
Date: Mon, 9 Jan 2006 18:00:08 +0100
Subject: [Softdevice-devel] new OSD support
Message-ID: <FB3B5DB3197CEA429E5FB8E83D01D039D149@sbs2003.do-net.de>

I noticed that if i use a OSDHeight of about 500, softdevice crashes again.

Is there some memory restriction ? Again, im using 1280x720.

OSDHeight of 350 works.

-------------
Andre Neumann

-----Original Message-----
From: softdevice-devel-admin at berlios.de [mailto:softdevice-devel-admin at berlios.de] On Behalf Of Martin Wache
Sent: Sunday, January 08, 2006 3:32 PM
To: softdevice-devel at berlios.de
Subject: Re: AW: [Softdevice-devel] new OSD support

Andre Neumann schrieb:
> Works great here now :)
> 
The fix is in the CVS now

Thank you for testing :-)

Bye,

Martin
_______________________________________________
Softdevice-devel mailing list
Softdevice-devel at lists.berlios.de
http://lists.berlios.de/mailman/listinfo/softdevice-devel






From M.Wache at gmx.net  Mon Jan  9 21:29:35 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 9 Jan 2006 21:29:35 +0100 (MET)
Subject: [Softdevice-devel] new OSD support
References: <FB3B5DB3197CEA429E5FB8E83D01D039D149@sbs2003.do-net.de>
Message-ID: <9672.1136838575@www66.gmx.net>

> --- Urspr?ngliche Nachricht ---
> Von: "Andre Neumann" <Neumann at do-net.de>
> An: <softdevice-devel at berlios.de>
> Betreff: RE: [Softdevice-devel] new OSD support
> Datum: Mon, 9 Jan 2006 18:00:08 +0100
> 
> I noticed that if i use a OSDHeight of about 500, softdevice crashes
> again.
> 
> Is there some memory restriction ? Again, im using 1280x720.
> 
> OSDHeight of 350 works.
> 
It took me some time to figure out which OSDHeight you are talking about...
But you are right. I missed some sanity checks. You are really a thorough
tester ;-)

A fix is in the CVS, please try it out.

Thanks again,
Martin

-- 
Lust, ein paar Euro nebenbei zu verdienen? Ohne Kosten, ohne Risiko!
Satte Provisionen f?r GMX Partner: http://www.gmx.net/de/go/partner


From marko.makela at hut.fi  Mon Jan  9 21:40:34 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 9 Jan 2006 22:40:34 +0200
Subject: [Softdevice-devel] new OSD support
In-Reply-To: <43BFD4E5.8040804@gmx.net>
References: <43BFD4E5.8040804@gmx.net>
Message-ID: <20060109204034.GA3565@localhost.localdomain>

On Sat, Jan 07, 2006 at 03:49:09PM +0100, Martin Wache wrote:
> I had to modify all four video-out methods, I tested them but of course
> I could have missed some new bugs. So please check out the latest
> cvs-version and test the softdevice with your favourite video-out methods.

With DFB output, I have three minor issues:

(1) the vertical stripes make white OSD text slightly harder to read than the
checkerboard pattern when the video in the background is bright

(2) on the very right of the OSD, there is a 1-pixel wide white stripe
visible when the background is black

(3) in the log, there are loads of DFB warning messages about wrong blitting
rectangle or some such.  I'll look up the exact messages if needed.

	Marko


From M.Wache at gmx.net  Mon Jan  9 22:03:26 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 9 Jan 2006 22:03:26 +0100 (MET)
Subject: [Softdevice-devel] new OSD support
References: <20060109204034.GA3565@localhost.localdomain>
Message-ID: <18732.1136840606@www66.gmx.net>

> --- Urspr?ngliche Nachricht ---
> Von: Marko M?kel? <marko.makela at hut.fi>
> An: softdevice-devel at berlios.de
> Betreff: Re: [Softdevice-devel] new OSD support
> Datum: Mon, 9 Jan 2006 22:40:34 +0200
> 
> On Sat, Jan 07, 2006 at 03:49:09PM +0100, Martin Wache wrote:
> > I had to modify all four video-out methods, I tested them but of course
> > I could have missed some new bugs. So please check out the latest
> > cvs-version and test the softdevice with your favourite video-out
> methods.
> 
> With DFB output, I have three minor issues:
> 
> (1) the vertical stripes make white OSD text slightly harder to read than
> the
> checkerboard pattern when the video in the background is bright
> 
Hmm, I thought with DirectFB one could do real alpha blending in hardware
and doesn't need the pseudo alpha blending ;-) Can't your graphics 
hardware do alpha blending? If you are interested, there is also a 
software alpha blending mode in Xv-out, which could easily ported to 
DirectFB-out.
But maybe you are right. I'll think about how we can have the old pattern.

> (2) on the very right of the OSD, there is a 1-pixel wide white stripe
> visible when the background is black
> 
Yes, I noticed that too. In Xv-out I'm just cutting it away, so I forgot
about it. Of course one could do the same in DFB, but I think the better
way is to find the origin for the strip.

> (3) in the log, there are loads of DFB warning messages about wrong
> blitting
> rectangle or some such.  I'll look up the exact messages if needed.
> 
Yes, please post that message. I'm not very experienced with directFB, so
I guess I did something stupid there ;-)

Thank you for the feedback!
Martin

-- 
10 GB Mailbox, 100 FreeSMS/Monat http://www.gmx.net/de/go/topmail
+++ GMX - die erste Adresse f?r Mail, Message, More +++


From marko.makela at hut.fi  Tue Jan 10 16:24:30 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 10 Jan 2006 17:24:30 +0200
Subject: [Softdevice-devel] new OSD support; DirectFB issues
In-Reply-To: <18732.1136840606@www66.gmx.net>
References: <20060109204034.GA3565@localhost.localdomain> <18732.1136840606@www66.gmx.net>
Message-ID: <20060110152430.GA20219@vipunen.hut.fi>

On Mon, Jan 09, 2006 at 10:03:26PM +0100, Martin Wache wrote:
> Hmm, I thought with DirectFB one could do real alpha blending in hardware
> and doesn't need the pseudo alpha blending ;-) Can't your graphics 
> hardware do alpha blending?

dfbinfo reports the following:


Screen (00) FBDev Primary Screen            (primary screen)
   Caps: VSYNC POWER_MANAGEMENT 

     Layer (00) FBDev Primary Layer             (primary layer)
        Type:    GRAPHICS 
        Caps:    SURFACE BRIGHTNESS CONTRAST SATURATION 

     Layer (01) Matrox Backend Scaler         
        Type:    GRAPHICS VIDEO STILL_PICTURE 
        Caps:    SURFACE SCREEN_LOCATION DEINTERLACING DST_COLORKEY BRIGHTNESS CONTRAST SCREEN_POSITION SCREEN_SIZE 


I'm using the primary head of a Matrox G450 card.

> > (3) in the log, there are loads of DFB warning messages about wrong
> > blitting
> > rectangle or some such.  I'll look up the exact messages if needed.
> > 
> Yes, please post that message. I'm not very experienced with directFB, so
> I guess I did something stupid there ;-)


[softdevice] Audio out seems to be OK
[softdevice] A/V devices initialized, now initializing MPEG2 Decoder
cSoftDevice::MakePrimaryDevice
[dfb] Refresh: action=IDirectFBSurface::Blit(IDirectFBSurface*, DFBRectangle*, int, int), result=Invalid area present!
[dfb] (re)configuring Videolayer to 704 x 576 (704x576)
[surface capabilities] videoSurface: videoonly double-buffered flipping 
[dfb] (re)configured 0x08100609
[dfb] Refresh: action=IDirectFBSurface::Blit(IDirectFBSurface*, DFBRectangle*, int, int), result=Invalid area present!
[dfb] Refresh: action=IDirectFBSurface::Blit(IDirectFBSurface*, DFBRectangle*, int, int), result=Invalid area present!
[dfb] Refresh: action=IDirectFBSurface::Blit(IDirectFBSurface*, DFBRectangle*, int, int), result=Invalid area present!

These are the 10 last lines from the log after starting vdr.  I may have
displayed and hidden the OSD menu three times before sampling the log.

	Marko


From inssomniak at mountaincable.net  Tue Jan 10 19:20:04 2006
From: inssomniak at mountaincable.net (Dave)
Date: Tue, 10 Jan 2006 13:20:04 -0500
Subject: [Softdevice-devel] new OSD support; DirectFB issues
In-Reply-To: <20060110152430.GA20219@vipunen.hut.fi>
References: <20060109204034.GA3565@localhost.localdomain> <18732.1136840606@www66.gmx.net> <20060110152430.GA20219@vipunen.hut.fi>
Message-ID: <43C3FAD4.4010301@mountaincable.net>


Marko M?kel? wrote:

>On Mon, Jan 09, 2006 at 10:03:26PM +0100, Martin Wache wrote:
>  
>
>>Hmm, I thought with DirectFB one could do real alpha blending in hardware
>>and doesn't need the pseudo alpha blending ;-) Can't your graphics 
>>hardware do alpha blending?
>>    
>>
>
>dfbinfo reports the following:
>
>
>Screen (00) FBDev Primary Screen            (primary screen)
>   Caps: VSYNC POWER_MANAGEMENT 
>
>     Layer (00) FBDev Primary Layer             (primary layer)
>        Type:    GRAPHICS 
>        Caps:    SURFACE BRIGHTNESS CONTRAST SATURATION 
>
>     Layer (01) Matrox Backend Scaler         
>        Type:    GRAPHICS VIDEO STILL_PICTURE 
>        Caps:    SURFACE SCREEN_LOCATION DEINTERLACING DST_COLORKEY BRIGHTNESS CONTRAST SCREEN_POSITION SCREEN_SIZE 
>
>
>I'm using the primary head of a Matrox G450 card.
>
>  
>
>>>(3) in the log, there are loads of DFB warning messages about wrong
>>>blitting
>>>rectangle or some such.  I'll look up the exact messages if needed.
>>>
>>>      
>>>
>>Yes, please post that message. I'm not very experienced with directFB, so
>>I guess I did something stupid there ;-)
>>    
>>
>
>
>[softdevice] Audio out seems to be OK
>[softdevice] A/V devices initialized, now initializing MPEG2 Decoder
>cSoftDevice::MakePrimaryDevice
>[dfb] Refresh: action=IDirectFBSurface::Blit(IDirectFBSurface*, DFBRectangle*, int, int), result=Invalid area present!
>[dfb] (re)configuring Videolayer to 704 x 576 (704x576)
>[surface capabilities] videoSurface: videoonly double-buffered flipping 
>[dfb] (re)configured 0x08100609
>[dfb] Refresh: action=IDirectFBSurface::Blit(IDirectFBSurface*, DFBRectangle*, int, int), result=Invalid area present!
>[dfb] Refresh: action=IDirectFBSurface::Blit(IDirectFBSurface*, DFBRectangle*, int, int), result=Invalid area present!
>[dfb] Refresh: action=IDirectFBSurface::Blit(IDirectFBSurface*, DFBRectangle*, int, int), result=Invalid area present!
>
>These are the 10 last lines from the log after starting vdr.  I may have
>displayed and hidden the OSD menu three times before sampling the log.
>
>	Marko
>_______________________________________________
>Softdevice-devel mailing list
>Softdevice-devel at lists.berlios.de
>http://lists.berlios.de/mailman/listinfo/softdevice-devel
>
>  
>

I can confirm this problem too.  Although does not seem to affect 
operation. Only appears during OSD display.


From M.Wache at gmx.net  Tue Jan 10 20:46:05 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 10 Jan 2006 20:46:05 +0100
Subject: [Softdevice-devel] new OSD support; DirectFB issues
In-Reply-To: <43C3FAD4.4010301@mountaincable.net>
References: <20060109204034.GA3565@localhost.localdomain> <18732.1136840606@www66.gmx.net> <20060110152430.GA20219@vipunen.hut.fi> <43C3FAD4.4010301@mountaincable.net>
Message-ID: <43C40EFD.4050205@gmx.net>

Dave schrieb:
> 
> 
> Marko M?kel? wrote:
> 
>> On Mon, Jan 09, 2006 at 10:03:26PM +0100, Martin Wache wrote:
>>  
>>
>>> Hmm, I thought with DirectFB one could do real alpha blending in
>>> hardware
>>> and doesn't need the pseudo alpha blending ;-) Can't your graphics
>>> hardware do alpha blending?
>>>   
>>
>>
>> dfbinfo reports the following:
>>
>>
>> Screen (00) FBDev Primary Screen            (primary screen)
>>   Caps: VSYNC POWER_MANAGEMENT
>>     Layer (00) FBDev Primary Layer             (primary layer)
>>        Type:    GRAPHICS        Caps:    SURFACE BRIGHTNESS CONTRAST
>> SATURATION
>>     Layer (01) Matrox Backend Scaler                Type:    GRAPHICS
>> VIDEO STILL_PICTURE        Caps:    SURFACE SCREEN_LOCATION
>> DEINTERLACING DST_COLORKEY BRIGHTNESS CONTRAST SCREEN_POSITION
>> SCREEN_SIZE
>>
>> I'm using the primary head of a Matrox G450 card.
>>
I really thought that the Matrox could do hardware alpha blending. Do
you use a 32-bit colour depth?

>>  
>>
>>>> (3) in the log, there are loads of DFB warning messages about wrong
>>>> blitting
>>>> rectangle or some such.  I'll look up the exact messages if needed.
>>>>
>>>>     
>>>
>>> Yes, please post that message. I'm not very experienced with
>>> directFB, so
>>> I guess I did something stupid there ;-)
>>>   
>>
>>
>>
>> [softdevice] Audio out seems to be OK
>> [softdevice] A/V devices initialized, now initializing MPEG2 Decoder
>> cSoftDevice::MakePrimaryDevice
>> [dfb] Refresh: action=IDirectFBSurface::Blit(IDirectFBSurface*,
>> DFBRectangle*, int, int), result=Invalid area present!
>> [dfb] (re)configuring Videolayer to 704 x 576 (704x576)
>> [surface capabilities] videoSurface: videoonly double-buffered
>> flipping [dfb] (re)configured 0x08100609
>> [dfb] Refresh: action=IDirectFBSurface::Blit(IDirectFBSurface*,
>> DFBRectangle*, int, int), result=Invalid area present!
>> [dfb] Refresh: action=IDirectFBSurface::Blit(IDirectFBSurface*,
>> DFBRectangle*, int, int), result=Invalid area present!
>> [dfb] Refresh: action=IDirectFBSurface::Blit(IDirectFBSurface*,
>> DFBRectangle*, int, int), result=Invalid area present!
>>
>> These are the 10 last lines from the log after starting vdr.  I may have
>> displayed and hidden the OSD menu three times before sampling the log.
>>
>>     Marko
>> _______________________________________________
>> Softdevice-devel mailing list
>> Softdevice-devel at lists.berlios.de
>> http://lists.berlios.de/mailman/listinfo/softdevice-devel
>>
>>  
>>
> 
> I can confirm this problem too.  Although does not seem to affect
> operation. Only appears during OSD display.

Thank you for the report!
It should be fixed in the CVS now.

Bye,
Martin


From stefan at lucke.in-berlin.de  Wed Jan 11 10:19:56 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 11 Jan 2006 10:19:56 +0100
Subject: [Softdevice-devel] new OSD support; DirectFB issues
In-Reply-To: <43C40EFD.4050205@gmx.net>
References: <20060109204034.GA3565@localhost.localdomain> <18732.1136840606@www66.gmx.net> <20060110152430.GA20219@vipunen.hut.fi> <43C3FAD4.4010301@mountaincable.net> <43C40EFD.4050205@gmx.net>
Message-ID: <1136971196.43c4cdbc56fb8@webmail.in-berlin.de>

Quoting Martin Wache <M.Wache at gmx.net>:

> Dave schrieb:
> >
> >
> > Marko M?kel? wrote:
> >
> >> On Mon, Jan 09, 2006 at 10:03:26PM +0100, Martin Wache wrote:
> >>
> >>
> >>> Hmm, I thought with DirectFB one could do real alpha blending in
> >>> hardware
> >>> and doesn't need the pseudo alpha blending ;-) Can't your graphics
> >>> hardware do alpha blending?
> >>>
> >>
> >>
> >> dfbinfo reports the following:
> >>
> >>
> >> Screen (00) FBDev Primary Screen            (primary screen)
> >>   Caps: VSYNC POWER_MANAGEMENT
> >>     Layer (00) FBDev Primary Layer             (primary layer)
> >>        Type:    GRAPHICS        Caps:    SURFACE BRIGHTNESS CONTRAST
> >> SATURATION
> >>     Layer (01) Matrox Backend Scaler                Type:    GRAPHICS
> >> VIDEO STILL_PICTURE        Caps:    SURFACE SCREEN_LOCATION
> >> DEINTERLACING DST_COLORKEY BRIGHTNESS CONTRAST SCREEN_POSITION
> >> SCREEN_SIZE
> >>
> >> I'm using the primary head of a Matrox G450 card.
> >>
> I really thought that the Matrox could do hardware alpha blending. Do
> you use a 32-bit colour depth?
>


They can do hw alpha blend, when YUY2 format and stretchblit is used.
They canNOT do this when backend scaler is used.

Stefan Lucke


From marko.makela at hut.fi  Wed Jan 11 20:57:47 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 11 Jan 2006 21:57:47 +0200
Subject: [Softdevice-devel] new OSD support; DirectFB issues
In-Reply-To: <43C40EFD.4050205@gmx.net>
References: <20060109204034.GA3565@localhost.localdomain> <18732.1136840606@www66.gmx.net> <20060110152430.GA20219@vipunen.hut.fi> <43C3FAD4.4010301@mountaincable.net> <43C40EFD.4050205@gmx.net>
Message-ID: <20060111195739.GA3523@localhost.localdomain>

On Tue, Jan 10, 2006 at 08:46:05PM +0100, Martin Wache wrote:
> >> [dfb] Refresh: action=IDirectFBSurface::Blit(IDirectFBSurface*,
> >> DFBRectangle*, int, int), result=Invalid area present!
> >> [dfb] Refresh: action=IDirectFBSurface::Blit(IDirectFBSurface*,
> >> DFBRectangle*, int, int), result=Invalid area present!
> >> [dfb] Refresh: action=IDirectFBSurface::Blit(IDirectFBSurface*,
> >> DFBRectangle*, int, int), result=Invalid area present!

> Thank you for the report!
> It should be fixed in the CVS now.

Indeed, the error messages were gone.  I even shifted the OSD so that it
would be clipped at the right border, and the messages were gone.

I reverted to vdr 1.3.37 because of problems with subtitles.  I tried
the dvd plugin, but the DVD menu navigation acted up on me again.
(Apparently it doesn't like fast-forwarding before the menu appears.)
So, I still can't say if the menu cursor is drawn at the correct position
now.

	Marko


From marko.makela at hut.fi  Wed Jan 11 21:10:18 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 11 Jan 2006 22:10:18 +0200
Subject: [Softdevice-devel] new OSD support; DirectFB issues
In-Reply-To: <1136971196.43c4cdbc56fb8@webmail.in-berlin.de>
References: <20060109204034.GA3565@localhost.localdomain> <18732.1136840606@www66.gmx.net> <20060110152430.GA20219@vipunen.hut.fi> <43C3FAD4.4010301@mountaincable.net> <43C40EFD.4050205@gmx.net> <1136971196.43c4cdbc56fb8@webmail.in-berlin.de>
Message-ID: <20060111201018.GB3523@localhost.localdomain>

On Wed, Jan 11, 2006 at 10:19:56AM +0100, Stefan Lucke wrote:
> Quoting Martin Wache <M.Wache at gmx.net>:
> > >> I'm using the primary head of a Matrox G450 card.
> > >>
> > I really thought that the Matrox could do hardware alpha blending. Do
> > you use a 32-bit colour depth?
> 
> They can do hw alpha blend, when YUY2 format and stretchblit is used.
> They canNOT do this when backend scaler is used.

Does this mean that alpha blending is available on TV out?  Should I
perhaps give the TV out another try?  When I tried it last spring, it
was unuseable slow (slower than VGA output), presumably due to color
space conversion done in software.

Is StretchBlit a software or a hardware operation?  In the past, when
I have tried to enable it in the OSD menu, it has reverted to disabled.

	Marko


From inssomniak at mountaincable.net  Thu Jan 12 06:15:57 2006
From: inssomniak at mountaincable.net (Dave)
Date: Thu, 12 Jan 2006 00:15:57 -0500
Subject: [Softdevice-devel] Getting rid of vertical tearing?
In-Reply-To: <20060111201018.GB3523@localhost.localdomain>
References: <20060109204034.GA3565@localhost.localdomain> <18732.1136840606@www66.gmx.net> <20060110152430.GA20219@vipunen.hut.fi> <43C3FAD4.4010301@mountaincable.net> <43C40EFD.4050205@gmx.net> <1136971196.43c4cdbc56fb8@webmail.in-berlin.de> <20060111201018.GB3523@localhost.localdomain>
Message-ID: <43C5E60D.2090004@mountaincable.net>

I use softdevice with directfb, with a matrox g450 with VGA out, (non-tv 
out), at 800x600 res to match my projector, but there is noticeable 
vertical tearing in the picture, and I was wondering if there was a way 
to get either directfb or softdevice to sync to vertical refresh to rid 
of these effects?  My guess is that the image is being displayed during 
vertical refresh, therefore it tears in fast motion scenes.  My screen 
is large therefore its quite noticeable for me.






From stefan at lucke.in-berlin.de  Thu Jan 12 07:35:23 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 12 Jan 2006 07:35:23 +0100
Subject: [Softdevice-devel] new OSD support; DirectFB issues
In-Reply-To: <20060111201018.GB3523@localhost.localdomain>
References: <20060109204034.GA3565@localhost.localdomain> <1136971196.43c4cdbc56fb8@webmail.in-berlin.de> <20060111201018.GB3523@localhost.localdomain>
Message-ID: <200601120735.23700.stefan@lucke.in-berlin.de>

On Mittwoch, 11. Januar 2006 21:10, Marko M?kel? wrote:
> On Wed, Jan 11, 2006 at 10:19:56AM +0100, Stefan Lucke wrote:
> > Quoting Martin Wache <M.Wache at gmx.net>:
> > > >> I'm using the primary head of a Matrox G450 card.
> > > >>
> > > I really thought that the Matrox could do hardware alpha blending. Do
> > > you use a 32-bit colour depth?
> > 
> > They can do hw alpha blend, when YUY2 format and stretchblit is used.
> > They canNOT do this when backend scaler is used.
> 
> Does this mean that alpha blending is available on TV out?  

Yes,  option '-vo dfb:mgatv' implicit switches to YUY2 and stretchblit.

> Should I
> perhaps give the TV out another try?  When I tried it last spring, it
> was unuseable slow (slower than VGA output), presumably due to color
> space conversion done in software.
> 
> Is StretchBlit a software or a hardware operation?  

Stretchblit is a hardware operation and it does the mixing (alpha
blending) of OSD.

> In the past, when
> I have tried to enable it in the OSD menu, it has reverted to disabled.

YUY2 was a precondition for strechtblit. I don't know if that works
with all cards. At least YUY2 and stretch blit works on matrox.
Stretchblit with via is tooo slow.

-- 
Stefan Lucke



From malcolm.caldwell at ntu.edu.au  Thu Jan 12 08:47:16 2006
From: malcolm.caldwell at ntu.edu.au (Malcolm Caldwell)
Date: Thu, 12 Jan 2006 17:17:16 +0930
Subject: [Softdevice-devel] new OSD support; DirectFB issues
In-Reply-To: <200601120735.23700.stefan@lucke.in-berlin.de>
References: <20060109204034.GA3565@localhost.localdomain>
	 <1136971196.43c4cdbc56fb8@webmail.in-berlin.de>
	 <20060111201018.GB3523@localhost.localdomain>
	 <200601120735.23700.stefan@lucke.in-berlin.de>
Message-ID: <1137052036.4625.22.camel@localhost.localdomain>

On Thu, 2006-01-12 at 07:35 +0100, Stefan Lucke wrote:
> On Mittwoch, 11. Januar 2006 21:10, Marko M?kel? wrote:
> > On Wed, Jan 11, 2006 at 10:19:56AM +0100, Stefan Lucke wrote:
> > > Quoting Martin Wache <M.Wache at gmx.net>:
> > > > >> I'm using the primary head of a Matrox G450 card.
> > > > >>
> > > > I really thought that the Matrox could do hardware alpha blending. Do
> > > > you use a 32-bit colour depth?
> > > 
> > > They can do hw alpha blend, when YUY2 format and stretchblit is used.
> > > They canNOT do this when backend scaler is used.
> > 
> > Does this mean that alpha blending is available on TV out?  
> 
> Yes,  option '-vo dfb:mgatv' implicit switches to YUY2 and stretchblit.

However, at least on my machine, dfb:mgatv does not allow alpha blending
- its disabled. 

> 
> > Should I
> > perhaps give the TV out another try?  When I tried it last spring, it
> > was unuseable slow (slower than VGA output), presumably due to color
> > space conversion done in software.
> > 
> > Is StretchBlit a software or a hardware operation?  
> 
> Stretchblit is a hardware operation and it does the mixing (alpha
> blending) of OSD.
> 
> > In the past, when
> > I have tried to enable it in the OSD menu, it has reverted to disabled.
> 
> YUY2 was a precondition for strechtblit. I don't know if that works
> with all cards. At least YUY2 and stretch blit works on matrox.
> Stretchblit with via is tooo slow.
> 



From stefan at lucke.in-berlin.de  Thu Jan 12 09:46:47 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 12 Jan 2006 09:46:47 +0100
Subject: option -vo dfb:mgatv (Was: Re: [Softdevice-devel] new OSD support; DirectFB issues)
In-Reply-To: <1137052036.4625.22.camel@localhost.localdomain>
References: <20060109204034.GA3565@localhost.localdomain>  <1136971196.43c4cdbc56fb8@webmail.in-berlin.de>  <20060111201018.GB3523@localhost.localdomain>  <200601120735.23700.stefan@lucke.in-berlin.de> <1137052036.4625.22.camel@localhost.localdomain>
Message-ID: <1137055607.43c6177710306@webmail.in-berlin.de>

Quoting Malcolm Caldwell <malcolm.caldwell at ntu.edu.au>:

> On Thu, 2006-01-12 at 07:35 +0100, Stefan Lucke wrote:
> > On Mittwoch, 11. Januar 2006 21:10, Marko M??kel?? wrote:
> > > On Wed, Jan 11, 2006 at 10:19:56AM +0100, Stefan Lucke wrote:
> > > > Quoting Martin Wache <M.Wache at gmx.net>:
> > > > > >> I'm using the primary head of a Matrox G450 card.
> > > > > >>
> > > > > I really thought that the Matrox could do hardware alpha blending. Do
> > > > > you use a 32-bit colour depth?
> > > >
> > > > They can do hw alpha blend, when YUY2 format and stretchblit is used.
> > > > They canNOT do this when backend scaler is used.
> > >
> > > Does this mean that alpha blending is available on TV out?
> >
> > Yes,  option '-vo dfb:mgatv' implicit switches to YUY2 and stretchblit.
>
> However, at least on my machine, dfb:mgatv does not allow alpha blending
> - its disabled.
>

Strange, are there some messages with errors (stderr or syslog) ?
Usually you need to load a kernel module to get 'mgatv' option work.

Stefan Lucke


From marko.makela at hut.fi  Thu Jan 12 21:39:01 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 12 Jan 2006 22:39:01 +0200
Subject: option -vo dfb:mgatv (Was: Re: [Softdevice-devel] new OSD support; DirectFB issues)
In-Reply-To: <1137055607.43c6177710306@webmail.in-berlin.de>
References: <20060109204034.GA3565@localhost.localdomain> <1136971196.43c4cdbc56fb8@webmail.in-berlin.de> <20060111201018.GB3523@localhost.localdomain> <200601120735.23700.stefan@lucke.in-berlin.de> <1137052036.4625.22.camel@localhost.localdomain> <1137055607.43c6177710306@webmail.in-berlin.de>
Message-ID: <20060112203901.GA3487@localhost.localdomain>

On Thu, Jan 12, 2006 at 09:46:47AM +0100, Stefan Lucke wrote:
> Quoting Malcolm Caldwell <malcolm.caldwell at ntu.edu.au>:
> 
> > > Yes,  option '-vo dfb:mgatv' implicit switches to YUY2 and stretchblit.
> >
> > However, at least on my machine, dfb:mgatv does not allow alpha blending
> > - its disabled.
> >
> 
> Strange, are there some messages with errors (stderr or syslog) ?
> Usually you need to load a kernel module to get 'mgatv' option work.

I just switched back to -vo dfb:mgatv output.  I almost forgot that
/etc/directfbrc has to be adjusted accordingly.  Here's my directfbrc
for mgatv:

matrox-crtc2
matrox-tv-standard=pal
matrox-cable-type=scart-rgb
primary-layer=2
hardware
mmx
no-banner
no-vt
graphics-vt
linux-input-ir-only

And here's my directfbrc for VGA output:

fbdev=/dev/fb0
mode=768x576
no-banner
no-debug
no-vt
depth=16
linux-input-ir-only

I guess there might be some redundant entries in my directfbrc for mgatv.
If I comment out primary-layer=2, the picture will be out of sync (it looks
like the default setting (primary-layer=0) produces VGA frequencies).
If I set primary-layer=1, I get a static almost-completely-black screen.

Here's a log excerpt for primary-layer=2:

-----
[dfb] Enumerating display Layers
Layer 2 FBDev Primary Layer  Type: graphics
  Caps: brightness contrast saturation surface
Layer 1 Matrox Backend Scaler  Type: graphics picture video
  Caps: brightness contrast deinterlacing dst_colorkey screen_location surface
Layer 0 Matrox CRTC2 Layer  Type: graphics picture video
  Caps: brightness contrast hue field_parity saturation surface
[dfb] Set DLBM_TRIPLE for layer [Matrox CRTC2 Layer]
[dfb] DLOP_FIELD_PARITY supported by layer [Matrox CRTC2 Layer]
[surface capabilities] scrSurface: videoonly flipping interlaced triple-buffered
[dfb] width = 720, height = 576
[dfb] got fmt = 0x00418c04 bpp = 32
[dfb] Using this layer for OSD: (Matrox CRTC2 Layer - [720x576])
[surface capabilities] osdSurface: videoonly double-buffered flipping
[surface capabilities] videoSurface: videoonly
[dfb] Using this layer for OSD: Matrox CRTC2 Layer
[dfb] Using this layer for Video out: Matrox CRTC2 Layer
[dfb] Display frame time is 19964 microseconds
[dfb] (re)configuring Videolayer to 720 x 576 (720x576)
[dfb] creating new surface (stretchBlit)
[surface capabilities] videoSurface: videoonly
[dfb] (re)configured 0x00200806
[softdevice] Video Out seems to be OK
[softdevice] Initializing Audio Out
[softdevice] Audio out seems to be OK
[softdevice] A/V devices initialized, now initializing MPEG2 Decoder
cSoftDevice::MakePrimaryDevice
[dfb] (re)configuring Videolayer to 704 x 576 (528x576)
[dfb] creating new surface (stretchBlit)
[surface capabilities] videoSurface: videoonly
[dfb] (re)configured 0x00200806
-----

Any suggestions for improvement?  The card is a Matrox G450.

After I set the display aspect ratio to 4:3 (it somehow was 5:4) to disable
scaling, interlaced video looks perfect.  Also the background of the OSD
is nicely alpha blended.

The only issue I have with -vo dfb:mgatv is occasional audio chopping.
I have the feeling that average CPU consumption is 40%-60% (of 900 MHz
Celeron), while on VGA output it is 30%-50%.  On VGA output, the only
way to get audio chopping is to transfer large files over the network.
Even enabling deinterlacing won't cause audio chopping.

Could the audio chopping on dfb:mgatv be due to A/V synchronization rather
than running out of CPU cycles?  I'll try firing up OProfile to see if
there is anything obvious that could reduce the CPU consumption.

For the time being, I think I will switch to dfb:mgatv, because it produces
sharper picture and reduces the amount of cables and boxes.  Really, the only
issue is the occasional audio chopping.

	Marko


From marko.makela at hut.fi  Thu Jan 12 22:21:17 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 12 Jan 2006 23:21:17 +0200
Subject: [Softdevice-devel] Apparent cache misses in yv12_to_yuy2()
Message-ID: <20060112212117.GB3487@localhost.localdomain>

The bottleneck with dfb:mgatv seems to be the yv12_to_yuy2() conversion
routine.  Here is some output from a short OProfile session of

opcontrol --reset
opcontrol --event=CPU_CLK_UNHALTED:90000:0:1:1 --start
# wait a couple of minutes of vdr running
opcontrol --stop

opreport --global-percent|head -15|tail +4
  samples|      %|
------------------
   175300 65.9127 libvdr-softdevice.so.1.3.37
    26491  9.9606 libdirectfb_matrox.so
    25179  9.4673 vmlinux
    10347  3.8905 oprofiled
     8917  3.3528 vdr
     8220  3.0907 libc-2.3.5.so
     4394  1.6521 oprofile
     2277  0.8562 libasound.so.2.0.0
     1142  0.4294 libpthread-2.3.5.so
      576  0.2166 cx8802

opreport -l .../libvdr-softdevice.so.1.3.37|head -15|tail +3
samples  %        symbol name
51820    29.5608  yv12_to_yuy2(unsigned char const*, unsigned char const*, unsigned char const*, unsigned char*, int, int, int, int, int)
16726     9.5414  mpeg_decode_mb
15620     8.9104  ff_mpa_synth_filter
13357     7.6195  put_pixels16_mmx
12487     7.1232  put_pixels8_mmx
8552      4.8785  put_pixels16_xy2_mmx
8013      4.5710  ff_simple_idct_add_mmx
5076      2.8956  MPV_decode_mb
3986      2.2738  MPV_motion
3906      2.2282  ff_simple_idct_put_mmx
3126      1.7832  mpeg_decode_motion
2819      1.6081  put_pixels16_y2_mmx2

opannotate -a -t 25 .../libvdr-softdevice.so.1.3.37|less

...
               :   5f314:       xor    %esi,%esi
    18  0.0103 :   5f316:       lea    0x0(%esi),%esi
               :   5f319:       lea    0x0(%edi),%edi
   171  0.0975 :   5f320:       movd   (%ebx),%mm1
 10316  5.8848 :   5f323:       movd   (%ecx),%mm2
  7726  4.4073 :   5f326:       movq   (%edx),%mm0
 26967 15.3833 :   5f329:       punpcklbw %mm2,%mm1
    10  0.0057 :   5f32c:       movq   %mm0,%mm3
   299  0.1706 :   5f32f:       movq   %mm1,%mm4
    63  0.0359 :   5f332:       punpcklbw %mm1,%mm0
    88  0.0502 :   5f335:       punpckhbw %mm4,%mm3
  1644  0.9378 :   5f338:       movq   %mm0,(%eax)

It looks like this one MMX instruction is consuming 15% of softdevice
time, or 0.153833*0.659127 = 10% of all samples, or 6% of all CPU,
assuming that the CPU is 40% idle.  I would guess that this is due to
a memory fault.  Let us measure the memory references instead of CPU
cycles, with opcontrol --event=DATA_MEM_REFS:7500:0:1:1 --start:

opreport --global-percent|head -15|tail +4
  samples|      %|
------------------
   218646 65.4678 libvdr-softdevice.so.1.3.37
    37578 11.2517 libdirectfb_matrox.so
    31738  9.5031 vmlinux
    12984  3.8877 oprofiled
     9497  2.8436 vdr
     8978  2.6882 libc-2.3.5.so
     5567  1.6669 oprofile
     3026  0.9061 libasound.so.2.0.0
     1332  0.3988 libpthread-2.3.5.so
      724  0.2168 cx8802

opreport -l .../libvdr-softdevice.so.1.3.37 |head -15|tail +3
samples  %        symbol name
68331    31.2519  yv12_to_yuy2(unsigned char const*, unsigned char const*, unsigned char const*, unsigned char*, int, int, int, int, int)
20615     9.4285  ff_mpa_synth_filter
19251     8.8046  put_pixels16_mmx
18329     8.3830  mpeg_decode_mb
18191     8.3198  put_pixels8_mmx
8380      3.8327  ff_simple_idct_add_mmx
7665      3.5057  put_pixels16_xy2_mmx
6996      3.1997  MPV_decode_mb
5098      2.3316  ff_simple_idct_put_mmx
4601      2.1043  MPV_motion
3993      1.8262  put_pixels16_x2_mmx2
3505      1.6030  mpeg_decode_motion

opannotate -a -t 25 .../libvdr-softdevice.so.1.3.37 |less
...
               :   5f314:       xor    %esi,%esi
    40  0.0183 :   5f316:       lea    0x0(%esi),%esi
     1 4.6e-04 :   5f319:       lea    0x0(%edi),%edi
   153  0.0700 :   5f320:       movd   (%ebx),%mm1
 14148  6.4707 :   5f323:       movd   (%ecx),%mm2
  3767  1.7229 :   5f326:       movq   (%edx),%mm0
 41531 18.9946 :   5f329:       punpcklbw %mm2,%mm1
    10  0.0046 :   5f32c:       movq   %mm0,%mm3
   466  0.2131 :   5f32f:       movq   %mm1,%mm4
    68  0.0311 :   5f332:       punpcklbw %mm1,%mm0
    91  0.0416 :   5f335:       punpckhbw %mm4,%mm3
  2178  0.9961 :   5f338:       movq   %mm0,(%eax)

Indeed, it seems to be a data cache miss.  These instructions
seem to correspond to the for loop in yv12_to_yuy2(), in utils.c.

I believe that it would help to add an explicit prefetch in the beginning
of this function, or perhaps before the function call in cDFBVideoOut::YUV().
That'd be __builtin_prefetch(addr, 1, 0) in GCC, I guess.  I'll see if
I can do it.  I must say that I'm not very familiar with these instruction
set extensions for vector processing.

Would it even be possible to decode directly into YUY2 color space?

BTW, when I switched colorspaces on the fly from the OSD menu, I got
funny OSD effects and blank video when StretchBlit was disabled,
but no crash.

	Marko


From marko.makela at hut.fi  Thu Jan 12 22:47:34 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 12 Jan 2006 23:47:34 +0200
Subject: [Softdevice-devel] Apparent cache misses in yv12_to_yuy2()
In-Reply-To: <20060112212117.GB3487@localhost.localdomain>
References: <20060112212117.GB3487@localhost.localdomain>
Message-ID: <20060112214734.GC3487@localhost.localdomain>

On Thu, Jan 12, 2006 at 11:21:17PM +0200, Marko M?kel? wrote:
>    171  0.0975 :   5f320:       movd   (%ebx),%mm1
>  10316  5.8848 :   5f323:       movd   (%ecx),%mm2
>   7726  4.4073 :   5f326:       movq   (%edx),%mm0
>  26967 15.3833 :   5f329:       punpcklbw %mm2,%mm1
>     10  0.0057 :   5f32c:       movq   %mm0,%mm3
>    299  0.1706 :   5f32f:       movq   %mm1,%mm4
>     63  0.0359 :   5f332:       punpcklbw %mm1,%mm0
>     88  0.0502 :   5f335:       punpckhbw %mm4,%mm3
>   1644  0.9378 :   5f338:       movq   %mm0,(%eax)
> 
> It looks like this one MMX instruction is consuming 15% of softdevice
> time, or 0.153833*0.659127 = 10% of all samples, or 6% of all CPU,
> assuming that the CPU is 40% idle.  I would guess that this is due to
> a memory fault.

More probably, the samples are reported one instructions too late.
The real culprits are the movd and movq instructions in the beginning
of the loop.

The article "Applications Tuning for Streaming SIMD Extensions" at
http://developer.intel.com/technology/itj/archive/1999.htm
suggests that the loop should be unrolled to get any advantage of
prefetching.  Each unrolled pass should process one cache line worth
of prefetched variables.  Assuming 16 bytes cache line width, the
loop would have to be unrolled 4 times to process a full cache line of
pu and pv and two cache lines of py.

I tried adding prefetch instructions using the predefined macros
in mmx.h, but it didn't help.  I guess the guys at SiS already
considered this.  Besides, the CPU probably does some heuristic
prefetching on its own.

	Marko


From jahuttun at gmail.com  Thu Jan 12 22:45:59 2006
From: jahuttun at gmail.com (Janne Huttunen)
Date: Thu, 12 Jan 2006 23:45:59 +0200
Subject: [Softdevice-devel] [PATCH] Fix softdevice compilation for AMD64
Message-ID: <43C6CE17.3030106@gmail.com>

This patch makes softdevice compile again on AMD64.
Works for me(tm).


Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.20
diff -u -r1.20 Makefile
--- Makefile	7 Jan 2006 14:28:39 -0000	1.20
+++ Makefile	12 Jan 2006 17:07:34 -0000
@@ -184,7 +184,7 @@
 ### normally you shoudn't have to touch something below this line
 
 CXX      ?= g++
-CXXFLAGS ?= -O2 -g -Wall -Woverloaded-virtual
+CXXFLAGS ?= -O2 -g -Wall -fPIC -Woverloaded-virtual
 
 ### The directory environment:
 
Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.3
diff -u -r1.3 SoftOsd.c
--- SoftOsd.c	9 Jan 2006 20:26:02 -0000	1.3
+++ SoftOsd.c	12 Jan 2006 17:07:34 -0000
@@ -323,7 +323,7 @@
 	end_dest+=16;
 #endif
         while (end_dest>dest) {
-                if ( IS_BACKGROUND(pixmap->a) && (((int)dest) & 0x4) ) {
+                if ( IS_BACKGROUND(pixmap->a) && (((intptr_t)dest) & 0x4) ) {
                         dest[0] = 0; dest[1] = 0; dest[2] = 0; dest[3] = 0x00;
                         // color key!
                 } else {
@@ -472,7 +472,7 @@
         end_dest+=8;
 #endif
         while (end_dest>dest) {
-                if ( IS_BACKGROUND(pixmap->a) && (((int)dest) & 0x2) ) {
+                if ( IS_BACKGROUND(pixmap->a) && (((intptr_t)dest) & 0x2) ) {
                         dest[0] = 0x0; dest[1] = 0x0; // color key!
                 } else {
                         dest[0] = ((pixmap->b >> 3)& 0x1F) | 
@@ -490,7 +490,7 @@
 	uint8_t *end_dest=dest+2*Pixel;
 	int PixelCount=0;
         while (end_dest>dest) {
-                if ( IS_BACKGROUND(pixmap->a) && (((int)pixmap) & 0x4)
+                if ( IS_BACKGROUND(pixmap->a) && (((intptr_t)pixmap) & 0x4)
 				|| IS_TRANSPARENT(pixmap->a) ) {
                         // transparent, don't draw anything !
                 } else {
@@ -509,7 +509,7 @@
 void cSoftOsd::CreatePixelMask(uint8_t * dest, color * pixmap, int Pixel) {
 	int CurrPixel=0;
         while (CurrPixel<Pixel) {
-                if ( (IS_BACKGROUND(pixmap->a) && !(((int)pixmap) & 0x4)  )
+                if ( (IS_BACKGROUND(pixmap->a) && !(((intptr_t)pixmap) & 0x4)  )
                                 || IS_OPAQUE(pixmap->a) ) 
                         dest[CurrPixel/8]|=(1<<CurrPixel%8);
                  else dest[CurrPixel/8]&=~(1<<CurrPixel%8);
Index: audio-ac3pt.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/audio-ac3pt.c,v
retrieving revision 1.1
diff -u -r1.1 audio-ac3pt.c
--- audio-ac3pt.c	6 Oct 2005 21:16:47 -0000	1.1
+++ audio-ac3pt.c	12 Jan 2006 17:07:34 -0000
@@ -18,7 +18,7 @@
 #include <alsa/asoundlib.h>
 #include "audio-ac3pt.h"
 
-enum {SPDIF_CON, SPDIF_PRO} spdif_t;
+typedef enum {SPDIF_CON, SPDIF_PRO} spdif_t;
 
 
 #ifndef WORDS_BIGENDIAN
Index: video-fb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-fb.c,v
retrieving revision 1.10
diff -u -r1.10 video-fb.c
--- video-fb.c	7 Jan 2006 14:28:39 -0000	1.10
+++ video-fb.c	12 Jan 2006 17:07:34 -0000
@@ -135,7 +135,7 @@
 
     OSDpresent=false;
 
-    printf("[video-fb] init %d x %d (Size: %d Bytes LineLen %d) Bpp: %d\n",fb_vinfo.xres, fb_vinfo.yres, size, line_len, fb_vinfo.bits_per_pixel);
+    printf("[video-fb] init %d x %d (Size: %zu Bytes LineLen %d) Bpp: %d\n",fb_vinfo.xres, fb_vinfo.yres, size, line_len, fb_vinfo.bits_per_pixel);
     // clear screens
     printf("[video-fb] Clearing the FB\n");
     unsigned char * fbinit;
Index: video-xv.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-xv.c,v
retrieving revision 1.36
diff -u -r1.36 video-xv.c
--- video-xv.c	7 Jan 2006 14:28:39 -0000	1.36
+++ video-xv.c	12 Jan 2006 17:07:34 -0000
@@ -1025,7 +1025,7 @@
           {
             if (!strcmp(encodingInfo[n].name, "XV_IMAGE"))
             {
-              fprintf(stderr, "[XvVideoOut]: max area size %d x %d\n",
+              fprintf(stderr, "[XvVideoOut]: max area size %lu x %lu\n",
                       encodingInfo[n].width, encodingInfo[n].height);
               dsyslog("[XvVideoOut]: max area size %lu x %lu",
                       encodingInfo[n].width, encodingInfo[n].height);



From stefan at lucke.in-berlin.de  Fri Jan 13 07:43:00 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 13 Jan 2006 07:43:00 +0100
Subject: [Softdevice-devel] Getting rid of vertical tearing?
Message-ID: <200601130743.00341.stefan@lucke.in-berlin.de>

On Donnerstag, 12. Januar 2006 06:15, Dave wrote:
> I use softdevice with directfb, with a matrox g450 with VGA out, (non-tv 
> out), at 800x600 res to match my projector, but there is noticeable 
> vertical tearing in the picture, and I was wondering if there was a way 
> to get either directfb or softdevice to sync to vertical refresh to rid 
> of these effects?

Usually we sync to vertical refresh. So it may depend on your
CPU (M/GHz ?) or assigned interrupt or kernel modules loaded.

>  My guess is that the image is being displayed during 
> vertical refresh, therefore it tears in fast motion scenes.  My screen 
> is large therefore its quite noticeable for me.
> 



-- 
Stefan Lucke



From M.Wache at gmx.net  Sun Jan 15 22:14:28 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 15 Jan 2006 22:14:28 +0100
Subject: [Softdevice-devel] [PATCH] Fix softdevice compilation for AMD64
In-Reply-To: <43C6CE17.3030106@gmail.com>
References: <43C6CE17.3030106@gmail.com>
Message-ID: <43CABB34.7080009@gmx.net>

Janne Huttunen schrieb:
> 
> This patch makes softdevice compile again on AMD64.
> Works for me(tm).
> 
> 
Thank you for the patch, I applied it to the CVS a moment ago.

However, I'm not really sure about this change:

-CXXFLAGS ?= -O2 -g -Wall -Woverloaded-virtual
+CXXFLAGS ?= -O2 -g -Wall -fPIC -Woverloaded-virtual

I now that -fPIC is now the default for vdr and that it is needed for 
AMD64, but I'm not sure about previous versions. For me this still works 
so I committed the change.

Bye,
Martin


From M.Wache at gmx.net  Mon Jan 16 21:46:24 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 16 Jan 2006 21:46:24 +0100
Subject: [Softdevice-devel] Apparent cache misses in yv12_to_yuy2()
In-Reply-To: <20060112214734.GC3487@localhost.localdomain>
References: <20060112212117.GB3487@localhost.localdomain> <20060112214734.GC3487@localhost.localdomain>
Message-ID: <43CC0620.1040107@gmx.net>

Marko M?kel? schrieb:
> On Thu, Jan 12, 2006 at 11:21:17PM +0200, Marko M?kel? wrote:
>>    171  0.0975 :   5f320:       movd   (%ebx),%mm1
>>  10316  5.8848 :   5f323:       movd   (%ecx),%mm2
>>   7726  4.4073 :   5f326:       movq   (%edx),%mm0
>>  26967 15.3833 :   5f329:       punpcklbw %mm2,%mm1
>>     10  0.0057 :   5f32c:       movq   %mm0,%mm3
>>    299  0.1706 :   5f32f:       movq   %mm1,%mm4
>>     63  0.0359 :   5f332:       punpcklbw %mm1,%mm0
>>     88  0.0502 :   5f335:       punpckhbw %mm4,%mm3
>>   1644  0.9378 :   5f338:       movq   %mm0,(%eax)
>>
>> It looks like this one MMX instruction is consuming 15% of softdevice
>> time, or 0.153833*0.659127 = 10% of all samples, or 6% of all CPU,
>> assuming that the CPU is 40% idle.  I would guess that this is due to
>> a memory fault.
> 
> More probably, the samples are reported one instructions too late.
> The real culprits are the movd and movq instructions in the beginning
> of the loop.
> 
> The article "Applications Tuning for Streaming SIMD Extensions" at
> http://developer.intel.com/technology/itj/archive/1999.htm
> suggests that the loop should be unrolled to get any advantage of
> prefetching.  Each unrolled pass should process one cache line worth
> of prefetched variables.  Assuming 16 bytes cache line width, the
> loop would have to be unrolled 4 times to process a full cache line of
> pu and pv and two cache lines of py.
> 
> I tried adding prefetch instructions using the predefined macros
> in mmx.h, but it didn't help.  I guess the guys at SiS already
> considered this.  Besides, the CPU probably does some heuristic
> prefetching on its own.
> 

Hi Marco,

I share your opinion that prefetch-instructions would probably speed up
this routine. And I also it, and I too found that there is no speed
gain. This made me wonder a lot since I've used prefetch-instructions
with great success in the software alpha-blending.
Then I tried several things to find out why there is no speedup, first I
commented all the memory to register movd/movq's - no speedup. I
commented a few other instructions like the punpack, etc - still no
speed up. But when I commented the movq register to memory there was a
great speed up ( more than 2x faster!), even when I uncommented all the
other instructions.
So it seems that on my machine it is not the reading from the memory but
the _writing_ which is slow - I assume because the video buffer is
directly in the video memory.
I'm not sure what one can do to speed this up. Setting up the /proc/mtrr
registers should help, but on my machine they are already properly set
up. I wonder if it is possible with DFB to write the image to a main
memory block and then use DMA copy to copy it to the video memory like
it is done in most Xv implementations.

Can you confirm the speedup when commenting the write to the video memory?

Martin


From voitto.tuomainen at luukku.com  Tue Jan 17 08:21:48 2006
From: voitto.tuomainen at luukku.com (Voitto Tuomainen)
Date: Tue, 17 Jan 2006 09:21:48 +0200 (EET)
Subject: [Softdevice-devel] Softplay shows dvb subtitles from tv broadcast
Message-ID: <1137482508475.voitto.tuomainen.8797.YAldFM5Cr5kjnWffohWpXQ@luukku.com>

Hi,
I've noticed couple days back, when trying softplay, that it shows dvb subtitles, if they are shown in tv broadcast.

Is there anything other to do, than change tv-channel to such, which does not have them?
_____
BR, Voitto Tuomainen

...................................................................
Luukku Plus paketilla p??set eroon tila- ja turvallisuusongelmista.
Hanki Luukku Plus ja helpotat el?m??si. http://www.mtv3.fi/luukku



From stefan at lucke.in-berlin.de  Tue Jan 17 08:26:37 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 17 Jan 2006 08:26:37 +0100
Subject: [Softdevice-devel] Apparent cache misses in yv12_to_yuy2()
In-Reply-To: <43CC0620.1040107@gmx.net>
References: <20060112212117.GB3487@localhost.localdomain> <20060112214734.GC3487@localhost.localdomain> <43CC0620.1040107@gmx.net>
Message-ID: <1137482797.43cc9c2de45fc@webmail.in-berlin.de>

Quoting Martin Wache <M.Wache at gmx.net>:

> Marko M?kel? schrieb:
> > On Thu, Jan 12, 2006 at 11:21:17PM +0200, Marko M?kel? wrote:
> >>    171  0.0975 :   5f320:       movd   (%ebx),%mm1
> >>  10316  5.8848 :   5f323:       movd   (%ecx),%mm2
> >>   7726  4.4073 :   5f326:       movq   (%edx),%mm0
> >>  26967 15.3833 :   5f329:       punpcklbw %mm2,%mm1
> >>     10  0.0057 :   5f32c:       movq   %mm0,%mm3
> >>    299  0.1706 :   5f32f:       movq   %mm1,%mm4
> >>     63  0.0359 :   5f332:       punpcklbw %mm1,%mm0
> >>     88  0.0502 :   5f335:       punpckhbw %mm4,%mm3
> >>   1644  0.9378 :   5f338:       movq   %mm0,(%eax)
> >>
> >> It looks like this one MMX instruction is consuming 15% of softdevice
> >> time, or 0.153833*0.659127 = 10% of all samples, or 6% of all CPU,
> >> assuming that the CPU is 40% idle.  I would guess that this is due to
> >> a memory fault.
> >
> > More probably, the samples are reported one instructions too late.
> > The real culprits are the movd and movq instructions in the beginning
> > of the loop.
> >
> > The article "Applications Tuning for Streaming SIMD Extensions" at
> > http://developer.intel.com/technology/itj/archive/1999.htm
> > suggests that the loop should be unrolled to get any advantage of
> > prefetching.  Each unrolled pass should process one cache line worth
> > of prefetched variables.  Assuming 16 bytes cache line width, the
> > loop would have to be unrolled 4 times to process a full cache line of
> > pu and pv and two cache lines of py.
> >
> > I tried adding prefetch instructions using the predefined macros
> > in mmx.h, but it didn't help.  I guess the guys at SiS already
> > considered this.  Besides, the CPU probably does some heuristic
> > prefetching on its own.
> >
>
> Hi Marco,
>
> I share your opinion that prefetch-instructions would probably speed up
> this routine. And I also it, and I too found that there is no speed
> gain. This made me wonder a lot since I've used prefetch-instructions
> with great success in the software alpha-blending.
> Then I tried several things to find out why there is no speedup, first I
> commented all the memory to register movd/movq's - no speedup. I
> commented a few other instructions like the punpack, etc - still no
> speed up. But when I commented the movq register to memory there was a
> great speed up ( more than 2x faster!), even when I uncommented all the
> other instructions.
> So it seems that on my machine it is not the reading from the memory but
> the _writing_ which is slow - I assume because the video buffer is
> directly in the video memory.

Single writes to AGP (video memory) should be avoided. Using a memory buffer
to convert (first) and copy to video (later) should be (much) faster.
Perhaps we should add an intermediate surface, and let directfb do the
conversion. I think there are some format conversions functions available.

> I'm not sure what one can do to speed this up. Setting up the /proc/mtrr
> registers should help, but on my machine they are already properly set
> up.

> I wonder if it is possible with DFB to write the image to a main
> memory block and then use DMA copy to copy it to the video memory like
> it is done in most Xv implementations.

DMA and Xv ? Can you give me a hint which XV implementation uses hardware acc
for YV12 formats ? The only thing I've seen is that they use a function often
called like copy_munged_data() to convert YV12 to YUV2 (thats true for matrox).

Stefan Lucke


From M.Wache at gmx.net  Tue Jan 17 18:01:19 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 17 Jan 2006 18:01:19 +0100
Subject: [Softdevice-devel] Softplay shows dvb subtitles from tv broadcast
In-Reply-To: <1137482508475.voitto.tuomainen.8797.YAldFM5Cr5kjnWffohWpXQ@luukku.com>
References: <1137482508475.voitto.tuomainen.8797.YAldFM5Cr5kjnWffohWpXQ@luukku.com>
Message-ID: <43CD22DF.6090706@gmx.net>

Voitto Tuomainen schrieb:
> Hi,
> I've noticed couple days back, when trying softplay, that it shows dvb subtitles, 
> if they are shown in tv broadcast.
> 
> Is there anything other to do, than change tv-channel to such, which does not have them?
> 

Hmm, I was not aware that softplay shows dvb subtitles. What are you
exactly doing? Are you watching a recorded PES stream (like the vdr
recordings)? Are you sure that the subtitles are not already encoded in
the video? I guess you are, I just want to be shure...

I know that ffmpeg can decode dvb subtitles, but I thought one has to do
something to get it decoded - and I certainly didn't do anything.
I will have a look at it.

Bye,
Martin



From M.Wache at gmx.net  Tue Jan 17 18:13:13 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 17 Jan 2006 18:13:13 +0100
Subject: [Softdevice-devel] Apparent cache misses in yv12_to_yuy2()
In-Reply-To: <1137482797.43cc9c2de45fc@webmail.in-berlin.de>
References: <20060112212117.GB3487@localhost.localdomain> <20060112214734.GC3487@localhost.localdomain> <43CC0620.1040107@gmx.net> <1137482797.43cc9c2de45fc@webmail.in-berlin.de>
Message-ID: <43CD25A9.70405@gmx.net>

Stefan Lucke schrieb:

>> So it seems that on my machine it is not the reading from the memory but
>> the _writing_ which is slow - I assume because the video buffer is
>> directly in the video memory.
> 
> Single writes to AGP (video memory) should be avoided. Using a memory buffer
> to convert (first) and copy to video (later) should be (much) faster.

I don't think so unless one uses DMA transfer for copying. Since in this
case the CPU is much faster than the writing and the mtrr register is
set to write-combined for the video memory the writes should be
transfered in large blocks.

> Perhaps we should add an intermediate surface, and let directfb do the
> conversion. I think there are some format conversions functions available.

If that is possible we should try that.

>> I wonder if it is possible with DFB to write the image to a main
>> memory block and then use DMA copy to copy it to the video memory like
>> it is done in most Xv implementations.
> 
> DMA and Xv ? Can you give me a hint which XV implementation uses hardware acc
> for YV12 formats ? The only thing I've seen is that they use a function often
> called like copy_munged_data() to convert YV12 to YUV2 (thats true for matrox).
> 
The R128 driver from XOrg and the Unichrome driver from Openchrome both
use DMA transfer to copy the overlay picture into video memory. In fact
these are the only two Xv implementations I know in source, but since
they both do it and it makes sense to do it I just assumed that most of
the Xv implementations do it like this. But I may be wrong here ;-)

Bye,
Martin


From marko.makela at hut.fi  Tue Jan 17 21:53:33 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 17 Jan 2006 22:53:33 +0200
Subject: [Softdevice-devel] Apparent cache misses in yv12_to_yuy2()
In-Reply-To: <43CC0620.1040107@gmx.net>
References: <20060112212117.GB3487@localhost.localdomain> <20060112214734.GC3487@localhost.localdomain> <43CC0620.1040107@gmx.net>
Message-ID: <20060117205333.GA3460@localhost.localdomain>

On Mon, Jan 16, 2006 at 09:46:24PM +0100, Martin Wache wrote:
> Then I tried several things to find out why there is no speedup, first I
> commented all the memory to register movd/movq's - no speedup. I
> commented a few other instructions like the punpack, etc - still no
> speed up. But when I commented the movq register to memory there was a
> great speed up ( more than 2x faster!), even when I uncommented all the
> other instructions.
> So it seems that on my machine it is not the reading from the memory but
> the _writing_ which is slow - I assume because the video buffer is
> directly in the video memory.
> I'm not sure what one can do to speed this up. Setting up the /proc/mtrr
> registers should help, but on my machine they are already properly set
> up.

On mine, they probably aren't.  I set a breakpoint in yv12_to_yuy2()
and found out that on the first round, srfc==0xb51dd000.  In /proc/mtrr,
I have the following:

reg00: base=0x00000000 (   0MB), size= 128MB: write-back, count=1
reg01: base=0xd6000000 (3424MB), size=  32MB: write-combining, count=1
reg06: base=0xe0000000 (3584MB), size=  64MB: write-combining, count=1

What should I write and where to correct the situation?  Again, this is
DirectFB on a "Matrox Graphics, Inc. Millennium G450 32Mb SDRAM Dual Head"
(description from lspci -vv)

> I wonder if it is possible with DFB to write the image to a main
> memory block and then use DMA copy to copy it to the video memory like
> it is done in most Xv implementations.

Maybe this could be done stride by stride, i.e., output to a main
memory block (of a few kilobytes) inside the loop on j, and fast_memcpy()
it to the surface memory after the loop?

> Can you confirm the speedup when commenting the write to the video memory?

I commented out the two movntq(mm?,*srfc) in the j loop.  Viewing live video
before the modification for 21 seconds:

opreport --global-percent:
   158838 62.5346 libvdr-softdevice.so.1.3.37
opreport -l libvdr-softdevice.so.1.3.37:
10479     6.5973  yv12_to_yuy2()

After the modification (black video surface) for 23 seconds:

opreport --global-percent:
   171060 62.4015 libvdr-softdevice.so.1.3.37
opreport -l libvdr-softdevice.so.1.3.37:
7080      4.1389  yv12_to_yuy2()

On my system, the improvement is only 4.1389/6.5973 - 1 = -37%.

I'll see if I can come up with a patch to output to a main memory block.

	Marko


From marko.makela at hut.fi  Tue Jan 17 21:56:01 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 17 Jan 2006 22:56:01 +0200
Subject: [Softdevice-devel] Softplay shows dvb subtitles from tv broadcast
In-Reply-To: <43CD22DF.6090706@gmx.net>
References: <1137482508475.voitto.tuomainen.8797.YAldFM5Cr5kjnWffohWpXQ@luukku.com> <43CD22DF.6090706@gmx.net>
Message-ID: <20060117205601.GB3460@localhost.localdomain>

On Tue, Jan 17, 2006 at 06:01:19PM +0100, Martin Wache wrote:
> Voitto Tuomainen schrieb:
> > Hi,
> > I've noticed couple days back, when trying softplay, that it shows dvb subtitles, 
> > if they are shown in tv broadcast.
> > 
> > Is there anything other to do, than change tv-channel to such, which does not have them?
> > 
> 
> Hmm, I was not aware that softplay shows dvb subtitles. What are you
> exactly doing? Are you watching a recorded PES stream (like the vdr
> recordings)? Are you sure that the subtitles are not already encoded in
> the video? I guess you are, I just want to be shure...

Are you by any chance using vdr 1.3.38 or 1.3.39 with the subtitles
plugin?  If yes, you may see DVB subtitles from live broadcast while
watching recordings.  I don't know if anyone has fixed it yet.  At least
I haven't seen any announcement on the vdr mailing list.  That's why
I have reverted to vdr-1.3.37.

	Marko


From M.Wache at gmx.net  Tue Jan 17 22:13:41 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 17 Jan 2006 22:13:41 +0100
Subject: [Softdevice-devel] "-vo shm:" / ShmClient a simple client/server model for the softdevice
Message-ID: <43CD5E05.2080702@gmx.net>

Hi all,

I've just committed a new video-out method to the softdevice. It's
purpose is to write the video to a shared memory segment, from which a
client can read it and display it. If no client is connected the
decoding is automatically suspended. If found this very useful for my
combined desktop/vdr box, now I can start vdr from startup-scripts and
when I want to watch TV or a recording I can start the Client from my X
session. And vdr is no longer stopped when I log out :-). This should
also be very useful if one wants to start Vdr from an other application
like for example freevo.

For now there is only a Xv-Client, in principle a Client for the other
output methods is also possible. For details how to build and use it
have a look at the README.

Have fun,

Martin


From M.Wache at gmx.net  Tue Jan 17 22:21:47 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 17 Jan 2006 22:21:47 +0100
Subject: [Softdevice-devel] Apparent cache misses in yv12_to_yuy2()
In-Reply-To: <20060117205333.GA3460@localhost.localdomain>
References: <20060112212117.GB3487@localhost.localdomain> <20060112214734.GC3487@localhost.localdomain> <43CC0620.1040107@gmx.net> <20060117205333.GA3460@localhost.localdomain>
Message-ID: <43CD5FEB.5000909@gmx.net>

Marko M?kel? schrieb:
> On Mon, Jan 16, 2006 at 09:46:24PM +0100, Martin Wache wrote:
>> Then I tried several things to find out why there is no speedup, first I
>> commented all the memory to register movd/movq's - no speedup. I
>> commented a few other instructions like the punpack, etc - still no
>> speed up. But when I commented the movq register to memory there was a
>> great speed up ( more than 2x faster!), even when I uncommented all the
>> other instructions.
>> So it seems that on my machine it is not the reading from the memory but
>> the _writing_ which is slow - I assume because the video buffer is
>> directly in the video memory.
>> I'm not sure what one can do to speed this up. Setting up the /proc/mtrr
>> registers should help, but on my machine they are already properly set
>> up.
> 
> On mine, they probably aren't.  I set a breakpoint in yv12_to_yuy2()
> and found out that on the first round, srfc==0xb51dd000.  In /proc/mtrr,
> I have the following:
> 
> reg00: base=0x00000000 (   0MB), size= 128MB: write-back, count=1
> reg01: base=0xd6000000 (3424MB), size=  32MB: write-combining, count=1
> reg06: base=0xe0000000 (3584MB), size=  64MB: write-combining, count=1
> 
> What should I write and where to correct the situation?  Again, this is
> DirectFB on a "Matrox Graphics, Inc. Millennium G450 32Mb SDRAM Dual Head"
> (description from lspci -vv)
> 
I guess the entry is correct, you can check the addresses with the
address lspci reports, the one you get from srfc is meaningless because
of the virtual memory system. You just don't now which virtual address
maps to which real memory address (I think only the kernel can tell that).

>> I wonder if it is possible with DFB to write the image to a main
>> memory block and then use DMA copy to copy it to the video memory like
>> it is done in most Xv implementations.
> 
> Maybe this could be done stride by stride, i.e., output to a main
> memory block (of a few kilobytes) inside the loop on j, and fast_memcpy()
> it to the surface memory after the loop?
> 
I'm not sure if fast_memcpy is really faster, but we could try.

>> Can you confirm the speedup when commenting the write to the video memory?
> 
> I commented out the two movntq(mm?,*srfc) in the j loop.  Viewing live video
> before the modification for 21 seconds:
> 
> opreport --global-percent:
>    158838 62.5346 libvdr-softdevice.so.1.3.37
> opreport -l libvdr-softdevice.so.1.3.37:
> 10479     6.5973  yv12_to_yuy2()
> 
> After the modification (black video surface) for 23 seconds:
> 
> opreport --global-percent:
>    171060 62.4015 libvdr-softdevice.so.1.3.37
> opreport -l libvdr-softdevice.so.1.3.37:
> 7080      4.1389  yv12_to_yuy2()
> 
> On my system, the improvement is only 4.1389/6.5973 - 1 = -37%.
> 

That's not that much. Did you try the opposite test, just commenting the
memory read movq/movd instructions to see if there is also a speedup?

Bye,
Martin



From marko.makela at hut.fi  Tue Jan 17 22:34:59 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 17 Jan 2006 23:34:59 +0200
Subject: [Softdevice-devel] Apparent cache misses in yv12_to_yuy2()
In-Reply-To: <20060117205333.GA3460@localhost.localdomain>
References: <20060112212117.GB3487@localhost.localdomain> <20060112214734.GC3487@localhost.localdomain> <43CC0620.1040107@gmx.net> <20060117205333.GA3460@localhost.localdomain>
Message-ID: <20060117213459.GC3460@localhost.localdomain>

On Tue, Jan 17, 2006 at 10:53:33PM +0200, Marko M?kel? wrote:
> Maybe this could be done stride by stride, i.e., output to a main
> memory block (of a few kilobytes) inside the loop on j, and fast_memcpy()
> it to the surface memory after the loop?

I tried this.

Before patching, viewing live video for 20 seconds:
   173680 65.2199 libvdr-softdevice.so.1.3.37
10131     5.8331  yv12_to_yuy2()

After original patch, viewing for 20 seconds:
   173900 65.2068 libvdr-softdevice.so.1.3.37
8391      4.8252  yv12_to_yuy2()

It seems a significant improvement in yv12_to_yuy2(), almost 16%
((8391/20) / (10479/21)-1), but the something makes the total
slower by 15% ((173900/20)/(158838/21)-1).

To test this theory, I replaced the stack-allocated buffer
uint8_t tmp[pitch] with static uint8_t tmp[8192]
(pitch==1408 in gdb).  Result from viewing for 20 seconds:

   166348 62.1934 libvdr-softdevice.so.1.3.37
9246      5.5582  yv12_to_yuy2()

Okay, not much better.  Perhaps the tmp buffer should be aligned at
a 4096-byte boundary?  Let's see, again viewing live video for 20 seconds:

   164434 63.1957 libvdr-softdevice.so.1.3.37
9474      5.7616  yv12_to_yuy2()

It doesn't seem to make any significant difference.

Maybe the whole frame should be copied to main memory first.  1408
bytes is not that big a block size.

Attached is the third version of my patch.  To get the second and
first version, replace "(uint8_t*) ((uint32_t(tmp)+4095)&~4095)"
with "tmp" and "static uint8_t tmp[8192]" with "uint8_t tmp[pitch]".

	Marko
-------------- next part --------------
Index: utils.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.c,v
retrieving revision 1.10
diff -p -u -r1.10 utils.c
--- utils.c	7 Jan 2006 13:26:43 -0000	1.10
+++ utils.c	17 Jan 2006 21:27:45 -0000
@@ -27,7 +27,7 @@
 #endif
 
 void yv12_to_yuy2(const uint8_t *ysrc, const uint8_t *usrc, const uint8_t *vsrc,
-                  uint8_t *dst, int width, int height,
+                  uint8_t *tmp, uint8_t *dst, int width, int height,
                   int lumStride, int chromStride, int dstStride)
 {
 #ifndef USE_MMX
@@ -65,7 +65,7 @@ void yv12_to_yuy2(const uint8_t *ysrc, c
     pv = vsrc;
     py = ysrc;
 
-    srfc = dst;
+    srfc = tmp;
 
     for (int j =0; j < width/8; j++)
     {
@@ -89,12 +89,13 @@ void yv12_to_yuy2(const uint8_t *ysrc, c
 
     ysrc += lumStride;;
 
-    if (i % 2 == 1)
+    if (i & 1)
     {
       usrc += chromStride;
       vsrc += chromStride;
     }
 
+    fast_memcpy(dst, tmp, dstStride);
     dst += dstStride;
   }
   __asm__ __volatile__ ("sfence \n"
Index: utils.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/utils.h,v
retrieving revision 1.5
diff -p -u -r1.5 utils.h
--- utils.h	15 Jul 2005 20:42:16 -0000	1.5
+++ utils.h	17 Jan 2006 21:27:45 -0000
@@ -22,6 +22,7 @@
 void yv12_to_yuy2( const uint8_t *ysrc,
                    const uint8_t *usrc,
                    const uint8_t *vsrc,
+                   uint8_t *tmp, // [dstStride]
                    uint8_t *dst,
                    int width,
                    int height,
Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.45
diff -p -u -r1.45 video-dfb.c
--- video-dfb.c	10 Jan 2006 19:40:25 -0000	1.45
+++ video-dfb.c	17 Jan 2006 21:27:45 -0000
@@ -1335,10 +1335,12 @@ void cDFBVideoOut::YUV(uint8_t *Py, uint
       }
 #endif
     } else if (pixelformat == DSPF_YUY2) {
+      static uint8_t tmp[8192];
 
       yv12_to_yuy2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
                    Pu + UVstride * cutTop + cutLeft,
                    Pv + UVstride * cutTop + cutLeft,
+                   (uint8_t*) ((uint32_t(tmp)+4095)&~4095),
                    dst + pitch * cutTop * 2 + cutLeft * 4,
                    Width - 2 * (cutLeft + cutRight),
                    Height - 2 * (cutTop + cutBottom),

From marko.makela at hut.fi  Tue Jan 17 22:47:25 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 17 Jan 2006 23:47:25 +0200
Subject: [Softdevice-devel] Apparent cache misses in yv12_to_yuy2()
In-Reply-To: <43CD5FEB.5000909@gmx.net>
References: <20060112212117.GB3487@localhost.localdomain> <20060112214734.GC3487@localhost.localdomain> <43CC0620.1040107@gmx.net> <20060117205333.GA3460@localhost.localdomain> <43CD5FEB.5000909@gmx.net>
Message-ID: <20060117214725.GD3460@localhost.localdomain>

On Tue, Jan 17, 2006 at 10:21:47PM +0100, Martin Wache wrote:
> > On mine, they probably aren't.  I set a breakpoint in yv12_to_yuy2()
> > and found out that on the first round, srfc==0xb51dd000.  In /proc/mtrr,
> > I have the following:
> > 
> > reg00: base=0x00000000 (   0MB), size= 128MB: write-back, count=1
> > reg01: base=0xd6000000 (3424MB), size=  32MB: write-combining, count=1
> > reg06: base=0xe0000000 (3584MB), size=  64MB: write-combining, count=1
> > 
> > What should I write and where to correct the situation?  Again, this is
> > DirectFB on a "Matrox Graphics, Inc. Millennium G450 32Mb SDRAM Dual Head"
> > (description from lspci -vv)
> > 
> I guess the entry is correct, you can check the addresses with the
> address lspci reports, the one you get from srfc is meaningless because
> of the virtual memory system. You just don't now which virtual address
> maps to which real memory address (I think only the kernel can tell that).

lspci says:

        Region 0: Memory at d6000000 (32-bit, prefetchable) [size=32M]
        Region 1: Memory at d9efc000 (32-bit, non-prefetchable) [size=16K]
        Region 2: Memory at d9000000 (32-bit, non-prefetchable) [size=8M]

So, I guess it's properly set up.

> >> Can you confirm the speedup when commenting the write to the video memory?
> > 
> > I commented out the two movntq(mm?,*srfc) in the j loop.  Viewing live video
> > before the modification for 21 seconds:
> > 
> > opreport --global-percent:
> >    158838 62.5346 libvdr-softdevice.so.1.3.37
> > opreport -l libvdr-softdevice.so.1.3.37:
> > 10479     6.5973  yv12_to_yuy2()
> > 
> > After the modification (black video surface) for 23 seconds:
> > 
> > opreport --global-percent:
> >    171060 62.4015 libvdr-softdevice.so.1.3.37
> > opreport -l libvdr-softdevice.so.1.3.37:
> > 7080      4.1389  yv12_to_yuy2()
> > 
> > On my system, the improvement is only 4.1389/6.5973 - 1 = -37%.
> > 
> 
> That's not that much. Did you try the opposite test, just commenting the
> memory read movq/movd instructions to see if there is also a speedup?

I just did:

   171866 62.6012 libvdr-softdevice.so.1.3.37
3295      1.9172  yv12_to_yuy2()

So, it looks like my original analysis was correct: the memory-to-register
moves are the bottleneck on my system.  I'd try unrolling the loop a few
times and perhaps adding prefetch instructions.  However, I have very little
idea how MMX instructions are scheduled and executed inside the processor
and how the prefetch mechanism really works.  Of course, this is the
opportunity to learn. :-)

Anyway, this would only save 3 or 4 percent of softdevice execution time.

Interestingly, this method is taking a lot of CPU:

21191    12.3300  cDFBVideoOut::SetParams()

Maybe it should not be called from cDFBVideoOut::YUV(), or maybe the
method should be split, so that only those things that are absolutely
necessary to update in cDFBVideoOut::YUV() are updated.

	Marko


From M.Wache at gmx.net  Tue Jan 17 23:00:39 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 17 Jan 2006 23:00:39 +0100
Subject: [Softdevice-devel] Apparent cache misses in yv12_to_yuy2()
In-Reply-To: <20060117213459.GC3460@localhost.localdomain>
References: <20060112212117.GB3487@localhost.localdomain> <20060112214734.GC3487@localhost.localdomain> <43CC0620.1040107@gmx.net> <20060117205333.GA3460@localhost.localdomain> <20060117213459.GC3460@localhost.localdomain>
Message-ID: <43CD6907.8020902@gmx.net>

Marko M?kel? schrieb:
> On Tue, Jan 17, 2006 at 10:53:33PM +0200, Marko M?kel? wrote:
>> Maybe this could be done stride by stride, i.e., output to a main
>> memory block (of a few kilobytes) inside the loop on j, and fast_memcpy()
>> it to the surface memory after the loop?
> 
> I tried this.
> 
> Before patching, viewing live video for 20 seconds:
>    173680 65.2199 libvdr-softdevice.so.1.3.37
> 10131     5.8331  yv12_to_yuy2()
> 
> After original patch, viewing for 20 seconds:
>    173900 65.2068 libvdr-softdevice.so.1.3.37
> 8391      4.8252  yv12_to_yuy2()
> 
> It seems a significant improvement in yv12_to_yuy2(), almost 16%
> ((8391/20) / (10479/21)-1), but the something makes the total
> slower by 15% ((173900/20)/(158838/21)-1).
> 
Are you sure that the savings are not because the transfer register to
memory is now accounted to fast_memcpy()? I don't know oprofile that
well, but I think usually it doesn't report sum the time spent in called
functions.

Martin


From marko.makela at hut.fi  Tue Jan 17 23:13:23 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 18 Jan 2006 00:13:23 +0200
Subject: [Softdevice-devel] Apparent cache misses in yv12_to_yuy2()
In-Reply-To: <43CD6907.8020902@gmx.net>
References: <20060112212117.GB3487@localhost.localdomain> <20060112214734.GC3487@localhost.localdomain> <43CC0620.1040107@gmx.net> <20060117205333.GA3460@localhost.localdomain> <20060117213459.GC3460@localhost.localdomain> <43CD6907.8020902@gmx.net>
Message-ID: <20060117221323.GE3460@localhost.localdomain>

On Tue, Jan 17, 2006 at 11:00:39PM +0100, Martin Wache wrote:
> Are you sure that the savings are not because the transfer register to
> memory is now accounted to fast_memcpy()? I don't know oprofile that
> well, but I think usually it doesn't report sum the time spent in called
> functions.

Good point.  I should have watched fast_memcpy() as well, or at least
made sure that it is inlined in yv12_to_yuy2().

It looks even more so that copying the data stride by stride via a
small main memory buffer will not gain anything.

Do you think that the SetParams() call in cDFBVideoOut::YUV()
could be made any faster?

	Marko


From M.Wache at gmx.net  Tue Jan 17 23:17:09 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 17 Jan 2006 23:17:09 +0100
Subject: [Softdevice-devel] Apparent cache misses in yv12_to_yuy2()
In-Reply-To: <20060117214725.GD3460@localhost.localdomain>
References: <20060112212117.GB3487@localhost.localdomain> <20060112214734.GC3487@localhost.localdomain> <43CC0620.1040107@gmx.net> <20060117205333.GA3460@localhost.localdomain> <43CD5FEB.5000909@gmx.net> <20060117214725.GD3460@localhost.localdomain>
Message-ID: <43CD6CE5.5050501@gmx.net>

Marko M?kel? schrieb:
> I just did:
> 
>    171866 62.6012 libvdr-softdevice.so.1.3.37
> 3295      1.9172  yv12_to_yuy2()
> 
> So, it looks like my original analysis was correct: the memory-to-register
> moves are the bottleneck on my system.  I'd try unrolling the loop a few
> times and perhaps adding prefetch instructions.  However, I have very little
> idea how MMX instructions are scheduled and executed inside the processor
> and how the prefetch mechanism really works.  Of course, this is the
> opportunity to learn. :-)
> 
If you want you can try the attached patch, it is optimized with the
register-to-memory movds commented. I wonder why these moves are so slow
on my system and not on yours...


> Anyway, this would only save 3 or 4 percent of softdevice execution time.
> 
> Interestingly, this method is taking a lot of CPU:
> 
> 21191    12.3300  cDFBVideoOut::SetParams()
> 
> Maybe it should not be called from cDFBVideoOut::YUV(), or maybe the
> method should be split, so that only those things that are absolutely
> necessary to update in cDFBVideoOut::YUV() are updated.

As far as I can tell it is necessary to call it from YUV so that format
changes are detected. I guess Stefan nows much better if this method can
be optimized :-)

Martin
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: fast_yv12_to_yuv2.patch
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060117/dd6d6014/attachment.ksh>

From voitto.tuomainen at luukku.com  Wed Jan 18 08:40:08 2006
From: voitto.tuomainen at luukku.com (Voitto Tuomainen)
Date: Wed, 18 Jan 2006 09:40:08 +0200 (EET)
Subject: [Softdevice-devel] Softplay shows dvb subtitles from tv
 broadcast
Message-ID: <1137570008773.voitto.tuomainen.10552.bJrphZEov1V4tVLYpLKdfQ@luukku.com>

Martin Wache kirjoitti 17.01.2006 kello 19:01:
> Voitto Tuomainen schrieb:
> > Hi,
> > I've noticed couple days back, when trying softplay, that it shows dvb
> subtitles, 
> > if they are shown in tv broadcast.
> > 
> > Is there anything other to do, than change tv-channel to such, which does
> not have them?
> > 
> 
> Hmm, I was not aware that softplay shows dvb subtitles. What are you
> exactly doing? Are you watching a recorded PES stream (like the vdr
> recordings)? Are you sure that the subtitles are not already encoded in
> the video? I guess you are, I just want to be shure...
> 
At first I started vdr with subtitles and softplay plugin to finnish yle-1 channel, which had english program. Those kind  of programs shows dvb subtitles.

During that I started from menu softplay, and started to play starwrek (avi). Yles subtitles are shown in play (starwrek is spoken in finnish). I even noticed the same, when I stopped avi play and started to play wav coded music.


> I know that ffmpeg can decode dvb subtitles, but I thought one has to do
> something to get it decoded - and I certainly didn't do anything.
> I will have a look at it.
> 
> Bye,
> Martin

______
BR, Voitto

...................................................................
Luukku Plus paketilla p??set eroon tila- ja turvallisuusongelmista.
Hanki Luukku Plus ja helpotat el?m??si. http://www.mtv3.fi/luukku



From voitto.tuomainen at luukku.com  Wed Jan 18 08:42:26 2006
From: voitto.tuomainen at luukku.com (Voitto Tuomainen)
Date: Wed, 18 Jan 2006 09:42:26 +0200 (EET)
Subject: [Softdevice-devel] Softplay shows dvb subtitles from tv
 broadcast
Message-ID: <1137570146215.voitto.tuomainen.10788.kmkIQqMUyI4N0ee7sSC1og@luukku.com>

Hi,
I was using 1.3.38.
______
Voitto

Marko M?kel? kirjoitti 17.01.2006 kello 22:56:
> On Tue, Jan 17, 2006 at 06:01:19PM +0100, Martin Wache wrote:
> > Voitto Tuomainen schrieb:
> > > Hi,
> > > I've noticed couple days back, when trying softplay, that it shows dvb
> subtitles, 
> > > if they are shown in tv broadcast.
> > > 
> > > Is there anything other to do, than change tv-channel to such, which
> does not have them?
> > > 
> > 
> > Hmm, I was not aware that softplay shows dvb subtitles. What are you
> > exactly doing? Are you watching a recorded PES stream (like the vdr
> > recordings)? Are you sure that the subtitles are not already encoded in
> > the video? I guess you are, I just want to be shure...
> 
> Are you by any chance using vdr 1.3.38 or 1.3.39 with the subtitles
> plugin?  If yes, you may see DVB subtitles from live broadcast while
> watching recordings.  I don't know if anyone has fixed it yet.  At least
> I haven't seen any announcement on the vdr mailing list.  That's why
> I have reverted to vdr-1.3.37.
> 
> 	Marko
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/softdevice-devel

______
BR, Voitto

...................................................................
Luukku Plus paketilla p??set eroon tila- ja turvallisuusongelmista.
Hanki Luukku Plus ja helpotat el?m??si. http://www.mtv3.fi/luukku



From marko.makela at hut.fi  Wed Jan 18 10:02:10 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 18 Jan 2006 11:02:10 +0200
Subject: [Softdevice-devel] Softplay shows dvb subtitles from tv broadcast
In-Reply-To: <1137570146215.voitto.tuomainen.10788.kmkIQqMUyI4N0ee7sSC1og@luukku.com>
References: <1137570146215.voitto.tuomainen.10788.kmkIQqMUyI4N0ee7sSC1og@luukku.com>
Message-ID: <20060118090210.GA23466@localhost.localdomain>

On Wed, Jan 18, 2006 at 09:42:26AM +0200, Voitto Tuomainen wrote:
> Hi,
> I was using 1.3.38.

Okay, so it was not a bug in softdevice or softplay, but the
patch distributed with the vdr-subtitles plugin needs to be adapted
for vdr 1.3.38.

	Marko


From marko.makela at hut.fi  Wed Jan 18 10:16:47 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 18 Jan 2006 11:16:47 +0200
Subject: [Softdevice-devel] Apparent cache misses in yv12_to_yuy2()
In-Reply-To: <43CD6CE5.5050501@gmx.net>
References: <20060112212117.GB3487@localhost.localdomain> <20060112214734.GC3487@localhost.localdomain> <43CC0620.1040107@gmx.net> <20060117205333.GA3460@localhost.localdomain> <43CD5FEB.5000909@gmx.net> <20060117214725.GD3460@localhost.localdomain> <43CD6CE5.5050501@gmx.net>
Message-ID: <20060118091647.GB23466@localhost.localdomain>

On Tue, Jan 17, 2006 at 11:17:09PM +0100, Martin Wache wrote:
> > Maybe it should not be called from cDFBVideoOut::YUV(), or maybe the
> > method should be split, so that only those things that are absolutely
> > necessary to update in cDFBVideoOut::YUV() are updated.
> 
> As far as I can tell it is necessary to call it from YUV so that format
> changes are detected. I guess Stefan nows much better if this method can
> be optimized :-)

Would it be possible to cache the current format in a variable and only
do the time-consuming stuff when the format actually changes?

I tried your patch quickly.  top still reports 60 to 70 percent CPU usage.
I'll make OProfile measurements later.

	Marko


From marko.makela at hut.fi  Wed Jan 18 21:29:41 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 18 Jan 2006 22:29:41 +0200
Subject: [Softdevice-devel] cDFBVideoOut::SetParams() wastes 20% of CPU on -vo dfb:mgatv
In-Reply-To: <20060118091647.GB23466@localhost.localdomain>
References: <20060112212117.GB3487@localhost.localdomain> <20060112214734.GC3487@localhost.localdomain> <43CC0620.1040107@gmx.net> <20060117205333.GA3460@localhost.localdomain> <43CD5FEB.5000909@gmx.net> <20060117214725.GD3460@localhost.localdomain> <43CD6CE5.5050501@gmx.net> <20060118091647.GB23466@localhost.localdomain>
Message-ID: <20060118202941.GC3474@localhost.localdomain>

On Wed, Jan 18, 2006 at 11:16:47AM +0200, Marko M?kel? wrote:
> I tried your patch quickly.  top still reports 60 to 70 percent CPU usage.
> I'll make OProfile measurements later.

Oh, I just noticed that last night, I was measuring DATA_MEM_REFS instead
of CPU_CLK_UNHALTED.  That's pretty useless, since the count will include
all memory references, no matter if they are cached or not.  So, please
disregard all my measurements from yesterday.

Here are some new measurements of
opcontrol --event=CPU_CLK_UNHALTED:9000:0:1:1,
each viewing 20 seconds of live video:

Unmodified softdevice from CVS a couple of days ago:
   104091 65.9275 libvdr-softdevice.so.1.3.37
23835    22.8982  yv12_to_yuy2()
23079    22.1719  cDFBVideoOut::SetParams()
[top shows around 65..76% of CPU usage for the vdr process]

Commenting out the SetParams() call in cDFBVideoOut::YUV():
    81825 62.9496 libvdr-softdevice.so.1.3.37
23904    29.2136  yv12_to_yuy2()
[no samples logged for cDFBVideoOut::SetParams()]
[top shows around 45..56% of CPU usage for the vdr process]

So, getting rid of the unnecessary SetParams() calls will save about 20%
of the CPU time.  I also (accidentally) measured DATA_MEM_REFS, and there the
savings were about 14%.  That might explain why I see 20% savings in top
instead of 29%*63% = 18%.  This is a huge difference!

Your patch:
   101188 66.3880 libvdr-softdevice.so.1.3.37
23224    22.9513  yv12_to_yuy2()
23019    22.7487  cDFBVideoOut::SetParams()

Your patch, commented out SetParams():
    76838 62.0567 libvdr-softdevice.so.1.3.37
23489    30.5695  yv12_to_yuy2()

If you compare the figures to the ones above (without your patch), there
is no significant difference.  To get more accuracy, the measurements should
be run for several minutes while playing exactly the same frames of a
recording.  But I don't think that saving 1 or 2 percent of execution time
on one particular processor would justify the change, if there is a
possibility that the new code will perform worse on other systems.

Bottom line: Please eliminate unnecessary SetParams() calls or unnecessary
code paths within cDFBVideoOut::SetParams() when it is invoked from
cDFBVideoOut::YUV().  This still won't get completely rid of audio chopping
on my system, but it's almost gone, even when quickly browsing the EPG or
the Recordings menus.

	Marko


From marko.makela at hut.fi  Wed Jan 18 22:12:56 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 18 Jan 2006 23:12:56 +0200
Subject: [Softdevice-devel] 100000% speed-up for cDFBVideoOut::SetParams()
In-Reply-To: <20060118202941.GC3474@localhost.localdomain>
References: <20060112212117.GB3487@localhost.localdomain> <20060112214734.GC3487@localhost.localdomain> <43CC0620.1040107@gmx.net> <20060117205333.GA3460@localhost.localdomain> <43CD5FEB.5000909@gmx.net> <20060117214725.GD3460@localhost.localdomain> <43CD6CE5.5050501@gmx.net> <20060118091647.GB23466@localhost.localdomain> <20060118202941.GC3474@localhost.localdomain>
Message-ID: <20060118211256.GE3474@localhost.localdomain>

On Wed, Jan 18, 2006 at 10:29:41PM +0200, Marko M?kel? wrote:
> So, getting rid of the unnecessary SetParams() calls will save about 20%
> of the CPU time.

I had a look at the machine instruction level.

opannotate --source -t 22 .../libvdr-softdevice.so.1.3.37
indicates the clearing loop as the culprit, accounting for almost
all of the logged 22813 samples:

    30  0.0309 :            for(i = 0; i < vidDsc.height; ++i, dst += pitch/4)
 22561 23.2532 :              for (j = 0; j < vidDsc.width / 2; ++j)
   191  0.1969 :                dst [j] = 0x80008000;

Could this loop be removed in most cases?  Is it really necessary to
clear the surface, as it will be overwritten with video frames?  Perhaps
the SetParams() method should take a parameter "bool clearSurface"
that cDFBVideoOut::YUV() would pass as false?

On a somewhat related note, when I suspend the MPEG2 stream from vdr,
the mgatv video overlay will not be blanked, no matter if the SetParams()
call or the above clearing loop is disabled or not.  How could this be fixed?
The screen at least used to turn black on DirectFB VGA output.

The attached patch speeds up cDFBVideoOut::SetParams() by a factor of
one thousand (1,000), from 22,813 to 23 collected samples.

	Marko
-------------- next part --------------
Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.45
diff -p -u -r1.45 video-dfb.c
--- video-dfb.c	10 Jan 2006 19:40:25 -0000	1.45
+++ video-dfb.c	18 Jan 2006 21:10:06 -0000
@@ -940,6 +940,7 @@ void cDFBVideoOut::SetParams()
           }
 
           videoSurface=dfb->CreateSurface(vidDsc);
+#if 0
           /* --------------------------------------------------------------------
            * Here is probably a bug in DirectFB, as Clear() does _not_ work
            * the same, as manual wipe out YUY2 surface. I tried Clear() on my
@@ -959,6 +960,7 @@ void cDFBVideoOut::SetParams()
                 dst [j] = 0x80008000;
             videoSurface->Unlock();
           }
+#endif
         }
         catch (DFBException *ex)
         {

From mvdbeek at gmx.de  Wed Jan 18 19:03:24 2006
From: mvdbeek at gmx.de (Marius van den Beek)
Date: Wed, 18 Jan 2006 19:03:24 +0100
Subject: [Softdevice-devel] -vo shm: Problems with hue and osd
Message-ID: <43CE82EC.70403@gmx.de>

Hi

I've tried the new method, it's exactly what I was looking for to replace
vdr-xine, but I can only do software osd and I'm unable to adjust  Hue
from the setup-menu. When adjusting via the nvidia-tool (or with -vo 
xv:) it works fine.
Thanks in advance

Marius


From stefan at lucke.in-berlin.de  Thu Jan 19 09:50:09 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 19 Jan 2006 09:50:09 +0100
Subject: [Softdevice-devel] 100000% speed-up for cDFBVideoOut::SetParams()
In-Reply-To: <20060118211256.GE3474@localhost.localdomain>
References: <20060112212117.GB3487@localhost.localdomain> <20060112214734.GC3487@localhost.localdomain> <43CC0620.1040107@gmx.net> <20060117205333.GA3460@localhost.localdomain> <43CD5FEB.5000909@gmx.net> <20060117214725.GD3460@localhost.localdomain> <43CD6CE5.5050501@gmx.net> <20060118091647.GB23466@localhost.localdomain> <20060118202941.GC3474@localhost.localdomain> <20060118211256.GE3474@localhost.localdomain>
Message-ID: <1137660609.43cf52c158eb8@webmail.in-berlin.de>

Quoting Marko M?kel? <marko.makela at hut.fi>:

> On Wed, Jan 18, 2006 at 10:29:41PM +0200, Marko M?kel? wrote:
> > So, getting rid of the unnecessary SetParams() calls will save about 20%
> > of the CPU time.
>
> I had a look at the machine instruction level.
>
> opannotate --source -t 22 .../libvdr-softdevice.so.1.3.37
> indicates the clearing loop as the culprit, accounting for almost
> all of the logged 22813 samples:
>
>     30  0.0309 :            for(i = 0; i < vidDsc.height; ++i, dst += pitch/4)
>  22561 23.2532 :              for (j = 0; j < vidDsc.width / 2; ++j)
>    191  0.1969 :                dst [j] = 0x80008000;
>
> Could this loop be removed in most cases?  Is it really necessary to
> clear the surface, as it will be overwritten with video frames?  Perhaps
> the SetParams() method should take a parameter "bool clearSurface"
> that cDFBVideoOut::YUV() would pass as false?

The problem in this case is not SetParms() beeing called, and not this
loop. The problem is: Why does SetParms() think there must be taken some
action (for each frame). SetParms() is for reallocation our drawing
surface in case some parameters changed.

Action taken are protected by:

  if (videoLayer || useStretchBlit)
  {
    if ( ! videoSurface || aspect_changed ||
        currentPixelFormat != setupStore->pixelFormat ||
        cutTop != setupStore->cropTopLines ||
        cutBottom != setupStore->cropBottomLines ||
        cutLeft != setupStore->cropLeftCols ||
        cutRight != setupStore->cropRightCols ||
        useStretchBlit != setupStore->useStretchBlit )
    {

If these expressions evaluate to true for every frame than you'll
get your measured values (I guess).

Do you build sofdevice with subplugins or as a single lib ?

>
> On a somewhat related note, when I suspend the MPEG2 stream from vdr,
> the mgatv video overlay will not be blanked, no matter if the SetParams()
> call or the above clearing loop is disabled or not.  How could this be fixed?
> The screen at least used to turn black on DirectFB VGA output.
>
> The attached patch speeds up cDFBVideoOut::SetParams() by a factor of
> one thousand (1,000), from 22,813 to 23 collected samples.
>
> 	Marko
>




From marko.makela at hut.fi  Thu Jan 19 11:41:27 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 19 Jan 2006 12:41:27 +0200
Subject: [Softdevice-devel] 100000% speed-up for cDFBVideoOut::SetParams()
In-Reply-To: <1137660609.43cf52c158eb8@webmail.in-berlin.de>
References: <20060112214734.GC3487@localhost.localdomain> <43CC0620.1040107@gmx.net> <20060117205333.GA3460@localhost.localdomain> <43CD5FEB.5000909@gmx.net> <20060117214725.GD3460@localhost.localdomain> <43CD6CE5.5050501@gmx.net> <20060118091647.GB23466@localhost.localdomain> <20060118202941.GC3474@localhost.localdomain> <20060118211256.GE3474@localhost.localdomain> <1137660609.43cf52c158eb8@webmail.in-berlin.de>
Message-ID: <20060119104127.GA4191@localhost.localdomain>

On Thu, Jan 19, 2006 at 09:50:09AM +0100, Stefan Lucke wrote:
> The problem in this case is not SetParms() beeing called, and not this
> loop. The problem is: Why does SetParms() think there must be taken some
> action (for each frame). SetParms() is for reallocation our drawing
> surface in case some parameters changed.

Okay, the constant reallocation of the drawing surface would also explain
why libdirectfb-matrox.so (or something like that) took about 10 percent
of all CPU cycles.  (This is from memory; I can't test until this evening.)

> Action taken are protected by:
> 
>   if (videoLayer || useStretchBlit)
>   {
>     if ( ! videoSurface || aspect_changed ||
>         currentPixelFormat != setupStore->pixelFormat ||
>         cutTop != setupStore->cropTopLines ||
>         cutBottom != setupStore->cropBottomLines ||
>         cutLeft != setupStore->cropLeftCols ||
>         cutRight != setupStore->cropRightCols ||
>         useStretchBlit != setupStore->useStretchBlit )
>     {
> 
> If these expressions evaluate to true for every frame than you'll
> get your measured values (I guess).

Yep, I agree that the conditions probably hold for every frame.  I'll
add debug printout to find out which condition is the culprit.  I
suspect pixelFormat or useStretchBlit, i.e., maybe when they are
automatically overridden by softdevice, they will not be stored properly.

> Do you build sofdevice with subplugins or as a single lib ?

As a single library, unless the configure script has overridden my
preference.  At least I didn't notice anything else softdevice-related in
PLUGINS/lib than libvdr-softdevice.so.1.3.*.

	Marko


From marko.makela at hut.fi  Thu Jan 19 16:36:30 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 19 Jan 2006 17:36:30 +0200
Subject: [Softdevice-devel] 100000% speed-up for cDFBVideoOut::SetParams()
In-Reply-To: <1137660609.43cf52c158eb8@webmail.in-berlin.de>
References: <20060112214734.GC3487@localhost.localdomain> <43CC0620.1040107@gmx.net> <20060117205333.GA3460@localhost.localdomain> <43CD5FEB.5000909@gmx.net> <20060117214725.GD3460@localhost.localdomain> <43CD6CE5.5050501@gmx.net> <20060118091647.GB23466@localhost.localdomain> <20060118202941.GC3474@localhost.localdomain> <20060118211256.GE3474@localhost.localdomain> <1137660609.43cf52c158eb8@webmail.in-berlin.de>
Message-ID: <20060119153630.GB6778@localhost.localdomain>

On Thu, Jan 19, 2006 at 09:50:09AM +0100, Stefan Lucke wrote:
> The problem in this case is not SetParms() beeing called, and not this
> loop. The problem is: Why does SetParms() think there must be taken some
> action (for each frame). SetParms() is for reallocation our drawing
> surface in case some parameters changed.

Okay, I see it now.  The clearing is needed, among others, when CropMode
changes.

> Action taken are protected by:
> 
>   if (videoLayer || useStretchBlit)
>   {
>     if ( ! videoSurface || aspect_changed ||
>         currentPixelFormat != setupStore->pixelFormat ||
>         cutTop != setupStore->cropTopLines ||
>         cutBottom != setupStore->cropBottomLines ||
>         cutLeft != setupStore->cropLeftCols ||
>         cutRight != setupStore->cropRightCols ||
>         useStretchBlit != setupStore->useStretchBlit )
>     {

BTW, I think it would be a little easier to read the code if the
method made use of an explicit return statement if the conditions
do not hold in the beginning.  In that way, the rest of the method
would not have to be indented by multiple levels.

> If these expressions evaluate to true for every frame than you'll
> get your measured values (I guess).

Yep, every frame.  You forgot to reset aspect_changed.  See the
attached patch.

Here's an excerpt of opreport --global-percent after viewing live video
for 20 seconds and capturing CPU_CLK_UNHALTED:90000.  I manually filtered
all libraries that seemed to have something to do with DirectFB:

    86543 65.7447 libvdr-softdevice.so.1.3.37
    12926  9.8196 libdirectfb_matrox.so
      286  0.2173 libdirectfb-0.9.so.25.0.0
       42  0.0319 libdfb++-0.9.so.25.0.0
       32  0.0243 libfusion-0.9.so.25.0.0
        8  0.0061 libdirectfb_fbdev.so

Before this patch:

   105215 67.6089 libvdr-softdevice.so.1.3.37
    16144 10.3738 libdirectfb_matrox.so
      495  0.3181 libdirectfb-0.9.so.25.0.0
      130  0.0835 libdfb++-0.9.so.25.0.0
      105  0.0675 libfusion-0.9.so.25.0.0
        9  0.0058 libdirect-0.9.so.25.0.0
        8  0.0051 libdirectfb_fbdev.so

So, getting rid of the surface reallocations has a little effect on
DirectFB as well.

	Marko
-------------- next part --------------
Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.45
diff -p -u -r1.45 video-dfb.c
--- video-dfb.c	10 Jan 2006 19:40:25 -0000	1.45
+++ video-dfb.c	19 Jan 2006 15:27:31 -0000
@@ -677,6 +677,7 @@ void cDFBVideoOut::SetParams()
         cutRight != setupStore->cropRightCols ||
         useStretchBlit != setupStore->useStretchBlit )
     {
+      aspect_changed = 0;
 
       cutTop    = setupStore->cropTopLines;
       cutBottom = setupStore->cropBottomLines;

From marko.makela at hut.fi  Thu Jan 19 17:25:15 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 19 Jan 2006 18:25:15 +0200
Subject: [Softdevice-devel] Comparing mgatv, vga(yuy2) and vga(i420)
Message-ID: <20060119162515.GC6778@localhost.localdomain>

Out of interest, I profiled -vo dfb:mgatv and DirectFB VGA output on
PixelFormat 0 and 2 (I420 and YUY2, I believe).

The performance of dfb:mgatv was very close to that of VGA on YUY2.
There were very few differences in the order of functions or the
relative percentages displayed by "opreport -l libvga-softdevice".
Here's the big picture (opreport --global-percent):

mgatv:
    91145 66.7216 libvdr-softdevice.so.1.3.37
    13114  9.5999 vmlinux
    12955  9.4835 libdirectfb_matrox.so
     5028  3.6807 oprofiled
     4397  3.2188 vdr
     4083  2.9889 libc-2.3.5.so

VGA(YUY2):
    91743 65.2103 libvdr-softdevice.so.1.3.37
    15048 10.6960 libdirectfb_matrox.so
    13762  9.7819 vmlinux
     5212  3.7047 oprofiled
     4635  3.2945 vdr
     4166  2.9612 libc-2.3.5.so

As expected, VGA(I420) was a little faster.  However, here we see an
increase in libc processor usage:

    71276 58.0925 libvdr-softdevice.so.1.3.37
    23271 18.9667 vmlinux
    13273 10.8180 libc-2.3.5.so
     5016  4.0882 vdr
     4296  3.5014 oprofiled
...
       42  0.0342 libdirectfb_matrox.so

Any idea why there are so many samples in libc?  /lib/tls/libc-2.3.5.so
lacks debugging symbols.  I guess I'll have to get a debug build of libc.

For libdirectfb_matrox.so, the answer is here:

samples  %        symbol name
14977    99.5282  matroxEngineSync

Any ideas why this is called on YUY2 but not on I420?

	Marko


From M.Wache at gmx.net  Thu Jan 19 18:00:58 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 19 Jan 2006 18:00:58 +0100
Subject: [Softdevice-devel] 100000% speed-up for cDFBVideoOut::SetParams()
In-Reply-To: <20060119153630.GB6778@localhost.localdomain>
References: <20060112214734.GC3487@localhost.localdomain> <43CC0620.1040107@gmx.net> <20060117205333.GA3460@localhost.localdomain> <43CD5FEB.5000909@gmx.net> <20060117214725.GD3460@localhost.localdomain> <43CD6CE5.5050501@gmx.net> <20060118091647.GB23466@localhost.localdomain> <20060118202941.GC3474@localhost.localdomain> <20060118211256.GE3474@localhost.localdomain> <1137660609.43cf52c158eb8@webmail.in-berlin.de> <20060119153630.GB6778@localhost.localdomain>
Message-ID: <43CFC5CA.6090403@gmx.net>

Marko M?kel? schrieb:
> On Thu, Jan 19, 2006 at 09:50:09AM +0100, Stefan Lucke wrote:
>> The problem in this case is not SetParms() beeing called, and not this
>> loop. The problem is: Why does SetParms() think there must be taken some
>> action (for each frame). SetParms() is for reallocation our drawing
>> surface in case some parameters changed.
> 
> Okay, I see it now.  The clearing is needed, among others, when CropMode
> changes.
> 
>> Action taken are protected by:
>>
>>   if (videoLayer || useStretchBlit)
>>   {
>>     if ( ! videoSurface || aspect_changed ||
>>         currentPixelFormat != setupStore->pixelFormat ||
>>         cutTop != setupStore->cropTopLines ||
>>         cutBottom != setupStore->cropBottomLines ||
>>         cutLeft != setupStore->cropLeftCols ||
>>         cutRight != setupStore->cropRightCols ||
>>         useStretchBlit != setupStore->useStretchBlit )
>>     {
> 
> BTW, I think it would be a little easier to read the code if the
> method made use of an explicit return statement if the conditions
> do not hold in the beginning.  In that way, the rest of the method
> would not have to be indented by multiple levels.
> 
>> If these expressions evaluate to true for every frame than you'll
>> get your measured values (I guess).
> 
> Yep, every frame.  You forgot to reset aspect_changed.  See the
> attached patch.
> 
Probably that is my fault. I changed the behavior of CheckAspect() in
video.c because of the new video-shm. Urg, global variables - on small
innocent looking change and they'll hit you at places you never expected...

I'll try to fix this.

Martin


From M.Wache at gmx.net  Thu Jan 19 18:07:12 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 19 Jan 2006 18:07:12 +0100
Subject: [Softdevice-devel] -vo shm: Problems with hue and osd
In-Reply-To: <43CE82EC.70403@gmx.de>
References: <43CE82EC.70403@gmx.de>
Message-ID: <43CFC740.7080603@gmx.net>

Marius van den Beek schrieb:
> Hi
> 
> I've tried the new method, it's exactly what I was looking for to replace
> vdr-xine, but I can only do software osd and I'm unable to adjust  Hue
> from the setup-menu. When adjusting via the nvidia-tool (or with -vo
> xv:) it works fine.

Nice to hear that someone else is interested in this feature too :-)

And yes, these are currently missing features, sorry I forgot to mention
them. Currently there is just no additional OSD layer and the client has
no access to the setupStore ( the place where Hue and the other settings
are stored) so the client doesn't know about any changes in the setup.

Bye,

Martin


From marko.makela at hut.fi  Fri Jan 20 00:28:40 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 20 Jan 2006 01:28:40 +0200
Subject: [Softdevice-devel] Save 10% CPU by sleeping before IDirectFBSurface::Flip()
In-Reply-To: <20060119162515.GC6778@localhost.localdomain>
References: <20060119162515.GC6778@localhost.localdomain>
Message-ID: <20060119232840.GA3475@localhost.localdomain>

On Thu, Jan 19, 2006 at 06:25:15PM +0200, Marko M?kel? wrote:
> As expected, VGA(I420) was a little faster.  However, here we see an
> increase in libc processor usage:
> 
>     71276 58.0925 libvdr-softdevice.so.1.3.37
>     23271 18.9667 vmlinux
>     13273 10.8180 libc-2.3.5.so
>      5016  4.0882 vdr
>      4296  3.5014 oprofiled
> ...
>        42  0.0342 libdirectfb_matrox.so
> 
> Any idea why there are so many samples in libc?  /lib/tls/libc-2.3.5.so
> lacks debugging symbols.  I guess I'll have to get a debug build of libc.

I installed the Debian package libc6-dbg and set
LD_LIBRARY_PATH=/usr/lib/debug for the vdr process, but could not
reproduce this.  I was unable to reproduce this even with the default
libc6.  The CPU usage of libc was only about 4 percent.

> samples  %        symbol name
> 14977    99.5282  matroxEngineSync
> 
> Any ideas why this is called on YUY2 but not on I420?

First, this appeared to come from the OSD menu.  When viewing a program
that has subtitles, there will be much OSD activity, like this:

#0  0xb41a0d03 in matroxEngineSync ()
   from /usr/local/lib/directfb-0.9.25/gfxdrivers/libdirectfb_matrox.so
#1  0xb781f6d2 in dfb_gfxcard_sync () from /usr/local/lib/libdirectfb-0.9.so.25
#2  0xb6f6bc51 in primaryFlipRegion ()
   from /usr/local/lib/directfb-0.9.25/systems/libdirectfb_fbdev.so
#3  0xb7829076 in dfb_layer_region_flip_update ()
   from /usr/local/lib/libdirectfb-0.9.so.25
#4  0xb77fe61f in IDirectFBSurface_Layer_Flip ()
   from /usr/local/lib/libdirectfb-0.9.so.25
#5  0xb7848da9 in IDirectFBSurface::Flip ()
   from /usr/local/lib/libdfb++-0.9.so.25
#6  0xb798d493 in cDFBVideoOut::CloseOSD (this=0xb6e02d68) at video-dfb.c:1198
#7  0xb7987887 in ~cSoftOsd (this=0xb6e56188) at SoftOsd.c:66
#8  0xb77cbe44 in SubtitlesViewer::Clear (this=0xb6e19bf0) at viewer.c:76
#9  0xb77cc2cd in SubtitlesViewer::SetPage (this=0xb6e19bf0, page=0xb6e06170)
    at viewer.c:97
#10 0xb77ca6df in cSubtitlesReceiver::Action (this=0xb6e19ab0)
    at receiver.c:112
#11 0x080f6772 in cThread::StartThread (Thread=0xb6e19bc4) at thread.c:235
#12 0xb7fabcfd in start_thread () from /lib/tls/libpthread.so.0
#13 0xb7e2d13e in clone () from /lib/tls/libc.so.6

I just switched to a channel that does not display DVB subtitles to see
if the culprit really is the OSD, which would be displayed and hidden
every few seconds when viewing subtitles.  There was not much difference,
as cDFBVideoOut::YUV() is constantly invoking Flip().

I see that there is an option for triple buffering, but apparently only
for VGA.  Would it be possible to enable it for mgatv?  Could
matroxEngineSync() yield the CPU to another thread?  (Is the stream being
decoded in another thread?)  In DirectFB 0.9.23, which I'm using, it's
just burning CPU:

               :    2d30:       lea    0x1(%edx),%eax
               :    2d33:       mov    %eax,0x1c(%esi)
     1  0.0075 :    2d36:       mov    %eax,%edx
               :    2d38:       mov    0x1e14(%edi),%eax
 13280 99.0971 :    2d3e:       and    $0x30000,%eax
     1  0.0075 :    2d43:       cmp    %eax,%ecx
               :    2d45:       jne    2d30 <matroxEngineSync+0x30>

Here's the corresponding source code from gfxdrivers/matrox/mmio.h,
mga_waitidle():

     while ((mga_in32(mdrv->mmio_base, STATUS) & (DWGENGSTS | ENDPRDMASTS)) !=
             mdev->idle_status) {
          mdev->idle_waitcycles++;
     }

I updated DirectFB and DFB++ to CVS HEAD (this code hasn't changed there)
and tried if caching the mmio_base and idle_status in registers and
removing the idle_waitcycles counter makes any difference.  No:

               :    2d10:       mov    (%edx),%eax
 13413 99.2820 :    2d12:       and    $0x30000,%eax
     1  0.0074 :    2d17:       cmp    %eax,%ecx
               :    2d19:       jne    2d10 <matroxEngineSync+0x20>

This loop is wasting 10% of all non-idle CPU (about 5% of total CPU)
on my system when using the YUY2 output format.  Can't the chip generate
an interrupt when it becomes idle?

There do not appear to be any Flip() calls when using I420 VGA output.

Here is a work-around: Sleep between the StretchBlit() and Flip() calls:

diff -p -u -r1.45 video-dfb.c
--- video-dfb.c 10 Jan 2006 19:40:25 -0000      1.45
+++ video-dfb.c 19 Jan 2006 23:04:04 -0000
@@ -1396,6 +1397,7 @@ void cDFBVideoOut::YUV(uint8_t *Py, uint
 #endif

       }
+      usleep(2000);
       //scrSurface->Flip(NULL, (setupStore->useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
       scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);

A usleep(5000) reduced the CPU usage of libdirectfb_matrox.so from over
15000 to 83 samples.  usleep(1000) increased the number of samples
to 109, with 14 samples in matroxEngineSync().  usleep(2000) resulted in
70 samples in libdirectfb_matrox.so, with 7 in matroxEngineSync().  Of
course, I should have sampled longer than 20 seconds to get more accurate
values.

I don't know what the optimal parameter for the usleep might be.  I guess
it depends on the value of HZ (which can be 100, 250, or 1000) and the
video frame rate, as the granularity of usleep() is 1/HZ seconds.  For
a 25 Hz frame rate (like mgatv), a frame takes 40 milliseconds.  At
HZ=100 (on 2.4 kernels), the sleep granularity is 10 milliseconds, which
might be too tight.  On VGA, it is even worse.  I guess that to be on the
safe side, you should put usleep(1000) there.  It doesn't make so much
difference if libdirectfb_matrox.so takes 0.1% or 0.06% of the CPU, but
10% (without any sleep) is definitely too much.

Later, I might see if something similar can be done in
cDFBVideoOut::OpenOSD(), cDFBVideoOut::RefreshOSD(),
cDFBVideoOut::CloseOSD(), and cDFBVideoOut::ShowOSD().
Any busy-waiting in RefreshOSD() might explain why audio and video frames
are occasionally dropped while the menus are being browsed.

	Marko


From stefan at lucke.in-berlin.de  Fri Jan 20 08:54:41 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 20 Jan 2006 08:54:41 +0100
Subject: [Softdevice-devel] Save 10% CPU by sleeping before IDirectFBSurface::Flip()
In-Reply-To: <20060119232840.GA3475@localhost.localdomain>
References: <20060119162515.GC6778@localhost.localdomain> <20060119232840.GA3475@localhost.localdomain>
Message-ID: <1137743681.43d0974107f0c@webmail.in-berlin.de>

Quoting Marko M?kel? <marko.makela at hut.fi>:

> On Thu, Jan 19, 2006 at 06:25:15PM +0200, Marko M?kel? wrote:
> > As expected, VGA(I420) was a little faster.  However, here we see an
> > increase in libc processor usage:
> >
> >     71276 58.0925 libvdr-softdevice.so.1.3.37
> >     23271 18.9667 vmlinux
> >     13273 10.8180 libc-2.3.5.so
> >      5016  4.0882 vdr
> >      4296  3.5014 oprofiled
> > ...
> >        42  0.0342 libdirectfb_matrox.so
> >
> > Any idea why there are so many samples in libc?  /lib/tls/libc-2.3.5.so
> > lacks debugging symbols.  I guess I'll have to get a debug build of libc.
>
> I installed the Debian package libc6-dbg and set
> LD_LIBRARY_PATH=/usr/lib/debug for the vdr process, but could not
> reproduce this.  I was unable to reproduce this even with the default
> libc6.  The CPU usage of libc was only about 4 percent.
>
> > samples  %        symbol name
> > 14977    99.5282  matroxEngineSync
> >
> > Any ideas why this is called on YUY2 but not on I420?
>
> First, this appeared to come from the OSD menu.  When viewing a program
> that has subtitles, there will be much OSD activity, like this:
>
> #0  0xb41a0d03 in matroxEngineSync ()
>    from /usr/local/lib/directfb-0.9.25/gfxdrivers/libdirectfb_matrox.so
> #1  0xb781f6d2 in dfb_gfxcard_sync () from /usr/local/lib/libdirectfb-0.9.so.25
> #2  0xb6f6bc51 in primaryFlipRegion ()
>    from /usr/local/lib/directfb-0.9.25/systems/libdirectfb_fbdev.so
> #3  0xb7829076 in dfb_layer_region_flip_update ()
>    from /usr/local/lib/libdirectfb-0.9.so.25
> #4  0xb77fe61f in IDirectFBSurface_Layer_Flip ()
>    from /usr/local/lib/libdirectfb-0.9.so.25
> #5  0xb7848da9 in IDirectFBSurface::Flip ()
>    from /usr/local/lib/libdfb++-0.9.so.25
> #6  0xb798d493 in cDFBVideoOut::CloseOSD (this=0xb6e02d68) at video-dfb.c:1198
> #7  0xb7987887 in ~cSoftOsd (this=0xb6e56188) at SoftOsd.c:66
> #8  0xb77cbe44 in SubtitlesViewer::Clear (this=0xb6e19bf0) at viewer.c:76
> #9  0xb77cc2cd in SubtitlesViewer::SetPage (this=0xb6e19bf0, page=0xb6e06170)
>     at viewer.c:97
> #10 0xb77ca6df in cSubtitlesReceiver::Action (this=0xb6e19ab0)
>     at receiver.c:112
> #11 0x080f6772 in cThread::StartThread (Thread=0xb6e19bc4) at thread.c:235
> #12 0xb7fabcfd in start_thread () from /lib/tls/libpthread.so.0
> #13 0xb7e2d13e in clone () from /lib/tls/libc.so.6
>
> I just switched to a channel that does not display DVB subtitles to see
> if the culprit really is the OSD, which would be displayed and hidden
> every few seconds when viewing subtitles.  There was not much difference,
> as cDFBVideoOut::YUV() is constantly invoking Flip().
>
> I see that there is an option for triple buffering, but apparently only
> for VGA.  Would it be possible to enable it for mgatv?  Could
> matroxEngineSync() yield the CPU to another thread?  (Is the stream being
> decoded in another thread?)  In DirectFB 0.9.23, which I'm using, it's
> just burning CPU:
>
>                :    2d30:       lea    0x1(%edx),%eax
>                :    2d33:       mov    %eax,0x1c(%esi)
>      1  0.0075 :    2d36:       mov    %eax,%edx
>                :    2d38:       mov    0x1e14(%edi),%eax
>  13280 99.0971 :    2d3e:       and    $0x30000,%eax
>      1  0.0075 :    2d43:       cmp    %eax,%ecx
>                :    2d45:       jne    2d30 <matroxEngineSync+0x30>
>
> Here's the corresponding source code from gfxdrivers/matrox/mmio.h,
> mga_waitidle():
>
>      while ((mga_in32(mdrv->mmio_base, STATUS) & (DWGENGSTS | ENDPRDMASTS)) !=
>              mdev->idle_status) {
>           mdev->idle_waitcycles++;
>      }

There was a change posted by Ville on directfb-dev list in october.
Thread title:

Experimental matrox field parity/triple buffering improvement

http://mail.directfb.org/pipermail/directfb-dev/2005-October/000851.html


But I didn't tested this myself. Even feedback from others was low.

Perhaps I should do some tests.

>
> I updated DirectFB and DFB++ to CVS HEAD (this code hasn't changed there)
> and tried if caching the mmio_base and idle_status in registers and
> removing the idle_waitcycles counter makes any difference.  No:
>
>                :    2d10:       mov    (%edx),%eax
>  13413 99.2820 :    2d12:       and    $0x30000,%eax
>      1  0.0074 :    2d17:       cmp    %eax,%ecx
>                :    2d19:       jne    2d10 <matroxEngineSync+0x20>
>
> This loop is wasting 10% of all non-idle CPU (about 5% of total CPU)
> on my system when using the YUY2 output format.  Can't the chip generate
> an interrupt when it becomes idle?
>
> There do not appear to be any Flip() calls when using I420 VGA output.
>
> Here is a work-around: Sleep between the StretchBlit() and Flip() calls:
>
> diff -p -u -r1.45 video-dfb.c
> --- video-dfb.c 10 Jan 2006 19:40:25 -0000      1.45
> +++ video-dfb.c 19 Jan 2006 23:04:04 -0000
> @@ -1396,6 +1397,7 @@ void cDFBVideoOut::YUV(uint8_t *Py, uint
>  #endif
>
>        }
> +      usleep(2000);
>        //scrSurface->Flip(NULL, (setupStore->useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
>        scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
>
> A usleep(5000) reduced the CPU usage of libdirectfb_matrox.so from over
> 15000 to 83 samples.  usleep(1000) increased the number of samples
> to 109, with 14 samples in matroxEngineSync().  usleep(2000) resulted in
> 70 samples in libdirectfb_matrox.so, with 7 in matroxEngineSync().  Of
> course, I should have sampled longer than 20 seconds to get more accurate
> values.
>
> I don't know what the optimal parameter for the usleep might be.  I guess
> it depends on the value of HZ (which can be 100, 250, or 1000) and the
> video frame rate, as the granularity of usleep() is 1/HZ seconds.  For
> a 25 Hz frame rate (like mgatv), a frame takes 40 milliseconds.  At
> HZ=100 (on 2.4 kernels), the sleep granularity is 10 milliseconds, which
> might be too tight.  On VGA, it is even worse.  I guess that to be on the
> safe side, you should put usleep(1000) there.  It doesn't make so much
> difference if libdirectfb_matrox.so takes 0.1% or 0.06% of the CPU, but
> 10% (without any sleep) is definitely too much.
>
> Later, I might see if something similar can be done in
> cDFBVideoOut::OpenOSD(), cDFBVideoOut::RefreshOSD(),
> cDFBVideoOut::CloseOSD(), and cDFBVideoOut::ShowOSD().
> Any busy-waiting in RefreshOSD() might explain why audio and video frames
> are occasionally dropped while the menus are being browsed.
>
> 	Marko

Stefan Lucke


From marko.makela at hut.fi  Fri Jan 20 11:48:32 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 20 Jan 2006 12:48:32 +0200
Subject: [Softdevice-devel] Save 10% CPU by sleeping before IDirectFBSurface::Flip()
In-Reply-To: <1137743681.43d0974107f0c@webmail.in-berlin.de>
References: <20060119162515.GC6778@localhost.localdomain> <20060119232840.GA3475@localhost.localdomain> <1137743681.43d0974107f0c@webmail.in-berlin.de>
Message-ID: <20060120104832.GB3805@localhost.localdomain>

On Fri, Jan 20, 2006 at 08:54:41AM +0100, Stefan Lucke wrote:
> There was a change posted by Ville on directfb-dev list in october.
> Thread title:
> 
> Experimental matrox field parity/triple buffering improvement
> 
> http://mail.directfb.org/pipermail/directfb-dev/2005-October/000851.html
> 
> 
> But I didn't tested this myself. Even feedback from others was low.

I vaguely remember that patch.  However, looking at the patch (and having
limited understanding of how the things work), I can't see how this would
eliminate the busy-waiting.  As far as I understood, the Flip() call is not
waiting for vblank, but for device idle (DMA and StretchBlit completed).

I didn't notice any tearing with the usleep() added, but I didn't test or
look very hard.

I'd like to know if YUV() is executed in the same thread as the MPEG decoder.
Well, I guess there is some VDR thread that can make use of the usleep()
scheduling slot, but can it really use up one whole slot per video frame?
The MPEG decoder most certainly could make use of all that CPU time.

What about the OSD methods, are they executed in the same thread as YUV()?

> Perhaps I should do some tests.

I would really appreciate it, as I don't really know how DMA and interrupts
work on modern PC hardware or how these things are handled in the Linux
kernel and userspace.

	Marko


From marko.makela at hut.fi  Fri Jan 20 18:34:34 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 20 Jan 2006 19:34:34 +0200
Subject: [Softdevice-devel] Save 10% CPU by sleeping before IDirectFBSurface::Flip()
In-Reply-To: <20060119232840.GA3475@localhost.localdomain>
References: <20060119162515.GC6778@localhost.localdomain> <20060119232840.GA3475@localhost.localdomain>
Message-ID: <20060120173434.GA17923@localhost.localdomain>

On Fri, Jan 20, 2006 at 01:28:40AM +0200, Marko M?kel? wrote:
> Later, I might see if something similar can be done in
> cDFBVideoOut::OpenOSD(), cDFBVideoOut::RefreshOSD(),
> cDFBVideoOut::CloseOSD(), and cDFBVideoOut::ShowOSD().

I commented out the DIEF_REPEAT and held the OK button down while
video playback was paused, to get lots of OSD activity.  Not surprisingly,
the Flip() operations ate a lot of CPU:

     7609 38.8909 vmlinux
     3571 18.2520 vdr
     2611 13.3453 libvdr-softdevice.so.1.3.37
     2354 12.0317 libc-2.3.5.so
     1555  7.9479 libdirectfb_matrox.so

After adding usleep(2000) or usleep(1000) before every Flip() in
video-dfb.c, the situation improved:

     7688 45.1492 vmlinux
     3328 19.5443 vdr
     2175 12.7731 libvdr-softdevice.so.1.3.37
     2046 12.0155 libc-2.3.5.so
...
       48  0.2819 libdirectfb_matrox.so

This was sampled only for two seconds, so the sample counts fluctuate
more than in my previous runs.  Anyway, we clearly see a 30-fold
improvement in libdirectfb_matrox.so.

Hmm, I'm observing jerky motion on one clip, no matter if YUV() calls
usleep().

> Any busy-waiting in RefreshOSD() might explain why audio and video frames
> are occasionally dropped while the menus are being browsed. 

Nope.  If I hold down the Down key in a menu with some usleep() added before
every Flip() in video-dfb.c, I'll get instant audio chopping.  I guess the
OSD is being handled by the same thread that does MPEG decoding and YUV.
Is it so?

	Marko


From M.Wache at gmx.net  Fri Jan 20 20:45:01 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Fri, 20 Jan 2006 20:45:01 +0100
Subject: [Softdevice-devel] Save 10% CPU by sleeping before IDirectFBSurface::Flip()
In-Reply-To: <20060120173434.GA17923@localhost.localdomain>
References: <20060119162515.GC6778@localhost.localdomain> <20060119232840.GA3475@localhost.localdomain> <20060120173434.GA17923@localhost.localdomain>
Message-ID: <43D13DBD.9060600@gmx.net>

Marko M?kel? schrieb:

> 
>> Any busy-waiting in RefreshOSD() might explain why audio and video frames
>> are occasionally dropped while the menus are being browsed. 
> 
> Nope.  If I hold down the Down key in a menu with some usleep() added before
> every Flip() in video-dfb.c, I'll get instant audio chopping.  I guess the
> OSD is being handled by the same thread that does MPEG decoding and YUV.
> Is it so?
> 
No, RefreshOSD() should called by the main thread, while the video is
decoded in a separate thread. Not sure why you get choppy audio... Maybe
it is just because of the CPU usage of the OSD rendering.

Ah, I forgot to send an e-mail yesterday, but I committed a patch to the
CVS which should the SetParams() problems.

Martin


From marko.makela at hut.fi  Fri Jan 20 22:05:27 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 20 Jan 2006 23:05:27 +0200
Subject: [Softdevice-devel] Save 10% CPU by sleeping before IDirectFBSurface::Flip()
In-Reply-To: <43D13DBD.9060600@gmx.net>
References: <20060119162515.GC6778@localhost.localdomain> <20060119232840.GA3475@localhost.localdomain> <20060120173434.GA17923@localhost.localdomain> <43D13DBD.9060600@gmx.net>
Message-ID: <20060120210527.GA3483@localhost.localdomain>

On Fri, Jan 20, 2006 at 08:45:01PM +0100, Martin Wache wrote:
> Marko M?kel? schrieb:
> >> Any busy-waiting in RefreshOSD() might explain why audio and video frames
> >> are occasionally dropped while the menus are being browsed. 
> > 
> > Nope.  If I hold down the Down key in a menu with some usleep() added before
> > every Flip() in video-dfb.c, I'll get instant audio chopping.  I guess the
> > OSD is being handled by the same thread that does MPEG decoding and YUV.
> > Is it so?
> > 
> No, RefreshOSD() should called by the main thread, while the video is
> decoded in a separate thread. Not sure why you get choppy audio...

Normally, I get a dropped audio frame at every 5th or 10th key-repeat if
I hold down the Down button in the Recordings or EPG menu.  After I added
a usleep() before every Flip() call in video-dfb.c, I got dropped audio
frames on every key-repeat.  I'm using the linuxinput module of DirectFB
for the remote control unit, if that makes any difference.

> Maybe it is just because of the CPU usage of the OSD rendering.

It could also be some weird priority inversion thing.

Can you give me a summary of the threads set up by vdr and softdevice?
Or is there some English or German documentation I could read?  I didn't
see anything relevant in the vdr source distribution.

	Marko


From M.Wache at gmx.net  Fri Jan 20 22:41:09 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Fri, 20 Jan 2006 22:41:09 +0100
Subject: [Softdevice-devel] Save 10% CPU by sleeping before IDirectFBSurface::Flip()
In-Reply-To: <20060120210527.GA3483@localhost.localdomain>
References: <20060119162515.GC6778@localhost.localdomain> <20060119232840.GA3475@localhost.localdomain> <20060120173434.GA17923@localhost.localdomain> <43D13DBD.9060600@gmx.net> <20060120210527.GA3483@localhost.localdomain>
Message-ID: <43D158F5.3030604@gmx.net>

Marko M?kel? schrieb:
> On Fri, Jan 20, 2006 at 08:45:01PM +0100, Martin Wache wrote:
>> Marko M?kel? schrieb:
>>>> Any busy-waiting in RefreshOSD() might explain why audio and video frames
>>>> are occasionally dropped while the menus are being browsed. 
>>> Nope.  If I hold down the Down key in a menu with some usleep() added before
>>> every Flip() in video-dfb.c, I'll get instant audio chopping.  I guess the
>>> OSD is being handled by the same thread that does MPEG decoding and YUV.
>>> Is it so?
>>>
>> No, RefreshOSD() should called by the main thread, while the video is
>> decoded in a separate thread. Not sure why you get choppy audio...
> 
> Normally, I get a dropped audio frame at every 5th or 10th key-repeat if
> I hold down the Down button in the Recordings or EPG menu.  After I added
> a usleep() before every Flip() call in video-dfb.c, I got dropped audio
> frames on every key-repeat.  I'm using the linuxinput module of DirectFB
> for the remote control unit, if that makes any difference.
> 
Hmm, that's strange. I added a pthread_yield() in SoftOsd.c, maybe this
does something. I added it because some skins use scrolling texts and
this caused audio buffer underruns on my system.

>> Maybe it is just because of the CPU usage of the OSD rendering.
> 
> It could also be some weird priority inversion thing.
> 
> Can you give me a summary of the threads set up by vdr and softdevice?
> Or is there some English or German documentation I could read?  I didn't
> see anything relevant in the vdr source distribution.
> 
For the vdr, I'm not even sure myself. For the softdevice, well that's
complicated, I guess I will miss a one or the other ;-)
There is one thread which uses libavformat to parse the PES received
from the vdr, one decoding thread for each audio and video, one for
events in DFB/Xv, one for redrawing the osd on format changes and
blanking the screen. And maybe I missed one ;-)

Martin


From anssi.hannula at gmail.com  Sat Jan 21 17:30:49 2006
From: anssi.hannula at gmail.com (Anssi Hannula)
Date: Sat, 21 Jan 2006 18:30:49 +0200
Subject: [Softdevice-devel] Apparent cache misses in yv12_to_yuy2()
In-Reply-To: <20060112212117.GB3487@localhost.localdomain>
References: <20060112212117.GB3487@localhost.localdomain>
Message-ID: <43D261B9.4010309@gmail.com>

Marko M?kel? wrote:
> The bottleneck with dfb:mgatv seems to be the yv12_to_yuy2() conversion
> routine.

[...]
> Would it even be possible to decode directly into YUY2 color space?

I'm no expert on this colorspace stuff, but don't the G400 and up
support YV12 output, or am I missing something here?

-- 
Anssi Hannula



From M.Wache at gmx.net  Sat Jan 21 18:37:45 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sat, 21 Jan 2006 18:37:45 +0100
Subject: [Softdevice-devel] Apparent cache misses in yv12_to_yuy2()
In-Reply-To: <43D261B9.4010309@gmail.com>
References: <20060112212117.GB3487@localhost.localdomain> <43D261B9.4010309@gmail.com>
Message-ID: <43D27169.9050007@gmx.net>

Anssi Hannula schrieb:
> Marko M?kel? wrote:
>> The bottleneck with dfb:mgatv seems to be the yv12_to_yuy2() conversion
>> routine.
> 
> [...]
>> Would it even be possible to decode directly into YUY2 color space?
> 
> I'm no expert on this colorspace stuff, but don't the G400 and up
> support YV12 output, or am I missing something here?
> 
As far as I know the video backend scaler supports YV12, but it doesn't
support alpha blending. The 2D/3D acceleration supports only yuy2 color
space but it can do alpha blending.

At least it's like that for my ATI Rage 128, and from what Stefan wrote
I assume it's the same for the Matrox cards.

Martin


From stefan at lucke.in-berlin.de  Sun Jan 22 12:58:03 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 22 Jan 2006 12:58:03 +0100
Subject: [Softdevice-devel] XV-out, toggle fullscreen while playback paused
Message-ID: <200601221258.03713.stefan@lucke.in-berlin.de>

Hi,

I get an odd behaviour when toggleing fullscreen mode while playback
is paused. It took a few seconds until still video image is shown
after toggle.

To fix this, I'm using attached dif to get instant video refresh.

map_count is used for limiting redraw operations to every third
event of interest. So when event processing loop terminates, there
may be some yet unhandled events. In that case redrawing of
current (still) picture is required too. XClearArea() should be
called too so that parts of screen which do not hold video,
get cleared. After reenabling this code video I got a huge number
of Expose events, so I disabled map_count increment for this 
(new handled) event type.

Martin, in which situations did you encounter problems with old logic ?


-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: xv-01.diff
Type: text/x-diff
Size: 1426 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060122/c0351e86/attachment.diff>

From M.Wache at gmx.net  Sun Jan 22 13:54:53 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 22 Jan 2006 13:54:53 +0100
Subject: [Softdevice-devel] XV-out, toggle fullscreen while playback paused
In-Reply-To: <200601221258.03713.stefan@lucke.in-berlin.de>
References: <200601221258.03713.stefan@lucke.in-berlin.de>
Message-ID: <43D3809D.9060802@gmx.net>

Stefan Lucke schrieb:
> Hi,
> 
> I get an odd behaviour when toggleing fullscreen mode while playback
> is paused. It took a few seconds until still video image is shown
> after toggle.
> 
> To fix this, I'm using attached dif to get instant video refresh.
> 
> map_count is used for limiting redraw operations to every third
> event of interest. So when event processing loop terminates, there
> may be some yet unhandled events. In that case redrawing of
> current (still) picture is required too. XClearArea() should be
> called too so that parts of screen which do not hold video,
> get cleared. After reenabling this code video I got a huge number
> of Expose events, so I disabled map_count increment for this 
> (new handled) event type.
> 
> Martin, in which situations did you encounter problems with old logic ?
>
I think it's stupid to randomly only to handle every third event, and
I'm sure that this was needed because the drawing mechanism of the
softdevice was/is broken. For instance the OSD was redrawn every other
video frame and not just on OSD change or window format change.
The Expose events are send by the xlib in case the window has to be
redrawn, for example because the window was partly overdrawn by an other
window and is put in front again. So in principle one only has to draw
the OSD in Expose events and on OSD change.
But as far as I understand the XClearArea() usage in the softdevice is
mostly wrong, usually we use XClearArea() and then immediately redraw
the window. This is wrong, because the XClearArea() call automatically
generates Expose events, so that the redrawing happens automatically
from ProcessEvents. And that is also the reason why XClearArea() should
not be called on Expose events.
I'm still new to xlib programming, so I maybe wrong somewhere, but to my
experience now the cpu usage of the xlib is smaller when osd is shown.
And there are still a lot of things which could be cleaned up...

>          break;
>        case Expose:
>          EVDEB("Expose\n");
> -        map_count++;
> +        //map_count++;
>          break;
>        default:
>          EVDEB("unhandled event: %d\n",event.type);
> @@ -657,16 +657,16 @@
>  
>    if (xv_initialized) {
>      if (map_count) {
> -      //XClearArea (dpy, win, 0, 0, 0, 0, True);
> +      XClearArea (dpy, win, 0, 0, 0, 0, True);
>        ShowOSD(0,false);
> -//      XvShmPutImage(dpy, port,
> -//                    win, gc,
> -//                    xv_image,
> -//                    sxoff, syoff,      /* sx, sy */
> -//                    swidth, sheight,   /* sw, sh */
> -//                    lxoff,  lyoff,     /* dx, dy */
> -//                    lwidth, lheight,   /* dw, dh */
> -//                    False);
> +      XvShmPutImage(dpy, port,
> +                    win, gc,
> +                    xv_image,
> +                    sxoff, syoff,      /* sx, sy */
> +                    swidth, sheight,   /* sw, sh */
> +                    lxoff,  lyoff,     /* dx, dy */
> +                    lwidth, lheight,   /* dw, dh */
> +                    False);
>        XSync(dpy, False);
>        map_count=0;
>      }

To fix your problem, isn't it enough to uncomment XvShmPutImage()?

Bye,
Martin


From marko.makela at hut.fi  Sun Jan 22 14:28:50 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sun, 22 Jan 2006 15:28:50 +0200
Subject: [Softdevice-devel] Apparent cache misses in yv12_to_yuy2()
In-Reply-To: <43D261B9.4010309@gmail.com>
References: <20060112212117.GB3487@localhost.localdomain> <43D261B9.4010309@gmail.com>
Message-ID: <20060122132850.GA10541@localhost.localdomain>

On Sat, Jan 21, 2006 at 06:30:49PM +0200, Anssi Hannula wrote:
> Marko M?kel? wrote:
> > The bottleneck with dfb:mgatv seems to be the yv12_to_yuy2() conversion
> > routine.
> 
> [...]
> > Would it even be possible to decode directly into YUY2 color space?
> 
> I'm no expert on this colorspace stuff, but don't the G400 and up
> support YV12 output, or am I missing something here?

For VGA output (using the back-end scaler) it does.  Maybe it does also
for TV output, but I don't know how.

One thing I should perhaps try is to drive VGA output to the SCART RGB.
Then I'd get rid of the Flip() calls and the color space conversion.
But I'm not sure if it would cause field parity issues.  The TV output
seems to have built-in interlaced output (i.e., complete frames in at
25 Hz, interlaced out at 50 Hz), which the VGA output might lack.

	Marko


From malcolm.caldwell at cdu.edu.au  Sun Jan 22 16:23:56 2006
From: malcolm.caldwell at cdu.edu.au (Malcolm Caldwell)
Date: Mon, 23 Jan 2006 00:53:56 +0930
Subject: [Softdevice-devel] Apparent cache misses in yv12_to_yuy2()
In-Reply-To: <20060122132850.GA10541@localhost.localdomain>
References: <20060112212117.GB3487@localhost.localdomain>
	 <43D261B9.4010309@gmail.com> <20060122132850.GA10541@localhost.localdomain>
Message-ID: <1137943436.4413.3.camel@localhost.localdomain>

On Sun, 2006-01-22 at 15:28 +0200, Marko M?kel? wrote:
> On Sat, Jan 21, 2006 at 06:30:49PM +0200, Anssi Hannula wrote:
> > Marko M?kel? wrote:
> > > The bottleneck with dfb:mgatv seems to be the yv12_to_yuy2() conversion
> > > routine.
> > 
> > [...]
> > > Would it even be possible to decode directly into YUY2 color space?
> > 
> > I'm no expert on this colorspace stuff, but don't the G400 and up
> > support YV12 output, or am I missing something here?
> 
> For VGA output (using the back-end scaler) it does.  Maybe it does also
> for TV output, but I don't know how.

On my G400 (or is it 450, I cannot remember) using TV out I only get to
choose YUV2.  I cannot enable hardware alpha.

There is a strange thing: If I try to use the menu to change to another
color space vdr crashes.  When I get some time I will try to trace this.

I also tried to change the format in the config file, but regardless in
the menu I see YUV2.

> One thing I should perhaps try is to drive VGA output to the SCART RGB.
> Then I'd get rid of the Flip() calls and the color space conversion.
> But I'm not sure if it would cause field parity issues.  The TV output
> seems to have built-in interlaced output (i.e., complete frames in at
> 25 Hz, interlaced out at 50 Hz), which the VGA output might lack.
> 
> 	Marko
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/softdevice-devel



From laz at club-burniston.co.uk  Sun Jan 22 16:43:10 2006
From: laz at club-burniston.co.uk (Laz)
Date: Sun, 22 Jan 2006 15:43:10 +0000
Subject: [Softdevice-devel] Apparent cache misses in yv12_to_yuy2()
In-Reply-To: <1137943436.4413.3.camel@localhost.localdomain>
References: <20060112212117.GB3487@localhost.localdomain> <20060122132850.GA10541@localhost.localdomain> <1137943436.4413.3.camel@localhost.localdomain>
Message-ID: <200601221543.10684.laz@club-burniston.co.uk>

On Sunday 22 January 2006 15:23, Malcolm Caldwell wrote:
> On Sun, 2006-01-22 at 15:28 +0200, Marko M?kel? wrote:
> > For VGA output (using the back-end scaler) it does.  Maybe it does also
> > for TV output, but I don't know how.
>
> On my G400 (or is it 450, I cannot remember) using TV out I only get to
> choose YUV2.  I cannot enable hardware alpha.
>
> There is a strange thing: If I try to use the menu to change to another
> color space vdr crashes.  When I get some time I will try to trace this.
>
> I also tried to change the format in the config file, but regardless in
> the menu I see YUV2.

If you use -vo dfb:mgatv, the pixel format is hard-coded to YUV2 and 
StretchBlit is enabled at about line 335 of video-dfb.c (depending on what 
version you have).

Cheers,

Laz


From marko.makela at hut.fi  Sun Jan 22 17:14:49 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sun, 22 Jan 2006 18:14:49 +0200
Subject: [Softdevice-devel] Save 10% CPU by sleeping before IDirectFBSurface::Flip()
In-Reply-To: <43D158F5.3030604@gmx.net>
References: <20060119162515.GC6778@localhost.localdomain> <20060119232840.GA3475@localhost.localdomain> <20060120173434.GA17923@localhost.localdomain> <43D13DBD.9060600@gmx.net> <20060120210527.GA3483@localhost.localdomain> <43D158F5.3030604@gmx.net>
Message-ID: <20060122161449.GA3966@localhost.localdomain>

On Fri, Jan 20, 2006 at 10:41:09PM +0100, Martin Wache wrote:
> Marko M?kel? schrieb:
> > On Fri, Jan 20, 2006 at 08:45:01PM +0100, Martin Wache wrote:
> >> Marko M?kel? schrieb:
> >>>> Any busy-waiting in RefreshOSD() might explain why audio and video frames
> >>>> are occasionally dropped while the menus are being browsed. 
> >>> Nope.  If I hold down the Down key in a menu with some usleep() added before
> >>> every Flip() in video-dfb.c, I'll get instant audio chopping.  I guess the
> >>> OSD is being handled by the same thread that does MPEG decoding and YUV.
> >>> Is it so?
> >>>
> >> No, RefreshOSD() should called by the main thread, while the video is
> >> decoded in a separate thread. Not sure why you get choppy audio...
> > 
> > Normally, I get a dropped audio frame at every 5th or 10th key-repeat if
> > I hold down the Down button in the Recordings or EPG menu.  After I added
> > a usleep() before every Flip() call in video-dfb.c, I got dropped audio
> > frames on every key-repeat.  I'm using the linuxinput module of DirectFB
> > for the remote control unit, if that makes any difference.
> > 
> Hmm, that's strange. I added a pthread_yield() in SoftOsd.c, maybe this
> does something. I added it because some skins use scrolling texts and
> this caused audio buffer underruns on my system.

Now I have two added usleep() in video-dfb.c:

diff -p -u -r1.45 video-dfb.c
--- video-dfb.c 10 Jan 2006 19:40:25 -0000      1.45
+++ video-dfb.c 22 Jan 2006 16:00:29 -0000
@@ -1245,6 +1245,7 @@ void cDFBVideoOut::ShowOSD ()
         scrSurface->SetBlittingFlags(DSBLIT_BLEND_ALPHACHANNEL);
         scrSurface->Blit(osdSurface, &osdsrc, 0, 0);
       }
+      usleep(1000);
       scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);

     }

This one reduces libdirectfb_matrox.so CPU usage when the video is paused.
(For some reason, vdr 1.3.39 apparently keeps calling ShowOSD in this case.)
However, it might add some audio chopping when navigating the menus at
key-repeat rate.

The second one I have posted already:

@@ -1397,6 +1398,7 @@ void cDFBVideoOut::YUV(uint8_t *Py, uint

       }
       //scrSurface->Flip(NULL, (setupStore->useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
+      usleep(2000);
       scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);

     }

These two usleep()s appear to be enough.  When holding down the Down button
in the EPG during paused video, I get this kind of CPU usage:

     7408 34.1729 vdr
     5665 26.1325 vmlinux
     3837 17.7000 libvdr-softdevice.so.1.3.39
     2669 12.3120 libc-2.3.5.so
...
       84  0.3875 libdirectfb_matrox.so

Within softdevice, we get:

1793     46.7292  cSoftOsd::ScaleUpHoriz_MMX(unsigned char*, int, color*, int)
1001     26.0881  cSoftOsd::DrawConvertBitmap(cBitmap*, bool)
800      20.8496  cSoftOsd::ScaleUpVert_MMX(unsigned char*, int, int, int, color**, int)
90        2.3456  cSoftOsd::ScaleVUpCopyToBitmap(unsigned char*, int, int, int,
bool, bool*)
71        1.8504  .plt
47        1.2249  yv12_to_yuy2(unsigned char const*, unsigned char const*, unsigned char const*, unsigned char*, int, int, int, int, int)

I think that this is okay.  According to top, the vdr process uses up less
than 50% of the available CPU.

I tried if pthread_yield() would do the trick in place of the usleep()
calls.  No, it doesn't: libdirectfb_matrox.so would keep burning CPU
in matroxEngineSync.

> For the vdr, I'm not even sure myself.

Oh well, I guess I'd better ask on the vdr mailing list, then.

	Marko


From marko.makela at hut.fi  Sun Jan 22 17:21:52 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sun, 22 Jan 2006 18:21:52 +0200
Subject: [Softdevice-devel] Crash with DVD subtitles
Message-ID: <20060122162152.GA3987@localhost.localdomain>

I tried to play a DVD with vdr-1.3.39, dvd plugin from CVS and softdevice CVS.
The DVD has an option for subtitles in one track.  I got a crash in
mpeg2decoder.c immediately after selecting that:

#0  cStreamDecoder::Action (this=0x843b258) at mpeg2decoder.c:177
177       while(active)
(gdb) i lo
pkt = (AVPacket *) 0x0

Should I run vdr inside gdb to get better information, or does this give
enough ideas?

	Marko


From stefan at lucke.in-berlin.de  Sun Jan 22 17:32:48 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 22 Jan 2006 17:32:48 +0100
Subject: [Softdevice-devel] XV-out, toggle fullscreen while playback paused
In-Reply-To: <43D3809D.9060802@gmx.net>
References: <200601221258.03713.stefan@lucke.in-berlin.de> <43D3809D.9060802@gmx.net>
Message-ID: <200601221732.48198.stefan@lucke.in-berlin.de>

On Sonntag, 22. Januar 2006 13:54, Martin Wache wrote:
> Stefan Lucke schrieb:
> > Hi,
> > 
> > I get an odd behaviour when toggleing fullscreen mode while playback
> > is paused. It took a few seconds until still video image is shown
> > after toggle.
> > 
> > To fix this, I'm using attached dif to get instant video refresh.
> > 
> > map_count is used for limiting redraw operations to every third
> > event of interest. So when event processing loop terminates, there
> > may be some yet unhandled events. In that case redrawing of
> > current (still) picture is required too. XClearArea() should be
> > called too so that parts of screen which do not hold video,
> > get cleared. After reenabling this code video I got a huge number
> > of Expose events, so I disabled map_count increment for this 
> > (new handled) event type.
> > 
> > Martin, in which situations did you encounter problems with old logic ?
> >

> I think it's stupid to randomly only to handle every third event, and
> I'm sure that this was needed because the drawing mechanism of the
> softdevice was/is broken.

No that's not stupid, it's just optimizing. Think of resizing. In that
situation you'll get ContigureNotify on every pixel size change
and a final Expose.

> For instance the OSD was redrawn every other
> video frame and not just on OSD change or window format change.

Hm, could be part of logic from vdr-1.2.x. OSD (re)draw was quite
different from that now.

> The Expose events are send by the xlib in case the window has to be
> redrawn, for example because the window was partly overdrawn by an other
> window and is put in front again. So in principle one only has to draw
> the OSD in Expose events and on OSD change.
> But as far as I understand the XClearArea() usage in the softdevice is
> mostly wrong, usually we use XClearArea() and then immediately redraw
> the window. 

>This is wrong, because the XClearArea() call automatically
> generates Expose events, so that the redrawing happens automatically
> from ProcessEvents. And that is also the reason why XClearArea() should
> not be called on Expose events.

Ah, thats why I never handled/looked at Expose events :-) .

> I'm still new to xlib programming, so I maybe wrong somewhere, but to my
> experience now the cpu usage of the xlib is smaller when osd is shown.
> And there are still a lot of things which could be cleaned up...
> 

[snip code]

> 
> To fix your problem, isn't it enough to uncomment XvShmPutImage()?

No, when going from full to windowed mode, it is required to clear
the entire area. Assume displaying a 4:3 video in a 16:9 window.
Without clear(), there may some parts of a previous drawn OSD left
and right of the video area.


-- 
Stefan Lucke



From M.Wache at gmx.net  Sun Jan 22 17:38:32 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 22 Jan 2006 17:38:32 +0100
Subject: [Softdevice-devel] Crash with DVD subtitles
In-Reply-To: <20060122162152.GA3987@localhost.localdomain>
References: <20060122162152.GA3987@localhost.localdomain>
Message-ID: <43D3B508.5070307@gmx.net>

Marko M?kel? schrieb:
> I tried to play a DVD with vdr-1.3.39, dvd plugin from CVS and softdevice CVS.
> The DVD has an option for subtitles in one track.  I got a crash in
> mpeg2decoder.c immediately after selecting that:
> 
> #0  cStreamDecoder::Action (this=0x843b258) at mpeg2decoder.c:177
> 177       while(active)
> (gdb) i lo
> pkt = (AVPacket *) 0x0
> 
> Should I run vdr inside gdb to get better information, or does this give
> enough ideas?
> 
A bit more informations would be nice. From a short look at the code pkt
= 0 should not cause any crashes in cStreamDecoder::Action.

Bye,
Martin


From M.Wache at gmx.net  Sun Jan 22 17:48:47 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 22 Jan 2006 17:48:47 +0100
Subject: [Softdevice-devel] Save 10% CPU by sleeping before IDirectFBSurface::Flip()
In-Reply-To: <20060122161449.GA3966@localhost.localdomain>
References: <20060119162515.GC6778@localhost.localdomain> <20060119232840.GA3475@localhost.localdomain> <20060120173434.GA17923@localhost.localdomain> <43D13DBD.9060600@gmx.net> <20060120210527.GA3483@localhost.localdomain> <43D158F5.3030604@gmx.net> <20060122161449.GA3966@localhost.localdomain>
Message-ID: <43D3B76F.1010100@gmx.net>

Marko M?kel? schrieb:
> On Fri, Jan 20, 2006 at 10:41:09PM +0100, Martin Wache wrote:
>> Marko M?kel? schrieb:
>>> On Fri, Jan 20, 2006 at 08:45:01PM +0100, Martin Wache wrote:
>>>> Marko M?kel? schrieb:
>>>>>> Any busy-waiting in RefreshOSD() might explain why audio and video frames
>>>>>> are occasionally dropped while the menus are being browsed. 
>>>>> Nope.  If I hold down the Down key in a menu with some usleep() added before
>>>>> every Flip() in video-dfb.c, I'll get instant audio chopping.  I guess the
>>>>> OSD is being handled by the same thread that does MPEG decoding and YUV.
>>>>> Is it so?
>>>>>
>>>> No, RefreshOSD() should called by the main thread, while the video is
>>>> decoded in a separate thread. Not sure why you get choppy audio...
>>> Normally, I get a dropped audio frame at every 5th or 10th key-repeat if
>>> I hold down the Down button in the Recordings or EPG menu.  After I added
>>> a usleep() before every Flip() call in video-dfb.c, I got dropped audio
>>> frames on every key-repeat.  I'm using the linuxinput module of DirectFB
>>> for the remote control unit, if that makes any difference.
>>>
>> Hmm, that's strange. I added a pthread_yield() in SoftOsd.c, maybe this
>> does something. I added it because some skins use scrolling texts and
>> this caused audio buffer underruns on my system.
> 
> Now I have two added usleep() in video-dfb.c:
> 
> diff -p -u -r1.45 video-dfb.c
> --- video-dfb.c 10 Jan 2006 19:40:25 -0000      1.45
> +++ video-dfb.c 22 Jan 2006 16:00:29 -0000
> @@ -1245,6 +1245,7 @@ void cDFBVideoOut::ShowOSD ()
>          scrSurface->SetBlittingFlags(DSBLIT_BLEND_ALPHACHANNEL);
>          scrSurface->Blit(osdSurface, &osdsrc, 0, 0);
>        }
> +      usleep(1000);
>        scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
> 
>      }

Did you try to change the parameters for Flip()? Maybe DSFLIP_ONSYNC or
DSFLIP_NONE helps?

Bye,
Martin


From M.Wache at gmx.net  Sun Jan 22 18:07:55 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 22 Jan 2006 18:07:55 +0100
Subject: [Softdevice-devel] XV-out, toggle fullscreen while playback paused
In-Reply-To: <200601221732.48198.stefan@lucke.in-berlin.de>
References: <200601221258.03713.stefan@lucke.in-berlin.de> <43D3809D.9060802@gmx.net> <200601221732.48198.stefan@lucke.in-berlin.de>
Message-ID: <43D3BBEB.7000801@gmx.net>

Stefan Lucke schrieb:
>> I think it's stupid to randomly only to handle every third event, and
>> I'm sure that this was needed because the drawing mechanism of the
>> softdevice was/is broken.
> 
> No that's not stupid, it's just optimizing. Think of resizing. In that
> situation you'll get ContigureNotify on every pixel size change
> and a final Expose.
> 
Also only every third MapNotify was handled, and MapNotify has nothing
to do with resizing.

>> For instance the OSD was redrawn every other
>> video frame and not just on OSD change or window format change.
> 
> Hm, could be part of logic from vdr-1.2.x. OSD (re)draw was quite
> different from that now.
>
What I meant is that ShowOSD() was called from inside of cXvVideoOut::YUV().


>> To fix your problem, isn't it enough to uncomment XvShmPutImage()?
> 
> No, when going from full to windowed mode, it is required to clear
> the entire area. Assume displaying a 4:3 video in a 16:9 window.
> Without clear(), there may some parts of a previous drawn OSD left
> and right of the video area.
> 
So I think the obvious solution is to call XClearArea() from
toggleFullScreen().

Bye,
Martin




From seppo.ingalsuo at iki.fi  Sun Jan 22 21:07:15 2006
From: seppo.ingalsuo at iki.fi (Seppo Ingalsuo)
Date: Sun, 22 Jan 2006 22:07:15 +0200
Subject: [Softdevice-devel] "-vo shm:" / ShmClient a simple client/server
 model for the softdevice
In-Reply-To: <43CD5E05.2080702@gmx.net>
References: <43CD5E05.2080702@gmx.net>
Message-ID: <43D3E5F3.1010300@iki.fi>

Hi,

This is great for my vdr setup! I managed to compile it with vdr 1.3.39 
by adding -ljpg and ../../../osdcontroller.o to link command line.

However the result was not that successful. I got to my 1280x720 X 
display almost black and white live tv picture with two small picture 
copies on the top of the screen, a kind of picture-in-picture look. 
There was no OSD.

Cheers,
Seppo



From M.Wache at gmx.net  Sun Jan 22 21:34:44 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 22 Jan 2006 21:34:44 +0100
Subject: [Softdevice-devel] "-vo shm:" / ShmClient a simple client/server
 model for the softdevice
In-Reply-To: <43D3E5F3.1010300@iki.fi>
References: <43CD5E05.2080702@gmx.net> <43D3E5F3.1010300@iki.fi>
Message-ID: <43D3EC64.8030909@gmx.net>

Seppo Ingalsuo schrieb:
> Hi,
> 
> This is great for my vdr setup! I managed to compile it with vdr 1.3.39
> by adding -ljpg and ../../../osdcontroller.o to link command line.
>
Up to now I only tested it with vdr-1.3.37, I will see how can manage to
make it compile also for >vdr-1.3.37. Thank you for the report!

> However the result was not that successful. I got to my 1280x720 X
> display almost black and white live tv picture with two small picture
> copies on the top of the screen, a kind of picture-in-picture look.
> There was no OSD.
> 
There is a small bug somwhere which causes that, usually closing the
ShmClient and restarting it helps.
The OSD currently only works in software alpha blending mode, so please
switch to it before using the ShmClient.
I'm currently working on speeding the -vo shm up useing direct
rendering, but that means I have to implement direct rendering first for
Xv-Out ;-). I will tackle the missing features and the bugs when direct
rendering is finished, however, I can't promise when that will be...

Bye,
Martin


From stefan at lucke.in-berlin.de  Sun Jan 22 23:58:42 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 22 Jan 2006 23:58:42 +0100
Subject: [Softdevice-devel] XV-out, toggle fullscreen while playback paused
In-Reply-To: <43D3BBEB.7000801@gmx.net>
References: <200601221258.03713.stefan@lucke.in-berlin.de> <200601221732.48198.stefan@lucke.in-berlin.de> <43D3BBEB.7000801@gmx.net>
Message-ID: <200601222358.42987.stefan@lucke.in-berlin.de>

On Sonntag, 22. Januar 2006 18:07, Martin Wache wrote:
> Stefan Lucke schrieb:
> >> I think it's stupid to randomly only to handle every third event, and
> >> I'm sure that this was needed because the drawing mechanism of the
> >> softdevice was/is broken.
> > 
> > No that's not stupid, it's just optimizing. Think of resizing. In that
> > situation you'll get ContigureNotify on every pixel size change
> > and a final Expose.
> > 
> Also only every third MapNotify was handled, and MapNotify has nothing
> to do with resizing.

You'll get MapNotify when a window gets back visible after it had been
minimized (was invisible). So usual action should be: redraw everything.
Action after resize op is: draw everything scaled to new size. 
I think we should drop redraw action from MapNotify and leave complete
redraw after event processing loop.

> 
> >> For instance the OSD was redrawn every other
> >> video frame and not just on OSD change or window format change.
> > 
> > Hm, could be part of logic from vdr-1.2.x. OSD (re)draw was quite
> > different from that now.
> >
> What I meant is that ShowOSD() was called from inside of cXvVideoOut::YUV().

Here I've still some problem to understand. 

> 
> 
> >> To fix your problem, isn't it enough to uncomment XvShmPutImage()?
> > 
> > No, when going from full to windowed mode, it is required to clear
> > the entire area. Assume displaying a 4:3 video in a 16:9 window.
> > Without clear(), there may some parts of a previous drawn OSD left
> > and right of the video area.
> > 
> So I think the obvious solution is to call XClearArea() from
> toggleFullScreen().

In toggleFullScreen() window areas have their starting dimensions
and not the target size of this operation.


-- 
Stefan Lucke



From torgeir at pobox.com  Mon Jan 23 04:38:57 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Mon, 23 Jan 2006 13:38:57 +1000
Subject: [Softdevice-devel] XV-out, toggle fullscreen while playback
	paused
In-Reply-To: <200601221732.48198.stefan@lucke.in-berlin.de>
References: <200601221258.03713.stefan@lucke.in-berlin.de>
	 <43D3809D.9060802@gmx.net>  <200601221732.48198.stefan@lucke.in-berlin.de>
Message-ID: <1137987538.5518.7.camel@localhost.localdomain>

On Sun, 2006-01-22 at 17:32 +0100, Stefan Lucke wrote:
> On Sonntag, 22. Januar 2006 13:54, Martin Wache wrote:

> > I think it's stupid to randomly only to handle every third event, and
> > I'm sure that this was needed because the drawing mechanism of the
> > softdevice was/is broken.
> 
> No that's not stupid, it's just optimizing. Think of resizing. In that
> situation you'll get ContigureNotify on every pixel size change
> and a final Expose.

It's possible to ask for events being compressed to avoid this.

> No, when going from full to windowed mode, it is required to clear
> the entire area. Assume displaying a 4:3 video in a 16:9 window.
> Without clear(), there may some parts of a previous drawn OSD left
> and right of the video area.

XClearArea should be correct, as long as the last argument if false
(don't generate expose event). See
http://tronche.com/gui/x/xlib/graphics/XClearArea.html


-- 
Torgeir Veimo <torgeir at pobox.com>



From stefan at lucke.in-berlin.de  Mon Jan 23 09:03:49 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 23 Jan 2006 09:03:49 +0100
Subject: [Softdevice-devel] XV-out, toggle fullscreen while playback	paused
In-Reply-To: <1137987538.5518.7.camel@localhost.localdomain>
References: <200601221258.03713.stefan@lucke.in-berlin.de>  <43D3809D.9060802@gmx.net>  <200601221732.48198.stefan@lucke.in-berlin.de> <1137987538.5518.7.camel@localhost.localdomain>
Message-ID: <1138003429.43d48de556170@webmail.in-berlin.de>

Quoting Torgeir Veimo <torgeir at pobox.com>:

> On Sun, 2006-01-22 at 17:32 +0100, Stefan Lucke wrote:
> > On Sonntag, 22. Januar 2006 13:54, Martin Wache wrote:
>
> > > I think it's stupid to randomly only to handle every third event, and
> > > I'm sure that this was needed because the drawing mechanism of the
> > > softdevice was/is broken.
> >
> > No that's not stupid, it's just optimizing. Think of resizing. In that
> > situation you'll get ContigureNotify on every pixel size change
> > and a final Expose.
>
> It's possible to ask for events being compressed to avoid this.

Are you referring to specifying this via hints ?
I think that is depending on window manager in use. Some honor such
hints and some not :-( .

>
> > No, when going from full to windowed mode, it is required to clear
> > the entire area. Assume displaying a 4:3 video in a 16:9 window.
> > Without clear(), there may some parts of a previous drawn OSD left
> > and right of the video area.
>
> XClearArea should be correct, as long as the last argument if false
> (don't generate expose event). See
> http://tronche.com/gui/x/xlib/graphics/XClearArea.html

Ups, thanks, that seems to be a general fault of mine :-(.


Stefan Lucke



From marko.makela at hut.fi  Mon Jan 23 09:24:02 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 23 Jan 2006 10:24:02 +0200
Subject: [Softdevice-devel] Apparent cache misses in yv12_to_yuy2()
In-Reply-To: <1137943436.4413.3.camel@localhost.localdomain>
References: <20060112212117.GB3487@localhost.localdomain> <43D261B9.4010309@gmail.com> <20060122132850.GA10541@localhost.localdomain> <1137943436.4413.3.camel@localhost.localdomain>
Message-ID: <20060123082402.GC3486@localhost.localdomain>

On Mon, Jan 23, 2006 at 12:53:56AM +0930, Malcolm Caldwell wrote:
> On my G400 (or is it 450, I cannot remember) using TV out I only get to
> choose YUV2.  I cannot enable hardware alpha.

YUY2, that is.  (I wonder when I'll get around to understanding what all
these color formats mean.)

> There is a strange thing: If I try to use the menu to change to another
> color space vdr crashes.  When I get some time I will try to trace this.

Me too.  You're welcome to trace it first. :-)

	Marko


From torgeir at pobox.com  Mon Jan 23 09:47:40 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Mon, 23 Jan 2006 18:47:40 +1000
Subject: [Softdevice-devel] XV-out, toggle fullscreen while
	playback	paused
In-Reply-To: <1138003429.43d48de556170@webmail.in-berlin.de>
References: <200601221258.03713.stefan@lucke.in-berlin.de>
	 <43D3809D.9060802@gmx.net>  <200601221732.48198.stefan@lucke.in-berlin.de>
	 <1137987538.5518.7.camel@localhost.localdomain>
	 <1138003429.43d48de556170@webmail.in-berlin.de>
Message-ID: <1138006060.26456.5.camel@localhost.localdomain>

On Mon, 2006-01-23 at 09:03 +0100, Stefan Lucke wrote:
> 
> > It's possible to ask for events being compressed to avoid this.
> 
> Are you referring to specifying this via hints ? 

Maybe my memory is failing me, i think it's actually the toolkit that
does the event compression.

On an unrelated note, it would be interesting to implement render &
composite based OSD when running under X11. 

-- 
Torgeir Veimo <torgeir at pobox.com>



From marko.makela at hut.fi  Mon Jan 23 10:44:55 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 23 Jan 2006 11:44:55 +0200
Subject: [Softdevice-devel] Save 10% CPU by sleeping before IDirectFBSurface::Flip()
In-Reply-To: <43D3B76F.1010100@gmx.net>
References: <20060119162515.GC6778@localhost.localdomain> <20060119232840.GA3475@localhost.localdomain> <20060120173434.GA17923@localhost.localdomain> <43D13DBD.9060600@gmx.net> <20060120210527.GA3483@localhost.localdomain> <43D158F5.3030604@gmx.net> <20060122161449.GA3966@localhost.localdomain> <43D3B76F.1010100@gmx.net>
Message-ID: <20060123094455.GA3713@localhost.localdomain>

On Sun, Jan 22, 2006 at 05:48:47PM +0100, Martin Wache wrote:
> > diff -p -u -r1.45 video-dfb.c
> > --- video-dfb.c 10 Jan 2006 19:40:25 -0000      1.45
> > +++ video-dfb.c 22 Jan 2006 16:00:29 -0000
> > @@ -1245,6 +1245,7 @@ void cDFBVideoOut::ShowOSD ()
> >          scrSurface->SetBlittingFlags(DSBLIT_BLEND_ALPHACHANNEL);
> >          scrSurface->Blit(osdSurface, &osdsrc, 0, 0);
> >        }
> > +      usleep(1000);
> >        scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
> > 
> >      }
> 
> Did you try to change the parameters for Flip()? Maybe DSFLIP_ONSYNC or
> DSFLIP_NONE helps?

I didn't try that in ShowOSD() yet, but I tried it in YUV() previously.
There was no difference, and I was not really surprised, since the
matroxEngineSync() invoked by Flip() is not waiting for vertical
retrace, but hardware idle.  That is, unless one of those flags avoids
the EngineSync altogether, it should not make any difference.  I would
guess that the wait time after the Blit or StretchBlit is rather constant.

	Marko


From M.Wache at gmx.net  Mon Jan 23 18:13:37 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 23 Jan 2006 18:13:37 +0100
Subject: [Softdevice-devel] XV-out, toggle fullscreen while	playback	paused
In-Reply-To: <1138006060.26456.5.camel@localhost.localdomain>
References: <200601221258.03713.stefan@lucke.in-berlin.de>	 <43D3809D.9060802@gmx.net>  <200601221732.48198.stefan@lucke.in-berlin.de>	 <1137987538.5518.7.camel@localhost.localdomain>	 <1138003429.43d48de556170@webmail.in-berlin.de> <1138006060.26456.5.camel@localhost.localdomain>
Message-ID: <43D50EC1.6030701@gmx.net>

Hi Torgeir!

Nice to hear from you again!

>XClearArea should be correct, as long as the last argument if false
>(don't generate expose event). See
>http://tronche.com/gui/x/xlib/graphics/XClearArea.html

That is a nice link, do know by any chance also a reference which
explains the Xextensions interface?


> On Mon, 2006-01-23 at 09:03 +0100, Stefan Lucke wrote:
>>> It's possible to ask for events being compressed to avoid this.
>> Are you referring to specifying this via hints ? 
> 
> Maybe my memory is failing me, i think it's actually the toolkit that
> does the event compression.
> 
> On an unrelated note, it would be interesting to implement render &
> composite based OSD when running under X11. 
>
Yes, that would be nice... Do you have any information on how to
implement that? I had a very brief look at the composite extension when
I rewrote the OSD, but I didn't even get the composite extension
running, so I stopped at some point...

Bye,
Martin



From anssi.hannula at gmail.com  Mon Jan 23 18:17:45 2006
From: anssi.hannula at gmail.com (Anssi Hannula)
Date: Mon, 23 Jan 2006 19:17:45 +0200
Subject: [Softdevice-devel] Apparent cache misses in yv12_to_yuy2()
In-Reply-To: <20060122132850.GA10541@localhost.localdomain>
References: <20060112212117.GB3487@localhost.localdomain> <43D261B9.4010309@gmail.com> <20060122132850.GA10541@localhost.localdomain>
Message-ID: <43D50FB9.8050601@gmail.com>

Marko M?kel? wrote:
> On Sat, Jan 21, 2006 at 06:30:49PM +0200, Anssi Hannula wrote:
> 
>>Marko M?kel? wrote:
>>
>>>The bottleneck with dfb:mgatv seems to be the yv12_to_yuy2() conversion
>>>routine.
>>
>>[...]
>>
>>>Would it even be possible to decode directly into YUY2 color space?
>>
>>I'm no expert on this colorspace stuff, but don't the G400 and up
>>support YV12 output, or am I missing something here?
> 
> 
> For VGA output (using the back-end scaler) it does.  Maybe it does also
> for TV output, but I don't know how.

When playing a file in CRTC2 with "mplayer -vo dfbmga" mplayer prints
that it's using colorspace YV12.
So either G400+ do support YV12, or the video just gets converted to
YUY2 in some later place?

-- 
Anssi Hannula



From M.Wache at gmx.net  Mon Jan 23 18:24:14 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 23 Jan 2006 18:24:14 +0100
Subject: [Softdevice-devel] XV-out, toggle fullscreen while playback paused
In-Reply-To: <200601222358.42987.stefan@lucke.in-berlin.de>
References: <200601221258.03713.stefan@lucke.in-berlin.de> <200601221732.48198.stefan@lucke.in-berlin.de> <43D3BBEB.7000801@gmx.net> <200601222358.42987.stefan@lucke.in-berlin.de>
Message-ID: <43D5113E.2090905@gmx.net>

Stefan Lucke schrieb:
> On Sonntag, 22. Januar 2006 18:07, Martin Wache wrote:
>> Stefan Lucke schrieb:
>>>> I think it's stupid to randomly only to handle every third event, and
>>>> I'm sure that this was needed because the drawing mechanism of the
>>>> softdevice was/is broken.
>>> No that's not stupid, it's just optimizing. Think of resizing. In that
>>> situation you'll get ContigureNotify on every pixel size change
>>> and a final Expose.
>>>
>> Also only every third MapNotify was handled, and MapNotify has nothing
>> to do with resizing.
> 
> You'll get MapNotify when a window gets back visible after it had been
> minimized (was invisible). So usual action should be: redraw everything.
> Action after resize op is: draw everything scaled to new size. 
> I think we should drop redraw action from MapNotify and leave complete
> redraw after event processing loop.
> 
Doing the redraw only after the event loop sounds reasonable to me.


>>
>>>> To fix your problem, isn't it enough to uncomment XvShmPutImage()?
>>> No, when going from full to windowed mode, it is required to clear
>>> the entire area. Assume displaying a 4:3 video in a 16:9 window.
>>> Without clear(), there may some parts of a previous drawn OSD left
>>> and right of the video area.
>>>
>> So I think the obvious solution is to call XClearArea() from
>> toggleFullScreen().
> 
> In toggleFullScreen() window areas have their starting dimensions
> and not the target size of this operation.
> 
Since Torgeir pointed out that we don't have to request expose events
from XClearArea() I think uncommenting the XClearArea() but changing it
to not requesting an expose event should solve the problem. And by
repleacing all XClearArea(,,true) with XClearArea(,,false) we will
probably gain a bit of performance, or am I wrong?

Bye,
Martin


From marko.makela at hut.fi  Mon Jan 23 21:30:53 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 23 Jan 2006 22:30:53 +0200
Subject: [Softdevice-devel] Crash with DVD subtitles
In-Reply-To: <43D3B508.5070307@gmx.net>
References: <20060122162152.GA3987@localhost.localdomain> <43D3B508.5070307@gmx.net>
Message-ID: <20060123203053.GA3476@localhost.localdomain>

On Sun, Jan 22, 2006 at 05:38:32PM +0100, Martin Wache wrote:
> > #0  cStreamDecoder::Action (this=0x843b258) at mpeg2decoder.c:177
> > 177       while(active)
> > (gdb) i lo
> > pkt = (AVPacket *) 0x0
> > 
> > Should I run vdr inside gdb to get better information, or does this give
> > enough ideas?
> > 
> A bit more informations would be nice. From a short look at the code pkt
> = 0 should not cause any crashes in cStreamDecoder::Action.

Sorry, wrong alarm.  It's an intentional throw in dvbspu.c:

#6  0x080a2fe5 in cDvbSpuBitmap (this=0x9324448, size=
      {x1 = 60, y1 = 462, x2 = 739, y2 = 551}, fodd=0x0, eodd=0x0, feven=0x0,
    eeven=0x0) at dvbspu.c:78
#7  0x080a3945 in cDvbSpuDecoder::setTime (this=0xafe05240, pts=261720)
    at dvbspu.c:515
#8  0xb76be572 in cDvdPlayer::seenSpuPts (this=0x839f200, pts=261720)
    at player-dvd.c:1378
#9  0xb76be95b in cDvdPlayer::seenAPTS (this=0x0, pts=0) at player-dvd.c:1371
#10 0xb76c746f in A52decoder::decode (this=0x839f25c,
    start=0xb2c4a263, size=1437, pktpts=<value optimized out>, SubStreamId=0
    at ca52.c:409
#11 0xb76c23e0 in cDvdPlayer::playPacket (this=0x839f200, cache_buf=@0x0,
    trickMode=false, noAudio=false) at player-dvd.c:1761
#12 0xb76c3391 in cDvdPlayer::Action (this=0x839f200) at player-dvd.c:1002
#13 0x081013e0 in cThread::StartThread (Thread=0x839f20c) at thread.c:243
#14 0xb7ec2cfd in start_thread () from /lib/tls/libpthread.so.0
#15 0xb7d4013e in clone () from /lib/tls/libc.so.6

This is because size.x2 >= 720.  I'll bark the right tree (the authors of
the DVD plugin).

	Marko


From marko.makela at hut.fi  Mon Jan 23 21:46:06 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 23 Jan 2006 22:46:06 +0200
Subject: [Softdevice-devel] Save 10% CPU by sleeping before IDirectFBSurface::Flip()
In-Reply-To: <43D3B76F.1010100@gmx.net>
References: <20060119162515.GC6778@localhost.localdomain> <20060119232840.GA3475@localhost.localdomain> <20060120173434.GA17923@localhost.localdomain> <43D13DBD.9060600@gmx.net> <20060120210527.GA3483@localhost.localdomain> <43D158F5.3030604@gmx.net> <20060122161449.GA3966@localhost.localdomain> <43D3B76F.1010100@gmx.net>
Message-ID: <20060123204606.GB3476@localhost.localdomain>

On Sun, Jan 22, 2006 at 05:48:47PM +0100, Martin Wache wrote:
> > Now I have two added usleep() in video-dfb.c:
> > 
> > diff -p -u -r1.45 video-dfb.c
> > --- video-dfb.c 10 Jan 2006 19:40:25 -0000      1.45
> > +++ video-dfb.c 22 Jan 2006 16:00:29 -0000
> > @@ -1245,6 +1245,7 @@ void cDFBVideoOut::ShowOSD ()
> >          scrSurface->SetBlittingFlags(DSBLIT_BLEND_ALPHACHANNEL);
> >          scrSurface->Blit(osdSurface, &osdsrc, 0, 0);
> >        }
> > +      usleep(1000);
> >        scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
> > 
> >      }
> 
> Did you try to change the parameters for Flip()? Maybe DSFLIP_ONSYNC or
> DSFLIP_NONE helps?

usleep(1000):

       19  0.3098 libdirectfb_matrox.so

DSFLIP_NONE:

     2859 33.0864 libdirectfb_matrox.so

DSFLIP_ONSYNC:

     2460 30.4117 libdirectfb_matrox.so

Test case: pause a recording and run
opcontrol --reset;opcontrol --start;sleep 4;opcontrol --stop

followed by opcontrol --global-percent|grep libdirectfb_matrox.so.
As before, the event measured was CPU_CLK_UNHALTED, count 90000.

I have tested a similar modification in YUV() earlier, and I got
similar results (i.e., sleeping is the only way to avoid busy-waiting).
Apparently, DirectFB on Matrox is always waiting for hardware idle
no matter which one of these sync methods is chosen.

	Marko

PS: In this case, the busy-waiting doubles or triples the CPU consumption
of vdr, from about 2% to 5..7% according to top.  In YUV(), the usleep()
reduces the figures reported by top by about 10%.  Going from 60% to 50%
CPU load is pretty significant.


From stefan at lucke.in-berlin.de  Mon Jan 23 21:48:27 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 23 Jan 2006 21:48:27 +0100
Subject: [Softdevice-devel] XV-out, toggle fullscreen while playback paused
In-Reply-To: <43D5113E.2090905@gmx.net>
References: <200601221258.03713.stefan@lucke.in-berlin.de> <200601222358.42987.stefan@lucke.in-berlin.de> <43D5113E.2090905@gmx.net>
Message-ID: <200601232148.27722.stefan@lucke.in-berlin.de>

On Montag, 23. Januar 2006 18:24, Martin Wache wrote:
> Stefan Lucke schrieb:
> > On Sonntag, 22. Januar 2006 18:07, Martin Wache wrote:
> >> Stefan Lucke schrieb:
> >>>> I think it's stupid to randomly only to handle every third event, and
> >>>> I'm sure that this was needed because the drawing mechanism of the
> >>>> softdevice was/is broken.
> >>> No that's not stupid, it's just optimizing. Think of resizing. In that
> >>> situation you'll get ContigureNotify on every pixel size change
> >>> and a final Expose.
> >>>
> >> Also only every third MapNotify was handled, and MapNotify has nothing
> >> to do with resizing.
> > 
> > You'll get MapNotify when a window gets back visible after it had been
> > minimized (was invisible). So usual action should be: redraw everything.
> > Action after resize op is: draw everything scaled to new size. 
> > I think we should drop redraw action from MapNotify and leave complete
> > redraw after event processing loop.
> > 
> Doing the redraw only after the event loop sounds reasonable to me.
> 
> 
> >>
> >>>> To fix your problem, isn't it enough to uncomment XvShmPutImage()?
> >>> No, when going from full to windowed mode, it is required to clear
> >>> the entire area. Assume displaying a 4:3 video in a 16:9 window.
> >>> Without clear(), there may some parts of a previous drawn OSD left
> >>> and right of the video area.
> >>>
> >> So I think the obvious solution is to call XClearArea() from
> >> toggleFullScreen().
> > 
> > In toggleFullScreen() window areas have their starting dimensions
> > and not the target size of this operation.
> > 
> Since Torgeir pointed out that we don't have to request expose events
> from XClearArea() I think uncommenting the XClearArea() but changing it
> to not requesting an expose event should solve the problem. And by
> repleacing all XClearArea(,,true) with XClearArea(,,false) we will
> probably gain a bit of performance, or am I wrong?

I changed most of them to "False". I left True in Initialize() and
Reconfigure().

First commit since (2005-11-16). 

-- 
Stefan Lucke



From inssomniak at mountaincable.net  Thu Jan 26 17:39:57 2006
From: inssomniak at mountaincable.net (Dave)
Date: Thu, 26 Jan 2006 11:39:57 -0500
Subject: [Softdevice-devel] Softdevice and Dolby Digital
Message-ID: <43D8FB5D.8090404@mountaincable.net>

I recently bought a new Dolby digital receiver, a Yamaha model, fully 
loaded job, and on this receiver, using dolby digital with softdevice 
cuts in and out, on some channels the audio will only come in for a few 
seconds at a time.  Others it can go 10-15 minutes before it cuts out, 
and the indicators flash from PCM to dolby digital during the cut-out of 
the sound.  My old Kenwood dolby digital receiver did not exibit this 
problem.  I can play an ac3 stream using ac3dec or mplayer perfectly.  
Any ideas what might cause this? 

Thanks!


From noreply at berlios.de  Tue Jan 31 19:25:16 2006
From: noreply at berlios.de (noreply at berlios.de)
Date: Tue, 31 Jan 2006 09:25:16 -0900 (AKST)
Subject: [Softdevice-devel] [Bug #6252] compiler fehler
Message-ID: <200601311825.k0VIPG7p005047@unicorn.berlios.de>

Bug #6252, was updated on 2006-Jan-31 09:25
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: general
Status: Open
Resolution: None
Bug Group: None
Priority: 5
Submitted by: daliman
Assigned to : none
Summary: compiler fehler

Details: Beim compilieren von softdevice mit SHM_SUPPORT=1, gibt es die Fehlermeldung: "video-shm.h:28: error: ISO C++ forbids declaration of 'cShmRemote' with no type
video-shm.h:28: error: expected ';' before '*' token"
Ich nutze gcc 4.0.2.



For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=6252&group_id=2051


From eddi at depieri.net  Wed Feb  1 11:03:17 2006
From: eddi at depieri.net (Eddi)
Date: Wed, 1 Feb 2006 11:03:17 +0100
Subject: [Softdevice-devel] Softdevice-xv and OSD trouble
Message-ID: <20060201100337.36A572183B1@tux.dpeddi.com>

Hi,
 
I've a strange problem with vdr and softdevice using xv plugin.
 
Softdevice works correctly, video-out using softdevice work, by pressing
buttons on my remote or keyboard, appear OSD menu, but after about 10-15
minutes, OSD doesn't appear any more.
Keyboard/lirc input works even if OSD doesn't appear.
 
I tried to run vdr from console but I haven't warning about this issue.
 
I haven't tested if with other video output (dfb, vidix, etc) I get the same
issue.
 
Same issue softdevice-0.1.1, softdevice-0.2.1 and softdevice-cvs.
 
I tried to upgrade to check if issue has been solved.
 
Best regards,
 
Eddi
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060201/86d8d6d6/attachment.html>

From M.Wache at gmx.net  Fri Feb  3 19:45:33 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Fri, 03 Feb 2006 19:45:33 +0100
Subject: [Softdevice-devel] Softdevice-xv and OSD trouble
In-Reply-To: <20060201100337.36A572183B1@tux.dpeddi.com>
References: <20060201100337.36A572183B1@tux.dpeddi.com>
Message-ID: <43E3A4CD.4080706@gmx.net>

Eddi schrieb:
> Hi,
>  
> I've a strange problem with vdr and softdevice using xv plugin.
>  
> Softdevice works correctly, video-out using softdevice work, by pressing
> buttons on my remote or keyboard, appear OSD menu, but after about 10-15
> minutes, OSD doesn't appear any more.
> Keyboard/lirc input works even if OSD doesn't appear.
>  
That is strange... I don't remember any similar bug report
What graphics card are you using? What's your X version?
Does it help to restart vdr to get the OSD back?

As a workaround you can probably use software alpha blending, or
disappears the OSD there also?

Bye,
Martin


From eddi at depieri.net  Sat Feb  4 00:58:28 2006
From: eddi at depieri.net (Eddi)
Date: Sat, 4 Feb 2006 00:58:28 +0100
Subject: R: [Softdevice-devel] Softdevice-xv and OSD trouble
In-Reply-To: <43E3A4CD.4080706@gmx.net>
Message-ID: <20060203235821.5DD372183B1@tux.dpeddi.com>

Eddi schrieb:
> Hi,
>  
> I've a strange problem with vdr and softdevice using xv plugin.
>  
> Softdevice works correctly, video-out using softdevice work, by pressing
> buttons on my remote or keyboard, appear OSD menu, but after about 10-15
> minutes, OSD doesn't appear any more.
> Keyboard/lirc input works even if OSD doesn't appear.
>  
>That is strange... I don't remember any similar bug report
>What graphics card are you using? 
i815 graphic card integrated in i810 chipset

>What's your X version?
Problem first seen on Xorg on Debian sid.
Debian xorg but I don't remember the version
I upgraded/changed distro to Ubuntu Breezy and the problem persist 
Ubuntu (6.8.2-77)

>Does it help to restart vdr to get the OSD back?
Yes by restarting vdr, I get OSD back

>As a workaround you can probably use software alpha blending, or
>disappears the OSD there also?
At the moment I tested with pseudo (and it is quite fast)
Now you suggest me, I'm testing with software mode. But I think is very too
slow.

It seems in software mode it doesn't hangs, but what may be that make OSD in
pseudo mode to hang?

Best regards

Eddi



From stefan at lucke.in-berlin.de  Sat Feb  4 10:21:55 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 4 Feb 2006 10:21:55 +0100
Subject: R: [Softdevice-devel] Softdevice-xv and OSD trouble
In-Reply-To: <20060203235821.5DD372183B1@tux.dpeddi.com>
References: <20060203235821.5DD372183B1@tux.dpeddi.com>
Message-ID: <200602041021.55892.stefan@lucke.in-berlin.de>

On Samstag, 4. Februar 2006 00:58, Eddi wrote:
> Eddi schrieb:
> > Hi,
> >  
> > I've a strange problem with vdr and softdevice using xv plugin.
> >  
> > Softdevice works correctly, video-out using softdevice work, by pressing
> > buttons on my remote or keyboard, appear OSD menu, but after about 10-15
> > minutes, OSD doesn't appear any more.
> > Keyboard/lirc input works even if OSD doesn't appear.

Broken color keying by driver (again) ?

> >  
> >That is strange... I don't remember any similar bug report
> >What graphics card are you using? 
> i815 graphic card integrated in i810 chipset
> 
> >What's your X version?
> Problem first seen on Xorg on Debian sid.
> Debian xorg but I don't remember the version
> I upgraded/changed distro to Ubuntu Breezy and the problem persist 
> Ubuntu (6.8.2-77)

> 
> >Does it help to restart vdr to get the OSD back?
> Yes by restarting vdr, I get OSD back

And moving the window around the screen ?
Whats the color depth of your screen (15, 16, 24 or 32 bit) ?
Please try 24 or 32 color depth.

> 
> >As a workaround you can probably use software alpha blending, or
> >disappears the OSD there also?
> At the moment I tested with pseudo (and it is quite fast)
> Now you suggest me, I'm testing with software mode. But I think is very too
> slow.
> 
> It seems in software mode it doesn't hangs, but what may be that make OSD in
> pseudo mode to hang?

I guess it doesn't hang, but the drawing mechanism (the way OSD and video
are mixed) is somehow broken in a few drivers. 

-- 
Stefan Lucke



From noreply at berlios.de  Sat Feb  4 11:24:58 2006
From: noreply at berlios.de (noreply at berlios.de)
Date: Sat, 4 Feb 2006 11:24:58 +0100 (CET)
Subject: [Softdevice-devel] [Bug #6252] compiler fehler
Message-ID: <200602041024.k14AOwNa004492@unicorn.berlios.de>

Bug #6252, was updated on 2006-Jan-31 19:25
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: general
Status: Closed
Resolution: None
Bug Group: None
Priority: 5
Submitted by: daliman
Assigned to : none
Summary: compiler fehler

Details: Beim compilieren von softdevice mit SHM_SUPPORT=1, gibt es die Fehlermeldung: "video-shm.h:28: error: ISO C++ forbids declaration of 'cShmRemote' with no type
video-shm.h:28: error: expected ';' before '*' token"
Ich nutze gcc 4.0.2.



Follow-Ups:

Date: 2006-Feb-04 11:24
By: wachm

Comment:
should be fixed in the CVS. Please try again.
-------------------------------------------------------

For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=6252&group_id=2051


From noreply at berlios.de  Sun Feb  5 00:22:55 2006
From: noreply at berlios.de (noreply at berlios.de)
Date: Sat, 4 Feb 2006 14:22:55 -0900 (AKST)
Subject: [Softdevice-devel] [Bug #6298] ShmClient
Message-ID: <200602042322.k14NMtGF020056@unicorn.berlios.de>

Bug #6298, was updated on 2006-Feb-04 14:22
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: general
Status: Open
Resolution: None
Bug Group: None
Priority: 5
Submitted by: daliman
Assigned to : none
Summary: ShmClient

Details: Mit der aktuellen CVS-Version ist des Compilieren von Softdevice mit ShmSupport m?glich, jedoch kann man den ShmClient nicht compilieren.

./../../tools.o: In function `RgbToJpeg(unsigned char*, int, int, int&, int)':
/usr/src/VDR/tools.c:759: undefined reference to `jpeg_std_error'
/usr/src/VDR/tools.c:760: undefined reference to `jpeg_CreateCompress'
/usr/src/VDR/tools.c:769: undefined reference to `jpeg_set_defaults'
/usr/src/VDR/tools.c:770: undefined reference to `jpeg_set_quality'
/usr/src/VDR/tools.c:771: undefined reference to `jpeg_start_compress'
/usr/src/VDR/tools.c:777: undefined reference to `jpeg_write_scanlines'
/usr/src/VDR/tools.c:778: undefined reference to `jpeg_finish_compress'
/usr/src/VDR/tools.c:779: undefined reference to `jpeg_destroy_compress'
../../../config.o: In function `cSetup::Save()':
/usr/src/VDR/config.c:725: undefined reference to `cDevice::numDevices'
/usr/src/VDR/config.c:726: undefined reference to `cDevice::numDevices'


For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=6298&group_id=2051


From noreply at berlios.de  Mon Feb  6 20:18:24 2006
From: noreply at berlios.de (noreply at berlios.de)
Date: Mon, 6 Feb 2006 20:18:24 +0100 (CET)
Subject: [Softdevice-devel] [Bug #6298] ShmClient
Message-ID: <200602061918.k16JIOEI027135@unicorn.berlios.de>

Bug #6298, was updated on 2006-Feb-05 00:22
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: general
Status: Closed
Resolution: None
Bug Group: None
Priority: 5
Submitted by: daliman
Assigned to : none
Summary: ShmClient

Details: Mit der aktuellen CVS-Version ist des Compilieren von Softdevice mit ShmSupport m?glich, jedoch kann man den ShmClient nicht compilieren.

./../../tools.o: In function `RgbToJpeg(unsigned char*, int, int, int&, int)':
/usr/src/VDR/tools.c:759: undefined reference to `jpeg_std_error'
/usr/src/VDR/tools.c:760: undefined reference to `jpeg_CreateCompress'
/usr/src/VDR/tools.c:769: undefined reference to `jpeg_set_defaults'
/usr/src/VDR/tools.c:770: undefined reference to `jpeg_set_quality'
/usr/src/VDR/tools.c:771: undefined reference to `jpeg_start_compress'
/usr/src/VDR/tools.c:777: undefined reference to `jpeg_write_scanlines'
/usr/src/VDR/tools.c:778: undefined reference to `jpeg_finish_compress'
/usr/src/VDR/tools.c:779: undefined reference to `jpeg_destroy_compress'
../../../config.o: In function `cSetup::Save()':
/usr/src/VDR/config.c:725: undefined reference to `cDevice::numDevices'
/usr/src/VDR/config.c:726: undefined reference to `cDevice::numDevices'


Follow-Ups:

Date: 2006-Feb-06 20:18
By: wachm

Comment:
Fixed for vdr-1.3.42, if it still doesn't work for you please report
your vdr version.
-------------------------------------------------------

For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=6298&group_id=2051


From stefan at lucke.in-berlin.de  Sat Feb 11 16:13:53 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 11 Feb 2006 16:13:53 +0100
Subject: [Softdevice-devel] [PATCH] Fix softdevice compilation for AMD64
In-Reply-To: <43C6CE17.3030106@gmail.com>
References: <43C6CE17.3030106@gmail.com>
Message-ID: <200602111613.53160.stefan@lucke.in-berlin.de>

On Donnerstag, 12. Januar 2006 22:45, Janne Huttunen wrote:
> 
> This patch makes softdevice compile again on AMD64.
> Works for me(tm).
> 

> Index: video-fb.c
> ===================================================================
> RCS file: /cvsroot/softdevice/softdevice/video-fb.c,v
> retrieving revision 1.10
> diff -u -r1.10 video-fb.c
> --- video-fb.c	7 Jan 2006 14:28:39 -0000	1.10
> +++ video-fb.c	12 Jan 2006 17:07:34 -0000
> @@ -135,7 +135,7 @@
>  
>      OSDpresent=false;
>  
> -    printf("[video-fb] init %d x %d (Size: %d Bytes LineLen %d) Bpp: %d\n",fb_vinfo.xres, fb_vinfo.yres, size, line_len, fb_vinfo.bits_per_pixel);
> +    printf("[video-fb] init %d x %d (Size: %zu Bytes LineLen %d) Bpp: %d\n",fb_vinfo.xres, fb_vinfo.yres, size, line_len, fb_vinfo.bits_per_pixel);

As "%zu" failes for me on my old prod vdr:

video-fb.c: In method `cFBVideoOut::cFBVideoOut(cSetupStore *)':
video-fb.c:137: warning: unknown conversion type character `z' in format
video-fb.c:137: warning: too many arguments for format

I consider "too many arguments" as an error.

is there any other format string to printf size_t type  values on AMD64 ?
Or does casting "size" to "(unsigned int) size" work?

>      // clear screens
>      printf("[video-fb] Clearing the FB\n");
>      unsigned char * fbinit;


-- 
Stefan Lucke



From stefan at lucke.in-berlin.de  Sat Feb 11 16:28:09 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 11 Feb 2006 16:28:09 +0100
Subject: [Softdevice-devel] Strange compile error in SoftOsd.c
Message-ID: <200602111628.09190.stefan@lucke.in-berlin.de>

Hi,

Martin I guess the following change is aquivalent:
Index: SoftOsd.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
retrieving revision 1.6
diff -b -B -U3 -r1.6 SoftOsd.c
--- SoftOsd.c   4 Feb 2006 10:05:09 -0000       1.6
+++ SoftOsd.c   11 Feb 2006 15:25:18 -0000
@@ -1347,9 +1347,7 @@
         int16_t g2=0;
         int16_t r2=0;
 #else
-        __asm__(
-                 " pxor %%mm7,%%mm7 \n" //mm7: 00 00 00 ...
-                 : :   );
+        pxor_r2r (mm7,mm7);
 #endif

         int32_t pos=start_pos;


Without that, I get the following error with gcc 2.95.3:
g++ -O2 -g -Wall -fPIC -Woverloaded-virtual -c -DHAVE_CONFIG -DPLUGIN_NAME_I18N='"softdevice"' -D_GNU_SOURCE -DPLUGINLIBDIR='"./PLUGINS/lib"' -I../../../include -I../../../../DVB/include -I/usr/local/include -I/usr/local/include/ffmpeg -I/usr/local/include/postproc   -D_REENTRANT -D_GNU_SOURCE -I/usr/local/include/directfb -I/usr/local/include/dfb++   SoftOsd.c
/tmp/cciMiMh0.s: Assembler messages:
/tmp/cciMiMh0.s:6269: Error: bad register name `%%mm7'

:-(( .

-- 
Stefan Lucke



From M.Wache at gmx.net  Sat Feb 11 17:55:38 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sat, 11 Feb 2006 17:55:38 +0100
Subject: [Softdevice-devel] Strange compile error in SoftOsd.c
In-Reply-To: <200602111628.09190.stefan@lucke.in-berlin.de>
References: <200602111628.09190.stefan@lucke.in-berlin.de>
Message-ID: <43EE170A.60109@gmx.net>

Stefan Lucke schrieb:
> Hi,
> 
> Martin I guess the following change is aquivalent:
> Index: SoftOsd.c
> ===================================================================
> RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
> retrieving revision 1.6
> diff -b -B -U3 -r1.6 SoftOsd.c
> --- SoftOsd.c   4 Feb 2006 10:05:09 -0000       1.6
> +++ SoftOsd.c   11 Feb 2006 15:25:18 -0000
> @@ -1347,9 +1347,7 @@
>          int16_t g2=0;
>          int16_t r2=0;
>  #else
> -        __asm__(
> -                 " pxor %%mm7,%%mm7 \n" //mm7: 00 00 00 ...
> -                 : :   );
> +        pxor_r2r (mm7,mm7);
>  #endif
> 
>          int32_t pos=start_pos;
> 
> 
> Without that, I get the following error with gcc 2.95.3:
> g++ -O2 -g -Wall -fPIC -Woverloaded-virtual -c -DHAVE_CONFIG -DPLUGIN_NAME_I18N='"softdevice"' -D_GNU_SOURCE -DPLUGINLIBDIR='"./PLUGINS/lib"' -I../../../include -I../../../../DVB/include -I/usr/local/include -I/usr/local/include/ffmpeg -I/usr/local/include/postproc   -D_REENTRANT -D_GNU_SOURCE -I/usr/local/include/directfb -I/usr/local/include/dfb++   SoftOsd.c
> /tmp/cciMiMh0.s: Assembler messages:
> /tmp/cciMiMh0.s:6269: Error: bad register name `%%mm7'
> 
> :-(( .
> 
I guess you mean g++ 2.95.3, the debian gcc 2.95.4 I tried compiled my
test case fine, while g++ 2.95.4 didn't. g++ 2.95.4 is getting on my
nerves......

Technically what your're proposing is the same, but I really dislike
that macro mmx programming style. I tried to find a simple solution
avoiding to use the macros but I failed. Here are some examples:

__asm__ __volatile__ ("pxor" " %" "mm7" ", %" "mm7" : : );

fails on g++ 3.3.5 (Debian) but works on  g++ 2.95.4 (Debian) and gcc 2.95.4

__asm__ __volatile__ ("pxor" " %" "mm7" ", %" "mm7" );
indeed works on all and is what pxor_r2r(mm7,mm7) translates into.

But you call that readable? Well try to remove the extra '"' and it will
fail to compile on g++ 3.3.5....

Ok, another try... I know that code like this exits for some time in the
softdevice, like the software alpha blend code. There we have:

       __asm__(" pxor %%mm3,%%mm3\n"
#ifdef USE_MMX2
                PREFETCH"(%0)\n"
                PREFETCH"(%1)\n"
                PREFETCH"(%2)\n"
                PREFETCH"64(%0)\n"
                PREFETCH"64(%1)\n"
                PREFETCH"64(%2)\n"
                PREFETCH"128(%0)\n"
                PREFETCH"128(%1)\n"
                PREFETCH"128(%2)\n"
#endif //USE_MMX2
                : : "r" (P1), "r" (P2), "r" (alpha) : "memory");

which is exactly the same which failes now on g++ 2.95.4, no not exactly
the failures were for:

__asm__(
               " pxor %%mm7,%%mm7 \n" //mm7: 00 00 00 ...
                : :   );
which has an empty register list. So I added a register:

       int dummy;
       __asm__(
                " pxor %%mm7,%%mm7 \n" //mm7: 00 00 00 ...
                 : : "r"(dummy)   );

Guess what? That works...
So I tried to remove the ":" which indicates the start of the empty
register list (maybe it doesn't like empty lists?) Doesn't work. No
surprise to me anymore...

Now can anyone explain that to me? That is *really* the strangest
behaviour I've _ever_ seen!

Stefan, I like the option of some dummy registers much more than the mmx
macros... Converting all mmx calculations is _not_ an option to me, and
I don't like mixing them in the same function.
I have only limited access to a computer running g++ 2.95.4, so can you
prepare a patch which fixes this? I will try to find a simpler solution
and faster, but I can't promise :-(

Bye,
Martin


From M.Wache at gmx.net  Sat Feb 11 18:04:28 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sat, 11 Feb 2006 18:04:28 +0100
Subject: [Softdevice-devel] Strange compile error in SoftOsd.c
In-Reply-To: <43EE170A.60109@gmx.net>
References: <200602111628.09190.stefan@lucke.in-berlin.de> <43EE170A.60109@gmx.net>
Message-ID: <43EE191C.6000809@gmx.net>

Martin Wache schrieb:
> Stefan Lucke schrieb:
>> Hi,
>>
>> Martin I guess the following change is aquivalent:
>> Index: SoftOsd.c
>> ===================================================================
>> RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
>> retrieving revision 1.6
>> diff -b -B -U3 -r1.6 SoftOsd.c
>> --- SoftOsd.c   4 Feb 2006 10:05:09 -0000       1.6
>> +++ SoftOsd.c   11 Feb 2006 15:25:18 -0000
>> @@ -1347,9 +1347,7 @@
>>          int16_t g2=0;
>>          int16_t r2=0;
>>  #else
>> -        __asm__(
>> -                 " pxor %%mm7,%%mm7 \n" //mm7: 00 00 00 ...
>> -                 : :   );
>> +        pxor_r2r (mm7,mm7);
>>  #endif
>>

Ok, I think this is the best solution:
        __asm__(
                 " pxor %%mm7,%%mm7 \n" //mm7: 00 00 00 ...
                  : : : "memory"  );

It just adds memory to the clobber list, which is not entirely correct,
but it should also not be wrong. And since it is at the beginning of the
function there should not be a speed disadvantage with this solutions.

Bye,
Martin


From stefan at lucke.in-berlin.de  Sat Feb 11 19:27:14 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 11 Feb 2006 19:27:14 +0100
Subject: [Softdevice-devel] Strange compile error in SoftOsd.c
In-Reply-To: <43EE191C.6000809@gmx.net>
References: <200602111628.09190.stefan@lucke.in-berlin.de> <43EE170A.60109@gmx.net> <43EE191C.6000809@gmx.net>
Message-ID: <200602111927.14992.stefan@lucke.in-berlin.de>

On Samstag, 11. Februar 2006 18:04, Martin Wache wrote:
> Martin Wache schrieb:
> > Stefan Lucke schrieb:
> >> Hi,
> >>
> >> Martin I guess the following change is aquivalent:
> >> Index: SoftOsd.c
> >> ===================================================================
> >> RCS file: /cvsroot/softdevice/softdevice/SoftOsd.c,v
> >> retrieving revision 1.6
> >> diff -b -B -U3 -r1.6 SoftOsd.c
> >> --- SoftOsd.c   4 Feb 2006 10:05:09 -0000       1.6
> >> +++ SoftOsd.c   11 Feb 2006 15:25:18 -0000
> >> @@ -1347,9 +1347,7 @@
> >>          int16_t g2=0;
> >>          int16_t r2=0;
> >>  #else
> >> -        __asm__(
> >> -                 " pxor %%mm7,%%mm7 \n" //mm7: 00 00 00 ...
> >> -                 : :   );
> >> +        pxor_r2r (mm7,mm7);
> >>  #endif
> >>
> 
> Ok, I think this is the best solution:
>         __asm__(
>                  " pxor %%mm7,%%mm7 \n" //mm7: 00 00 00 ...
>                   : : : "memory"  );
> 
> It just adds memory to the clobber list, which is not entirely correct,
> but it should also not be wrong. And since it is at the beginning of the
> function there should not be a speed disadvantage with this solutions.

So I'll stick to this version, as this compiles for both gcc 2.95.3
and 3.3.1 . Luckily gcc and g++ report the same version numbers.

-- 
Stefan Lucke



From Neumann at do-net.de  Sat Feb 11 20:12:25 2006
From: Neumann at do-net.de (Andre Neumann)
Date: Sat, 11 Feb 2006 20:12:25 +0100
Subject: [Softdevice-devel] DFB Matrox Hardware Deinterlace
Message-ID: <FB3B5DB3197CEA429E5FB8E83D01D039D14D@sbs2003.do-net.de>

Hi list,
 
i asked that some weeks ago, but now i have the answer.
 
I asked, if the matrox can do deinterlacing in hardware, and yes, it is true.
The Matrox can do it, and it works good. Not with softdevice,
but i tested vdr-xine plugin with df_xine. It works great and it is very fast.
With the vdr-xine plugin an df_xine i can watch HD1 channel without stuttering, cpu is about 90%.
 
Since df_xine can use the hardware deinterlacing, im sure softdevice can do it aswell.
Since im not a programmer, i wanted to ask
if someone (maybe Stefan or Martin) could take a look at it. 
 
Here is df_xine: http://www.directfb.org/index.php/viewcvs.cgi/DirectFB-extra/samples/df_xine/
 
-----------------------
Andre Neumann




From stefan at lucke.in-berlin.de  Sat Feb 11 21:26:45 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 11 Feb 2006 21:26:45 +0100
Subject: [Softdevice-devel] DFB Matrox Hardware Deinterlace
In-Reply-To: <FB3B5DB3197CEA429E5FB8E83D01D039D14D@sbs2003.do-net.de>
References: <FB3B5DB3197CEA429E5FB8E83D01D039D14D@sbs2003.do-net.de>
Message-ID: <200602112126.45707.stefan@lucke.in-berlin.de>

On Samstag, 11. Februar 2006 20:12, Andre Neumann wrote:
> Hi list,
>  
> i asked that some weeks ago, but now i have the answer.
>  
> I asked, if the matrox can do deinterlacing in hardware, and yes, it is true.

My impression is: this is not true. Around line 770 in video-dfb.c
you'll find some code that is deactivated (DSCAPS_INTERLACED) .
You may activate this for a test. DirectFBs use of this flag is line doubling.
Or when dealing  blitting with flag DSBLIT_DEINTERLACE:
http://www.directfb.org/docs/DirectFB_Reference/types.html#DFBSurfaceBlittingFlags

What could be done is: double frame rate by use of these flags.
Use field 0 and do upscaling, use field 1 (SetField(1);) and do it too.

But activating this part of code will result in poor quality when video
has a small resolution like 352x288.

There is something still on the todo list like doubling frame rate.
Modern LCD-TVs use higher refresh rates and any scaling
(especially downscaling) of interlaced material, should be done
for each field separate. That applies to normal TVs too.

> The Matrox can do it, and it works good. Not with softdevice,
> but i tested vdr-xine plugin with df_xine. It works great and it is very fast.
> With the vdr-xine plugin an df_xine i can watch HD1 channel without stuttering, cpu is about 90%.
>  
> Since df_xine can use the hardware deinterlacing, im sure softdevice can do it aswell.
> Since im not a programmer, i wanted to ask
> if someone (maybe Stefan or Martin) could take a look at it. 
>  
> Here is df_xine: http://www.directfb.org/index.php/viewcvs.cgi/DirectFB-extra/samples/df_xine/
>  

Xine has some buildin software deinterlace funtions.

But to my knowledge there is no additional deinterlacer on matrox cards
beside the already used hardware scaling functions.

-- 
Stefan Lucke



From inssomniak at mountaincable.net  Sat Feb 11 22:03:09 2006
From: inssomniak at mountaincable.net (Dave)
Date: Sat, 11 Feb 2006 16:03:09 -0500
Subject: [Softdevice-devel] DFB Matrox Hardware Deinterlace
In-Reply-To: <200602112126.45707.stefan@lucke.in-berlin.de>
References: <FB3B5DB3197CEA429E5FB8E83D01D039D14D@sbs2003.do-net.de> <200602112126.45707.stefan@lucke.in-berlin.de>
Message-ID: <43EE510D.5080401@mountaincable.net>


Stefan Lucke wrote:

>On Samstag, 11. Februar 2006 20:12, Andre Neumann wrote:
>  
>
>>Hi list,
>> 
>>i asked that some weeks ago, but now i have the answer.
>> 
>>I asked, if the matrox can do deinterlacing in hardware, and yes, it is true.
>>    
>>
>
>My impression is: this is not true. Around line 770 in video-dfb.c
>you'll find some code that is deactivated (DSCAPS_INTERLACED) .
>You may activate this for a test. DirectFBs use of this flag is line doubling.
>Or when dealing  blitting with flag DSBLIT_DEINTERLACE:
>http://www.directfb.org/docs/DirectFB_Reference/types.html#DFBSurfaceBlittingFlags
>
>What could be done is: double frame rate by use of these flags.
>Use field 0 and do upscaling, use field 1 (SetField(1);) and do it too.
>
>But activating this part of code will result in poor quality when video
>has a small resolution like 352x288.
>
>There is something still on the todo list like doubling frame rate.
>Modern LCD-TVs use higher refresh rates and any scaling
>(especially downscaling) of interlaced material, should be done
>for each field separate. That applies to normal TVs too.
>
>  
>
>>The Matrox can do it, and it works good. Not with softdevice,
>>but i tested vdr-xine plugin with df_xine. It works great and it is very fast.
>>With the vdr-xine plugin an df_xine i can watch HD1 channel without stuttering, cpu is about 90%.
>> 
>>Since df_xine can use the hardware deinterlacing, im sure softdevice can do it aswell.
>>Since im not a programmer, i wanted to ask
>>if someone (maybe Stefan or Martin) could take a look at it. 
>> 
>>Here is df_xine: http://www.directfb.org/index.php/viewcvs.cgi/DirectFB-extra/samples/df_xine/
>> 
>>    
>>
>
>Xine has some buildin software deinterlace funtions.
>
>But to my knowledge there is no additional deinterlacer on matrox cards
>beside the already used hardware scaling functions.
>  
>

I put softdevice and xine side by side running on directfb and 
softdevice won hands down for deinterlacing (albeight i dont watch HD 
channels), I did not try df_xine as it wont compile for me.  Even up 
against xine's apparently superior software tvtime deinterlacer I still 
saw interlacing artifacts in the picture as with softdevice I see 
absolutely none (lavc, median) I use an LCD projector, the image size is 
112 inches 4:3 aspect

I would be interested in trying out/debugging any other deinterlacing 
methods softdevice could do, I as well use a matrox with directfb, the 
more that can be done in hardware the better I always say :)  flipping 
modes of deinterlacing depending on resolution might be an option, but I 
rarely see 352x288 resolution anymore, most for me is 544x480, it is 
upscaled to 800x600 to match my projector

Thanks

Dave


From torgeir at pobox.com  Sun Feb 12 11:52:08 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Sun, 12 Feb 2006 20:52:08 +1000
Subject: [Softdevice-devel] x11 documentation links
Message-ID: <1139741528.8399.15.camel@localhost.localdomain>

http://www.rahul.net/kenton/xsites.html

-- 
Torgeir Veimo <torgeir at pobox.com>



From stefan at lucke.in-berlin.de  Sun Feb 12 19:36:53 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 12 Feb 2006 19:36:53 +0100
Subject: [Softdevice-devel] [ANNOUNCE] vdr-softdevice-0.2.2
Message-ID: <200602121936.53613.stefan@lucke.in-berlin.de>

Hello,

softdevice team (Torgeir Veimo, Martin Wache and me, Stefan Lucke)
is pleased to announce a new release of vdr softdevice plugin.

General info:
? Softdevice plugin enables vdr to run on your desktop with
? so called budget cards. You'll get vdr output via framebuffer or X11-Xv or
? DirectFB or vidix to your screen. Decoding is done via ffmpeg.

Plugin's homepage is located at: http://softdevice.berlios.de/

Changelog since last release:
2006-02-12: softdevice-0.2.2
2006-02-11:
   - some minor fixes:
       - OSD redrawing with dfb-out when switching from StretchBlit to BES mode
       - compiling with SoftOsd.c with gcc 2.95.3
2006-02-06:
   - don't start ShmClient in fullscreen mode by default
   - some more documentation
   - disable debuging information
   - fix linking of ShmClient with vdr-1.3.42
   - add usleep to ShmClient (to avoid busy loop in case there are no
     semaphores)
   - fix for vdr-1.3.42 compatibility
   - disable some trace messages
2006-02-03:
   - remove unused code, variables and parameters from video-xv
   - add more documentation to the readme
   - fix ShmClient pixel[] array initialisation
   - compile fix for video-shm.h
   - some fixes in the osd handling of video-shm
   - added NoVScaleCopyToBitmap() vor YUV mode
   - fix thread termination in cSoftOsd
   - make sure that strides are multiples of 16 in cSoftOsd
2006-02-03:
   - remove cSoftOsd and cOsd dependency from cVideoOut. Size and
     Mode changes are now handled by a thread from cSoftOsd.
   - introduce separate OSD layer in ShmClient/video-shm
2006-01-19:
   - now correct fix for CheckArea() not updating the aspect ratio
2006-01-17:
   - add video-shm and ShmClient, a simple server/client model for the
     softdevice. See the file README for details.
2006-01-15:
   - compile fix for vdr-1.2.6
   - fix for AMD64 builds (patch by Janne Huttunen, many thanks to him)
2006-01-10:
   - fix error message from DirectFB about wrong blitting area with new OSD
2006-01-09:
    - add missing sanity check in cSoftOsd::DrawConvertBitmap()
      (many thanks to Andre Neumann for reporting the problem)
2006-01-08:
    - fix segfault in cSoftOsd for lines longer than 1024
      (thanks to Andre Neumann for reporting the problem)
    - updated video-dfb for the new OSD. Double buffered displays should
work now as well and the OSD mode is set properly
2006-01-07:
    - completely rewritten OSD. Supports up- and down-scaleing in MMX
    - add sfence and emms to yv12_to_yuy2()
    - on resume try to open audio-out in non-blocking mode
2005-12-15:
    - use fast_memcpy in dfb out
2005-11-30:
    - g++-2.95 complaints about "::" in inline asm and wants ": :" instead.

-- 
Stefan Lucke



From inssomniak at mountaincable.net  Sun Feb 12 20:27:33 2006
From: inssomniak at mountaincable.net (Dave)
Date: Sun, 12 Feb 2006 14:27:33 -0500
Subject: [Softdevice-devel] desperate plea to stop dolby digital cut outs
Message-ID: <43EF8C25.8090202@mountaincable.net>

I use SPDIF 5.1 mode with softdevice, and the dolby digital cuts in and 
out during periods of "xruns" (PCM does too but only for a tiny fraction 
of a second), the dolby digital can cut out for more than a second, 
while the av receiver re-syncs  the bitstream.  Is a better quality 
sound card going to fix this? what causes it? Ill go get a good quality 
sound card if it will fix it, but Im not sure that it will.  Any thoughts?




From stefan at lucke.in-berlin.de  Sun Feb 12 21:13:23 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 12 Feb 2006 21:13:23 +0100
Subject: [Softdevice-devel] desperate plea to stop dolby digital cut outs
In-Reply-To: <43EF8C25.8090202@mountaincable.net>
References: <43EF8C25.8090202@mountaincable.net>
Message-ID: <200602122113.23439.stefan@lucke.in-berlin.de>

On Sonntag, 12. Februar 2006 20:27, Dave wrote:
> I use SPDIF 5.1 mode with softdevice, and the dolby digital cuts in and 
> out during periods of "xruns" (PCM does too but only for a tiny fraction 
> of a second), the dolby digital can cut out for more than a second, 
> while the av receiver re-syncs  the bitstream.  Is a better quality 
> sound card going to fix this?

Just for interest: whats your current card ?

> what causes it?

Even if normal audio is streamed as 48KHz or other sample frequencies,
there is slight difference between A/D sampling and D/A conversion.
Let's guess A/D is done at 47990Hz and D/A at 48100Hz. With this
setup it is obvious that you'll get some Xruns during playback.
For PCM output we could think of a resampling logic that adjusts audio
rate to video rate (sync on video).
In case DD5.1 things are more complicated: Decode 5.1, resample
all 6 channels, reencode them to DD5.1 and then output via SPDIF.

With decoding/encoding there could be some patent issues I guess :-( .

> Ill go get a good quality 
> sound card if it will fix it, but Im not sure that it will.  Any thoughts?

The ideal solution would be a sound card that would allow some
software controlled adjustments of the PLL which clocks PCM/SPDIF out.
But unfortunatly I've never heard of such a card (or searched for the
wrong keywords).

Another way would be some finetuning of the video refresh rate.

Ideally both (audio and video PLLs) should be adjusted to incoming
reference clock.

For long resync periods of your A/V receiver, I'll think I should
have a closer look at bitstream-out code. This FF-card plugin has
some better underrun and overruns handling code I guess.

-- 
Stefan Lucke



From inssomniak at mountaincable.net  Sun Feb 12 22:35:24 2006
From: inssomniak at mountaincable.net (Dave)
Date: Sun, 12 Feb 2006 16:35:24 -0500
Subject: [Softdevice-devel] desperate plea to stop dolby digital cut outs
In-Reply-To: <200602122113.23439.stefan@lucke.in-berlin.de>
References: <43EF8C25.8090202@mountaincable.net> <200602122113.23439.stefan@lucke.in-berlin.de>
Message-ID: <43EFAA1C.1010109@mountaincable.net>


Stefan Lucke wrote:

>On Sonntag, 12. Februar 2006 20:27, Dave wrote:
>  
>
>>I use SPDIF 5.1 mode with softdevice, and the dolby digital cuts in and 
>>out during periods of "xruns" (PCM does too but only for a tiny fraction 
>>of a second), the dolby digital can cut out for more than a second, 
>>while the av receiver re-syncs  the bitstream.  Is a better quality 
>>sound card going to fix this?
>>    
>>
>
>Just for interest: whats your current card ?
>
>  
>

Its just an onboard SIS 7012 with alc655 codec

>>what causes it?
>>    
>>
>
>Even if normal audio is streamed as 48KHz or other sample frequencies,
>there is slight difference between A/D sampling and D/A conversion.
>Let's guess A/D is done at 47990Hz and D/A at 48100Hz. With this
>setup it is obvious that you'll get some Xruns during playback.
>For PCM output we could think of a resampling logic that adjusts audio
>rate to video rate (sync on video).
>In case DD5.1 things are more complicated: Decode 5.1, resample
>all 6 channels, reencode them to DD5.1 and then output via SPDIF.
>
>With decoding/encoding there could be some patent issues I guess :-( .
>
>  
>

I thought with the dolby digital bitstream out there was no decoding of 
the stream, but was simply sent to the av decoder in encoded format, 
therefore there was no patent issues involved?

>>Ill go get a good quality 
>>sound card if it will fix it, but Im not sure that it will.  Any thoughts?
>>    
>>
>
>The ideal solution would be a sound card that would allow some
>software controlled adjustments of the PLL which clocks PCM/SPDIF out.
>But unfortunatly I've never heard of such a card (or searched for the
>wrong keywords).
>
>Another way would be some finetuning of the video refresh rate.
>
>Ideally both (audio and video PLLs) should be adjusted to incoming
>reference clock.
>
>  
>
So if I understand correctly the bitstream out plugin can use a FF DVB 
card SPDIF out to input of sound card SPDIF as a reference clock to the 
DVB channel tuned to hold sample rate.. interesting, but as far as Im 
aware there is no outout of FF card video/audio while using softdevice? 
( I have a nexus FF card with spdif out)  I tried vdr -a"ac3dec -C" as 
test, and still ran into the same problems of sound cutting out (not to 
mention bad sync issues), so real problem is that the 48000 sample rate 
of the DVB channel isnt the same as the 48000 rate of the sound card, 
therefore you get drift. 

My guess is also no way to do it in software to fix, but maybe what you 
said, is do something with the video instead, (drop frames, duplicate 
frames?)  Use the sound card as reference to video?  Im not a programmer 
im sorry I just think of weird things. :)


>For long resync periods of your A/V receiver, I'll think I should
>have a closer look at bitstream-out code. This FF-card plugin has
>some better underrun and overruns handling code I guess.
>
>  
>


From inssomniak at mountaincable.net  Mon Feb 13 00:20:55 2006
From: inssomniak at mountaincable.net (Dave)
Date: Sun, 12 Feb 2006 18:20:55 -0500
Subject: [Softdevice-devel] desperate plea to stop dolby digital cut outs
In-Reply-To: <43EFAA1C.1010109@mountaincable.net>
References: <43EF8C25.8090202@mountaincable.net> <200602122113.23439.stefan@lucke.in-berlin.de> <43EFAA1C.1010109@mountaincable.net>
Message-ID: <43EFC2D7.5070801@mountaincable.net>

I ran some tests for kicks and installed the bitstream plugin and used 
it, and it works perfectly. although I could never get the video and 
audio sync'd properly, using the delays in the setup of the plugin.  So 
I would say it is superior to ac3play code?




From admin at berlios.de  Mon Feb 13 18:10:29 2006
From: admin at berlios.de (admin at berlios.de)
Date: Mon, 13 Feb 2006 08:10:29 -0900 (AKST)
Subject: [Softdevice-devel] [Bug #6409] Version 0.2.2
Message-ID: <200602131710.k1DHATjW025509@unicorn.berlios.de>

Bug #6409, was updated on 2006-Feb-13 08:10
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: None
Status: Open
Resolution: None
Bug Group: None
Priority: 5
Submitted by: daliman
Assigned to : none
Summary: Version 0.2.2

Details: Im Vergleich zu 0.2.1 sind mir ein paar Sachen aufgefallen:

1. Bei Radiosender (hier Astra 19.2) dauert es f?nf Sekunden bis das OSD aktualisiert wird. Auch das Aufrufen aller VDR-Funktionen dauert es allgemein 5 sekunden bis das entsprechende OSD erscheint. (shm & xv)

2. (kein echter Fehler) Programme im 4:3 Format werden nicht der Bildschirmgr??e angepasst. Cropping und Bildschirmformat helfen hier auch nicht. (nur shm)

3. (auch kein Fehler) Ist es m?glich den ShmClient in den Softdevice-Code zu ?bernehmen? Zwar kann man dann keinen anderen Client verbinden, man k?nnte aber eine weitere Commandlineoption hinzunehmen die dieses m?glich macht.

Gru?, daliman.de


For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=6409&group_id=2051


From admin at berlios.de  Mon Feb 13 19:22:33 2006
From: admin at berlios.de (admin at berlios.de)
Date: Mon, 13 Feb 2006 09:22:33 -0900 (AKST)
Subject: [Softdevice-devel] [Bug #6409] Version 0.2.2
Message-ID: <200602131822.k1DIMXOS009167@unicorn.berlios.de>

Bug #6409, was updated on 2006-Feb-13 08:10
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: None
Status: Open
Resolution: None
Bug Group: None
Priority: 5
Submitted by: daliman
Assigned to : none
Summary: Version 0.2.2

Details: Im Vergleich zu 0.2.1 sind mir ein paar Sachen aufgefallen:

1. Bei Radiosender (hier Astra 19.2) dauert es f?nf Sekunden bis das OSD aktualisiert wird. Auch das Aufrufen aller VDR-Funktionen dauert es allgemein 5 sekunden bis das entsprechende OSD erscheint. (shm & xv)

2. (kein echter Fehler) Programme im 4:3 Format werden nicht der Bildschirmgr??e angepasst. Cropping und Bildschirmformat helfen hier auch nicht. (nur shm)

3. (auch kein Fehler) Ist es m?glich den ShmClient in den Softdevice-Code zu ?bernehmen? Zwar kann man dann keinen anderen Client verbinden, man k?nnte aber eine weitere Commandlineoption hinzunehmen die dieses m?glich macht.

Gru?, daliman.de


Follow-Ups:

Date: 2006-Feb-13 09:22
By: daliman

Comment:
Nachtrag zur Fehlermeldung Punkt 1:
Das ist nur der Fall wenn im Men? "OSD alpha blending=software" ausgew?hlt ist. Man kann dieses Problem also umgehen, jedoch ist die Darstellung bei "pseudo" (was das auch immer sein soll ...) nicht optimal.

-------------------------------------------------------

For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=6409&group_id=2051


From ajhseppa at niksula.hut.fi  Tue Feb 14 19:48:11 2006
From: ajhseppa at niksula.hut.fi (=?ISO-8859-1?Q?Antti_Sepp=E4l=E4?=)
Date: Tue, 14 Feb 2006 20:48:11 +0200 (EET)
Subject: [Softdevice-devel] [PATCH] Use pluginlibdir defined in Make.config
Message-ID: <20060214193038.W15609@neilikka.niksula.hut.fi>

Hello.

May I suggest including this small patch to make softdevice search its
subplugins from PLUGINLIBDIR defined in vdrs Make.config by default.

Currently softdevice ignores the setting in Make.config and uses a
relative path of ./PLUGINS/lib when loading subplugins. Some users (at
least me) may prefer having plugins located in a non-default directory.


--- Makefile.orig	2006-02-14 20:32:23.033392920 +0200
+++ Makefile	2006-02-14 20:31:58.062189120 +0200
@@ -26,6 +26,8 @@
 LIBDIR     = ../../lib
 TMPDIR     = /tmp
 
+PLUGINLIBDIR = ./PLUGINS/lib
+
 -include config.mak
 
 # uncomment to build the shared memory video server
@@ -209,7 +211,7 @@
 INCLUDES += -I$(VDRDIR)/include -I$(DVBDIR)/include $(FFMPEGCFLAGS)
 
 DEFINES += -DPLUGIN_NAME_I18N='"$(PLUGIN)"' -D_GNU_SOURCE
-DEFINES += -DPLUGINLIBDIR='"./PLUGINS/lib"'
+DEFINES += -DPLUGINLIBDIR='"$(PLUGINLIBDIR)"'
 
 ### The object files (add further files here):
 


From stefan at lucke.in-berlin.de  Wed Feb 15 07:52:21 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 15 Feb 2006 07:52:21 +0100
Subject: [Softdevice-devel] [Bug #6409] Version 0.2.2
In-Reply-To: <200602131822.k1DIMXOS009167@unicorn.berlios.de>
References: <200602131822.k1DIMXOS009167@unicorn.berlios.de>
Message-ID: <200602150752.21648.stefan@lucke.in-berlin.de>

On Montag, 13. Februar 2006 19:22, wrote:
> Bug #6409, was updated on 2006-Feb-13 08:10
> Here is a current snapshot of the bug.
> 
> Project: Vdr Softdevice
> Category: None
> Status: Open
> Resolution: None
> Bug Group: None
> Priority: 5
> Submitted by: daliman
> Assigned to : none
> Summary: Version 0.2.2
> 
> Details: Im Vergleich zu 0.2.1 sind mir ein paar Sachen aufgefallen:
> 
> 1. Bei Radiosender (hier Astra 19.2) dauert es f?nf Sekunden bis das OSD aktualisiert wird. Auch das Aufrufen aller VDR-Funktionen dauert es allgemein 5 sekunden bis das entsprechende OSD erscheint. (shm & xv)

This one could be fixed by attached patch. Setting video->Osd_changed = true 
in SoftOsd.c is not the best way I guess. But this fix would trigger some/one
other bug more often. 
Without that fix I get deadlocks at startup in xv-out mode very seldom.
Deadlock viewed with an attached gdb session at line 1185 (video-xv.c):

pthread_mutex_lock(&xv_mutex);

With this it happens frequent, but with a different mutex :-( :
(gdb) bt
#0  0x4005db94 in __pthread_sigsuspend () from /lib/i686/libpthread.so.0
#1  0x4005d9d8 in __pthread_wait_for_restart_signal () from /lib/i686/libpthread.so.0
#2  0x4005f1bd in __pthread_alt_lock () from /lib/i686/libpthread.so.0
#3  0x4005bf90 in pthread_mutex_lock () from /lib/i686/libpthread.so.0
#4  0x080faf1d in cMutex::Lock() (this=0x81e0c80) at thread.c:190
#5  0x418167e1 in cVideoOut::CloseOSD() (this=0x8374880) at video.c:447
#6  0x41819b0e in cXvVideoOut::CloseOSD() (this=0x8374880) at video-xv.c:1170
#7  0x4031eb11 in ~cSoftOsd (this=0x8274388) at SoftOsd.c:75
#8  0x080eb473 in ~cSkinSTTNGDisplayChannel (this=0x841ac98) at skinsttng.c:226
#9  0x080be41f in ~cDisplayChannel (this=0x83d4d98) at menu.c:3041
#10 0x081058f0 in main (argc=12, argv=0xbffff304) at vdr.c:993

It is commen is that this happens at start-up, osd-close of the first osd displayed.
Some memory corruption I guess. I addition somtimes I get some
invalid pointer in free() during termination or some segfaults.
from gdb it sometimes look like it is the destructor of cXvVideoOut,
last line ;-) (delete this ?).

> Follow-Ups:
> 
> Date: 2006-Feb-13 09:22
> By: daliman
> 
> Comment:
> Nachtrag zur Fehlermeldung Punkt 1:
> Das ist nur der Fall wenn im Men? "OSD alpha blending=software" ausgew?hlt ist. Man kann dieses Problem also umgehen, jedoch ist die Darstellung bei "pseudo" (was das auch immer sein soll ...) nicht optimal.


-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: softdevice-osd-refresh01.diff
Type: text/x-diff
Size: 1131 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060215/96597646/attachment.diff>

From jahuttun at gmail.com  Wed Feb 15 13:44:25 2006
From: jahuttun at gmail.com (Janne Huttunen)
Date: Wed, 15 Feb 2006 14:44:25 +0200
Subject: [Softdevice-devel] [PATCH] Fix softdevice compilation for AMD64
In-Reply-To: <200602111613.53160.stefan@lucke.in-berlin.de>
References: <43C6CE17.3030106@gmail.com>
	 <200602111613.53160.stefan@lucke.in-berlin.de>
Message-ID: <4cd8d14e0602150444l640333e8l441aa89acb0dc60@mail.gmail.com>

> As "%zu" failes for me on my old prod vdr:
>
> video-fb.c: In method `cFBVideoOut::cFBVideoOut(cSetupStore *)':
> video-fb.c:137: warning: unknown conversion type character `z' in format
> video-fb.c:137: warning: too many arguments for format
>
> I consider "too many arguments" as an error.

Oh well, I guess zu is a C99ism. So it should be a matter of having
recent enough gcc and glibc and possibly using some -std=c99
switch. I have no idea how long it has been supported.

> is there any other format string to printf size_t type  values on AMD64 ?
> Or does casting "size" to "(unsigned int) size" work?

In case you wish to support older systems, I think your best bet is
to cast to (unsigned long) and use %lu .


From stefan at lucke.in-berlin.de  Fri Feb 17 22:01:41 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 17 Feb 2006 22:01:41 +0100
Subject: [Softdevice-devel] [Bug #6409] Version 0.2.2
In-Reply-To: <200602150752.21648.stefan@lucke.in-berlin.de>
References: <200602131822.k1DIMXOS009167@unicorn.berlios.de> <200602150752.21648.stefan@lucke.in-berlin.de>
Message-ID: <200602172201.42083.stefan@lucke.in-berlin.de>

On Mittwoch, 15. Februar 2006 07:52, Stefan Lucke wrote:
> On Montag, 13. Februar 2006 19:22, wrote:
> > Bug #6409, was updated on 2006-Feb-13 08:10
> > Here is a current snapshot of the bug.
> > 
> > Project: Vdr Softdevice
> > Category: None
> > Status: Open
> > Resolution: None
> > Bug Group: None
> > Priority: 5
> > Submitted by: daliman
> > Assigned to : none
> > Summary: Version 0.2.2
> > 
> > Details: Im Vergleich zu 0.2.1 sind mir ein paar Sachen aufgefallen:
> > 
> > 1. Bei Radiosender (hier Astra 19.2) dauert es f?nf Sekunden bis das OSD aktualisiert wird. Auch das Aufrufen aller VDR-Funktionen dauert es allgemein 5 sekunden bis das entsprechende OSD erscheint. (shm & xv)
> 
> This one could be fixed by attached patch. Setting video->Osd_changed = true 
> in SoftOsd.c is not the best way I guess. But this fix would trigger some/one
> other bug more often. 
> Without that fix I get deadlocks at startup in xv-out mode very seldom.
> Deadlock viewed with an attached gdb session at line 1185 (video-xv.c):
> 
> pthread_mutex_lock(&xv_mutex);
> 
> With this it happens frequent, but with a different mutex :-( :
> (gdb) bt
> #0  0x4005db94 in __pthread_sigsuspend () from /lib/i686/libpthread.so.0
> #1  0x4005d9d8 in __pthread_wait_for_restart_signal () from /lib/i686/libpthread.so.0
> #2  0x4005f1bd in __pthread_alt_lock () from /lib/i686/libpthread.so.0
> #3  0x4005bf90 in pthread_mutex_lock () from /lib/i686/libpthread.so.0
> #4  0x080faf1d in cMutex::Lock() (this=0x81e0c80) at thread.c:190
> #5  0x418167e1 in cVideoOut::CloseOSD() (this=0x8374880) at video.c:447
> #6  0x41819b0e in cXvVideoOut::CloseOSD() (this=0x8374880) at video-xv.c:1170
> #7  0x4031eb11 in ~cSoftOsd (this=0x8274388) at SoftOsd.c:75
> #8  0x080eb473 in ~cSkinSTTNGDisplayChannel (this=0x841ac98) at skinsttng.c:226
> #9  0x080be41f in ~cDisplayChannel (this=0x83d4d98) at menu.c:3041
> #10 0x081058f0 in main (argc=12, argv=0xbffff304) at vdr.c:993
> 
> It is commen is that this happens at start-up, osd-close of the first osd displayed.
> Some memory corruption I guess. I addition somtimes I get some
> invalid pointer in free() during termination or some segfaults.
> from gdb it sometimes look like it is the destructor of cXvVideoOut,
> last line ;-) (delete this ?).

Finally I got it with help from valgrind, which complained about a
conditional jump in GetOSDDimension() based on an uninitialized variable.
After enabling OSD debugging I saw the initial area of size 1024x576,
(startup mode is 16:9) which is larger than my default xv-area.

Fix is done by introducing a new method to adjust video-out's osd
mode, which has to be called _before_ any other query functions and
removing osd mode setting from Commit..Unlock() functions.

Perhaps I should release a fix version (0.2.3).

-- 
Stefan Lucke



From admin at berlios.de  Fri Feb 17 22:34:27 2006
From: admin at berlios.de (admin at berlios.de)
Date: Fri, 17 Feb 2006 22:34:27 +0100 (CET)
Subject: [Softdevice-devel] [Bug #6409] Version 0.2.2
Message-ID: <200602172134.k1HLYRFI007935@unicorn.berlios.de>

Bug #6409, was updated on 2006-Feb-13 18:10
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: None
Status: Closed
Resolution: Fixed
Bug Group: None
Priority: 5
Submitted by: daliman
Assigned to : none
Summary: Version 0.2.2

Details: Im Vergleich zu 0.2.1 sind mir ein paar Sachen aufgefallen:

1. Bei Radiosender (hier Astra 19.2) dauert es f?nf Sekunden bis das OSD aktualisiert wird. Auch das Aufrufen aller VDR-Funktionen dauert es allgemein 5 sekunden bis das entsprechende OSD erscheint. (shm & xv)

2. (kein echter Fehler) Programme im 4:3 Format werden nicht der Bildschirmgr??e angepasst. Cropping und Bildschirmformat helfen hier auch nicht. (nur shm)

3. (auch kein Fehler) Ist es m?glich den ShmClient in den Softdevice-Code zu ?bernehmen? Zwar kann man dann keinen anderen Client verbinden, man k?nnte aber eine weitere Commandlineoption hinzunehmen die dieses m?glich macht.

Gru?, daliman.de


Follow-Ups:

Date: 2006-Feb-17 22:34
By: lucke

Comment:
Fix for 1. is in cvs now.
Topics 2. and 3. should be opened separate if you consider then as real bugs.
-------------------------------------------------------

Date: 2006-Feb-13 19:22
By: daliman

Comment:
Nachtrag zur Fehlermeldung Punkt 1:
Das ist nur der Fall wenn im Men? "OSD alpha blending=software" ausgew?hlt ist. Man kann dieses Problem also umgehen, jedoch ist die Darstellung bei "pseudo" (was das auch immer sein soll ...) nicht optimal.

-------------------------------------------------------

For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=6409&group_id=2051


From seb42 at gmx.de  Mon Feb 20 17:35:45 2006
From: seb42 at gmx.de (Sebastian Vandersee)
Date: Mon, 20 Feb 2006 17:35:45 +0100
Subject: [Softdevice-devel] Displaying images
Message-ID: <43F9EFE1.5010000@gmx.de>

Hi there,

what softdevice modifications would have to be done in order
to display image (e.g. jpg) with softdevice? Any pointers?
I don't like to convert images first to mpeg still pics
and then play it. That's too slow.
It would be great, if pictures could be directly displayed.
Is anyone working on such a feature?

Oh, and btw: thanks for softdevice!

Sebastian


From marko.makela at hut.fi  Mon Feb 20 20:33:44 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 20 Feb 2006 21:33:44 +0200
Subject: [Softdevice-devel] Matrox G450 VGA (not mgatv) to SCART pinout?
Message-ID: <20060220193251.GA4466@localhost.localdomain>

I'm trying to connect my RGB video monitor to the VGA output of the G450,
so that the color space conversion could be avoided.

The mgatv output works fine with this cable connected to the secondary
head: http://forum.matrox.com/mga/viewtopic.php?t=4383

However, I was unable to figure out where to get composite sync from
the primary head.  The link to http://www.sm.go.dlr.de/%7Ebob/scart/scart.gif
at http://softdevice.berlios.de/ doesn't respond.

As I don't have access to an oscilloscope right now, I don't know if the
sync problems are due to bad fbset timings (/etc/fb.modes) or wrong cable.
I tried with and without the DDC loop (pins 12 and 15), hoping to find
composite sync on pins 5, 13 or 14.

While testing, I noticed that DirectFB insists on having mode=%ux%u in
/etc/directfbrc.  I wonder where it takes the timings.  Does it get the
first entry with matching xres and yres from /etc/fb.modes?

Last but not least, are the "my-pal-32" timings posted at
http://softdevice.berlios.de/ a bit off?  If I understood correctly,
they give a line time of 66.9 ?s, while 64 ?s would be correct (AFAIK).
The frame time is about 19.470 ms, while it should be 20 ms to get a 50 Hz
frame rate.  As I couldn't get my monitor to synchronize by fiddling with
the values, I do not think that this is my problem.

	Marko


From stefan at lucke.in-berlin.de  Mon Feb 20 23:02:47 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 20 Feb 2006 23:02:47 +0100
Subject: [Softdevice-devel] Displaying images
In-Reply-To: <43F9EFE1.5010000@gmx.de>
References: <43F9EFE1.5010000@gmx.de>
Message-ID: <200602202302.47845.stefan@lucke.in-berlin.de>

On Montag, 20. Februar 2006 17:35, Sebastian Vandersee wrote:
> Hi there,
> 
> what softdevice modifications would have to be done in order
> to display image (e.g. jpg) with softdevice? Any pointers?

I tried that as part of my unpublished UPnP extension, but
ffmpeg failed to detect jpegs.

> I don't like to convert images first to mpeg still pics
> and then play it. That's too slow.
> It would be great, if pictures could be directly displayed.
> Is anyone working on such a feature?

Perhaps we should try again that part in softplay.

> 
> Oh, and btw: thanks for softdevice!
> 
> Sebastian


-- 
Stefan Lucke



From stefan at lucke.in-berlin.de  Mon Feb 20 23:02:52 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 20 Feb 2006 23:02:52 +0100
Subject: [Softdevice-devel] Matrox G450 VGA (not mgatv) to SCART pinout?
In-Reply-To: <20060220193251.GA4466@localhost.localdomain>
References: <20060220193251.GA4466@localhost.localdomain>
Message-ID: <200602202302.52976.stefan@lucke.in-berlin.de>

On Montag, 20. Februar 2006 20:33, Marko M?kel? wrote:
> I'm trying to connect my RGB video monitor to the VGA output of the G450,
> so that the color space conversion could be avoided.
> 
> The mgatv output works fine with this cable connected to the secondary
> head: http://forum.matrox.com/mga/viewtopic.php?t=4383
> 
> However, I was unable to figure out where to get composite sync from
> the primary head.  The link to http://www.sm.go.dlr.de/%7Ebob/scart/scart.gif
> at http://softdevice.berlios.de/ doesn't respond.

Thanks, have to correct the link. Did a google search for pictures
with scart.gif, and found that picture as the 2nd from left in the
1st row:
http://images.google.de/images?hl=de&ie=ISO-8859-1&q=scart.gif&btnG=Suche&sa=N&tab=wi

http://www.obsolyte.com/sunFAQ/faq_framebuffer/fbfaq_files/scart.gif

> 
> As I don't have access to an oscilloscope right now, I don't know if the
> sync problems are due to bad fbset timings (/etc/fb.modes) or wrong cable.
> I tried with and without the DDC loop (pins 12 and 15), hoping to find
> composite sync on pins 5, 13 or 14.
> 
> While testing, I noticed that DirectFB insists on having mode=%ux%u in
> /etc/directfbrc.  I wonder where it takes the timings.  Does it get the
> first entry with matching xres and yres from /etc/fb.modes?

Yes.

> 
> Last but not least, are the "my-pal-32" timings posted at
> http://softdevice.berlios.de/ a bit off?  If I understood correctly,
> they give a line time of 66.9 ?s, while 64 ?s would be correct (AFAIK).

No fb.mode calculation is a bit complicated: result is about 63.998235 ?s :-)
mode "my-pal-32"
    geometry 768 576 768 576 32
    timings  67723 106 1 44 1 70 4
    csync high
    laced true
    bcast true
endmode


From vdr at igt-gmbh.de  Mon Feb 20 19:46:37 2006
From: vdr at igt-gmbh.de (thomas erdmann)
Date: Mon, 20 Feb 2006 19:46:37 +0100
Subject: [Softdevice-devel] Softdevice and HDTV and OSD
Message-ID: <200602201946.37288.vdr@igt-gmbh.de>

Hello List,
i came to the Softdevice Plugin because of several Problems with the Xine 
Plugin.
The normal Functions for "looking TV" with only a Budget Card are implemented 
better than then there i think, without the need to patch a large Project 
like Xine Sources of a special Date with the use of a specific Version of the 
Plugin. I've given it up before a couple of Weeks, because the same Problems 
withover multiple Versions :-(
Now i'm using Softdevice CVS several Weeks and it's working good -thank you !
Now i am experimenting with HD(Free)TV on Astra and Hotbird. I found, that 
with adjusting Softdevice to "OSD Einblendung Pseudo" it runs without crash 
but it's very hard to read anything of the OSD Text - it only flickers while 
key press event. So i looked at the Sources and tried some changes, without 
the expected results :-(
Can anyone give me a hint to
a) Do a faster OSD Redraw in "Pseude Mode" 
b) Change the Software OSD for running at larger Resolutions without Crash

THX
  Thomas


From seb42 at gmx.de  Mon Feb 20 23:30:42 2006
From: seb42 at gmx.de (Sebastian Vandersee)
Date: Mon, 20 Feb 2006 23:30:42 +0100
Subject: [Softdevice-devel] Displaying images
In-Reply-To: <200602202302.47845.stefan@lucke.in-berlin.de>
References: <43F9EFE1.5010000@gmx.de> <200602202302.47845.stefan@lucke.in-berlin.de>
Message-ID: <43FA4312.4050706@gmx.de>

Hi,

Stefan Lucke schrieb:

> On Montag, 20. Februar 2006 17:35, Sebastian Vandersee wrote:
> 
>>Hi there,
>>
>>what softdevice modifications would have to be done in order
>>to display image (e.g. jpg) with softdevice? Any pointers?
> 
> 
> I tried that as part of my unpublished UPnP extension, but
> ffmpeg failed to detect jpegs.
> 
Do you plan to publish your UPnP extension?

> 
>>I don't like to convert images first to mpeg still pics
>>and then play it. That's too slow.
>>It would be great, if pictures could be directly displayed.
>>Is anyone working on such a feature?
> 
> 
> Perhaps we should try again that part in softplay.
> 
I just took a look at the sources of softplay. Would that mean,
instead of passing a frame in "packet mode" to softdevice,
one would have to pass a jpeg? I guess, there will be also
changes required in softdevice itself, right?

Sebastian


From stefan at lucke.in-berlin.de  Mon Feb 20 23:54:20 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 20 Feb 2006 23:54:20 +0100
Subject: [Softdevice-devel] Softdevice and HDTV and OSD
In-Reply-To: <200602201946.37288.vdr@igt-gmbh.de>
References: <200602201946.37288.vdr@igt-gmbh.de>
Message-ID: <200602202354.20100.stefan@lucke.in-berlin.de>

On Montag, 20. Februar 2006 19:46, thomas erdmann wrote:
> Hello List,
> i came to the Softdevice Plugin because of several Problems with the Xine 
> Plugin.
> The normal Functions for "looking TV" with only a Budget Card are implemented 
> better than then there i think, without the need to patch a large Project 
> like Xine Sources of a special Date with the use of a specific Version of the 
> Plugin. I've given it up before a couple of Weeks, because the same Problems 
> withover multiple Versions :-(
> Now i'm using Softdevice CVS several Weeks and it's working good -thank you !
> Now i am experimenting with HD(Free)TV on Astra and Hotbird. I found, that 
> with adjusting Softdevice to "OSD Einblendung Pseudo" it runs without crash 
> but it's very hard to read anything of the OSD Text - it only flickers while 
> key press event. So i looked at the Sources and tried some changes, without 
> the expected results :-(
> Can anyone give me a hint to
> a) Do a faster OSD Redraw in "Pseude Mode" 

In "Pseudo Mode" there should be no need for faster refreshs as the
mixing OSD + video is done in hardware by color keying. If you get
only a flickering OSD (nvidia card + driver ?)

> b) Change the Software OSD for running at larger Resolutions without Crash
Does the crash happen too if you select max-area option for xv-out ?
' ... -vo xv:max-area: ...'

-- 
Stefan Lucke



From stefan at lucke.in-berlin.de  Tue Feb 21 00:06:38 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 21 Feb 2006 00:06:38 +0100
Subject: [Softdevice-devel] Displaying images
In-Reply-To: <43FA4312.4050706@gmx.de>
References: <43F9EFE1.5010000@gmx.de> <200602202302.47845.stefan@lucke.in-berlin.de> <43FA4312.4050706@gmx.de>
Message-ID: <200602210006.38032.stefan@lucke.in-berlin.de>

On Montag, 20. Februar 2006 23:30, Sebastian Vandersee wrote:
> Hi,
> 
> Stefan Lucke schrieb:
> 
> > On Montag, 20. Februar 2006 17:35, Sebastian Vandersee wrote:
> > 
> >>Hi there,
> >>
> >>what softdevice modifications would have to be done in order
> >>to display image (e.g. jpg) with softdevice? Any pointers?
> > 
> > 
> > I tried that as part of my unpublished UPnP extension, but
> > ffmpeg failed to detect jpegs.
> > 
> Do you plan to publish your UPnP extension?

Hm, it's not only unpublished it is even unfinished, some sort of prototype.
Some function are working: Detection of UPnP servers (tested with
twonky mediaserver http://www.twonkyvision.de/ ), getting some
directory info, playing video and playing audio but not playing images.
If you are interested in UPnP, you may have a look at djmount
http://djmount.sourceforge.net/  which exports UPnP media-directories
via usermount file system structure.
By this everything (except images) should be playable via softplay.

> 
> > 
> >>I don't like to convert images first to mpeg still pics
> >>and then play it. That's too slow.
> >>It would be great, if pictures could be directly displayed.
> >>Is anyone working on such a feature?
> > 
> > 
> > Perhaps we should try again that part in softplay.
> > 
> I just took a look at the sources of softplay. Would that mean,
> instead of passing a frame in "packet mode" to softdevice,
> one would have to pass a jpeg? I guess, there will be also
> changes required in softdevice itself, right?


-- 
Stefan Lucke



From marko.makela at hut.fi  Tue Feb 21 11:51:59 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 21 Feb 2006 12:51:59 +0200
Subject: [Softdevice-devel] Matrox G450 VGA (not mgatv) to SCART pinout?
In-Reply-To: <200602202302.52976.stefan@lucke.in-berlin.de>
References: <20060220193251.GA4466@localhost.localdomain> <200602202302.52976.stefan@lucke.in-berlin.de>
Message-ID: <20060221105159.GB3851@localhost.localdomain>

On Mon, Feb 20, 2006 at 11:02:52PM +0100, Stefan Lucke wrote:
> http://www.obsolyte.com/sunFAQ/faq_framebuffer/fbfaq_files/scart.gif

That picture only shows the SCART connector.  Is there anything special
on the VGA end (like connecting some DDC pins with each other?)

> So that should be 945 * 67723 = 63998235 picoseconds * 625 lines,
> which is about 39.998896875ms frame duration.
> 
> > The frame time is about 19.470 ms, while it should be 20 ms to get a 50 Hz
> > frame rate.  As I couldn't get my monitor to synchronize by fiddling with
> > the values, I do not think that this is my problem.
> 
> Is that a monitor device or tv device ?

It's a PAL and RGB monitor, Commodore 1084 a.k.a. Philips CM8833.

> Only tv devices should get a sync. The disadvantage is that I don't
> know how to select field parity in that mode .

That would explain why the field parity is sometimes wrong in the
mgatv RGB output.

	Marko


From M.Wache at gmx.net  Tue Feb 21 17:58:38 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 21 Feb 2006 17:58:38 +0100
Subject: [Softdevice-devel] Softdevice and HDTV and OSD
In-Reply-To: <200602202354.20100.stefan@lucke.in-berlin.de>
References: <200602201946.37288.vdr@igt-gmbh.de> <200602202354.20100.stefan@lucke.in-berlin.de>
Message-ID: <43FB46BE.6020104@gmx.net>

Stefan Lucke schrieb:
> On Montag, 20. Februar 2006 19:46, thomas erdmann wrote:
>> Hello List,
>> i came to the Softdevice Plugin because of several Problems with the Xine 
>> Plugin.
>> The normal Functions for "looking TV" with only a Budget Card are implemented 
>> better than then there i think, without the need to patch a large Project 
>> like Xine Sources of a special Date with the use of a specific Version of the 
>> Plugin. I've given it up before a couple of Weeks, because the same Problems 
>> withover multiple Versions :-(
>> Now i'm using Softdevice CVS several Weeks and it's working good -thank you !
>> Now i am experimenting with HD(Free)TV on Astra and Hotbird. I found, that 
>> with adjusting Softdevice to "OSD Einblendung Pseudo" it runs without crash 
>> but it's very hard to read anything of the OSD Text - it only flickers while 
>> key press event. So i looked at the Sources and tried some changes, without 
>> the expected results :-(
>> Can anyone give me a hint to
>> a) Do a faster OSD Redraw in "Pseude Mode" 
> 
> In "Pseudo Mode" there should be no need for faster refreshs as the
> mixing OSD + video is done in hardware by color keying. If you get
> only a flickering OSD (nvidia card + driver ?)
> 
>> b) Change the Software OSD for running at larger Resolutions without Crash
> Does the crash happen too if you select max-area option for xv-out ?
> ' ... -vo xv:max-area: ...'
> 
The software osd layer is too small for HDTV, one has to get larger
buffers for osdP*. I guess that would fix the crashes, but the osd would
not be scaled. To get scaled osd one also has to implement the method
ScaleVUpCopyToBitmap() for YUV modes, which could almost be a copy of
the ones for the RGB modes, but one would have to ensure that
AYUV_to_AYUV420P gets the correct lines.

Bye,
Martin


From M.Wache at gmx.net  Tue Feb 21 18:03:17 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 21 Feb 2006 18:03:17 +0100
Subject: [Softdevice-devel] Displaying images
In-Reply-To: <43FA4312.4050706@gmx.de>
References: <43F9EFE1.5010000@gmx.de> <200602202302.47845.stefan@lucke.in-berlin.de> <43FA4312.4050706@gmx.de>
Message-ID: <43FB47D5.1040900@gmx.net>

Sebastian Vandersee schrieb:
> Hi,
> 
> Stefan Lucke schrieb:
> 
>> On Montag, 20. Februar 2006 17:35, Sebastian Vandersee wrote:
>>
>>> Hi there,
>>>
>>> what softdevice modifications would have to be done in order
>>> to display image (e.g. jpg) with softdevice? Any pointers?
>>
>> I tried that as part of my unpublished UPnP extension, but
>> ffmpeg failed to detect jpegs.
>>
> Do you plan to publish your UPnP extension?
> 
>>> I don't like to convert images first to mpeg still pics
>>> and then play it. That's too slow.
>>> It would be great, if pictures could be directly displayed.
>>> Is anyone working on such a feature?
>>
>> Perhaps we should try again that part in softplay.
>>
> I just took a look at the sources of softplay. Would that mean,
> instead of passing a frame in "packet mode" to softdevice,
> one would have to pass a jpeg? I guess, there will be also
> changes required in softdevice itself, right?
> 
If you can convince ffmpeg to consider jpeg a video codec that you could
try that (maybe as motion jpeg?). However I think that using
av_read_image() from avformat.h looks more promising. If you manage to
get the jpegs decoded inside softplay ( or if you prefer that you can
also create your own plugin) we can introduce a new method to pass the
decoded image to the softdevice via the service interface.

Bye,
Martin


From seb42 at gmx.de  Tue Feb 21 18:34:04 2006
From: seb42 at gmx.de (Sebastian Vandersee)
Date: Tue, 21 Feb 2006 18:34:04 +0100
Subject: [Softdevice-devel] Displaying images
In-Reply-To: <43FB47D5.1040900@gmx.net>
References: <43F9EFE1.5010000@gmx.de> <200602202302.47845.stefan@lucke.in-berlin.de> <43FA4312.4050706@gmx.de> <43FB47D5.1040900@gmx.net>
Message-ID: <43FB4F0C.2000102@gmx.de>

Martin Wache schrieb:

> 
> [ .. ]
>>
>>>>I don't like to convert images first to mpeg still pics
>>>>and then play it. That's too slow.
>>>>It would be great, if pictures could be directly displayed.
>>>>Is anyone working on such a feature?
>>>
>>>Perhaps we should try again that part in softplay.
>>>
>>
>>I just took a look at the sources of softplay. Would that mean,
>>instead of passing a frame in "packet mode" to softdevice,
>>one would have to pass a jpeg? I guess, there will be also
>>changes required in softdevice itself, right?
>>
> 
> If you can convince ffmpeg to consider jpeg a video codec that you could
> try that (maybe as motion jpeg?). However I think that using
> av_read_image() from avformat.h looks more promising. If you manage to
> get the jpegs decoded inside softplay ( or if you prefer that you can
> also create your own plugin) we can introduce a new method to pass the
> decoded image to the softdevice via the service interface.
> 
I've never done this - but decoding images (e.g. jpegs) should be
possible with ImageMagick library.
So what format would I have to pass to softdevice's service
interface (assumed that such a method would be introduced)?
RGB? YUV? Probably depends on the graphics mode softdevice
uses, right?


Sebastian


From M.Wache at gmx.net  Tue Feb 21 18:48:36 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 21 Feb 2006 18:48:36 +0100
Subject: [Softdevice-devel] Displaying images
In-Reply-To: <43FB4F0C.2000102@gmx.de>
References: <43F9EFE1.5010000@gmx.de> <200602202302.47845.stefan@lucke.in-berlin.de> <43FA4312.4050706@gmx.de> <43FB47D5.1040900@gmx.net> <43FB4F0C.2000102@gmx.de>
Message-ID: <43FB5274.5090106@gmx.net>

Sebastian Vandersee schrieb:
> Martin Wache schrieb:
> 
>> [ .. ]
>>>>> I don't like to convert images first to mpeg still pics
>>>>> and then play it. That's too slow.
>>>>> It would be great, if pictures could be directly displayed.
>>>>> Is anyone working on such a feature?
>>>> Perhaps we should try again that part in softplay.
>>>>
>>> I just took a look at the sources of softplay. Would that mean,
>>> instead of passing a frame in "packet mode" to softdevice,
>>> one would have to pass a jpeg? I guess, there will be also
>>> changes required in softdevice itself, right?
>>>
>> If you can convince ffmpeg to consider jpeg a video codec that you could
>> try that (maybe as motion jpeg?). However I think that using
>> av_read_image() from avformat.h looks more promising. If you manage to
>> get the jpegs decoded inside softplay ( or if you prefer that you can
>> also create your own plugin) we can introduce a new method to pass the
>> decoded image to the softdevice via the service interface.
>>
> I've never done this - but decoding images (e.g. jpegs) should be
> possible with ImageMagick library.
> So what format would I have to pass to softdevice's service
> interface (assumed that such a method would be introduced)?
> RGB? YUV? Probably depends on the graphics mode softdevice
> uses, right?
> 
The best graphics format would be YUV420, then we can display it in the
video layer. The image has also to be scaled to some sensible
resolution, for the YUV420 format that can also be done be ffmpeg with
av_img_resample() or similar.

I would prefer to use ffmpeg (I know that it is possible to do it with
ffmpeg - I'm just not sure how it works), currently that is the only
library which is needed, and I don't like the idea of having a
dependency on imagemagick.

Bye,
Martin

Bye,
Martin


From seb42 at gmx.de  Tue Feb 21 19:04:31 2006
From: seb42 at gmx.de (Sebastian Vandersee)
Date: Tue, 21 Feb 2006 19:04:31 +0100
Subject: [Softdevice-devel] Displaying images
In-Reply-To: <43FB5274.5090106@gmx.net>
References: <43F9EFE1.5010000@gmx.de> <200602202302.47845.stefan@lucke.in-berlin.de> <43FA4312.4050706@gmx.de> <43FB47D5.1040900@gmx.net> <43FB4F0C.2000102@gmx.de> <43FB5274.5090106@gmx.net>
Message-ID: <43FB562F.6050509@gmx.de>

Martin Wache schrieb:

> Sebastian Vandersee schrieb:
> 
>>Martin Wache schrieb:
>>
>>
>>>[ .. ]
>>>
>>>>>>I don't like to convert images first to mpeg still pics
>>>>>>and then play it. That's too slow.
>>>>>>It would be great, if pictures could be directly displayed.
>>>>>>Is anyone working on such a feature?
>>>>>
>>>>>Perhaps we should try again that part in softplay.
>>>>>
>>>>
>>>>I just took a look at the sources of softplay. Would that mean,
>>>>instead of passing a frame in "packet mode" to softdevice,
>>>>one would have to pass a jpeg? I guess, there will be also
>>>>changes required in softdevice itself, right?
>>>>
>>>
>>>If you can convince ffmpeg to consider jpeg a video codec that you could
>>>try that (maybe as motion jpeg?). However I think that using
>>>av_read_image() from avformat.h looks more promising. If you manage to
>>>get the jpegs decoded inside softplay ( or if you prefer that you can
>>>also create your own plugin) we can introduce a new method to pass the
>>>decoded image to the softdevice via the service interface.
>>>
>>
>>I've never done this - but decoding images (e.g. jpegs) should be
>>possible with ImageMagick library.
>>So what format would I have to pass to softdevice's service
>>interface (assumed that such a method would be introduced)?
>>RGB? YUV? Probably depends on the graphics mode softdevice
>>uses, right?
>>
> 
> The best graphics format would be YUV420, then we can display it in the
> video layer. The image has also to be scaled to some sensible
> resolution, for the YUV420 format that can also be done be ffmpeg with
> av_img_resample() or similar.
> 
> I would prefer to use ffmpeg (I know that it is possible to do it with
> ffmpeg - I'm just not sure how it works), currently that is the only
> library which is needed, and I don't like the idea of having a
> dependency on imagemagick.
> 
Well, if I create a separate plugin which utilize another lib
(e.g. ImageMagick) to transform pics to YUV420 and then pass it
to softdevice, there will be no dependency on ImageMagick for
softdevice.
Anyway, I'll take a look at the API provided by ffmpeg.


Sebastian


From marko.makela at hut.fi  Tue Feb 21 22:26:12 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 21 Feb 2006 23:26:12 +0200
Subject: [Softdevice-devel] Displaying images
In-Reply-To: <43FB5274.5090106@gmx.net>
References: <43F9EFE1.5010000@gmx.de> <200602202302.47845.stefan@lucke.in-berlin.de> <43FA4312.4050706@gmx.de> <43FB47D5.1040900@gmx.net> <43FB4F0C.2000102@gmx.de> <43FB5274.5090106@gmx.net>
Message-ID: <20060221212612.GA3667@localhost.localdomain>

On Tue, Feb 21, 2006 at 06:48:36PM +0100, Martin Wache wrote:
> >> If you can convince ffmpeg to consider jpeg a video codec that you could
> >> try that (maybe as motion jpeg?). However I think that using
> >> av_read_image() from avformat.h looks more promising. If you manage to
> >> get the jpegs decoded inside softplay ( or if you prefer that you can
> >> also create your own plugin) we can introduce a new method to pass the
> >> decoded image to the softdevice via the service interface.
> >>
> > I've never done this - but decoding images (e.g. jpegs) should be
> > possible with ImageMagick library.
> > So what format would I have to pass to softdevice's service
> > interface (assumed that such a method would be introduced)?
> > RGB? YUV? Probably depends on the graphics mode softdevice
> > uses, right?

FWIW, vdr already depends on libjpeg because of the grab command.
libjpeg is the library for encoding and decoding EXIF and JFIF JPEG
images.  I would be very surprised if ImageMagick didn't depend on it.

I believe that most JPEG images are in Y/Cb/Cr color space.  You can
request libjpeg to convert between color spaces, e.g.,
Y/Cb/Cr/K <-> CMYK or Y/Cb/Cr <-> RGB.  I don't think that you can
ask it to convert between CMYK and RGB.

> I would prefer to use ffmpeg (I know that it is possible to do it with
> ffmpeg - I'm just not sure how it works), currently that is the only
> library which is needed, and I don't like the idea of having a
> dependency on imagemagick.

Me too.

	Marko


From vdr at igt-gmbh.de  Tue Feb 21 23:20:20 2006
From: vdr at igt-gmbh.de (thomas erdmann)
Date: Tue, 21 Feb 2006 23:20:20 +0100
Subject: [Softdevice-devel] Softdevice and HDTV and OSD
In-Reply-To: <200602202354.20100.stefan@lucke.in-berlin.de>
References: <200602201946.37288.vdr@igt-gmbh.de> <200602202354.20100.stefan@lucke.in-berlin.de>
Message-ID: <200602212320.20703.vdr@igt-gmbh.de>

Hello Stefan,
thanks for your fast answer.
In Pseudo mode the OSD only appears a very short time after key event, then it 
isn't visible. So i can't read anything without pressing several times 
up/down or so.
In the Software OSD i tried all documented options with all my CVS 
compilations and none until last Friday worked after switching to any HD 
Channel.
I use a Nvidia FX6600GT and the latest Nvidia Driver.
If this is a Problem which Driver should be used instead ?
Do you have any hints ?
THX
? Thomas

Am Montag, 20. Februar 2006 23:54 schrieben Sie:

> On Montag, 20. Februar 2006 19:46, thomas erdmann wrote:
> > Hello List,
> > i came to the Softdevice Plugin because of several Problems with the Xine
> > Plugin.
> > The normal Functions for "looking TV" with only a Budget Card are
> > implemented better than then there i think, without the need to patch a
> > large Project like Xine Sources of a special Date with the use of a
> > specific Version of the Plugin. I've given it up before a couple of
> > Weeks, because the same Problems withover multiple Versions :-(
> > Now i'm using Softdevice CVS several Weeks and it's working good -thank
> > you ! Now i am experimenting with HD(Free)TV on Astra and Hotbird. I
> > found, that with adjusting Softdevice to "OSD Einblendung Pseudo" it runs
> > without crash but it's very hard to read anything of the OSD Text - it
> > only flickers while key press event. So i looked at the Sources and tried
> > some changes, without the expected results :-(
> > Can anyone give me a hint to
> > a) Do a faster OSD Redraw in "Pseude Mode"
>
> In "Pseudo Mode" there should be no need for faster refreshs as the
> mixing OSD + video is done in hardware by color keying. If you get
> only a flickering OSD (nvidia card + driver ?)
>
> > b) Change the Software OSD for running at larger Resolutions without
> > Crash
>
> Does the crash happen too if you select max-area option for xv-out ?
> ' ... -vo xv:max-area: ...'


From stefan at lucke.in-berlin.de  Wed Feb 22 23:41:44 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 22 Feb 2006 23:41:44 +0100
Subject: [Softdevice-devel] Softdevice and HDTV and OSD
In-Reply-To: <200602212320.20703.vdr@igt-gmbh.de>
References: <200602201946.37288.vdr@igt-gmbh.de> <200602202354.20100.stefan@lucke.in-berlin.de> <200602212320.20703.vdr@igt-gmbh.de>
Message-ID: <200602222341.44639.stefan@lucke.in-berlin.de>

On Dienstag, 21. Februar 2006 23:20, thomas erdmann wrote:
> Hello Stefan,
> thanks for your fast answer.
> In Pseudo mode the OSD only appears a very short time after key event, then it 
> isn't visible. So i can't read anything without pressing several times 
> up/down or so.

I've found some hints of what could be changed in our color key handling.
But first I want to check some of your seen behaviour.

What happens when you select normal tv and place another terminal
window on top of vdr softdevice window ?

What happens when you select the entire window area ?

With my enviroment, terminal window hides vdr window, but when I
select entire terminal window, I can see video throught black selected
area parts.

Did you test softdevice 0.2.1 too ?
Is there a difference in "pseudo" osd drawing ? (AUTOPAINT_COLORKEY changed).

> In the Software OSD i tried all documented options with all my CVS 
> compilations and none until last Friday worked after switching to any HD 
> Channel.
> I use a Nvidia FX6600GT and the latest Nvidia Driver.
> If this is a Problem which Driver should be used instead ?
> Do you have any hints ?
> THX
> ? Thomas
> 

Could you avoid top post in your replies,
and please subscribe to our list, as your post have to be approved
manually. Manual filtering is bad since I usually tend to reject or discard
them. Allmost all mails in this category is spam (more than 10 per day).

> Am Montag, 20. Februar 2006 23:54 schrieben Sie:
> 
> > On Montag, 20. Februar 2006 19:46, thomas erdmann wrote:
> > > Hello List,
> > > i came to the Softdevice Plugin because of several Problems with the Xine
> > > Plugin.
> > > The normal Functions for "looking TV" with only a Budget Card are
> > > implemented better than then there i think, without the need to patch a
> > > large Project like Xine Sources of a special Date with the use of a
> > > specific Version of the Plugin. I've given it up before a couple of
> > > Weeks, because the same Problems withover multiple Versions :-(
> > > Now i'm using Softdevice CVS several Weeks and it's working good -thank
> > > you ! Now i am experimenting with HD(Free)TV on Astra and Hotbird. I
> > > found, that with adjusting Softdevice to "OSD Einblendung Pseudo" it runs
> > > without crash but it's very hard to read anything of the OSD Text - it
> > > only flickers while key press event. So i looked at the Sources and tried
> > > some changes, without the expected results :-(
> > > Can anyone give me a hint to
> > > a) Do a faster OSD Redraw in "Pseude Mode"
> >
> > In "Pseudo Mode" there should be no need for faster refreshs as the
> > mixing OSD + video is done in hardware by color keying. If you get
> > only a flickering OSD (nvidia card + driver ?)
> >
> > > b) Change the Software OSD for running at larger Resolutions without
> > > Crash
> >
> > Does the crash happen too if you select max-area option for xv-out ?
> > ' ... -vo xv:max-area: ...'


-- 
Stefan Lucke



From stefan at lucke.in-berlin.de  Thu Feb 23 00:14:32 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 23 Feb 2006 00:14:32 +0100
Subject: [Softdevice-devel] Softdevice and HDTV and OSD
In-Reply-To: <200602212320.20703.vdr@igt-gmbh.de>
References: <200602201946.37288.vdr@igt-gmbh.de> <200602202354.20100.stefan@lucke.in-berlin.de> <200602212320.20703.vdr@igt-gmbh.de>
Message-ID: <200602230014.32560.stefan@lucke.in-berlin.de>

On Dienstag, 21. Februar 2006 23:20, thomas erdmann wrote:
> Hello Stefan,
> thanks for your fast answer.
> In Pseudo mode the OSD only appears a very short time after key event, then it 
> isn't visible. So i can't read anything without pressing several times 
> up/down or so.
> In the Software OSD i tried all documented options with all my CVS 
> compilations and none until last Friday worked after switching to any HD 
> Channel.
> I use a Nvidia FX6600GT and the latest Nvidia Driver.
> If this is a Problem which Driver should be used instead ?
> Do you have any hints ?

Please send us output of command "xvinfo"

-- 
Stefan Lucke



From admin at berlios.de  Thu Feb 23 00:51:09 2006
From: admin at berlios.de (admin at berlios.de)
Date: Wed, 22 Feb 2006 14:51:09 -0900 (AKST)
Subject: [Softdevice-devel] [Bug #6551] Keine Transparenz
Message-ID: <200602222351.k1MNp94Q012792@unicorn.berlios.de>

Bug #6551, was updated on 2006-Feb-22 14:51
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: xv-out
Status: Open
Resolution: None
Bug Group: None
Priority: 5
Submitted by: daliman
Assigned to : none
Summary: Keine Transparenz

Details: Wenn kein Stream angezeigt wird, z.B. bei Radiosendern, wird das OSD-Men? nicht transparent angezeigt. (OSD-Alphablending PSEUDO/Software). Das ist auch beim Kanalwechsel kurzfristig der Fall.

For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=6551&group_id=2051


From admin at berlios.de  Thu Feb 23 01:02:49 2006
From: admin at berlios.de (admin at berlios.de)
Date: Wed, 22 Feb 2006 15:02:49 -0900 (AKST)
Subject: [Softdevice-devel] [Bug #6551] Keine Transparenz
Message-ID: <200602230002.k1N02niG006563@unicorn.berlios.de>

Bug #6551, was updated on 2006-Feb-22 14:51
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: xv-out
Status: Open
Resolution: None
Bug Group: None
Priority: 5
Submitted by: daliman
Assigned to : none
Summary: Keine Transparenz

Details: Wenn kein Stream angezeigt wird, z.B. bei Radiosendern, wird das OSD-Men? nicht transparent angezeigt. (OSD-Alphablending PSEUDO/Software). Das ist auch beim Kanalwechsel kurzfristig der Fall.

Follow-Ups:

Date: 2006-Feb-22 15:02
By: daliman

Comment:
Nachtrag: Auch der ShmClient bringt Fehler:
../../../include/vdr/ci.h:114: error: two or more data types in declaration of 'parameter'
ShmClient.c: In function 'int main(int, char**)':
ShmClient.c:77: warning: unused variable 'curr_pict_shmid'

-------------------------------------------------------

For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=6551&group_id=2051


From alexander-riedel at t-online.de  Thu Feb 23 19:10:23 2006
From: alexander-riedel at t-online.de (Alexander Riedel)
Date: Thu, 23 Feb 2006 19:10:23 +0100
Subject: [Softdevice-devel] New OSD and Scalling
Message-ID: <43FDFA8F.4080503@t-online.de>

Hi All!

Is there a possibility in the new OSD auto scalling to switch off?
I have developed an UTF-8 patch for vdr. 
http://www.vdr-wiki.de/wiki/index.php/Utf8-patch

Patch contains Freetype and can auserdem native antialiasing.
And now with new OSD the picture becomes antialiased, however, without 
scalling became symbole much nicer.
See:
http://www.vdr-wiki.de/wiki/index.php/Bild:Utf8-patch-01.png
or
http://www.vdr-wiki.de/wiki/index.php/Bild:Utf8-patch-05.png



From stefan at lucke.in-berlin.de  Thu Feb 23 19:22:32 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 23 Feb 2006 19:22:32 +0100
Subject: [Softdevice-devel] Softdevice and HDTV and OSD
In-Reply-To: <200602212320.20703.vdr@igt-gmbh.de>
References: <200602201946.37288.vdr@igt-gmbh.de> <200602202354.20100.stefan@lucke.in-berlin.de> <200602212320.20703.vdr@igt-gmbh.de>
Message-ID: <200602231922.33275.stefan@lucke.in-berlin.de>

On Dienstag, 21. Februar 2006 23:20, thomas erdmann wrote:
> Hello Stefan,
> thanks for your fast answer.
> In Pseudo mode the OSD only appears a very short time after key event, then it 
> isn't visible. So i can't read anything without pressing several times 
> up/down or so.
> In the Software OSD i tried all documented options with all my CVS 
> compilations and none until last Friday worked after switching to any HD 
> Channel.
> I use a Nvidia FX6600GT and the latest Nvidia Driver.

I found some hints that using overlay is impossible with this card.
So software OSD alpha blending is the only choise you have.
Those modern nvidia cards have only texture/blitting capabilities.

google search with: "xvinfo nvidia overlay"
http://www.google.de/search?hl=de&ie=ISO-8859-1&q=xvinfo+nvidia+overlay&btnG=Google-Suche&meta=

german:
http://lists.debian.org/debian-user-german/2005/08/msg00199.html

> If this is a Problem which Driver should be used instead ?
> Do you have any hints ?
> THX
> ? Thomas
> 

-- 
Stefan Lucke



From admin at berlios.de  Thu Feb 23 20:09:03 2006
From: admin at berlios.de (admin at berlios.de)
Date: Thu, 23 Feb 2006 20:09:03 +0100 (CET)
Subject: [Softdevice-devel] [Bug #6551] Keine Transparenz
Message-ID: <200602231909.k1NJ93eF019385@unicorn.berlios.de>

Bug #6551, was updated on 2006-Feb-23 00:51
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: xv-out
Status: Open
Resolution: None
Bug Group: None
Priority: 5
Submitted by: daliman
Assigned to : none
Summary: Keine Transparenz

Details: Wenn kein Stream angezeigt wird, z.B. bei Radiosendern, wird das OSD-Men? nicht transparent angezeigt. (OSD-Alphablending PSEUDO/Software). Das ist auch beim Kanalwechsel kurzfristig der Fall.

Follow-Ups:

Date: 2006-Feb-23 20:09
By: wachm

Comment:
Ich bin mir nicht sicher ob ich das richtig verstehe wenn du von nicht transparent redest, meinst du das der Hintergrund schwarz wird?

Zum ShmClient: Erstmal m?chte ich dich bitten f?r jedes Problem einen speparaten Bugreport zu ?ffnen, das macht das Verwalten einfacher.
Ich kann dieses Problem nicht reproduzieren, die Fehlermeldung stammt aus einer Datei die zum Vdr geh?rt. Deshalb brauche ich noch etwas mehr Informationen (die ?brigens zu jedem guten Bugreport geh?ren): Vdr-Version (ist die gepatcht?), gcc/g++ Version und Distribution.  

-------------------------------------------------------

Date: 2006-Feb-23 01:02
By: daliman

Comment:
Nachtrag: Auch der ShmClient bringt Fehler:
../../../include/vdr/ci.h:114: error: two or more data types in declaration of 'parameter'
ShmClient.c: In function 'int main(int, char**)':
ShmClient.c:77: warning: unused variable 'curr_pict_shmid'

-------------------------------------------------------

For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=6551&group_id=2051


From M.Wache at gmx.net  Thu Feb 23 20:24:20 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 23 Feb 2006 20:24:20 +0100
Subject: [Softdevice-devel] Displaying images
In-Reply-To: <43FB562F.6050509@gmx.de>
References: <43F9EFE1.5010000@gmx.de> <200602202302.47845.stefan@lucke.in-berlin.de> <43FA4312.4050706@gmx.de> <43FB47D5.1040900@gmx.net> <43FB4F0C.2000102@gmx.de> <43FB5274.5090106@gmx.net> <43FB562F.6050509@gmx.de>
Message-ID: <43FE0BE4.70803@gmx.net>

Sebastian Vandersee schrieb:

>> The best graphics format would be YUV420, then we can display it in the
>> video layer. The image has also to be scaled to some sensible
>> resolution, for the YUV420 format that can also be done be ffmpeg with
>> av_img_resample() or similar.
>>
>> I would prefer to use ffmpeg (I know that it is possible to do it with
>> ffmpeg - I'm just not sure how it works), currently that is the only
>> library which is needed, and I don't like the idea of having a
>> dependency on imagemagick.
>>
> Well, if I create a separate plugin which utilize another lib
> (e.g. ImageMagick) to transform pics to YUV420 and then pass it
> to softdevice, there will be no dependency on ImageMagick for
> softdevice.
> Anyway, I'll take a look at the API provided by ffmpeg.
> 
Sure, if you create your own plugin  I don't mind any dependencies ;-)

Maybe you should also consider libjpeg, like Marko suggested since vdr
depends on it I think it doesn't harm if softplay or softdevice also
depend on it. I wonder why it didn't come to my mind ;-)
Thanks Marko!

Bye,
Martin


From M.Wache at gmx.net  Thu Feb 23 20:30:58 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 23 Feb 2006 20:30:58 +0100
Subject: [Softdevice-devel] New OSD and Scalling
In-Reply-To: <43FDFA8F.4080503@t-online.de>
References: <43FDFA8F.4080503@t-online.de>
Message-ID: <43FE0D72.6070406@gmx.net>

Alexander Riedel schrieb:
> Hi All!
> 
> Is there a possibility in the new OSD auto scalling to switch off?
> I have developed an UTF-8 patch for vdr.
> http://www.vdr-wiki.de/wiki/index.php/Utf8-patch
> 
> Patch contains Freetype and can auserdem native antialiasing.
> And now with new OSD the picture becomes antialiased, however, without
> scalling became symbole much nicer.
> See:
> http://www.vdr-wiki.de/wiki/index.php/Bild:Utf8-patch-01.png
> or
> http://www.vdr-wiki.de/wiki/index.php/Bild:Utf8-patch-05.png
> 

No, currently there is no switch to do that. But you can simply return
-1 for the OSDWidth and OSDHeight in the GetOSDDimension() function of
your video out method. Then the OSD won't be scaled.

Bye,
Martin


From marko.makela at hut.fi  Thu Feb 23 20:48:53 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 23 Feb 2006 21:48:53 +0200
Subject: [Softdevice-devel] Displaying images
In-Reply-To: <43FE0BE4.70803@gmx.net>
References: <43F9EFE1.5010000@gmx.de> <200602202302.47845.stefan@lucke.in-berlin.de> <43FA4312.4050706@gmx.de> <43FB47D5.1040900@gmx.net> <43FB4F0C.2000102@gmx.de> <43FB5274.5090106@gmx.net> <43FB562F.6050509@gmx.de> <43FE0BE4.70803@gmx.net>
Message-ID: <20060223194853.GB10545@localhost.localdomain>

On Thu, Feb 23, 2006 at 08:24:20PM +0100, Martin Wache wrote:
> Maybe you should also consider libjpeg, like Marko suggested since vdr
> depends on it I think it doesn't harm if softplay or softdevice also
> depend on it. I wonder why it didn't come to my mind ;-)
> Thanks Marko!

No problem.  BTW, do you know if there is any JPEG viewer that would
do the color space transformation (normally YCbCr -> RGB) and scaling
in hardware (Xv)?  I guess it would save some CPU if the Y component
could be passed as is.

	Marko


From M.Wache at gmx.net  Thu Feb 23 21:25:49 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 23 Feb 2006 21:25:49 +0100
Subject: [Softdevice-devel] Displaying images
In-Reply-To: <20060223194853.GB10545@localhost.localdomain>
References: <43F9EFE1.5010000@gmx.de> <200602202302.47845.stefan@lucke.in-berlin.de> <43FA4312.4050706@gmx.de> <43FB47D5.1040900@gmx.net> <43FB4F0C.2000102@gmx.de> <43FB5274.5090106@gmx.net> <43FB562F.6050509@gmx.de> <43FE0BE4.70803@gmx.net> <20060223194853.GB10545@localhost.localdomain>
Message-ID: <43FE1A4D.1080705@gmx.net>

Marko M?kel? schrieb:
> On Thu, Feb 23, 2006 at 08:24:20PM +0100, Martin Wache wrote:
>> Maybe you should also consider libjpeg, like Marko suggested since vdr
>> depends on it I think it doesn't harm if softplay or softdevice also
>> depend on it. I wonder why it didn't come to my mind ;-)
>> Thanks Marko!
> 
> No problem.  BTW, do you know if there is any JPEG viewer that would
> do the color space transformation (normally YCbCr -> RGB) and scaling
> in hardware (Xv)?  I guess it would save some CPU if the Y component
> could be passed as is.
> 
No, I don't know one and I doubt that there is one. I don't think the
savings on the CPU time is worth the efforts, and you add requirements
to the video driver.
But if Sebastian manages to decode the images the softdevice will do it
like this :-)

Bye,

Martin


From seb42 at gmx.de  Thu Feb 23 22:50:15 2006
From: seb42 at gmx.de (Sebastian Vandersee)
Date: Thu, 23 Feb 2006 22:50:15 +0100
Subject: [Softdevice-devel] Displaying images
In-Reply-To: <43FE1A4D.1080705@gmx.net>
References: <43F9EFE1.5010000@gmx.de> <200602202302.47845.stefan@lucke.in-berlin.de> <43FA4312.4050706@gmx.de> <43FB47D5.1040900@gmx.net> <43FB4F0C.2000102@gmx.de> <43FB5274.5090106@gmx.net> <43FB562F.6050509@gmx.de> <43FE0BE4.70803@gmx.net> <20060223194853.GB10545@localhost.localdomain> <43FE1A4D.1080705@gmx.net>
Message-ID: <43FE2E17.6010803@gmx.de>

Martin Wache schrieb:

> Marko M?kel? schrieb:
> 
>>On Thu, Feb 23, 2006 at 08:24:20PM +0100, Martin Wache wrote:
>>
>>>Maybe you should also consider libjpeg, like Marko suggested since vdr
>>>depends on it I think it doesn't harm if softplay or softdevice also
>>>depend on it. I wonder why it didn't come to my mind ;-)
>>>Thanks Marko!
>>
>>No problem.  BTW, do you know if there is any JPEG viewer that would
>>do the color space transformation (normally YCbCr -> RGB) and scaling
>>in hardware (Xv)?  I guess it would save some CPU if the Y component
>>could be passed as is.
>>
> 
> No, I don't know one and I doubt that there is one. I don't think the
> savings on the CPU time is worth the efforts, and you add requirements
> to the video driver.
> But if Sebastian manages to decode the images the softdevice will do it
> like this :-)
> 
Hehe, that puts some pressure on me to implement jpeg decoding ;-)
Hopefully I can start looking at it next week.

Sebastian


From admin at berlios.de  Thu Feb 23 22:26:48 2006
From: admin at berlios.de (admin at berlios.de)
Date: Thu, 23 Feb 2006 22:26:48 +0100 (CET)
Subject: [Softdevice-devel] [Feature #1291] OSD does not scale
Message-ID: <200602232126.k1NLQmco021805@unicorn.berlios.de>

Feature Request #1291, was updated on 2005-Sep-21 22:53
You can respond by visiting: 
http://developer.berlios.de/feature/?func=detailfeature&feature_id=1291&group_id=2051

Category: None
Status: Closed
Priority: 5
Summary: OSD does not scale

By: wachm
Date: 2006-Feb-23 22:26

Message:
Logged In: YES 
user_id=11379
Browser: Mozilla/5.0 (Macintosh; U; PPC Mac OS X Mach-O; de; rv:1.8.0.1) Gecko/20060111 Firefox/1.5.0.1

Since Version 2.2 upscaling of the OSD is supported for
>vdr-1.37

----------------------------------------------------------------------

By: thorsten
Date: 2005-Sep-21 22:53

Message:
Logged In: YES 
user_id=19783
Browser: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.7.8) Gecko/20050521

I use a TerraTec Cinergy T2 USB DVB-T with VDR 1.2.6
and softdevice. Unfortunately, when switching to
fullscreen mode the OSD is not scaled (it stays 7xx*5xx
while the picture itself is scaled to 1400x1050).
Therefore one cannot use the OSD to control the TV from
more than 1-2 meters.

----------------------------------------------------------------------
You can respond by visiting: 
http://developer.berlios.de/feature/?func=detailfeature&feature_id=1291&group_id=2051


From marko.makela at hut.fi  Fri Feb 24 11:43:01 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 24 Feb 2006 12:43:01 +0200
Subject: [Softdevice-devel] Displaying images
In-Reply-To: <43FE2E17.6010803@gmx.de>
References: <200602202302.47845.stefan@lucke.in-berlin.de> <43FA4312.4050706@gmx.de> <43FB47D5.1040900@gmx.net> <43FB4F0C.2000102@gmx.de> <43FB5274.5090106@gmx.net> <43FB562F.6050509@gmx.de> <43FE0BE4.70803@gmx.net> <20060223194853.GB10545@localhost.localdomain> <43FE1A4D.1080705@gmx.net> <43FE2E17.6010803@gmx.de>
Message-ID: <20060224104301.GA5714@localhost.localdomain>

On Thu, Feb 23, 2006 at 10:50:15PM +0100, Sebastian Vandersee wrote:
> >>No problem.  BTW, do you know if there is any JPEG viewer that would
> >>do the color space transformation (normally YCbCr -> RGB) and scaling
> >>in hardware (Xv)?  I guess it would save some CPU if the Y component
> >>could be passed as is.
> >>
> > 
> > No, I don't know one and I doubt that there is one. I don't think the
> > savings on the CPU time is worth the efforts, and you add requirements
> > to the video driver.
> > But if Sebastian manages to decode the images the softdevice will do it
> > like this :-)
> > 
> Hehe, that puts some pressure on me to implement jpeg decoding ;-)
> Hopefully I can start looking at it next week.

Well, if I were you, I'd probably go the YCbCr -> RGB -> YUV route first,
and then determine that implementing all possible conversions YCbCr -> I420,
YCbCr -> YV12, YCbCr -> YUY2 etc. is not worth the effort. :-)

For what it is worth, I've written a JPEG to JPEG image scaler that also
converts CMYK to RGB.  It's in the file scale.c of my photomolo package,
of which I just released a new version:
http://www.iki.fi/~msmakela/software/photomolo/

You might find that useful, since I guess you will want to scale the images.
The algorithm scales the image line by line, that is, it will not decompress
the whole JPEG image first.  It'd be easy to modify the code to store the
downscaled RGB image data instead of passing it to libjpeg.

See also libjpeg.doc (/usr/share/doc/libjpeg62-dev/libjpeg.doc.gz on Debian).
I found the document very helpful.

	Marko


From marko.makela at hut.fi  Fri Feb 24 13:32:48 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 24 Feb 2006 14:32:48 +0200
Subject: [Softdevice-devel] Implementing the GRAB command
Message-ID: <20060224123248.GA5860@localhost.localdomain>

This caught my eye on the vdr mailing list.  Without looking at the source,
I guess that the contents of the frame buffer would have to be converted
to RGB in order for the GRAB command to work.

	Marko
----- Forwarded message from Andreas Mair <Andreas.Mair at linogate.com> -----

From: Andreas Mair <Andreas.Mair at linogate.com>
Subject: Re: [vdr] VDRAdmin doesn't display preview of channel
To: VDR Mailing List <vdr at linuxtv.org>
Reply-to: VDR Mailing List <vdr at linuxtv.org>
Organization: Linogate

On Friday 24 February 2006 13:10, Niko Mikkila wrote:
> On Fri, 24 Feb 2006 13:35:47 +0200
>
> Jouni Karvo <jouni.karvo at tkk.fi> wrote:
> > Niko Mikkila writes:
> >  > Preview only works with full-featured DVB-cards that have an onboard
> >  > MPEG-2 decoder. With budget cards you can install streamdev-server
> >  > plugin and use streaming instead, but you won't get OSD that way.
> >
> > Well - I have got periodic still images (including OSD) with vdr-xine.
> > I am not sure about after the last upgrade, though.  For streaming,
> > yes, no such thing.
>
> Interesting. Where does VDR Admin get those decoded images from?
> I thought the only source VDR Admin uses is /dev/video* and that is
> certainly not available when having only Xine (or softdevice or Dxr3)
> as a decoder. Are you sure you don't have a FF card in your system?

VDRAdmin uses VDR's "grab" command. AFAIK the output device plugins have to 
implement this feature so that VDR can grab. Seems like it's implemented 
for vdr-xine and FF cards, but not for vdr-softdevice.

Regards,
Andreas

_______________________________________________
vdr mailing list
vdr at linuxtv.org
http://www.linuxtv.org/cgi-bin/mailman/listinfo/vdr

----- End forwarded message -----


From admin at berlios.de  Fri Feb 24 18:33:25 2006
From: admin at berlios.de (admin at berlios.de)
Date: Fri, 24 Feb 2006 08:33:25 -0900 (AKST)
Subject: [Softdevice-devel] [Bug #6551] Keine Transparenz
Message-ID: <200602241733.k1OHXPq8019134@unicorn.berlios.de>

Bug #6551, was updated on 2006-Feb-22 14:51
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: xv-out
Status: Open
Resolution: None
Bug Group: None
Priority: 5
Submitted by: daliman
Assigned to : none
Summary: Keine Transparenz

Details: Wenn kein Stream angezeigt wird, z.B. bei Radiosendern, wird das OSD-Men? nicht transparent angezeigt. (OSD-Alphablending PSEUDO/Software). Das ist auch beim Kanalwechsel kurzfristig der Fall.

Follow-Ups:

Date: 2006-Feb-24 08:33
By: daliman

Comment:
OSD-Men?s k?nnen transparent dargestellt werden. (im SoftwareModus). Beim Kanalwechsel schein SD kurzfristig in den PSEUDO-Modus (Alphablending) umzuschalten, bei dem ja keine Transparenz dargestellt werden kann.

vdr 1.3.43 
SuSE 10.0
gcc 4.0.2

mit ungepanschtem VDR und gepatchtem VDR (BigPatch + EasyDiseqc) ist es gleich.
 
-------------------------------------------------------

Date: 2006-Feb-23 10:09
By: wachm

Comment:
Ich bin mir nicht sicher ob ich das richtig verstehe wenn du von nicht transparent redest, meinst du das der Hintergrund schwarz wird?

Zum ShmClient: Erstmal m?chte ich dich bitten f?r jedes Problem einen speparaten Bugreport zu ?ffnen, das macht das Verwalten einfacher.
Ich kann dieses Problem nicht reproduzieren, die Fehlermeldung stammt aus einer Datei die zum Vdr geh?rt. Deshalb brauche ich noch etwas mehr Informationen (die ?brigens zu jedem guten Bugreport geh?ren): Vdr-Version (ist die gepatcht?), gcc/g++ Version und Distribution.  

-------------------------------------------------------

Date: 2006-Feb-22 15:02
By: daliman

Comment:
Nachtrag: Auch der ShmClient bringt Fehler:
../../../include/vdr/ci.h:114: error: two or more data types in declaration of 'parameter'
ShmClient.c: In function 'int main(int, char**)':
ShmClient.c:77: warning: unused variable 'curr_pict_shmid'

-------------------------------------------------------

For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=6551&group_id=2051


From M.Wache at gmx.net  Sat Feb 25 16:50:46 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sat, 25 Feb 2006 16:50:46 +0100
Subject: [Softdevice-devel] Displaying images
In-Reply-To: <20060224104301.GA5714@localhost.localdomain>
References: <200602202302.47845.stefan@lucke.in-berlin.de> <43FA4312.4050706@gmx.de> <43FB47D5.1040900@gmx.net> <43FB4F0C.2000102@gmx.de> <43FB5274.5090106@gmx.net> <43FB562F.6050509@gmx.de> <43FE0BE4.70803@gmx.net> <20060223194853.GB10545@localhost.localdomain> <43FE1A4D.1080705@gmx.net> <43FE2E17.6010803@gmx.de> <20060224104301.GA5714@localhost.localdomain>
Message-ID: <44007CD6.3000904@gmx.net>

Marko M?kel? schrieb:
> On Thu, Feb 23, 2006 at 10:50:15PM +0100, Sebastian Vandersee wrote:
>>>> No problem.  BTW, do you know if there is any JPEG viewer that would
>>>> do the color space transformation (normally YCbCr -> RGB) and scaling
>>>> in hardware (Xv)?  I guess it would save some CPU if the Y component
>>>> could be passed as is.
>>>>
>>> No, I don't know one and I doubt that there is one. I don't think the
>>> savings on the CPU time is worth the efforts, and you add requirements
>>> to the video driver.
>>> But if Sebastian manages to decode the images the softdevice will do it
>>> like this :-)
>>>
>> Hehe, that puts some pressure on me to implement jpeg decoding ;-)
>> Hopefully I can start looking at it next week.
> 
> Well, if I were you, I'd probably go the YCbCr -> RGB -> YUV route first,
> and then determine that implementing all possible conversions YCbCr -> I420,
> YCbCr -> YV12, YCbCr -> YUY2 etc. is not worth the effort. :-)
> 
Maybe I'm mistaken, but isn't the only difference between jpeg's YCrCr
and the YUV format used by mpeg2 the range of the values? To my
knowledge one format doesn't use the full range of 0-255 possible for a
byte. So the conversion from YCbCr to YUV should be a lot simpler that
going via RGB. And the only necessary format to support would be YUV420P
(YUV planar, U and V component having 1/4 of the resolution of the Y
component) since the softdevice can do all the conversions from YUV420P :-)

Bye,
Martin


From M.Wache at gmx.net  Sat Feb 25 16:56:30 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sat, 25 Feb 2006 16:56:30 +0100
Subject: [Softdevice-devel] Implementing the GRAB command
In-Reply-To: <20060224123248.GA5860@localhost.localdomain>
References: <20060224123248.GA5860@localhost.localdomain>
Message-ID: <44007E2E.6050907@gmx.net>

Marko M?kel? schrieb:
> This caught my eye on the vdr mailing list.  Without looking at the source,
> I guess that the contents of the frame buffer would have to be converted
> to RGB in order for the GRAB command to work.
> 
Implementing the GRAB command is on my Todo list for some time, but I
never managed to have a closer look... Currently I'm looking at how to
handle the picture buffers better in the softdevice and possibly
implement direct rendering. Unfortunately not all Xv implementations
behave the same. Maybe that is a good opportunity to implement the
Grab() method.

Martin


From admin at berlios.de  Sat Feb 25 16:29:15 2006
From: admin at berlios.de (admin at berlios.de)
Date: Sat, 25 Feb 2006 16:29:15 +0100 (CET)
Subject: [Softdevice-devel] [Bug #6551] Keine Transparenz
Message-ID: <200602251529.k1PFTFjc001103@unicorn.berlios.de>

Bug #6551, was updated on 2006-Feb-23 00:51
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: xv-out
Status: Open
Resolution: None
Bug Group: None
Priority: 5
Submitted by: daliman
Assigned to : none
Summary: Keine Transparenz

Details: Wenn kein Stream angezeigt wird, z.B. bei Radiosendern, wird das OSD-Men? nicht transparent angezeigt. (OSD-Alphablending PSEUDO/Software). Das ist auch beim Kanalwechsel kurzfristig der Fall.

Follow-Ups:

Date: 2006-Feb-25 16:29
By: wachm

Comment:
Das das Softdevice von sich aus in den Pseudo-Osd Modus umschaltet halte ich f?r sehr unwahrscheinlich. Kannst du bitte deinen Bildschirm abfotografieren und einen Link zu den Bildern posten damit ich mal sehen kann wie das aussieht? Wird der Hintergrund eigentlich schwarz wenn das passiert?

Martin
-------------------------------------------------------

Date: 2006-Feb-24 18:33
By: daliman

Comment:
OSD-Men?s k?nnen transparent dargestellt werden. (im SoftwareModus). Beim Kanalwechsel schein SD kurzfristig in den PSEUDO-Modus (Alphablending) umzuschalten, bei dem ja keine Transparenz dargestellt werden kann.

vdr 1.3.43 
SuSE 10.0
gcc 4.0.2

mit ungepanschtem VDR und gepatchtem VDR (BigPatch + EasyDiseqc) ist es gleich.
 
-------------------------------------------------------

Date: 2006-Feb-23 20:09
By: wachm

Comment:
Ich bin mir nicht sicher ob ich das richtig verstehe wenn du von nicht transparent redest, meinst du das der Hintergrund schwarz wird?

Zum ShmClient: Erstmal m?chte ich dich bitten f?r jedes Problem einen speparaten Bugreport zu ?ffnen, das macht das Verwalten einfacher.
Ich kann dieses Problem nicht reproduzieren, die Fehlermeldung stammt aus einer Datei die zum Vdr geh?rt. Deshalb brauche ich noch etwas mehr Informationen (die ?brigens zu jedem guten Bugreport geh?ren): Vdr-Version (ist die gepatcht?), gcc/g++ Version und Distribution.  

-------------------------------------------------------

Date: 2006-Feb-23 01:02
By: daliman

Comment:
Nachtrag: Auch der ShmClient bringt Fehler:
../../../include/vdr/ci.h:114: error: two or more data types in declaration of 'parameter'
ShmClient.c: In function 'int main(int, char**)':
ShmClient.c:77: warning: unused variable 'curr_pict_shmid'

-------------------------------------------------------

For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=6551&group_id=2051


From admin at berlios.de  Mon Feb 27 02:14:07 2006
From: admin at berlios.de (admin at berlios.de)
Date: Sun, 26 Feb 2006 16:14:07 -0900 (AKST)
Subject: [Softdevice-devel] [Bug #6551] Keine Transparenz
Message-ID: <200602270114.k1R1E7iP020462@unicorn.berlios.de>

Bug #6551, was updated on 2006-Feb-22 14:51
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: xv-out
Status: Open
Resolution: None
Bug Group: None
Priority: 5
Submitted by: daliman
Assigned to : none
Summary: Keine Transparenz

Details: Wenn kein Stream angezeigt wird, z.B. bei Radiosendern, wird das OSD-Men? nicht transparent angezeigt. (OSD-Alphablending PSEUDO/Software). Das ist auch beim Kanalwechsel kurzfristig der Fall.

Follow-Ups:

Date: 2006-Feb-26 16:14
By: daliman

Comment:
Diese Problem scheint kein SD-Problem zu sein, denn mit einer ?lteren VDR Version (< 1.3.40) funktioniert es. Auch die OSD-Gr??e beim Kanalwechsel artet bei den neueren Versionen in einem Zucken aus. (s. Xine). 
-------------------------------------------------------

Date: 2006-Feb-25 06:29
By: wachm

Comment:
Das das Softdevice von sich aus in den Pseudo-Osd Modus umschaltet halte ich f?r sehr unwahrscheinlich. Kannst du bitte deinen Bildschirm abfotografieren und einen Link zu den Bildern posten damit ich mal sehen kann wie das aussieht? Wird der Hintergrund eigentlich schwarz wenn das passiert?

Martin
-------------------------------------------------------

Date: 2006-Feb-24 08:33
By: daliman

Comment:
OSD-Men?s k?nnen transparent dargestellt werden. (im SoftwareModus). Beim Kanalwechsel schein SD kurzfristig in den PSEUDO-Modus (Alphablending) umzuschalten, bei dem ja keine Transparenz dargestellt werden kann.

vdr 1.3.43 
SuSE 10.0
gcc 4.0.2

mit ungepanschtem VDR und gepatchtem VDR (BigPatch + EasyDiseqc) ist es gleich.
 
-------------------------------------------------------

Date: 2006-Feb-23 10:09
By: wachm

Comment:
Ich bin mir nicht sicher ob ich das richtig verstehe wenn du von nicht transparent redest, meinst du das der Hintergrund schwarz wird?

Zum ShmClient: Erstmal m?chte ich dich bitten f?r jedes Problem einen speparaten Bugreport zu ?ffnen, das macht das Verwalten einfacher.
Ich kann dieses Problem nicht reproduzieren, die Fehlermeldung stammt aus einer Datei die zum Vdr geh?rt. Deshalb brauche ich noch etwas mehr Informationen (die ?brigens zu jedem guten Bugreport geh?ren): Vdr-Version (ist die gepatcht?), gcc/g++ Version und Distribution.  

-------------------------------------------------------

Date: 2006-Feb-22 15:02
By: daliman

Comment:
Nachtrag: Auch der ShmClient bringt Fehler:
../../../include/vdr/ci.h:114: error: two or more data types in declaration of 'parameter'
ShmClient.c: In function 'int main(int, char**)':
ShmClient.c:77: warning: unused variable 'curr_pict_shmid'

-------------------------------------------------------

For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=6551&group_id=2051


From jpahka at welho.com  Mon Feb 27 13:23:46 2006
From: jpahka at welho.com (jpahka at welho.com)
Date: Mon, 27 Feb 2006 14:23:46 +0200
Subject: [Softdevice-devel] Toggle aspect ratio?
Message-ID: <1141043026.4402ef52cb52a@webmail.welho.com>

A feature perhaps to softdevice: I have a widescreen (16:9) crt television and a
G400 videocard, and use the primary head of my g400 to output to my tv via
svideo. I'm using the latest stable version (0.2.2) of softdevice. Now the thing
is: I live in Finland and at least here, the aspect ratio of the dvb
transmissions is changing virtually between every show (htv cable network). This
means I have to change my softdevice setup all the time in order to see the
shows the way I want to, ie. 16:9 shows in full and 4:3 shows 'stretched'

I grepped through the sources and saw that there aren't that many places where
the aspect ratio selection is specified. Perhaps it would be easy to add a
feature to softdevice to be able to toggle between (only) 4:3 and 16:9 aspect
ratio with a single button press in remote while watching live tv or a
recording. This would make using softdevice a lot easier for me at least (which
btw already is a lot of fun, since it works so great!).

If somebody has any pointers how to do this, I'd be very greatful...

TIA, juhis



From torgeir at pobox.com  Mon Feb 27 13:40:04 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Mon, 27 Feb 2006 22:40:04 +1000
Subject: [Softdevice-devel] Toggle aspect ratio?
In-Reply-To: <1141043026.4402ef52cb52a@webmail.welho.com>
References: <1141043026.4402ef52cb52a@webmail.welho.com>
Message-ID: <1141044004.11404.9.camel@localhost.localdomain>

On Mon, 2006-02-27 at 14:23 +0200, jpahka at welho.com wrote:
> Perhaps it would be easy to add a
> feature to softdevice to be able to toggle between (only) 4:3 and 16:9
> aspect
> ratio with a single button press in remote while watching live tv or a
> recording. 

Are you refering to broadcasts of 16:9 recordings inside a plain 4:3
transmission? If so I think you're looking for a zoom button. 

Softdevice should otherwise handle any properly coded transmission and
display it at the greates possible size inside the configured screen
size.

-- 
Torgeir Veimo <torgeir at pobox.com>



From jpahka at welho.com  Mon Feb 27 14:34:41 2006
From: jpahka at welho.com (Juha Pahkala)
Date: Mon, 27 Feb 2006 15:34:41 +0200
Subject: [Softdevice-devel] Toggle aspect ratio?
In-Reply-To: <1141044004.11404.9.camel@localhost.localdomain>
References: <1141043026.4402ef52cb52a@webmail.welho.com> <1141044004.11404.9.camel@localhost.localdomain>
Message-ID: <4402FFF1.70202@welho.com>

Torgeir Veimo wrote:

>On Mon, 2006-02-27 at 14:23 +0200, jpahka at welho.com wrote:
>  
>
>>Perhaps it would be easy to add a
>>feature to softdevice to be able to toggle between (only) 4:3 and 16:9
>>aspect
>>ratio with a single button press in remote while watching live tv or a
>>recording. 
>>    
>>
>
>Are you refering to broadcasts of 16:9 recordings inside a plain 4:3
>transmission? If so I think you're looking for a zoom button. 
>
>Softdevice should otherwise handle any properly coded transmission and
>display it at the greates possible size inside the configured screen
>size.
>
>  
>
I suppose so. I mean that If configure my screen aspect ratio to be 4:3, 
I sometimes get black bars above and below the picture, and if I 
configure it to be 16:9, I get them left and right. And I don't want 
them at all ;)

So, how can I enable this 'zoom mode'? Is this the same as the Crop 
Mode? Because that often zooms the picture too large. Or are you 
referring to some other setting?

juhis


From marko.makela at hut.fi  Mon Feb 27 16:57:34 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 27 Feb 2006 17:57:34 +0200
Subject: [Softdevice-devel] Toggle aspect ratio?
In-Reply-To: <4402FFF1.70202@welho.com>
References: <1141043026.4402ef52cb52a@webmail.welho.com> <1141044004.11404.9.camel@localhost.localdomain> <4402FFF1.70202@welho.com>
Message-ID: <20060227155734.GB15551@localhost.localdomain>

On Mon, Feb 27, 2006 at 03:34:41PM +0200, Juha Pahkala wrote:
> >Are you refering to broadcasts of 16:9 recordings inside a plain 4:3
> >transmission? If so I think you're looking for a zoom button. 

Usually, in Finland they won't change the aspect ratio during the program,
except for commercial breaks, which always seem to be sent in 4:3.

Instead, they either add bars at top and bottom or crop top and bottom (!).
I've observed the cropping in Nalle Luppakorva (Mi? Uszatek).

> >Softdevice should otherwise handle any properly coded transmission and
> >display it at the greates possible size inside the configured screen
> >size.
> >
> > 
> >
> I suppose so. I mean that If configure my screen aspect ratio to be 4:3, 
> I sometimes get black bars above and below the picture, and if I 
> configure it to be 16:9, I get them left and right. And I don't want 
> them at all ;)

Do you have a 16:9 TV screen?  Perhaps softdevice should generate the WSS
signal, so that your screen would automatically add the bars?

> So, how can I enable this 'zoom mode'? Is this the same as the Crop 
> Mode? Because that often zooms the picture too large. Or are you 
> referring to some other setting?

CropModeToggleKey works fine for me.  I have an old 4:3 PAL and RGB monitor.

	Marko


From jpahka at welho.com  Mon Feb 27 18:07:34 2006
From: jpahka at welho.com (Juha Pahkala)
Date: Mon, 27 Feb 2006 19:07:34 +0200
Subject: [Softdevice-devel] Toggle aspect ratio?
In-Reply-To: <20060227155734.GB15551@localhost.localdomain>
References: <1141043026.4402ef52cb52a@webmail.welho.com> <1141044004.11404.9.camel@localhost.localdomain> <4402FFF1.70202@welho.com> <20060227155734.GB15551@localhost.localdomain>
Message-ID: <440331D6.7080406@welho.com>

Marko M?kel? wrote:

>On Mon, Feb 27, 2006 at 03:34:41PM +0200, Juha Pahkala wrote:
>  
>
>>>Are you refering to broadcasts of 16:9 recordings inside a plain 4:3
>>>transmission? If so I think you're looking for a zoom button. 
>>>      
>>>
>
>Usually, in Finland they won't change the aspect ratio during the program,
>except for commercial breaks, which always seem to be sent in 4:3.
>
>Instead, they either add bars at top and bottom or crop top and bottom (!).
>I've observed the cropping in Nalle Luppakorva (Mi? Uszatek).
>
>  
>
>>>Softdevice should otherwise handle any properly coded transmission and
>>>display it at the greates possible size inside the configured screen
>>>size.
>>>
>>>
>>>
>>>      
>>>
>>I suppose so. I mean that If configure my screen aspect ratio to be 4:3, 
>>I sometimes get black bars above and below the picture, and if I 
>>configure it to be 16:9, I get them left and right. And I don't want 
>>them at all ;)
>>    
>>
>
>Do you have a 16:9 TV screen?  Perhaps softdevice should generate the WSS
>signal, so that your screen would automatically add the bars?
>
>  
>
>>So, how can I enable this 'zoom mode'? Is this the same as the Crop 
>>Mode? Because that often zooms the picture too large. Or are you 
>>referring to some other setting?
>>    
>>
>
>CropModeToggleKey works fine for me.  I have an old 4:3 PAL and RGB monitor.
>
>  
>
Yes, I do have a 16:9 TV screen. And if I set the softdevice aspect 
ratio to 16:9 and the broadcast is 4:3 (as it often is eg. in the 
'subtv' channel) the crop modes are as follows:

   None   ->   black bars left & right

    4:3   ->   black bars left & right

   16:9   ->   picture zoomed so that aspect ratio is constant, width 
ok, but top and bottom of the picture are not visible.

And with the aspect ratio set to 4:3 and the broadcast 16:9 the same 
thing happens when zooming, apect ratio remains, but left and right 
parts of the picture invisible.

So, what I'm missing is the 'stretch' effect that I get when eg. 
watching a 4:3 brodcast in 4:3 aspect ratio mode.

So, is this a bug then? In softdevice or directfb? My directfb version 
is a cvs snapshot from around mid december (so 0.9.25 cvs) and 
softdevice is latest stable (0.2.2). And my vdr command is: "-P 
'softdevice -vo dfb:triple ...'". So g400, first head.

TIA, juhis







From stefan at lucke.in-berlin.de  Tue Feb 28 06:59:27 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 28 Feb 2006 06:59:27 +0100
Subject: [Softdevice-devel] Toggle aspect ratio?
In-Reply-To: <440331D6.7080406@welho.com>
References: <1141043026.4402ef52cb52a@webmail.welho.com> <20060227155734.GB15551@localhost.localdomain> <440331D6.7080406@welho.com>
Message-ID: <200602280659.27703.stefan@lucke.in-berlin.de>

On Montag, 27. Februar 2006 18:07, Juha Pahkala wrote:
> Yes, I do have a 16:9 TV screen. And if I set the softdevice aspect 
> ratio to 16:9 and the broadcast is 4:3 (as it often is eg. in the 
> 'subtv' channel) the crop modes are as follows:
> 
>    None   ->   black bars left & right
> 
>     4:3   ->   black bars left & right
> 
>    16:9   ->   picture zoomed so that aspect ratio is constant, width 
> ok, but top and bottom of the picture are not visible.

That is the expected behaviour. Allways keep the aspect ratio.

> 
> And with the aspect ratio set to 4:3 and the broadcast 16:9 the same 
> thing happens when zooming, apect ratio remains, but left and right 
> parts of the picture invisible.
> 
> So, what I'm missing is the 'stretch' effect that I get when eg. 
> watching a 4:3 brodcast in 4:3 aspect ratio mode.

You want fat people ? A horizontal strech only ?
A varaible stretch, like keeping keeping center at contant ratio
and stretching the borders only is not possible.

> 
> So, is this a bug then? In softdevice or directfb? My directfb version 
> is a cvs snapshot from around mid december (so 0.9.25 cvs) and 
> softdevice is latest stable (0.2.2). And my vdr command is: "-P 
> 'softdevice -vo dfb:triple ...'". So g400, first head.
> 


-- 
Stefan Lucke



From jpahka at welho.com  Wed Mar  1 17:25:47 2006
From: jpahka at welho.com (Juha Pahkala)
Date: Wed, 01 Mar 2006 18:25:47 +0200
Subject: [Softdevice-devel] Toggle aspect ratio?
In-Reply-To: <200602280659.27703.stefan@lucke.in-berlin.de>
References: <1141043026.4402ef52cb52a@webmail.welho.com> <20060227155734.GB15551@localhost.localdomain> <440331D6.7080406@welho.com> <200602280659.27703.stefan@lucke.in-berlin.de>
Message-ID: <4405CB0B.6040508@welho.com>

Stefan Lucke wrote:

>
>>And with the aspect ratio set to 4:3 and the broadcast 16:9 the same 
>>thing happens when zooming, apect ratio remains, but left and right 
>>parts of the picture invisible.
>>
>>So, what I'm missing is the 'stretch' effect that I get when eg. 
>>watching a 4:3 brodcast in 4:3 aspect ratio mode.
>>    
>>
>
>You want fat people ? A horizontal strech only ?
>A varaible stretch, like keeping keeping center at contant ratio
>and stretching the borders only is not possible.
>
>  
>

Well, yes, I guess so :)  Surely a varaible strech would be even better, 
but a constant horizontal strech is what I get when I look at a 4:3 
brodcast in my 16:9 TV with softdevice in 4:3 mode, right? I do prefer 
that to the black bars left & right, that makes the picture look awfully 
small ;)

So, would that be an option in the crop mode then?

juhis




From seb42 at gmx.de  Sat Mar  4 13:41:57 2006
From: seb42 at gmx.de (Sebastian Vandersee)
Date: Sat, 04 Mar 2006 13:41:57 +0100
Subject: [Softdevice-devel] Displaying images
In-Reply-To: <44007CD6.3000904@gmx.net>
References: <200602202302.47845.stefan@lucke.in-berlin.de> <43FA4312.4050706@gmx.de> <43FB47D5.1040900@gmx.net> <43FB4F0C.2000102@gmx.de> <43FB5274.5090106@gmx.net> <43FB562F.6050509@gmx.de> <43FE0BE4.70803@gmx.net> <20060223194853.GB10545@localhost.localdomain> <43FE1A4D.1080705@gmx.net> <43FE2E17.6010803@gmx.de> <20060224104301.GA5714@localhost.localdomain> <44007CD6.3000904@gmx.net>
Message-ID: <44098B15.2040503@gmx.de>

Martin Wache schrieb:
> Marko M?kel? schrieb:
> 
>>On Thu, Feb 23, 2006 at 10:50:15PM +0100, Sebastian Vandersee wrote:
>>
>>>>>No problem.  BTW, do you know if there is any JPEG viewer that would
>>>>>do the color space transformation (normally YCbCr -> RGB) and scaling
>>>>>in hardware (Xv)?  I guess it would save some CPU if the Y component
>>>>>could be passed as is.
>>>>>
>>>>
>>>>No, I don't know one and I doubt that there is one. I don't think the
>>>>savings on the CPU time is worth the efforts, and you add requirements
>>>>to the video driver.
>>>>But if Sebastian manages to decode the images the softdevice will do it
>>>>like this :-)
>>>>
>>>
>>>Hehe, that puts some pressure on me to implement jpeg decoding ;-)
>>>Hopefully I can start looking at it next week.
>>
>>Well, if I were you, I'd probably go the YCbCr -> RGB -> YUV route first,
>>and then determine that implementing all possible conversions YCbCr -> I420,
>>YCbCr -> YV12, YCbCr -> YUY2 etc. is not worth the effort. :-)
>>
> 
> Maybe I'm mistaken, but isn't the only difference between jpeg's YCrCr
> and the YUV format used by mpeg2 the range of the values? To my
> knowledge one format doesn't use the full range of 0-255 possible for a
> byte. So the conversion from YCbCr to YUV should be a lot simpler that
> going via RGB. And the only necessary format to support would be YUV420P
> (YUV planar, U and V component having 1/4 of the resolution of the Y
> component) since the softdevice can do all the conversions from YUV420P :-)
> 
I've written a little jpeg decoder utility based on your suggestions.
It uses libjpeg to decode into YCbCr and then performs transformation
to YUV420P. No scaling yet.
So now my question is, how to feed the decompressed data into
softdevice?


Sebastian


From M.Wache at gmx.net  Sat Mar  4 18:11:00 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sat, 04 Mar 2006 18:11:00 +0100
Subject: [Softdevice-devel] Displaying images
In-Reply-To: <44098B15.2040503@gmx.de>
References: <200602202302.47845.stefan@lucke.in-berlin.de> <43FA4312.4050706@gmx.de> <43FB47D5.1040900@gmx.net> <43FB4F0C.2000102@gmx.de> <43FB5274.5090106@gmx.net> <43FB562F.6050509@gmx.de> <43FE0BE4.70803@gmx.net> <20060223194853.GB10545@localhost.localdomain> <43FE1A4D.1080705@gmx.net> <43FE2E17.6010803@gmx.de> <20060224104301.GA5714@localhost.localdomain> <44007CD6.3000904@gmx.net> <44098B15.2040503@gmx.de>
Message-ID: <4409CA24.7090200@gmx.net>

Sebastian Vandersee schrieb:

> I've written a little jpeg decoder utility based on your suggestions.
> It uses libjpeg to decode into YCbCr and then performs transformation
> to YUV420P. No scaling yet.

Nice to hear!

> So now my question is, how to feed the decompressed data into
> softdevice?
> 

I attached a fast and crude patch which exports the DrawStill_420pl()
function via the service interface. To use it you have to open the
softdevice for replay (like it is done in softplay or softieee1394),
then you can get function pointers to some replay functions including
the DrawStill() method via vdr's Service interface (see the
servicedemo-plugin). You can find the id-string and the structure in
softdevice.h.
Once you have the function pointer you just have to call DrawStill()
with the three planes Y,U,V, the width and the height, and the strides
(the number of bytes to jump to the next line) for Y and U,V planes.
Don't pass pictures greater than 736x576, it will result in a crash.

I did not test the patch, but there is not much which could go wrong,
some thinks are still to be done inside the softdevice, like saving a
local copy of the picture (for software osd blending), and we have to
discuss how to handle the aspect ratio...
So there are still some open points, but I think this is a starting
point for discussions :-)

Bye,

Martin
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: StillPictures.diff
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060304/24ee0b76/attachment.ksh>

From seb42 at gmx.de  Sun Mar  5 16:34:41 2006
From: seb42 at gmx.de (Sebastian Vandersee)
Date: Sun, 05 Mar 2006 16:34:41 +0100
Subject: [Softdevice-devel] Displaying images
In-Reply-To: <4409CA24.7090200@gmx.net>
References: <200602202302.47845.stefan@lucke.in-berlin.de> <43FA4312.4050706@gmx.de> <43FB47D5.1040900@gmx.net> <43FB4F0C.2000102@gmx.de> <43FB5274.5090106@gmx.net> <43FB562F.6050509@gmx.de> <43FE0BE4.70803@gmx.net> <20060223194853.GB10545@localhost.localdomain> <43FE1A4D.1080705@gmx.net> <43FE2E17.6010803@gmx.de> <20060224104301.GA5714@localhost.localdomain> <44007CD6.3000904@gmx.net> <44098B15.2040503@gmx.de> <4409CA24.7090200@gmx.net>
Message-ID: <440B0511.5060108@gmx.de>

Martin Wache schrieb:
> Sebastian Vandersee schrieb:
> 
>>So now my question is, how to feed the decompressed data into
>>softdevice?
>>
> 
> I attached a fast and crude patch which exports the DrawStill_420pl()
> function via the service interface. To use it you have to open the
> softdevice for replay (like it is done in softplay or softieee1394),
> then you can get function pointers to some replay functions including
> the DrawStill() method via vdr's Service interface (see the
> servicedemo-plugin). You can find the id-string and the structure in
> softdevice.h.
>
Thanks for the patch! It works for me. I wrote a really dumb vdr plugin
that displays a jpeg straight through softdevice.

> Once you have the function pointer you just have to call DrawStill()
> with the three planes Y,U,V, the width and the height, and the strides
> (the number of bytes to jump to the next line) for Y and U,V planes.
> Don't pass pictures greater than 736x576, it will result in a crash.
> 
Well, at the moment I'm using vdr with DFB + 1024x768 Res. So if I want
to see high res images, I rather would like to transform it to 1024x768
instead of using 720x576.

> I did not test the patch, but there is not much which could go wrong,
> some thinks are still to be done inside the softdevice, like saving a
> local copy of the picture (for software osd blending), and we have to
> discuss how to handle the aspect ratio...
> So there are still some open points, but I think this is a starting
> point for discussions :-)
> 
What I have in mind is an vdr-plugin "softimage", which would the
replace the existing vdr-image plugin for me. So I ask myself, what
functions should be provided by such a plugin and what functions
should belong to softdevice (regarding scaling, aspect ratio etc.)?
Any suggestions?

Sebastian


From M.Wache at gmx.net  Sun Mar  5 20:06:23 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 05 Mar 2006 20:06:23 +0100
Subject: [Softdevice-devel] Displaying images
In-Reply-To: <440B0511.5060108@gmx.de>
References: <200602202302.47845.stefan@lucke.in-berlin.de> <43FA4312.4050706@gmx.de> <43FB47D5.1040900@gmx.net> <43FB4F0C.2000102@gmx.de> <43FB5274.5090106@gmx.net> <43FB562F.6050509@gmx.de> <43FE0BE4.70803@gmx.net> <20060223194853.GB10545@localhost.localdomain> <43FE1A4D.1080705@gmx.net> <43FE2E17.6010803@gmx.de> <20060224104301.GA5714@localhost.localdomain> <44007CD6.3000904@gmx.net> <44098B15.2040503@gmx.de> <4409CA24.7090200@gmx.net> <440B0511.5060108@gmx.de>
Message-ID: <440B36AF.3020004@gmx.net>

Sebastian Vandersee schrieb:
> Martin Wache schrieb:
>> Sebastian Vandersee schrieb:
>>
>>> So now my question is, how to feed the decompressed data into
>>> softdevice?
>>>
>> I attached a fast and crude patch which exports the DrawStill_420pl()
>> function via the service interface. To use it you have to open the
>> softdevice for replay (like it is done in softplay or softieee1394),
>> then you can get function pointers to some replay functions including
>> the DrawStill() method via vdr's Service interface (see the
>> servicedemo-plugin). You can find the id-string and the structure in
>> softdevice.h.
>>
> Thanks for the patch! It works for me. I wrote a really dumb vdr plugin
> that displays a jpeg straight through softdevice.
> 
>> Once you have the function pointer you just have to call DrawStill()
>> with the three planes Y,U,V, the width and the height, and the strides
>> (the number of bytes to jump to the next line) for Y and U,V planes.
>> Don't pass pictures greater than 736x576, it will result in a crash.
>>
> Well, at the moment I'm using vdr with DFB + 1024x768 Res. So if I want
> to see high res images, I rather would like to transform it to 1024x768
> instead of using 720x576.

720x576 is the usual resolution of an mpeg2 stream, so the softdevice
allocates only a picture buffer of this size. Of course that could be
changed, in fact Xv-Out already has an option(max area) which allows the
allocation of the whole possible area. This depends on the graphics card
(and on it's memory size). I'm not completely sure how that is done in
DFB-out, maybe it's just working out of the box or a few things have to
be changed. I guess Stefan knows this :-)

> 
>> I did not test the patch, but there is not much which could go wrong,
>> some thinks are still to be done inside the softdevice, like saving a
>> local copy of the picture (for software osd blending), and we have to
>> discuss how to handle the aspect ratio...
>> So there are still some open points, but I think this is a starting
>> point for discussions :-)
>>
> What I have in mind is an vdr-plugin "softimage", which would the
> replace the existing vdr-image plugin for me. So I ask myself, what
> functions should be provided by such a plugin and what functions
> should belong to softdevice (regarding scaling, aspect ratio etc.)?
> Any suggestions?
> 
The softdevice currently has only a limited scaling ability (mainly for
the OSD in ARGB/AYUV format). Since there will always be an upper limit
of what can be displayed and there will always be some user how tries to
display a larger image I think the possibility of downscaling of the
images is mandatory, upscaling can easily be done by the YUV hardware
scaler.
About the aspect ratio handling I'm not so sure, Stefan did all the work
there ;-). I guess it is the best to hand over the pictures with an
aspect ratio of 1:1 and the softdevice tries to keep that ratio. As far
as I remember the patch I send you just assumes that the picture is in
the same aspect ratio as the last displayed stream, so that would have
to be changed. Stefan, what do you think?

Bye,
Martin


From stefan at lucke.in-berlin.de  Sun Mar  5 20:50:37 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 5 Mar 2006 20:50:37 +0100
Subject: [Softdevice-devel] Displaying images
In-Reply-To: <440B36AF.3020004@gmx.net>
References: <200602202302.47845.stefan@lucke.in-berlin.de> <440B0511.5060108@gmx.de> <440B36AF.3020004@gmx.net>
Message-ID: <200603052050.37934.stefan@lucke.in-berlin.de>

On Sonntag, 5. M?rz 2006 20:06, Martin Wache wrote:
> Sebastian Vandersee schrieb:
> > Martin Wache schrieb:
> >> Sebastian Vandersee schrieb:
> >>
> >>> So now my question is, how to feed the decompressed data into
> >>> softdevice?
> >>>
> >> I attached a fast and crude patch which exports the DrawStill_420pl()
> >> function via the service interface. To use it you have to open the
> >> softdevice for replay (like it is done in softplay or softieee1394),
> >> then you can get function pointers to some replay functions including
> >> the DrawStill() method via vdr's Service interface (see the
> >> servicedemo-plugin). You can find the id-string and the structure in
> >> softdevice.h.
> >>
> > Thanks for the patch! It works for me. I wrote a really dumb vdr plugin
> > that displays a jpeg straight through softdevice.
> > 
> >> Once you have the function pointer you just have to call DrawStill()
> >> with the three planes Y,U,V, the width and the height, and the strides
> >> (the number of bytes to jump to the next line) for Y and U,V planes.
> >> Don't pass pictures greater than 736x576, it will result in a crash.
> >>
> > Well, at the moment I'm using vdr with DFB + 1024x768 Res. So if I want
> > to see high res images, I rather would like to transform it to 1024x768
> > instead of using 720x576.
> 
> 720x576 is the usual resolution of an mpeg2 stream, so the softdevice
> allocates only a picture buffer of this size. Of course that could be
> changed, in fact Xv-Out already has an option(max area) which allows the
> allocation of the whole possible area. This depends on the graphics card
> (and on it's memory size). I'm not completely sure how that is done in
> DFB-out, maybe it's just working out of the box or a few things have to
> be changed. I guess Stefan knows this :-)

I guess we need some additional functions, so that other could query
image capabiltities of current output methods. The default, provided
my our cVideOut super class should be something like this:
typedef struct
{
	char	fourCC[4];
	int		maxWidth,
			maxHeight;
} imageFormat;

imageFormat defaultImageFormats [] = 
	{ {'YV12', 720, 576},
	 {'    ', 0, 0}};

imageFormat *
cVideoOut::GetImageFormats(void)
{
	return defaultImageFormats;
}

DFB-out with matrox works up to HDTV resolutions I guess (not with
all pixels formats). 

> 
> > 
> >> I did not test the patch, but there is not much which could go wrong,
> >> some thinks are still to be done inside the softdevice, like saving a
> >> local copy of the picture (for software osd blending), and we have to
> >> discuss how to handle the aspect ratio...
> >> So there are still some open points, but I think this is a starting
> >> point for discussions :-)
> >>
> > What I have in mind is an vdr-plugin "softimage", which would the
> > replace the existing vdr-image plugin for me. So I ask myself, what
> > functions should be provided by such a plugin and what functions
> > should belong to softdevice (regarding scaling, aspect ratio etc.)?
> > Any suggestions?
> > 
> The softdevice currently has only a limited scaling ability (mainly for
> the OSD in ARGB/AYUV format). Since there will always be an upper limit
> of what can be displayed and there will always be some user how tries to
> display a larger image I think the possibility of downscaling of the
> images is mandatory, upscaling can easily be done by the YUV hardware
> scaler.
> About the aspect ratio handling I'm not so sure, Stefan did all the work
> there ;-). I guess it is the best to hand over the pictures with an
> aspect ratio of 1:1 and the softdevice tries to keep that ratio. As far
> as I remember the patch I send you just assumes that the picture is in
> the same aspect ratio as the last displayed stream, so that would have
> to be changed. Stefan, what do you think?

Our current logic (aspect ratio calculation) is based on
ffmpeg structures AVFrame _and_ AVCodecContext.

Have to think a bit more ..

-- 
Stefan Lucke



From jpahka at welho.com  Sun Mar  5 20:55:01 2006
From: jpahka at welho.com (Juha Pahkala)
Date: Sun, 05 Mar 2006 21:55:01 +0200
Subject: [Softdevice-devel] Toggle aspect ratio?
In-Reply-To: <4405CB0B.6040508@welho.com>
References: <1141043026.4402ef52cb52a@webmail.welho.com> <20060227155734.GB15551@localhost.localdomain> <440331D6.7080406@welho.com> <200602280659.27703.stefan@lucke.in-berlin.de> <4405CB0B.6040508@welho.com>
Message-ID: <440B4215.704@welho.com>

Juha Pahkala wrote:

> Stefan Lucke wrote:
>
>>
>>> And with the aspect ratio set to 4:3 and the broadcast 16:9 the same 
>>> thing happens when zooming, apect ratio remains, but left and right 
>>> parts of the picture invisible.
>>>
>>> So, what I'm missing is the 'stretch' effect that I get when eg. 
>>> watching a 4:3 brodcast in 4:3 aspect ratio mode.
>>>   
>>
>>
>> You want fat people ? A horizontal strech only ?
>> A varaible stretch, like keeping keeping center at contant ratio
>> and stretching the borders only is not possible.
>>
>>  
>>
>
> Well, yes, I guess so :)  Surely a varaible strech would be even 
> better, but a constant horizontal strech is what I get when I look at 
> a 4:3 brodcast in my 16:9 TV with softdevice in 4:3 mode, right? I do 
> prefer that to the black bars left & right, that makes the picture 
> look awfully small ;)
>
> So, would that be an option in the crop mode then?
>
> juhis
>
>

I've got a related question. How do I configure vdr so that I can change 
the current crop mode via lirc? So far I added 'LIRC.User1' directive to 
remote.conf and configured softdevice crop mode key to User1. But that 
doesn't seem to be enough. Do I need to add something to keymacros.conf?

TIA, juhis




From admin at berlios.de  Mon Mar  6 16:21:00 2006
From: admin at berlios.de (admin at berlios.de)
Date: Mon, 6 Mar 2006 16:21:00 +0100 (CET)
Subject: [Softdevice-devel] [Feature #1942] audio-out: internal mute
Message-ID: <200603061521.k26FL0Hf005350@unicorn.berlios.de>

Feature Request #1942, was updated on 2006-Mar-06 16:20
You can respond by visiting: 
http://developer.berlios.de/feature/?func=detailfeature&feature_id=1942&group_id=2051

Category: None
Status: Open
Priority: 5
Summary: audio-out: internal mute

By: tagore
Date: 2006-Mar-06 16:20

Message:
Logged In: YES 
user_id=14338
Browser: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.7.9) Gecko/20050711 Firefox/1.0.5

muting softdevice mutes the Alsa-PCM-Channel.
It would be nice if  the muting-function was realized
internally (like in xine) not manipiulating the global
mixer-channels.


Perhaps this is a bit particular, but still: I changed
to CCRMA-Fedora to make music. This involves
low-latency-soundserver jack.  Jack is presently not
compatible with dmix-plugin for alsa.  But dmix was my
workaround to to mute vdr while running another
sound-application.

Thanks
  Tagore

----------------------------------------------------------------------
You can respond by visiting: 
http://developer.berlios.de/feature/?func=detailfeature&feature_id=1942&group_id=2051


From marko.makela at hut.fi  Mon Mar  6 20:40:46 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 6 Mar 2006 21:40:46 +0200
Subject: [Softdevice-devel] Displaying images
In-Reply-To: <440B0511.5060108@gmx.de>
References: <43FB562F.6050509@gmx.de> <43FE0BE4.70803@gmx.net> <20060223194853.GB10545@localhost.localdomain> <43FE1A4D.1080705@gmx.net> <43FE2E17.6010803@gmx.de> <20060224104301.GA5714@localhost.localdomain> <44007CD6.3000904@gmx.net> <44098B15.2040503@gmx.de> <4409CA24.7090200@gmx.net> <440B0511.5060108@gmx.de>
Message-ID: <20060306194046.GA13666@localhost.localdomain>

On Sun, Mar 05, 2006 at 04:34:41PM +0100, Sebastian Vandersee wrote:
> What I have in mind is an vdr-plugin "softimage", which would the
> replace the existing vdr-image plugin for me. So I ask myself, what
> functions should be provided by such a plugin and what functions
> should belong to softdevice (regarding scaling, aspect ratio etc.)?
> Any suggestions?

Because digital images tend to have a much bigger resolution than TV
screens, there should be a zoom in/out feature with the ability to move
the zoom window (the cropping area), so that you can see details.  On
recent digital cameras, you get at least 8 megapixels, and the TV screen
can only display less than half a megapixel.

I don't know if keys can be grabbed by plugins or if you'd have to
resort to dirty tricks like the CropModeToggleKey in softdevice.
I'd map the arrow keys to moving the zoom window and perhaps the
color keys for zoom min/in/out/max.

I have some thousands of photos backed up on my vdr box, and I could
find the plugin useful.  It could be a nice way to show pictures to visitors.
In that application, it would be nice to tag images either in advance (to
create "playlists", i.e., slide shows) or while viewing the images (to
compose lists of photos for copying or printing).  The "playlists" could
well be left out of the plugin; i.e., let the user create a directory
containing symlinks to the images, and to choose that directory as the
starting point.

It would be nice if the plugin could optionally show on OSD the contents of
JPEG COM markers (embedded image comments) or maybe even certain Exif tags
and various colour curves and histograms (just kidding about the last one).

	Marko


From M.Wache at gmx.net  Mon Mar  6 23:13:33 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 06 Mar 2006 23:13:33 +0100
Subject: [Softdevice-devel] Toggle aspect ratio?
In-Reply-To: <440B4215.704@welho.com>
References: <1141043026.4402ef52cb52a@webmail.welho.com> <20060227155734.GB15551@localhost.localdomain> <440331D6.7080406@welho.com> <200602280659.27703.stefan@lucke.in-berlin.de> <4405CB0B.6040508@welho.com> <440B4215.704@welho.com>
Message-ID: <440CB40D.4080704@gmx.net>

Juha Pahkala schrieb:

> I've got a related question. How do I configure vdr so that I can change
> the current crop mode via lirc? So far I added 'LIRC.User1' directive to
> remote.conf and configured softdevice crop mode key to User1. But that
> doesn't seem to be enough. Do I need to add something to keymacros.conf?
> 
I'm sorry, but toggling the crop mode via a user key only works with the
softdevice's own remotes (DFB-remote and Xv-remote). Unfortunately there
is currently no way for a plugin to directly receive keypress events :-(

Martin


From admin at berlios.de  Mon Mar  6 23:17:32 2006
From: admin at berlios.de (admin at berlios.de)
Date: Mon, 6 Mar 2006 23:17:32 +0100 (CET)
Subject: [Softdevice-devel] [Bug #6551] Keine Transparenz
Message-ID: <200603062217.k26MHW5K028335@unicorn.berlios.de>

Bug #6551, was updated on 2006-Feb-23 00:51
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: xv-out
Status: Closed
Resolution: None
Bug Group: None
Priority: 5
Submitted by: daliman
Assigned to : none
Summary: Keine Transparenz

Details: Wenn kein Stream angezeigt wird, z.B. bei Radiosendern, wird das OSD-Men? nicht transparent angezeigt. (OSD-Alphablending PSEUDO/Software). Das ist auch beim Kanalwechsel kurzfristig der Fall.

Follow-Ups:

Date: 2006-Mar-06 23:17
By: wachm

Comment:
Wenn das kein softdevice spezifisches Problem ist schlie?e ich den Bugreport.
-------------------------------------------------------

Date: 2006-Feb-27 02:14
By: daliman

Comment:
Diese Problem scheint kein SD-Problem zu sein, denn mit einer ?lteren VDR Version (< 1.3.40) funktioniert es. Auch die OSD-Gr??e beim Kanalwechsel artet bei den neueren Versionen in einem Zucken aus. (s. Xine). 
-------------------------------------------------------

Date: 2006-Feb-25 16:29
By: wachm

Comment:
Das das Softdevice von sich aus in den Pseudo-Osd Modus umschaltet halte ich f?r sehr unwahrscheinlich. Kannst du bitte deinen Bildschirm abfotografieren und einen Link zu den Bildern posten damit ich mal sehen kann wie das aussieht? Wird der Hintergrund eigentlich schwarz wenn das passiert?

Martin
-------------------------------------------------------

Date: 2006-Feb-24 18:33
By: daliman

Comment:
OSD-Men?s k?nnen transparent dargestellt werden. (im SoftwareModus). Beim Kanalwechsel schein SD kurzfristig in den PSEUDO-Modus (Alphablending) umzuschalten, bei dem ja keine Transparenz dargestellt werden kann.

vdr 1.3.43 
SuSE 10.0
gcc 4.0.2

mit ungepanschtem VDR und gepatchtem VDR (BigPatch + EasyDiseqc) ist es gleich.
 
-------------------------------------------------------

Date: 2006-Feb-23 20:09
By: wachm

Comment:
Ich bin mir nicht sicher ob ich das richtig verstehe wenn du von nicht transparent redest, meinst du das der Hintergrund schwarz wird?

Zum ShmClient: Erstmal m?chte ich dich bitten f?r jedes Problem einen speparaten Bugreport zu ?ffnen, das macht das Verwalten einfacher.
Ich kann dieses Problem nicht reproduzieren, die Fehlermeldung stammt aus einer Datei die zum Vdr geh?rt. Deshalb brauche ich noch etwas mehr Informationen (die ?brigens zu jedem guten Bugreport geh?ren): Vdr-Version (ist die gepatcht?), gcc/g++ Version und Distribution.  

-------------------------------------------------------

Date: 2006-Feb-23 01:02
By: daliman

Comment:
Nachtrag: Auch der ShmClient bringt Fehler:
../../../include/vdr/ci.h:114: error: two or more data types in declaration of 'parameter'
ShmClient.c: In function 'int main(int, char**)':
ShmClient.c:77: warning: unused variable 'curr_pict_shmid'

-------------------------------------------------------

For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=6551&group_id=2051


From Neumann at do-net.de  Sun Mar 12 12:26:32 2006
From: Neumann at do-net.de (Andre Neumann)
Date: Sun, 12 Mar 2006 12:26:32 +0100
Subject: [Softdevice-devel] Cannot compile recent CVS
Message-ID: <FB3B5DB3197CEA429E5FB8E83D01D039D151@sbs2003.do-net.de>

Hi,
 
when compiling recent cvs i get the following:
 
make[1]: Leaving directory `/usr/local/src/vdr-1.3.44/PLUGINS/src/sky'
Plugin softdevice:
make[1]: Entering directory `/usr/local/src/vdr-1.3.44/PLUGINS/src/softdevice-CVS'
g++ -O2 -g -Wall -fPIC -Woverloaded-virtual -c -DUSE_MMX -DUSE_MMX2 -DUSE_SUBPLUGINS -DDFB_SUPPORT -DPP_LIBAVCODEC -DPLUGIN_NAME_I18N='"softdevice"' -D_GNU_SOURCE -DPLUGINLIBDIR='"./PLUGINS/lib"' -I../../../include -I../../../../DVB/include -I/usr/include/ffmpeg/ -I/usr/local/include/dfb++ -I/usr/local/include/directfb SoftOsd.c
SoftOsd.c: In member function `void cSoftOsd::OsdCommit()':
SoftOsd.c:173: error: no matching function for call to `cVideoOut::
   CommitUnlockSoftOsdSurface()'
video.h:212: error: candidates are: virtual void
   cVideoOut::CommitUnlockSoftOsdSurface(int, int)
video.h:167: error: `int cVideoOut::Osd_changed' is private
SoftOsd.c:182: error: within this context
make[1]: *** [SoftOsd.o] Error 1
make[1]: Leaving directory `/usr/local/src/vdr-1.3.44/PLUGINS/src/softdevice-CVS'

-------------
Andre Neumann




From M.Wache at gmx.net  Sun Mar 12 12:44:58 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 12 Mar 2006 12:44:58 +0100
Subject: [Softdevice-devel] Cannot compile recent CVS
In-Reply-To: <FB3B5DB3197CEA429E5FB8E83D01D039D151@sbs2003.do-net.de>
References: <FB3B5DB3197CEA429E5FB8E83D01D039D151@sbs2003.do-net.de>
Message-ID: <441409BA.4020606@gmx.net>

Andre Neumann schrieb:
> Hi,
>  
> when compiling recent cvs i get the following:
>  
Sorry, I forgot to commit my changes to SoftOsd.c :-/
Thank you for the report, it should be fixed now.

Bye,
Martin


From Neumann at do-net.de  Sun Mar 12 12:56:18 2006
From: Neumann at do-net.de (Andre Neumann)
Date: Sun, 12 Mar 2006 12:56:18 +0100
Subject: [Softdevice-devel] Cannot compile recent CVS
Message-ID: <FB3B5DB3197CEA429E5FB8E83D01D039D153@sbs2003.do-net.de>

Works. Thank you.

-------------
Andre Neumann 

> -----Original Message-----
> From: softdevice-devel-admin at berlios.de 
> [mailto:softdevice-devel-admin at berlios.de] On Behalf Of Martin Wache
> Sent: Sunday, March 12, 2006 12:45 PM
> To: softdevice-devel at berlios.de
> Subject: Re: [Softdevice-devel] Cannot compile recent CVS
> 
> Andre Neumann schrieb:
> > Hi,
> >  
> > when compiling recent cvs i get the following:
> >  
> Sorry, I forgot to commit my changes to SoftOsd.c :-/ Thank 
> you for the report, it should be fixed now.
> 
> Bye,
> Martin
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/softdevice-devel
> 
> 
> 



From listaccount at e-tobi.net  Sun Mar 12 20:37:07 2006
From: listaccount at e-tobi.net (Tobias Grimm)
Date: Sun, 12 Mar 2006 20:37:07 +0100
Subject: [Softdevice-devel] Will Softplay stay separated from Softdevice?
Message-ID: <44147863.50207@e-tobi.net>

Hi!

I'm currently packaging Softplay for Debian and was wondering, if it
will stay separated from Softdevice or if it might be merged with
Softdevice into a single tarball in the future. (From the packagers
point of view, I would prefer a single tarball.)

bye,

Tobias



From M.Wache at gmx.net  Sun Mar 12 22:42:56 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 12 Mar 2006 22:42:56 +0100
Subject: [Softdevice-devel] Will Softplay stay separated from Softdevice?
In-Reply-To: <44147863.50207@e-tobi.net>
References: <44147863.50207@e-tobi.net>
Message-ID: <441495E0.8060302@gmx.net>

Tobias Grimm schrieb:
> Hi!
> 
> I'm currently packaging Softplay for Debian and was wondering, if it
> will stay separated from Softdevice or if it might be merged with
> Softdevice into a single tarball in the future. (From the packagers
> point of view, I would prefer a single tarball.)
> 

We had a discussion about this when softplay was started. Back than we
decided to have it separated, and I still favour this option for several
reasons.
Why exactly would you like to have a single tarball? Because of the
dependency on softdevice.h? This is not needed anymore from vdr-1.3.30
and a softplay cvs version from today. The communication between the
softdevice and softplay now happens over the service interface.

I would not completely exclude the possibility of integrating softplay
into the softdevice, but there would have to be a good reason for that
which I can understand.

Bye,
Martin


From listaccount at e-tobi.net  Sun Mar 12 23:45:10 2006
From: listaccount at e-tobi.net (Tobias Grimm)
Date: Sun, 12 Mar 2006 23:45:10 +0100
Subject: [Softdevice-devel] Will Softplay stay separated from Softdevice?
In-Reply-To: <441495E0.8060302@gmx.net>
References: <44147863.50207@e-tobi.net> <441495E0.8060302@gmx.net>
Message-ID: <4414A476.7020409@e-tobi.net>

Martin Wache wrote:

>Why exactly would you like to have a single tarball? Because of the
>dependency on softdevice.h?
>

Yes - it's a little bit awkward to do cleanly in Debian.

>This is not needed anymore from vdr-1.3.30
>and a softplay cvs version from today. The communication between the
>softdevice and softplay now happens over the service interface.
>  
>

Thanks, I didn't knew that. In this case, I will directly switch to the
CVS version for the moment.

bye,

Tobias


From M.Wache at gmx.net  Mon Mar 13 10:04:34 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 13 Mar 2006 10:04:34 +0100
Subject: [Softdevice-devel] Will Softplay stay separated from Softdevice?
In-Reply-To: <4414A476.7020409@e-tobi.net>
References: <44147863.50207@e-tobi.net> <441495E0.8060302@gmx.net> <4414A476.7020409@e-tobi.net>
Message-ID: <441535A2.8080106@gmx.net>

Tobias Grimm schrieb:
> Martin Wache wrote:
> 
>> Why exactly would you like to have a single tarball? Because of the
>> dependency on softdevice.h?
>>
> 
> Yes - it's a little bit awkward to do cleanly in Debian.
> 
>> This is not needed anymore from vdr-1.3.30
>> and a softplay cvs version from today. The communication between the
>> softdevice and softplay now happens over the service interface.
>>  
>>
> 
> Thanks, I didn't knew that. In this case, I will directly switch to the
> CVS version for the moment.
> 
Ok, that is probably the best possibility (but please mark the package
as a cvs-version), unfortunately a release of softplay is overdue and
I'm not sure when I will have some time to work on it. Yesterday I just
cleaned up what I got so far and (hopefully) fixed the segmentation
violation which was stopping me from committing the work.

Thank you for packaging all the packages for debian (not only softdevice
and softplay, also for all the other packages)! I'm using debian myself
on one of my machines and it is one of my favourite  distribution.

I still have a packaging related question. I'm not sure if you already
packaged the softdevice-0.2.2, but there is a new feature: the shared
memory client /server, which I find very useful. If you start up the
softdevice with "-vo shm:" it allocates a shared memory segment and
waits for clients, the decoding stays suspended. If you start the shared
memory client (a separate program: ShmClient), it connects to the shared
memory segment, signals that the decoding should be started and displays
the video via Xv. When you close the ShmClient the decoding will be
automatically suspended.
So my question is now: the shmclient has to be linked against a few vdr
objects, is it possible to do that in a debian package?

Bye,
Martin


From listaccount at e-tobi.net  Fri Mar 17 23:08:19 2006
From: listaccount at e-tobi.net (Tobias Grimm)
Date: Fri, 17 Mar 2006 23:08:19 +0100
Subject: [Softdevice-devel] Will Softplay stay separated from Softdevice?
In-Reply-To: <441535A2.8080106@gmx.net>
References: <44147863.50207@e-tobi.net> <441495E0.8060302@gmx.net> <4414A476.7020409@e-tobi.net> <441535A2.8080106@gmx.net>
Message-ID: <441B3353.9090806@e-tobi.net>

Martin Wache wrote:

>Ok, that is probably the best possibility (but please mark the package
>as a cvs-version)
>

Yes. CVS versions get special version numbers like 0.0.1+cvs2006317.

>I'm not sure when I will have some time to work on it. Yesterday I just
>cleaned up what I got so far and (hopefully) fixed the segmentation
>violation which was stopping me from committing the work.
>  
>

There seems to be some issues with GCC4:

PlayList.c: In member function 'void cItemIdx::Shuffle()':
PlayList.c:246: warning: format '%4d' expects type 'int', but argument 3
has type 'sIdx'
PlayList.c:246: warning: format '%4d' expects type 'int', but argument 5
has type 'sIdx'
PlayList.c: In member function 'int cPlayList::LoadM3U(const char*)':
PlayList.c:647: error: invalid initialization of non-const reference of
type 'const char*&' from a temporary of type 'const char*'
softplay.h:120: error: in passing argument 1 of 'void skipSpaces(const
char*&)'
PlayList.c:674: error: invalid initialization of non-const reference of
type 'const char*&' from a temporary of type 'const char*'
softplay.h:120: error: in passing argument 1 of 'void skipSpaces(const
char*&)'


>Thank you for packaging all the packages for debian (not only softdevice
>and softplay, also for all the other packages)!
>

You're welcome! ;-)

>I still have a packaging related question. I'm not sure if you already
>packaged the softdevice-0.2.2,
>

I've updated the package but haven't released it yet. (Wanted to do this
with softplay together.)

>So my question is now: the shmclient has to be linked against a few vdr
>objects, is it possible to do that in a debian package?
>  
>

That's a little bit difficult. I can think of the following solutions:

1) The necessary VDR sources are put into the debian package - but this
makes the source package too dependent on the vdr version

2) The VDR package is modified, to produce a static library, containing
the needed objects, which is distributed with vdr-dev. That's probably
the cleanest solution, but I have to speak with Thomas first, because I
don't want the VDR package at e-tobi.net to be too different from the
official Debian package.

What's the reason for the SHMClient? Can't this be built directly into
the plugin? A separate 'launchshmclient' could then trigger the plugin
to start the SHMClient.

bye,

Tobias


From karl.glatz at googlemail.com  Sun Mar 19 23:49:26 2006
From: karl.glatz at googlemail.com (Karl Glatz)
Date: Sun, 19 Mar 2006 23:49:26 +0100
Subject: [Softdevice-devel] Softdevice with FFmpeg with --enable-dc1394 compiled (Ubuntu)
In-Reply-To: <d5c44b7f0603191443r7375544bu@mail.gmail.com>
References: <d5c44b7f0603191443r7375544bu@mail.gmail.com>
Message-ID: <d5c44b7f0603191449n1ef5b4a9p@mail.gmail.com>

Hello,

i've just installed VDR with the softdevice plugin on my Ubuntu
system. As I'm using many programms wich depends on ffmpeg packages
I'd like to use this instead of compiling my own.

Compiling works great! But now when I try to start VDR it says:
--
Mar 19 23:39:57 localhost vdr: [9328] ERROR:
/usr/local/lib/vdr/libvdr-softdevice.so.1.3.44: undefined symbol:
dc1394_create_handle
--

But ffplay works perfect! And libraw1394 ist also installed!

I think the libvdr-softdevice calls the ffmpeg libs which compiled
against libraw1394 and trys to call the dc1394_create_handle.

Have anyone a Idea what I can do to solve this problem. Installing
FFmpeg without the --enable-dc1394 option isn't a option for me,
because I want to keep my Ubuntu package!

mfg
Karl Glatz


From stefan at lucke.in-berlin.de  Mon Mar 20 12:43:22 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 20 Mar 2006 12:43:22 +0100
Subject: [Softdevice-devel] Softdevice with FFmpeg with --enable-dc1394 compiled (Ubuntu)
In-Reply-To: <d5c44b7f0603191449n1ef5b4a9p@mail.gmail.com>
References: <d5c44b7f0603191443r7375544bu@mail.gmail.com> <d5c44b7f0603191449n1ef5b4a9p@mail.gmail.com>
Message-ID: <1142855002.441e955a5d525@webmail.in-berlin.de>

Quoting Karl Glatz:

> Hello,
>
> i've just installed VDR with the softdevice plugin on my Ubuntu
> system. As I'm using many programms wich depends on ffmpeg packages
> I'd like to use this instead of compiling my own.
>
> Compiling works great! But now when I try to start VDR it says:
> --
> Mar 19 23:39:57 localhost vdr: [9328] ERROR:
> /usr/local/lib/vdr/libvdr-softdevice.so.1.3.44: undefined symbol:
> dc1394_create_handle
> --

It could be cought by running configure in softdevice directory if
your ffmpeg version supports pkg-config ;-) .

Another way could be editing Makefile . There is a section
where "undefined symbol" messages from ffmpeg should be handled.
In your case a line for fixing could look like:

FMPEGLIBS += -ldc1394

>
> But ffplay works perfect! And libraw1394 ist also installed!
>
> I think the libvdr-softdevice calls the ffmpeg libs which compiled
> against libraw1394 and trys to call the dc1394_create_handle.
>
> Have anyone a Idea what I can do to solve this problem. Installing
> FFmpeg without the --enable-dc1394 option isn't a option for me,
> because I want to keep my Ubuntu package!
>

Stefan Lucke


From M.Wache at gmx.net  Wed Mar 22 17:55:03 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Wed, 22 Mar 2006 17:55:03 +0100
Subject: Resend: Re: [Softdevice-devel] Will Softplay stay separated from
 Softdevice?
Message-ID: <44218167.1080309@gmx.net>

Either the list is stuck again, or this message was somehow lost, so I'm
resending it...

Tobias Grimm schrieb:
> There seems to be some issues with GCC4:
> 
> PlayList.c: In member function 'void cItemIdx::Shuffle()':
> PlayList.c:246: warning: format '%4d' expects type 'int', but argument 3
> has type 'sIdx'
> PlayList.c:246: warning: format '%4d' expects type 'int', but argument 5
> has type 'sIdx'
> PlayList.c: In member function 'int cPlayList::LoadM3U(const char*)':
> PlayList.c:647: error: invalid initialization of non-const reference of
> type 'const char*&' from a temporary of type 'const char*'
> softplay.h:120: error: in passing argument 1 of 'void skipSpaces(const
> char*&)'
> PlayList.c:674: error: invalid initialization of non-const reference of
> type 'const char*&' from a temporary of type 'const char*'
> softplay.h:120: error: in passing argument 1 of 'void skipSpaces(const
> char*&)'
> 

Thank you for the report, it should be fixed in the CVS now.


>> So my question is now: the shmclient has to be linked against a few vdr
>> objects, is it possible to do that in a debian package?
>>  
>>
> 
> That's a little bit difficult. I can think of the following solutions:
> 
> 1) The necessary VDR sources are put into the debian package - but this
> makes the source package too dependent on the vdr version
> 
> 2) The VDR package is modified, to produce a static library, containing
> the needed objects, which is distributed with vdr-dev. That's probably
> the cleanest solution, but I have to speak with Thomas first, because I
> don't want the VDR package at e-tobi.net to be too different from the
> official Debian package.

Hmm, maybe the cleanest solution is to get rid of the dependency on vdr
objects at all. It is not really needed, it's just because for the first
tries it was the fastest solution. Since I consider the ShmClient
currently as experimental it is probably the best if you just ignore it
in the softdevice-0.2.2 package. I will get rid of the dependencies and
the problem won't be there for the next release :-)


> 
> What's the reason for the SHMClient? Can't this be built directly into
> the plugin? A separate 'launchshmclient' could then trigger the plugin
> to start the SHMClient.
> 
I thought that would be obvious, it is mainly for people who use a
combined vdr/desktop box (like me). When booting my computer vdr is
started with the softdevice shared memory server. I can work without
noticing that vdr is running, and when I want to watch TV I start the
ShmClient.
It may also be useful if one wants to use vdr from a different program,
for example MythTV

Bye,
Martin



From listaccount at e-tobi.net  Wed Mar 22 20:25:54 2006
From: listaccount at e-tobi.net (Tobias Grimm)
Date: Wed, 22 Mar 2006 20:25:54 +0100
Subject: Resend: Re: [Softdevice-devel] Will Softplay stay separated from
 Softdevice?
In-Reply-To: <44218167.1080309@gmx.net>
References: <44218167.1080309@gmx.net>
Message-ID: <4421A4C2.8000904@e-tobi.net>

Martin Wache wrote:

>Thank you for the report, it should be fixed in the CVS now.
>  
>

You missed one:

--- vdr-plugin-softplay-0.0.2+cvs20060322.orig/PlayList.c
+++ vdr-plugin-softplay-0.0.2+cvs20060322/PlayList.c
@@ -672,7 +672,9 @@
                
         // check for extinfos...
         char *extInfoPos=line[!swapLine];
-        skipSpaces((const char *)extInfoPos);
+        //skipSpaces((const char *)extInfoPos);
+        while ( *extInfoPos==' ' )
+            extInfoPos++;
         if ( *extInfoPos=='#' && FileIndex ) {
             cIndex *Idx=FileIndex->GetOrAddIndex(ItemFile);
             if (Idx)


>in the softdevice-0.2.2 package. I will get rid of the dependencies and
>the problem won't be there for the next release :-)
>  
>

Great, I'm looking forward to it!

bye,

Tobias


From M.Wache at gmx.net  Thu Mar 23 00:03:02 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 23 Mar 2006 00:03:02 +0100 (MET)
Subject: [Softdevice-devel] =?ISO-8859-1?Q?Re:_Resend:_Re:_[Softdevice-devel]_Will_Softplay_stay_sepa?=
 =?ISO-8859-1?Q?rated_from_Softdevice=3F?=
References: <4421A4C2.8000904@e-tobi.net>
Message-ID: <8715.1143068582@www045.gmx.net>

> You missed one:
> 
> --- vdr-plugin-softplay-0.0.2+cvs20060322.orig/PlayList.c
> +++ vdr-plugin-softplay-0.0.2+cvs20060322/PlayList.c
> @@ -672,7 +672,9 @@
>                 
>          // check for extinfos...
>          char *extInfoPos=line[!swapLine];
> -        skipSpaces((const char *)extInfoPos);
> +        //skipSpaces((const char *)extInfoPos);
> +        while ( *extInfoPos==' ' )
> +            extInfoPos++;
>          if ( *extInfoPos=='#' && FileIndex ) {
>              cIndex *Idx=FileIndex->GetOrAddIndex(ItemFile);
>              if (Idx)
> 
> 
Thanks for the patch, I applied it to the CVS.

Bye,
Martin

-- 
Bis zu 70% Ihrer Onlinekosten sparen: GMX SmartSurfer!
Kostenlos downloaden: http://www.gmx.net/de/go/smartsurfer


From listaccount at e-tobi.net  Sun Mar 26 22:20:36 2006
From: listaccount at e-tobi.net (Tobias Grimm)
Date: Sun, 26 Mar 2006 22:20:36 +0200
Subject: [Softdevice-devel] Small include fixes
Message-ID: <4426F794.1060103@e-tobi.net>

Hi!

Thomas Guenther has found some improper includes of vdr header files.
Please see attached patch.

bye,

Tobias
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: 01_build.dpatch
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060326/1d1d240d/attachment.ksh>

From madscientist at nekto.net  Thu Mar 30 19:51:08 2006
From: madscientist at nekto.net (MadFox)
Date: Thu, 30 Mar 2006 23:51:08 +0600
Subject: [Softdevice-devel] Softdevice(DFB) crash
Message-ID: <442C1A8C.5040307@nekto.net>

Hello !

I don't found another way, and I want your help.
I can't launch VDR with softdevice - vo dfb:mgatv.
The normal FB device (-vo fb:) is working, but my VDR is crashing with
this:
(!) (caught signal 4 (at 0xXXXXXX illegal operand))
All other devices (sound, dvb SkyStar 2 card ) are working ok.
The problem seems in softdevice, how I cant fix it ?

VDR Version 1.3.45
SoftDevice - latest from CVS

Best regards,
Yuriy Evgrafov.



From Neumann at do-net.de  Fri Mar 31 08:53:18 2006
From: Neumann at do-net.de (Andre Neumann)
Date: Fri, 31 Mar 2006 08:53:18 +0200
Subject: [Softdevice-devel] Softdevice(DFB) crash
Message-ID: <FB3B5DB3197CEA429E5FB8E83D01D0390D9003@sbs2003.do-net.de>

Hi,

Please post your /etc/directfbrc file.

-------------
Andre Neumann

 

> -----Original Message-----
> From: softdevice-devel-admin at berlios.de 
> [mailto:softdevice-devel-admin at berlios.de] On Behalf Of MadFox
> Sent: Thursday, March 30, 2006 7:51 PM
> To: softdevice-devel at lists.berlios.de 
> Subject: [Softdevice-devel] Softdevice(DFB) crash
> 
> Hello !
> 
> I don't found another way, and I want your help.
> I can't launch VDR with softdevice - vo dfb:mgatv.
> The normal FB device (-vo fb:) is working, but my VDR is crashing with
> this:
> (!) (caught signal 4 (at 0xXXXXXX illegal operand))
> All other devices (sound, dvb SkyStar 2 card ) are working ok.
> The problem seems in softdevice, how I cant fix it ?
> 
> VDR Version 1.3.45
> SoftDevice - latest from CVS
> 
> Best regards,
> Yuriy Evgrafov.
> 
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/softdevice-devel
> 
> 
> 




From hannu.k.salonen at gmail.com  Fri Mar 31 11:05:03 2006
From: hannu.k.salonen at gmail.com (Hannu Salonen)
Date: Fri, 31 Mar 2006 12:05:03 +0300
Subject: [Softdevice-devel] softdevice xv - osd visible only when no video
Message-ID: <4d943d820603310105k46b36122p9957ad81ca12dabb@mail.gmail.com>

For some reason osd and video won't mix.
Osd flickers when you move
vindow but video draws over it

Any clue what's wrong?

softdevice-0.2.2
ubuntu dapper
nvidia 6600 gt hardware
tried xorgs nv server and nvidia binary server - same behaviour on both

Hannu Salonen
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060331/ecb8589b/attachment.html>

From stefan at lucke.in-berlin.de  Fri Mar 31 14:43:05 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 31 Mar 2006 14:43:05 +0200
Subject: [Softdevice-devel] softdevice xv - osd visible only when no video
In-Reply-To: <4d943d820603310105k46b36122p9957ad81ca12dabb@mail.gmail.com>
References: <4d943d820603310105k46b36122p9957ad81ca12dabb@mail.gmail.com>
Message-ID: <1143808985.442d23d90cea3@webmail.in-berlin.de>

Quoting Hannu Salonen:

> For some reason osd and video won't mix.
> Osd flickers when you move
> vindow but video draws over it
>
> Any clue what's wrong?
>
> softdevice-0.2.2
> ubuntu dapper
> nvidia 6600 gt hardware

see:
http://lists.berlios.de/pipermail/softdevice-devel/2006q1/001770.html

Use software OSD alpha blending mode.

> tried xorgs nv server and nvidia binary server - same behaviour on both
>

Stefan Lucke



