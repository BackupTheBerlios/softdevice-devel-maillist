From M.Wache at gmx.net  Sat Apr  1 10:31:20 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sat, 01 Apr 2006 10:31:20 +0200
Subject: [Softdevice-devel] Small include fixes
In-Reply-To: <4426F794.1060103@e-tobi.net>
References: <4426F794.1060103@e-tobi.net>
Message-ID: <442E3A58.4030105@gmx.net>

Tobias Grimm schrieb:
> Hi!
> 
> Thomas Guenther has found some improper includes of vdr header files.
> Please see attached patch.
> 
Thank you for the patch, I applied a slightly modified version, since
some of the includes are not needed anymore.

Bye,
Martin


From stefan at lucke.in-berlin.de  Sat Apr  1 12:13:23 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 1 Apr 2006 12:13:23 +0200
Subject: [Softdevice-devel] [PATCH] Use pluginlibdir defined in Make.config
In-Reply-To: <20060214193038.W15609@neilikka.niksula.hut.fi>
References: <20060214193038.W15609@neilikka.niksula.hut.fi>
Message-ID: <200604011213.23186.stefan@lucke.in-berlin.de>

On Dienstag 14 Februar 2006 19:48, Antti Sepp?l? wrote:
> 
> Hello.
> 
> May I suggest including this small patch to make softdevice search its
> subplugins from PLUGINLIBDIR defined in vdrs Make.config by default.
> 
> Currently softdevice ignores the setting in Make.config and uses a
> relative path of ./PLUGINS/lib when loading subplugins. Some users (at
> least me) may prefer having plugins located in a non-default directory.

Thanks, applied.

-- 
Stefan Lucke


From Neumann at do-net.de  Sun Apr  2 13:59:30 2006
From: Neumann at do-net.de (Andre Neumann)
Date: Sun, 2 Apr 2006 13:59:30 +0200
Subject: [Softdevice-devel] Segfault with my new system
Message-ID: <FB3B5DB3197CEA429E5FB8E83D01D039D155@sbs2003.do-net.de>

Hi list,
 
i installed today my new system (Kernel 2.4 and gcc 2.95).
 
DirectFB is working fine, matroxfb too. Only softdevice plugin is not working.
 
When calling ./vdr --help i get a segfault, when i want to run softdevice, too. Here is the bt:
 
(gdb) bt
#0  0x40009e53 in _dl_relocate_object () from /lib/ld-linux.so.2
#1  0x401c94e4 in dl_open_worker () from /lib/libc.so.6
#2  0x4000c040 in _dl_catch_error () from /lib/ld-linux.so.2
#3  0x401c97af in _dl_open () from /lib/libc.so.6
#4  0x40051447 in dlopen_doit () from /lib/libdl.so.2
#5  0x4000c040 in _dl_catch_error () from /lib/ld-linux.so.2
#6  0x40051890 in _dlerror_run () from /lib/libdl.so.2
#7  0x40051486 in dlopen@@GLIBC_2.1 () from /lib/libdl.so.2
#8  0x080bf277 in Load__4cDllb (this=0x81ebdc0, Log=false) at plugin.c:181
#9  0x080bf9c1 in LoadPlugins__14cPluginManagerb (this=0xbffff7c0, Log=false) at plugin.c:312
#10 0x080ea508 in main (argc=2, argv=0xbffff884) at vdr.c:366
#11 0x400e69ed in __libc_start_main () from /lib/libc.so.6
(gdb)

Maybe anyone can help here?
 
-------------
Andre Neumann




From marko.makela at hut.fi  Tue Apr  4 21:47:23 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 4 Apr 2006 22:47:23 +0300
Subject: [Softdevice-devel] Vertical line at right OSD border
Message-ID: <20060404194723.GA352458@kosh.hut.fi>

Due to hardware failure, I had to switch from DirectFB mgatv output to
DirectFB VGA on my Matrox G450 card.  No matter which color space or
crop mode I choose, the right-hand border of the OSD layer contains a
green line whenever a menu is open.  Every second scanline is bright
green, and every other line is black or transparent.  Upgrading to
softdevice CVS did not help.  Is this a known issue?

	Marko


From stefan at lucke.in-berlin.de  Wed Apr  5 07:54:10 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 5 Apr 2006 07:54:10 +0200
Subject: [Softdevice-devel] Vertical line at right OSD border
In-Reply-To: <20060404194723.GA352458@kosh.hut.fi>
References: <20060404194723.GA352458@kosh.hut.fi>
Message-ID: <200604050754.10260.stefan@lucke.in-berlin.de>

On Dienstag 04 April 2006 21:47, Marko M?kel? wrote:
> Due to hardware failure, I had to switch from DirectFB mgatv output to
> DirectFB VGA on my Matrox G450 card.  No matter which color space or
> crop mode I choose, the right-hand border of the OSD layer contains a
> green line whenever a menu is open.  Every second scanline is bright
> green, and every other line is black or transparent.  Upgrading to
> softdevice CVS did not help.  Is this a known issue?

It's the same her with xv-out. It happens only with pseudo OSD
and it depends on selected screen aspect, only when set to 5:4 or 4:3
on a 5:4 screen. 

-- 
Stefan Lucke


From agentx at menja.net  Sat Apr  8 18:40:23 2006
From: agentx at menja.net (AgentX)
Date: Sat, 08 Apr 2006 20:40:23 +0400
Subject: [Softdevice-devel] Packed color problem
Message-ID: <20060408164023.12507.qmail@mars2.netlogic.ru>

Hello !

I think that I write to right place, I successefuly installed your plugin and it works without any bugs, except one - Packed color problem:
I see the "red lines" on red color, "blue lines" on blue color, other interlacaing support (fields sync and etc) works well. In MPlayer you can fix that with mplayer -vf ilpack, but of course I can't do it in softdevice.
I tried to switch another colorspace (YV12, I420) in softdevice, but I after the picture goes away from screen and I don't see anything. I set another colorspace in /etc/directfbrc but this don't take effect - the softdevice uses YUY2.
How I can fix this problem ?

My card: Matrox G450 RGB via VGA cable
I am using the DirectFB (last from cvs 2006-03-27)
Softdevice: Last from CVS too 2006-03-27
Program: VDR 1.3.38
I am running VDR with:
vdr -P"softdevice -vo dfb:mgatv:"

My /etc/directfbrc

mode=720x576
primary-layer=2
pixelformat=YV12
#
# output setup
#
matrox-crtc2
matrox-tv-standard=pal
matrox-cable-type=scart-rgb
#
# misc
#
#input=lirc
#disable-module=keyboard
disable-module=lirc
disable-module=joystick
disable-module=mutouch
disable-module=ps2mouse
disable-module=sdlinput
disable-module=serialmouse
disable-module=sonypi

With best regards 
AgentX. 
Thank you !



From stefan at lucke.in-berlin.de  Sat Apr  8 19:49:53 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 8 Apr 2006 19:49:53 +0200
Subject: [Softdevice-devel] Packed color problem
In-Reply-To: <20060408164023.12507.qmail@mars2.netlogic.ru>
References: <20060408164023.12507.qmail@mars2.netlogic.ru>
Message-ID: <200604081949.53581.stefan@lucke.in-berlin.de>

On Samstag 08 April 2006 18:40, AgentX wrote:
> Hello !
> 
> I think that I write to right place, I successefuly installed your plugin and it works without any bugs, except one - Packed color problem:
> I see the "red lines" on red color, "blue lines" on blue color, other interlacaing support (fields sync and etc) works well.
> In MPlayer you can fix that with mplayer -vf ilpack, but of course I can't do it in softdevice. 

Didn't find something about ilpack for -vf in mplayer docs.
I guess I didn't understand how your error shows up ( "red lines" on red color ..).
Could you place a screenshot picture of your problem somewhere ?

> I tried to switch another colorspace (YV12, I420) in softdevice, but I after the picture goes away from screen and I don't see anything. 
> I set another colorspace in /etc/directfbrc but this don't take effect - the softdevice uses YUY2. 
> How I can fix this problem ?

TV-out works only in YUY2 format, as thats the only fromat which 
supports ARGB destination surface format.

> 
> My card: Matrox G450 RGB via VGA cable

For TV-out you need a self made cable.
Whats the memory size of your card ?

For not subscribed people it is best to drop a note but about
that, so that others could keep you on cc .

> I am using the DirectFB (last from cvs 2006-03-27)
> Softdevice: Last from CVS too 2006-03-27
> Program: VDR 1.3.38
> I am running VDR with:
> vdr -P"softdevice -vo dfb:mgatv:"
> 
> My /etc/directfbrc
> 
> mode=720x576
> primary-layer=2
> pixelformat=YV12
> #
> # output setup
> #
> matrox-crtc2
> matrox-tv-standard=pal
> matrox-cable-type=scart-rgb
> #
> # misc
> #
> #input=lirc
> #disable-module=keyboard
> disable-module=lirc
> disable-module=joystick
> disable-module=mutouch
> disable-module=ps2mouse
> disable-module=sdlinput
> disable-module=serialmouse
> disable-module=sonypi
> 
> With best regards 
> AgentX. 
> Thank you !
> 

-- 
Stefan Lucke


From marko.makela at hut.fi  Sat Apr  8 20:52:34 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sat, 8 Apr 2006 21:52:34 +0300
Subject: [Softdevice-devel] Vertical line at right OSD border
In-Reply-To: <200604050754.10260.stefan@lucke.in-berlin.de>
References: <20060404194723.GA352458@kosh.hut.fi> <200604050754.10260.stefan@lucke.in-berlin.de>
Message-ID: <20060408185234.GA4556@localhost.localdomain>

On Wed, Apr 05, 2006 at 07:54:10AM +0200, Stefan Lucke wrote:
> On Dienstag 04 April 2006 21:47, Marko M?kel? wrote:
> > Due to hardware failure, I had to switch from DirectFB mgatv output to
> > DirectFB VGA on my Matrox G450 card.  No matter which color space or
> > crop mode I choose, the right-hand border of the OSD layer contains a
> > green line whenever a menu is open.  Every second scanline is bright
> > green, and every other line is black or transparent.  Upgrading to
> > softdevice CVS did not help.  Is this a known issue?
> 
> It's the same her with xv-out. It happens only with pseudo OSD
> and it depends on selected screen aspect, only when set to 5:4 or 4:3
> on a 5:4 screen. 

I'm getting it on DirectFB VGA no matter what screen aspect or crop mode
is selected.  Sometimes, the bar only fills part of the right border
(e.g., when the "||" (Pause) symbol is displayed at the bottom of the screen
when using the classic theme).

The bar is somewhat annoying, because it is displayed for a few seconds
whenever subtitles appear or disappear (and that is practically always
when watching a foreign program on any of the state-run channels in
Finland).

I also noticed some flicker when the OSD is active.  Alpha blending is set
to "pseudo".  I don't remember experiencing such flicker before.

	Marko


From stefan at lucke.in-berlin.de  Sun Apr  9 08:38:41 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 9 Apr 2006 08:38:41 +0200
Subject: [Softdevice-devel] Packed color problem
In-Reply-To: <20060409032812.5127.qmail@mars2.netlogic.ru>
References: <20060409032812.5127.qmail@mars2.netlogic.ru>
Message-ID: <200604090838.41743.stefan@lucke.in-berlin.de>

On Sonntag 09 April 2006 05:28, AgentX wrote:
> Hello, Stefan Lucke <....>,
> 
> At Sat, 8 Apr 2006 19:49:53 +0200 you wrote:
> 
> > On Samstag 08 April 2006 18:40, AgentX wrote:
> > > Hello !
> > > 
> > > I think that I write to right place, I successefuly installed your plugin and it works without any bugs, except one - Packed color problem:
> > > I see the "red lines" on red color, "blue lines" on blue color, other interlacaing support (fields sync and etc) works well.
> > > In MPlayer you can fix that with mplayer -vf ilpack, but of course I can't do it in softdevice. 
> > 
> > Didn't find something about ilpack for -vf in mplayer docs.
> > I guess I didn't understand how your error shows up ( "red lines" on red color ..).
> > Could you place a screenshot picture of your problem somewhere ?
> > 
> > > I tried to switch another colorspace (YV12, I420) in softdevice, but I after the picture goes away from screen and I don't see anything. 
> > > I set another colorspace in /etc/directfbrc but this don't take effect - the softdevice uses YUY2. 
> > > How I can fix this problem ?
> > 
> > TV-out works only in YUY2 format, as thats the only fromat which 
> > supports ARGB destination surface format.
> > 
> > > 
> > > My card: Matrox G450 RGB via VGA cable
> > 
> > For TV-out you need a self made cable.
> > Whats the memory size of your card ?
> > 
> > For not subscribed people it is best to drop a note but about
> > that, so that others could keep you on cc .
> > 
> > > I am using the DirectFB (last from cvs 2006-03-27)
> > > Softdevice: Last from CVS too 2006-03-27
> > > Program: VDR 1.3.38
> > > I am running VDR with:
> > > vdr -P"softdevice -vo dfb:mgatv:"
> > > 
> > > My /etc/directfbrc

> > > 
> > > With best regards 
> > > AgentX. 
> > > Thank you !
> > > 
> > 
> > -- 
> > Stefan Lucke
> > 
> 
> Thanks for your answer !
> Yes, I my TV-out working via special cable (VGA->SCART), I am already make it. 
> And about the mplayer -fv ilpack filter:
> 
> When interlaced video is stored in YUV 4:2:0 formats, chroma interlacing does not line up properly due to 
> vertical downsampling of the chroma channels. This filter packs the planar 4:2:0 data into YUY2 (4:2:2) format 
> with the chroma lines in their proper locations, so that in any given scanline, the luma and chroma 
> data both come from the same field. The optional argument selects the sampling mode. 
> By default, linear interpolation (mode 1) is used. Mode 0 uses nearest-neighbor sampling, which is fast but incorrect.    

Assuming your TV is 4:3 format. 
Do you get this allways or only when 16:9 video is downscaled to fit
the 4:3 area of your TV ?

During 420 to 422 conversion we just repeat chroma information. This is
not the optimal way, when chroma information is field based. By default
we assume chroma is frame based. The only PAL source 420 I know
that used frame based chroma is DV. libdv at sourceforge is using 
a field based approach for generating 422 data.

> 
> It's from man page of mplayer, it's fully describing my problem : 
> 1)  chroma lines are not in their proper locations 
> 2) chroma interlacing does not line up properly. 
> If I applying this filter for videos in MPlayer - I don't have my problem with color - I don't see any color defects.   
> 
> I tried to set the yuy2 color in directfbrc, but nothing happens. 

We are selecting the surface pixel format, so this overrides your selection.

> About screenshot - I don't have a camera. But my problem is it, that about I wrote above.  

Do you get this effect for all of your sources (DVB-x) ?
Can you place a short recording (<= 2 minutes) that shows up 
your problem, for downloading ?

Subscribing to our list may be a good idea too.

> Waiting for your answer.
> With best regards.
> AgentX.

-- 
Stefan Lucke


From jonis2006 at yandex.ru  Sun Apr  9 12:36:20 2006
From: jonis2006 at yandex.ru (jonis2006)
Date: Sun, 9 Apr 2006 14:36:20 +0400 (MSD)
Subject: [Softdevice-devel] Packed color problem
Message-ID: <4438E3A4.000001.18262@webmail10.yandex.ru>

Hello, Stefan Lucke <stefan at lucke.in-berlin.de>,

At Sun, 9 Apr 2006 08:38:41 +0200 you wrote:

> On Sonntag 09 April 2006 05:28, AgentX wrote:
> > Hello, Stefan Lucke <....>,
> > 
> > At Sat, 8 Apr 2006 19:49:53 +0200 you wrote:
> > 
> > > On Samstag 08 April 2006 18:40, AgentX wrote:
> > > > Hello !
> > > > 
> > > > I think that I write to right place, I successefuly installed your plugin and it works without any bugs, except one - Packed color problem:
> > > > I see the "red lines" on red color, "blue lines" on blue color, other interlacaing support (fields sync and etc) works well.
> > > > In MPlayer you can fix that with mplayer -vf ilpack, but of course I can't do it in softdevice. 
> > > 
> > > Didn't find something about ilpack for -vf in mplayer docs.
> > > I guess I didn't understand how your error shows up ( "red lines" on red color ..).
> > > Could you place a screenshot picture of your problem somewhere ?
> > > 
> > > > I tried to switch another colorspace (YV12, I420) in softdevice, but I after the picture goes away from screen and I don't see anything. 
> > > > I set another colorspace in /etc/directfbrc but this don't take effect - the softdevice uses YUY2. 
> > > > How I can fix this problem ?
> > > 
> > > TV-out works only in YUY2 format, as thats the only fromat which 
> > > supports ARGB destination surface format.
> > > 
> > > > 
> > > > My card: Matrox G450 RGB via VGA cable
> > > 
> > > For TV-out you need a self made cable.
> > > Whats the memory size of your card ?
> > > 
> > > For not subscribed people it is best to drop a note but about
> > > that, so that others could keep you on cc .
> > > 
> > > > I am using the DirectFB (last from cvs 2006-03-27)
> > > > Softdevice: Last from CVS too 2006-03-27
> > > > Program: VDR 1.3.38
> > > > I am running VDR with:
> > > > vdr -P"softdevice -vo dfb:mgatv:"
> > > > 
> > > > My /etc/directfbrc
> 
> > > > 
> > > > With best regards 
> > > > AgentX. 
> > > > Thank you !
> > > > 
> > > 
> > > -- 
> > > Stefan Lucke
> > > 
> > 
> > Thanks for your answer !
> > Yes, I my TV-out working via special cable (VGA->SCART), I am already make it. 
> > And about the mplayer -fv ilpack filter:
> > 
> > When interlaced video is stored in YUV 4:2:0 formats, chroma interlacing does not line up properly due to 
> > vertical downsampling of the chroma channels. This filter packs the planar 4:2:0 data into YUY2 (4:2:2) format 
> > with the chroma lines in their proper locations, so that in any given scanline, the luma and chroma 
> > data both come from the same field. The optional argument selects the sampling mode. 
> > By default, linear interpolation (mode 1) is used. Mode 0 uses nearest-neighbor sampling, which is fast but incorrect.    
> 
> Assuming your TV is 4:3 format. 
> Do you get this allways or only when 16:9 video is downscaled to fit
> the 4:3 area of your TV ?
> 
> During 420 to 422 conversion we just repeat chroma information. This is
> not the optimal way, when chroma information is field based. By default
> we assume chroma is frame based. The only PAL source 420 I know
> that used frame based chroma is DV. libdv at sourceforge is using 
> a field based approach for generating 422 data.
> 
> > 
> > It's from man page of mplayer, it's fully describing my problem : 
> > 1)  chroma lines are not in their proper locations 
> > 2) chroma interlacing does not line up properly. 
> > If I applying this filter for videos in MPlayer - I don't have my problem with color - I don't see any color defects.   
> > 
> > I tried to set the yuy2 color in directfbrc, but nothing happens. 
> 
> We are selecting the surface pixel format, so this overrides your selection.
> 
> > About screenshot - I don't have a camera. But my problem is it, that about I wrote above.  
> 
> Do you get this effect for all of your sources (DVB-x) ?
> Can you place a short recording (<= 2 minutes) that shows up 
> your problem, for downloading ?
> 
> Subscribing to our list may be a good idea too.
> 
> > Waiting for your answer.
> > With best regards.
> > AgentX.
> 
> -- 
> Stefan Lucke
> 

Hello !
Thanks for your answer ! 
I have only one source  - DVB-S, i don't have any other. 
And so I found the camera (hmm not real camera the web camera) and take photos.
I see the red (blue green and etc) lines on moving objects. The pictures on photos REALLY is I see ! This is not a capture defect of the camera !
And look on the short movie: Take  attention  when Vh1 logo is moving(chaning).
The movie: 
http://vm22.on.ufanet.ru/defect.avi

Thanks !
Waiting for your answer.
With best regards.
AgentX

P.S.

I try to subsciribe to mailing list but I was not receive the confirmations. Now I get confirmation on my alternative and subcribed:
E-Mail: jonis2006 at yandex.ru.










From M.Wache at gmx.net  Sun Apr  9 13:05:41 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 09 Apr 2006 13:05:41 +0200
Subject: [Softdevice-devel] Vertical line at right OSD border
In-Reply-To: <20060408185234.GA4556@localhost.localdomain>
References: <20060404194723.GA352458@kosh.hut.fi> <200604050754.10260.stefan@lucke.in-berlin.de> <20060408185234.GA4556@localhost.localdomain>
Message-ID: <4438EA85.1090207@gmx.net>

Marko M?kel? schrieb:
> On Wed, Apr 05, 2006 at 07:54:10AM +0200, Stefan Lucke wrote:
>> On Dienstag 04 April 2006 21:47, Marko M?kel? wrote:
>>> Due to hardware failure, I had to switch from DirectFB mgatv output to
>>> DirectFB VGA on my Matrox G450 card.  No matter which color space or
>>> crop mode I choose, the right-hand border of the OSD layer contains a
>>> green line whenever a menu is open.  Every second scanline is bright
>>> green, and every other line is black or transparent.  Upgrading to
>>> softdevice CVS did not help.  Is this a known issue?
>> It's the same her with xv-out. It happens only with pseudo OSD
>> and it depends on selected screen aspect, only when set to 5:4 or 4:3
>> on a 5:4 screen. 
> 
> I'm getting it on DirectFB VGA no matter what screen aspect or crop mode
> is selected.  Sometimes, the bar only fills part of the right border
> (e.g., when the "||" (Pause) symbol is displayed at the bottom of the screen
> when using the classic theme).
> 
> The bar is somewhat annoying, because it is displayed for a few seconds
> whenever subtitles appear or disappear (and that is practically always
> when watching a foreign program on any of the state-run channels in
> Finland).
> 
Please try the attached patch, it won't fix the original problem (which
I already tried to find some time ago) but it should cure the symptons

> I also noticed some flicker when the OSD is active.  Alpha blending is set
> to "pseudo".  I don't remember experiencing such flicker before.
> 
The alpha blending setting has no effect on directFB, it's only for
vidix and Xv-video out. Is the OSD flickering or the video flickering?

Bye,
Martin
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: diff.txt
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060409/02b94306/attachment.txt>

From stefan at lucke.in-berlin.de  Sun Apr  9 14:23:49 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 9 Apr 2006 14:23:49 +0200
Subject: [Softdevice-devel] Vertical line at right OSD border
In-Reply-To: <4438EA85.1090207@gmx.net>
References: <20060404194723.GA352458@kosh.hut.fi> <20060408185234.GA4556@localhost.localdomain> <4438EA85.1090207@gmx.net>
Message-ID: <200604091423.50372.stefan@lucke.in-berlin.de>

On Sonntag 09 April 2006 13:05, Martin Wache wrote:
> Marko M?kel? schrieb:
> > On Wed, Apr 05, 2006 at 07:54:10AM +0200, Stefan Lucke wrote:
> >> On Dienstag 04 April 2006 21:47, Marko M?kel? wrote:
> >>> Due to hardware failure, I had to switch from DirectFB mgatv output to
> >>> DirectFB VGA on my Matrox G450 card.  No matter which color space or
> >>> crop mode I choose, the right-hand border of the OSD layer contains a
> >>> green line whenever a menu is open.  Every second scanline is bright
> >>> green, and every other line is black or transparent.  Upgrading to
> >>> softdevice CVS did not help.  Is this a known issue?
> >> It's the same her with xv-out. It happens only with pseudo OSD
> >> and it depends on selected screen aspect, only when set to 5:4 or 4:3
> >> on a 5:4 screen. 
> > 
> > I'm getting it on DirectFB VGA no matter what screen aspect or crop mode
> > is selected.  Sometimes, the bar only fills part of the right border
> > (e.g., when the "||" (Pause) symbol is displayed at the bottom of the screen
> > when using the classic theme).
> > 
> > The bar is somewhat annoying, because it is displayed for a few seconds
> > whenever subtitles appear or disappear (and that is practically always
> > when watching a foreign program on any of the state-run channels in
> > Finland).
> > 
> Please try the attached patch, it won't fix the original problem (which
> I already tried to find some time ago) but it should cure the symptons

It does cure the sympton for xv-out with pseudo OSD, but it seems to
have somebad effect when OSD drawing is set to software. Some
chars ('a' and 'e') get hard readable ;-( .
That depends on setting of "Screen Aspect" , see the screenshots at:
http://lucke.in-berlin.de/OSD/ 

> 
> > I also noticed some flicker when the OSD is active.  Alpha blending is set
> > to "pseudo".  I don't remember experiencing such flicker before.
> > 
> The alpha blending setting has no effect on directFB, it's only for
> vidix and Xv-video out. Is the OSD flickering or the video flickering?
> 
> Bye,
> Martin
> 

-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Sun Apr  9 15:34:11 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 9 Apr 2006 15:34:11 +0200
Subject: [Softdevice-devel] Vertical line at right OSD border
In-Reply-To: <200604091423.50372.stefan@lucke.in-berlin.de>
References: <20060404194723.GA352458@kosh.hut.fi> <4438EA85.1090207@gmx.net> <200604091423.50372.stefan@lucke.in-berlin.de>
Message-ID: <200604091534.11888.stefan@lucke.in-berlin.de>

On Sonntag 09 April 2006 14:23, Stefan Lucke wrote:
> On Sonntag 09 April 2006 13:05, Martin Wache wrote:
> > Marko M?kel? schrieb:
> > > On Wed, Apr 05, 2006 at 07:54:10AM +0200, Stefan Lucke wrote:
> > >> On Dienstag 04 April 2006 21:47, Marko M?kel? wrote:
> > >>> Due to hardware failure, I had to switch from DirectFB mgatv output to
> > >>> DirectFB VGA on my Matrox G450 card.  No matter which color space or
> > >>> crop mode I choose, the right-hand border of the OSD layer contains a
> > >>> green line whenever a menu is open.  Every second scanline is bright
> > >>> green, and every other line is black or transparent.  Upgrading to
> > >>> softdevice CVS did not help.  Is this a known issue?
> > >> It's the same her with xv-out. It happens only with pseudo OSD
> > >> and it depends on selected screen aspect, only when set to 5:4 or 4:3
> > >> on a 5:4 screen. 
> > > 
> > > I'm getting it on DirectFB VGA no matter what screen aspect or crop mode
> > > is selected.  Sometimes, the bar only fills part of the right border
> > > (e.g., when the "||" (Pause) symbol is displayed at the bottom of the screen
> > > when using the classic theme).
> > > 
> > > The bar is somewhat annoying, because it is displayed for a few seconds
> > > whenever subtitles appear or disappear (and that is practically always
> > > when watching a foreign program on any of the state-run channels in
> > > Finland).
> > > 
> > Please try the attached patch, it won't fix the original problem (which
> > I already tried to find some time ago) but it should cure the symptons
> 
> It does cure the sympton for xv-out with pseudo OSD, but it seems to
> have somebad effect when OSD drawing is set to software. Some
> chars ('a' and 'e') get hard readable ;-( .
> That depends on setting of "Screen Aspect" , see the screenshots at:
> http://lucke.in-berlin.de/OSD/ 
> 

Scaling effect ('a', 'e') is the same without patch, so forget 2nd
part of my comment.

-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Sun Apr  9 16:14:04 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 9 Apr 2006 16:14:04 +0200
Subject: [Softdevice-devel] Packed color problem
In-Reply-To: <4438E3A4.000001.18262@webmail10.yandex.ru>
References: <4438E3A4.000001.18262@webmail10.yandex.ru>
Message-ID: <200604091614.04847.stefan@lucke.in-berlin.de>

On Sonntag 09 April 2006 12:36, jonis2006 wrote:
> Hello, Stefan Lucke,
> 
> At Sun, 9 Apr 2006 08:38:41 +0200 you wrote:
> 
> > On Sonntag 09 April 2006 05:28, AgentX wrote:
> > > Hello, Stefan Lucke <....>,
> > > 
> > > At Sat, 8 Apr 2006 19:49:53 +0200 you wrote:
> > > 
> > > > On Samstag 08 April 2006 18:40, AgentX wrote:
> > > > > Hello !
> > > > > 
> > > > > I think that I write to right place, I successefuly installed your plugin and it works without any bugs, except one - Packed color problem:
> > > > > I see the "red lines" on red color, "blue lines" on blue color, other interlacaing support (fields sync and etc) works well.
> > > > > In MPlayer you can fix that with mplayer -vf ilpack, but of course I can't do it in softdevice. 
> > > > 
> > > > Didn't find something about ilpack for -vf in mplayer docs.
> > > > I guess I didn't understand how your error shows up ( "red lines" on red color ..).
> > > > Could you place a screenshot picture of your problem somewhere ?
> > > > 
> > > > > I tried to switch another colorspace (YV12, I420) in softdevice, but I after the picture goes away from screen and I don't see anything. 
> > > > > I set another colorspace in /etc/directfbrc but this don't take effect - the softdevice uses YUY2. 
> > > > > How I can fix this problem ?
> > > > 
> > > > TV-out works only in YUY2 format, as thats the only fromat which 
> > > > supports ARGB destination surface format.
> > > > 
> > > > > 
> > > > > My card: Matrox G450 RGB via VGA cable
> > > > 
> > > > For TV-out you need a self made cable.
> > > > Whats the memory size of your card ?
> > > > 
> > > > For not subscribed people it is best to drop a note but about
> > > > that, so that others could keep you on cc .
> > > > 
> > > > > I am using the DirectFB (last from cvs 2006-03-27)
> > > > > Softdevice: Last from CVS too 2006-03-27
> > > > > Program: VDR 1.3.38
> > > > > I am running VDR with:
> > > > > vdr -P"softdevice -vo dfb:mgatv:"
> > > > > 
> > > > > My /etc/directfbrc
> > 
> > > > > 
> > > > > With best regards 
> > > > > AgentX. 
> > > > > Thank you !
> > > > > 
> > > > 
> > > > -- 
> > > > Stefan Lucke
> > > > 
> > > 
> > > Thanks for your answer !
> > > Yes, I my TV-out working via special cable (VGA->SCART), I am already make it. 
> > > And about the mplayer -fv ilpack filter:
> > > 
> > > When interlaced video is stored in YUV 4:2:0 formats, chroma interlacing does not line up properly due to 
> > > vertical downsampling of the chroma channels. This filter packs the planar 4:2:0 data into YUY2 (4:2:2) format 
> > > with the chroma lines in their proper locations, so that in any given scanline, the luma and chroma 
> > > data both come from the same field. The optional argument selects the sampling mode. 
> > > By default, linear interpolation (mode 1) is used. Mode 0 uses nearest-neighbor sampling, which is fast but incorrect.    
> > 
> > Assuming your TV is 4:3 format. 
> > Do you get this allways or only when 16:9 video is downscaled to fit
> > the 4:3 area of your TV ?
> > 
> > During 420 to 422 conversion we just repeat chroma information. This is
> > not the optimal way, when chroma information is field based. By default
> > we assume chroma is frame based. The only PAL source 420 I know
> > that used frame based chroma is DV. libdv at sourceforge is using 
> > a field based approach for generating 422 data.
> > 
> > > 
> > > It's from man page of mplayer, it's fully describing my problem : 
> > > 1)  chroma lines are not in their proper locations 
> > > 2) chroma interlacing does not line up properly. 
> > > If I applying this filter for videos in MPlayer - I don't have my problem with color - I don't see any color defects.   
> > > 
> > > I tried to set the yuy2 color in directfbrc, but nothing happens. 
> > 
> > We are selecting the surface pixel format, so this overrides your selection.
> > 
> > > About screenshot - I don't have a camera. But my problem is it, that about I wrote above.  
> > 
> > Do you get this effect for all of your sources (DVB-x) ?
> > Can you place a short recording (<= 2 minutes) that shows up 
> > your problem, for downloading ?
> > 
> > Subscribing to our list may be a good idea too.
> > 
> > > Waiting for your answer.
> > > With best regards.
> > > AgentX.
> > 
> > -- 
> > Stefan Lucke
> > 
> 
> Hello !
> Thanks for your answer ! 
> I have only one source  - DVB-S, i don't have any other. 
> And so I found the camera (hmm not real camera the web camera) and take photos.
> I see the red (blue green and etc) lines on moving objects. The pictures on photos REALLY is I see ! This is not a capture defect of the camera !
> And look on the short movie: Take  attention  when Vh1 logo is moving(chaning).
> The movie: 
> http://vm22.on.ufanet.ru/defect.avi

Thats not what I actually expected (expected a 000.vdr file).
Whats written to syslog as scaling parameters (like:) ?

Apr  9 14:53:02 jarada jarada vdr: [14478] [VideoOut]: aspect changed (0 -> 0 ; 1.366667 -> 1.333333)
Apr  9 14:53:02 jarada jarada vdr: [14478] [VideoOut]: 720x576 [0,0 720x576] -> 1024x576 [128,0 768x576]

-- 
Stefan Lucke


From marko.makela at hut.fi  Sun Apr  9 21:48:17 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sun, 9 Apr 2006 22:48:17 +0300
Subject: [Softdevice-devel] Vertical line at right OSD border
In-Reply-To: <4438EA85.1090207@gmx.net>
References: <20060404194723.GA352458@kosh.hut.fi> <200604050754.10260.stefan@lucke.in-berlin.de> <20060408185234.GA4556@localhost.localdomain> <4438EA85.1090207@gmx.net>
Message-ID: <20060409194817.GB4337@localhost.localdomain>

On Sun, Apr 09, 2006 at 01:05:41PM +0200, Martin Wache wrote:
> > I'm getting it on DirectFB VGA no matter what screen aspect or crop mode
> > is selected.  Sometimes, the bar only fills part of the right border
> > (e.g., when the "||" (Pause) symbol is displayed at the bottom of the screen
> > when using the classic theme).
> > 
> > The bar is somewhat annoying, because it is displayed for a few seconds
> > whenever subtitles appear or disappear (and that is practically always
> > when watching a foreign program on any of the state-run channels in
> > Finland).
> > 
> Please try the attached patch, it won't fix the original problem (which
> I already tried to find some time ago) but it should cure the symptons

Yes, cutting the 2 pixels from the right cures the symptoms.

> > I also noticed some flicker when the OSD is active.  Alpha blending is set
> > to "pseudo".  I don't remember experiencing such flicker before.
> > 
> The alpha blending setting has no effect on directFB, it's only for
> vidix and Xv-video out.

Would it be possible to omit the irrelevant entries from the menu?
For instance, do not show the alpha blending setting when DirectFB output
is selected.  That would be less confusing.

> Is the OSD flickering or the video flickering?

I'm not sure, but I think it is the OSD.  It occurs very rarely, so it
is hard to repeat.  The CPU is a bit over 50% idle.

	Marko


From lucianm at users.sourceforge.net  Mon Apr 10 02:02:05 2006
From: lucianm at users.sourceforge.net (Lucian Muresan)
Date: Mon, 10 Apr 2006 02:02:05 +0200
Subject: [Softdevice-devel] [PATCH] upmix mono to stereo (to be audible via SPDIF)
Message-ID: <4439A07D.4060900@users.sourceforge.net>

Hi folks,

if I only tried this myself earlier, didn't know it was so simple :-).
Some of you might remember I mentioned I'm receiving several DVB-S
channels whith just mono MP2 sound, and can't hear anything in my
external amp hooked via SPDIF. Well, that's because PCM sent via SPDIF
has to be stereo, and up to now, softdevice sent it mono as it came on
those channels, therefore the amp couldn't understand it. The attached
patch cures this. It's odd that the audioMode says "stereo" (maybe as
it's nor left language or right language), but the number of channels
says 1.
I've seen that the audiosamples array is allocated big enough, so I just
doubled the samples and modified the lenght and channel number, I hope
that's ok and gets adopted somehow.

Cheers,
Lucian
-------------- next part --------------
A non-text attachment was scrubbed...
Name: vdr-softdevice-0.2.2.20060315_mono.diff
Type: text/x-patch
Size: 1568 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060410/2813e719/attachment.bin>

From marko.makela at hut.fi  Mon Apr 10 22:13:13 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 10 Apr 2006 23:13:13 +0300
Subject: [Softdevice-devel] Flicker when video is paused
In-Reply-To: <4438EA85.1090207@gmx.net>
References: <20060404194723.GA352458@kosh.hut.fi> <200604050754.10260.stefan@lucke.in-berlin.de> <20060408185234.GA4556@localhost.localdomain> <4438EA85.1090207@gmx.net>
Message-ID: <20060410201313.GA3754@localhost.localdomain>

On Sun, Apr 09, 2006 at 01:05:41PM +0200, Martin Wache wrote:
> > I also noticed some flicker when the OSD is active.  Alpha blending is set
> > to "pseudo".  I don't remember experiencing such flicker before.
> > 
> The alpha blending setting has no effect on directFB, it's only for
> vidix and Xv-video out. Is the OSD flickering or the video flickering?

Now I got a repeatable test case for this.  While replaying a recording,
hit Pause and wait at least 10 seconds.  Every now and then, the video
image will be shortly filled with black, as if the screen were constantly
redrawn with missing synchronization on vertical retrace.  I wonder why
the screen would be redrawn, because there is absolutely no movement
in the video or the OSD.

If necessary, I can try to find out with OProfile what is causing the
screen to be redrawn.  Again, this is DirectFB VGA output on the
Matrox G450.

	Marko


From stefan at lucke.in-berlin.de  Mon Apr 10 23:41:44 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 10 Apr 2006 23:41:44 +0200
Subject: [Softdevice-devel] Flicker when video is paused
In-Reply-To: <20060410201313.GA3754@localhost.localdomain>
References: <20060404194723.GA352458@kosh.hut.fi> <4438EA85.1090207@gmx.net> <20060410201313.GA3754@localhost.localdomain>
Message-ID: <200604102341.44426.stefan@lucke.in-berlin.de>

On Montag 10 April 2006 22:13, Marko M?kel? wrote:
> On Sun, Apr 09, 2006 at 01:05:41PM +0200, Martin Wache wrote:
> > > I also noticed some flicker when the OSD is active.  Alpha blending is set
> > > to "pseudo".  I don't remember experiencing such flicker before.
> > > 
> > The alpha blending setting has no effect on directFB, it's only for
> > vidix and Xv-video out. Is the OSD flickering or the video flickering?
> 
> Now I got a repeatable test case for this.  While replaying a recording,
> hit Pause and wait at least 10 seconds.  Every now and then, the video
> image will be shortly filled with black, as if the screen were constantly
> redrawn with missing synchronization on vertical retrace.  I wonder why
> the screen would be redrawn, because there is absolutely no movement
> in the video or the OSD.

Try either commenting out line 97 of video.c :
OsdRefreshCounter > 80 || // blanks the screen after inactivity (4s)

Or make OsdRefreshCounter public (or protected) again and set
it to 0 at the beginning of YUV in video-dfb.c


-- 
Stefan Lucke


From jonis2006 at yandex.ru  Tue Apr 11 09:05:12 2006
From: jonis2006 at yandex.ru (jonis2006)
Date: Tue, 11 Apr 2006 11:05:12 +0400 (MSD)
Subject: [Softdevice-devel] Softdevice Matrox G450 YV12 problem.
Message-ID: <443B5528.000004.11240@ariel.yandex.ru>

Hello !
I can't switch my Matrox G450 to YV12 output color in Softdevice - Only YUY2 working.
When I switching to YV12 - picture working very slowly and have inverted color.
It is possible to fix that ?


From marko.makela at hut.fi  Tue Apr 11 09:37:19 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 11 Apr 2006 10:37:19 +0300
Subject: [Softdevice-devel] Flicker when video is paused
In-Reply-To: <200604102341.44426.stefan@lucke.in-berlin.de>
References: <20060404194723.GA352458@kosh.hut.fi> <4438EA85.1090207@gmx.net> <20060410201313.GA3754@localhost.localdomain> <200604102341.44426.stefan@lucke.in-berlin.de>
Message-ID: <20060411073719.GA3769@localhost.localdomain>

On Mon, Apr 10, 2006 at 11:41:44PM +0200, Stefan Lucke wrote:
> Try either commenting out line 97 of video.c :
> OsdRefreshCounter > 80 || // blanks the screen after inactivity (4s)

Thanks, this seems to cure the problem.  When playback is paused,
libvdr-softdevice is using less than 0.2% of logged CPU, and vdr
is using 2.3%.  Without the patch, softdevice uses 0.8%.

Here's the CPU usage of softdevice after the patch, with playback paused:

CPU: PIII, speed 906.822 MHz (estimated)
Counted CPU_CLK_UNHALTED events (clocks processor is not halted) with a unit mask of 0x00 (No unit mask) count 90000
samples  %        symbol name
14       21.2121  cSoftOsd::Action()
9        13.6364  cRelTimer::GetRelTime()
9        13.6364  cSoftOsd::SetMode(int, bool, bool, bool, unsigned char*)
6         9.0909  cVideoOut::AdjustOSDMode()
5         7.5758  cVideoOut::Action()
4         6.0606  cDFBRemote::Action()
4         6.0606  cSoftDevice::Poll(cPoller&, int)
4         6.0606  cStreamDecoder::Action()
2         3.0303  cDFBVideoOut::GetOSDDimension(int&, int&, int&, int&)
2         3.0303  cDFBVideoOut::GetOSDMode(int&, bool&, bool&, bool&, unsigned char*&)
2         3.0303  cMpeg2Decoder::Action()
2         3.0303  cMpeg2Decoder::BufferFill(int)
1         1.5152  cDFBVideoOut::ProcessEvents()
1         1.5152  cDFBVideoOut::ShowOSD()
1         1.5152  cSoftDevice::HasDecoder() const

The sampler was run for 20 seconds.  To get somewhat more accurate results,
I'd let OProfile gather samples for at least 1000 seconds.

BTW, what is the difference between cRelTimer::TimePassed() and
cRelTimer::GetRelTime()?

> Or make OsdRefreshCounter public (or protected) again and set
> it to 0 at the beginning of YUV in video-dfb.c

Why is YUV called when the playback is paused?  Is it because ffmpeg is not
writing directly to the frame buffer?  Interestingly, I did see a few samples
of YUV when the patch was not applied (and none when it was).  Maybe this is
because with the patch, the load on the memory bus (or cache) is reduced.

	Marko


From jonis2006 at yandex.ru  Tue Apr 11 09:38:14 2006
From: jonis2006 at yandex.ru (jonis2006)
Date: Tue, 11 Apr 2006 11:38:14 +0400 (MSD)
Subject: [Softdevice-devel] Packed Color - problem - Videofile of defects and log of VDR
Message-ID: <443B5CE6.000004.23780@mfront7.yandex.ru>

Hello !
I have already wrote to Softdevice mailing list about my problem, and Stefan Lucke requsted a vdr file with defects: 
Here is:
http://vm22.ufanet.ru/002.vdr
Look at the red human - If you will use yuy2 color with directfb, you will get red lines on TV screen. If you will use YV12 (He is not working on Matrox G450 with softdevice) picture will be displayed properly.
With Mplayer DFB YV12 output works well.
/etc/directfbrc
# layer setup 
# 
mode=768x576-32
primary-layer=2
pixelformat=YV12
depth=32

# 
# output setup 
# 
matrox-crtc2 
matrox-tv-standard=pal 
matrox-cable-type=scart-rgb
# 
# misc 
# 
#input=lirc
#disable-module=keyboard
disable-module=lirc
disable-module=joystick
disable-module=mutouch
disable-module=ps2mouse
disable-module=sdlinput
disable-module=serialmouse
disable-module=sonypi
------------------
LOG:
INFO: loading ca cache from /video/plugins/ca.cache
WARNING: no smartcard interface defined!
cam 0: try to open ca device myself
cam 0: no ca device, assuming budget card & SoftCSA
INFO: Using software decryption on card 0
[dfb] (re)configuring Videolayer to 736 x 576 (720x576)
[dfb] creating new surface (stretchBlit)
[surface capabilities] videoSurface: videoonly
[dfb] (re)configured 0x00200806
[dfb] (re)configuring Videolayer to 736 x 576 (736x576)
[dfb] creating new surface (stretchBlit)
[surface capabilities] videoSurface: videoonly
[dfb] (re)configured 0x00200806
[dfb] (re)configuring Videolayer to 720 x 576 (720x576)
[dfb] creating new surface (stretchBlit)


How to fix that ?


From jonis2006 at yandex.ru  Tue Apr 11 09:41:49 2006
From: jonis2006 at yandex.ru (jonis2006)
Date: Tue, 11 Apr 2006 11:41:49 +0400 (MSD)
Subject: [Softdevice-devel] Packed color problem - Video file with defects and log of VDR (Fixed mistake)
Message-ID: <443B5DBD.000003.21811@webmail9.yandex.ru>

Hello !
Sorry I mistake URL of the file in a previous message:
http://vm22.on.ufanet.ru/002.vdr
I have already wrote to Softdevice mailing list about my problem, and
Stefan Lucke requsted a vdr file with defects: 
Here is:
http://vm22.on.ufanet.ru/002.vdr
Look at the red human - If you will use yuy2 color with directfb, you will
get red lines on TV screen. If you will use YV12 (He is not working on
Matrox G450 with softdevice) picture will be displayed properly.
With Mplayer DFB YV12 output works well.
/etc/directfbrc
# layer setup 
# 
mode=768x576-32
primary-layer=2
pixelformat=YV12
depth=32

# 
# output setup 
# 
matrox-crtc2 
matrox-tv-standard=pal 
matrox-cable-type=scart-rgb
# 
# misc 
# 
#input=lirc
#disable-module=keyboard
disable-module=lirc
disable-module=joystick
disable-module=mutouch
disable-module=ps2mouse
disable-module=sdlinput
disable-module=serialmouse
disable-module=sonypi
------------------
LOG:
INFO: loading ca cache from /video/plugins/ca.cache
WARNING: no smartcard interface defined!
cam 0: try to open ca device myself
cam 0: no ca device, assuming budget card & SoftCSA
INFO: Using software decryption on card 0
[dfb] (re)configuring Videolayer to 736 x 576 (720x576)
[dfb] creating new surface (stretchBlit)
[surface capabilities] videoSurface: videoonly
[dfb] (re)configured 0x00200806
[dfb] (re)configuring Videolayer to 736 x 576 (736x576)
[dfb] creating new surface (stretchBlit)
[surface capabilities] videoSurface: videoonly
[dfb] (re)configured 0x00200806
[dfb] (re)configuring Videolayer to 720 x 576 (720x576)
[dfb] creating new surface (stretchBlit)


How to fix that ?


From M.Wache at gmx.net  Tue Apr 11 20:45:59 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 11 Apr 2006 20:45:59 +0200
Subject: [Softdevice-devel] [PATCH] upmix mono to stereo (to be audible
 via SPDIF)
In-Reply-To: <4439A07D.4060900@users.sourceforge.net>
References: <4439A07D.4060900@users.sourceforge.net>
Message-ID: <443BF967.5090707@gmx.net>

Lucian Muresan schrieb:
> Hi folks,
> 
> if I only tried this myself earlier, didn't know it was so simple :-).
> Some of you might remember I mentioned I'm receiving several DVB-S
> channels whith just mono MP2 sound, and can't hear anything in my
> external amp hooked via SPDIF. Well, that's because PCM sent via SPDIF
> has to be stereo, and up to now, softdevice sent it mono as it came on
> those channels, therefore the amp couldn't understand it. The attached
> patch cures this. It's odd that the audioMode says "stereo" (maybe as
> it's nor left language or right language), but the number of channels
> says 1.
> I've seen that the audiosamples array is allocated big enough, so I just
> doubled the samples and modified the lenght and channel number, I hope
> that's ok and gets adopted somehow.
> 
The patch looks okay except that it should do something sensible in case
that the audiosamples is too small. I don't think that this actually
will happen, but if we don't handle that case the softdevice will crash
which is always bad. I think reallocating a that case bigger buffer is
enough.
I'm a bit short on time, so if you fix this issue we can apply the
patch. Otherwise you have to wait until I find some time to fix it myself.

Bye,
Martin




From M.Wache at gmx.net  Tue Apr 11 21:01:46 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 11 Apr 2006 21:01:46 +0200
Subject: [Softdevice-devel] Flicker when video is paused
In-Reply-To: <200604102341.44426.stefan@lucke.in-berlin.de>
References: <20060404194723.GA352458@kosh.hut.fi> <4438EA85.1090207@gmx.net> <20060410201313.GA3754@localhost.localdomain> <200604102341.44426.stefan@lucke.in-berlin.de>
Message-ID: <443BFD1A.7040708@gmx.net>

Stefan Lucke schrieb:
> On Montag 10 April 2006 22:13, Marko M?kel? wrote:
>> On Sun, Apr 09, 2006 at 01:05:41PM +0200, Martin Wache wrote:
>>>> I also noticed some flicker when the OSD is active.  Alpha blending is set
>>>> to "pseudo".  I don't remember experiencing such flicker before.
>>>>
>>> The alpha blending setting has no effect on directFB, it's only for
>>> vidix and Xv-video out. Is the OSD flickering or the video flickering?
>> Now I got a repeatable test case for this.  While replaying a recording,
>> hit Pause and wait at least 10 seconds.  Every now and then, the video
>> image will be shortly filled with black, as if the screen were constantly
>> redrawn with missing synchronization on vertical retrace.  I wonder why
>> the screen would be redrawn, because there is absolutely no movement
>> in the video or the OSD.
> 
> Try either commenting out line 97 of video.c :
> OsdRefreshCounter > 80 || // blanks the screen after inactivity (4s)
> 
If we just comment that line the screen won't be blanked. I really
wonder why it flickers just because the screen is redrawn. I mean
exactly the same methods are used like we normally use for video, so one
shouldn't see any flicker. Maybe redrawing on OSD change in software
mode and blanking the screen should be handled separately.

> Or make OsdRefreshCounter public (or protected) again and set
> it to 0 at the beginning of YUV in video-dfb.c
> 
That won't change anything, since OsdRefreshCounter is already set to
Zero in
DrawVideo and DrawStill and YUV is never called directly.

So should we apply the workaround for the original issue with the
vertical lines at the borders? I don't think that I will be able to fix
the real problem soon...

Bye,
Martin


From marko.makela at hut.fi  Tue Apr 11 21:46:24 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 11 Apr 2006 22:46:24 +0300
Subject: [Softdevice-devel] Flicker when video is paused
In-Reply-To: <443BFD1A.7040708@gmx.net>
References: <20060404194723.GA352458@kosh.hut.fi> <4438EA85.1090207@gmx.net> <20060410201313.GA3754@localhost.localdomain> <200604102341.44426.stefan@lucke.in-berlin.de> <443BFD1A.7040708@gmx.net>
Message-ID: <20060411194624.GA3731@localhost.localdomain>

On Tue, Apr 11, 2006 at 09:01:46PM +0200, Martin Wache wrote:
> > Try either commenting out line 97 of video.c :
> > OsdRefreshCounter > 80 || // blanks the screen after inactivity (4s)
> > 
> If we just comment that line the screen won't be blanked. I really
> wonder why it flickers just because the screen is redrawn. I mean
> exactly the same methods are used like we normally use for video, so one
> shouldn't see any flicker.

Could the DMA engine of the Matrox G450 be stalling?  Or could a context
switch disturb the timing?  Only vdr was running on the system.  The
disturbance looked like a black horizontal bar of varying height.  Once
the screen was completely black for approximately one frame (1/75 sec).

> So should we apply the workaround for the original issue with the
> vertical lines at the borders? I don't think that I will be able to fix
> the real problem soon...

Will the workaround reduce the horizontal resolution of the OSD layer?

	Marko


From stefan at lucke.in-berlin.de  Tue Apr 11 22:08:34 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 11 Apr 2006 22:08:34 +0200
Subject: [Softdevice-devel] Flicker when video is paused
In-Reply-To: <443BFD1A.7040708@gmx.net>
References: <20060404194723.GA352458@kosh.hut.fi> <200604102341.44426.stefan@lucke.in-berlin.de> <443BFD1A.7040708@gmx.net>
Message-ID: <200604112208.34671.stefan@lucke.in-berlin.de>

On Dienstag 11 April 2006 21:01, Martin Wache wrote:
> Stefan Lucke schrieb:
> > On Montag 10 April 2006 22:13, Marko M?kel? wrote:
> >> On Sun, Apr 09, 2006 at 01:05:41PM +0200, Martin Wache wrote:
> >>>> I also noticed some flicker when the OSD is active.  Alpha blending is set
> >>>> to "pseudo".  I don't remember experiencing such flicker before.
> >>>>
> >>> The alpha blending setting has no effect on directFB, it's only for
> >>> vidix and Xv-video out. Is the OSD flickering or the video flickering?
> >> Now I got a repeatable test case for this.  While replaying a recording,
> >> hit Pause and wait at least 10 seconds.  Every now and then, the video
> >> image will be shortly filled with black, as if the screen were constantly
> >> redrawn with missing synchronization on vertical retrace.  I wonder why
> >> the screen would be redrawn, because there is absolutely no movement
> >> in the video or the OSD.
> > 
> > Try either commenting out line 97 of video.c :
> > OsdRefreshCounter > 80 || // blanks the screen after inactivity (4s)
> > 
> If we just comment that line the screen won't be blanked. I really
> wonder why it flickers just because the screen is redrawn. I mean
> exactly the same methods are used like we normally use for video, so one
> shouldn't see any flicker. Maybe redrawing on OSD change in software
> mode and blanking the screen should be handled separately.

After a second though of my suggestion, I'm wondering why it had an
effect at all. Like you mentioned, OsdRefreshCounter is reset
in both functions (DrawStill and DrawVideo). So there should be no
additional call to YUV at all.

@Marko:
At which revision is your video.c file ?

> 
> > Or make OsdRefreshCounter public (or protected) again and set
> > it to 0 at the beginning of YUV in video-dfb.c
> > 
> That won't change anything, since OsdRefreshCounter is already set to
> Zero in
> DrawVideo and DrawStill and YUV is never called directly.
> 
> So should we apply the workaround for the original issue with the
> vertical lines at the borders? I don't think that I will be able to fix
> the real problem soon...

I guess we should apply that. The only drawback is, that the first
channel status OSD after startup, seems a bit garbeld in pseudo mode.
A few coloums are repeated on the right side.


-- 
Stefan Lucke


From marko.makela at hut.fi  Tue Apr 11 22:21:33 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 11 Apr 2006 23:21:33 +0300
Subject: [Softdevice-devel] Flicker when video is paused
In-Reply-To: <200604112208.34671.stefan@lucke.in-berlin.de>
References: <20060404194723.GA352458@kosh.hut.fi> <200604102341.44426.stefan@lucke.in-berlin.de> <443BFD1A.7040708@gmx.net> <200604112208.34671.stefan@lucke.in-berlin.de>
Message-ID: <20060411202133.GB3731@localhost.localdomain>

On Tue, Apr 11, 2006 at 10:08:34PM +0200, Stefan Lucke wrote:
> > > Try either commenting out line 97 of video.c :
> > > OsdRefreshCounter > 80 || // blanks the screen after inactivity (4s)
> > > 
> > If we just comment that line the screen won't be blanked. I really
> > wonder why it flickers just because the screen is redrawn. I mean
> > exactly the same methods are used like we normally use for video, so one
> > shouldn't see any flicker. Maybe redrawing on OSD change in software
> > mode and blanking the screen should be handled separately.
> 
> After a second though of my suggestion, I'm wondering why it had an
> effect at all. Like you mentioned, OsdRefreshCounter is reset
> in both functions (DrawStill and DrawVideo). So there should be no
> additional call to YUV at all.
> 
> @Marko:
> At which revision is your video.c file ?

CVS from yesterday or Sunday, when I upgraded to vdr 1.3.46.  I'm afraid
I won't have time to diagnose further until some time next week.

	Marko


From lucianm at users.sourceforge.net  Wed Apr 12 01:39:55 2006
From: lucianm at users.sourceforge.net (Lucian Muresan)
Date: Wed, 12 Apr 2006 01:39:55 +0200
Subject: [Softdevice-devel] [PATCH] upmix mono to stereo (to be audible
 via SPDIF)
In-Reply-To: <443BF967.5090707@gmx.net>
References: <4439A07D.4060900@users.sourceforge.net> <443BF967.5090707@gmx.net>
Message-ID: <443C3E4B.1020303@users.sourceforge.net>

Martin Wache wrote:
[..]
> The patch looks okay except that it should do something sensible in case
> that the audiosamples is too small. I don't think that this actually
> will happen, but if we don't handle that case the softdevice will crash
> which is always bad. I think reallocating a that case bigger buffer is
> enough.
> I'm a bit short on time, so if you fix this issue we can apply the
> patch. Otherwise you have to wait until I find some time to fix it myself.

Ok, here is a version which reallocates audiosamples (I changed the
signature of UpmixMono to use references to the audiosamples buffer,
respectively to the lenght) just in case. Seems a bit overdozed, but
you're right, even if it#s very unlikely to happen, it shouldn't be left
not handled.

Lucian

-------------- next part --------------
A non-text attachment was scrubbed...
Name: vdr-softdevice-0.2.2.20060315_mono.diff
Type: text/x-patch
Size: 2697 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060412/95255b76/attachment.bin>

From marko.makela at hut.fi  Wed Apr 12 09:13:07 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 12 Apr 2006 10:13:07 +0300
Subject: [Softdevice-devel] Flicker when video is paused
In-Reply-To: <20060411202133.GB3731@localhost.localdomain>
References: <20060404194723.GA352458@kosh.hut.fi> <200604102341.44426.stefan@lucke.in-berlin.de> <443BFD1A.7040708@gmx.net> <200604112208.34671.stefan@lucke.in-berlin.de> <20060411202133.GB3731@localhost.localdomain>
Message-ID: <20060412071307.GA3652@localhost.localdomain>

On Tue, Apr 11, 2006 at 11:21:33PM +0300, Marko M?kel? wrote:
> > After a second though of my suggestion, I'm wondering why it had an
> > effect at all. Like you mentioned, OsdRefreshCounter is reset
> > in both functions (DrawStill and DrawVideo). So there should be no
> > additional call to YUV at all.
> > 
> > @Marko:
> > At which revision is your video.c file ?
> 
> CVS from yesterday or Sunday, when I upgraded to vdr 1.3.46.  I'm afraid
> I won't have time to diagnose further until some time next week.

I forgot that I have added two usleep() calls to video-dfb.c to avoid
busy-waiting for "graphics controller ready", as I mentioned some weeks
ago.  Those calls should not be executed when VGA output (as opposed to
mgatv) is selected.

	Marko


From marko.makela at hut.fi  Wed Apr 12 17:00:39 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 12 Apr 2006 18:00:39 +0300
Subject: [Softdevice-devel] Flicker when video is paused
In-Reply-To: <20060411202133.GB3731@localhost.localdomain>
References: <20060404194723.GA352458@kosh.hut.fi> <200604102341.44426.stefan@lucke.in-berlin.de> <443BFD1A.7040708@gmx.net> <200604112208.34671.stefan@lucke.in-berlin.de> <20060411202133.GB3731@localhost.localdomain>
Message-ID: <20060412150039.GA4006@localhost.localdomain>

On Tue, Apr 11, 2006 at 11:21:33PM +0300, Marko M?kel? wrote:
> > @Marko:
> > At which revision is your video.c file ?
> 
> CVS from yesterday or Sunday, when I upgraded to vdr 1.3.46.  I'm afraid
> I won't have time to diagnose further until some time next week.

It's up-to-date CVS as of now.  I tried reverting all my patches (attached),
and there was flicker when playback was paused.  So, the added usleep()
calls before srcSurface->Flip() are definitely not the culprit.  With the
patch applied, the flicker goes away.

	Marko
-------------- next part --------------
Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.51
diff -p -u -r1.51 video-dfb.c
--- video-dfb.c	12 Mar 2006 09:43:28 -0000	1.51
+++ video-dfb.c	12 Apr 2006 14:54:28 -0000
@@ -1335,6 +1335,7 @@ void cDFBVideoOut::ShowOSD ()
         scrSurface->SetBlittingFlags(DSBLIT_BLEND_ALPHACHANNEL);
         scrSurface->Blit(osdSurface, &osdsrc, 0, 0);
       }
+      usleep(1000);
       scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
 
     }
@@ -1486,6 +1487,7 @@ void cDFBVideoOut::YUV(uint8_t *Py, uint
 
       }
       //scrSurface->Flip(NULL, (setupStore->useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
+      usleep(2000);
       scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
 
     }
Index: video.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.c,v
retrieving revision 1.47
diff -p -u -r1.47 video.c
--- video.c	12 Mar 2006 09:43:28 -0000	1.47
+++ video.c	12 Apr 2006 14:54:28 -0000
@@ -94,7 +94,7 @@ void cVideoOut::Action()
     OsdRefreshCounter++;
     usleep(50000);
     if (
-        OsdRefreshCounter > 80 || // blanks the screen after inactivity (4s)
+//      OsdRefreshCounter > 80 || // blanks the screen after inactivity (4s)
         (setupStore->osdMode == OSDMODE_SOFTWARE &&
          OsdRefreshCounter>2 && Osd_changed))
     {

From stefan at lucke.in-berlin.de  Wed Apr 12 23:57:51 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 12 Apr 2006 23:57:51 +0200
Subject: [Softdevice-devel] [PATCH] upmix mono to stereo (to be audible via SPDIF)
In-Reply-To: <443C3E4B.1020303@users.sourceforge.net>
References: <4439A07D.4060900@users.sourceforge.net> <443BF967.5090707@gmx.net> <443C3E4B.1020303@users.sourceforge.net>
Message-ID: <200604122357.51664.stefan@lucke.in-berlin.de>

On Mittwoch 12 April 2006 01:39, Lucian Muresan wrote:
> Martin Wache wrote:
> [..]
> > The patch looks okay except that it should do something sensible in case
> > that the audiosamples is too small. I don't think that this actually
> > will happen, but if we don't handle that case the softdevice will crash
> > which is always bad. I think reallocating a that case bigger buffer is
> > enough.
> > I'm a bit short on time, so if you fix this issue we can apply the
> > patch. Otherwise you have to wait until I find some time to fix it myself.
> 
> Ok, here is a version which reallocates audiosamples (I changed the
> signature of UpmixMono to use references to the audiosamples buffer,
> respectively to the lenght) just in case. Seems a bit overdozed, but
> you're right, even if it#s very unlikely to happen, it shouldn't be left
> not handled.

> + ?if (Length > AVCODEC_MAX_AUDIO_FRAME_SIZE/2) {
> + ? ? // in this unlikely case, the buffer should be increased
> + ? ? BUFDEB(
> + ? ? ? "cAudioStreamDecoder::UpmixMono: reallocating too small buffer (%d) to %d\n",
> + ? ? ? AVCODEC_MAX_AUDIO_FRAME_SIZE, 2*Length );
> + ? ? samples = (uint8_t *)realloc(samples, 2*Length);

So in case realloc fails, you'll destroy your reference to an already
allocated buffer (before: samples != NULL, after: samples == NULL)

I would prefer the first version with extension that our initial buffer
is allocated with 2*AVCODEC_MAX_AUDIO_FRAME_SIZE .


-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Thu Apr 13 00:17:22 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 13 Apr 2006 00:17:22 +0200
Subject: [Softdevice-devel] Packed color problem - Video file with defects and log of VDR (Fixed mistake)
In-Reply-To: <443B5DBD.000003.21811@webmail9.yandex.ru>
References: <443B5DBD.000003.21811@webmail9.yandex.ru>
Message-ID: <200604130017.22399.stefan@lucke.in-berlin.de>

On Dienstag 11 April 2006 09:41, jonis2006 wrote:
> Hello !
> Sorry I mistake URL of the file in a previous message:
> http://vm22.on.ufanet.ru/002.vdr

Thanks for the file.

> I have already wrote to Softdevice mailing list about my problem, and
> Stefan Lucke requsted a vdr file with defects: 
> Here is:
> http://vm22.on.ufanet.ru/002.vdr
> Look at the red human - If you will use yuy2 color with directfb, you will
> get red lines on TV screen. If you will use YV12 (He is not working on
> Matrox G450 with softdevice) picture will be displayed properly.

With matrox cards I never had problems switching between color
formats via OSD when vga out is used. For TV-out only YUY2 is
supported.

> With Mplayer DFB YV12 output works well.
> /etc/directfbrc
> # layer setup 
> # 
> mode=768x576-32
> primary-layer=2
> pixelformat=YV12

Can you try to use pixelformat=ARGB as mentioned on
http://softdevice.berlios.de .

> depth=32
> 

-- 
Stefan Lucke


From lucianm at users.sourceforge.net  Thu Apr 13 09:02:10 2006
From: lucianm at users.sourceforge.net (Lucian Muresan)
Date: Thu, 13 Apr 2006 09:02:10 +0200
Subject: [Softdevice-devel] [PATCH] upmix mono to stereo (to be audible
 via SPDIF)
In-Reply-To: <200604122357.51664.stefan@lucke.in-berlin.de>
References: <4439A07D.4060900@users.sourceforge.net> <443BF967.5090707@gmx.net> <443C3E4B.1020303@users.sourceforge.net> <200604122357.51664.stefan@lucke.in-berlin.de>
Message-ID: <443DF772.9060900@users.sourceforge.net>

Stefan Lucke wrote:
> On Mittwoch 12 April 2006 01:39, Lucian Muresan wrote:
[..]
> 
>> +  if (Length > AVCODEC_MAX_AUDIO_FRAME_SIZE/2) {
>> +     // in this unlikely case, the buffer should be increased
>> +     BUFDEB(
>> +       "cAudioStreamDecoder::UpmixMono: reallocating too small buffer (%d) to %d\n",
>> +       AVCODEC_MAX_AUDIO_FRAME_SIZE, 2*Length );
>> +     samples = (uint8_t *)realloc(samples, 2*Length);
> 
> So in case realloc fails, you'll destroy your reference to an already
> allocated buffer (before: samples != NULL, after: samples == NULL)

If that would happen, I'm allocating it again few lines below to the
original size of AVCODEC_MAX_AUDIO_FRAME_SIZE, but if it would occur
indeed, the whole thing would repeat itself, so you're right it would be
ugly.
I'm just wondering if it _really_ would happen. From the debugging I've
done when trying out my patch I've seen that the length of the
audiosamples is actually 2304 (or something like that) for mono streams,
and exactly double for stereo, and both figures are really far, far away
from AVCODEC_MAX_AUDIO_FRAME_SIZE which is 192000.

> I would prefer the first version with extension that our initial buffer
> is allocated with 2*AVCODEC_MAX_AUDIO_FRAME_SIZE .

Of course, memory allocation should happen preferably only once. You
know your project and ffmpeg internals far better and can judge if
2*AVCODEC_MAX_AUDIO_FRAME_SIZE is not too large. On the other hand, is
there some other place where the length of the sample itself is set? I
mean, wasn't an overflow possible without my UpmixMono patch, is it
taken care of it dynamically already and checked that the lenght is
never larger, or was it just assumed that AVCODEC_MAX_AUDIO_FRAME_SIZE
will be enough due to its large value? If so, I wouldn't fear about mono
samples too much, the risk would be the same, unless the other
assumption is true and that chunk length is checked against
AVCODEC_MAX_AUDIO_FRAME_SIZE right at the place where it is fed to
softdevice. Don't know if it's even possible to have an influence on
that dynamic length (or is it dynamic, who sets it?)...

Lucian


From jonis2006 at yandex.ru  Thu Apr 13 13:44:45 2006
From: jonis2006 at yandex.ru (jonis2006)
Date: Thu, 13 Apr 2006 15:44:45 +0400 (MSD)
Subject: [Softdevice-devel] Packed color problem - Video file with defects and log of VDR (Fixed mistake)
In-Reply-To: <200604130017.22399.stefan@lucke.in-berlin.de>
References: <443B5DBD.000003.21811@webmail9.yandex.ru> <200604130017.22399.stefan@lucke.in-berlin.de>
Message-ID: <443E39AD.000007.26249@mfront8.yandex.ru>

>On Dienstag 11 April 2006 09:41, jonis2006 wrote:
>> Hello !
>> Sorry I mistake URL of the file in a previous message:
>> http://vm22.on.ufanet.ru/002.vdr
>
>Thanks for the file.
>
>> I have already wrote to Softdevice mailing list about my problem, and
>> Stefan Lucke requsted a vdr file with defects: 
>> Here is:
>> http://vm22.on.ufanet.ru/002.vdr
>> Look at the red human - If you will use yuy2 color with directfb, you will
>> get red lines on TV screen. If you will use YV12 (He is not working on
>> Matrox G450 with softdevice) picture will be displayed properly.
>
>With matrox cards I never had problems switching between color
>formats via OSD when vga out is used. For TV-out only YUY2 is
>supported.
>
>> With Mplayer DFB YV12 output works well.
>> /etc/directfbrc
>> # layer setup 
>> # 
>> mode=768x576-32
>> primary-layer=2
>> pixelformat=YV12
>
>Can you try to use pixelformat=ARGB as mentioned on
>http://softdevice.berlios.de .
>
>> depth=32
>> 

I tried ARGB, but picture is unchanged, problem still persist. Maybe solution is to take some MPlayer code to use it in SoftDevice ?


From stefan at lucke.in-berlin.de  Thu Apr 13 22:04:44 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 13 Apr 2006 22:04:44 +0200
Subject: [Softdevice-devel] Packed color problem - Video file with defects and log of VDR (Fixed mistake)
In-Reply-To: <443E39AD.000007.26249@mfront8.yandex.ru>
References: <443B5DBD.000003.21811@webmail9.yandex.ru> <200604130017.22399.stefan@lucke.in-berlin.de> <443E39AD.000007.26249@mfront8.yandex.ru>
Message-ID: <200604132204.44321.stefan@lucke.in-berlin.de>

On Donnerstag 13 April 2006 13:44, jonis2006 wrote:
> >On Dienstag 11 April 2006 09:41, jonis2006 wrote:
> >> Hello !
> >> Sorry I mistake URL of the file in a previous message:
> >> http://vm22.on.ufanet.ru/002.vdr
> >
> >Thanks for the file.
> >

[snip]

> 
> I tried ARGB, but picture is unchanged, problem still persist. Maybe solution is to take some MPlayer code to use it in SoftDevice ?

No I don't like this idea.
I think I'm on the way to provide a solution. Color information of
your example is not frame based, it is field based. So we have
to take the first chroma line for luma lines 0 & 2 and the second
chroma line for luma lines 1 & 3.  Some of my samples look better
when field based chroma yv12_yuy2 converter is used.
I did my test in a modified xv-out method, the is using YUY2 format
instead of YV12. Attached you'll find my diff for utils.[ch]  and
video_dfb.c  which is in C only (no mmx opt. yet).

Can you try this ?

-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: field-based-chroma-01.diff
Type: text/x-diff
Size: 6970 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060413/3dfbd4da/attachment.diff>

From jonis2006 at yandex.ru  Fri Apr 14 13:17:05 2006
From: jonis2006 at yandex.ru (jonis2006)
Date: Fri, 14 Apr 2006 15:17:05 +0400 (MSD)
Subject: [Softdevice-devel] Packed color problem - Video file with defects and log of VDR (Fixed mistake)
In-Reply-To: <200604132204.44321.stefan@lucke.in-berlin.de>
References: <443B5DBD.000003.21811@webmail9.yandex.ru> <200604130017.22399.stefan@lucke.in-berlin.de> <443E39AD.000007.26249@mfront8.yandex.ru> <200604132204.44321.stefan@lucke.in-berlin.de>
Message-ID: <443F84B1.000001.11336@camay.yandex.ru>

>On Donnerstag 13 April 2006 13:44, jonis2006 wrote:
>> >On Dienstag 11 April 2006 09:41, jonis2006 wrote:
>> >> Hello !
>> >> Sorry I mistake URL of the file in a previous message:
>> >> http://vm22.on.ufanet.ru/002.vdr
>> >
>> >Thanks for the file.
>> >
>
>[snip]
>
>> 
>> I tried ARGB, but picture is unchanged, problem still persist. Maybe solution is to take some MPlayer code to use it in SoftDevice ?
>
>No I don't like this idea.
>I think I'm on the way to provide a solution. Color information of
>your example is not frame based, it is field based. So we have
>to take the first chroma line for luma lines 0 & 2 and the second
>chroma line for luma lines 1 & 3.  Some of my samples look better
>when field based chroma yv12_yuy2 converter is used.
>I did my test in a modified xv-out method, the is using YUY2 format
>instead of YV12. Attached you'll find my diff for utils.[ch]  and
>video_dfb.c  which is in C only (no mmx opt. yet).
>
>Can you try this ?

Hello !
I test it ! All ok ! Picture and colors displaying properly ! 
Thanks !
With best regards.
AgentX


From stefan at lucke.in-berlin.de  Fri Apr 14 23:27:29 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 14 Apr 2006 23:27:29 +0200
Subject: [Softdevice-devel] [PATCH] upmix mono to stereo (to be audible via SPDIF)
In-Reply-To: <443DF772.9060900@users.sourceforge.net>
References: <4439A07D.4060900@users.sourceforge.net> <200604122357.51664.stefan@lucke.in-berlin.de> <443DF772.9060900@users.sourceforge.net>
Message-ID: <200604142327.29217.stefan@lucke.in-berlin.de>

On Donnerstag 13 April 2006 09:02, Lucian Muresan wrote:
> Stefan Lucke wrote:
> > On Mittwoch 12 April 2006 01:39, Lucian Muresan wrote:
> [..]
> > 
> >> +  if (Length > AVCODEC_MAX_AUDIO_FRAME_SIZE/2) {
> >> +     // in this unlikely case, the buffer should be increased
> >> +     BUFDEB(
> >> +       "cAudioStreamDecoder::UpmixMono: reallocating too small buffer (%d) to %d\n",
> >> +       AVCODEC_MAX_AUDIO_FRAME_SIZE, 2*Length );
> >> +     samples = (uint8_t *)realloc(samples, 2*Length);
> > 
> > So in case realloc fails, you'll destroy your reference to an already
> > allocated buffer (before: samples != NULL, after: samples == NULL)
> 
> If that would happen, I'm allocating it again few lines below to the
> original size of AVCODEC_MAX_AUDIO_FRAME_SIZE, but if it would occur
> indeed, the whole thing would repeat itself, so you're right it would be
> ugly.
> I'm just wondering if it _really_ would happen. From the debugging I've
> done when trying out my patch I've seen that the length of the
> audiosamples is actually 2304 (or something like that) for mono streams,
> and exactly double for stereo, and both figures are really far, far away
> from AVCODEC_MAX_AUDIO_FRAME_SIZE which is 192000.
> 
> > I would prefer the first version with extension that our initial buffer
> > is allocated with 2*AVCODEC_MAX_AUDIO_FRAME_SIZE .
> 
> Of course, memory allocation should happen preferably only once. You
> know your project and ffmpeg internals far better and can judge if
> 2*AVCODEC_MAX_AUDIO_FRAME_SIZE is not too large. On the other hand, is
> there some other place where the length of the sample itself is set? I
> mean, wasn't an overflow possible without my UpmixMono patch, is it
> taken care of it dynamically already and checked that the lenght is
> never larger, or was it just assumed that AVCODEC_MAX_AUDIO_FRAME_SIZE
> will be enough due to its large value?

It seems be an rather arbitrary value. I checked my ffmpeg source,
but noone really cares about this. There are several places with 
allocations of this size and only _one_ check, where it gets checked
and limited to half size of AVCODEC_MAX_AUDIO_FRAME_SIZE :-) .

> If so, I wouldn't fear about mono 
> samples too much, the risk would be the same, unless the other
> assumption is true and that chunk length is checked against
> AVCODEC_MAX_AUDIO_FRAME_SIZE right at the place where it is fed to
> softdevice. Don't know if it's even possible to have an influence on
> that dynamic length (or is it dynamic, who sets it?)...

Applied your patch (1st version) with some small modifications.


-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Fri Apr 14 23:33:04 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 14 Apr 2006 23:33:04 +0200
Subject: [Softdevice-devel] From todays changelog
Message-ID: <200604142333.04413.stefan@lucke.in-berlin.de>

Hi,

as there are only a few persons on cvs list (15 vs. 67)
there is somthing new in cvs. Prehaps someone is interested in testing:

2006-04-14:
   - Expand top/bottom line and left/right coloumns (from vdr-portal).
   - Zoom feature, zoomed area may be shifted around.
   - yv12 -> yuy2 converter for field based chroma.
   - remember interlaced mode of current frame.
   - some preparations for some more XvImage formats (not yet selectable).
   - Restricted OSD alpha blend option to XV and VIDIX out.
   - started some documentation of our various OSD options.
   - applied patch for mono upmix from Lucian Muresan


-- 
Stefan Lucke


From admin at berlios.de  Sat Apr 15 02:17:28 2006
From: admin at berlios.de (admin at berlios.de)
Date: Fri, 14 Apr 2006 16:17:28 -0800 (AKDT)
Subject: [Softdevice-devel] [Bug #7147] cvs - expand top/bottom lines
Message-ID: <200604150017.k3F0HSAA029322@unicorn.berlios.de>

Bug #7147, was updated on 2006-Apr-14 16:17
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: None
Status: Open
Resolution: None
Bug Group: None
Priority: 5
Submitted by: daliman
Assigned to : none
Summary: cvs - expand top/bottom lines

Details: Ich bin mir nicht sicher ob man das Folgende als Fehler bezeichnen kann, aber ich kann es ja versuchen.

Mit diesem Wert wird der Bildschirm nach oben erweitert, wobei die untere "Kante" fast an der selben Stelle bleibt. Bei manchen Sendern ist die obere Bildschirmkante bereits bei einem Wert von 14 erreicht. Wenn man die Postition, wie z.B. mit ZoomCenter(x,y) jetzt korrigieren k?nnte, also nach unten verschieben, dann k?nnte man weiter bis 25 erh?hen  und eine Bildschirmf?llende Ausgabe erreichen. Welche Variablen m?ssten dazu ver?ndert werden?
   

For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=7147&group_id=2051


From admin at berlios.de  Sat Apr 15 02:57:40 2006
From: admin at berlios.de (admin at berlios.de)
Date: Sat, 15 Apr 2006 02:57:40 +0200 (CEST)
Subject: [Softdevice-devel] [Bug #7147] cvs - expand top/bottom lines
Message-ID: <200604150057.k3F0ve8T018321@unicorn.berlios.de>

Bug #7147, was updated on 2006-Apr-15 02:17
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: None
Status: Open
Resolution: None
Bug Group: None
Priority: 5
Submitted by: daliman
Assigned to : none
Summary: cvs - expand top/bottom lines

Details: Ich bin mir nicht sicher ob man das Folgende als Fehler bezeichnen kann, aber ich kann es ja versuchen.

Mit diesem Wert wird der Bildschirm nach oben erweitert, wobei die untere "Kante" fast an der selben Stelle bleibt. Bei manchen Sendern ist die obere Bildschirmkante bereits bei einem Wert von 14 erreicht. Wenn man die Postition, wie z.B. mit ZoomCenter(x,y) jetzt korrigieren k?nnte, also nach unten verschieben, dann k?nnte man weiter bis 25 erh?hen  und eine Bildschirmf?llende Ausgabe erreichen. Welche Variablen m?ssten dazu ver?ndert werden?
   

Follow-Ups:

Date: 2006-Apr-15 02:57
By: lucke

Comment:
Die beiden Kanten sollten sich gleichzeitig und im gleichen Umfang verschieben. 
Wurde eine make clean in softdevice-verzeichnis ausgef?hrt (falls cvs update gemacht wurde)?
Welche Ausgabemethode wird verwendet?
Ich habe nur mit xv getestet.
-------------------------------------------------------

For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=7147&group_id=2051


From stefan at lucke.in-berlin.de  Sat Apr 15 11:16:48 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 15 Apr 2006 11:16:48 +0200
Subject: [Softdevice-devel] Joining the club of "Caught signal 11 .." users
Message-ID: <200604151116.48248.stefan@lucke.in-berlin.de>

Hi,

with a gentoo 2006.0 system and gcc 3.4.4
g++ (GCC) 3.4.4 (Gentoo 3.4.4-r1, ssp-3.4.4-1.0, pie-8.7.8)

configuring with --enable-multi --enable-debug --enable-trace ,
compilations result in triggering an internal compiler bug:
http://bugs.gentoo.org/show_bug.cgi?id=130001

With and without --enable-multi I got sig11 at various times when
starting vdr with softdevice plugin.

my directfb version is cvs from yesterday.
hardware for sig11 is a G550 on aopen celeron-m board.

dfbinfo works most of the time, but sometimes it did not
finish reporting.

Error message from softdevice:
[dfb] Set DLBM_TRIPLE for layer [Matrox CRTC2 Layer]
[dfb] DLOP_FIELD_PARITY supported by layer [Matrox CRTC2 Layer]
[dfb] 1 draw frame (736 x 576) Y: 736 UV: 368
[dfb] (re)configuring Videolayer to 736 x 576 (720x576)
[dfb] creating new surface (stretchBlit)
[surface capabilities] videoSurface: videoonly
[dfb] (re)configured 0x00200806
[dfb] 2 draw frame (736 x 576) Y: 736 UV: 368
xx3
xx4
(!) [10775:    0.197] --> Caught signal 11 (at 0x4, invalid address) <--
(!) [10769:    0.198] --> Caught signal 11 (at 0xb565d54e, invalid address) <--
(!) Direct/Thread: Killing 'Fusion Dispatch' (10776)!
Killed

My question is: which gcc version use other softdevice / directfb / gentoo
users in a stable enviroment ?

-- 
Stefan Lucke


From timmytf at deathrow.vistech.net  Sun Apr 16 17:00:04 2006
From: timmytf at deathrow.vistech.net (The Fox)
Date: Sun, 16 Apr 2006 21:00:04 +0600
Subject: [Softdevice-devel] Sound crashes :(
Message-ID: <44425BF4.6080004@deathrow.vistech.net>

My softdevice crashes on 44kHz channels, 48kHz channels is ok.


Console:
_____________________________________________________________________________________________________
vdr: pcm_mmap.c:108: snd_pcm_mmap_write_areas: Assertion
`snd_pcm_mmap_playback_avail(pcm) >= size' failed.
(!) [ 6088:    0.000] --> Caught signal 6 (unknown origin) <--
(!) [ 6087:    0.145] --> Caught signal 11 (at 0xb34145be, invalid
address) <--
./vdr.sh: line 11:  5469 Killed                  ./vdr -P"softdevice -vo
xv::" -Pfemon -Ptext2skin -Pchannelscan -Pmp3 --shutdown=./stop.sh
[root at localhost vdr-1.3.38]#


What to do ?




From inssomniak at mountaincable.net  Mon Apr 17 03:28:37 2006
From: inssomniak at mountaincable.net (Dave)
Date: Sun, 16 Apr 2006 21:28:37 -0400
Subject: [Softdevice-devel] Re: [directfb-users] Joining the club of "Caught signal 11 .." users
In-Reply-To: <200604151116.48248.stefan@lucke.in-berlin.de>
References: <200604151116.48248.stefan@lucke.in-berlin.de>
Message-ID: <4442EF45.3050209@mountaincable.net>

Im using:

gcc version 3.4.5 (Gentoo 3.4.5, ssp-3.4.5-1.0, pie-8.7.9)
Softdevice CVS and DirectFB CVS probably from a few weeks ago now.

Very stable here. But didnt compile with --enable-debug or --enable-trace


Stefan Lucke wrote:

>Hi,
>
>with a gentoo 2006.0 system and gcc 3.4.4
>g++ (GCC) 3.4.4 (Gentoo 3.4.4-r1, ssp-3.4.4-1.0, pie-8.7.8)
>
>configuring with --enable-multi --enable-debug --enable-trace ,
>compilations result in triggering an internal compiler bug:
>http://bugs.gentoo.org/show_bug.cgi?id=130001
>
>With and without --enable-multi I got sig11 at various times when
>starting vdr with softdevice plugin.
>
>my directfb version is cvs from yesterday.
>hardware for sig11 is a G550 on aopen celeron-m board.
>
>dfbinfo works most of the time, but sometimes it did not
>finish reporting.
>
>Error message from softdevice:
>[dfb] Set DLBM_TRIPLE for layer [Matrox CRTC2 Layer]
>[dfb] DLOP_FIELD_PARITY supported by layer [Matrox CRTC2 Layer]
>[dfb] 1 draw frame (736 x 576) Y: 736 UV: 368
>[dfb] (re)configuring Videolayer to 736 x 576 (720x576)
>[dfb] creating new surface (stretchBlit)
>[surface capabilities] videoSurface: videoonly
>[dfb] (re)configured 0x00200806
>[dfb] 2 draw frame (736 x 576) Y: 736 UV: 368
>xx3
>xx4
>(!) [10775:    0.197] --> Caught signal 11 (at 0x4, invalid address) <--
>(!) [10769:    0.198] --> Caught signal 11 (at 0xb565d54e, invalid address) <--
>(!) Direct/Thread: Killing 'Fusion Dispatch' (10776)!
>Killed
>
>My question is: which gcc version use other softdevice / directfb / gentoo
>users in a stable enviroment ?
>
>  
>


From inssomniak at mountaincable.net  Mon Apr 17 03:30:28 2006
From: inssomniak at mountaincable.net (Dave)
Date: Sun, 16 Apr 2006 21:30:28 -0400
Subject: [Softdevice-devel] From todays changelog
In-Reply-To: <200604142333.04413.stefan@lucke.in-berlin.de>
References: <200604142333.04413.stefan@lucke.in-berlin.de>
Message-ID: <4442EFB4.2040203@mountaincable.net>

I will get right on this :)

Stefan Lucke wrote:

>Hi,
>
>as there are only a few persons on cvs list (15 vs. 67)
>there is somthing new in cvs. Prehaps someone is interested in testing:
>
>2006-04-14:
>   - Expand top/bottom line and left/right coloumns (from vdr-portal).
>   - Zoom feature, zoomed area may be shifted around.
>   - yv12 -> yuy2 converter for field based chroma.
>   - remember interlaced mode of current frame.
>   - some preparations for some more XvImage formats (not yet selectable).
>   - Restricted OSD alpha blend option to XV and VIDIX out.
>   - started some documentation of our various OSD options.
>   - applied patch for mono upmix from Lucian Muresan
>
>
>  
>


From inssomniak at mountaincable.net  Mon Apr 17 03:30:28 2006
From: inssomniak at mountaincable.net (Dave)
Date: Sun, 16 Apr 2006 21:30:28 -0400
Subject: [Softdevice-devel] From todays changelog
In-Reply-To: <200604142333.04413.stefan@lucke.in-berlin.de>
References: <200604142333.04413.stefan@lucke.in-berlin.de>
Message-ID: <4442EFB4.2040203@mountaincable.net>

I will get right on this :)

Stefan Lucke wrote:

>Hi,
>
>as there are only a few persons on cvs list (15 vs. 67)
>there is somthing new in cvs. Prehaps someone is interested in testing:
>
>2006-04-14:
>   - Expand top/bottom line and left/right coloumns (from vdr-portal).
>   - Zoom feature, zoomed area may be shifted around.
>   - yv12 -> yuy2 converter for field based chroma.
>   - remember interlaced mode of current frame.
>   - some preparations for some more XvImage formats (not yet selectable).
>   - Restricted OSD alpha blend option to XV and VIDIX out.
>   - started some documentation of our various OSD options.
>   - applied patch for mono upmix from Lucian Muresan
>
>
>  
>


From laz at club-burniston.co.uk  Mon Apr 17 15:06:11 2006
From: laz at club-burniston.co.uk (Laz)
Date: Mon, 17 Apr 2006 14:06:11 +0100
Subject: [Softdevice-devel] Via CLE266 hardware MPEG decoding...
Message-ID: <200604171406.12101.laz@club-burniston.co.uk>

I know this has been mentioned several times in the past but I don't think 
anyone has made any progress in getting hardware MPEG decoding on the Via 
CLE266 and related chips from DirectFB apps. I have a Via Epia system running 
vdr with softdevice using DirectFB TV-out output, and this works really well 
but it is just on the limit of what the CPU can do when it is decoding the 
MPEG2 stream in software, so I get a few jerks and A-V sync isn't as good as 
it should be. I've started looking into this again now...

Currently, softdevice uses libavcodec to do the actual MPEG2 decoding. What I 
was hoping for was a simple slot-in solution where I just pass the relevant 
MPEG2 data to a different library, retrieve the decoded frames, and leave 
softdevice to display them using DirectFB.

Here is a summary of what I've found and my understanding:

libddmpeg: the original one from Via and the one reverse engineered by Ivor 
Hewitt. I believe that both of these rely on X and so aren't as helpful as 
I'd like them to be for this instance.

VeXP-VIAXine: not really delved into this but I think this requires X too.

cle266mp-plugin: This is an output plugin for mplayer. Still in the process of 
studying this. Not sure whether it requires X or not, i.e. whether this 
plugin displays the video as well as decoding it.

mtest: not fully built this yet because it requires a patch to DirectFB. It 
seems to need /dev/cle266vgaio which linux-viafb from DirectFB doesn't 
provide. (Seen mention of using the cle266vgaio module at the same time as 
the viafb module: not looked into this yet.) This one only depends on 
DirectFB but only decodes video and not audio.

All of the above (except mtest) are tied into X so mtest is probably the 
easiest starting point. Nothing that I've found does _just_ decoding: they 
all decode and display the images.


From M.Wache at gmx.net  Mon Apr 17 21:42:46 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 17 Apr 2006 21:42:46 +0200
Subject: [Softdevice-devel] Sound crashes :(
In-Reply-To: <44425BF4.6080004@deathrow.vistech.net>
References: <44425BF4.6080004@deathrow.vistech.net>
Message-ID: <4443EFB6.5090508@gmx.net>

The Fox schrieb:
> My softdevice crashes on 44kHz channels, 48kHz channels is ok.
> 
> 
> Console:
> _____________________________________________________________________________________________________
> 
> vdr: pcm_mmap.c:108: snd_pcm_mmap_write_areas: Assertion
> `snd_pcm_mmap_playback_avail(pcm) >= size' failed.
> (!) [ 6088:    0.000] --> Caught signal 6 (unknown origin) <--
> (!) [ 6087:    0.145] --> Caught signal 11 (at 0xb34145be, invalid
> address) <--
> ./vdr.sh: line 11:  5469 Killed                  ./vdr -P"softdevice -vo
> xv::" -Pfemon -Ptext2skin -Pchannelscan -Pmp3 --shutdown=./stop.sh
> [root at localhost vdr-1.3.38]#
> 
> 
> What to do ?
> 
Try upgrading your Alsa installation(what's your alsa version anyway?),
to me this looks like a bug in Alsa. I also checked the alsa source in
pcm_mmap.c, I don't see how a bug in the softdevice could cause that
assertion failure.

The softdevice always plays the audio in the same samplerate it receives
the audio. If you use the default alsa device and your hardware can't
playback the samplerate alsa should automatically resample the audio to
a samplerate which is supported by your hardware. I guess that this
somehow fails on your system.

Bye,
Martin


From Malcolm.Caldwell at cdu.edu.au  Tue Apr 18 02:14:05 2006
From: Malcolm.Caldwell at cdu.edu.au (Malcolm Caldwell)
Date: Tue, 18 Apr 2006 09:44:05 +0930
Subject: [Softdevice-devel] From todays changelog
In-Reply-To: <200604142333.04413.stefan@lucke.in-berlin.de>
References: <200604142333.04413.stefan@lucke.in-berlin.de>
Message-ID: <1145319245.3565.10.camel@localhost.localdomain>

OK,

Since I am one of those not on the cvs list...

Has there been any work on the MGA TV non-field based StretchBlit bug?
If not is anyone working on it?

This bug *severely* affects the effectiveness of softdevice for me.  I
have a 4:3 TV.  This bug means:
      * I have to view all my channels as centre cut instead of
        letterboxed.  I would prefer not to loose the sides of every
        programme I watch
      * softplay's output is 'broken' (because hardly any material is at
        a resolution the same as softdevices output)
      * ntsc material is 'broken' (I know there are framerate problems
        as well, but I can put up with the bad frame rate, but not the
        wobbly pictures)

Basically, this bug means that MGA TV-Out softdevice is very limited.

Now, I may get a chance to look at the code sometime, but I wanted to
know if anyone is working on it at the moment.  (I have had a quick look
and so far it is not obvious how the code works...)

On Fri, 2006-04-14 at 23:33 +0200, Stefan Lucke wrote:
> Hi,
> 
> as there are only a few persons on cvs list (15 vs. 67)
> there is somthing new in cvs. Prehaps someone is interested in testing:
> 
> 2006-04-14:
>    - Expand top/bottom line and left/right coloumns (from vdr-portal).
>    - Zoom feature, zoomed area may be shifted around.
>    - yv12 -> yuy2 converter for field based chroma.
>    - remember interlaced mode of current frame.
>    - some preparations for some more XvImage formats (not yet selectable).
>    - Restricted OSD alpha blend option to XV and VIDIX out.
>    - started some documentation of our various OSD options.
>    - applied patch for mono upmix from Lucian Muresan
> 
> 


From nicolas at huillard.net  Wed Apr 19 15:54:05 2006
From: nicolas at huillard.net (Nicolas Huillard)
Date: Wed, 19 Apr 2006 15:54:05 +0200
Subject: [Softdevice-devel] Via CLE266 hardware MPEG decoding...
In-Reply-To: <200604171406.12101.laz@club-burniston.co.uk>
References: <200604171406.12101.laz@club-burniston.co.uk>
Message-ID: <444640FD.4080408@huillard.net>

Laz a ?crit :
> I know this has been mentioned several times in the past but I don't think 
> anyone has made any progress in getting hardware MPEG decoding on the Via 
> CLE266 and related chips from DirectFB apps. I have a Via Epia system running 
> vdr with softdevice using DirectFB TV-out output, and this works really well 
> but it is just on the limit of what the CPU can do when it is decoding the 
> MPEG2 stream in software, so I get a few jerks and A-V sync isn't as good as 
> it should be. I've started looking into this again now...

It's really nice to see that there is still interest in this solution !
Since I still didn't upgrade from vdr 1.3.33 / softdevice 0.2.0, I can't
help very much with this, but I can still recall ancient threads, test,
etc...

...
> mtest: not fully built this yet because it requires a patch to DirectFB. It 
> seems to need /dev/cle266vgaio which linux-viafb from DirectFB doesn't 
> provide. (Seen mention of using the cle266vgaio module at the same time as 
> the viafb module: not looked into this yet.) This one only depends on 
> DirectFB but only decodes video and not audio.

cle266vgaio is an old kernel modules which should provide sufficient
interface to the CLE266, when using the VESA frame-buffer kernel module
with DirectFB. It should be replaced by the newer viafb from the
DirectFB CVS (which comes from... see HISTORY file).
I just searched through my old code and tests and found the libsoftmpeg
library, which came (early 2004) with a VDR plugin, in order to provide
something like softdevice does. This library was once patched to allow
hardware MPEG decoding. I still have the whole code there, and found a
reference to "mtest", without any "mtest.*" file.
Maybe I have there a useful library that you could work from ? I think
the core is in the following directory :

  2467 Feb  6  2004 libcle266mpeg/GetFBOffset.patch
  1658 Feb  6  2004 libcle266mpeg/GetFBOffsetDFB++.patch
  1108 Feb  6  2004 libcle266mpeg/README.txt
  5567 Mar 23  2004 libcle266mpeg/cle266mpegdec.c
  1786 Mar 20  2004 libcle266mpeg/cle266mpegdec.h
  5610 Mar 21  2004 libcle266mpeg/debug.c
   574 Feb  6  2004 libcle266mpeg/debug.h
  7736 Mar 21  2004 libcle266mpeg/decoder.c
  4619 Feb  6  2004 libcle266mpeg/decoder.h
  4109 Mar 27  2004 libcle266mpeg/hwdec.c
   874 Feb  6  2004 libcle266mpeg/hwdec.h
 10017 Feb  6  2004 libcle266mpeg/mpeg2defs.h
 10476 Feb  6  2004 libcle266mpeg/parser.c
  3556 Feb  6  2004 libcle266mpeg/parser.h
 16700 Feb  6  2004 libcle266mpeg/scanner.c
  5640 Feb  6  2004 libcle266mpeg/scanner.h

I can send you the whole stuff via PM, if needed.

> All of the above (except mtest) are tied into X so mtest is probably the 
> easiest starting point. Nothing that I've found does _just_ decoding: they 
> all decode and display the images.

Just saw a reference inside a file above :

 * This code has no video output dependencies. The user code must
 * set up a framebuffer for video display, and 4x YUV420 format
 * buffers within video memory.
 *
 * A user code must implement the 'blah' function which
 * is called whenever the picture size changes after a
 * sequence header. This should rescale the video output
 * as appropriate.

ie. : the decoder outputs the decoded chunks in video memory, but you
still have a chance to get them back (rescale, convert, grab, etc.
That's what Xine must do to run it's post-process plug-ins).

...
> Has anyone made any more progress with this or am I starting from scratch? 
> Ultimately, the best route would probably be to incorporate hardware decoding 
> into ffmpeg or similar but, for now, I'd just be happy to get it working from 
> softdevice!

There are mainly two possible routes : the great and beautiful one,
where you integrate all needed functionnaly inside one of ffmpeg,
libavcodec, or similar library, remove X dependencies, etc. And the fast
and hackish one, where you get small library parts, pack them together
and have a working, albeit uncomplete thingy. That's how the viafb
kernel module evolved... Once basic support is available, will come the
time to write beautiful code...

-- 
NH


From laz at club-burniston.co.uk  Wed Apr 19 16:39:59 2006
From: laz at club-burniston.co.uk (Laz)
Date: Wed, 19 Apr 2006 15:39:59 +0100
Subject: [Softdevice-devel] Via CLE266 hardware MPEG decoding...
In-Reply-To: <444640FD.4080408@huillard.net>
References: <200604171406.12101.laz@club-burniston.co.uk> <444640FD.4080408@huillard.net>
Message-ID: <200604191540.00483.laz@club-burniston.co.uk>

On Wednesday 19 Apr 2006 14:54, Nicolas Huillard wrote:
> Laz a ?crit :
> > I know this has been mentioned several times in the past but I don't
> > think anyone has made any progress in getting hardware MPEG decoding
> > on the Via CLE266 and related chips from DirectFB apps. I have a Via
> > Epia system running vdr with softdevice using DirectFB TV-out output,
> > and this works really well but it is just on the limit of what the
> > CPU can do when it is decoding the MPEG2 stream in software, so I get
> > a few jerks and A-V sync isn't as good as it should be. I've started
> > looking into this again now...
>
> It's really nice to see that there is still interest in this solution !
> Since I still didn't upgrade from vdr 1.3.33 / softdevice 0.2.0, I
> can't help very much with this, but I can still recall ancient threads,
> test, etc...
>
> ...

It seems to be something which gets mentioned every now and then  but 
nothing ever seems to come of it!

> > mtest: not fully built this yet because it requires a patch to
> > DirectFB. It seems to need /dev/cle266vgaio which linux-viafb from
> > DirectFB doesn't provide. (Seen mention of using the cle266vgaio
> > module at the same time as the viafb module: not looked into this
> > yet.) This one only depends on DirectFB but only decodes video and
> > not audio.
>
> cle266vgaio is an old kernel modules which should provide sufficient
> interface to the CLE266, when using the VESA frame-buffer kernel module
> with DirectFB. It should be replaced by the newer viafb from the
> DirectFB CVS (which comes from... see HISTORY file).

Yes. Emails from Mark Adams suggests that I can mmap /dev/fb0 from viafb 
in the way it would have been done with /dev/cle266vgaio. I have built 
mtest so that it uses /dev/fb0 rather than /dev/cle266vgaio but haven't 
managed to get it to work yet: it sits in a loop, waiting for the decoder 
to become ready. I need to convince myself that it is checking the 
correct register for this!

> I just searched through my old code and tests and found the libsoftmpeg
> library, which came (early 2004) with a VDR plugin, in order to provide
> something like softdevice does. This library was once patched to allow
> hardware MPEG decoding. I still have the whole code there, and found a
> reference to "mtest", without any "mtest.*" file.
> Maybe I have there a useful library that you could work from ? I think
> the core is in the following directory :
>
>   2467 Feb  6  2004 libcle266mpeg/GetFBOffset.patch
>   1658 Feb  6  2004 libcle266mpeg/GetFBOffsetDFB++.patch
>   1108 Feb  6  2004 libcle266mpeg/README.txt
>   5567 Mar 23  2004 libcle266mpeg/cle266mpegdec.c
>   1786 Mar 20  2004 libcle266mpeg/cle266mpegdec.h
>   5610 Mar 21  2004 libcle266mpeg/debug.c
>    574 Feb  6  2004 libcle266mpeg/debug.h
>   7736 Mar 21  2004 libcle266mpeg/decoder.c
>   4619 Feb  6  2004 libcle266mpeg/decoder.h
>   4109 Mar 27  2004 libcle266mpeg/hwdec.c
>    874 Feb  6  2004 libcle266mpeg/hwdec.h
>  10017 Feb  6  2004 libcle266mpeg/mpeg2defs.h
>  10476 Feb  6  2004 libcle266mpeg/parser.c
>   3556 Feb  6  2004 libcle266mpeg/parser.h
>  16700 Feb  6  2004 libcle266mpeg/scanner.c
>   5640 Feb  6  2004 libcle266mpeg/scanner.h
>
> I can send you the whole stuff via PM, if needed.

That would certainly be helpful: please send it to this email address. I 
am currently pooling together as much code as I can which may be 
relevant. I'm starting to see some similarities between it, too!

;)

I think the information is there it just needs someone to pull it all 
together!

> > All of the above (except mtest) are tied into X so mtest is probably
> > the easiest starting point. Nothing that I've found does _just_
> > decoding: they all decode and display the images.
>
> Just saw a reference inside a file above :
>
>  * This code has no video output dependencies. The user code must
>  * set up a framebuffer for video display, and 4x YUV420 format
>  * buffers within video memory.
>  *
>  * A user code must implement the 'blah' function which
>  * is called whenever the picture size changes after a
>  * sequence header. This should rescale the video output
>  * as appropriate.
>
> ie. : the decoder outputs the decoded chunks in video memory, but you
> still have a chance to get them back (rescale, convert, grab, etc.
> That's what Xine must do to run it's post-process plug-ins).

That would be the best bet for a stand-alone library, i.e. send the 
decoder data and read the decoded frames back out again, rather than 
flipping the buffer directly. I was hoping to just replace the call to 
avcodec_decode_video() in softdevice, rather than having to mess about 
with the DirectFB code for adding as OSD layer, etc.!

> > Has anyone made any more progress with this or am I starting from
> > scratch? Ultimately, the best route would probably be to incorporate
> > hardware decoding into ffmpeg or similar but, for now, I'd just be
> > happy to get it working from softdevice!
>
> There are mainly two possible routes : the great and beautiful one,
> where you integrate all needed functionnaly inside one of ffmpeg,
> libavcodec, or similar library, remove X dependencies, etc. And the
> fast and hackish one, where you get small library parts, pack them
> together and have a working, albeit uncomplete thingy. That's how the
> viafb kernel module evolved... Once basic support is available, will
> come the time to write beautiful code...

Indeed. It seems that most of the effort ended up going into the 
unichrome / openchrome projects rather than creating a nice, 
self-contained library!

Cheers,

Laz


From stefan at lucke.in-berlin.de  Thu Apr 20 07:44:08 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 20 Apr 2006 07:44:08 +0200
Subject: [Softdevice-devel] Re: [directfb-users] Joining the club of "Caught signal 11 .." users
In-Reply-To: <4442EF45.3050209@mountaincable.net>
References: <200604151116.48248.stefan@lucke.in-berlin.de> <4442EF45.3050209@mountaincable.net>
Message-ID: <200604200744.09016.stefan@lucke.in-berlin.de>

On Montag 17 April 2006 03:28, Dave wrote:
> Im using:
> 
> gcc version 3.4.5 (Gentoo 3.4.5, ssp-3.4.5-1.0, pie-8.7.9)
> Softdevice CVS and DirectFB CVS probably from a few weeks ago now.
> 
> Very stable here. But didnt compile with --enable-debug or --enable-trace

Thanks for your reply,
but when configured with --enable-debug I had to set optimize level
to -O2 for a successful compile.

Results are very strange. I thought a fprintf to stderr is unbuffered,
but that seem to be no longer true, as I see your SetParms() method
beeing called when _not_ all messages from constructor are printed.

With TV-out enabled "-vo dfb:mgatv:" it stil failes. With vga-out it
sometimes works. Even dfbinfo terminates with a segfault.

> 
> 
> Stefan Lucke wrote:
> 
> >Hi,
> >
> >with a gentoo 2006.0 system and gcc 3.4.4
> >g++ (GCC) 3.4.4 (Gentoo 3.4.4-r1, ssp-3.4.4-1.0, pie-8.7.8)
> >
> >configuring with --enable-multi --enable-debug --enable-trace ,
> >compilations result in triggering an internal compiler bug:
> >http://bugs.gentoo.org/show_bug.cgi?id=130001
> >
> >With and without --enable-multi I got sig11 at various times when
> >starting vdr with softdevice plugin.
> >
> >my directfb version is cvs from yesterday.
> >hardware for sig11 is a G550 on aopen celeron-m board.
> >
> >dfbinfo works most of the time, but sometimes it did not
> >finish reporting.
> >
> >Error message from softdevice:
> >[dfb] Set DLBM_TRIPLE for layer [Matrox CRTC2 Layer]
> >[dfb] DLOP_FIELD_PARITY supported by layer [Matrox CRTC2 Layer]
> >[dfb] 1 draw frame (736 x 576) Y: 736 UV: 368
> >[dfb] (re)configuring Videolayer to 736 x 576 (720x576)
> >[dfb] creating new surface (stretchBlit)
> >[surface capabilities] videoSurface: videoonly
> >[dfb] (re)configured 0x00200806
> >[dfb] 2 draw frame (736 x 576) Y: 736 UV: 368
> >xx3
> >xx4
> >(!) [10775:    0.197] --> Caught signal 11 (at 0x4, invalid address) <--
> >(!) [10769:    0.198] --> Caught signal 11 (at 0xb565d54e, invalid address) <--
> >(!) Direct/Thread: Killing 'Fusion Dispatch' (10776)!
> >Killed
> >
> >My question is: which gcc version use other softdevice / directfb / gentoo
> >users in a stable enviroment ?
> >
> >  
> >
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/softdevice-devel
> 

-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: dfbinfo-run-01.bz2
Type: application/x-bzip2
Size: 3878 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060420/710a3aae/attachment.bin>

From stefan at lucke.in-berlin.de  Thu Apr 20 07:55:57 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 20 Apr 2006 07:55:57 +0200
Subject: [Softdevice-devel] Re: [directfb-users] Joining the club of "Caught signal 11 .." users
In-Reply-To: <200604200744.09016.stefan@lucke.in-berlin.de>
References: <200604151116.48248.stefan@lucke.in-berlin.de> <4442EF45.3050209@mountaincable.net> <200604200744.09016.stefan@lucke.in-berlin.de>
Message-ID: <200604200755.57250.stefan@lucke.in-berlin.de>

On Donnerstag 20 April 2006 07:44, Stefan Lucke wrote:
> On Montag 17 April 2006 03:28, Dave wrote:
> > Im using:
> > 
> > gcc version 3.4.5 (Gentoo 3.4.5, ssp-3.4.5-1.0, pie-8.7.9)
> > Softdevice CVS and DirectFB CVS probably from a few weeks ago now.
> > 
> > Very stable here. But didnt compile with --enable-debug or --enable-trace
> 
> Thanks for your reply,
> but when configured with --enable-debug I had to set optimize level
> to -O2 for a successful compile.
> 
> Results are very strange. I thought a fprintf to stderr is unbuffered,
> but that seem to be no longer true, as I see your SetParms() method
> beeing called when _not_ all messages from constructor are printed.
> 
> With TV-out enabled "-vo dfb:mgatv:" it stil failes. With vga-out it
> sometimes works. Even dfbinfo terminates with a segfault.
> 

Damm, closeing mail window results in mail sent.

Wanted to add 2 other outputs too:
In dfb-run-03 we reach at least our YUV() method 
before initially reported happens.

> >(!) [10775:    0.197] --> Caught signal 11 (at 0x4, invalid address) <--
> >(!) [10769:    0.198] --> Caught signal 11 (at 0xb565d54e, invalid address) <--

But in dfb-run-01 we do an exit() because there is "No Videolayer". That should
never happen.

-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: dfb-run-01.bz2
Type: application/x-bzip2
Size: 1729 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060420/1661aa09/attachment.bin>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: dfb-run-03.bz2
Type: application/x-bzip2
Size: 4540 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060420/1661aa09/attachment-0001.bin>

From admin at berlios.de  Thu Apr 20 12:51:10 2006
From: admin at berlios.de (admin at berlios.de)
Date: Thu, 20 Apr 2006 12:51:10 +0200 (CEST)
Subject: [Softdevice-devel] [Bug #7202] Illegal instruction
Message-ID: <200604201051.k3KApAtM017496@unicorn.berlios.de>

Bug #7202, was updated on 2006-Apr-20 12:51
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: None
Status: Open
Resolution: None
Bug Group: None
Priority: 5
Submitted by: drakon
Assigned to : none
Summary: Illegal instruction

Details: Hallo!
Wenn das Programm auf einem Rechner dessen Prozessor kein MMX2 unterst?tzt kompiliert und ausgef?hrt wird kommt es zu diesem Fehler.
Das Problem habe ich hier beschrieben:

http://vdr-portal.de/board/thread.php?threadid=48118

For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=7202&group_id=2051


From stefan at lucke.in-berlin.de  Thu Apr 20 23:23:59 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 20 Apr 2006 23:23:59 +0200
Subject: [directfb-users] [Softdevice-devel] Re: Joining the club of "Caught signal 11 .." users
In-Reply-To: <9B345A8D-2A3D-44BA-A1A7-C5DE048DB61B@gmail.com>
References: <200604151116.48248.stefan@lucke.in-berlin.de> <200604200755.57250.stefan@lucke.in-berlin.de> <9B345A8D-2A3D-44BA-A1A7-C5DE048DB61B@gmail.com>
Message-ID: <200604202324.00071.stefan@lucke.in-berlin.de>

On Donnerstag 20 April 2006 17:33, Tom Bridgwater wrote:
> I have better luck using UDP for coherent debugging output.
> 
> In /etc/directfbrc add (192.168.1.100 is the machine where you watch  
> the log):
> log-udp=192.168.1.100:8088
> 
> On the machine where you watch the log, run:
> socat - udp4-listen:8088,fork
> 
> In your own program you can get your debugging in that same stream  
> using D_DEBUG macros instead of fprintf(stderr ...) or cerr<<
> http://www.directfb.org/wiki/index.php/Direct:Debug
> 

Thanks for the hint, I guess I have to consider this for future
debugging statements.

I found the bug, and it's a plain softdevice bug.
I copied vdr's setup.conf file from an existing vdr instance of mine.
In this setup, I'd set our OSD drawing mode to software alpha blending.
When this is set, constructor of cDFBVideoOut super class starts a thread
for refreshing which takes some action, even constructor of derived class
has not yet finished :-( .


> /TomB
> 
> On Apr 19, 2006, at 10:55 PM, Stefan Lucke wrote:
> 
> >> Results are very strange. I thought a fprintf to stderr is  
> >> unbuffered,
> >> but that seem to be no longer true, as I see your SetParms() method
> >> beeing called when _not_ all messages from constructor are printed.
> 
> 

-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Fri Apr 21 22:39:48 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 21 Apr 2006 22:39:48 +0200
Subject: [Softdevice-devel] Next release ?
Message-ID: <200604212239.48922.stefan@lucke.in-berlin.de>

Is there anything left for a new release 0.2.3 [beside some additional
text in README] ?

-- 
Stefan Lucke


From marko.makela at hut.fi  Fri Apr 21 23:06:15 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sat, 22 Apr 2006 00:06:15 +0300
Subject: [Softdevice-devel] Next release ?
In-Reply-To: <200604212239.48922.stefan@lucke.in-berlin.de>
References: <200604212239.48922.stefan@lucke.in-berlin.de>
Message-ID: <20060421210615.GC3548@localhost.localdomain>

On Fri, Apr 21, 2006 at 10:39:48PM +0200, Stefan Lucke wrote:
> Is there anything left for a new release 0.2.3 [beside some additional
> text in README] ?

I can suggest a few things:

* Disable the "Use StretchBlit" menu item when StretchBlit cannot be enabled.

* The pixel format YV12 has the blue and red channels mixed on DirectFB
MGA G450.  This has been so at least for a year.

* Consider replacing VDRVERSION and VDRVERSNUM with APIVERSION and APIVERSNUM.
Or perhaps defer that until VDR 1.4 is out.

	Marko


From stefan at lucke.in-berlin.de  Sat Apr 22 00:42:00 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 22 Apr 2006 00:42:00 +0200
Subject: [Softdevice-devel] Next release ?
In-Reply-To: <20060421210615.GC3548@localhost.localdomain>
References: <200604212239.48922.stefan@lucke.in-berlin.de> <20060421210615.GC3548@localhost.localdomain>
Message-ID: <200604220042.00621.stefan@lucke.in-berlin.de>

On Freitag 21 April 2006 23:06, Marko M?kel? wrote:
> On Fri, Apr 21, 2006 at 10:39:48PM +0200, Stefan Lucke wrote:
> > Is there anything left for a new release 0.2.3 [beside some additional
> > text in README] ?
> 
> I can suggest a few things:
> 
> * Disable the "Use StretchBlit" menu item when StretchBlit cannot be enabled.

When stretchblit isn't accelerated ?

> 
> * The pixel format YV12 has the blue and red channels mixed on DirectFB
> MGA G450.  This has been so at least for a year.

Do you mean mixed or swapped ?
If it (swapped: use I420 insteadof YV12) is an issue with G450 only, it 
should be fixed in directfb. YV12, planar 4:2:0 format should be the same
for all drivers. If it is not, we offer use of I420 ;-) .

If you meant mixed, in which way are they mixed ?

> 
> * Consider replacing VDRVERSION and VDRVERSNUM with APIVERSION and APIVERSNUM.
> Or perhaps defer that until VDR 1.4 is out.

Did not test vdr-1.3.47. Would be some bigger change, as I like to keep 
compatibility with older vdr versions. I still use in some situations vdr-1.2.1 .

Short test with vdr-1.3.47: configure runs and xv-out is still usable.

-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Sat Apr 22 11:11:57 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 22 Apr 2006 11:11:57 +0200
Subject: DirectFB downscaling (WAS: Re: [Softdevice-devel] From todays changelog)
Message-ID: <200604221111.57846.stefan@lucke.in-berlin.de>

On Dienstag 18 April 2006 02:14, Malcolm Caldwell wrote:
> OK,
> 
> Since I am one of those not on the cvs list...
> 
> Has there been any work on the MGA TV non-field based StretchBlit bug?
No.
> If not is anyone working on it?
No.

I think your are referring to this thread on directfb-users:
http://mail.directfb.org/pipermail/directfb-users/2005-October/000770.html

But before pushing that again on directfb lists, I have to test Ville's
modifications he suggested in this thread (long time ago too):

Or has anyone tried his patches from?
http://mail.directfb.org/pipermail/directfb-dev/2005-October/000846.html

There was low feedback on directfb-dev.

> 
> This bug *severely* affects the effectiveness of softdevice for me.  I
> have a 4:3 TV.  This bug means:
>       * I have to view all my channels as centre cut instead of
>         letterboxed.  I would prefer not to loose the sides of every
>         programme I watch

>       * softplay's output is 'broken' (because hardly any material is at
>         a resolution the same as softdevices output)

That's the part I do not understand even though softplay is 
Martin's baby. 

>       * ntsc material is 'broken' (I know there are framerate problems
>         as well, but I can put up with the bad frame rate, but not the
>         wobbly pictures)

I guess you want PAL/NTSC recognition on the fly. This should be
possible, even if we have to reinitialise directfb complete.

(@Martin: In that case I need the videoInitialized variable allways,
as state changes like: videoInitialized -> !videoInitialized -> videoInitialized)

The only drawback is that directfb only can PAL and NTSC. PAL60 is to my 
knowledge not possible. The difference is composite out. In NTSC mode
you need a real NTSC device. Usually PAL TVs can do some sort
of 60Hz mode (timing from NTSC, but color info on composite encoded
as PAL).

> 
> Basically, this bug means that MGA TV-Out softdevice is very limited.

Can agree to that. A few months ago when I recognized that issue,
it was a nogo argument for me too [ switching my main TV to 
softdevice :-( ]. It caused some frustration on me (ac3 solved but ..) .


The most annoying thing and most difficult to resolve is to my opinion:
16:9 downscaled on 4:3 TV.

> 
> Now, I may get a chance to look at the code sometime, but I wanted to
> know if anyone is working on it at the moment.  (I have had a quick look
> and so far it is not obvious how the code works...)
> 
> On Fri, 2006-04-14 at 23:33 +0200, Stefan Lucke wrote:
> > Hi,
> > 
> > as there are only a few persons on cvs list (15 vs. 67)
> > there is somthing new in cvs. Prehaps someone is interested in testing:
> > 
> > 2006-04-14:
> >    - Expand top/bottom line and left/right coloumns (from vdr-portal).
> >    - Zoom feature, zoomed area may be shifted around.
> >    - yv12 -> yuy2 converter for field based chroma.
> >    - remember interlaced mode of current frame.
> >    - some preparations for some more XvImage formats (not yet selectable).
> >    - Restricted OSD alpha blend option to XV and VIDIX out.
> >    - started some documentation of our various OSD options.
> >    - applied patch for mono upmix from Lucian Muresan
> > 
> > 

-- 
Stefan Lucke


From marko.makela at hut.fi  Sat Apr 22 18:22:14 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sat, 22 Apr 2006 19:22:14 +0300
Subject: [Softdevice-devel] Next release ?
In-Reply-To: <200604220042.00621.stefan@lucke.in-berlin.de>
References: <200604212239.48922.stefan@lucke.in-berlin.de> <20060421210615.GC3548@localhost.localdomain> <200604220042.00621.stefan@lucke.in-berlin.de>
Message-ID: <20060422162214.GB3489@localhost.localdomain>

On Sat, Apr 22, 2006 at 12:42:00AM +0200, Stefan Lucke wrote:
> > * Disable the "Use StretchBlit" menu item when StretchBlit cannot be enabled.
> 
> When stretchblit isn't accelerated ?

Maybe.  I don't know why, but when I try to enable StretchBlit on DirectFB
VGA (MGA G450), it will change back to disabled when I reopen the menu.
It'd be less confusing if the setting were hidden altogether.

> > * The pixel format YV12 has the blue and red channels mixed on DirectFB
> > MGA G450.  This has been so at least for a year.
> 
> Do you mean mixed or swapped ?

Probably swapped.  Red tones definitely become blue, but there wasn't much
blue on the screen when I tested, so I wasn't sure if blue tones would turn
red.

> If it (swapped: use I420 insteadof YV12) is an issue with G450 only, it 
> should be fixed in directfb. YV12, planar 4:2:0 format should be the same
> for all drivers. If it is not, we offer use of I420 ;-) .

I'm using DirectFB 0.9.24 or a slightly newer CVS snapshot.  However, I just
switched back to mgatv output, so I can't test this further.  (I figured out
that the monitor or the TV output didn't break when I hot-plugged cables
some time ago; my son just happened to turn the brightness to minimum.)
Anyway, I agree that this is a very minor issue, because I420 is the
preferred choice.

> Short test with vdr-1.3.47: configure runs and xv-out is still usable.

That's because VDRVERSION == APIVERSION.  The two will probably differ when
vdr 1.4 is released.  Then vdr would be loading plugins by APIVERSION.

	Marko


From marko.makela at hut.fi  Sat Apr 22 18:32:29 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sat, 22 Apr 2006 19:32:29 +0300
Subject: DirectFB downscaling (WAS: Re: [Softdevice-devel] From todays changelog)
In-Reply-To: <200604221111.57846.stefan@lucke.in-berlin.de>
References: <200604221111.57846.stefan@lucke.in-berlin.de>
Message-ID: <20060422163229.GC3489@localhost.localdomain>

On Sat, Apr 22, 2006 at 11:11:57AM +0200, Stefan Lucke wrote:
> The most annoying thing and most difficult to resolve is to my opinion:
> 16:9 downscaled on 4:3 TV.

FWIW, center-cut works pretty well for me.  There's not that much essential
information on the edges, but then again, I'm not watching movies.

The only problems are on channels that burn the subtitles on the video
stream rather than using DVB subtitles, which are scaled to actual 4:3
screen width.

That said, I'm happy to test any mgatv patches you come up with.

vdr -Psoftdevice -Psubtitles -Pdvd on a 14" monitor is the only TV in
our household since over a year, and it works perfectly.

	Marko


From Malcolm.Caldwell at cdu.edu.au  Sun Apr 23 15:39:15 2006
From: Malcolm.Caldwell at cdu.edu.au (Malcolm Caldwell)
Date: Sun, 23 Apr 2006 23:09:15 +0930
Subject: DirectFB downscaling (WAS: Re: [Softdevice-devel] From todays
	changelog)
In-Reply-To: <200604221111.57846.stefan@lucke.in-berlin.de>
References: <200604221111.57846.stefan@lucke.in-berlin.de>
Message-ID: <1145799555.27094.18.camel@localhost.localdomain>

On Sat, 2006-04-22 at 11:11 +0200, Stefan Lucke wrote:
> On Dienstag 18 April 2006 02:14, Malcolm Caldwell wrote:
> > OK,
> > 
> > Since I am one of those not on the cvs list...
> > 
> > Has there been any work on the MGA TV non-field based StretchBlit bug?
> No.
> > If not is anyone working on it?
> No.
> 
> I think your are referring to this thread on directfb-users:
> http://mail.directfb.org/pipermail/directfb-users/2005-October/000770.html

Yes.  This would be the bug.

> But before pushing that again on directfb lists, I have to test Ville's
> modifications he suggested in this thread (long time ago too):
> 
> Or has anyone tried his patches from?
> http://mail.directfb.org/pipermail/directfb-dev/2005-October/000846.html

This looks interesting, although it is not obvious from the description
or the followups that this fixes the problem talked about here.

> There was low feedback on directfb-dev.
> 
> > 
> > This bug *severely* affects the effectiveness of softdevice for me.  I
> > have a 4:3 TV.  This bug means:
> >       * I have to view all my channels as centre cut instead of
> >         letterboxed.  I would prefer not to loose the sides of every
> >         programme I watch
> 
> >       * softplay's output is 'broken' (because hardly any material is at
> >         a resolution the same as softdevices output)
> 
> That's the part I do not understand even though softplay is 
> Martin's baby. 

I *think* the issue is I have tried it on interlaced material.  I used
dvdrip and it decided to crop the image slightly.  Softdevice then seems
to scale this image to the full frame size.

> >       * ntsc material is 'broken' (I know there are framerate problems
> >         as well, but I can put up with the bad frame rate, but not the
> >         wobbly pictures)
> 
> I guess you want PAL/NTSC recognition on the fly. This should be
> possible, even if we have to reinitialise directfb complete.
> 
> (@Martin: In that case I need the videoInitialized variable allways,
> as state changes like: videoInitialized -> !videoInitialized -> videoInitialized)
> 
> The only drawback is that directfb only can PAL and NTSC. PAL60 is to my 
> knowledge not possible. The difference is composite out. In NTSC mode
> you need a real NTSC device. Usually PAL TVs can do some sort
> of 60Hz mode (timing from NTSC, but color info on composite encoded
> as PAL).

Many televisions CAN handle PAL and true NTSC as well as the PAL60 style
"ntsc rates with pal encoding" mode that some VCRs output.

(Many televisions here in Australia anyway.  I would surprised if
European models were that different)

> > Basically, this bug means that MGA TV-Out softdevice is very limited.
> 
> Can agree to that. A few months ago when I recognized that issue,
> it was a nogo argument for me too [ switching my main TV to 
> softdevice :-( ]. It caused some frustration on me (ac3 solved but ..) .
> 
> 
> The most annoying thing and most difficult to resolve is to my opinion:
> 16:9 downscaled on 4:3 TV.
> 
> > 
> > Now, I may get a chance to look at the code sometime, but I wanted to
> > know if anyone is working on it at the moment.  (I have had a quick look
> > and so far it is not obvious how the code works...)

I am fairly sure we can work around the bug by doing two stretchblits
with stride*2 in the YUV function.  However, it would be better to do
this in directfb, particularly if the mga chips can do it in hardware!

Another 'option' is to turn on the deinterlace code.  Seems strange to
turn on deinterlacing code when final desplay device is interlaced but
this gets rid of the 'tearing' apparent on moving scenes.  However, on
the other hand it makes a real mess of scrolling text.

> > On Fri, 2006-04-14 at 23:33 +0200, Stefan Lucke wrote:
> > > Hi,
> > > 
> > > as there are only a few persons on cvs list (15 vs. 67)
> > > there is somthing new in cvs. Prehaps someone is interested in testing:
> > > 
> > > 2006-04-14:
> > >    - Expand top/bottom line and left/right coloumns (from vdr-portal).
> > >    - Zoom feature, zoomed area may be shifted around.
> > >    - yv12 -> yuy2 converter for field based chroma.
> > >    - remember interlaced mode of current frame.
> > >    - some preparations for some more XvImage formats (not yet selectable).
> > >    - Restricted OSD alpha blend option to XV and VIDIX out.
> > >    - started some documentation of our various OSD options.
> > >    - applied patch for mono upmix from Lucian Muresan
> > > 
> > > 
> 


From Malcolm.Caldwell at cdu.edu.au  Sun Apr 23 15:39:15 2006
From: Malcolm.Caldwell at cdu.edu.au (Malcolm Caldwell)
Date: Sun, 23 Apr 2006 23:09:15 +0930
Subject: DirectFB downscaling (WAS: Re: [Softdevice-devel] From todays
	changelog)
In-Reply-To: <200604221111.57846.stefan@lucke.in-berlin.de>
References: <200604221111.57846.stefan@lucke.in-berlin.de>
Message-ID: <1145799555.27094.18.camel@localhost.localdomain>

On Sat, 2006-04-22 at 11:11 +0200, Stefan Lucke wrote:
> On Dienstag 18 April 2006 02:14, Malcolm Caldwell wrote:
> > OK,
> > 
> > Since I am one of those not on the cvs list...
> > 
> > Has there been any work on the MGA TV non-field based StretchBlit bug?
> No.
> > If not is anyone working on it?
> No.
> 
> I think your are referring to this thread on directfb-users:
> http://mail.directfb.org/pipermail/directfb-users/2005-October/000770.html

Yes.  This would be the bug.

> But before pushing that again on directfb lists, I have to test Ville's
> modifications he suggested in this thread (long time ago too):
> 
> Or has anyone tried his patches from?
> http://mail.directfb.org/pipermail/directfb-dev/2005-October/000846.html

This looks interesting, although it is not obvious from the description
or the followups that this fixes the problem talked about here.

> There was low feedback on directfb-dev.
> 
> > 
> > This bug *severely* affects the effectiveness of softdevice for me.  I
> > have a 4:3 TV.  This bug means:
> >       * I have to view all my channels as centre cut instead of
> >         letterboxed.  I would prefer not to loose the sides of every
> >         programme I watch
> 
> >       * softplay's output is 'broken' (because hardly any material is at
> >         a resolution the same as softdevices output)
> 
> That's the part I do not understand even though softplay is 
> Martin's baby. 

I *think* the issue is I have tried it on interlaced material.  I used
dvdrip and it decided to crop the image slightly.  Softdevice then seems
to scale this image to the full frame size.

> >       * ntsc material is 'broken' (I know there are framerate problems
> >         as well, but I can put up with the bad frame rate, but not the
> >         wobbly pictures)
> 
> I guess you want PAL/NTSC recognition on the fly. This should be
> possible, even if we have to reinitialise directfb complete.
> 
> (@Martin: In that case I need the videoInitialized variable allways,
> as state changes like: videoInitialized -> !videoInitialized -> videoInitialized)
> 
> The only drawback is that directfb only can PAL and NTSC. PAL60 is to my 
> knowledge not possible. The difference is composite out. In NTSC mode
> you need a real NTSC device. Usually PAL TVs can do some sort
> of 60Hz mode (timing from NTSC, but color info on composite encoded
> as PAL).

Many televisions CAN handle PAL and true NTSC as well as the PAL60 style
"ntsc rates with pal encoding" mode that some VCRs output.

(Many televisions here in Australia anyway.  I would surprised if
European models were that different)

> > Basically, this bug means that MGA TV-Out softdevice is very limited.
> 
> Can agree to that. A few months ago when I recognized that issue,
> it was a nogo argument for me too [ switching my main TV to 
> softdevice :-( ]. It caused some frustration on me (ac3 solved but ..) .
> 
> 
> The most annoying thing and most difficult to resolve is to my opinion:
> 16:9 downscaled on 4:3 TV.
> 
> > 
> > Now, I may get a chance to look at the code sometime, but I wanted to
> > know if anyone is working on it at the moment.  (I have had a quick look
> > and so far it is not obvious how the code works...)

I am fairly sure we can work around the bug by doing two stretchblits
with stride*2 in the YUV function.  However, it would be better to do
this in directfb, particularly if the mga chips can do it in hardware!

Another 'option' is to turn on the deinterlace code.  Seems strange to
turn on deinterlacing code when final desplay device is interlaced but
this gets rid of the 'tearing' apparent on moving scenes.  However, on
the other hand it makes a real mess of scrolling text.

> > On Fri, 2006-04-14 at 23:33 +0200, Stefan Lucke wrote:
> > > Hi,
> > > 
> > > as there are only a few persons on cvs list (15 vs. 67)
> > > there is somthing new in cvs. Prehaps someone is interested in testing:
> > > 
> > > 2006-04-14:
> > >    - Expand top/bottom line and left/right coloumns (from vdr-portal).
> > >    - Zoom feature, zoomed area may be shifted around.
> > >    - yv12 -> yuy2 converter for field based chroma.
> > >    - remember interlaced mode of current frame.
> > >    - some preparations for some more XvImage formats (not yet selectable).
> > >    - Restricted OSD alpha blend option to XV and VIDIX out.
> > >    - started some documentation of our various OSD options.
> > >    - applied patch for mono upmix from Lucian Muresan
> > > 
> > > 
> 


From Malcolm.Caldwell at cdu.edu.au  Sun Apr 23 15:42:16 2006
From: Malcolm.Caldwell at cdu.edu.au (Malcolm Caldwell)
Date: Sun, 23 Apr 2006 23:12:16 +0930
Subject: DirectFB downscaling (WAS: Re: [Softdevice-devel] From todays
	changelog)
In-Reply-To: <20060422163229.GC3489@localhost.localdomain>
References: <200604221111.57846.stefan@lucke.in-berlin.de>
	 <20060422163229.GC3489@localhost.localdomain>
Message-ID: <1145799737.27094.22.camel@localhost.localdomain>

On Sat, 2006-04-22 at 19:32 +0300, Marko M?kel? wrote:
> On Sat, Apr 22, 2006 at 11:11:57AM +0200, Stefan Lucke wrote:
> > The most annoying thing and most difficult to resolve is to my opinion:
> > 16:9 downscaled on 4:3 TV.
> 
> FWIW, center-cut works pretty well for me.  There's not that much essential
> information on the edges, but then again, I'm not watching movies.

I have been using centre-cut for quite a few months now (8 or so).  It
annoys me quite often but I put up with it.

It is particularly annoying because it seems to cut slightly more than
the television stations own 4:3 centre-cut, so it *just* misses out
things on the edge of the picture.  (Like 1/4 of the station logo!)

> The only problems are on channels that burn the subtitles on the video
> stream rather than using DVB subtitles, which are scaled to actual 4:3
> screen width.

Yes. And other on-screen graphics.

> That said, I'm happy to test any mgatv patches you come up with.
> 
> vdr -Psoftdevice -Psubtitles -Pdvd on a 14" monitor is the only TV in
> our household since over a year, and it works perfectly.
> 
> 	Marko
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/softdevice-devel


From M.Wache at gmx.net  Sun Apr 23 22:03:10 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 23 Apr 2006 22:03:10 +0200
Subject: [Softdevice-devel] ShmClient updated
Message-ID: <444BDD7E.90503@gmx.net>

Hi all,

I just committed a patch which makes the ShmClient independent of Vdr
objects. By now there is also the possibility to use both software Osd
blending and pseudo Osd blending with the ShmClient, the only thing
which still needs to be done is the access to the SetupStore. So it is
still not possible to use all the settings with the ShmClient (like
contrast, hue etc).
However I'm now mainly using the ShmClient on my Vdr, and it works very
stable for me. In case there are still problems with ShmClient please
report them, and of course success reports are also welcome :-)

Bye,

Martin


From M.Wache at gmx.net  Sun Apr 23 22:19:42 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 23 Apr 2006 22:19:42 +0200
Subject: [Softdevice-devel] Via CLE266 hardware MPEG decoding...
In-Reply-To: <200604191540.00483.laz@club-burniston.co.uk>
References: <200604171406.12101.laz@club-burniston.co.uk> <444640FD.4080408@huillard.net> <200604191540.00483.laz@club-burniston.co.uk>
Message-ID: <444BE15E.2020106@gmx.net>

Laz schrieb:
> On Wednesday 19 Apr 2006 14:54, Nicolas Huillard wrote:
>> Laz a ?crit :
>>> I know this has been mentioned several times in the past but I don't
>>> think anyone has made any progress in getting hardware MPEG decoding
>>> on the Via CLE266 and related chips from DirectFB apps. I have a Via
>>> Epia system running vdr with softdevice using DirectFB TV-out output,
>>> and this works really well but it is just on the limit of what the
>>> CPU can do when it is decoding the MPEG2 stream in software, so I get
>>> a few jerks and A-V sync isn't as good as it should be. I've started
>>> looking into this again now...
>> It's really nice to see that there is still interest in this solution !
>> Since I still didn't upgrade from vdr 1.3.33 / softdevice 0.2.0, I
>> can't help very much with this, but I can still recall ancient threads,
>> test, etc...
>>
>> ...
> 
> It seems to be something which gets mentioned every now and then  but 
> nothing ever seems to come of it!
> 
I have to admit that the progress is currently slow, I don't have that
much time to spent on the softdevice and there are many things to be
done... What I plan is to integrate the Via Xvmc acceleration into the
softdevice. Unfortunately the current design of the video out doesn't
allow this (direct rendering is needed, different image formats...), so
I have to change quite fundamental things in the softdevice. Since I
want not to mess up the softdevice code I have to do that in small pieces...

> 
> I think the information is there it just needs someone to pull it all 
> together!
>
Did I understand correctly, that you will try to do this? That would be
great!


>>> Has anyone made any more progress with this or am I starting from
>>> scratch? Ultimately, the best route would probably be to incorporate
>>> hardware decoding into ffmpeg or similar but, for now, I'd just be
>>> happy to get it working from softdevice!
>> There are mainly two possible routes : the great and beautiful one,
>> where you integrate all needed functionnaly inside one of ffmpeg,
>> libavcodec, or similar library, remove X dependencies, etc. And the
>> fast and hackish one, where you get small library parts, pack them
>> together and have a working, albeit uncomplete thingy. That's how the
>> viafb kernel module evolved... Once basic support is available, will
>> come the time to write beautiful code...
> 
> Indeed. It seems that most of the effort ended up going into the 
> unichrome / openchrome projects rather than creating a nice, 
> self-contained library!
> 
I think I remember that the openchrome developers once search for
someone who would integrate the mpeg2 hardware acceleration into
DirectFB, but obviously the didn't find anyone...

What I can say is that the patch to ffmpeg to use the VLD-Xvmc is rather
small (it can be extracted from the mplayer patch on openchrome), so
getting support form ffmpeg should not be difficult.
Please keep us updated on your progress!

Bye,
Martin


From marko.makela at hut.fi  Sun Apr 23 22:37:19 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sun, 23 Apr 2006 23:37:19 +0300
Subject: [Softdevice-devel] video.c -r1.50 broken
Message-ID: <20060423203719.GA4032@localhost.localdomain>

I just updated my vdr box to version 1.3.48.  I see that softdevice has been
updated today as well, now that VDRVERSION != APIVERSION for the first time.

However, the current revision of video.c (r1.50) causes a crash at startup
(vdr -P'softdevice -vo:mgatv):

Program received signal SIGSEGV, Segmentation fault.
[Switching to Thread -1520223312 (LWP 4581)]
0xa776f0c8 in IDirectFBEventBuffer::GetEvent ()
   from /usr/local/lib/libdfb++-0.9.so.25
(gdb) bt
#0  0xa776f0c8 in IDirectFBEventBuffer::GetEvent ()
   from /usr/local/lib/libdfb++-0.9.so.25
#1  0xa78b8528 in cDFBVideoOut::ProcessEvents (this=0x828c950)
    at video-dfb.c:588
#2  0xa78a2e7f in cVideoOut::Action (this=0x828c950) at video.c:103
#3  0x08105720 in cThread::StartThread (Thread=0x828c950) at thread.c:244
#4  0xa7f9eced in start_thread () from /lib/tls/libpthread.so.0
#5  0xa7e17dee in clone () from /lib/tls/libc.so.6

Revision 1.49 of video.c starts, but keeps printing these messages:

[dfb] (re)configuring Videolayer to 736 x 576 (704x576)
[dfb] creating new surface (stretchBlit)
[surface capabilities] videoSurface: videoonly
[dfb] (re)configured 0x00200806
[dfb] (re)configuring Videolayer to 736 x 576 (720x576)
[dfb] creating new surface (stretchBlit)
[surface capabilities] videoSurface: videoonly
[dfb] (re)configured 0x00200806
...

	Marko


From marko.makela at hut.fi  Sun Apr 23 22:56:59 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sun, 23 Apr 2006 23:56:59 +0300
Subject: [Softdevice-devel] video-dfb.c -r1.54 removes RCU support?
Message-ID: <20060423205659.GB4032@localhost.localdomain>

I'm using the bundled remote control unit of the Hauppauge Nova-T PCI 90002
via the following software stack:

 cx88-input.c in Linux 2.6.16.9
 libdirectfb_linux_input
 video-dfb.c in softdevice
 vdr 1.3.48

Martin, how should I connect the RCU to VDR from now on?  I'd prefer not
to install another plugin (vdr-remote?).

	Marko


From stefan at lucke.in-berlin.de  Sun Apr 23 23:02:15 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 23 Apr 2006 23:02:15 +0200
Subject: [Softdevice-devel] video.c -r1.50 broken
In-Reply-To: <20060423203719.GA4032@localhost.localdomain>
References: <20060423203719.GA4032@localhost.localdomain>
Message-ID: <200604232302.15388.stefan@lucke.in-berlin.de>

On Sonntag 23 April 2006 22:37, Marko M?kel? wrote:
> I just updated my vdr box to version 1.3.48.  I see that softdevice has been
> updated today as well, now that VDRVERSION != APIVERSION for the first time.
> 
> However, the current revision of video.c (r1.50) causes a crash at startup
> (vdr -P'softdevice -vo:mgatv):
> 
> Program received signal SIGSEGV, Segmentation fault.

Can you try to add a :

if (!videoInitialized)
	return;

to top of method ProcessEvents() in video-dfb.c after line 587 ?


-- 
Stefan Lucke


From admin at berlios.de  Sun Apr 23 22:31:26 2006
From: admin at berlios.de (admin at berlios.de)
Date: Sun, 23 Apr 2006 22:31:26 +0200 (CEST)
Subject: [Softdevice-devel] [Bug #7202] Illegal instruction
Message-ID: <200604232031.k3NKVQbP007790@unicorn.berlios.de>

Bug #7202, was updated on 2006-Apr-20 12:51
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: None
Status: Open
Resolution: None
Bug Group: None
Priority: 5
Submitted by: drakon
Assigned to : none
Summary: Illegal instruction

Details: Hallo!
Wenn das Programm auf einem Rechner dessen Prozessor kein MMX2 unterst?tzt kompiliert und ausgef?hrt wird kommt es zu diesem Fehler.
Das Problem habe ich hier beschrieben:

http://vdr-portal.de/board/thread.php?threadid=48118

Follow-Ups:

Date: 2006-Apr-23 22:31
By: wachm

Comment:
Ich denke ich habe das Problem gel?st, da wurde ein MMX2-Befehl trotzdem in utils.c und SoftOsd.c benutzt. Ich habe aber selbst kein Prozessor mit dem ich das ausprobieren k?nnte... Bitte probier mal die CVS Version aus und sag bescheid ob's geht
-------------------------------------------------------

For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=7202&group_id=2051


From marko.makela at hut.fi  Sun Apr 23 23:13:06 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 24 Apr 2006 00:13:06 +0300
Subject: [Softdevice-devel] video.c -r1.50 broken
In-Reply-To: <200604232302.15388.stefan@lucke.in-berlin.de>
References: <20060423203719.GA4032@localhost.localdomain> <200604232302.15388.stefan@lucke.in-berlin.de>
Message-ID: <20060423211306.GC4032@localhost.localdomain>

On Sun, Apr 23, 2006 at 11:02:15PM +0200, Stefan Lucke wrote:
> Can you try to add a :
> 
> if (!videoInitialized)
> 	return;
> 
> to top of method ProcessEvents() in video-dfb.c after line 587 ?

Thanks, that does the trick.  An alternative fix is to revert to
video-dfb.c -r1.53 and video-dfb.h -r1.18.

	Marko


From stefan at lucke.in-berlin.de  Sun Apr 23 23:18:53 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 23 Apr 2006 23:18:53 +0200
Subject: [Softdevice-devel] Next release ?
In-Reply-To: <20060422162214.GB3489@localhost.localdomain>
References: <200604212239.48922.stefan@lucke.in-berlin.de> <200604220042.00621.stefan@lucke.in-berlin.de> <20060422162214.GB3489@localhost.localdomain>
Message-ID: <200604232318.53229.stefan@lucke.in-berlin.de>

On Samstag 22 April 2006 18:22, Marko M?kel? wrote:
> On Sat, Apr 22, 2006 at 12:42:00AM +0200, Stefan Lucke wrote:


> 
> > Short test with vdr-1.3.47: configure runs and xv-out is still usable.
> 
> That's because VDRVERSION == APIVERSION.  The two will probably differ when
> vdr 1.4 is released.  Then vdr would be loading plugins by APIVERSION.

Damm, my modification I prepared worked until I noticed Klaus did another
funny check for plugin compatibility today. So I had to add a comment
line to trick that check:

#DUMMY=$(LIBDIR)/fake.vdr.Makefile.check.$(APIVERSION)

Without that line, softdevice won't get compiled at all ;-) .

Next release should be delayed, until our cvs version
stabilized a few days.

-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Sun Apr 23 23:25:32 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 23 Apr 2006 23:25:32 +0200
Subject: [Softdevice-devel] video.c -r1.50 broken
In-Reply-To: <20060423211306.GC4032@localhost.localdomain>
References: <20060423203719.GA4032@localhost.localdomain> <200604232302.15388.stefan@lucke.in-berlin.de> <20060423211306.GC4032@localhost.localdomain>
Message-ID: <200604232325.32607.stefan@lucke.in-berlin.de>

On Sonntag 23 April 2006 23:13, Marko M?kel? wrote:
> On Sun, Apr 23, 2006 at 11:02:15PM +0200, Stefan Lucke wrote:
> > Can you try to add a :
> > 
> > if (!videoInitialized)
> > 	return;
> > 
> > to top of method ProcessEvents() in video-dfb.c after line 587 ?
> 
> Thanks, that does the trick.  An alternative fix is to revert to
> video-dfb.c -r1.53 and video-dfb.h -r1.18.

Change is in cvs. Commited that without compile check :-( as
this box lacks DirectFB support.


-- 
Stefan Lucke


From nicolas at huillard.net  Mon Apr 24 10:58:18 2006
From: nicolas at huillard.net (Nicolas Huillard)
Date: Mon, 24 Apr 2006 10:58:18 +0200
Subject: [Softdevice-devel] Via CLE266 hardware MPEG decoding...
In-Reply-To: <444BE15E.2020106@gmx.net>
References: <200604171406.12101.laz@club-burniston.co.uk> <444640FD.4080408@huillard.net> <200604191540.00483.laz@club-burniston.co.uk> <444BE15E.2020106@gmx.net>
Message-ID: <444C932A.9070801@huillard.net>

Martin Wache a ?crit :
> I have to admit that the progress is currently slow, I don't have that
> much time to spent on the softdevice and there are many things to be
> done... What I plan is to integrate the Via Xvmc acceleration into the
> softdevice. Unfortunately the current design of the video out doesn't
> allow this (direct rendering is needed, different image formats...), so
> I have to change quite fundamental things in the softdevice. Since I
> want not to mess up the softdevice code I have to do that in small pieces...

What Laz is interested into (and I too) is hardware MPEG2 decoding with
the DirectFB output method, ie. without X dependencies.
That's not the so-called XVMC implementation, which inherently has X
dependency...

>>I think the information is there it just needs someone to pull it all 
>>together!
> 
> Did I understand correctly, that you will try to do this? That would be
> great!


From laz at club-burniston.co.uk  Mon Apr 24 14:00:59 2006
From: laz at club-burniston.co.uk (Laz)
Date: Mon, 24 Apr 2006 13:00:59 +0100
Subject: [Softdevice-devel] Via CLE266 hardware MPEG decoding...
In-Reply-To: <444C932A.9070801@huillard.net>
References: <200604171406.12101.laz@club-burniston.co.uk> <444BE15E.2020106@gmx.net> <444C932A.9070801@huillard.net>
Message-ID: <200604241300.59604.laz@club-burniston.co.uk>

On Monday 24 Apr 2006 09:58, Nicolas Huillard wrote:
> Martin Wache a ?crit :
> > I have to admit that the progress is currently slow, I don't have
> > that much time to spent on the softdevice and there are many things
> > to be done... What I plan is to integrate the Via Xvmc acceleration
> > into the softdevice. Unfortunately the current design of the video
> > out doesn't allow this (direct rendering is needed, different image
> > formats...), so I have to change quite fundamental things in the
> > softdevice. Since I want not to mess up the softdevice code I have to
> > do that in small pieces...
>
> What Laz is interested into (and I too) is hardware MPEG2 decoding with
> the DirectFB output method, ie. without X dependencies.
> That's not the so-called XVMC implementation, which inherently has X
> dependency...

That's about it: I have had hardware decoding going with xine and XVMC but 
I don't really want the additional overhead of running X on my vdr box!

;)

> >>I think the information is there it just needs someone to pull it all
> >>together!
> >
> > Did I understand correctly, that you will try to do this? That would
> > be great!
>
> From my latest private mail exchange with Laz : yes, DirectFB.
> I think XVMC is far more advanced and should not be a real problem (and
> you mention patches to ffmpeg that should add XVMC to softdevice
> without much work or no work at all in softdevice).

At the moment, I'm just trying to get something that works before trying 
to incorporate it into anything... Eventually, I hope to create either 
another output driver for softdevice or incorporate it into the existing 
video-dfb.c (although that might be more difficult because libsoftmpeg 
takes care of the A-V sync and the actual audio and video output).

> > I think I remember that the openchrome developers once search for
> > someone who would integrate the mpeg2 hardware acceleration into
> > DirectFB, but obviously the didn't find anyone...
>
> What I remenber is DirectFB developers searching for someone to
> integrate openchrome hardware decoding into DirectFB, removing X
> dependencies.
> I do not read openchrome's ML, though, so you might also be right.

I have yet to get my head around how this would fit into either DirectFB 
or ffmpeg...

> > What I can say is that the patch to ffmpeg to use the VLD-Xvmc is
> > rather small (it can be extracted from the mplayer patch on
> > openchrome), so getting support form ffmpeg should not be difficult.
>
> If that patch doesn't add X dependency (or run-time X dependency), that
> would be great !

Most of what I've seen depends heavily on X.

:-(

Cheers,

Laz


From torgeir at pobox.com  Mon Apr 24 14:17:43 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Mon, 24 Apr 2006 14:17:43 +0200
Subject: [Softdevice-devel] Via CLE266 hardware MPEG decoding...
In-Reply-To: <200604241300.59604.laz@club-burniston.co.uk>
References: <200604171406.12101.laz@club-burniston.co.uk>
	 <444BE15E.2020106@gmx.net> <444C932A.9070801@huillard.net>
	 <200604241300.59604.laz@club-burniston.co.uk>
Message-ID: <1145881063.11070.7.camel@localhost>

On Mon, 2006-04-24 at 13:00 +0100, Laz wrote:
> 
> I have yet to get my head around how this would fit into either
> DirectFB or ffmpeg...

At least XvMC is easy with libavcodec, you just force a different output
format than CODEC_ID_MPEG2VIDEO, instead asking for
CODEC_ID_MPEG2VIDEO_XVMC, so that idct and mc is not performed. You can
check if the format returned by libavformat is the above, and force to
use the XVMC variant.

The difficulty is driving the hardware. It's easier to start with XvMC,
since there are existing working systems. Once you understand the model
properly, it's possible to make an API which doesn't require X11.

-- 
Torgeir Veimo <torgeir at pobox.com>



From nicolas at huillard.net  Mon Apr 24 14:34:07 2006
From: nicolas at huillard.net (Nicolas Huillard)
Date: Mon, 24 Apr 2006 14:34:07 +0200
Subject: [Softdevice-devel] Via CLE266 hardware MPEG decoding...
In-Reply-To: <200604241300.59604.laz@club-burniston.co.uk>
References: <200604171406.12101.laz@club-burniston.co.uk> <444BE15E.2020106@gmx.net> <444C932A.9070801@huillard.net> <200604241300.59604.laz@club-burniston.co.uk>
Message-ID: <444CC5BF.7000607@huillard.net>

Laz a ?crit :
> At the moment, I'm just trying to get something that works before trying 
> to incorporate it into anything... Eventually, I hope to create either 
> another output driver for softdevice or incorporate it into the existing 
> video-dfb.c (although that might be more difficult because libsoftmpeg 
> takes care of the A-V sync and the actual audio and video output).

...

> I have yet to get my head around how this would fit into either DirectFB 
> or ffmpeg...

Just a thought I had some time ago : what you try to achieve is using a
standalone MPEG2 decoder... much like the EM8300 / DXR3 / Hollywood+ card...
Maybe looking at the DXR3 VDR plugin could help in some way (either
implementing CLE266 in this plugin, or getting CLE266 + EM8300 code
inside softdevice...)

http://www.schluenss.de/DXR3.html
http://sourceforge.net/projects/dxr3plugin

-- 
NH


From laz at club-burniston.co.uk  Mon Apr 24 14:39:53 2006
From: laz at club-burniston.co.uk (Laz)
Date: Mon, 24 Apr 2006 13:39:53 +0100
Subject: [Softdevice-devel] Via CLE266 hardware MPEG decoding...
In-Reply-To: <444CC5BF.7000607@huillard.net>
References: <200604171406.12101.laz@club-burniston.co.uk> <200604241300.59604.laz@club-burniston.co.uk> <444CC5BF.7000607@huillard.net>
Message-ID: <200604241339.53264.laz@club-burniston.co.uk>

On Monday 24 Apr 2006 13:34, Nicolas Huillard wrote:
> Laz a ?crit :
> > At the moment, I'm just trying to get something that works before
> > trying to incorporate it into anything... Eventually, I hope to
> > create either another output driver for softdevice or incorporate it
> > into the existing video-dfb.c (although that might be more difficult
> > because libsoftmpeg takes care of the A-V sync and the actual audio
> > and video output).
>
> ...
>
> > I have yet to get my head around how this would fit into either
> > DirectFB or ffmpeg...
>
> Just a thought I had some time ago : what you try to achieve is using a
> standalone MPEG2 decoder... much like the EM8300 / DXR3 / Hollywood+
> card... Maybe looking at the DXR3 VDR plugin could help in some way
> (either implementing CLE266 in this plugin, or getting CLE266 + EM8300
> code inside softdevice...)
>
> http://www.schluenss.de/DXR3.html
> http://sourceforge.net/projects/dxr3plugin

I used to use a dxr3 for output!

;)

I think with that, you just send an MPEG stream at the device and it comes 
nicely out of the tv-out connector. I don't think it's as easy with the 
CLE266. With the CLE266, you feed it MPEG data and it ends up in a 
framebuffer which you then need to blit or flip at the relevant time.

The OSD on the dxr3 is done on the devices sub-picture unit, ratherh than 
a 'real OSD', and so the number of colours, etc. is limited. I like the 
way DirectFB gives a separate layer for using as the OSD, rather than 
mixing the OSD in with the vidoe, which is I think how the xine and 
related output plugins work.

Cheers,

Laz


From nicolas at huillard.net  Mon Apr 24 14:41:55 2006
From: nicolas at huillard.net (Nicolas Huillard)
Date: Mon, 24 Apr 2006 14:41:55 +0200
Subject: [Softdevice-devel] Via CLE266 hardware MPEG decoding...
In-Reply-To: <444CC5BF.7000607@huillard.net>
References: <200604171406.12101.laz@club-burniston.co.uk> <444BE15E.2020106@gmx.net> <444C932A.9070801@huillard.net> <200604241300.59604.laz@club-burniston.co.uk> <444CC5BF.7000607@huillard.net>
Message-ID: <444CC793.2030201@huillard.net>

Nicolas Huillard a ?crit :
> Just a thought I had some time ago : what you try to achieve is using a
> standalone MPEG2 decoder... much like the EM8300 / DXR3 / Hollywood+ card...
> Maybe looking at the DXR3 VDR plugin could help in some way (either
> implementing CLE266 in this plugin, or getting CLE266 + EM8300 code
> inside softdevice...)
> 
> http://www.schluenss.de/DXR3.html
> http://sourceforge.net/projects/dxr3plugin

Googling from there, I got : http://dxr3player.sourceforge.net/

<copy>
dxr3Player is a lightweight, command-line DVD player for Linux and the
DXR3 (aka Hollywood+) MPEG-2 decoder boards. It supports all major DVD
features, including: menus, navigation, fast forward and backward
playback, subtitles and camera angle changes. The player is very
conservative on memory usage and tries very hard (and mostly succeeds)
to keep video and audio in sync.

As of version 0.10, it works with Via's Unichrome (CLE266) chipset,
though it is quite experimental.
</copy>

So this one implements hardware decoding for the two chips, without X
dependency. Lastest release dated April 22, 2005.

-- 
NH


From laz at club-burniston.co.uk  Mon Apr 24 15:01:36 2006
From: laz at club-burniston.co.uk (Laz)
Date: Mon, 24 Apr 2006 14:01:36 +0100
Subject: [Softdevice-devel] Via CLE266 hardware MPEG decoding...
In-Reply-To: <444CC793.2030201@huillard.net>
References: <200604171406.12101.laz@club-burniston.co.uk> <444CC5BF.7000607@huillard.net> <444CC793.2030201@huillard.net>
Message-ID: <200604241401.36479.laz@club-burniston.co.uk>

On Monday 24 Apr 2006 13:41, Nicolas Huillard wrote:
> Nicolas Huillard a ?crit :
> > Just a thought I had some time ago : what you try to achieve is using
> > a standalone MPEG2 decoder... much like the EM8300 / DXR3 /
> > Hollywood+ card... Maybe looking at the DXR3 VDR plugin could help in
> > some way (either implementing CLE266 in this plugin, or getting
> > CLE266 + EM8300 code inside softdevice...)
> >
> > http://www.schluenss.de/DXR3.html
> > http://sourceforge.net/projects/dxr3plugin
>
> Googling from there, I got : http://dxr3player.sourceforge.net/
>
> <copy>
> dxr3Player is a lightweight, command-line DVD player for Linux and the
> DXR3 (aka Hollywood+) MPEG-2 decoder boards. It supports all major DVD
> features, including: menus, navigation, fast forward and backward
> playback, subtitles and camera angle changes. The player is very
> conservative on memory usage and tries very hard (and mostly succeeds)
> to keep video and audio in sync.
>
> As of version 0.10, it works with Via's Unichrome (CLE266) chipset,
> though it is quite experimental.
> </copy>
>
> So this one implements hardware decoding for the two chips, without X
> dependency. Lastest release dated April 22, 2005.

I hadn't seen that project before! Thanks for that!

:)

That looks like yet another totally separate set of source. Still, it all 
helps...

Cheers,

Laz


From marko.makela at hut.fi  Mon Apr 24 20:55:27 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 24 Apr 2006 21:55:27 +0300
Subject: [Softdevice-devel] video-dfb.c -r1.54 removes RCU support?
In-Reply-To: <20060423205659.GB4032@localhost.localdomain>
References: <20060423205659.GB4032@localhost.localdomain>
Message-ID: <20060424185527.GB3939@localhost.localdomain>

On Sun, Apr 23, 2006 at 11:56:59PM +0300, Marko M?kel? wrote:
> I'm using the bundled remote control unit of the Hauppauge Nova-T PCI 90002
> via the following software stack:
> 
>  cx88-input.c in Linux 2.6.16.9
>  libdirectfb_linux_input
>  video-dfb.c in softdevice
>  vdr 1.3.48
> 
> Martin, how should I connect the RCU to VDR from now on?  I'd prefer not
> to install another plugin (vdr-remote?).

Okay, I see that the current version still constructs
dfbRemote = new cSoftRemote ("softdevice-dfb");
but somehow it will deliver no events.  I added the line
disable-module=linux_input
to /etc/directfbrc and installed vdr-remote-0.3.6.  This has
the benefit that the |< and >| keys can now be assigned;
DirectFB maps the keysyms to same codes as some other keys on the RCU.

It was a bit irritating to define the RCU mapping.  First, I believed
that the old deadlock bug still hasn't been fixed.  Then, I finally
understood that for some reason, in the "learning remote codes" screen,
the OSD is updated at a delay of several seconds.  I could press the
buttons very fast and they would be registered properly, but the screen
would only be updated some 3 or 5 seconds later.  While using vdr, the
OSD mostly responded fast, but at one occasion (after tuning to a radio
channel), I got a similar delay.

Could it be that video-dfb.c triggers OSD updates by three things: new
video frame, DFBInputEvent (cDFBVideoOut::ProcessEvents()), and a
very slow timer?

I suggest that dfbRemote be removed altogether.  If that cannot be done,
the code should be fixed so that it will deliver events to VDR as before
video-dfb.c -r1.54.

	Marko


From stefan at lucke.in-berlin.de  Tue Apr 25 07:00:38 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 25 Apr 2006 07:00:38 +0200
Subject: [Softdevice-devel] video-dfb.c -r1.54 removes RCU support?
In-Reply-To: <20060424185527.GB3939@localhost.localdomain>
References: <20060423205659.GB4032@localhost.localdomain> <20060424185527.GB3939@localhost.localdomain>
Message-ID: <200604250700.38150.stefan@lucke.in-berlin.de>

On Montag 24 April 2006 20:55, Marko M?kel? wrote:
> On Sun, Apr 23, 2006 at 11:56:59PM +0300, Marko M?kel? wrote:
> > I'm using the bundled remote control unit of the Hauppauge Nova-T PCI 90002
> > via the following software stack:
> > 
> >  cx88-input.c in Linux 2.6.16.9
> >  libdirectfb_linux_input
> >  video-dfb.c in softdevice
> >  vdr 1.3.48
> > 
> > Martin, how should I connect the RCU to VDR from now on?  I'd prefer not
> > to install another plugin (vdr-remote?).
> 
> Okay, I see that the current version still constructs
> dfbRemote = new cSoftRemote ("softdevice-dfb");
> but somehow it will deliver no events.  I added the line
> disable-module=linux_input
> to /etc/directfbrc and installed vdr-remote-0.3.6.  This has
> the benefit that the |< and >| keys can now be assigned;
> DirectFB maps the keysyms to same codes as some other keys on the RCU.
> 
> It was a bit irritating to define the RCU mapping.  First, I believed
> that the old deadlock bug still hasn't been fixed.  

Deadlock bug? Have to to search the archive (or give me a hint).

> Then, I finally 
> understood that for some reason, in the "learning remote codes" screen,
> the OSD is updated at a delay of several seconds.  I could press the
> buttons very fast and they would be registered properly, but the screen
> would only be updated some 3 or 5 seconds later.  While using vdr, the
> OSD mostly responded fast, but at one occasion (after tuning to a radio
> channel), I got a similar delay.
> 
> Could it be that video-dfb.c triggers OSD updates by three things: new
> video frame, DFBInputEvent (cDFBVideoOut::ProcessEvents()), and a
> very slow timer?

Events were and are processed after each frame gets displayed.
Additional they were and are processed from a background thread,
previously from dfb-remote thread, now from video class, and that
lacked an OSD refresh call. Should be fixed.

Can you try to cvs update ?

> 
> I suggest that dfbRemote be removed altogether.  If that cannot be done,
> the code should be fixed so that it will deliver events to VDR as before
> video-dfb.c -r1.54.
> 


-- 
Stefan Lucke


From marko.makela at hut.fi  Tue Apr 25 07:40:36 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 25 Apr 2006 08:40:36 +0300
Subject: [Softdevice-devel] video-dfb.c -r1.54 removes RCU support?
In-Reply-To: <200604250700.38150.stefan@lucke.in-berlin.de>
References: <20060423205659.GB4032@localhost.localdomain> <20060424185527.GB3939@localhost.localdomain> <200604250700.38150.stefan@lucke.in-berlin.de>
Message-ID: <20060425054036.GA3707@localhost.localdomain>

On Tue, Apr 25, 2006 at 07:00:38AM +0200, Stefan Lucke wrote:
> > It was a bit irritating to define the RCU mapping.  First, I believed
> > that the old deadlock bug still hasn't been fixed.  
> 
> Deadlock bug? Have to to search the archive (or give me a hint).

Well, in early 2005, vdr would ignore RCU keypresses in the learning mode
for most of the time.   I had to add some fprintf call to video-dfb.c
and to manually copy the codes from the error log to remote.conf.
It may have been related to LD_ASSUME_KERNEL=2.4.1 (NPTL vs. LinuxThreads).

> > Could it be that video-dfb.c triggers OSD updates by three things: new
> > video frame, DFBInputEvent (cDFBVideoOut::ProcessEvents()), and a
> > very slow timer?
> 
> Events were and are processed after each frame gets displayed.
> Additional they were and are processed from a background thread,
> previously from dfb-remote thread, now from video class, and that
> lacked an OSD refresh call. Should be fixed.
> 
> Can you try to cvs update ?

I'll try tonight.

	Marko


From kier at gmx.de  Tue Apr 25 14:08:42 2006
From: kier at gmx.de (Christian Kier)
Date: Tue, 25 Apr 2006 14:08:42 +0200
Subject: [Softdevice-devel] XvMC support
Message-ID: <444E114A.6040001@gmx.de>

Hi!

I call a EPIA SP 13000 board my own which provides hardware MPEG2 
support by the CN400 chipset. This chipset is supported by the XvMC 
extension of the x.org server (openchrome project) which I successfully 
enabled.

Right now I use the xv output device of the softdevice-plugin with vdr. 
Are there plans to support xvmc by the plugin?
Or would another -- xvmc-aware -- application be the better choice for me?

Regards,
/Christian


From torgeir at pobox.com  Tue Apr 25 14:15:35 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Tue, 25 Apr 2006 14:15:35 +0200
Subject: [Softdevice-devel] XvMC support
In-Reply-To: <444E114A.6040001@gmx.de>
References: <444E114A.6040001@gmx.de>
Message-ID: <1145967335.22253.7.camel@localhost>

On Tue, 2006-04-25 at 14:08 +0200, Christian Kier wrote:
> 
> I call a EPIA SP 13000 board my own which provides hardware MPEG2 
> support by the CN400 chipset. This chipset is supported by the XvMC 
> extension of the x.org server (openchrome project) which I
> successfully 
> enabled.
> 
> Right now I use the xv output device of the softdevice-plugin with
> vdr. 
> Are there plans to support xvmc by the plugin?
> Or would another -- xvmc-aware -- application be the better choice for
> me?

I think it's mostly due to that none of the developers need it, nor have
any XvMC enabled hardware.  

-- 
Torgeir Veimo <torgeir at pobox.com>



From marko.makela at hut.fi  Tue Apr 25 16:48:29 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 25 Apr 2006 17:48:29 +0300
Subject: [Softdevice-devel] video-dfb.c -r1.54 removes RCU support?
In-Reply-To: <200604250700.38150.stefan@lucke.in-berlin.de>
References: <20060423205659.GB4032@localhost.localdomain> <20060424185527.GB3939@localhost.localdomain> <200604250700.38150.stefan@lucke.in-berlin.de>
Message-ID: <20060425144829.GA7401@localhost.localdomain>

On Tue, Apr 25, 2006 at 07:00:38AM +0200, Stefan Lucke wrote:
> > Could it be that video-dfb.c triggers OSD updates by three things: new
> > video frame, DFBInputEvent (cDFBVideoOut::ProcessEvents()), and a
> > very slow timer?
> 
> Events were and are processed after each frame gets displayed.
> Additional they were and are processed from a background thread,
> previously from dfb-remote thread, now from video class, and that
> lacked an OSD refresh call. Should be fixed.
> 
> Can you try to cvs update ?

Thanks, it fixes the issue.

BTW, was the flicker removed when pausing the video? Or does it only
occur with dfb-vga output? (I'm using mgatv now.)

> > I suggest that dfbRemote be removed altogether.  If that cannot be done,
> > the code should be fixed so that it will deliver events to VDR as before
> > video-dfb.c -r1.54.

Of course, removing dfbRemote would also remove CropModeToggleKey.

	Marko


From laz at club-burniston.co.uk  Tue Apr 25 16:54:10 2006
From: laz at club-burniston.co.uk (Laz)
Date: Tue, 25 Apr 2006 15:54:10 +0100
Subject: [Softdevice-devel] video-dfb.c -r1.54 removes RCU support?
In-Reply-To: <20060425144829.GA7401@localhost.localdomain>
References: <20060423205659.GB4032@localhost.localdomain> <200604250700.38150.stefan@lucke.in-berlin.de> <20060425144829.GA7401@localhost.localdomain>
Message-ID: <200604251554.10504.laz@club-burniston.co.uk>

On Tuesday 25 Apr 2006 15:48, Marko M?kel? wrote:
> On Tue, Apr 25, 2006 at 07:00:38AM +0200, Stefan Lucke wrote:
> > > Could it be that video-dfb.c triggers OSD updates by three things:
> > > new video frame, DFBInputEvent (cDFBVideoOut::ProcessEvents()), and
> > > a very slow timer?
> >
> > Events were and are processed after each frame gets displayed.
> > Additional they were and are processed from a background thread,
> > previously from dfb-remote thread, now from video class, and that
> > lacked an OSD refresh call. Should be fixed.
> >
> > Can you try to cvs update ?
>
> Thanks, it fixes the issue.
>
> BTW, was the flicker removed when pausing the video? Or does it only
> occur with dfb-vga output? (I'm using mgatv now.)

I've just noticed that after updating to softdevice cvs from last weekend 
(also updated DirectFB then, too). It gives a brief flash about once a 
second when paused! This is with DirectFB output with viatv.

Cheers,

Laz


From nicolas at huillard.net  Tue Apr 25 17:23:41 2006
From: nicolas at huillard.net (Nicolas Huillard)
Date: Tue, 25 Apr 2006 17:23:41 +0200
Subject: [Softdevice-devel] video-dfb.c -r1.54 removes RCU support?
In-Reply-To: <20060425144829.GA7401@localhost.localdomain>
References: <20060423205659.GB4032@localhost.localdomain> <20060424185527.GB3939@localhost.localdomain> <200604250700.38150.stefan@lucke.in-berlin.de> <20060425144829.GA7401@localhost.localdomain>
Message-ID: <444E3EFD.2050307@huillard.net>

Marko M?kel? a ?crit :
>>>I suggest that dfbRemote be removed altogether.  If that cannot be done,
>>>the code should be fixed so that it will deliver events to VDR as before
>>>video-dfb.c -r1.54.
> 
> Of course, removing dfbRemote would also remove CropModeToggleKey.

I recall having dug into this a long time ago. The dfbRemote code is a
quick and dirty hack, and IMHO should be removed.
The CropModeToggleKey could still be handled by subclassing the real
remote class or creating an event handler for keypresses.
The problem of current implementation is that keypresses are processed
twice : once by the VDR main remote object, and once more by the
dfbRemote object. Luckily, only one of those really process each event...

Another problem is that remote keys are processed by DirectFB LIRC input
plugin, which translates LIRC codes into DFB codes... Some key codes
from your LIRC simply do not match what DirectFB expect, and the key is
simply dropped. That happenned with the [A/B] key on my remote, mapped
to a "A/B" code in LIRC, which did not match the "AB" #define in
DirectFB. That was the key I tried to assign to CropModeToggleKey, and
the only one on the remote that didn't work...

-- 
NH


From nicolas at huillard.net  Tue Apr 25 17:29:05 2006
From: nicolas at huillard.net (Nicolas Huillard)
Date: Tue, 25 Apr 2006 17:29:05 +0200
Subject: [Softdevice-devel] XvMC support
In-Reply-To: <444E114A.6040001@gmx.de>
References: <444E114A.6040001@gmx.de>
Message-ID: <444E4041.50304@huillard.net>

Christian Kier a ?crit :
> Hi!
> 
> I call a EPIA SP 13000 board my own which provides hardware MPEG2
> support by the CN400 chipset. This chipset is supported by the XvMC
> extension of the x.org server (openchrome project) which I successfully
> enabled.
> 
> Right now I use the xv output device of the softdevice-plugin with vdr.
> Are there plans to support xvmc by the plugin?
> Or would another -- xvmc-aware -- application be the better choice for me?

If you don't mind keeping X, try the vdr-xine plugin, which can make use
of XvMC.
Laz is currently (I hope !) digging into hardware MPEG2 decoding using
CLE266, found on EPIA M boards and others. Once this work, it could
easily be ported to CN400. This enhancement would use the directfb
output method of softdevice.
If you can 1) wait a bit and test, and 2) remove you X dependency,
that's a really good way to go. If you can help Laz in coding and
debugging, it could also be really cool !

> Regards,
> /Christian

-- 
NH


From seppo.ingalsuo at iki.fi  Tue Apr 25 18:43:09 2006
From: seppo.ingalsuo at iki.fi (Seppo Ingalsuo)
Date: Tue, 25 Apr 2006 19:43:09 +0300
Subject: [Softdevice-devel] ShmClient updated
In-Reply-To: <444BDD7E.90503@gmx.net>
References: <444BDD7E.90503@gmx.net>
Message-ID: <444E519D.6080002@iki.fi>

Hi,

>However I'm now mainly using the ShmClient on my Vdr, and it works very
>stable for me. In case there are still problems with ShmClient please
>report them, and of course success reports are also welcome :-)
>  
>
I have tried it some time ago but found vdr-xine to be more suitable for 
me. Have you considered making shmclient behave more like xine with vdr 
plugin?

- Shmclient would own the resources such as lirc, audio, etc. only when 
it runs. Shmclient would control vdr daemon similarly as vdr-xine 
plugin. I guess that would be a quite big philopsophy change for 
softdevice.

- Shmclient could be terminated trough lirc (e.g. remote off button)

My htpc is connected to a LCD flat panel so I'm using it sometimes as a 
computer for web browsing and games. I'm launching xine usually with 
lirc cursor keys from matchbox desktop that can be easily controlled by 
keyboard and lirc.

I'm asking this because xine-ui messes up it's configuration files 
easily and the UI is weird . Gxine has a good UI but it has been 
unstable and crashes often full screen mode. Other xine variants such 
oxine probably do not have full support for vdr controls.

Seppo

>Bye,
>
>Martin
>_______________________________________________
>Softdevice-devel mailing list
>Softdevice-devel at lists.berlios.de
>http://lists.berlios.de/mailman/listinfo/softdevice-devel
>  
>



From M.Wache at gmx.net  Tue Apr 25 22:10:09 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 25 Apr 2006 22:10:09 +0200
Subject: [Softdevice-devel] ShmClient updated
In-Reply-To: <444E519D.6080002@iki.fi>
References: <444BDD7E.90503@gmx.net> <444E519D.6080002@iki.fi>
Message-ID: <444E8221.7070307@gmx.net>

Seppo Ingalsuo schrieb:
> Hi,
> 
>> However I'm now mainly using the ShmClient on my Vdr, and it works very
>> stable for me. In case there are still problems with ShmClient please
>> report them, and of course success reports are also welcome :-)
>>  
>>
> I have tried it some time ago but found vdr-xine to be more suitable for
> me. Have you considered making shmclient behave more like xine with vdr
> plugin?
> 
> - Shmclient would own the resources such as lirc, audio, etc. only when
> it runs. Shmclient would control vdr daemon similarly as vdr-xine
> plugin. I guess that would be a quite big philopsophy change for
> softdevice.
>
The audio device is freed automatically when the ShmClient is closed.
Lirc is not owned by the softdevice at all, I can't do much about that.
 The Xv-Port is as well released, so if I understand your request
correctly everything (except lirc) is already like you are suggesting.


> - Shmclient could be terminated trough lirc (e.g. remote off button)

Yes, that would be nice. Unfortunately we need access to keypress events
for doing this, and this is not easily possible with vdr at the moment.

It's been a long time since I last used lirc, but isn't it possible to
execute commands on keypress? A 'killall ShmClient' should do the job...

Bye,
Martin


From M.Wache at gmx.net  Tue Apr 25 22:23:40 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 25 Apr 2006 22:23:40 +0200
Subject: [Softdevice-devel] video-dfb.c -r1.54 removes RCU support?
In-Reply-To: <444E3EFD.2050307@huillard.net>
References: <20060423205659.GB4032@localhost.localdomain> <20060424185527.GB3939@localhost.localdomain> <200604250700.38150.stefan@lucke.in-berlin.de> <20060425144829.GA7401@localhost.localdomain> <444E3EFD.2050307@huillard.net>
Message-ID: <444E854C.7040007@gmx.net>

Nicolas Huillard schrieb:
> Marko M?kel? a ?crit :
>>>> I suggest that dfbRemote be removed altogether.  If that cannot be done,
>>>> the code should be fixed so that it will deliver events to VDR as before
>>>> video-dfb.c -r1.54.
>> Of course, removing dfbRemote would also remove CropModeToggleKey.
> 
No that's not true. I didn't remove the dfbRemote, I just removed a lot
of code which was not necessary and was also present in the video-xv.c
file. Now video-dfb and video-xv share one remote, and the
CropModeToggleKey is anyway handled by the cSetupStore. The change I did
should not change the behaviour of the softdevice in any way. Of course
I could have introduced more bugs (I'm sorry I'm manly using Xv, so I
usually test that much better...)

> I recall having dug into this a long time ago. The dfbRemote code is a
> quick and dirty hack, and IMHO should be removed.
> The CropModeToggleKey could still be handled by subclassing the real
> remote class or creating an event handler for keypresses.
> The problem of current implementation is that keypresses are processed
> twice : once by the VDR main remote object, and once more by the
> dfbRemote object. Luckily, only one of those really process each event...

In my Opinion main problem with the CropModeToggleKey is that it doesn't
work for other remotes than the one's of the softdevice.

Bye,
Martin


From marko.makela at hut.fi  Tue Apr 25 22:34:39 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 25 Apr 2006 23:34:39 +0300
Subject: [Softdevice-devel] video-dfb.c -r1.54 removes RCU support?
In-Reply-To: <444E854C.7040007@gmx.net>
References: <20060423205659.GB4032@localhost.localdomain> <20060424185527.GB3939@localhost.localdomain> <200604250700.38150.stefan@lucke.in-berlin.de> <20060425144829.GA7401@localhost.localdomain> <444E3EFD.2050307@huillard.net> <444E854C.7040007@gmx.net>
Message-ID: <20060425203439.GB3679@localhost.localdomain>

Martin,

> >>>> I suggest that dfbRemote be removed altogether.  If that cannot be done,
> >>>> the code should be fixed so that it will deliver events to VDR as before
> >>>> video-dfb.c -r1.54.
> >> Of course, removing dfbRemote would also remove CropModeToggleKey.
> > 
> No that's not true.

I didn't claim that you removed dfbRemote.  I merely suggested that it be
done, because as of video-dfb.c -r1.54, no DirectFB remote events are
reported to VDR.

> Now video-dfb and video-xv share one remote, and the
> CropModeToggleKey is anyway handled by the cSetupStore. The change I did
> should not change the behaviour of the softdevice in any way. Of course
> I could have introduced more bugs (I'm sorry I'm manly using Xv, so I
> usually test that much better...)

Please test with DirectFB then.  It doesn't matter for me any more,
since I switched to using the vdr-remote plugin, and I can live without
the CropModeToggleKey for now.

> In my Opinion main problem with the CropModeToggleKey is that it doesn't
> work for other remotes than the one's of the softdevice.

Then what do you think about Nicolas' suggestion:

> > The CropModeToggleKey could still be handled by subclassing the real
> > remote class or creating an event handler for keypresses.

Best regards,

	Marko


From M.Wache at gmx.net  Tue Apr 25 23:31:07 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 25 Apr 2006 23:31:07 +0200
Subject: [Softdevice-devel] video-dfb.c -r1.54 removes RCU support?
In-Reply-To: <20060425203439.GB3679@localhost.localdomain>
References: <20060423205659.GB4032@localhost.localdomain> <20060424185527.GB3939@localhost.localdomain> <200604250700.38150.stefan@lucke.in-berlin.de> <20060425144829.GA7401@localhost.localdomain> <444E3EFD.2050307@huillard.net> <444E854C.7040007@gmx.net> <20060425203439.GB3679@localhost.localdomain>
Message-ID: <444E951B.6070706@gmx.net>

Marko M?kel? schrieb:
> Martin,
> 
>>>>>> I suggest that dfbRemote be removed altogether.  If that cannot be done,
>>>>>> the code should be fixed so that it will deliver events to VDR as before
>>>>>> video-dfb.c -r1.54.
>>>> Of course, removing dfbRemote would also remove CropModeToggleKey.
>> No that's not true.
> 
> I didn't claim that you removed dfbRemote.  I merely suggested that it be
> done, because as of video-dfb.c -r1.54, no DirectFB remote events are
> reported to VDR.
> 
I did test video-dfb, for me the remote works just like before. Is there
anybody else who has problems with the dfb-remote?

> Then what do you think about Nicolas' suggestion:
> 
>>> The CropModeToggleKey could still be handled by subclassing the real
>>> remote class or creating an event handler for keypresses.
> 

I'm not sure if that can be done. If one uses the vdr-remote plugin
there is (to my knowledge) no way how the softdevice can have access to
keypress events, except of course if we patch the vdr.
Maybe we should ask for the possibility of receiving keypresses for
plugins at the vdr mailing list, if vdr would implement such a feature
we could simply use that.

Bye,
Martin


From stefan at lucke.in-berlin.de  Wed Apr 26 07:54:29 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 26 Apr 2006 07:54:29 +0200
Subject: [Softdevice-devel] video-dfb.c -r1.54 removes RCU support?
In-Reply-To: <20060425203439.GB3679@localhost.localdomain>
References: <20060423205659.GB4032@localhost.localdomain> <444E854C.7040007@gmx.net> <20060425203439.GB3679@localhost.localdomain>
Message-ID: <200604260754.29371.stefan@lucke.in-berlin.de>

On Dienstag 25 April 2006 22:34, Marko M?kel? wrote:
> Martin,
> 
> > >>>> I suggest that dfbRemote be removed altogether.  If that cannot be done,
> > >>>> the code should be fixed so that it will deliver events to VDR as before
> > >>>> video-dfb.c -r1.54.
> > >> Of course, removing dfbRemote would also remove CropModeToggleKey.
> > > 
> > No that's not true.
> 
> I didn't claim that you removed dfbRemote.  I merely suggested that it be
> done, because as of video-dfb.c -r1.54, no DirectFB remote events are
> reported to VDR.
> 

I did a test with current cvs and df-remote seems to work. When the
teaching phase started it took a while until vdrs screen got updated
for the first time. After that initial delay, subsequent keys were
reported immediate (OSD refreshs too). CropModeToogleKey
worked (mapped to USER1).


-- 
Stefan Lucke


From kier at gmx.de  Wed Apr 26 10:10:58 2006
From: kier at gmx.de (Christian Kier)
Date: Wed, 26 Apr 2006 10:10:58 +0200
Subject: [Softdevice-devel] XvMC support
In-Reply-To: <444E4041.50304@huillard.net>
References: <444E114A.6040001@gmx.de> <444E4041.50304@huillard.net>
Message-ID: <444F2B12.5040005@gmx.de>

Nicolas Huillard wrote:
> Christian Kier a ?crit :
> 
>>Hi!
>>
>>I call a EPIA SP 13000 board my own which provides hardware MPEG2
>>support by the CN400 chipset. This chipset is supported by the XvMC
>>extension of the x.org server (openchrome project) which I successfully
>>enabled.
>>
>>Right now I use the xv output device of the softdevice-plugin with vdr.
>>Are there plans to support xvmc by the plugin?
>>Or would another -- xvmc-aware -- application be the better choice for me?
> 
> 
> If you don't mind keeping X, try the vdr-xine plugin, which can make use
> of XvMC.
> Laz is currently (I hope !) digging into hardware MPEG2 decoding using
> CLE266, found on EPIA M boards and others. Once this work, it could
> easily be ported to CN400. This enhancement would use the directfb
> output method of softdevice.
> If you can 1) wait a bit and test, and 2) remove you X dependency,
> that's a really good way to go. If you can help Laz in coding and
> debugging, it could also be really cool !

1) yes.
2) yes, why not. I start X only for vdr (since I never used dfb before).

Laz, are you still on this topic? Then tell me how I can help you.

/Christian


From laz at club-burniston.co.uk  Wed Apr 26 11:06:49 2006
From: laz at club-burniston.co.uk (Laz)
Date: Wed, 26 Apr 2006 10:06:49 +0100
Subject: [Softdevice-devel] XvMC support
In-Reply-To: <444F2B12.5040005@gmx.de>
References: <444E114A.6040001@gmx.de> <444E4041.50304@huillard.net> <444F2B12.5040005@gmx.de>
Message-ID: <200604261006.50159.laz@club-burniston.co.uk>

On Wednesday 26 Apr 2006 09:10, Christian Kier wrote:
> Nicolas Huillard wrote:
> > If you don't mind keeping X, try the vdr-xine plugin, which can make
> > use of XvMC.
> > Laz is currently (I hope !) digging into hardware MPEG2 decoding
> > using CLE266, found on EPIA M boards and others. Once this work, it
> > could easily be ported to CN400. This enhancement would use the
> > directfb output method of softdevice.
> > If you can 1) wait a bit and test, and 2) remove you X dependency,
> > that's a really good way to go. If you can help Laz in coding and
> > debugging, it could also be really cool !
>
> 1) yes.
> 2) yes, why not. I start X only for vdr (since I never used dfb
> before).

No 2 is why I much prefer the DirectFB method to using X!

:)

> Laz, are you still on this topic? Then tell me how I can help you.

Nothing really to report yet: I now have a working-ish version of 
libsoftmpeg which uses the hardware decoder. It no longer needs to have 
things running as root (which is always nice!) and I eventually got it 
working with the demo app (plays back an MPEG2-TS file), albeit quite 
jerkily!

I'll need to do a bit more testing with this and then I'll try to work it 
into an output method for softdevice.

I doubt I'll get much done before the weekend, though...

Cheers,

Laz


From nicolas at huillard.net  Wed Apr 26 11:59:11 2006
From: nicolas at huillard.net (Nicolas Huillard)
Date: Wed, 26 Apr 2006 11:59:11 +0200
Subject: [Softdevice-devel] XvMC support
In-Reply-To: <200604261006.50159.laz@club-burniston.co.uk>
References: <444E114A.6040001@gmx.de> <444E4041.50304@huillard.net> <444F2B12.5040005@gmx.de> <200604261006.50159.laz@club-burniston.co.uk>
Message-ID: <444F446F.4000508@huillard.net>

Laz a ?crit :
> Nothing really to report yet: I now have a working-ish version of 
> libsoftmpeg which uses the hardware decoder. It no longer needs to have 
> things running as root (which is always nice!) and I eventually got it 
> working with the demo app (plays back an MPEG2-TS file), albeit quite 
> jerkily!

Congratulations !
Feel free to submit code to the ML (directfb, softdevice), to give a
chance to test.
If you modified libsoftmpeg, you can also upload your mods to the
DirectFB CVS repository, to have a broader audience. I think DOK was
interested (2005-09) in adding hardware support to the MPEG2 video
provider in DirectFB. If he can do this using your modified libsoftmpeg,
you will get much more testers and maybe developers.

> I'll need to do a bit more testing with this and then I'll try to work it 
> into an output method for softdevice.

Great !
I just though about something : if your code is a new output method, it
will only handle MPEG1/2, preventing from using softplay to decode DivX
et al. Maybe it's better implemented as an alternate decoder for the
directfb output method, giving a chance to still use current libavcodec
for other codecs.

> I doubt I'll get much done before the weekend, though...

Live your life, keep up the good work, and try to build a supporting
community around your project.

-- 
NH


From laz at club-burniston.co.uk  Wed Apr 26 12:35:03 2006
From: laz at club-burniston.co.uk (Laz)
Date: Wed, 26 Apr 2006 11:35:03 +0100
Subject: [Softdevice-devel] XvMC support
In-Reply-To: <444F446F.4000508@huillard.net>
References: <444E114A.6040001@gmx.de> <200604261006.50159.laz@club-burniston.co.uk> <444F446F.4000508@huillard.net>
Message-ID: <200604261135.03615.laz@club-burniston.co.uk>

On Wednesday 26 Apr 2006 10:59, Nicolas Huillard wrote:
> Laz a ?crit :
> > Nothing really to report yet: I now have a working-ish version of
> > libsoftmpeg which uses the hardware decoder. It no longer needs to
> > have things running as root (which is always nice!) and I eventually
> > got it working with the demo app (plays back an MPEG2-TS file),
> > albeit quite jerkily!
>
> Congratulations !
> Feel free to submit code to the ML (directfb, softdevice), to give a
> chance to test.

Still a bit early for that, I'm afraid!

> If you modified libsoftmpeg, you can also upload your mods to the
> DirectFB CVS repository, to have a broader audience. I think DOK was
> interested (2005-09) in adding hardware support to the MPEG2 video
> provider in DirectFB. If he can do this using your modified
> libsoftmpeg, you will get much more testers and maybe developers.

That would be good. As it stands, libsoftmpeg does both the decoding and 
displaying of an MPEG stream as separate threads (still not worked out 
whether it will do MPEG1 as well as MPEG2...). The decoded frames end up 
in DirectFB surfaces which are then flipped. I'm sure it would be much 
simpler if I removed the display thread (or made it optional) and let 
something else do the actual flipping step.

I may also remove all traces of avcodec from my version so that it would 
then only work with CLE266 (and CLE400?) chips. At the moment, there are 
huge chunks of code which are ignored due to #defines.

> > I'll need to do a bit more testing with this and then I'll try to
> > work it into an output method for softdevice.
>
> Great !
> I just though about something : if your code is a new output method, it
> will only handle MPEG1/2, preventing from using softplay to decode DivX
> et al. Maybe it's better implemented as an alternate decoder for the
> directfb output method, giving a chance to still use current libavcodec
> for other codecs.

I thought softplay was pretty much stand-alone and used ffmpeg to decode 
stuff: softdevice also uses ffmpeg but only decodes MPEG streams.

> > I doubt I'll get much done before the weekend, though...
>
> Live your life, keep up the good work, and try to build a supporting
> community around your project.

:)

Cheers,

Laz


From stefan at lucke.in-berlin.de  Wed Apr 26 12:41:15 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 26 Apr 2006 12:41:15 +0200
Subject: [Softdevice-devel] XvMC support
In-Reply-To: <200604261006.50159.laz@club-burniston.co.uk>
References: <444E114A.6040001@gmx.de> <444E4041.50304@huillard.net> <444F2B12.5040005@gmx.de> <200604261006.50159.laz@club-burniston.co.uk>
Message-ID: <1146048075.444f4e4b18190@webmail.in-berlin.de>

Quoting Laz <laz at club-burniston.co.uk>:

> On Wednesday 26 Apr 2006 09:10, Christian Kier wrote:
> > Nicolas Huillard wrote:
> > > If you don't mind keeping X, try the vdr-xine plugin, which can make
> > > use of XvMC.
> > > Laz is currently (I hope !) digging into hardware MPEG2 decoding
> > > using CLE266, found on EPIA M boards and others. Once this work, it
> > > could easily be ported to CN400. This enhancement would use the
> > > directfb output method of softdevice.
> > > If you can 1) wait a bit and test, and 2) remove you X dependency,
> > > that's a really good way to go. If you can help Laz in coding and
> > > debugging, it could also be really cool !
> >
> > 1) yes.
> > 2) yes, why not. I start X only for vdr (since I never used dfb
> > before).
>
> No 2 is why I much prefer the DirectFB method to using X!
>
> :)
>
> > Laz, are you still on this topic? Then tell me how I can help you.
>
> Nothing really to report yet: I now have a working-ish version of
> libsoftmpeg which uses the hardware decoder. It no longer needs to have
> things running as root (which is always nice!) and I eventually got it
> working with the demo app (plays back an MPEG2-TS file), albeit quite
> jerkily!

Can you show us your modifications so we can see how to modify
softdevice ?

>
> I'll need to do a bit more testing with this and then I'll try to work it
> into an output method for softdevice.
>
> I doubt I'll get much done before the weekend, though...
>

I think we should get softdevice 0.2.3 this weekend (sunday evening
after first test with vdr-1.4.0).


After that we could try to integrate that xvmc into softdevice.


Stefan Lucke


From nicolas at huillard.net  Wed Apr 26 13:04:45 2006
From: nicolas at huillard.net (Nicolas Huillard)
Date: Wed, 26 Apr 2006 13:04:45 +0200
Subject: [Softdevice-devel] XvMC support
In-Reply-To: <200604261135.03615.laz@club-burniston.co.uk>
References: <444E114A.6040001@gmx.de> <200604261006.50159.laz@club-burniston.co.uk> <444F446F.4000508@huillard.net> <200604261135.03615.laz@club-burniston.co.uk>
Message-ID: <444F53CD.2070407@huillard.net>

Laz a ?crit :
> I thought softplay was pretty much stand-alone and used ffmpeg to decode 
> stuff: softdevice also uses ffmpeg but only decodes MPEG streams.

Martin and Stefan could be more effective than me.
In my understanding, softplay uses livavformat to read files and feed
them to softdevice, which in turn uses libavcodec to decode and display
the stream.
libsoftmpeg should only handle the latter part, and be selected by
softdevice/directfb instead of libavcodec, when the stream is compatible
(ie. libsoftmpeg would play DVD, DVB, MPEG files)

-- 
NH


From laz at club-burniston.co.uk  Wed Apr 26 13:28:03 2006
From: laz at club-burniston.co.uk (Laz)
Date: Wed, 26 Apr 2006 12:28:03 +0100
Subject: [Softdevice-devel] XvMC support
In-Reply-To: <444F53CD.2070407@huillard.net>
References: <444E114A.6040001@gmx.de> <200604261135.03615.laz@club-burniston.co.uk> <444F53CD.2070407@huillard.net>
Message-ID: <200604261228.03911.laz@club-burniston.co.uk>

On Wednesday 26 Apr 2006 12:04, Nicolas Huillard wrote:
> Laz a ?crit :
> > I thought softplay was pretty much stand-alone and used ffmpeg to
> > decode stuff: softdevice also uses ffmpeg but only decodes MPEG
> > streams.
>
> Martin and Stefan could be more effective than me.
> In my understanding, softplay uses livavformat to read files and feed
> them to softdevice, which in turn uses libavcodec to decode and display
> the stream.
> libsoftmpeg should only handle the latter part, and be selected by
> softdevice/directfb instead of libavcodec, when the stream is
> compatible (ie. libsoftmpeg would play DVD, DVB, MPEG files)

Ahh...I was thinking that mpeg2decoder.c called something like 
avcodec_decode_mpeg but it is actually avcodec_decode_frame, i.e. any 
format (codec depending!). Just read the documentation for softplay. 

Ideally, what I'd want to do, then, is test whether the current stream is 
MPEG or not and if so (and the output method is something like 
dfb:cle266) send the data to my hardware decoding function, and then make 
sure the correct buffer gets flipped later on at the relevant time.

Cheers,

Laz


From seppo.ingalsuo at iki.fi  Wed Apr 26 17:57:34 2006
From: seppo.ingalsuo at iki.fi (Seppo Ingalsuo)
Date: Wed, 26 Apr 2006 18:57:34 +0300
Subject: [Softdevice-devel] ShmClient updated
In-Reply-To: <444E8221.7070307@gmx.net>
References: <444BDD7E.90503@gmx.net> <444E519D.6080002@iki.fi> <444E8221.7070307@gmx.net>
Message-ID: <444F986E.6090505@iki.fi>

Martin Wache wrote:

>The audio device is freed automatically when the ShmClient is closed.
>  
>
Yes, you are right. 50% of my wishes already filled :^)

>Lirc is not owned by the softdevice at all, I can't do much about that.
> The Xv-Port is as well released, so if I understand your request
>correctly everything (except lirc) is already like you are suggesting.
>  
>
Yes, the problem is that with softdevice vdr (or remote plugin) owns 
lirc.  In theory softdevice could implement remote plugin's lirc 
functionality or somehow enable and disable lirc but that would 
naturally be a bigger change that quite likely wouldn't be interesting 
for softdevice users who run fb version of softdevice.

Anyway with VDR responding to lirc all the time I would need to be more 
careful in hiding the remote from my kids :^)

>Yes, that would be nice. Unfortunately we need access to keypress events
>for doing this, and this is not easily possible with vdr at the moment.
>
>It's been a long time since I last used lirc, but isn't it possible to
>execute commands on keypress? A 'killall ShmClient' should do the job...
>  
>
That idea could work but last time when I tried I could not have two 
simultaneous lirc clients. However I might have done something wrong.

Seppo



From laz at club-burniston.co.uk  Wed Apr 26 18:12:50 2006
From: laz at club-burniston.co.uk (Laz)
Date: Wed, 26 Apr 2006 17:12:50 +0100
Subject: [Softdevice-devel] Actual format of data passed to avcodec_decode_video() in mpeg2decoder.c...
Message-ID: <200604261712.51314.laz@club-burniston.co.uk>

Hi,

I'm working on incorporating hardware MPEG decoding for the Via CLE266 
into softdevice. The simplest way would be to replace the call to 
avcodec_decode_video() at mpeg2decoder.c:570 with a replacement which 
does the equivalent in hardware (and then grab the relevant data back to 
the relevant DirectFB video surface for eventual display). I'm hoping to 
use libsoftmpeg for this but I need to work out 'how deep' into the 
library I can go.

Obviously, I can avoid any A-V sync bits in libsoftmpeg because softdevice 
keeps track of that itself. However, I need to work out the form of an 
MPEG stream that currently gets passed to avcodec_decode_video(). Much 
quicker to ask than try to work it out for myself and get it wrong!

;)

Is it MPEG PES complete with audio, or is it just an MPEG ES stream by 
this point? (Obviously, I'll have to check for different types of streams 
sent by softplay, etc.). I.e. do I need to worry about audio in the 
stream or not!

Cheers,

Laz


From marko.makela at hut.fi  Wed Apr 26 22:28:51 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 26 Apr 2006 23:28:51 +0300
Subject: [Softdevice-devel] video-dfb.c -r1.54 removes RCU support?
In-Reply-To: <444E951B.6070706@gmx.net>
References: <20060423205659.GB4032@localhost.localdomain> <20060424185527.GB3939@localhost.localdomain> <200604250700.38150.stefan@lucke.in-berlin.de> <20060425144829.GA7401@localhost.localdomain> <444E3EFD.2050307@huillard.net> <444E854C.7040007@gmx.net> <20060425203439.GB3679@localhost.localdomain> <444E951B.6070706@gmx.net>
Message-ID: <20060426202851.GA3655@localhost.localdomain>

On Tue, Apr 25, 2006 at 11:31:07PM +0200, Martin Wache wrote:
> > I didn't claim that you removed dfbRemote.  I merely suggested that it be
> > done, because as of video-dfb.c -r1.54, no DirectFB remote events are
> > reported to VDR.
> > 
> I did test video-dfb, for me the remote works just like before. Is there
> anybody else who has problems with the dfb-remote?

I did several tests with video-dfb.c -r1.53 and -r1.54, and the RCU would
only work with -r1.53.  I'm afraid I don't have time to repeat the tests
until weekend (which is when I guess you'd be releasing softdevice).

> > Then what do you think about Nicolas' suggestion:
> > 
> >>> The CropModeToggleKey could still be handled by subclassing the real
> >>> remote class or creating an event handler for keypresses.
> 
> I'm not sure if that can be done. If one uses the vdr-remote plugin
> there is (to my knowledge) no way how the softdevice can have access to
> keypress events, except of course if we patch the vdr.

You're probably right.  One option could be to patch the vdr-remote plugin
and use the inter-plugin service interface to report special keys to
softdevice.

> Maybe we should ask for the possibility of receiving keypresses for
> plugins at the vdr mailing list, if vdr would implement such a feature
> we could simply use that.

Yes, it could be something for vdr 1.5.x.

	Marko


From stefan at lucke.in-berlin.de  Wed Apr 26 23:45:19 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 26 Apr 2006 23:45:19 +0200
Subject: [Softdevice-devel] video-dfb.c -r1.54 removes RCU support?
In-Reply-To: <20060426202851.GA3655@localhost.localdomain>
References: <20060423205659.GB4032@localhost.localdomain> <444E951B.6070706@gmx.net> <20060426202851.GA3655@localhost.localdomain>
Message-ID: <200604262345.19246.stefan@lucke.in-berlin.de>

On Mittwoch 26 April 2006 22:28, Marko M?kel? wrote:
> On Tue, Apr 25, 2006 at 11:31:07PM +0200, Martin Wache wrote:
> > > I didn't claim that you removed dfbRemote.  I merely suggested that it be
> > > done, because as of video-dfb.c -r1.54, no DirectFB remote events are
> > > reported to VDR.
> > > 
> > I did test video-dfb, for me the remote works just like before. Is there
> > anybody else who has problems with the dfb-remote?
> 
> I did several tests with video-dfb.c -r1.53 and -r1.54, and the RCU would
> only work with -r1.53.  I'm afraid I don't have time to repeat the tests
> until weekend (which is when I guess you'd be releasing softdevice).
> 

On Montag 24 April 2006 20:55, Marko M?kel? wrote:
> On Sun, Apr 23, 2006 at 11:56:59PM +0300, Marko M?kel? wrote:
> > I'm using the bundled remote control unit of the Hauppauge Nova-T PCI 90002
> > via the following software stack:
> > 
> >  cx88-input.c in Linux 2.6.16.9
> >  libdirectfb_linux_input
> >  video-dfb.c in softdevice
> >  vdr 1.3.48
> > 
> > Martin, how should I connect the RCU to VDR from now on?  I'd prefer not
> > to install another plugin (vdr-remote?).
> 
> Okay, I see that the current version still constructs
> dfbRemote = new cSoftRemote ("softdevice-dfb");
> but somehow it will deliver no events.  I added the line
> disable-module=linux_input
> to /etc/directfbrc and installed vdr-remote-0.3.6.  This has

Did you reenable linux_input in your /etc/directfbrc ?


-- 
Stefan Lucke


From M.Wache at gmx.net  Thu Apr 27 00:00:17 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 27 Apr 2006 00:00:17 +0200
Subject: [Softdevice-devel] Actual format of data passed to avcodec_decode_video()
 in mpeg2decoder.c...
In-Reply-To: <200604261712.51314.laz@club-burniston.co.uk>
References: <200604261712.51314.laz@club-burniston.co.uk>
Message-ID: <444FED71.9090504@gmx.net>

Laz schrieb:
> Hi,
> 
> I'm working on incorporating hardware MPEG decoding for the Via CLE266 
> into softdevice. The simplest way would be to replace the call to 
> avcodec_decode_video() at mpeg2decoder.c:570 with a replacement which 
> does the equivalent in hardware (and then grab the relevant data back to 
> the relevant DirectFB video surface for eventual display). I'm hoping to 
> use libsoftmpeg for this but I need to work out 'how deep' into the 
> library I can go.

It would be great if that would work like this. Maybe we can even do
some postprocessing on it ;-)

> 
> Obviously, I can avoid any A-V sync bits in libsoftmpeg because softdevice 
> keeps track of that itself. However, I need to work out the form of an 
> MPEG stream that currently gets passed to avcodec_decode_video(). Much 
> quicker to ask than try to work it out for myself and get it wrong!
> 
> ;)
> 
> Is it MPEG PES complete with audio, or is it just an MPEG ES stream by 
> this point? (Obviously, I'll have to check for different types of streams 
> sent by softplay, etc.). I.e. do I need to worry about audio in the 
> stream or not!
> 
You don't need to worry about the audio.
The softdevice gets PES from Vdr, and the PES packets are parsed by
libavformat. So what is fed into avcodec_decode_video() is whatever is
inside of the PES stream video stream (maybe ES, I forgot, it some time
since I wrote this :-(). You don't have to worry about different streams
if you are replacing avcodec_decode_video() only if context->codec_id
==CODEC_ID_MPEG2VIDEO.
Like that we could simple switch the decoders for mpeg2 and for other
than mpeg2 we could use the softdevice like it is now.
But I think these are problems which can be solved later.

Bye,
Martin


From nicolas at huillard.net  Thu Apr 27 09:04:13 2006
From: nicolas at huillard.net (Nicolas Huillard)
Date: Thu, 27 Apr 2006 09:04:13 +0200
Subject: [Softdevice-devel] Actual format of data passed to avcodec_decode_video()
 in mpeg2decoder.c...
In-Reply-To: <200604261712.51314.laz@club-burniston.co.uk>
References: <200604261712.51314.laz@club-burniston.co.uk>
Message-ID: <44506CED.7080507@huillard.net>

Laz a ?crit :
> Hi,
> 
> I'm working on incorporating hardware MPEG decoding for the Via CLE266 
> into softdevice. The simplest way would be to replace the call to 
> avcodec_decode_video() at mpeg2decoder.c:570 with a replacement which 
> does the equivalent in hardware (and then grab the relevant data back to 
> the relevant DirectFB video surface for eventual display). I'm hoping to 
> use libsoftmpeg for this but I need to work out 'how deep' into the 
> library I can go.

libsoftmpeg is actually made up of a software decoder (ffmpeg ?) and a
patch from Collin that added hardware decoding to it. Maybe you don't
need to go deep inside the lib (top-down), but just inside the patch
(bottom-up) (I think it is the libcle266mpeg/ directory in the tar i
sent you) ?

-- 
NH


From marko.makela at hut.fi  Thu Apr 27 09:24:30 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 27 Apr 2006 10:24:30 +0300
Subject: [Softdevice-devel] video-dfb.c -r1.54 removes RCU support?
In-Reply-To: <200604262345.19246.stefan@lucke.in-berlin.de>
References: <20060423205659.GB4032@localhost.localdomain> <444E951B.6070706@gmx.net> <20060426202851.GA3655@localhost.localdomain> <200604262345.19246.stefan@lucke.in-berlin.de>
Message-ID: <20060427072430.GA3948@localhost.localdomain>

On Wed, Apr 26, 2006 at 11:45:19PM +0200, Stefan Lucke wrote:
> > Okay, I see that the current version still constructs
> > dfbRemote = new cSoftRemote ("softdevice-dfb");
> > but somehow it will deliver no events.  I added the line
> > disable-module=linux_input
> > to /etc/directfbrc and installed vdr-remote-0.3.6.  This has
> 
> Did you reenable linux_input in your /etc/directfbrc ?

No, I'll keep using vdr-remote for the time being.

I didn't touch any DirectFB settings when I tried to get the softdevice-dfb
remote to work.  I switched at least two times between the old and new
video-dfb.[ch], and the result was consistent: no RCU events would be
delivered with the new video-dfb.c.

	Marko


From stefan at lucke.in-berlin.de  Thu Apr 27 09:56:27 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 27 Apr 2006 09:56:27 +0200
Subject: [Softdevice-devel] video-dfb.c -r1.54 removes RCU support?
In-Reply-To: <20060427072430.GA3948@localhost.localdomain>
References: <20060423205659.GB4032@localhost.localdomain> <444E951B.6070706@gmx.net> <20060426202851.GA3655@localhost.localdomain> <200604262345.19246.stefan@lucke.in-berlin.de> <20060427072430.GA3948@localhost.localdomain>
Message-ID: <1146124587.4450792bde709@webmail.in-berlin.de>

Quoting Marko M?kel? :

> On Wed, Apr 26, 2006 at 11:45:19PM +0200, Stefan Lucke wrote:
> > > Okay, I see that the current version still constructs
> > > dfbRemote = new cSoftRemote ("softdevice-dfb");
> > > but somehow it will deliver no events.  I added the line
> > > disable-module=linux_input
> > > to /etc/directfbrc and installed vdr-remote-0.3.6.  This has
> >
> > Did you reenable linux_input in your /etc/directfbrc ?
>
> No, I'll keep using vdr-remote for the time being.

Was a bit silly of me. As you said it works with 1.53 you should
get those events with current version too. Your problem must be
something different.

>
> I didn't touch any DirectFB settings when I tried to get the softdevice-dfb
> remote to work.  I switched at least two times between the old and new
> video-dfb.[ch], and the result was consistent: no RCU events would be
> delivered with the new video-dfb.c.

Did you replace only video-dfb.c revisions ?
That should not work, as ProcessEvents() is now triggered in video.c .

Stefan Lucke


From laz at club-burniston.co.uk  Thu Apr 27 13:13:47 2006
From: laz at club-burniston.co.uk (Laz)
Date: Thu, 27 Apr 2006 12:13:47 +0100
Subject: [Softdevice-devel] Actual format of data passed to avcodec_decode_video() in mpeg2decoder.c...
In-Reply-To: <44506CED.7080507@huillard.net>
References: <200604261712.51314.laz@club-burniston.co.uk> <44506CED.7080507@huillard.net>
Message-ID: <200604271213.48223.laz@club-burniston.co.uk>

On Thursday 27 Apr 2006 08:04, Nicolas Huillard wrote:
> Laz a ?crit :
> > Hi,
> >
> > I'm working on incorporating hardware MPEG decoding for the Via
> > CLE266 into softdevice. The simplest way would be to replace the call
> > to avcodec_decode_video() at mpeg2decoder.c:570 with a replacement
> > which does the equivalent in hardware (and then grab the relevant
> > data back to the relevant DirectFB video surface for eventual
> > display). I'm hoping to use libsoftmpeg for this but I need to work
> > out 'how deep' into the library I can go.
>
> libsoftmpeg is actually made up of a software decoder (ffmpeg ?) and a
> patch from Collin that added hardware decoding to it. Maybe you don't
> need to go deep inside the lib (top-down), but just inside the patch
> (bottom-up) (I think it is the libcle266mpeg/ directory in the tar i
> sent you) ?

Yes: that's pretty much it. I think I'll try to create a library that does 
full decoding and display of an MPEG stream, i.e. 'a playback library' 
but make it so that it is possible to call just the decoding sections as 
well, so that audio and A-V sync can be handled elsewhere if needed. This 
will probably be more useful than a much simpler 'feed in encoded video 
and get out decoded frames' sort of library.

The libcle266mpeg directory is pretty much straight from mtest.

Cheers,

Laz


From juniper81 at gmail.com  Thu Apr 27 19:41:24 2006
From: juniper81 at gmail.com (Ari Koponen)
Date: Thu, 27 Apr 2006 20:41:24 +0300
Subject: DirectFB downscaling (WAS: Re: [Softdevice-devel] From todays changelog)
In-Reply-To: <200604221111.57846.stefan@lucke.in-berlin.de>
References: <200604221111.57846.stefan@lucke.in-berlin.de>
Message-ID: <b7bb36410604271041ga147e02u47b4a46579083fd7@mail.gmail.com>

Hi,

I also see this down scaling problem on mgatv very annoying.

> But before pushing that again on directfb lists, I have to test Ville's
> modifications he suggested in this thread (long time ago too):
>
> Or has anyone tried his patches from?
> http://mail.directfb.org/pipermail/directfb-dev/2005-October/000846.html
>

I tried but the patches failed, although it's been a while so I don't
remember very well the details. I wonder what kernel they were tried
on? Although it might have failed because, my matroxfb is already
patched with the full memory patch. If I remember correctly, I had
even bigger problems merging the patches to the DirectFB than to the
kernel.


From stefan at lucke.in-berlin.de  Thu Apr 27 22:34:11 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 27 Apr 2006 22:34:11 +0200
Subject: DirectFB downscaling (WAS: Re: [Softdevice-devel] From todays changelog)
In-Reply-To: <b7bb36410604271041ga147e02u47b4a46579083fd7@mail.gmail.com>
References: <200604221111.57846.stefan@lucke.in-berlin.de> <b7bb36410604271041ga147e02u47b4a46579083fd7@mail.gmail.com>
Message-ID: <200604272234.11333.stefan@lucke.in-berlin.de>

On Donnerstag 27 April 2006 19:41, Ari Koponen wrote:
> Hi,
> 
> I also see this down scaling problem on mgatv very annoying.
> 
> > But before pushing that again on directfb lists, I have to test Ville's
> > modifications he suggested in this thread (long time ago too):
> >
> > Or has anyone tried his patches from?
> > http://mail.directfb.org/pipermail/directfb-dev/2005-October/000846.html
> >
> 
> I tried but the patches failed, although it's been a while so I don't
> remember very well the details. I wonder what kernel they were tried
> on? Although it might have failed because, my matroxfb is already
> patched with the full memory patch. If I remember correctly, I had
> even bigger problems merging the patches to the DirectFB than to the
> kernel.

I just tried the patches, in the DirectFB part there were some conflicts
and I don't know if my handling of that additional argument is allways
correct as the visible effect is somehow jerky as there are some
pictures repeated or lost (every few seconds).

The cpu load is rather reduced.


From marko.makela at hut.fi  Thu Apr 27 23:07:59 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 28 Apr 2006 00:07:59 +0300
Subject: [Softdevice-devel] video-dfb.c -r1.54 removes RCU support?
In-Reply-To: <1146124587.4450792bde709@webmail.in-berlin.de>
References: <20060423205659.GB4032@localhost.localdomain> <444E951B.6070706@gmx.net> <20060426202851.GA3655@localhost.localdomain> <200604262345.19246.stefan@lucke.in-berlin.de> <20060427072430.GA3948@localhost.localdomain> <1146124587.4450792bde709@webmail.in-berlin.de>
Message-ID: <20060427210759.GB3506@localhost.localdomain>

On Thu, Apr 27, 2006 at 09:56:27AM +0200, Stefan Lucke wrote:
> > I didn't touch any DirectFB settings when I tried to get the softdevice-dfb
> > remote to work.  I switched at least two times between the old and new
> > video-dfb.[ch], and the result was consistent: no RCU events would be
> > delivered with the new video-dfb.c.
> 
> Did you replace only video-dfb.c revisions ?
> That should not work, as ProcessEvents() is now triggered in video.c .

I replaced only video-dfb.c and video-dfb.h, as far as I remember.  It
could be that I was using an older (somehow mismatching) version of video.c.
When I first tried to compile after cvs update, it failed.  Another cvs
update fetched some further changes, and the compilation succeeded.

I will try to test the dfb remote during the weekend, so that this issue
can be put to rest.

	Marko


From admin at berlios.de  Thu Apr 27 22:29:22 2006
From: admin at berlios.de (admin at berlios.de)
Date: Thu, 27 Apr 2006 22:29:22 +0200 (CEST)
Subject: [Softdevice-devel] [Feature #1942] audio-out: internal mute
Message-ID: <200604272029.k3RKTM4P005425@unicorn.berlios.de>

Feature Request #1942, was updated on 2006-Mar-06 16:20
You can respond by visiting: 
http://developer.berlios.de/feature/?func=detailfeature&feature_id=1942&group_id=2051

Category: None
Status: Closed
Priority: 5
Summary: audio-out: internal mute

By: wachm
Date: 2006-Apr-27 22:29

Message:
Logged In: YES 
user_id=11379
Browser: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.7.10) Gecko/20050917 Firefox/1.0.6

By default the softdevice now no longer changes the
alsa-mixer settings on volume change.

----------------------------------------------------------------------

By: tagore
Date: 2006-Mar-06 16:20

Message:
Logged In: YES 
user_id=14338
Browser: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.7.9) Gecko/20050711 Firefox/1.0.5

muting softdevice mutes the Alsa-PCM-Channel.
It would be nice if  the muting-function was realized
internally (like in xine) not manipiulating the global
mixer-channels.


Perhaps this is a bit particular, but still: I changed
to CCRMA-Fedora to make music. This involves
low-latency-soundserver jack.  Jack is presently not
compatible with dmix-plugin for alsa.  But dmix was my
workaround to to mute vdr while running another
sound-application.

Thanks
  Tagore

----------------------------------------------------------------------
You can respond by visiting: 
http://developer.berlios.de/feature/?func=detailfeature&feature_id=1942&group_id=2051


From stefan at lucke.in-berlin.de  Fri Apr 28 20:49:11 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 28 Apr 2006 20:49:11 +0200
Subject: [Softdevice-devel] [PATCH] softplay build fix for vdr 1.3.48 ++
Message-ID: <200604282049.11146.stefan@lucke.in-berlin.de>

Hi,

here is a Makefile fix for vdr versions >= 1.3.48 .
Testet with vdr-1.3.49 .

-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: softplay-vdr-1.4.diff
Type: text/x-diff
Size: 2319 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060428/d0a50df4/attachment.diff>

From marko.makela at hut.fi  Fri Apr 28 22:06:57 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 28 Apr 2006 23:06:57 +0300
Subject: [Softdevice-devel] video-dfb.c -r1.54 removes RCU support?
In-Reply-To: <20060427210759.GB3506@localhost.localdomain>
References: <20060423205659.GB4032@localhost.localdomain> <444E951B.6070706@gmx.net> <20060426202851.GA3655@localhost.localdomain> <200604262345.19246.stefan@lucke.in-berlin.de> <20060427072430.GA3948@localhost.localdomain> <1146124587.4450792bde709@webmail.in-berlin.de> <20060427210759.GB3506@localhost.localdomain>
Message-ID: <20060428200657.GA6537@localhost.localdomain>

On Fri, Apr 28, 2006 at 12:07:59AM +0300, Marko M?kel? wrote:
> On Thu, Apr 27, 2006 at 09:56:27AM +0200, Stefan Lucke wrote:
> > > I didn't touch any DirectFB settings when I tried to get the softdevice-dfb
> > > remote to work.  I switched at least two times between the old and new
> > > video-dfb.[ch], and the result was consistent: no RCU events would be
> > > delivered with the new video-dfb.c.
> > 
> > Did you replace only video-dfb.c revisions ?
> > That should not work, as ProcessEvents() is now triggered in video.c .
> 
> I replaced only video-dfb.c and video-dfb.h, as far as I remember.  It
> could be that I was using an older (somehow mismatching) version of video.c.  > When I first tried to compile after cvs update, it failed.  Another cvs
> update fetched some further changes, and the compilation succeeded.
> 
> I will try to test the dfb remote during the weekend, so that this issue
> can be put to rest.

The remote works with softdevice CVS as of now and vdr 1.3.49.  Last time
I tested, the CVS repository probably was in an inconsistent state.
(Any plans of switching to Subversion or some other revision control system
where commits are atomic?)

In fact, I had to revert to using the softdevice-dfb remote, because
vdr-remote-0.3.6 maps key-repeat events to key-press.  I didn't notice,
because I usually press the buttons for less than 0.1 seconds, but my
family had trouble with it.  As the logic in vdr-remote looked complex,
I didn't try to fix it.

The only issue I have with the softdevice-dfb remote is that DirectFB
performs a many-to-one mapping of keycodes, making the ">|" and "|<"
buttons on the new Hauppauge remote inaccessible.  I wonder if it would
make sense to implement a direct <linux/input.h> interface to video.c.
All RCUs bundled with DVB tuner cards are using that interface, right?

	Marko


From laz at club-burniston.co.uk  Sat Apr 29 19:56:28 2006
From: laz at club-burniston.co.uk (Laz)
Date: Sat, 29 Apr 2006 18:56:28 +0100
Subject: [Softdevice-devel] CLE266 hardware decoding...
Message-ID: <200604291856.28488.laz@club-burniston.co.uk>

I'm getting there...

:)

I now have softdevice decoding using the hardware decoder and I have a 
picture! Currently, the image only fills a quarter of the screen and the 
sound seems to have gone quiet for some bizarre reason!

I'm ignoring any image sizes at the moment so everything is hard-coded to 
720x576, and I'm totally ignoring any of the image cropping and scaling 
parts. I'm blitting decoded frames directly from a decoder buffer to the 
video surface and they both claim to be the same size, so I'm not sure why I 
only get video on the top left quarter of the screen! The OSD layer fills the 
screen, though.

Any thoughts?

Apart from this, it looks like its going well: my CPU usage used to be ca. 
70-80% using software decoding. It's now down to about 35%.

I think the code needs a bit more of a tidy before I post any patches.

Cheers,

Laz


From torgeir at pobox.com  Sat Apr 29 20:20:10 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Sat, 29 Apr 2006 20:20:10 +0200
Subject: [Softdevice-devel] CLE266 hardware decoding...
In-Reply-To: <200604291856.28488.laz@club-burniston.co.uk>
References: <200604291856.28488.laz@club-burniston.co.uk>
Message-ID: <1146334810.13609.0.camel@localhost>

On Sat, 2006-04-29 at 18:56 +0100, Laz wrote:
> 
> Apart from this, it looks like its going well: my CPU usage used to be
> ca. 70-80% using software decoding. It's now down to about 35%. 

Which EPIA board is this with?

-- 
Torgeir Veimo <torgeir at pobox.com>



From laz at club-burniston.co.uk  Sat Apr 29 21:34:24 2006
From: laz at club-burniston.co.uk (Laz)
Date: Sat, 29 Apr 2006 20:34:24 +0100
Subject: [Softdevice-devel] CLE266 hardware decoding...
In-Reply-To: <1146334810.13609.0.camel@localhost>
References: <200604291856.28488.laz@club-burniston.co.uk> <1146334810.13609.0.camel@localhost>
Message-ID: <200604292034.24217.laz@club-burniston.co.uk>

On Saturday 29 April 2006 19:20, Torgeir Veimo wrote:
> On Sat, 2006-04-29 at 18:56 +0100, Laz wrote:
> > Apart from this, it looks like its going well: my CPU usage used to be
> > ca. 70-80% using software decoding. It's now down to about 35%.
>
> Which EPIA board is this with?

This is on an Epia MII 12000 with TV-out.

Cheers,

Laz


From marko.makela at hut.fi  Sat Apr 29 21:46:27 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sat, 29 Apr 2006 22:46:27 +0300
Subject: [Softdevice-devel] dfb:mgatv screen not blanked when playing audio-only program
Message-ID: <20060429194627.GA3525@localhost.localdomain>

On DirectFB VGA output, the screen at least used to be blanked after a
few seconds when playing an audio-only (radio) program.  On dfb:mgatv,
this does not appear to be the case: the frame buffer will not be blanked
even after a minute of playing radio.

I'm using vdr 1.4.0 prerelease and softdevice CVS.

	Marko


From stefan at lucke.in-berlin.de  Sat Apr 29 22:27:35 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 29 Apr 2006 22:27:35 +0200
Subject: [Softdevice-devel] dfb:mgatv screen not blanked when playing audio-only program
In-Reply-To: <20060429194627.GA3525@localhost.localdomain>
References: <20060429194627.GA3525@localhost.localdomain>
Message-ID: <200604292227.35173.stefan@lucke.in-berlin.de>

On Samstag 29 April 2006 21:46, Marko M?kel? wrote:
> On DirectFB VGA output, the screen at least used to be blanked after a
> few seconds when playing an audio-only (radio) program.  On dfb:mgatv,
> this does not appear to be the case: the frame buffer will not be blanked
> even after a minute of playing radio.

Try cvs update. Has been introduced by dfb OSD responsivness fix.

> 
> I'm using vdr 1.4.0 prerelease and softdevice CVS.
> 
> 	Marko

-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Sat Apr 29 22:51:57 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 29 Apr 2006 22:51:57 +0200
Subject: [Softdevice-devel] CLE266 hardware decoding...
In-Reply-To: <200604291856.28488.laz@club-burniston.co.uk>
References: <200604291856.28488.laz@club-burniston.co.uk>
Message-ID: <200604292251.57293.stefan@lucke.in-berlin.de>

On Samstag 29 April 2006 19:56, Laz wrote:
> 
> I'm getting there...
> 
> :)
> 
> I now have softdevice decoding using the hardware decoder and I have a 
> picture! Currently, the image only fills a quarter of the screen and the 
> sound seems to have gone quiet for some bizarre reason!
> 
> I'm ignoring any image sizes at the moment so everything is hard-coded to 
> 720x576, and I'm totally ignoring any of the image cropping and scaling 
> parts. I'm blitting decoded frames directly from a decoder buffer to the 
> video surface and they both claim to be the same size, so I'm not sure why I 
> only get video on the top left quarter of the screen! The OSD layer fills the 
> screen, though.
> 
> Any thoughts?

Show us the code, and perhaps some thoughts may come.

Especially I'm interested in the interfacing code for mpeg2decoder.c as
I'll try to use xvmc within X11 on my epia board too. So interfaceing should
be the same. That could offer a way to another subplugin too which could
a combined network audio/video device.

> 
> Apart from this, it looks like its going well: my CPU usage used to be ca. 
> 70-80% using software decoding. It's now down to about 35%.
> 
> I think the code needs a bit more of a tidy before I post any patches.
> 
> Cheers,
> 
> Laz

-- 
Stefan Lucke


From ollo.diab at gmx.de  Sun Apr 30 10:55:55 2006
From: ollo.diab at gmx.de (Thomas Herrmann)
Date: Sun, 30 Apr 2006 10:55:55 +0200 (MEST)
Subject: [Softdevice-devel] CLE266 hardware decoding...
References: <200604292251.57293.stefan@lucke.in-berlin.de>
Message-ID: <11488.1146387355@www051.gmx.net>

Hi everybody,

I just want to mention the software "mpeg2play_accel" which supports XVMC -
at least on my Nvidia - nicely. Maybe it's worth to take a look:

http://www.xfree86.org/~mvojkovi/mpeg2play_accel.tar.gz

Regards,   Thomas



-- 
GMX Produkte empfehlen und ganz einfach Geld verdienen!
Satte Provisionen f?r GMX Partner: http://www.gmx.net/de/go/partner


From laz at club-burniston.co.uk  Sun Apr 30 11:41:26 2006
From: laz at club-burniston.co.uk (Laz)
Date: Sun, 30 Apr 2006 10:41:26 +0100
Subject: [Softdevice-devel] Patch: cle266 hardware decoding...
Message-ID: <200604301041.26837.laz@club-burniston.co.uk>

Right...here is a first attempt at a patch which incorporates hardware 
decoding into softdevice on via cle266 chipsets. It's a bit hacked together 
and requires a lot more work but as a first point it seems to work mostly.

Prerequisites: libcle266decode (see below for link), the library which 
provides the decoder access.

viafb: I'm using linux-viafb from DirectFB cvs from 18/4/06. My version 
includes Mark Adams' field sync patch. Not sure whether this would work with 
any other viafb. Probably not.

DirectFB and DFB++: both need patching with patches supplied in 
libcle266decode tarball (DFB++ one needs applying by hand at present but it 
involves adding about 2 lines: will fix at some point!). I'm using DirectFB 
and DFB++ from cvs on the 18/4/06 (not sure if anything drastic has changed 
since then). I've also patched with Mark Adams' field sync patch.

The patch is against softdevice cvs from 28/4/06. You will probably have to 
add -lcle266decode to the Makefile or config.mak. I have tried to enclose all 
of my additions in #ifdefs so you will also need to add -DCLE266HW to the 
Makefile. I think the only place where I didn't enclose with an #ifdef was in 
cDFBVideoOut::YUV because the compiler didn't like having #ifdefs within the 
try {} catch {} structures: they are there but commented out!

;)

Hopefully, the plugin should behave as normal unless it is called as 
-P'softdevice -vo dfb:cle266' Only MPEG-2 video is sent to the hardware 
decoder: anything else should still be decoded by ffmpeg, so things like 
softplay should hopefully work still (not tried yet!).

At present, this also enables viatv because I'm using TV-out for this.

At present, I get a smooth picture on my TV but it only occupies the top-left 
quarter of the screen! Total CPU usage has dropped from ca. 70-80% with 
software decoding to ca. 35% with my patch. It seems quite stable: it ran 
seamlessly over night without locking up.

The decoded frames end up in a DirectFB surface so I'm blitting these from 
here directly to the video surface, rather than copying to the avcodec 
structures. This means that there are some complaints where frame sizes are 
determined from the avcodec context (I commented out a few fprintfs from 
postprocessing steps)!

At the moment, this doesn't matter because I'm just blitting the whole frame 
rather than cropping, etc. This does mean that if, for example, the stream 
changes from 720x576 to 704x576, I end up with a strip of the previous few 
frames at the right-hand edge of my picture!

The video surface is forced to YV12 pixel format so that this blit can take 
place. N.B. I get a picture with swapped round red and blue (or something) if 
I select YV12 without the hardware decoding but then it has always been like 
that for me.

Patch:
http://vdr.club-burniston.co.uk/softdevice_cle266.diff

Decoder library:
http://vdr.club-burniston.co.uk/libcle266decode-0.1.tar.gz

This is looking quite promising but still needs a lot of work...

Current problem is trying to work out why I only get a quarter-sized 
frame...if anyone has any clues, please let me know! Both the decoded frame 
buffer and the video surface are 720x576 so I'm not sure why only a quarter 
gets filled with video. The OSD itself fills the screen!

Cheers,

Laz


From stefan at lucke.in-berlin.de  Sun Apr 30 12:53:06 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 30 Apr 2006 12:53:06 +0200
Subject: [Softdevice-devel] Patch: cle266 hardware decoding...
In-Reply-To: <200604301041.26837.laz@club-burniston.co.uk>
References: <200604301041.26837.laz@club-burniston.co.uk>
Message-ID: <200604301253.06606.stefan@lucke.in-berlin.de>

On Sonntag 30 April 2006 11:41, Laz wrote:
> 
> Right...here is a first attempt at a patch which incorporates hardware 
> decoding into softdevice on via cle266 chipsets. It's a bit hacked together 
> and requires a lot more work but as a first point it seems to work mostly.
> 
> Prerequisites: libcle266decode (see below for link), the library which 
> provides the decoder access.
> 
> viafb: I'm using linux-viafb from DirectFB cvs from 18/4/06. My version 
> includes Mark Adams' field sync patch. Not sure whether this would work with 
> any other viafb. Probably not.
> 
> DirectFB and DFB++: both need patching with patches supplied in 
> libcle266decode tarball (DFB++ one needs applying by hand at present but it 
> involves adding about 2 lines: will fix at some point!). I'm using DirectFB 
> and DFB++ from cvs on the 18/4/06 (not sure if anything drastic has changed 
> since then). I've also patched with Mark Adams' field sync patch.
> 
> The patch is against softdevice cvs from 28/4/06. You will probably have to 
> add -lcle266decode to the Makefile or config.mak. I have tried to enclose all 
> of my additions in #ifdefs so you will also need to add -DCLE266HW to the 
> Makefile. I think the only place where I didn't enclose with an #ifdef was in 
> cDFBVideoOut::YUV because the compiler didn't like having #ifdefs within the 
> try {} catch {} structures: they are there but commented out!
> 
> ;)
> 
> Hopefully, the plugin should behave as normal unless it is called as 
> -P'softdevice -vo dfb:cle266' Only MPEG-2 video is sent to the hardware 
> decoder: anything else should still be decoded by ffmpeg, so things like 
> softplay should hopefully work still (not tried yet!).
> 
> At present, this also enables viatv because I'm using TV-out for this.
> 
> At present, I get a smooth picture on my TV but it only occupies the top-left 
> quarter of the screen! Total CPU usage has dropped from ca. 70-80% with 
> software decoding to ca. 35% with my patch. It seems quite stable: it ran 
> seamlessly over night without locking up.

Ups, top left corner ...

Can you try this after line 355 in video-dfb.c:

  if (desc.caps & DLCAPS_SCREEN_LOCATION)
  {
    try 
    {
       videoLayer->SetScreenLocation(0.0,0.0,0.5,0.5);
       videoLayer->SetScreenLocation(0.0,0.0,1.0,1.0);
    }
    catch (DFBException *ex)
    {
      fprintf (stderr, "[dfb] SetParams: action=%s, result=%s\n", ex->GetAction(), ex->GetResult());
      delete ex;
    }
  }

Perhaps SetParams() gets not called due to missing information
size/aspect ratio of decoded frames.


-- 
Stefan Lucke


From laz at club-burniston.co.uk  Sun Apr 30 15:04:16 2006
From: laz at club-burniston.co.uk (Laz)
Date: Sun, 30 Apr 2006 14:04:16 +0100
Subject: [Softdevice-devel] Patch: cle266 hardware decoding...
In-Reply-To: <200604301253.06606.stefan@lucke.in-berlin.de>
References: <200604301041.26837.laz@club-burniston.co.uk> <200604301253.06606.stefan@lucke.in-berlin.de>
Message-ID: <200604301404.16684.laz@club-burniston.co.uk>

On Sunday 30 April 2006 11:53, Stefan Lucke wrote:

{snip}

> Ups, top left corner ...
>
> Can you try this after line 355 in video-dfb.c:
>
>   if (desc.caps & DLCAPS_SCREEN_LOCATION)
>   {
>     try
>     {
>        videoLayer->SetScreenLocation(0.0,0.0,0.5,0.5);
>        videoLayer->SetScreenLocation(0.0,0.0,1.0,1.0);
>     }
>     catch (DFBException *ex)
>     {
>       fprintf (stderr, "[dfb] SetParams: action=%s, result=%s\n",
> ex->GetAction(), ex->GetResult()); delete ex;
>     }
>   }
>
> Perhaps SetParams() gets not called due to missing information
> size/aspect ratio of decoded frames.

Just tried your addition and it is the same, i.e. video is squidged into 
top-left corner. I think it must be down to the lack of frame information. If 
I look at the output, I see:

[dfb] width = 720, height = 576
[dfb] got fmt = 0x00418c04 bpp = 32
[dfb] Using this layer for OSD: (VIA CLE266 Graphics - [720x576])
[surface capabilities] osdSurface: videoonly double-buffered flipping
[surface capabilities] videoSurface: videoonly flipping triple-buffered
[dfb] Configuring CooperativeLevel for Overlay
[dfb] Configuring CooperativeLevel for OSD
[dfb] Using this layer for OSD: VIA CLE266 Graphics
[dfb] Using this layer for Video out: VIA Unichrome Video
[dfb] Display frame time is 19998 microseconds
[dfb] (re)configuring Videolayer to 720 x 576 (720x576)
[dfb] SetParams: Enabling DLOP_FIELD_PARITY
[surface capabilities] videoSurface: videoonly flipping triple-buffered
[dfb] (re)configured 0x0810060a
[softdevice] Video Out seems to be OK
[softdevice] Initializing Audio Out
[softdevice] Audio out seems to be OK
[softdevice] A/V devices initialized, now initializing MPEG2 Decoder
vdr: RADIO PLUGIN START
#[dfb] (re)configuring Videolayer to 0 x 0 (0x0)
[dfb] SetParams: Enabling DLOP_FIELD_PARITY
[dfb] SetParams: 
action=IDirectFBDisplayLayer::SetConfiguration(DFBDisplayLayerConfig&), 
result=Not supported!
[dfb] SetParams: action=IDirectFBDisplayLayer::SetScreenLocation(float, float, 
f
loat, float), result=Invalid argument!
[surface capabilities] videoSurface: videoonly flipping triple-buffered
[dfb] (re)configured 0x0810060a

I tried forcing fwidth, dwidth, fheight, and dheight to fixed values at the 
start of SetParams but it is still squashed into the corner. Bizarrely, that 
change makes the video flicker madly!

Do you think my best bet is setting the width and height values in the AVCodec 
context structure (even if just to fixed values for now)? What other bits 
would also need values elsewhere? I think I convinced myself that PTS values, 
etc. are set where the audio and video are separated, rather than during the 
frame decoding.

Cheers,

Laz


From stefan at lucke.in-berlin.de  Sun Apr 30 16:49:46 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 30 Apr 2006 16:49:46 +0200
Subject: [Softdevice-devel] [ANNOUNCE] vdr-softdevice-0.2.3
Message-ID: <200604301649.46396.stefan@lucke.in-berlin.de>

Hello,

softdevice team (Torgeir Veimo, Martin Wache and me, Stefan Lucke)
is pleased to announce a new release of vdr softdevice plugin.

General info:
  Softdevice plugin enables vdr to run on your desktop with
  so called budget cards. You'll get vdr output via framebuffer or X11-Xv or
  DirectFB or vidix to your screen. Decoding is done via ffmpeg.

Supported vdr versions: 1.2.x, 1.3.x and 1.4.0

Plugin's homepage is located at: http://softdevice.berlios.de/

Changelog since last release:
2006-04-30: softdevice-0.2.3
2006-04-29:
   - enable build of ShmClient and video-shm when possible.
   - disable interlaced vs. not-interlaced (progressive) reporting
     via syslog. it's changing in seconds intervall for some stations.
   - dfb: fix screen not blanked with audio only stream.
2006-04-27:
   - change volume handling to no longer change the alsa-mixer settings
   - fix black screen for some aspect ratios using ShmClient
2006-04-25:
   - fix ShmClient blank screen every 4s
2006-04-24:
   - xv + dfb: removed some unused code.
   - vidix + fb: adjusted to use videoInitialized.
   - call Initialize() after all video constructors.
   - dfb: OSD responsivness in paused mode.
2006-04-23:
   - added volume changing without changing the alsa-mixer control (to use it
     add -DNO_MIXER, currently experimental)
   - fix for vdr-1.3.48
   - remove duplicate remote code, call ProcessEvents() from the video thread
     and remove the RC thread
   - no longer link ShmClient to vdr objects
   - fix some includes
   - probably fix for processors not supporting mmx2
2006-04-21:
   - updated finnish translations (by Rolf Ahrenberg).
   - video-dfb: fix for crash at startup when software OSD blending was active.
   - video-xv: changed local flag initialized to videoInitialized of our super class.
2006-04-17:
   - cut away the left- and rightmost column of the osd
2006-04-14:
   - Expand top/bottom line and left/right coloumns (from vdr-portal).
   - Zoom feature, zoomed area may be shifted around.
   - yv12 -> yuy2 converter for field based chroma.
   - remember interlaced mode of current frame.
   - some preparations for some more XvImage formats (not yet selectable).
   - Restricted OSD alpha blend option to XV and VIDIX out.
   - started some documentation of our various OSD options.
   - applied patch for mono upmix from Lucian Muresan
2006-04-01:
   - applied Makefile patch from Antti Sepp?l?
   - apply slightly modified patch by Thomas G?nter which fixes improper
     includes of vdr header files
   - fix compilation without Xinerama support
2006-03-31:
   - Xinerama support (detection and build requires to run configure).
   - reactivate use of source x/y offsets for Xv*PutImage(..) operations.
2006-03-21:
   - remove the image copy overhead from the ShmClient
   - catch errors on osd and xv image creation
   - support for non-shared memory xv
2006-03-12:
   - Fix StillPicture handling when no PES header is sent
     (for example streamdev-server-plugin)
   - redraw video layer on OSD close in software mode
   - use OsdWidth and OsdHeight for drawing osd layer
2006-03-11:
   - MMX version of AYUV_to_AYUV420P()
   - shortcut for AYUV no scale OSD modes
2006-03-10:
   - tune some parameters to avoid unecessary rescaling/redrawing of the OSD
2006-02-19:
   - some german translations
   - fix compilation of shm-client
   - fix compilation of video-shm
2006-02-18:
   - fix OSD drawn at wrong location in software OSD blending mode when
     cropping is active
2006-02-17:
   - fix bug #6409 (OSD not refreshed fast enough in software OSD blending mode
     when video is paused)
   - fix crash / deadlocks at startup in 16:9 mode in software OSD blending mode

-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Mon May  1 09:10:39 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 1 May 2006 09:10:39 +0200
Subject: [Softdevice-devel] [ANNOUNCE] vdr-softdevice-0.2.3
In-Reply-To: <200604301649.46396.stefan@lucke.in-berlin.de>
References: <200604301649.46396.stefan@lucke.in-berlin.de>
Message-ID: <200605010910.40152.stefan@lucke.in-berlin.de>

Hello,

just replaced released tar file with vdr-softdevice-0.2.3a, as there
were two major bugs with configuring an compiling DirectFB output.
Sorry for inconvenience.

For getting fixes within this release, you could just type
'cvs update' within softdevice directory. By this update, you'll
stay in the cvs branch created for this release (branch: v023_fix).


Stefan Lucke


From marko.makela at hut.fi  Mon May  1 20:19:14 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 1 May 2006 21:19:14 +0300
Subject: [Softdevice-devel] dfb:mgatv screen not blanked when playing audio-only program
In-Reply-To: <200604292227.35173.stefan@lucke.in-berlin.de>
References: <20060429194627.GA3525@localhost.localdomain> <200604292227.35173.stefan@lucke.in-berlin.de>
Message-ID: <20060501181914.GA4228@localhost.localdomain>

On Sat, Apr 29, 2006 at 10:27:35PM +0200, Stefan Lucke wrote:
> On Samstag 29 April 2006 21:46, Marko M?kel? wrote:
> > On DirectFB VGA output, the screen at least used to be blanked after a
> > few seconds when playing an audio-only (radio) program.  On dfb:mgatv,
> > this does not appear to be the case: the frame buffer will not be blanked
> > even after a minute of playing radio.
> 
> Try cvs update. Has been introduced by dfb OSD responsivness fix.

Thanks, that fixed the bug.

	Marko


From stefan at lucke.in-berlin.de  Wed May  3 00:30:52 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 3 May 2006 00:30:52 +0200
Subject: [Softdevice-devel] Re: [Softdevice-cvs] How to change resolution
In-Reply-To: <44573AC3.7080807@saunalahti.fi>
References: <44573AC3.7080807@saunalahti.fi>
Message-ID: <200605030030.52202.stefan@lucke.in-berlin.de>

On Dienstag 02 Mai 2006 12:56, Mika Puska wrote:
> Im using Directfb and matroxTVout.
> How to change resolution from 720x576 to 768x576?
> Adjusting directfbrc does?t work?!?

TVout is limited to 720x576 for PAL and 720x480 for NTSC.
Why do you want to change that ?
TVs do not operate in square pixel mode.


-- 
Stefan Lucke


From admin at berlios.de  Wed May  3 00:46:56 2006
From: admin at berlios.de (admin at berlios.de)
Date: Tue, 2 May 2006 14:46:56 -0800 (AKDT)
Subject: [Softdevice-devel] [Bug #7365] Crash bei Kanalwechsel + ExpandBottomLines
Message-ID: <200605022246.k42MkuxJ029175@unicorn.berlios.de>

Bug #7365, was updated on 2006-May-02 14:46
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: None
Status: Open
Resolution: None
Bug Group: None
Priority: 5
Submitted by: daliman
Assigned to : none
Summary: Crash bei Kanalwechsel + ExpandBottomLines

Details: Wenn der Wert ExpandBottomLines erh?ht wurde und dannach mit den Cursortasten der Kanal gewechselt wird, crasht der VDR.

vdr-1.4 + BP + softdevice 0.2.3a & cvs update


For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=7365&group_id=2051


From admin at berlios.de  Wed May  3 08:03:12 2006
From: admin at berlios.de (admin at berlios.de)
Date: Wed, 3 May 2006 08:03:12 +0200 (CEST)
Subject: [Softdevice-devel] [Bug #7365] Crash bei Kanalwechsel + ExpandBottomLines
Message-ID: <200605030603.k4363CEh023421@unicorn.berlios.de>

Bug #7365, was updated on 2006-May-03 00:46
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: None
Status: Open
Resolution: None
Bug Group: None
Priority: 5
Submitted by: daliman
Assigned to : none
Summary: Crash bei Kanalwechsel + ExpandBottomLines

Details: Wenn der Wert ExpandBottomLines erh?ht wurde und dannach mit den Cursortasten der Kanal gewechselt wird, crasht der VDR.

vdr-1.4 + BP + softdevice 0.2.3a & cvs update


Follow-Ups:

Date: 2006-May-03 08:03
By: lucke

Comment:
Which output method do you use ?

From laz at club-burniston.co.uk  Wed May  3 10:51:10 2006
From: laz at club-burniston.co.uk (Laz)
Date: Wed, 3 May 2006 09:51:10 +0100
Subject: [Softdevice-devel] Patch: cle266 hardware decoding...
In-Reply-To: <200604301404.16684.laz@club-burniston.co.uk>
References: <200604301041.26837.laz@club-burniston.co.uk> <200604301253.06606.stefan@lucke.in-berlin.de> <200604301404.16684.laz@club-burniston.co.uk>
Message-ID: <200605030951.10192.laz@club-burniston.co.uk>

On Sunday 30 Apr 2006 14:04, Laz wrote:

> I tried forcing fwidth, dwidth, fheight, and dheight to fixed values at
> the start of SetParams but it is still squashed into the corner.
> Bizarrely, that change makes the video flicker madly!
>
> Do you think my best bet is setting the width and height values in the
> AVCodec context structure (even if just to fixed values for now)? What
> other bits would also need values elsewhere? I think I convinced myself
> that PTS values, etc. are set where the audio and video are separated,
> rather than during the frame decoding.

I've had a private email from Rolf Ahrenberg who got this working and had 
the same quarter-sized image. However, he tells me that setting 
"context->width = 720; context->height = 576;" around where the decoder 
is called gives a full-screen picture.

I haven't tested this yet but this is what I was going to try next! Not 
sure what happens like this if the stream changes resolution or aspect 
ratio, though! That's the next step...

:)

Cheers,

Laz


From nicolas at huillard.net  Thu May  4 13:39:29 2006
From: nicolas at huillard.net (Nicolas Huillard)
Date: Thu, 04 May 2006 13:39:29 +0200
Subject: [Softdevice-devel] Re: [vdr] view online trailers with VDR
In-Reply-To: <4459DFB4.8050900@calidae.net>
References: <4459D12F.1040106@calidae.net> <4459D1B1.7080603@calidae.net>	<4459D538.4060709@huillard.net> <4459DFB4.8050900@calidae.net>
Message-ID: <4459E7F1.1040901@huillard.net>

Leo M?rquez a ?crit :
> En/na Nicolas Huillard ha escrit:
>> Leo M?rquez a ?crit :
>>> As usually I answer myself.
>>> I supose that I want the vod (video on demand) plugin.
>> Can you provide an URL ?

I meant : the URL of the plugin itself, which I didn't know...

Here it is : http://famillejacques.free.fr/vdr/vod/

It seems to be what you're looking for.
It also seems that it could drive the softplay plugin as it does with
the mplayer plugin, with the "service" interface.

-- 
NH


From voitto.tuomainen at luukku.com  Thu May  4 22:37:01 2006
From: voitto.tuomainen at luukku.com (Voitto Tuomainen)
Date: Thu, 4 May 2006 23:37:01 +0300 (EEST)
Subject: [Softdevice-devel] softdevice-0-2.3a amd64 cSetupStore::CatchRemoteKey error
Message-ID: <1146775021758.voitto.tuomainen.98977.0jIZJg5Vwz2JgGwymyj1KQ@luukku.com>

Hi,
I tried to compile softdevice with my 64 bit gentoo
- gcc version 3.4.6 (Gentoo 3.4.6-r1, ssp-3.4.5-1.0, pie-8.7.9)

Compilation stops to an error:

setup-softdevice.c:412: error: prototype for `bool cSetupStore::CatchRemoteKey(const char*, uint64)' does not match any in class `cSetupStore'
setup-softdevice.h:117: error: candidate is: virtual bool cSetupStore::CatchRemoteKey(const char*, uint64_t)
make[1]: *** [setup-softdevice.o] Error 1
make[1]: Leaving directory `/usr/local/vdr/vdr-1.4.0/PLUGINS/src/softdevice-0.2.3a'


______
BR, Voitto Tuomainen

...................................................................
Luukku Plus paketilla p??set eroon tila- ja turvallisuusongelmista.
Hanki Luukku Plus ja helpotat el?m??si. http://www.mtv3.fi/luukku



From stefan at lucke.in-berlin.de  Thu May  4 23:40:22 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 4 May 2006 23:40:22 +0200
Subject: [Softdevice-devel] softdevice-0-2.3a amd64 cSetupStore::CatchRemoteKey error
In-Reply-To: <1146775021758.voitto.tuomainen.98977.0jIZJg5Vwz2JgGwymyj1KQ@luukku.com>
References: <1146775021758.voitto.tuomainen.98977.0jIZJg5Vwz2JgGwymyj1KQ@luukku.com>
Message-ID: <200605042340.22913.stefan@lucke.in-berlin.de>

On Donnerstag 04 Mai 2006 22:37, Voitto Tuomainen wrote:
> Hi,
> I tried to compile softdevice with my 64 bit gentoo
> - gcc version 3.4.6 (Gentoo 3.4.6-r1, ssp-3.4.5-1.0, pie-8.7.9)
> 
> Compilation stops to an error:
> 
> setup-softdevice.c:412: error: prototype for `bool cSetupStore::CatchRemoteKey(const char*, uint64)' does not match any in class `cSetupStore'
> setup-softdevice.h:117: error: candidate is: virtual bool cSetupStore::CatchRemoteKey(const char*, uint64_t)
> make[1]: *** [setup-softdevice.o] Error 1
> make[1]: Leaving directory `/usr/local/vdr/vdr-1.4.0/PLUGINS/src/softdevice-0.2.3a'

cd to softdevice-0.2.3a directory and do cvs update.


-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Fri May  5 23:59:52 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 5 May 2006 23:59:52 +0200
Subject: DirectFB downscaling (WAS: Re: [Softdevice-devel] From todays changelog)
In-Reply-To: <1145799555.27094.18.camel@localhost.localdomain>
References: <200604221111.57846.stefan@lucke.in-berlin.de> <1145799555.27094.18.camel@localhost.localdomain>
Message-ID: <200605052359.52422.stefan@lucke.in-berlin.de>

On Sonntag 23 April 2006 15:39, Malcolm Caldwell wrote:
> On Sat, 2006-04-22 at 11:11 +0200, Stefan Lucke wrote:
> > On Dienstag 18 April 2006 02:14, Malcolm Caldwell wrote:
> > > OK,
> > > 
> > > Since I am one of those not on the cvs list...
> > > 
> > > Has there been any work on the MGA TV non-field based StretchBlit bug?
> > No.
> > > If not is anyone working on it?
> > No.
> > 
> > I think your are referring to this thread on directfb-users:
> > http://mail.directfb.org/pipermail/directfb-users/2005-October/000770.html
> 
> Yes.  This would be the bug.

Ok, I made some progress. Here is the first patch for directfb.

In the code, there is still something I don't like. Hardwiring these
multiplications '*2' for YUY2 and '*4' for RGBA (source / destination),

+     mga_out32( mmio, mdev->src_offset[0]+mdev->src_pitch*2, TEXORG );
+     mga_out32( mmio, mdev->dst_pitch*2, PITCH );
+     mga_out32( mmio, mdev->dst_offset[0]+mdev->dst_pitch*4, DSTORG );

and forcing strechblit acting allways as an interlaced blit here:
-     matroxBlitTMU( mdrv, mdev, srect, drect, true );
-
+       matroxBlitTMU_interlaced( mdrv, mdev, srect, drect, true );
+#if 0
+     if (mdev->blit_interlaced && !mdev->blit_deinterlace) {
+       matroxBlitTMU_interlaced( mdrv, mdev, srect, drect, true );
+     } else 
+       matroxBlitTMU( mdrv, mdev, srect, drect, true );
+#endif

But by this, I guess you don't need a patch for softdevice.

The only thing you should modify is field based color handling.
For this I uploaded a short test stream, which has a marker at 0:00:04.09 .

http://www.lucke.in-berlin.de/interlaced_16_9_test_stream.tar.bz2

I guess you see the difference too, as there is much movement with red color.
To my opinion it is viewed best when function yv12_to_yuy2_il_c() gets
called instead of yv12_to_yuy2() (lines 1309 & 1310).
I guess I should make yv12_to_yuy2_il_c() the default one, even there
is not an mmx version.

-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: interlaced_blit_03.diff
Type: text/x-diff
Size: 8387 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060505/29aa79fb/attachment.diff>

From jonis2006 at yandex.ru  Sat May  6 09:43:35 2006
From: jonis2006 at yandex.ru (jonis2006)
Date: Sat, 6 May 2006 11:43:35 +0400 (MSD)
Subject: [Softdevice-devel] Softdevice - When the yv12 I420 will work ?
Message-ID: <445C53A7.000005.08832@mfront8.yandex.ru>

Hello !
I want to ask developers of softdevice: When yv12 and i420 will be implemented in softdevice ? Because picture quality in yv12 and i420 colors MORE better than yuy2.
Conversion of YV12 to yuy2 cause big loose of picture sharpness and less colors.
I think you softdevice very need in YV12 and I420 output colorspace support woking (espcially on Matroxes like G450 ).

I know that YV12 working in MPlayer very good. But I can't understand why it not working in softdevice (yuy2 is working, but why others does't work ?).

When yv12 (The quality is very good especially on with this colorspace) will be implemented in softdevice ?

With best regards.
AgentX


From stefan at lucke.in-berlin.de  Sat May  6 14:28:24 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 6 May 2006 14:28:24 +0200
Subject: [Softdevice-devel] Softdevice - When the yv12 I420 will work ?
In-Reply-To: <445C53A7.000005.08832@mfront8.yandex.ru>
References: <445C53A7.000005.08832@mfront8.yandex.ru>
Message-ID: <200605061428.24824.stefan@lucke.in-berlin.de>

On Samstag 06 Mai 2006 09:43, jonis2006 wrote:
> Hello !
> I want to ask developers of softdevice: When yv12 and i420 will be implemented in softdevice ? Because picture quality in yv12 and i420 colors MORE better than yuy2.
> Conversion of YV12 to yuy2 cause big loose of picture sharpness and less colors.

No, as there is no conversion between these formats. Data is just reordered.

> I think you softdevice very need in YV12 and I420 output colorspace support woking (espcially on Matroxes like G450 ).
> 
> I know that YV12 working in MPlayer very good. But I can't understand why it not working in softdevice (yuy2 is working, but why others does't work ?).

YV12 and I420 do work with softdevice and matrox and VGA.
These formats are _not_ supported for TV-out.

See:
http://www.directfb.org/index.php?path=Main%2FSupport%2FGraphics&driver=matrox

In this matrix I see no highlighted entry for source format YV12/I420 and
destination format ARGB.

> 
> When yv12 (The quality is very good especially on with this colorspace) will be implemented in softdevice ?
> 


-- 
Stefan Lucke


From M.Wache at gmx.net  Sun May  7 09:57:58 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 07 May 2006 09:57:58 +0200
Subject: [Softdevice-devel] Patch: cle266 hardware decoding...
In-Reply-To: <200605030951.10192.laz@club-burniston.co.uk>
References: <200604301041.26837.laz@club-burniston.co.uk> <200604301253.06606.stefan@lucke.in-berlin.de> <200604301404.16684.laz@club-burniston.co.uk> <200605030951.10192.laz@club-burniston.co.uk>
Message-ID: <445DA886.7020700@gmx.net>

Laz schrieb:
> On Sunday 30 Apr 2006 14:04, Laz wrote:
> 
>> I tried forcing fwidth, dwidth, fheight, and dheight to fixed values at
>> the start of SetParams but it is still squashed into the corner.
>> Bizarrely, that change makes the video flicker madly!
>>
>> Do you think my best bet is setting the width and height values in the
>> AVCodec context structure (even if just to fixed values for now)? What
>> other bits would also need values elsewhere? I think I convinced myself
>> that PTS values, etc. are set where the audio and video are separated,
>> rather than during the frame decoding.
> 
> I've had a private email from Rolf Ahrenberg who got this working and had 
> the same quarter-sized image. However, he tells me that setting 
> "context->width = 720; context->height = 576;" around where the decoder 
> is called gives a full-screen picture.
> 
> I haven't tested this yet but this is what I was going to try next! Not 
> sure what happens like this if the stream changes resolution or aspect 
> ratio, though! That's the next step...
> 
Hi Laz,

finally I have some time to work on the softdevice again, and I wanted
to have a look at your patch. I know that I downloaded it and had a
quick look, but I can't find it anymore and the link isn't working for
me anymore. Can you please post the patch again? Maybe you already have
an updated version?

From stefan at lucke.in-berlin.de  Sun May  7 15:08:03 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 7 May 2006 15:08:03 +0200
Subject: [Softdevice-devel] Patch: cle266 hardware decoding...
In-Reply-To: <200605030951.10192.laz@club-burniston.co.uk>
References: <200604301041.26837.laz@club-burniston.co.uk> <200604301404.16684.laz@club-burniston.co.uk> <200605030951.10192.laz@club-burniston.co.uk>
Message-ID: <200605071508.03603.stefan@lucke.in-berlin.de>

On Mittwoch 03 Mai 2006 10:51, Laz wrote:
> On Sunday 30 Apr 2006 14:04, Laz wrote:
> 
> > I tried forcing fwidth, dwidth, fheight, and dheight to fixed values at
> > the start of SetParams but it is still squashed into the corner.
> > Bizarrely, that change makes the video flicker madly!
> >
> > Do you think my best bet is setting the width and height values in the
> > AVCodec context structure (even if just to fixed values for now)? What
> > other bits would also need values elsewhere? I think I convinced myself
> > that PTS values, etc. are set where the audio and video are separated,
> > rather than during the frame decoding.
> 
> I've had a private email from Rolf Ahrenberg who got this working and had 
> the same quarter-sized image. However, he tells me that setting 
> "context->width = 720; context->height = 576;" around where the decoder 
> is called gives a full-screen picture.

They should be available in CLE266MPEGDecoderState.width ( and height).
Hopefully it is accessible, should be as it is not declared private.

But some information for aspect calculation and interlaced/progressive
detection is taken from the decoded frame (AVFrame).

> 
> I haven't tested this yet but this is what I was going to try next! Not 
> sure what happens like this if the stream changes resolution or aspect 
> ratio, though! That's the next step...
> 
> :)


-- 
Stefan Lucke


From jonis2006 at yandex.ru  Sun May  7 15:35:59 2006
From: jonis2006 at yandex.ru (jonis2006)
Date: Sun, 7 May 2006 17:35:59 +0400 (MSD)
Subject: [Softdevice-devel] Softdevice - When the yv12 I420 will work ?
In-Reply-To: <200605061428.24824.stefan@lucke.in-berlin.de>
References: <445C53A7.000005.08832@mfront8.yandex.ru> <200605061428.24824.stefan@lucke.in-berlin.de>
Message-ID: <445DF7BF.000004.22233@mfront7.yandex.ru>

>On Samstag 06 Mai 2006 09:43, jonis2006 wrote:
>> Hello !
>> I want to ask developers of softdevice: When yv12 and i420 will be implemented in softdevice ? Because picture quality in yv12 and i420 colors MORE better than yuy2.
>> Conversion of YV12 to yuy2 cause big loose of picture sharpness and less colors.
>
>No, as there is no conversion between these formats. Data is just reordered.
>
>> I think you softdevice very need in YV12 and I420 output colorspace support woking (espcially on Matroxes like G450 ).
>> 
>> I know that YV12 working in MPlayer very good. But I can't understand why it not working in softdevice (yuy2 is working, but why others does't work ?).
>
>YV12 and I420 do work with softdevice and matrox and VGA.
>These formats are _not_ supported for TV-out.
>
>See:
>http://www.directfb.org/index.php?path=Main%2FSupport%2FGraphics&driver=matrox
>
>In this matrix I see no highlighted entry for source format YV12/I420 and
>destination format ARGB.
>
>> 
>> When yv12 (The quality is very good especially on with this colorspace) will be implemented in softdevice ?
>> 
>
Hello !

You wrote:
>See:
>http://www.directfb.org/index.php?path=Main%2FSupport%2FGraphics&driver=matrox
>
>In this matrix I see no highlighted entry for source format YV12/I420 and
>destination format ARGB.
I understand, but how raise quality of the picture ? Im mplayer picture has much sharpness than softdevice, and he using YV12 (on TV out !), and if source=yv12 and destination = ARGB not supported, maybe made work source=yv12 and destination = YV12 ?
Everybody wants MAX sharpness of quality :((

P.S.

Maybe reorder data in yv12_to_yuy2 to raise sharpness ?



From rahrenbe at cc.hut.fi  Sun May  7 18:17:08 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Sun, 7 May 2006 19:17:08 +0300 (EEST)
Subject: [Softdevice-devel] Patch: cle266 hardware decoding...
In-Reply-To: <445DA886.7020700@gmx.net>
References: <200604301041.26837.laz@club-burniston.co.uk>
 <200604301253.06606.stefan@lucke.in-berlin.de> <200604301404.16684.laz@club-burniston.co.uk>
 <200605030951.10192.laz@club-burniston.co.uk> <445DA886.7020700@gmx.net>
Message-ID: <Pine.OSF.4.61.0605071910020.310604@kosh.hut.fi>

On Sun, 7 May 2006, Martin Wache wrote:

> finally I have some time to work on the softdevice again, and I wanted
> to have a look at your patch. I know that I downloaded it and had a
> quick look, but I can't find it anymore and the link isn't working for
> me anymore. Can you please post the patch again? Maybe you already have
> an updated version?

Well, I've cleaned up the patch a bit and added pkg-config support for 
the library to ease up guessing in plugin's configure script. You can 
currently found the library (renamed it back to its' original name) 
here: 
http://www.saunalahti.fi/~rahrenbe/vdr/patches/libcle266mpegdec-0.1.tar.gz

The archive contains both the softdevice and the directfb patches and 
also my quick-n-dirty hack for "fullscreen" mode.

By the way, my portage overlay (located in the same place) contains 
directfb cvs ebuilds with corresponding patches included.

BR,
--
rofa


From marko.makela at hut.fi  Mon May  8 09:40:14 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Mon, 8 May 2006 10:40:14 +0300
Subject: DirectFB downscaling (WAS: Re: [Softdevice-devel] From todays changelog)
In-Reply-To: <200604272234.11333.stefan@lucke.in-berlin.de>
References: <200604221111.57846.stefan@lucke.in-berlin.de> <b7bb36410604271041ga147e02u47b4a46579083fd7@mail.gmail.com> <200604272234.11333.stefan@lucke.in-berlin.de>
Message-ID: <20060508074014.GD3471@localhost.localdomain>

On Thu, Apr 27, 2006 at 10:34:11PM +0200, Stefan Lucke wrote:
> > > http://mail.directfb.org/pipermail/directfb-dev/2005-October/000846.html
> > >
> > 
> > I tried but the patches failed, although it's been a while so I don't
> > remember very well the details. I wonder what kernel they were tried
> > on? Although it might have failed because, my matroxfb is already
> > patched with the full memory patch. If I remember correctly, I had
> > even bigger problems merging the patches to the DirectFB than to the
> > kernel.
> 
> I just tried the patches, in the DirectFB part there were some conflicts
> and I don't know if my handling of that additional argument is allways
> correct as the visible effect is somehow jerky as there are some
> pictures repeated or lost (every few seconds).

I tried the patches last night.  The kernel patch was fine: I only had
to resolve one trivial conflict (changed context, I guess).  I'm using
kernel 2.6.16.14.  Then I updated DirectFB to CVS, but I gave up trying
to resolve the conflicts.

> The cpu load is rather reduced.
> 
> From about 30% to 20% on a Celeron-M 1.5G

This sounds very promising.  Could you post the adapted DirectFB patch, so
that I can try it out?  Currently, -vo dfb:mgatv drops frames every now
and then on my 900 MHz Celeron box.

	Marko


From laz at club-burniston.co.uk  Mon May  8 10:46:36 2006
From: laz at club-burniston.co.uk (Laz)
Date: Mon, 8 May 2006 09:46:36 +0100
Subject: [Softdevice-devel] Patch: cle266 hardware decoding...
In-Reply-To: <445DA886.7020700@gmx.net>
References: <200604301041.26837.laz@club-burniston.co.uk> <200605030951.10192.laz@club-burniston.co.uk> <445DA886.7020700@gmx.net>
Message-ID: <200605080946.36388.laz@club-burniston.co.uk>

On Sunday 07 May 2006 08:57, Martin Wache wrote:
> Laz schrieb:
> > I've had a private email from Rolf Ahrenberg who got this working and
> > had the same quarter-sized image. However, he tells me that setting
> > "context->width = 720; context->height = 576;" around where the
> > decoder is called gives a full-screen picture.
> >
> > I haven't tested this yet but this is what I was going to try next!
> > Not sure what happens like this if the stream changes resolution or
> > aspect ratio, though! That's the next step...
>
> finally I have some time to work on the softdevice again, and I wanted
> to have a look at your patch. I know that I downloaded it and had a
> quick look, but I can't find it anymore and the link isn't working for
> me anymore. Can you please post the patch again? Maybe you already have
> an updated version?

Sorry: the web server was down. Back up now. However, I think Rolf 
Ahrenberg posted a link to an updated version. (I haven't had a chance to 
get back to it yet!)

> From my memory I can say that I was surprised that the patch was so
> small, so in my opinion we can merge it into the softdevice as soon as
> it works stable and the above issue is solved.

It seems quite stable on the short tests I've tried such as leaving it 
going all day whilst I'm at work or overnight. The main problem is the 
scaling and aspect ratio. I'm just Blitting straight to the video surface 
at the moment!

> I also remember that you 
> used the SetupStore for some global variables which weren't really
> setup options. Please don't do that, especially the index of the next
> picture doesn't belong there.

Sorry about that: I knew it was quite nasty! It was a quick bodge to see 
if it actually worked. I'm still finding my feet a bit with C++ and I 
couldn't easily see anywhere else which could be accessed by both 
cMpeg2Decoder and cDFBVideoOut!

I think Rolf has tidied it up a bit but I haven't had a chance to look 
yet: he may have sorted out the variables.

Cheers,

Laz


From laz at club-burniston.co.uk  Mon May  8 10:55:17 2006
From: laz at club-burniston.co.uk (Laz)
Date: Mon, 8 May 2006 09:55:17 +0100
Subject: [Softdevice-devel] Patch: cle266 hardware decoding...
In-Reply-To: <Pine.OSF.4.61.0605071910020.310604@kosh.hut.fi>
References: <200604301041.26837.laz@club-burniston.co.uk> <445DA886.7020700@gmx.net> <Pine.OSF.4.61.0605071910020.310604@kosh.hut.fi>
Message-ID: <200605080955.17406.laz@club-burniston.co.uk>

On Sunday 07 May 2006 17:17, Rolf Ahrenberg wrote:
> On Sun, 7 May 2006, Martin Wache wrote:
> > finally I have some time to work on the softdevice again, and I
> > wanted to have a look at your patch. I know that I downloaded it and
> > had a quick look, but I can't find it anymore and the link isn't
> > working for me anymore. Can you please post the patch again? Maybe
> > you already have an updated version?
>
> Well, I've cleaned up the patch a bit and added pkg-config support for
> the library to ease up guessing in plugin's configure script. You can
> currently found the library (renamed it back to its' original name)
> here:
> http://www.saunalahti.fi/~rahrenbe/vdr/patches/libcle266mpegdec-0.1.tar
>.gz
>
> The archive contains both the softdevice and the directfb patches and
> also my quick-n-dirty hack for "fullscreen" mode.

Thanks, Rolf. I haven't had much time to get back to it, recently, I'm 
afraid! I had originally stripped out all the configure stuff because it 
looked quite broken. I've never dealt with it 'from that side' so didn't 
put it back. Thanks for doing that, and incorporating it into the 
softdevice configure script.

:)

Cheers,

Laz


From laz at club-burniston.co.uk  Mon May  8 10:57:25 2006
From: laz at club-burniston.co.uk (Laz)
Date: Mon, 8 May 2006 09:57:25 +0100
Subject: [Softdevice-devel] Patch: cle266 hardware decoding...
In-Reply-To: <200605071508.03603.stefan@lucke.in-berlin.de>
References: <200604301041.26837.laz@club-burniston.co.uk> <200605030951.10192.laz@club-burniston.co.uk> <200605071508.03603.stefan@lucke.in-berlin.de>
Message-ID: <200605080957.25886.laz@club-burniston.co.uk>

On Sunday 07 May 2006 14:08, Stefan Lucke wrote:
> On Mittwoch 03 Mai 2006 10:51, Laz wrote:
> > I've had a private email from Rolf Ahrenberg who got this working and
> > had the same quarter-sized image. However, he tells me that setting
> > "context->width = 720; context->height = 576;" around where the
> > decoder is called gives a full-screen picture.
>
> They should be available in CLE266MPEGDecoderState.width ( and height).
> Hopefully it is accessible, should be as it is not declared private.

Ah yes: didn't think of that at the time! I should probably add the 'which 
buffer contains the decoded frame' variable to that structure to make it 
a bit more self-contained.

> But some information for aspect calculation and interlaced/progressive
> detection is taken from the decoded frame (AVFrame).

I thought it might be a bit more complicated. Does any of the A-V sync 
stuff come from the decoding or is all of that from the libavformat bit?

Cheers,

Laz


From rahrenbe at cc.hut.fi  Mon May  8 18:51:53 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Mon, 8 May 2006 19:51:53 +0300 (EEST)
Subject: [Softdevice-devel] Patch: cle266 hardware decoding...
In-Reply-To: <200605080946.36388.laz@club-burniston.co.uk>
References: <200604301041.26837.laz@club-burniston.co.uk>
 <200605030951.10192.laz@club-burniston.co.uk> <445DA886.7020700@gmx.net>
 <200605080946.36388.laz@club-burniston.co.uk>
Message-ID: <Pine.OSF.4.61.0605081943120.27526@kosh.hut.fi>

On Mon, 8 May 2006, Laz wrote:

> I think Rolf has tidied it up a bit but I haven't had a chance to look
> yet: he may have sorted out the variables.

Nope. I didn't touch any of them, because I don't know how you guys want 
to implement the whole hw decoding feature into softdevice. I just 
modified the library to better suit for automatic compilation and 
installing (for my gentoo box) and the patch to include preliminary (and 
untested) support for configure with some minor additional cleanups.

The library requires some interface changes (i.e. getter for 
width/height/aspectratio, framebuffer device for opening, etc.), but I 
stopped working on that until things clear up a bit on the softdevice 
side.

BR,
--
rofa


From stefan at lucke.in-berlin.de  Mon May  8 21:59:25 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 8 May 2006 21:59:25 +0200
Subject: DirectFB downscaling (WAS: Re: [Softdevice-devel] From todays changelog)
In-Reply-To: <20060508074014.GD3471@localhost.localdomain>
References: <200604221111.57846.stefan@lucke.in-berlin.de> <200604272234.11333.stefan@lucke.in-berlin.de> <20060508074014.GD3471@localhost.localdomain>
Message-ID: <200605082159.25345.stefan@lucke.in-berlin.de>

On Montag 08 Mai 2006 09:40, Marko M?kel? wrote:
> On Thu, Apr 27, 2006 at 10:34:11PM +0200, Stefan Lucke wrote:
> > > > http://mail.directfb.org/pipermail/directfb-dev/2005-October/000846.html
> > > >
> > > 
> > > I tried but the patches failed, although it's been a while so I don't
> > > remember very well the details. I wonder what kernel they were tried
> > > on? Although it might have failed because, my matroxfb is already
> > > patched with the full memory patch. If I remember correctly, I had
> > > even bigger problems merging the patches to the DirectFB than to the
> > > kernel.
> > 
> > I just tried the patches, in the DirectFB part there were some conflicts
> > and I don't know if my handling of that additional argument is allways
> > correct as the visible effect is somehow jerky as there are some
> > pictures repeated or lost (every few seconds).
> 
> I tried the patches last night.  The kernel patch was fine: I only had
> to resolve one trivial conflict (changed context, I guess).  I'm using
> kernel 2.6.16.14.  Then I updated DirectFB to CVS, but I gave up trying
> to resolve the conflicts.
> 
> > The cpu load is rather reduced.
> > 
> > From about 30% to 20% on a Celeron-M 1.5G
> 
> This sounds very promising.  Could you post the adapted DirectFB patch, so
> that I can try it out?  Currently, -vo dfb:mgatv drops frames every now
> and then on my 900 MHz Celeron box.

Hopefully attached is the complete one.
But I backed that out due to above mentioned jerkyness.
I think we should move the discussion of Ville's patches to direfb-dev.

-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: ville_dfb_v4.diff
Type: text/x-diff
Size: 11760 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060508/5b739d72/attachment.diff>

From rahrenbe at cc.hut.fi  Mon May  8 23:00:41 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Tue, 9 May 2006 00:00:41 +0300 (EEST)
Subject: [Softdevice-devel] OSD transparency & DirectFB on EPIA
Message-ID: <Pine.OSF.4.61.0605082348460.194686@kosh.hut.fi>

Hi,

I've been playing with Softdevice in my EPIA based setup from time to 
time, but never managed to get the OSD transparency working. Originally 
I though that this was somekind of limitation in hardware/driver, but 
recently I noticed that Xineliboutput-plugin provides a nice transparent 
OSD when running it on viafb-directfb-cvs framebuffer driver and latest 
DirectFB libraries. So my DirectFB and framebuffer settings must be 
correct and functional as the Xinelibout works.

Why doesn't transparency work with Softdevice's OSD implementation on 
CLE266?

BR,
--
rofa


From M.Wache at gmx.net  Mon May  8 21:48:01 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 08 May 2006 21:48:01 +0200
Subject: [Softdevice-devel] Patch: cle266 hardware decoding...
In-Reply-To: <200605080957.25886.laz@club-burniston.co.uk>
References: <200604301041.26837.laz@club-burniston.co.uk> <200605030951.10192.laz@club-burniston.co.uk> <200605071508.03603.stefan@lucke.in-berlin.de> <200605080957.25886.laz@club-burniston.co.uk>
Message-ID: <445FA071.9040208@gmx.net>

Laz schrieb:
> On Sunday 07 May 2006 14:08, Stefan Lucke wrote:
>> On Mittwoch 03 Mai 2006 10:51, Laz wrote:
>>> I've had a private email from Rolf Ahrenberg who got this working and
>>> had the same quarter-sized image. However, he tells me that setting
>>> "context->width = 720; context->height = 576;" around where the
>>> decoder is called gives a full-screen picture.
>> They should be available in CLE266MPEGDecoderState.width ( and height).
>> Hopefully it is accessible, should be as it is not declared private.
> 
> Ah yes: didn't think of that at the time! I should probably add the 'which 
> buffer contains the decoded frame' variable to that structure to make it 
> a bit more self-contained.
>
The softdevice currently doesn't support direct rendering, and that is
what the hardware decoder actually does. I have a patch which starts to
implement the direct rendering, unfortunately it isn't finished yet.
With proper direct rendering support passing the correct FB will not be
a problem, so I would suggest to leave it as it is for now.


>> But some information for aspect calculation and interlaced/progressive
>> detection is taken from the decoded frame (AVFrame).
> 
> I thought it might be a bit more complicated. Does any of the A-V sync 
> stuff come from the decoding or is all of that from the libavformat bit?
> 
Libavformat delivers the pts for the coded frame which starts in the
packet. The difficult bit is to find the correct decoded frame to that
pts, since they are reordered for displaying. I will try to have a look
at it...

I also have the patches running now, it works nice except for the aspect
ratio and some a-v syncing issues.

Bye,
Martin


From laz at club-burniston.co.uk  Tue May  9 10:56:10 2006
From: laz at club-burniston.co.uk (Laz)
Date: Tue, 9 May 2006 09:56:10 +0100
Subject: [Softdevice-devel] OSD transparency & DirectFB on EPIA
In-Reply-To: <Pine.OSF.4.61.0605082348460.194686@kosh.hut.fi>
References: <Pine.OSF.4.61.0605082348460.194686@kosh.hut.fi>
Message-ID: <200605090956.11075.laz@club-burniston.co.uk>

On Monday 08 May 2006 22:00, Rolf Ahrenberg wrote:
> Hi,
>
> I've been playing with Softdevice in my EPIA based setup from time to
> time, but never managed to get the OSD transparency working. Originally
> I though that this was somekind of limitation in hardware/driver, but
> recently I noticed that Xineliboutput-plugin provides a nice
> transparent OSD when running it on viafb-directfb-cvs framebuffer
> driver and latest DirectFB libraries. So my DirectFB and framebuffer
> settings must be correct and functional as the Xinelibout works.
>
> Why doesn't transparency work with Softdevice's OSD implementation on
> CLE266?

It used to work well a few months back but when I updated either 
softdevice or DirectFB from cvs a couple of months back (both at the same 
time so I don't know which is the cause of the problem.

With cvs from a couple of weeks back, the only time I see transparency is 
when I have black text which becomes totally see-through (with 
skinsopalusika). Setting the colour to something like 0x111111 does make 
it opaque again.

I think that the depth of the alpha channel isn't quite as good as it ould 
like to be (I think I had to play about a bit with the colours before 
they were transparent and nicely alpha blended).

Cheers,

Laz


From stefan at lucke.in-berlin.de  Mon May  8 22:06:16 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 8 May 2006 22:06:16 +0200
Subject: [Softdevice-devel] Re: DirectFB downscaling
In-Reply-To: <200605052359.52422.stefan@lucke.in-berlin.de>
References: <200604221111.57846.stefan@lucke.in-berlin.de> <1145799555.27094.18.camel@localhost.localdomain> <200605052359.52422.stefan@lucke.in-berlin.de>
Message-ID: <200605082206.16699.stefan@lucke.in-berlin.de>

On Freitag 05 Mai 2006 23:59, Stefan Lucke wrote:
> On Sonntag 23 April 2006 15:39, Malcolm Caldwell wrote:
> > On Sat, 2006-04-22 at 11:11 +0200, Stefan Lucke wrote:
> > > On Dienstag 18 April 2006 02:14, Malcolm Caldwell wrote:
> > > > OK,
> > > > 
> > > > Since I am one of those not on the cvs list...
> > > > 
> > > > Has there been any work on the MGA TV non-field based StretchBlit bug?
> > > No.
> > > > If not is anyone working on it?
> > > No.
> > > 
> > > I think your are referring to this thread on directfb-users:
> > > http://mail.directfb.org/pipermail/directfb-users/2005-October/000770.html
> > 
> > Yes.  This would be the bug.
> 
> Ok, I made some progress. Here is the first patch for directfb.
> 
> In the code, there is still something I don't like. Hardwiring these
> multiplications '*2' for YUY2 and '*4' for RGBA (source / destination),

> 
> and forcing strechblit acting allways as an interlaced blit here:
> -     matroxBlitTMU( mdrv, mdev, srect, drect, true );
> -
> +       matroxBlitTMU_interlaced( mdrv, mdev, srect, drect, true );

> But by this, I guess you don't need a patch for softdevice.

These issues are resolved now.

I posted the latest modification on directfb-dev. Softdevice cvs
is ready for this patch. Detection of presence of DSBLIT_INTERLACED
is done in configure.

> I guess you see the difference too, as there is much movement with red color.
> To my opinion it is viewed best when function yv12_to_yuy2_il_c() gets
> called instead of yv12_to_yuy2() (lines 1309 & 1310).
> I guess I should make yv12_to_yuy2_il_c() the default one, even there
> is not an mmx version.

That is in cvs too, but the desicion is dependant of interlaced
vs. progressive video.


-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: interlaced_blit_05.diff
Type: text/x-diff
Size: 9282 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060508/e8987618/attachment.diff>

From stefan at lucke.in-berlin.de  Tue May  9 20:15:03 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 9 May 2006 20:15:03 +0200
Subject: [Softdevice-devel] OSD transparency & DirectFB on EPIA
In-Reply-To: <200605090956.11075.laz@club-burniston.co.uk>
References: <Pine.OSF.4.61.0605082348460.194686@kosh.hut.fi> <200605090956.11075.laz@club-burniston.co.uk>
Message-ID: <200605092015.03511.stefan@lucke.in-berlin.de>

On Dienstag 09 Mai 2006 10:56, Laz wrote:
> On Monday 08 May 2006 22:00, Rolf Ahrenberg wrote:
> > Hi,
> >
> > I've been playing with Softdevice in my EPIA based setup from time to
> > time, but never managed to get the OSD transparency working. Originally
> > I though that this was somekind of limitation in hardware/driver, but
> > recently I noticed that Xineliboutput-plugin provides a nice
> > transparent OSD when running it on viafb-directfb-cvs framebuffer
> > driver and latest DirectFB libraries. So my DirectFB and framebuffer
> > settings must be correct and functional as the Xinelibout works.
> >
> > Why doesn't transparency work with Softdevice's OSD implementation on
> > CLE266?
> 
> It used to work well a few months back but when I updated either 
> softdevice or DirectFB from cvs a couple of months back (both at the same 
> time so I don't know which is the cause of the problem.

My last test with my via board was serveral months ago too.

> 
> With cvs from a couple of weeks back, the only time I see transparency is 
> when I have black text which becomes totally see-through (with 
> skinsopalusika). Setting the colour to something like 0x111111 does make 
> it opaque again.

Full black is full transparent now ?
Colud be either an issue with AlphaInversed at line 1091 or
with SetLevel (1)  at line 763.

Could you try setting AlphaInversed to false fixed, and/ or
either skip the call of SetLevel or replacing that with SetLevel(-1).

Won't try that here at the moment, as my epia board acts as our
productive dvb-t receiver. My dvb-s cards turned inoperable
during some slight maintenance :-( .

See (in german):
http://www.vdr-portal.de/board/thread.php?threadid=44983

> 
> I think that the depth of the alpha channel isn't quite as good as it ould 
> like to be (I think I had to play about a bit with the colours before 
> they were transparent and nicely alpha blended).

Epia boards do not support 8bit alpha values, only 4 or 5bit
(the higher ones).

-- 
Stefan Lucke


From marko.makela at hut.fi  Tue May  9 23:38:50 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 10 May 2006 00:38:50 +0300
Subject: [Softdevice-devel] Re: DirectFB downscaling
In-Reply-To: <200605082206.16699.stefan@lucke.in-berlin.de>
References: <200604221111.57846.stefan@lucke.in-berlin.de> <1145799555.27094.18.camel@localhost.localdomain> <200605052359.52422.stefan@lucke.in-berlin.de> <200605082206.16699.stefan@lucke.in-berlin.de>
Message-ID: <20060509213850.GB15419@localhost.localdomain>

On Mon, May 08, 2006 at 10:06:16PM +0200, Stefan Lucke wrote:
> I posted the latest modification on directfb-dev. Softdevice cvs
> is ready for this patch. Detection of presence of DSBLIT_INTERLACED
> is done in configure.

After applying your attached patch to DirectFB CVS and recompiling and
installing, and after ./configure and make plugins on softdevice cvs,
my log was initially flooded with this:

[dfb] Refresh: action=IDirectFBSurface::SetBlittingFlags(DFBSurfaceBlittingFlags), result=Not supported!

I fixed this by updating, recompiling and installing DFB++.

Now the waves seem to be gone, no matter which crop mode is selected.
Thank you, this makes 16:9 material more watchable on 4:3 screens.

	Marko


From marko.makela at hut.fi  Wed May 10 00:19:05 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 10 May 2006 01:19:05 +0300
Subject: DirectFB downscaling (WAS: Re: [Softdevice-devel] From todays changelog)
In-Reply-To: <200605082159.25345.stefan@lucke.in-berlin.de>
References: <200604221111.57846.stefan@lucke.in-berlin.de> <200604272234.11333.stefan@lucke.in-berlin.de> <20060508074014.GD3471@localhost.localdomain> <200605082159.25345.stefan@lucke.in-berlin.de>
Message-ID: <20060509221905.GD15419@localhost.localdomain>

On Mon, May 08, 2006 at 09:59:25PM +0200, Stefan Lucke wrote:
> > > The cpu load is rather reduced.
> > > 
> > > From about 30% to 20% on a Celeron-M 1.5G
> > 
> > This sounds very promising.  Could you post the adapted DirectFB patch, so
> > that I can try it out?  Currently, -vo dfb:mgatv drops frames every now
> > and then on my 900 MHz Celeron box.
> 
> Hopefully attached is the complete one.
> But I backed that out due to above mentioned jerkyness.

For me, it works rather well, but it didn't seem to reduce CPU usage:
top says vdr uses around 45%.  The top user according to OProfile is
yv12_to_yuy2_il_c(), with 35% of softdevice samples, or 23% of all samples.

When viewing live program from MTV3 (or a short test recording from it),
the fields are somehow mixed.  Luckily, this clip has horizontal scrolling
text, which makes it easier to guess what is going on.  The text appears
to jump (say) 4 pixels to the left, then 2 pixels to the right, then again
4 pixels to the left, and so on.  The scroll is smooth if I revert Ville's
patch.  Would you like to have the clip for testing?

> I think we should move the discussion of Ville's patches to direfb-dev.

Sorry, I didn't get around to subscribing to that list yet.

	Marko


From malcolm.caldwell at ntu.edu.au  Wed May 10 07:25:58 2006
From: malcolm.caldwell at ntu.edu.au (Malcolm Caldwell)
Date: Wed, 10 May 2006 14:55:58 +0930
Subject: [Softdevice-devel] Re: DirectFB downscaling
In-Reply-To: <200605082206.16699.stefan@lucke.in-berlin.de>
References: <200604221111.57846.stefan@lucke.in-berlin.de>
	 <1145799555.27094.18.camel@localhost.localdomain>
	 <200605052359.52422.stefan@lucke.in-berlin.de>
	 <200605082206.16699.stefan@lucke.in-berlin.de>
Message-ID: <1147238758.3526.18.camel@localhost.localdomain>

On Mon, 2006-05-08 at 22:06 +0200, Stefan Lucke wrote:
> On Freitag 05 Mai 2006 23:59, Stefan Lucke wrote:
> > On Sonntag 23 April 2006 15:39, Malcolm Caldwell wrote:
> > > On Sat, 2006-04-22 at 11:11 +0200, Stefan Lucke wrote:
> > > > On Dienstag 18 April 2006 02:14, Malcolm Caldwell wrote:
> > > > > OK,
> > > > > 
> > > > > Since I am one of those not on the cvs list...
> > > > > 
> > > > > Has there been any work on the MGA TV non-field based StretchBlit bug?
> > > > No.
> > > > > If not is anyone working on it?
> > > > No.
> > > > 
> > > > I think your are referring to this thread on directfb-users:
> > > > http://mail.directfb.org/pipermail/directfb-users/2005-October/000770.html
> > > 
> > > Yes.  This would be the bug.
> > 
> > Ok, I made some progress. Here is the first patch for directfb.
> > 
> > In the code, there is still something I don't like. Hardwiring these
> > multiplications '*2' for YUY2 and '*4' for RGBA (source / destination),
> 
> > 
> > and forcing strechblit acting allways as an interlaced blit here:
> > -     matroxBlitTMU( mdrv, mdev, srect, drect, true );
> > -
> > +       matroxBlitTMU_interlaced( mdrv, mdev, srect, drect, true );
> 
> > But by this, I guess you don't need a patch for softdevice.
> 
> These issues are resolved now.
> 
> I posted the latest modification on directfb-dev. Softdevice cvs
> is ready for this patch. Detection of presence of DSBLIT_INTERLACED
> is done in configure.

This is great.  I have not had time to test this yet.  Last weekend I
upgraded to vdr 1.4 and latest softdevice.  I am busy this weekend.
Perhaps I will get some time before then...

> > I guess you see the difference too, as there is much movement with red color.
> > To my opinion it is viewed best when function yv12_to_yuy2_il_c() gets
> > called instead of yv12_to_yuy2() (lines 1309 & 1310).
> > I guess I should make yv12_to_yuy2_il_c() the default one, even there
> > is not an mmx version.
> 
> That is in cvs too, but the desicion is dependant of interlaced
> vs. progressive video.

Great.



From stefan at lucke.in-berlin.de  Wed May 10 00:54:55 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 10 May 2006 00:54:55 +0200
Subject: [Softdevice-devel] OSD transparency & DirectFB on EPIA
In-Reply-To: <200605092015.03511.stefan@lucke.in-berlin.de>
References: <Pine.OSF.4.61.0605082348460.194686@kosh.hut.fi> <200605090956.11075.laz@club-burniston.co.uk> <200605092015.03511.stefan@lucke.in-berlin.de>
Message-ID: <200605100054.55340.stefan@lucke.in-berlin.de>

On Dienstag 09 Mai 2006 20:15, Stefan Lucke wrote:
> On Dienstag 09 Mai 2006 10:56, Laz wrote:
> > On Monday 08 May 2006 22:00, Rolf Ahrenberg wrote:
> > > Hi,
> > >
> > > I've been playing with Softdevice in my EPIA based setup from time to
> > > time, but never managed to get the OSD transparency working. Originally
> > > I though that this was somekind of limitation in hardware/driver, but
> > > recently I noticed that Xineliboutput-plugin provides a nice
> > > transparent OSD when running it on viafb-directfb-cvs framebuffer
> > > driver and latest DirectFB libraries. So my DirectFB and framebuffer
> > > settings must be correct and functional as the Xinelibout works.
> > >
> > > Why doesn't transparency work with Softdevice's OSD implementation on
> > > CLE266?
> > 
> > It used to work well a few months back but when I updated either 
> > softdevice or DirectFB from cvs a couple of months back (both at the same 
> > time so I don't know which is the cause of the problem.
> 
> My last test with my via board was serveral months ago too.
> 
> > 
> > With cvs from a couple of weeks back, the only time I see transparency is 
> > when I have black text which becomes totally see-through (with 
> > skinsopalusika). Setting the colour to something like 0x111111 does make 
> > it opaque again.
> 
> Full black is full transparent now ?
> Colud be either an issue with AlphaInversed at line 1091 or
> with SetLevel (1)  at line 763.
> 
> Could you try setting AlphaInversed to false fixed, and/ or
> either skip the call of SetLevel or replacing that with SetLevel(-1).
> 
> Won't try that here at the moment, as my epia board acts as our
> productive dvb-t receiver. 

Did a test now with vdr-1.4.0 and softdevice-cvs-head. OSD is still
drawn in normal alpha blend mode. I did not any other plugin (skin-plugin).
My DirectFB version on this box is somewhere outdated. I guess I've
to upgrade.

(*) DirectFB/Config: Parsing config file '/etc/directfbrc'.

       ---------------------- DirectFB v0.9.23 ---------------------
             (c) 2000-2002  convergence integrated media GmbH
             (c) 2002-2004  convergence GmbH
        -----------------------------------------------------------

(*) DirectFB/Core: Single Application Core. (2005-09-24 07:55)

viafb is at:
viafb: VIA UNICHROME framebuffer 1.0 initializing

> My dvb-s cards turned inoperable 
> during some slight maintenance :-( .
> 
> See (in german):
> http://www.vdr-portal.de/board/thread.php?threadid=44983
> 
> > 
> > I think that the depth of the alpha channel isn't quite as good as it ould 
> > like to be (I think I had to play about a bit with the colours before 
> > they were transparent and nicely alpha blended).
> 
> Epia boards do not support 8bit alpha values, only 4 or 5bit
> (the higher ones).
> 

-- 
Stefan Lucke


From marko.makela at hut.fi  Wed May 10 10:38:16 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 10 May 2006 11:38:16 +0300
Subject: [Softdevice-devel] Re: DirectFB downscaling
In-Reply-To: <20060509213850.GB15419@localhost.localdomain>
References: <200604221111.57846.stefan@lucke.in-berlin.de> <1145799555.27094.18.camel@localhost.localdomain> <200605052359.52422.stefan@lucke.in-berlin.de> <200605082206.16699.stefan@lucke.in-berlin.de> <20060509213850.GB15419@localhost.localdomain>
Message-ID: <20060510083816.GA11567@localhost.localdomain>

On Wed, May 10, 2006 at 12:38:50AM +0300, Marko M?kel? wrote:
> Now the waves seem to be gone, no matter which crop mode is selected.
> Thank you, this makes 16:9 material more watchable on 4:3 screens.

On the other hand, the loss of MMX acceleration also means almost
guaranteed frame drops when browsing the OSD.  Before this change,
the poor 900 MHz Celeron only dropped frames once in a few minutes.

Perhaps there should be a #define in the beginning of video-dfb.c
that would disable non-MMX color space conversions.  Making it a
setup menu option would probably be an overkill.

	Marko


From laz at club-burniston.co.uk  Wed May 10 00:02:37 2006
From: laz at club-burniston.co.uk (Laz)
Date: Tue, 9 May 2006 23:02:37 +0100
Subject: [Softdevice-devel] OSD transparency & DirectFB on EPIA
In-Reply-To: <200605092015.03511.stefan@lucke.in-berlin.de>
References: <Pine.OSF.4.61.0605082348460.194686@kosh.hut.fi> <200605090956.11075.laz@club-burniston.co.uk> <200605092015.03511.stefan@lucke.in-berlin.de>
Message-ID: <200605092302.37838.laz@club-burniston.co.uk>

On Tuesday 09 May 2006 19:15, Stefan Lucke wrote:
> On Dienstag 09 Mai 2006 10:56, Laz wrote:
> > With cvs from a couple of weeks back, the only time I see transparency is
> > when I have black text which becomes totally see-through (with
> > skinsopalusika). Setting the colour to something like 0x111111 does make
> > it opaque again.
>
> Full black is full transparent now ?

Yes: took me a while to work out what was wrong. It's quite difficult to spot 
transparent text in an opaque background!

;)

> Colud be either an issue with AlphaInversed at line 1091 or
> with SetLevel (1)  at line 763.
>
> Could you try setting AlphaInversed to false fixed, and/ or
> either skip the call of SetLevel or replacing that with SetLevel(-1).

I had a quick go at trying SetLevel(-1) after reading Readme.txt in the 
DirectFB unichrome driver source. I can't actually remember what that did but 
I lost either the OSD or the video layer completely!

Just tested again: commenting out the SetLevel(1) made no difference; setting 
it to -1 gives me no visible video, even when the OSD is absent. I also don't 
see any glimpses of video through any of the text with it like this. I also 
tried setting osdDsc.pixelformat = DSPF_AiRGB (see below) to no effect, i.e. 
with SetLevel(-1) I still saw no video layer.

Maybe this is a change in DirectFB so that the alpha channel isn't reversed 
(assuming that's how it was before!). Just had a quick go setting 
AlphaInversed to false and it didn't seem to have any effect at all.

Maybe this is something deeper in SoftOsd.c? Not really delved into that 
yet...

> Won't try that here at the moment, as my epia board acts as our
> productive dvb-t receiver. My dvb-s cards turned inoperable
> during some slight maintenance :-( .
>
> See (in german):
> http://www.vdr-portal.de/board/thread.php?threadid=44983
>
> > I think that the depth of the alpha channel isn't quite as good as it
> > ould like to be (I think I had to play about a bit with the colours
> > before they were transparent and nicely alpha blended).
>
> Epia boards do not support 8bit alpha values, only 4 or 5bit
> (the higher ones).

Sounds familiar. To quote bits from the DirectFB unichrome Readme.txt file:

Special features
----------------

* The video overlay layer can be placed beneath the primary layer,
  which can have an alpha channel.

  To enable this, set the level of the overlay to -1 (using SetLevel)
  and enable the DLOP_ALPHACHANNEL option on the primary.  Then use
  either ARGB or AiRGB as the primary pixel format (see also 'known
  bugs and quirks' below).

Known bugs and quirks
---------------------

* In underlay mode (see 'special features', above), the video
  is fully visible where the primary layer's alpha is 255, and
  invisible (= graphics visible) where the alpha is 0.

  There are two options to overcome this:

  The first is to use the special pixel format AiRGB.

  The second is to XOR the alpha channel of the surface, e.g. just
  before flipping the primary surface.


Now this "Special feature" sounds like the behaviour we would want here but 
the video layer is currently set to layer 1 rather than -1 (and see above!):

if (isVIAUnichrome)
            videoLayer->SetLevel(1);

DLOP_ALPHACHANNEL is being enabled just above here, too. The pixel format is 
DSPF_ARGB, as far as I can tell.

More details:

I generally use skinsoppalusikka and this appears as everything fully opaque 
except black text (or anything else?) being fully transparent. Switching to 
the standard vdr skin or the ST-TNG skin gives me a fully transparent 
background with coloured opaque text, except for the selected line of a menu 
or menu titles which have fully transparent text.

Cheers,

Laz


From nicolas at huillard.net  Wed May 10 11:02:26 2006
From: nicolas at huillard.net (Nicolas Huillard)
Date: Wed, 10 May 2006 11:02:26 +0200
Subject: [Softdevice-devel] OSD transparency & DirectFB on EPIA
In-Reply-To: <200605100054.55340.stefan@lucke.in-berlin.de>
References: <Pine.OSF.4.61.0605082348460.194686@kosh.hut.fi> <200605090956.11075.laz@club-burniston.co.uk> <200605092015.03511.stefan@lucke.in-berlin.de> <200605100054.55340.stefan@lucke.in-berlin.de>
Message-ID: <4461AC22.6040500@huillard.net>

Stefan Lucke a ?crit :
> Did a test now with vdr-1.4.0 and softdevice-cvs-head. OSD is still
> drawn in normal alpha blend mode. I did not any other plugin (skin-plugin).
> My DirectFB version on this box is somewhere outdated. I guess I've
> to upgrade.

I also have an old DirectFB, and remember I had to patch it for alpha
blending. I don't have details in mind, but the answer must reside on
the ML archive...

-- 
NH


From stefan at lucke.in-berlin.de  Wed May 10 12:57:28 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 10 May 2006 12:57:28 +0200
Subject: [Softdevice-devel] OSD transparency & DirectFB on EPIA
In-Reply-To: <200605092302.37838.laz@club-burniston.co.uk>
References: <Pine.OSF.4.61.0605082348460.194686@kosh.hut.fi> <200605090956.11075.laz@club-burniston.co.uk> <200605092015.03511.stefan@lucke.in-berlin.de> <200605092302.37838.laz@club-burniston.co.uk>
Message-ID: <1147258648.4461c718c3d14@webmail.in-berlin.de>

Quoting Laz:

> On Tuesday 09 May 2006 19:15, Stefan Lucke wrote:
> > On Dienstag 09 Mai 2006 10:56, Laz wrote:
> > > With cvs from a couple of weeks back, the only time I see transparency is
> > > when I have black text which becomes totally see-through (with
> > > skinsopalusika). Setting the colour to something like 0x111111 does make
> > > it opaque again.
> >
> > Full black is full transparent now ?
>
> Yes: took me a while to work out what was wrong. It's quite difficult to spot
> transparent text in an opaque background!
>
> ;)
>
> > Colud be either an issue with AlphaInversed at line 1091 or
> > with SetLevel (1)  at line 763.
> >
> > Could you try setting AlphaInversed to false fixed, and/ or
> > either skip the call of SetLevel or replacing that with SetLevel(-1).
>
> I had a quick go at trying SetLevel(-1) after reading Readme.txt in the
> DirectFB unichrome driver source. I can't actually remember what that did but
> I lost either the OSD or the video layer completely!


From laz at club-burniston.co.uk  Wed May 10 14:22:49 2006
From: laz at club-burniston.co.uk (Laz)
Date: Wed, 10 May 2006 13:22:49 +0100
Subject: [Softdevice-devel] OSD transparency & DirectFB on EPIA
In-Reply-To: <1147258648.4461c718c3d14@webmail.in-berlin.de>
References: <Pine.OSF.4.61.0605082348460.194686@kosh.hut.fi> <200605092302.37838.laz@club-burniston.co.uk> <1147258648.4461c718c3d14@webmail.in-berlin.de>
Message-ID: <200605101322.49604.laz@club-burniston.co.uk>

On Wednesday 10 May 2006 11:57, Stefan Lucke wrote:
> Quoting Laz:
> > I had a quick go at trying SetLevel(-1) after reading Readme.txt in
> > the DirectFB unichrome driver source. I can't actually remember what
> > that did but I lost either the OSD or the video layer completely!
>
> From a look at directfb code, it should work with SetLevel(-1), if
> unichrome driver would report capability DLCAPS_ALPHACHANNEL. Reporting
> DLCAPS_ALPHACHANNEL has to be fixed in
> DirectFB/gfxdrivers/unichrome/uc_overlay.h line 5 or 6, by or'ing this
> together with other flags .

Hmmmm... I'm sure that my setup does report 'alphachannel' on 
initialisation for me (can't check right now, or which layer this is 
for), and so presumably it does get enabled. Shouldn't this be enabled 
for the primary layer and not the overlay, anyway? Looking at 
video-dfb.c, DLCAPS_ALPHACHANNEL is being checked for and set for the 
video layer rather than the primary layer.

Or are you saying that this feature is currently broken or missing for the 
overlay layer in the unichrome driver?

Cheers,

Laz



From stefan at lucke.in-berlin.de  Wed May 10 19:18:55 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 10 May 2006 19:18:55 +0200
Subject: [Softdevice-devel] OSD transparency & DirectFB on EPIA
In-Reply-To: <200605101322.49604.laz@club-burniston.co.uk>
References: <Pine.OSF.4.61.0605082348460.194686@kosh.hut.fi> <1147258648.4461c718c3d14@webmail.in-berlin.de> <200605101322.49604.laz@club-burniston.co.uk>
Message-ID: <200605101918.55289.stefan@lucke.in-berlin.de>

On Mittwoch 10 Mai 2006 14:22, Laz wrote:
> On Wednesday 10 May 2006 11:57, Stefan Lucke wrote:
> > Quoting Laz:
> > > I had a quick go at trying SetLevel(-1) after reading Readme.txt in
> > > the DirectFB unichrome driver source. I can't actually remember what
> > > that did but I lost either the OSD or the video layer completely!
> >
> > From a look at directfb code, it should work with SetLevel(-1), if
> > unichrome driver would report capability DLCAPS_ALPHACHANNEL. Reporting
> > DLCAPS_ALPHACHANNEL has to be fixed in
> > DirectFB/gfxdrivers/unichrome/uc_overlay.h line 5 or 6, by or'ing this
> > together with other flags .
> 
> Hmmmm... I'm sure that my setup does report 'alphachannel' on 
> initialisation for me (can't check right now, or which layer this is 
> for), and so presumably it does get enabled. Shouldn't this be enabled 
> for the primary layer and not the overlay, anyway? Looking at 
> video-dfb.c, DLCAPS_ALPHACHANNEL is being checked for and set for the 
> video layer rather than the primary layer.

Guess you are right. That's from November:
http://mail.directfb.org/pipermail/directfb-dev/2005-November/000970.html

> 
> Or are you saying that this feature is currently broken or missing for the 
> overlay layer in the unichrome driver?
> 

-- 
Stefan Lucke


From inssomniak at mountaincable.net  Thu May 11 05:01:44 2006
From: inssomniak at mountaincable.net (Dave)
Date: Wed, 10 May 2006 23:01:44 -0400
Subject: [Softdevice-devel] Patch: cle266 hardware decoding...
In-Reply-To: <445FA071.9040208@gmx.net>
References: <200604301041.26837.laz@club-burniston.co.uk> <200605030951.10192.laz@club-burniston.co.uk> <200605071508.03603.stefan@lucke.in-berlin.de> <200605080957.25886.laz@club-burniston.co.uk> <445FA071.9040208@gmx.net>
Message-ID: <4462A918.4010301@mountaincable.net>

What are the chances this would work for a VIA KM400 based chipset? 


Martin Wache wrote:
> Laz schrieb:
>   
>> On Sunday 07 May 2006 14:08, Stefan Lucke wrote:
>>     
>>> On Mittwoch 03 Mai 2006 10:51, Laz wrote:
>>>       
>>>> I've had a private email from Rolf Ahrenberg who got this working and
>>>> had the same quarter-sized image. However, he tells me that setting
>>>> "context->width = 720; context->height = 576;" around where the
>>>> decoder is called gives a full-screen picture.
>>>>         
>>> They should be available in CLE266MPEGDecoderState.width ( and height).
>>> Hopefully it is accessible, should be as it is not declared private.
>>>       
>> Ah yes: didn't think of that at the time! I should probably add the 'which 
>> buffer contains the decoded frame' variable to that structure to make it 
>> a bit more self-contained.
>>
>>     
> The softdevice currently doesn't support direct rendering, and that is
> what the hardware decoder actually does. I have a patch which starts to
> implement the direct rendering, unfortunately it isn't finished yet.
> With proper direct rendering support passing the correct FB will not be
> a problem, so I would suggest to leave it as it is for now.
>
>
>   
>>> But some information for aspect calculation and interlaced/progressive
>>> detection is taken from the decoded frame (AVFrame).
>>>       
>> I thought it might be a bit more complicated. Does any of the A-V sync 
>> stuff come from the decoding or is all of that from the libavformat bit?
>>
>>     
> Libavformat delivers the pts for the coded frame which starts in the
> packet. The difficult bit is to find the correct decoded frame to that
> pts, since they are reordered for displaying. I will try to have a look
> at it...
>
> I also have the patches running now, it works nice except for the aspect
> ratio and some a-v syncing issues.
>
> Bye,
> Martin
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/softdevice-devel
>
>   


From stefan at lucke.in-berlin.de  Thu May 11 07:30:16 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 11 May 2006 07:30:16 +0200
Subject: [Softdevice-devel] OSD transparency & DirectFB on EPIA
In-Reply-To: <200605101918.55289.stefan@lucke.in-berlin.de>
References: <Pine.OSF.4.61.0605082348460.194686@kosh.hut.fi> <200605101322.49604.laz@club-burniston.co.uk> <200605101918.55289.stefan@lucke.in-berlin.de>
Message-ID: <200605110730.16799.stefan@lucke.in-berlin.de>

On Mittwoch 10 Mai 2006 19:18, Stefan Lucke wrote:
> On Mittwoch 10 Mai 2006 14:22, Laz wrote:
> > On Wednesday 10 May 2006 11:57, Stefan Lucke wrote:
> > > Quoting Laz:
> > > > I had a quick go at trying SetLevel(-1) after reading Readme.txt in
> > > > the DirectFB unichrome driver source. I can't actually remember what
> > > > that did but I lost either the OSD or the video layer completely!
> > >
> > > From a look at directfb code, it should work with SetLevel(-1), if
> > > unichrome driver would report capability DLCAPS_ALPHACHANNEL. Reporting
> > > DLCAPS_ALPHACHANNEL has to be fixed in
> > > DirectFB/gfxdrivers/unichrome/uc_overlay.h line 5 or 6, by or'ing this
> > > together with other flags .
> > 
> > Hmmmm... I'm sure that my setup does report 'alphachannel' on 
> > initialisation for me (can't check right now, or which layer this is 
> > for), and so presumably it does get enabled. Shouldn't this be enabled 
> > for the primary layer and not the overlay, anyway? Looking at 
> > video-dfb.c, DLCAPS_ALPHACHANNEL is being checked for and set for the 
> > video layer rather than the primary layer.
> 
> Guess you are right. That's from November:
> http://mail.directfb.org/pipermail/directfb-dev/2005-November/000970.html
> 

But it's definitely more complicated :-( . So now with directfb cvs, I only
have video when SetLayer(1) or OSD when SetLayer(-1). So I guess
to fix this, many things may break. I cannot promise that it will work
with other (older directfb versions) :-( .

-- 
Stefan Lucke


From Malcolm.Caldwell at cdu.edu.au  Thu May 11 15:07:35 2006
From: Malcolm.Caldwell at cdu.edu.au (Malcolm Caldwell)
Date: Thu, 11 May 2006 22:37:35 +0930
Subject: [Softdevice-devel] Re: DirectFB downscaling
In-Reply-To: <200605082206.16699.stefan@lucke.in-berlin.de>
References: <200604221111.57846.stefan@lucke.in-berlin.de>
	 <1145799555.27094.18.camel@localhost.localdomain>
	 <200605052359.52422.stefan@lucke.in-berlin.de>
	 <200605082206.16699.stefan@lucke.in-berlin.de>
Message-ID: <1147352855.3518.12.camel@localhost.localdomain>

On Mon, 2006-05-08 at 22:06 +0200, Stefan Lucke wrote:
> 
> I posted the latest modification on directfb-dev. Softdevice cvs
> is ready for this patch. Detection of presence of DSBLIT_INTERLACED
> is done in configure.

I can confirm that with the latest cvs softdevice and with the patch to
directfb all material now displays fine on my matrox tv out system.

This includes viewing 16:9 material on my 4:3 display, viewing
interlaced AVIs, even viewing NTSC material on my PAL tv.  (Although
with NTSC softdevice really struggles trying to keep playback smooth due
to the differing framerate!)

> > I guess you see the difference too, as there is much movement with red color.
> > To my opinion it is viewed best when function yv12_to_yuy2_il_c() gets
> > called instead of yv12_to_yuy2() (lines 1309 & 1310).
> > I guess I should make yv12_to_yuy2_il_c() the default one, even there
> > is not an mmx version.

I have noticed that CPU usage has increased.  Hopefully not a real
problem for me but an issue all the same.

> That is in cvs too, but the desicion is dependant of interlaced
> vs. progressive video.

Perhaps the decision can also be based on if the source has differing
dimensions to the destination?  (ie if (4:3->4:3) use the fast code?)

Anyway, this is great: Stefan gets a big thank you from me!


From M.Wache at gmx.net  Thu May 11 21:41:01 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 11 May 2006 21:41:01 +0200
Subject: [Softdevice-devel] Patch: cle266 hardware decoding...
In-Reply-To: <445FA071.9040208@gmx.net>
References: <200604301041.26837.laz@club-burniston.co.uk> <200605030951.10192.laz@club-burniston.co.uk> <200605071508.03603.stefan@lucke.in-berlin.de> <200605080957.25886.laz@club-burniston.co.uk> <445FA071.9040208@gmx.net>
Message-ID: <4463934D.9080507@gmx.net>


>>> But some information for aspect calculation and interlaced/progressive
>>> detection is taken from the decoded frame (AVFrame).
>> I thought it might be a bit more complicated. Does any of the A-V sync 
>> stuff come from the decoding or is all of that from the libavformat bit?
>>
> Libavformat delivers the pts for the coded frame which starts in the
> packet. The difficult bit is to find the correct decoded frame to that
> pts, since they are reordered for displaying. I will try to have a look
> at it...
> 

Ok, here is a patch to Rolfs version of libcle266mpegdec which
implements pts handling. I would not call it a perfekt solution, but it
is something to start with.

I also had a look at the aspect ratio, it seems that the dtg active
format is not parsed inside libcle266mpegdec. From ffmpeg the
information should be inside of a user data block marked with
0x0000001b2, followed by the tag 'DTG1', have a look at the function
mpeg_decode_user_data() in libavcodec/mpeg12.c.
I tried to implement a parser in libcle266mpegdec, but somehow I don't
understand the parser, or the information is not there ...

So I will now go on and have a look at the softdevice part. I guess I
will move CheckAspectDimension() from video.c to mpegdecoder.c and
reimplement it for the cle266 case.

Bye,
Martin
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: pts.diff
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060511/62c748db/attachment.ksh>

From stefan at lucke.in-berlin.de  Fri May 12 15:20:41 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 12 May 2006 15:20:41 +0200
Subject: [Softdevice-devel] Patch: cle266 hardware decoding...
In-Reply-To: <4463934D.9080507@gmx.net>
References: <200604301041.26837.laz@club-burniston.co.uk> <200605030951.10192.laz@club-burniston.co.uk> <200605071508.03603.stefan@lucke.in-berlin.de> <200605080957.25886.laz@club-burniston.co.uk> <445FA071.9040208@gmx.net> <4463934D.9080507@gmx.net>
Message-ID: <1147440041.44648ba9e9f70@webmail.in-berlin.de>

Quoting Martin Wache <M.Wache at gmx.net>:

>
> >>> But some information for aspect calculation and interlaced/progressive
> >>> detection is taken from the decoded frame (AVFrame).
> >> I thought it might be a bit more complicated. Does any of the A-V sync
> >> stuff come from the decoding or is all of that from the libavformat bit?
> >>
> > Libavformat delivers the pts for the coded frame which starts in the
> > packet. The difficult bit is to find the correct decoded frame to that
> > pts, since they are reordered for displaying. I will try to have a look
> > at it...
> >
>
> Ok, here is a patch to Rolfs version of libcle266mpegdec which
> implements pts handling. I would not call it a perfekt solution, but it
> is something to start with.
>
> I also had a look at the aspect ratio, it seems that the dtg active
> format is not parsed inside libcle266mpegdec. From ffmpeg the
> information should be inside of a user data block marked with
> 0x0000001b2, followed by the tag 'DTG1', have a look at the function
> mpeg_decode_user_data() in libavcodec/mpeg12.c.
> I tried to implement a parser in libcle266mpegdec, but somehow I don't
> understand the parser, or the information is not there ...

Do you have a test stream from which you know it has AFD data present ?
I've only one and may upload it. In germany I havn't seen AFD data.

>
> So I will now go on and have a look at the softdevice part. I guess I
> will move CheckAspectDimension() from video.c to mpegdecoder.c and
> reimplement it for the cle266 case.

Isn't it easier just to fill relevant info in AVFarme and codec ?
I guess we allocated both.





From laz at club-burniston.co.uk  Fri May 12 15:44:28 2006
From: laz at club-burniston.co.uk (Laz)
Date: Fri, 12 May 2006 14:44:28 +0100
Subject: [Softdevice-devel] Patch: cle266 hardware decoding...
In-Reply-To: <4463934D.9080507@gmx.net>
References: <200604301041.26837.laz@club-burniston.co.uk> <445FA071.9040208@gmx.net> <4463934D.9080507@gmx.net>
Message-ID: <200605121444.28551.laz@club-burniston.co.uk>

On Thursday 11 May 2006 20:41, Martin Wache wrote:
> >>> But some information for aspect calculation and
> >>> interlaced/progressive detection is taken from the decoded frame
> >>> (AVFrame).
> >>
> >> I thought it might be a bit more complicated. Does any of the A-V
> >> sync stuff come from the decoding or is all of that from the
> >> libavformat bit?
> >
> > Libavformat delivers the pts for the coded frame which starts in the
> > packet. The difficult bit is to find the correct decoded frame to
> > that pts, since they are reordered for displaying. I will try to have
> > a look at it...
>
> Ok, here is a patch to Rolfs version of libcle266mpegdec which
> implements pts handling. I would not call it a perfekt solution, but it
> is something to start with.

Excellent stuff! I really haven't had a chance to get back to looking at 
this. It's good that others are moving things forward.

> I also had a look at the aspect ratio, it seems that the dtg active
> format is not parsed inside libcle266mpegdec. From ffmpeg the
> information should be inside of a user data block marked with
> 0x0000001b2, followed by the tag 'DTG1', have a look at the function
> mpeg_decode_user_data() in libavcodec/mpeg12.c.
> I tried to implement a parser in libcle266mpegdec, but somehow I don't
> understand the parser, or the information is not there ...
>
> So I will now go on and have a look at the softdevice part. I guess I
> will move CheckAspectDimension() from video.c to mpegdecoder.c and
> reimplement it for the cle266 case.

Good good.

I might get a chance to test things at the weekend, along with some of the 
OSD transparency issues...

Cheers,

Laz


From marko.makela at hut.fi  Fri May 12 17:32:26 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 12 May 2006 18:32:26 +0300
Subject: [Softdevice-devel] Re: DirectFB downscaling
In-Reply-To: <1147352855.3518.12.camel@localhost.localdomain>
References: <200604221111.57846.stefan@lucke.in-berlin.de> <1145799555.27094.18.camel@localhost.localdomain> <200605052359.52422.stefan@lucke.in-berlin.de> <200605082206.16699.stefan@lucke.in-berlin.de> <1147352855.3518.12.camel@localhost.localdomain>
Message-ID: <20060512153226.GB5000@localhost.localdomain>

On Thu, May 11, 2006 at 10:37:35PM +0930, Malcolm Caldwell wrote:
> Perhaps the decision can also be based on if the source has differing
> dimensions to the destination?  (ie if (4:3->4:3) use the fast code?)

Excellent idea!  That would really be very helpful for my poor 900 MHz
system.

I think that it would be better to check if any vertical scaling is needed.
Over here, most 16:9 material is sent without encoding black bars at top
and bottom, and it displayed fine at 4:3 (clipping from left and right)
with the old code.

	Marko


From M.Wache at gmx.net  Fri May 12 17:54:30 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Fri, 12 May 2006 17:54:30 +0200
Subject: [Softdevice-devel] Re: DirectFB downscaling
In-Reply-To: <20060512153226.GB5000@localhost.localdomain>
References: <200604221111.57846.stefan@lucke.in-berlin.de> <1145799555.27094.18.camel@localhost.localdomain> <200605052359.52422.stefan@lucke.in-berlin.de> <200605082206.16699.stefan@lucke.in-berlin.de> <1147352855.3518.12.camel@localhost.localdomain> <20060512153226.GB5000@localhost.localdomain>
Message-ID: <4464AFB6.4070304@gmx.net>

Marko M?kel? schrieb:
> On Thu, May 11, 2006 at 10:37:35PM +0930, Malcolm Caldwell wrote:
>> Perhaps the decision can also be based on if the source has differing
>> dimensions to the destination?  (ie if (4:3->4:3) use the fast code?)
> 
> Excellent idea!  That would really be very helpful for my poor 900 MHz
> system.
> 

I think it would be better just to try to accelerate yv12_to_yuy2_il_c()
with mmx. That should be quite simple, one could use yv12_to_yuy2_mmx()
as a template and just adjust the pointers in the mmx code. Even better
would be to merge the two loops over the strides into one, so that the
cache usage (every u and v stride has to be accessed twice) would be
optimal.

Bye,
Martin


From M.Wache at gmx.net  Fri May 12 18:00:40 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Fri, 12 May 2006 18:00:40 +0200
Subject: [Softdevice-devel] Re: DirectFB downscaling
In-Reply-To: <4464AFB6.4070304@gmx.net>
References: <200604221111.57846.stefan@lucke.in-berlin.de> <1145799555.27094.18.camel@localhost.localdomain> <200605052359.52422.stefan@lucke.in-berlin.de> <200605082206.16699.stefan@lucke.in-berlin.de> <1147352855.3518.12.camel@localhost.localdomain> <20060512153226.GB5000@localhost.localdomain> <4464AFB6.4070304@gmx.net>
Message-ID: <4464B128.6030202@gmx.net>

Martin Wache schrieb:
> Marko M?kel? schrieb:
>> On Thu, May 11, 2006 at 10:37:35PM +0930, Malcolm Caldwell wrote:
>>> Perhaps the decision can also be based on if the source has differing
>>> dimensions to the destination?  (ie if (4:3->4:3) use the fast code?)
>> Excellent idea!  That would really be very helpful for my poor 900 MHz
>> system.
>>
> 
> I think it would be better just to try to accelerate yv12_to_yuy2_il_c()
> with mmx. That should be quite simple, one could use yv12_to_yuy2_mmx()
> as a template and just adjust the pointers in the mmx code. Even better
> would be to merge the two loops over the strides into one, so that the
> cache usage (every u and v stride has to be accessed twice) would be
> optimal.

Hmm, stupid me, scratch the last comment. The cache usage is
automatically ok, it is already in the way the loops are build :-)

Bye,
Martin


From M.Wache at gmx.net  Fri May 12 18:39:35 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Fri, 12 May 2006 18:39:35 +0200
Subject: [Softdevice-devel] Patch: cle266 hardware decoding...
In-Reply-To: <1147440041.44648ba9e9f70@webmail.in-berlin.de>
References: <200604301041.26837.laz@club-burniston.co.uk> <200605030951.10192.laz@club-burniston.co.uk> <200605071508.03603.stefan@lucke.in-berlin.de> <200605080957.25886.laz@club-burniston.co.uk> <445FA071.9040208@gmx.net> <4463934D.9080507@gmx.net> <1147440041.44648ba9e9f70@webmail.in-berlin.de>
Message-ID: <4464BA47.9060403@gmx.net>

Stefan Lucke schrieb:
> Quoting Martin Wache <M.Wache at gmx.net>:
>> I also had a look at the aspect ratio, it seems that the dtg active
>> format is not parsed inside libcle266mpegdec. From ffmpeg the
>> information should be inside of a user data block marked with
>> 0x0000001b2, followed by the tag 'DTG1', have a look at the function
>> mpeg_decode_user_data() in libavcodec/mpeg12.c.
>> I tried to implement a parser in libcle266mpegdec, but somehow I don't
>> understand the parser, or the information is not there ...
> 
> Do you have a test stream from which you know it has AFD data present ?
> I've only one and may upload it. In germany I havn't seen AFD data.
> 
No, I guess I haven't. I will ask you for it when I come back to
implementing it. Thanks!

>> So I will now go on and have a look at the softdevice part. I guess I
>> will move CheckAspectDimension() from video.c to mpegdecoder.c and
>> reimplement it for the cle266 case.
> 
> Isn't it easier just to fill relevant info in AVFarme and codec ?
> I guess we allocated both.
> 
Yes, that is definitely simpler, but in my opinion also much uncleaner.
The state of AVFrame and codec are undefined as long as we don't use
libavcodec (of course we allocate it, but usually we don't fill it), so
I think it's dangerous to pretend that everything is ok. And there will
be even more trouble if we have some variables which doesn't map 1:1 to
variables of ffmpeg...
Also we could remove the dependency on avcodec.h in video.h which is
only needed because we calculate the aspect ratio of the stream inside
of video.c.

Bye,
Martin


From stefan at lucke.in-berlin.de  Fri May 12 21:30:51 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 12 May 2006 21:30:51 +0200
Subject: [Softdevice-devel] Re: DirectFB downscaling
In-Reply-To: <4464AFB6.4070304@gmx.net>
References: <200604221111.57846.stefan@lucke.in-berlin.de> <20060512153226.GB5000@localhost.localdomain> <4464AFB6.4070304@gmx.net>
Message-ID: <200605122130.51398.stefan@lucke.in-berlin.de>

On Freitag 12 Mai 2006 17:54, Martin Wache wrote:
> Marko M?kel? schrieb:
> > On Thu, May 11, 2006 at 10:37:35PM +0930, Malcolm Caldwell wrote:
> >> Perhaps the decision can also be based on if the source has differing
> >> dimensions to the destination?  (ie if (4:3->4:3) use the fast code?)

No, that interlaced color ordering is independant of scaling. I originally
implemented and tested it with x11 out. There are still some remainders of
that in our cvs yet (reconfigure(YUY2) ..)

> > 
> > Excellent idea!  That would really be very helpful for my poor 900 MHz
> > system.
> > 
> 
> I think it would be better just to try to accelerate yv12_to_yuy2_il_c()
> with mmx. 

That's definitly a TODO. I'like to have some different sets of functions
which are allways present (therefor the _c extension). With compeled
set of conversion/reordering functions, the one to use could be set
at runtime (_mmx, _sse, _sse2, ..).


-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Fri May 12 21:30:57 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 12 May 2006 21:30:57 +0200
Subject: [Softdevice-devel] Patch: cle266 hardware decoding...
In-Reply-To: <4464BA47.9060403@gmx.net>
References: <200604301041.26837.laz@club-burniston.co.uk> <1147440041.44648ba9e9f70@webmail.in-berlin.de> <4464BA47.9060403@gmx.net>
Message-ID: <200605122130.57503.stefan@lucke.in-berlin.de>

On Freitag 12 Mai 2006 18:39, Martin Wache wrote:
> Stefan Lucke schrieb:
> > Quoting Martin Wache <M.Wache at gmx.net>:
> >> I also had a look at the aspect ratio, it seems that the dtg active
> >> format is not parsed inside libcle266mpegdec. From ffmpeg the
> >> information should be inside of a user data block marked with
> >> 0x0000001b2, followed by the tag 'DTG1', have a look at the function
> >> mpeg_decode_user_data() in libavcodec/mpeg12.c.
> >> I tried to implement a parser in libcle266mpegdec, but somehow I don't
> >> understand the parser, or the information is not there ...
> > 
> > Do you have a test stream from which you know it has AFD data present ?
> > I've only one and may upload it. In germany I havn't seen AFD data.
> > 
> No, I guess I haven't. I will ask you for it when I come back to
> implementing it. Thanks!
> 


> >> So I will now go on and have a look at the softdevice part. I guess I
> >> will move CheckAspectDimension() from video.c to mpegdecoder.c and
> >> reimplement it for the cle266 case.
> > 
> > Isn't it easier just to fill relevant info in AVFarme and codec ?
> > I guess we allocated both.
> > 
> Yes, that is definitely simpler, but in my opinion also much uncleaner.

I just want to avoid that mpeg2decoder grows and grows. It should
be split in some smaller pieces instead.

I guess at the current state, the whole cle266 code is a hack. But if I would get
my via dfbout work again (then hw accelerated :-) ), I'd like to include
that, even in some hackish state, into our cvs. Let's polish code later.

The only thing which must (should) be changed, is the layer index carried
in setup store. This should be a public member in videoDecoder. Unused
by others, so it doesn't harm.

> The state of AVFrame and codec are undefined as long as we don't use
> libavcodec (of course we allocate it, but usually we don't fill it), so
> I think it's dangerous to pretend that everything is ok. 

Filling only those members which are sufficiant to make CheckAspect..
and co. work, should be ok (setting only direct members, not those 
accessed via pointers). 

> And there will 
> be even more trouble if we have some variables which doesn't map 1:1 to
> variables of ffmpeg...
> Also we could remove the dependency on avcodec.h in video.h which is
> only needed because we calculate the aspect ratio of the stream inside
> of video.c.


-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Fri May 12 23:22:31 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 12 May 2006 23:22:31 +0200
Subject: [Softdevice-devel] Patch: cle266 hardware decoding...
In-Reply-To: <200605122130.57503.stefan@lucke.in-berlin.de>
References: <200604301041.26837.laz@club-burniston.co.uk> <4464BA47.9060403@gmx.net> <200605122130.57503.stefan@lucke.in-berlin.de>
Message-ID: <200605122322.31991.stefan@lucke.in-berlin.de>

On Freitag 12 Mai 2006 21:30, Stefan Lucke wrote:
> On Freitag 12 Mai 2006 18:39, Martin Wache wrote:
> > Stefan Lucke schrieb:
> > > Quoting Martin Wache <M.Wache at gmx.net>:
> > >> I also had a look at the aspect ratio, it seems that the dtg active
> > >> format is not parsed inside libcle266mpegdec. From ffmpeg the
> > >> information should be inside of a user data block marked with
> > >> 0x0000001b2, followed by the tag 'DTG1', have a look at the function
> > >> mpeg_decode_user_data() in libavcodec/mpeg12.c.
> > >> I tried to implement a parser in libcle266mpegdec, but somehow I don't
> > >> understand the parser, or the information is not there ...
> > > 
> > > Do you have a test stream from which you know it has AFD data present ?
> > > I've only one and may upload it. In germany I havn't seen AFD data.
> > > 
> > No, I guess I haven't. I will ask you for it when I come back to
> > implementing it. Thanks!
> > 

So short, that url didn't fit in ;-(  ( < 1MB):
http://www.lucke.in-berlin.de/afd_test.tgz

A 16:9 stream with AFD set to 4:3. It should fill entire 4:3 screen
and it shouldn't be letterboxed.

-- 
Stefan Lucke


From laz at club-burniston.co.uk  Sat May 13 12:16:25 2006
From: laz at club-burniston.co.uk (Laz)
Date: Sat, 13 May 2006 11:16:25 +0100
Subject: [Softdevice-devel] Patch: cle266 hardware decoding...
In-Reply-To: <Pine.OSF.4.61.0605081943120.27526@kosh.hut.fi>
References: <200604301041.26837.laz@club-burniston.co.uk> <200605080946.36388.laz@club-burniston.co.uk> <Pine.OSF.4.61.0605081943120.27526@kosh.hut.fi>
Message-ID: <200605131116.25524.laz@club-burniston.co.uk>

On Monday 08 May 2006 17:51, Rolf Ahrenberg wrote:
> On Mon, 8 May 2006, Laz wrote:
> > I think Rolf has tidied it up a bit but I haven't had a chance to look
> > yet: he may have sorted out the variables.
>
> Nope. I didn't touch any of them, because I don't know how you guys want
> to implement the whole hw decoding feature into softdevice. I just
> modified the library to better suit for automatic compilation and
> installing (for my gentoo box) and the patch to include preliminary (and
> untested) support for configure with some minor additional cleanups.
>
> The library requires some interface changes (i.e. getter for
> width/height/aspectratio, framebuffer device for opening, etc.), but I
> stopped working on that until things clear up a bit on the softdevice
> side.

I just did a quick test adding a usleep(100) to the hwdec_wait() polling 
function and my total CPU usage dropped from ca. 70-80% with software 
decoding, to ca. 35% without the usleep, to ca. 15% with it!

:)

I'm also tidying up some bits in softdevice but I've just managed to break 
software decoding!

Cheers,

Laz


From laz at club-burniston.co.uk  Sat May 13 16:31:18 2006
From: laz at club-burniston.co.uk (Laz)
Date: Sat, 13 May 2006 15:31:18 +0100
Subject: [Softdevice-devel] CLE266 hardware decoding: a bit of progress
Message-ID: <200605131531.18395.laz@club-burniston.co.uk>

I've made a bit of progress with my patch for CLE266 hardware MPEG2 decoding. 
Current version should be available here:

http://vdr.club-burniston.co.uk/softdevice_cle266.diff

This is based on softdevice cvs from today and includes Rolf's autoconf bits 
so that the configure script will include support automatically, if it finds 
the decoding library.

This version needs to be built against Rolf Ahrenberg's tarball of the decoder 
library (not the original one I did)
http://www.saunalahti.fi/~rahrenbe/vdr/patches/libcle266mpegdec-0.1.tar.gz

and it should also be patched to add support for storing PTS values:
https://lists.berlios.de/pipermail/softdevice-devel/2006q2/001987.html

I've put in a few more sanity checks and moved a variable I had added to 
cSetupSoftdevice into cVideoOut.

It is now 'sort of' full screen: the scaling of the video layer comes from 
context->sample_aspect_ratio.num and context->sample_aspect_ratio.den which 
would be set by avcodec_decode_video() (unless I've missed something!). At 
the moment, I am forcing these to 64 and 45, respectively, which are the 
values I was seeing for a 720x576 stream at 16:9. This means that a stream of 
this resolution is correct but resolutions such as 704x576 aren't expanded 
and have black borders at the sides.

Switching channels or jumping within a recording has a delay of about a second 
or so whilst the decoder sorts itself out (it probably needs resetting in 
these situations, or something: not really explored this yet) but seems to 
work OK otherwise.

Not tested it for any length of time, yet, so I'm not sure of the long-term 
stability yet. There is a little bit of stuttering with interlaced streams: 
not sure of the source of this yet, and the A-V sync needs sorting out. I 
need to get my head around how the PTS values are used in the sync algorithm: 
some parts seem to come from the call to avcodec_decode_video() and others 
from libavformat.

I've also found that adding a usleep(100) at ca. line 110 of 
libcle266mpegdec/src/decoder.c decreases the CPU usage a lot: the overall CPU 
usage drops from ca. 80% with software decoding, to ca. 35% with hardware 
decoding without the usleep, and to ca. 14% with it. The highest load process 
is now down to 9% or so. In theory, there is an interrupt for when the 
decoder is ready but apparently the hardware is broken.

:(

Still needs working on but it's getting there and looking good!

:)

Cheers,

Laz


From nicolas at huillard.net  Sat May 13 16:53:09 2006
From: nicolas at huillard.net (Nicolas Huillard)
Date: Sat, 13 May 2006 16:53:09 +0200
Subject: [Softdevice-devel] CLE266 hardware decoding: a bit of progress
In-Reply-To: <200605131531.18395.laz@club-burniston.co.uk>
References: <200605131531.18395.laz@club-burniston.co.uk>
Message-ID: <4465F2D5.2040709@huillard.net>

Laz a ?crit :
> Still needs working on but it's getting there and looking good!

Sincere congratulations for your work, and patches from others !
I'll definitely have a look at all this early next week !

-- 
NH


From rahrenbe at cc.hut.fi  Sat May 13 17:36:14 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Sat, 13 May 2006 18:36:14 +0300 (EEST)
Subject: [Softdevice-devel] CLE266 hardware decoding: a bit of progress
In-Reply-To: <200605131531.18395.laz@club-burniston.co.uk>
References: <200605131531.18395.laz@club-burniston.co.uk>
Message-ID: <Pine.OSF.4.61.0605131832140.39722@kosh.hut.fi>

On Sat, 13 May 2006, Laz wrote:

>
> I've made a bit of progress with my patch for CLE266 hardware MPEG2 decoding.
> Current version should be available here:
>
> http://vdr.club-burniston.co.uk/softdevice_cle266.diff

Your server timeouts here. Could send the patch directly to me, so I 
would update the library with latest modifications (a few cleanups from 
me, Martin's pts patch, your experimental usleep patch). As the library 
is still experimental and under development I won't increment the 
version number.

BR,
--
rofa


From rahrenbe at cc.hut.fi  Sat May 13 22:14:33 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Sat, 13 May 2006 23:14:33 +0300 (EEST)
Subject: [Softdevice-devel] CLE266 hardware decoding: a bit of progress
In-Reply-To: <Pine.OSF.4.61.0605131832140.39722@kosh.hut.fi>
References: <200605131531.18395.laz@club-burniston.co.uk>
 <Pine.OSF.4.61.0605131832140.39722@kosh.hut.fi>
Message-ID: <Pine.OSF.4.61.0605132308090.334651@kosh.hut.fi>

On Sat, 13 May 2006, Rolf Ahrenberg wrote:

> On Sat, 13 May 2006, Laz wrote:
>
>> 
>> I've made a bit of progress with my patch for CLE266 hardware MPEG2 
>> decoding.
>> Current version should be available here:
>> 
>> http://vdr.club-burniston.co.uk/softdevice_cle266.diff
>
> Your server timeouts here. Could send the patch directly to me, so I would 
> update the library with latest modifications (a few cleanups from me, 
> Martin's pts patch, your experimental usleep patch). As the library is still 
> experimental and under development I won't increment the version number.

OK. I've now uploaded the updated libcle266mpegdec-0.1.tar.gz to the 
server. It includes my attempt to fill up those aspect ratio numerators 
and denominators - hopefully I didn't misunderstood the feature.

I did try the usleep hack in the decoder. It really brings my CPU load 
from 30% to 3%, but the drawback is jerky picture on my TV. So I left it 
out.. Please, let me know if broke something in the library or the 
included softdevice patch.

BR,
--
rofa


From M.Wache at gmx.net  Sun May 14 10:17:20 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 14 May 2006 10:17:20 +0200
Subject: [Softdevice-devel] Patch: cle266 hardware decoding...
In-Reply-To: <200605122130.57503.stefan@lucke.in-berlin.de>
References: <200604301041.26837.laz@club-burniston.co.uk> <1147440041.44648ba9e9f70@webmail.in-berlin.de> <4464BA47.9060403@gmx.net> <200605122130.57503.stefan@lucke.in-berlin.de>
Message-ID: <4466E790.8090609@gmx.net>

Stefan Lucke schrieb:
>>>> So I will now go on and have a look at the softdevice part. I guess I
>>>> will move CheckAspectDimension() from video.c to mpegdecoder.c and
>>>> reimplement it for the cle266 case.
>>> Isn't it easier just to fill relevant info in AVFarme and codec ?
>>> I guess we allocated both.
>>>
>> Yes, that is definitely simpler, but in my opinion also much uncleaner.
> 
> I just want to avoid that mpeg2decoder grows and grows. It should
> be split in some smaller pieces instead.
> 
I agree with you that mpeg2decoder contains things which doesn't belong
there, for example the filtering together with the filter contexts.

> I guess at the current state, the whole cle266 code is a hack. But if I would get
> my via dfbout work again (then hw accelerated :-) ), I'd like to include
> that, even in some hackish state, into our cvs. Let's polish code later.
>
Here I don't understand you, on one hand you say mpeg2decoder should not
grow anymore, on the other hand you want to include a hack into
mpeg2decoder, which will certainly not make the code more readable. And
who is going to do the clean up? I don't think that we will receive
patches by other people which clean the mess up once the code is in. So
it is either you or me who has to do the cleaning. Will you do this?

Right now there seem several people interested in getting the cle266
decoder work with the softdevice, you and me included. So in my opinion
it is the best to do it right from the start, and not to include hacks.
 To me that means that we should process all the information of the
stream inside the decoders (inside mpeg2decoder) and pass only the
relevant information (dimension, aspect ratio, the pictures,...) to the
filters and the video out.

> The only thing which must (should) be changed, is the layer index carried
> in setup store. This should be a public member in videoDecoder. Unused
> by others, so it doesn't harm.
> 
It doesn't have to be a public member in videoDecoder, it can also be a
local variable in cVideoStreamDecoder::DecodePacker(), but the important
point is how we pass it to the video-out. I think we need a structure
here which can pass the pictures to the video out, which supports direct
rendering.

>> The state of AVFrame and codec are undefined as long as we don't use
>> libavcodec (of course we allocate it, but usually we don't fill it), so
>> I think it's dangerous to pretend that everything is ok. 
> 
> Filling only those members which are sufficiant to make CheckAspect..
> and co. work, should be ok (setting only direct members, not those 
> accessed via pointers). 
> 
As you say it _should_ be ok, but _will_ it be ok? What will happen when
we include the next hack? What will break? What happens if ffmpeg
changes in some subtle way? No, I don't like this, it is a hack and
nothing else.


Bye,
Martin


From M.Wache at gmx.net  Sun May 14 10:25:39 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sun, 14 May 2006 10:25:39 +0200
Subject: [Softdevice-devel] CLE266 hardware decoding: a bit of progress
In-Reply-To: <Pine.OSF.4.61.0605132308090.334651@kosh.hut.fi>
References: <200605131531.18395.laz@club-burniston.co.uk> <Pine.OSF.4.61.0605131832140.39722@kosh.hut.fi> <Pine.OSF.4.61.0605132308090.334651@kosh.hut.fi>
Message-ID: <4466E983.1020103@gmx.net>

Rolf Ahrenberg schrieb:
> On Sat, 13 May 2006, Rolf Ahrenberg wrote:
> 
>> On Sat, 13 May 2006, Laz wrote:
>>
>>>
>>> I've made a bit of progress with my patch for CLE266 hardware MPEG2
>>> decoding.
>>> Current version should be available here:
>>>
>>> http://vdr.club-burniston.co.uk/softdevice_cle266.diff
>>
>> Your server timeouts here. Could send the patch directly to me, so I
>> would update the library with latest modifications (a few cleanups
>> from me, Martin's pts patch, your experimental usleep patch). As the
>> library is still experimental and under development I won't increment
>> the version number.
> 
> OK. I've now uploaded the updated libcle266mpegdec-0.1.tar.gz to the
> server. It includes my attempt to fill up those aspect ratio numerators
> and denominators - hopefully I didn't misunderstood the feature.
> 
> I did try the usleep hack in the decoder. It really brings my CPU load
> from 30% to 3%, but the drawback is jerky picture on my TV. So I left it
> out.. Please, let me know if broke something in the library or the
> included softdevice patch.
> 
I haven't had the time yet to look at your latest code, hopefully I will
have some time this evening.
But I want to say that the usleep part isn't properly working also for
me. That busy waiting is definitely something which should be improved,
but I fear that usleep won't work. The minimum sleep time is 1ms
(depending on the kernel) and that seems to be too much.

Bye,

Martin


From laz at club-burniston.co.uk  Sun May 14 10:57:28 2006
From: laz at club-burniston.co.uk (Laz)
Date: Sun, 14 May 2006 09:57:28 +0100
Subject: [Softdevice-devel] CLE266 hardware decoding: a bit of progress
In-Reply-To: <4466E983.1020103@gmx.net>
References: <200605131531.18395.laz@club-burniston.co.uk> <Pine.OSF.4.61.0605132308090.334651@kosh.hut.fi> <4466E983.1020103@gmx.net>
Message-ID: <200605140957.29117.laz@club-burniston.co.uk>

On Sunday 14 May 2006 09:25, Martin Wache wrote:
> Rolf Ahrenberg schrieb:

> > OK. I've now uploaded the updated libcle266mpegdec-0.1.tar.gz to the
> > server. It includes my attempt to fill up those aspect ratio numerators
> > and denominators - hopefully I didn't misunderstood the feature.

I'm not convinced that your numbers here are correct: I get black borders at 
the top and bottom of my 16:9 TV now. I also found a channel which wasn't 
expanded properly horizontally. I'll see if I can find the relevant bits in 
ffmpeg and see what values are set there. I was seeing things like 64/45 when 
I looked at the output from software decoding.

> > I did try the usleep hack in the decoder. It really brings my CPU load
> > from 30% to 3%, but the drawback is jerky picture on my TV. So I left it
> > out.. Please, let me know if broke something in the library or the
> > included softdevice patch.

Your patch and library seem to work fine for me apart from the black borders.

> I haven't had the time yet to look at your latest code, hopefully I will
> have some time this evening.
> But I want to say that the usleep part isn't properly working also for
> me. That busy waiting is definitely something which should be improved,
> but I fear that usleep won't work. The minimum sleep time is 1ms
> (depending on the kernel) and that seems to be too much.

I must admit that I thought the resolution would be better than that! Maybe 
having it without is the best that can be achieved practically.

Do we need to determine coded_picture_number somehow, too? This is probably 
why I'm getting the odd # in my output:

    /* ------------------------------------------------------------------------
     * DV read via dv1394 seems to have
     * context->coded_frame->coded_picture_number
     * always set to zero. Therefor lets do the following guess upon current
     * PTS value. Don't know if there are other codecs which deliver
     * codec_picture_number as zero.
     * Hopefully noone else will see '#' chars printed.
     */
    if (!pts && lastPTS != (int64_t) AV_NOPTS_VALUE)
    {
       fprintf(stderr,"#");
       pts = lastPTS;
    }

Cheers,

Laz


From rahrenbe at cc.hut.fi  Sun May 14 11:43:28 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Sun, 14 May 2006 12:43:28 +0300 (EEST)
Subject: [Softdevice-devel] CLE266 hardware decoding: a bit of progress
In-Reply-To: <200605140957.29117.laz@club-burniston.co.uk>
References: <200605131531.18395.laz@club-burniston.co.uk>
 <Pine.OSF.4.61.0605132308090.334651@kosh.hut.fi> <4466E983.1020103@gmx.net>
 <200605140957.29117.laz@club-burniston.co.uk>
Message-ID: <Pine.OSF.4.61.0605141234170.324914@kosh.hut.fi>

On Sun, 14 May 2006, Laz wrote:

> I'm not convinced that your numbers here are correct: I get black borders at
> the top and bottom of my 16:9 TV now. I also found a channel which wasn't
> expanded properly horizontally. I'll see if I can find the relevant bits in
> ffmpeg and see what values are set there. I was seeing things like 64/45 when
> I looked at the output from software decoding.

My quick look at the ffmpeg code revealed that it's calculating the 
num/den pair from the aspect ratio information that is a float. There's 
a strange minor horizontal shift in my 16:9 TV set, if the softdevice's 
aspect ratio is set to default or 16:9. However if I set the screen to 
16:10 the video scaling seems to be correct and without any 
vertical/horizontal shift.

BR,
--
rofa


From patrick.boettcher at desy.de  Sun May 14 14:47:43 2006
From: patrick.boettcher at desy.de (Patrick Boettcher)
Date: Sun, 14 May 2006 14:47:43 +0200 (CEST)
Subject: [Softdevice-devel] colored snow with softplay
Message-ID: <Pine.LNX.4.64.0605141421100.9954@pub4.ifh.de>

Hi list,
Hi Tobi,

first of all a big thank you to the softdevice-team for providing 
softdevice and softplay. I'm using it now since one year and after some 
starting difficulties and after switching to e-tobi.net (for using vdr 
without headaches) I have to say this solution is very stable. Is it time 
for softdevice 1.0?

When Tobi included softplay as a package I considered to use it to watch 
xvids (instead of manual invoking mplayer on my vdr-machine). And another 
time I was convinced that softdevice/softplay is a stable solution. 
Setting up a vdr with softdevice/play is easier than using vdr with a 
ff-card and the mplayer-plugin.

Unfortunately softplay seems not to be so popular and I think that is why 
the softplay-plugin is not up-to-date in his repository. It currently 
needs vdr-1.3.41 . I was staying at that version as long as I could resist 
to update, but now there is vdr 1.4 and I really wanted to update.

So I updated normally apt-get update ... bla. Except softplay everything 
is working very fine.

This morning I simply thought, just getting the vdr-plugin-softplay 
package source, getting the -dev-dependencies and a simply 
dpkg-buildpackage is enough to create a softplay-package for vdr-1.4 . I 
was not completely wrong:

The softplay menu entry appears, I can select all my media files but one 
thing is strange:

When I play a file (which was working yesterday with 1.3.41 and softplay) 
I just get audio now and "colored snow" as a picture. I have absolutely no 
idea what is wrong. My feeling is, that the video cannot be decoded by 
libavcodec. When updating Debian not only e-tobi was updated, but also 
other packages from testing. I also used the latest CVS source of softplay 
- result is the same.

I tried it on my vdr-machine (using dfb with mga) and on my 
desktop-machine using xv - both have the same symptoms.

During the compilation I saw some warnings (attached is the build-output).

I have the feeling there is a lot I could do to track down the problem, 
but to be honest, I don't exactly know where to start. I would appreciate 
if someone can help me debugging this issue and I'll be happy to provide 
useful information.

best regards,
Patrick.

--
  Mail: patrick.boettcher at desy.de
  WWW:  http://www.wi-bw.tfh-wildau.de/~pboettch/


From listaccount at e-tobi.net  Sun May 14 16:39:58 2006
From: listaccount at e-tobi.net (Tobias Grimm)
Date: Sun, 14 May 2006 16:39:58 +0200
Subject: [Softdevice-devel] colored snow with softplay
In-Reply-To: <Pine.LNX.4.64.0605141421100.9954@pub4.ifh.de>
References: <Pine.LNX.4.64.0605141421100.9954@pub4.ifh.de>
Message-ID: <4467413E.1060902@e-tobi.net>

Patrick Boettcher wrote:

>Unfortunately softplay seems not to be so popular and I think that is why 
>the softplay-plugin is not up-to-date in his repository. It currently 
>needs vdr-1.3.41 .
>

??? The softplay package in my repository is for vdr 1.4.0. Which
version are you using?

The current version in my vdr-experimental repository is a CVS snapshot
from 2006-03-23 with a small patch, that adapts the Makefile for VDR 1.4.0.

>During the compilation I saw some warnings (attached is the build-output).
>  
>

Sorry, no attachment in your mail!

Tobias


From patrick.boettcher at desy.de  Sun May 14 16:52:41 2006
From: patrick.boettcher at desy.de (Patrick Boettcher)
Date: Sun, 14 May 2006 16:52:41 +0200 (CEST)
Subject: [Softdevice-devel] colored snow with softplay
In-Reply-To: <4467413E.1060902@e-tobi.net>
References: <Pine.LNX.4.64.0605141421100.9954@pub4.ifh.de> <4467413E.1060902@e-tobi.net>
Message-ID: <Pine.LNX.4.64.0605141647090.9954@pub4.ifh.de>

Hi Tobias,

On Sun, 14 May 2006, Tobias Grimm wrote:
> >Unfortunately softplay seems not to be so popular and I think that is why 
> >the softplay-plugin is not up-to-date in his repository. It currently 
> >needs vdr-1.3.41 .
> >
> 
> ??? The softplay package in my repository is for vdr 1.4.0. Which
> version are you using?

deb http://e-tobi.net/vdr-experimental sarge base backports addons 
vdr-multipatch

When I select softplay it says:

vdr-plugin-softplay: Conflicts: vdr (> 1.3.41-9999) but 1.4.0-1ctvdr1 is 
to be installed

(vdr is installed and running)

While all other packages are updated fluently, this package was making 
problems all the time. Sorry for my mistake, but I don't know what is 
wrong with my setup.

regards,
Patrick.

--
  Mail: patrick.boettcher at desy.de
  WWW:  http://www.wi-bw.tfh-wildau.de/~pboettch/


From listaccount at e-tobi.net  Sun May 14 17:42:29 2006
From: listaccount at e-tobi.net (Tobias Grimm)
Date: Sun, 14 May 2006 17:42:29 +0200
Subject: [Softdevice-devel] colored snow with softplay
In-Reply-To: <Pine.LNX.4.64.0605141647090.9954@pub4.ifh.de>
References: <Pine.LNX.4.64.0605141421100.9954@pub4.ifh.de> <4467413E.1060902@e-tobi.net> <Pine.LNX.4.64.0605141647090.9954@pub4.ifh.de>
Message-ID: <44674FE5.2060001@e-tobi.net>

Patrick Boettcher wrote:

> vdr-plugin-softplay: Conflicts: vdr (> 1.3.41-9999) but 1.4.0-1ctvdr1 is
>
>to be installed
>  
>

Please do an "apt-get update" and try to install softplay again.

Tobias


From patrick.boettcher at desy.de  Sun May 14 18:16:12 2006
From: patrick.boettcher at desy.de (Patrick Boettcher)
Date: Sun, 14 May 2006 18:16:12 +0200 (CEST)
Subject: [Softdevice-devel] colored snow with softplay
In-Reply-To: <44674FE5.2060001@e-tobi.net>
References: <Pine.LNX.4.64.0605141421100.9954@pub4.ifh.de> <4467413E.1060902@e-tobi.net>
 <Pine.LNX.4.64.0605141647090.9954@pub4.ifh.de> <44674FE5.2060001@e-tobi.net>
Message-ID: <Pine.LNX.4.64.0605141809570.9954@pub4.ifh.de>

On Sun, 14 May 2006, Tobias Grimm wrote:

> Patrick Boettcher wrote:
> 
> > vdr-plugin-softplay: Conflicts: vdr (> 1.3.41-9999) but 1.4.0-1ctvdr1 is
> >
> >to be installed
> >  
> >
> 
> Please do an "apt-get update" and try to install softplay again.

OK. Installing it from the repository worked. Thanks. I misunderstood the 
concept of your vdr repository and that's why I haven't reported that 
earlier to you. Sorry.

But my original problem persists.

It is quite easy to reproduce:

On my desktop I just ran 

vdr -v /var/lib/video.00 -c /var/lib/vdr -L /usr/lib/vdr/plugins 
-P"softdevice -vo xv:" -P"softplay --media-path /media-softplay"

(even without having a dvb card)

In /media-softplay there is a normal xvid/divx and when I run it I have 
sound but the video is garbage.

Patrick.

--
  Mail: patrick.boettcher at desy.de
  WWW:  http://www.wi-bw.tfh-wildau.de/~pboettch/


From stefan at lucke.in-berlin.de  Sun May 14 19:25:24 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 14 May 2006 19:25:24 +0200
Subject: [Softdevice-devel] colored snow with softplay
In-Reply-To: <Pine.LNX.4.64.0605141809570.9954@pub4.ifh.de>
References: <Pine.LNX.4.64.0605141421100.9954@pub4.ifh.de> <44674FE5.2060001@e-tobi.net> <Pine.LNX.4.64.0605141809570.9954@pub4.ifh.de>
Message-ID: <200605141925.24899.stefan@lucke.in-berlin.de>

On Sonntag 14 Mai 2006 18:16, Patrick Boettcher wrote:
> On Sun, 14 May 2006, Tobias Grimm wrote:
> 
> > Patrick Boettcher wrote:
> > 
> > > vdr-plugin-softplay: Conflicts: vdr (> 1.3.41-9999) but 1.4.0-1ctvdr1 is
> > >
> > >to be installed
> > >  
> > >
> > 
> > Please do an "apt-get update" and try to install softplay again.
> 
> OK. Installing it from the repository worked. Thanks. I misunderstood the 
> concept of your vdr repository and that's why I haven't reported that 
> earlier to you. Sorry.
> 
> But my original problem persists.
> 
> It is quite easy to reproduce:
> 
> On my desktop I just ran 
> 
> vdr -v /var/lib/video.00 -c /var/lib/vdr -L /usr/lib/vdr/plugins 
> -P"softdevice -vo xv:" -P"softplay --media-path /media-softplay"
> 
> (even without having a dvb card)
> 
> In /media-softplay there is a normal xvid/divx and when I run it I have 
> sound but the video is garbage.

Assuming they played previously fine.
Did you upgrade your ffmpeg version too ?
So which version is reported at startup from softdevice ?

-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Sun May 14 22:25:22 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 14 May 2006 22:25:22 +0200
Subject: [Softdevice-devel] Patch: cle266 hardware decoding...
In-Reply-To: <4466E790.8090609@gmx.net>
References: <200604301041.26837.laz@club-burniston.co.uk> <200605122130.57503.stefan@lucke.in-berlin.de> <4466E790.8090609@gmx.net>
Message-ID: <200605142225.22150.stefan@lucke.in-berlin.de>

On Sonntag 14 Mai 2006 10:17, Martin Wache wrote:
> Stefan Lucke schrieb:
> >>>> So I will now go on and have a look at the softdevice part. I guess I
> >>>> will move CheckAspectDimension() from video.c to mpegdecoder.c and
> >>>> reimplement it for the cle266 case.
> >>> Isn't it easier just to fill relevant info in AVFarme and codec ?
> >>> I guess we allocated both.
> >>>
> >> Yes, that is definitely simpler, but in my opinion also much uncleaner.
> > 
> > I just want to avoid that mpeg2decoder grows and grows. It should
> > be split in some smaller pieces instead.
> > 
> I agree with you that mpeg2decoder contains things which doesn't belong
> there, for example the filtering together with the filter contexts.
> 
> > I guess at the current state, the whole cle266 code is a hack. But if I would get
> > my via dfbout work again (then hw accelerated :-) ), I'd like to include
> > that, even in some hackish state, into our cvs. Let's polish code later.
> >
> Here I don't understand you, on one hand you say mpeg2decoder should not
> grow anymore, on the other hand you want to include a hack into
> mpeg2decoder, which will certainly not make the code more readable.

I guess you are right. The wish of including this should not turn off
some sort of thinking ;-) .
A bad thing too would be: Hm, now we have some sort of HW acceleration,
XvMC for DirectFB but it doesn' work with X11 XvMC :-( .

And even worse ffmpeg's XVMC make some troubles.
Some troubles to get it compiled in, adding a HAVE_XVMC in config.h
and a HAVE_XVMC_ACCEL=yes in config.mak.
But most trouble could be the hack setting SLICE_FLAG_CODED_ORDER.
avcodec_decode_video() returns now a negative value 

videoout should be extended by a function which formats are
supported like "VideoOut->SupportsFormat(FOURCC_XVMC)"
By default only YV12 is supported by all.


-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: xvmc-01.patch
Type: text/x-diff
Size: 2487 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060514/24014921/attachment.patch>

From M.Wache at gmx.net  Mon May 15 21:13:45 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 15 May 2006 21:13:45 +0200
Subject: [Softdevice-devel] Patch: cle266 hardware decoding...
In-Reply-To: <200605142225.22150.stefan@lucke.in-berlin.de>
References: <200604301041.26837.laz@club-burniston.co.uk> <200605122130.57503.stefan@lucke.in-berlin.de> <4466E790.8090609@gmx.net> <200605142225.22150.stefan@lucke.in-berlin.de>
Message-ID: <4468D2E9.8010108@gmx.net>

Stefan Lucke schrieb:
> On Sonntag 14 Mai 2006 10:17, Martin Wache wrote:
>> Stefan Lucke schrieb:
>>>>>> So I will now go on and have a look at the softdevice part. I guess I
>>>>>> will move CheckAspectDimension() from video.c to mpegdecoder.c and
>>>>>> reimplement it for the cle266 case.
>>>>> Isn't it easier just to fill relevant info in AVFarme and codec ?
>>>>> I guess we allocated both.
>>>>>
>>>> Yes, that is definitely simpler, but in my opinion also much uncleaner.
>>> I just want to avoid that mpeg2decoder grows and grows. It should
>>> be split in some smaller pieces instead.
>>>
>> I agree with you that mpeg2decoder contains things which doesn't belong
>> there, for example the filtering together with the filter contexts.
>>
>>> I guess at the current state, the whole cle266 code is a hack. But if I would get
>>> my via dfbout work again (then hw accelerated :-) ), I'd like to include
>>> that, even in some hackish state, into our cvs. Let's polish code later.
>>>
>> Here I don't understand you, on one hand you say mpeg2decoder should not
>> grow anymore, on the other hand you want to include a hack into
>> mpeg2decoder, which will certainly not make the code more readable.
> 
> I guess you are right. The wish of including this should not turn off
> some sort of thinking ;-) .
> A bad thing too would be: Hm, now we have some sort of HW acceleration,
> XvMC for DirectFB but it doesn' work with X11 XvMC :-( .
>
Indeed it would be the best solution to have the same (or at least a
similar) interface for X11 XvMC and the however it will be called
DirectFB hw mpeg2 acceleration. If one could even use the same lowlevel
code that would be perfect.


> And even worse ffmpeg's XVMC make some troubles.
> Some troubles to get it compiled in, adding a HAVE_XVMC in config.h
> and a HAVE_XVMC_ACCEL=yes in config.mak.
> But most trouble could be the hack setting SLICE_FLAG_CODED_ORDER.
> avcodec_decode_video() returns now a negative value 
>
As far as I remember ffmpeg doesn't support the VIA style of hw mpeg2
decoding, there is a patch for mplayer, which contains a patch for
ffmpeg which one has to apply.

Bye,
Martin


From M.Wache at gmx.net  Mon May 15 21:31:30 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 15 May 2006 21:31:30 +0200
Subject: [Softdevice-devel] CLE266 hardware decoding: a bit of progress
In-Reply-To: <200605140957.29117.laz@club-burniston.co.uk>
References: <200605131531.18395.laz@club-burniston.co.uk> <Pine.OSF.4.61.0605132308090.334651@kosh.hut.fi> <4466E983.1020103@gmx.net> <200605140957.29117.laz@club-burniston.co.uk>
Message-ID: <4468D712.30708@gmx.net>

Laz schrieb:
> On Sunday 14 May 2006 09:25, Martin Wache wrote:
>> Rolf Ahrenberg schrieb:
> 
>>> OK. I've now uploaded the updated libcle266mpegdec-0.1.tar.gz to the
>>> server. It includes my attempt to fill up those aspect ratio numerators
>>> and denominators - hopefully I didn't misunderstood the feature.
> 
> I'm not convinced that your numbers here are correct: I get black borders at 
> the top and bottom of my 16:9 TV now. I also found a channel which wasn't 
> expanded properly horizontally. I'll see if I can find the relevant bits in 
> ffmpeg and see what values are set there. I was seeing things like 64/45 when 
> I looked at the output from software decoding.
> 
>>> I did try the usleep hack in the decoder. It really brings my CPU load
>>> from 30% to 3%, but the drawback is jerky picture on my TV. So I left it
>>> out.. Please, let me know if broke something in the library or the
>>> included softdevice patch.
> 
> Your patch and library seem to work fine for me apart from the black borders.
> 
>> I haven't had the time yet to look at your latest code, hopefully I will
>> have some time this evening.
>> But I want to say that the usleep part isn't properly working also for
>> me. That busy waiting is definitely something which should be improved,
>> but I fear that usleep won't work. The minimum sleep time is 1ms
>> (depending on the kernel) and that seems to be too much.
> 
> I must admit that I thought the resolution would be better than that! Maybe 
> having it without is the best that can be achieved practically.
>
I had a look at the latest libViaXvMC and it seems that they do sleep in
the loop using nanosleep. I'm not sure if nanosleep has a better
resolution, they also seem to use DMA to copy the slices, maybe that
makes a difference. I think I remember much lower CPU usages (less <10%)
from xine using the latest X11 XvMC VIA hw decoding, does somebody know
some numbers? Is it worth to think about integrating the DMA routines?


> Do we need to determine coded_picture_number somehow, too? This is probably 
> why I'm getting the odd # in my output:
> 
No, that is not needed, it is a part of a hack which we use to sort the
pts values to the decoded frames. With my pts patch to your library we
already know the pts values.

In fact quite a lot of the code inside
cVideoStreamDecoder::DecodePacket() which deals with pts values is not
needed in your case. One could try to gather the ffmpeg specific stuff
and move it into a separate method, which returns a more general picture
structure already including the pts. For the via hw decoding one could
write a similar method... I will send my patch for direct rendering to
the list, it is still unfinished and may crash, but it is probably good
to discuss if it is useful for your patches and what changes still need
to be done.

Bye,
Martin


From M.Wache at gmx.net  Mon May 15 22:20:31 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 15 May 2006 22:20:31 +0200
Subject: [Softdevice-devel] [PATCH] direct rendering
Message-ID: <4468E28F.60306@gmx.net>

Hi list,

I'm sending you my first concept for direct rendering with the
softdevice, meaning that the video-out allocates the picture buffes (not
necessarily in video memory, which may be slower). There are many
advantages of direct rendering, for example the pictures get allocated
by the video out, so they can be used at any time by the video out,
without having to fear that they have been deleted (because the
mpeg2decoder has been reseted). Very nice for software alpha blending
and we can also implement screenshots a lot easier :-). X11 XvMC needs
direct rendering and I think Laz patches also could benefit from it. For
Xv-out it would also be faster to use direct rendering.

The main part is the PicBuffer structure:

  typedef struct sPicBuffer {
    PixelFormat format;
    uint8_t *pixel[4];
    int stride[4];
    unsigned int use_count;
    int max_width;
    int max_height;
    int edge_width;  // needed by ffmpeg
    int edge_height; // needed by ffmpeg
    int Width;
    int Height;
    int buf_num;      // video-out specific buffer number
    int pic_num;     // needed by ffmpeg
    void *priv_data;
  };

I want to propose to use this structure (which can of course be extended
 by aspect ratio,pts etc..) for decoded pictures.
If one uses filters, the decoder should allocate the picture buffers
from the filters, the filters from the video out, else the decoder
should directly use the buffers from the video out.
My patch already overrides ffmpegs get_buffer()/release_buffer() to use
picture buffes from the video out, the filters still have to be changed.

In case of Laz hardware decoding patches the fb could be stored in
buf_num, and if one sets up *pixel[] correctly even filtering would be
possible (but most likely it would be slow...), however it would be nice
for software alpha blending.

There are still a lot of open questions, especially on the filtering...
Comments are welcome :-)

Bye,
Martin


From ivor at ivor.org  Mon May 15 22:18:21 2006
From: ivor at ivor.org (Ivor Hewitt)
Date: Mon, 15 May 2006 21:18:21 +0100
Subject: [Softdevice-devel] Via CLE266 hardware MPEG decoding...
Message-ID: <200605152118.21598.ivor@ivor.org>

Hey all,

Came into this thread late (er and sorry for breaking the threading) after 
someone replied to me here:-
http://forums.viaarena.com/messageview.aspx?catid=28&threadid=72183&enterthread=y

We've talked about this subject many times but always had more (self)interest 
in getting working X drivers instead... and a lack of volunteers wanting to 
work on frame buffer code.

Providing a mechanism by which the X specific portions can be removed from the 
XvMC driver and the common code shared with directfb would be 'a really good 
thing'.

To clear up a couple of questions that were raised:-

The original ddmpeg library worked under both X and FB. However it is a 
proprietary VIA specific interface and only taken advantage of with VeMP and 
VeXP.

>> If that patch doesn't add X dependency (or run-time X dependency), that
>> would be great !
> Most of what I've seen depends heavily on X.
>
Well it depends on X to the effect that it relies on allocating memory and 
interfacing with the Xv/XvMC interface.


It wouldn't be a collosal undertaking to abstract this out of the via xvmc 
library and allow directfb to allocate memory and do the window management.

Regards,
-- 
Ivor Hewitt.
http://www.openchrome.org


From M.Wache at gmx.net  Mon May 15 23:27:56 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 15 May 2006 23:27:56 +0200
Subject: [Softdevice-devel] Via CLE266 hardware MPEG decoding...
In-Reply-To: <200605152118.21598.ivor@ivor.org>
References: <200605152118.21598.ivor@ivor.org>
Message-ID: <4468F25C.6070406@gmx.net>

Ivor Hewitt schrieb:
> Hey all,
> 
> Came into this thread late (er and sorry for breaking the threading) after 
> someone replied to me here:-
> http://forums.viaarena.com/messageview.aspx?catid=28&threadid=72183&enterthread=y
> 
> We've talked about this subject many times but always had more (self)interest 
> in getting working X drivers instead... and a lack of volunteers wanting to 
> work on frame buffer code.
> 
> Providing a mechanism by which the X specific portions can be removed from the 
> XvMC driver and the common code shared with directfb would be 'a really good 
> thing'.
>

I agree with you that it would be the best to share as much code as
possible. I had a look at the latest libviaXvMC and in fact
viaLowLevel.c is very similar to what Laz uses in his library. The one
major difference is the use of DMA, and I don't know if it is simple to
set up DMA from userspace. So maybe it is the best to start with the
code as it is now and try to get it working and then try to synchronize
the code bases.

What I'm not really sure about is what are Laz's plans for the library.
Laz, do you want your library to a stand alone library or would you like
to try to integrate it into DirectFB?  I would prefer the latter - but I
guess that means more work...

> To clear up a couple of questions that were raised:-
> 
> The original ddmpeg library worked under both X and FB. However it is a 
> proprietary VIA specific interface and only taken advantage of with VeMP and 
> VeXP.
>
The most pressing question on my mind is: is it possible to reduce the
CPU load by getting rid of the busy loop while waiting for the decoder
to become ready again? It's quite stupid to waste CPU time just for
waiting for the decoder if the goal of using the decoder was to save CPU
time :-)

It is really good to know that you are interested in the development, so
we can ask a lot of questions concerning the via chipset :-)

Bye,
Martin


From ivor at ivor.org  Mon May 15 23:42:57 2006
From: ivor at ivor.org (Ivor Hewitt)
Date: Mon, 15 May 2006 22:42:57 +0100
Subject: [Softdevice-devel] Via CLE266 hardware MPEG decoding...
In-Reply-To: <4468F25C.6070406@gmx.net>
References: <200605152118.21598.ivor@ivor.org> <4468F25C.6070406@gmx.net>
Message-ID: <200605152242.58045.ivor@ivor.org>

On Monday 15 May 2006 22:27, Martin Wache wrote:
>
> I agree with you that it would be the best to share as much code as
> possible. I had a look at the latest libviaXvMC and in fact
> viaLowLevel.c is very similar to what Laz uses in his library. The one
> major difference is the use of DMA, and I don't know if it is simple to
> set up DMA from userspace. So maybe it is the best to start with the
> code as it is now and try to get it working and then try to synchronize
> the code bases.
>
possibly... although the xvmc library code will give you unichrome-pro support 
for free.

> The most pressing question on my mind is: is it possible to reduce the
> CPU load by getting rid of the busy loop while waiting for the decoder
> to become ready again? It's quite stupid to waste CPU time just for
> waiting for the decoder if the goal of using the decoder was to save CPU
> time :-)
>
As far as known, no. There's no end of decoding interrupt. Although there time 
spent in that loop should be quite small, most of the time is spent copying 
data back and forth.

> It is really good to know that you are interested in the development, so
> we can ask a lot of questions concerning the via chipset :-)
>
Well it's all fun.

-- 
Ivor Hewitt.


From laz at club-burniston.co.uk  Tue May 16 02:42:54 2006
From: laz at club-burniston.co.uk (Laz)
Date: Tue, 16 May 2006 01:42:54 +0100
Subject: [Softdevice-devel] Via CLE266 hardware MPEG decoding...
In-Reply-To: <4468F25C.6070406@gmx.net>
References: <200605152118.21598.ivor@ivor.org> <4468F25C.6070406@gmx.net>
Message-ID: <200605160142.54930.laz@club-burniston.co.uk>

On Monday 15 May 2006 22:27, Martin Wache wrote:
> Ivor Hewitt schrieb:
> > Providing a mechanism by which the X specific portions can be removed
> > from the XvMC driver and the common code shared with directfb would be 'a
> > really good thing'.
>
> I agree with you that it would be the best to share as much code as
> possible. I had a look at the latest libviaXvMC and in fact
> viaLowLevel.c is very similar to what Laz uses in his library. The one
> major difference is the use of DMA, and I don't know if it is simple to
> set up DMA from userspace. So maybe it is the best to start with the
> code as it is now and try to get it working and then try to synchronize
> the code bases.

I'm not sure of the exact origin of some of the code but I found several 
different libraries, plugins, and patches which contained very similar 
looking chunks of code!

;)

> What I'm not really sure about is what are Laz's plans for the library.
> Laz, do you want your library to a stand alone library or would you like
> to try to integrate it into DirectFB?  I would prefer the latter - but I
> guess that means more work...

As the library stands, it seems to do its job. the only real thing to do is to 
tidy it up, etc. Obviously, it would be much simpler to use if this stuff was 
integrated properly into ffmpeg or DirectFB. I'm not sure i know enough about 
the internals either of those to do the job, though. So I think that would 
have to be down to someone else!

The MPEG2 engine in libcle266mpegdec is pretty nasty to understand but then 
this probably duplicates the work of bits of ffmpeg (and DirectFB?). It would 
(hopefully!) only need the relevant chunks of code which feed data in and out 
of the decoder, sets up the relevant buffers, etc.

> > To clear up a couple of questions that were raised:-
> >
> > The original ddmpeg library worked under both X and FB. However it is a
> > proprietary VIA specific interface and only taken advantage of with VeMP
> > and VeXP.
>
> The most pressing question on my mind is: is it possible to reduce the
> CPU load by getting rid of the busy loop while waiting for the decoder
> to become ready again? It's quite stupid to waste CPU time just for
> waiting for the decoder if the goal of using the decoder was to save CPU
> time :-)

Good point! It's a great improvement in saving CPU time as it is but could be 
better.

Cheers,

Laz


From patrick.boettcher at desy.de  Tue May 16 07:58:31 2006
From: patrick.boettcher at desy.de (Patrick Boettcher)
Date: Tue, 16 May 2006 07:58:31 +0200 (CEST)
Subject: [Softdevice-devel] colored snow with softplay
In-Reply-To: <200605141925.24899.stefan@lucke.in-berlin.de>
References: <Pine.LNX.4.64.0605141421100.9954@pub4.ifh.de> <44674FE5.2060001@e-tobi.net>
 <Pine.LNX.4.64.0605141809570.9954@pub4.ifh.de> <200605141925.24899.stefan@lucke.in-berlin.de>
Message-ID: <Pine.LNX.4.64.0605160754240.32374@pub6.ifh.de>

Hi,

This is the start output of vdr:

[softdevice] processing args
[softdevice]   argv [0] = softdevice
[softdevice]   argv [1] = -vo
vo_argv: xv:
[setup-softdevice] alsa ac3Mode set to: 0
[setup-softdevice] alsa device set to: default
[setup-softdevice] A/V Offset set to (0)
[setup-softdevice] Cropping 0 lines from bottom
[setup-softdevice] Cropping 0 columns from left
[setup-softdevice] cropping mode set to 0 (none)
[setup-softdevice] cropping mode toggle key set to 0 (none)
[setup-softdevice] Cropping 0 columns from right
[setup-softdevice] Cropping 0 lines from top
[setup-softdevice] deinterlace method set to 0 none
[setup-softdevice] setting alpha blend mode to pseudo
[softdevice] picture mirroring set to 0 (off)
[setup-softdevice] pixel format set to (I420)
[setup-softdevice] shouldSuspend to: 0
[softdevice] UseStretchBlitset to off
[setup-softdevice] startup aspect set to (4:3 normal)
[softdevice] initializing Plugin
[softdevice] Initializing Video Out
[softdevice] ffmpeg version(CVS) build(3211265)
[XvVideoOut]: osd_image shmid = 753666
[XvVideoOut]: got osd_image: width 1280 height 1024, bytes per line 5120
[XvVideoOut]: max area size 2048 x 2048
[XvVideoOut]: using area size 736 x 576
[softdevice] Xv out OK !
[softdevice] Video Out seems to be OK
[softdevice] Initializing Audio Out
[softdevice] Audio out seems to be OK
[softdevice] A/V devices initialized, now initializing MPEG2 Decoder

and this when I start a xvid-file:

could not find stream info
PLDBG: GetPlayMode nb_streams 2
PLDBG: GetPlayMode stream 0 codec_type 0
PLDBG: GetPlayMode stream 1 codec_type 1
#Input #0, avi, from 'test':
  Duration: 00:44:05.6, start: 0.000000, bitrate: 1111 kb/s
#  Stream #0.0, 23.98 fps(r): Video: mpeg4, yuv420p, 624x352
  Stream #0.1: Audio: mp3, 48000 Hz, stereo, 128 kb/s
######

I hope this helps.

On Sun, 14 May 2006, Stefan Lucke wrote:
> Assuming they played previously fine.

Yes.
> Did you upgrade your ffmpeg version too ?
> So which version is reported at startup from softdevice ?

See above, please.

regards,
Patrick.

--
  Mail: patrick.boettcher at desy.de
  WWW:  http://www.wi-bw.tfh-wildau.de/~pboettch/


From jpahka at welho.com  Tue May 16 14:20:53 2006
From: jpahka at welho.com (Juha Pahkala)
Date: Tue, 16 May 2006 15:20:53 +0300
Subject: [Softdevice-devel] Error compiling softplay
Message-ID: <4469C3A5.30705@welho.com>

Hi,

I decided to try out softplay, but I'm unable to compile it. I think I 
have recent enough ffmepg and all the other requirements shuld be 
satisfied. Anybody have clue what's going on?

TIA, juhis


make[1]: Entering directory 
`/home/veehoo/src/dvb/vdr-1.3.37/PLUGINS/src/softplay'
g++ -O2 -Wall -Woverloaded-virtual -c -D_GNU_SOURCE 
-DPLUGIN_NAME_I18N='"softplay"' -I../../../include 
-I../../../../DVB/include -I/usr/local/include/ffmpeg/ SoftPlayer.c
SoftPlayer.c: In member function ?virtual void cSoftPlayer::Action()?:
SoftPlayer.c:173: error: request for member ?codec_type? in 
?((cSoftPlayer*)this)->cSoftPlayer::ic->AVFormatContext::streams[pkt.AVPacket::stream_index]->AVStream::codec?, 
which is of non-class type ?AVCodecContext*?
SoftPlayer.c:178: error: request for member ?codec_type? in 
?((cSoftPlayer*)this)->cSoftPlayer::ic->AVFormatContext::streams[pkt.AVPacket::stream_index]->AVStream::codec?, 
which is of non-class type ?AVCodecContext*?
SoftPlayer.c:222: error: request for member ?codec_id? in 
?((cSoftPlayer*)this)->cSoftPlayer::ic->AVFormatContext::streams[i]->AVStream::codec?, 
which is of non-class type ?AVCodecContext*?
SoftPlayer.c: In member function ?ePlayMode 
cSoftPlayer::GetPlayMode(AVFormatContext*)?:
SoftPlayer.c:248: error: request for member ?codec_type? in 
?IC->AVFormatContext::streams[i]->AVStream::codec?, which is of 
non-class type ?AVCodecContext*?
SoftPlayer.c:250: error: request for member ?codec_type? in 
?IC->AVFormatContext::streams[i]->AVStream::codec?, which is of 
non-class type ?AVCodecContext*?
make[1]: *** [SoftPlayer.o] Error 1



From jonis2006 at yandex.ru  Tue May 16 14:38:42 2006
From: jonis2006 at yandex.ru (jonis2006)
Date: Tue, 16 May 2006 16:38:42 +0400 (MSD)
Subject: [Softdevice-devel] Error compiling softplay
In-Reply-To: <4469C3A5.30705@welho.com>
References: <4469C3A5.30705@welho.com>
Message-ID: <4469C7D2.00000A.30189@webmail9.yandex.ru>

>Hi,
>
>I decided to try out softplay, but I'm unable to compile it. I think I 
>have recent enough ffmepg and all the other requirements shuld be 
>satisfied. Anybody have clue what's going on?
>
>TIA, juhis
>
>
>make[1]: Entering directory 
>`/home/veehoo/src/dvb/vdr-1.3.37/PLUGINS/src/softplay'
>g++ -O2 -Wall -Woverloaded-virtual -c -D_GNU_SOURCE 
>-DPLUGIN_NAME_I18N='"softplay"' -I../../../include 
>-I../../../../DVB/include -I/usr/local/include/ffmpeg/ SoftPlayer.c
>SoftPlayer.c: In member function ?virtual void cSoftPlayer::Action()?:
>SoftPlayer.c:173: error: request for member ?codec_type? in 
>?((cSoftPlayer*)this)->cSoftPlayer::ic->AVFormatContext::streams[pkt.AVPacket::stream_index]->AVStream::codec?, 
>which is of non-class type ?AVCodecContext*?
>SoftPlayer.c:178: error: request for member ?codec_type? in 
>?((cSoftPlayer*)this)->cSoftPlayer::ic->AVFormatContext::streams[pkt.AVPacket::stream_index]->AVStream::codec?, 
>which is of non-class type ?AVCodecContext*?
>SoftPlayer.c:222: error: request for member ?codec_id? in 
>?((cSoftPlayer*)this)->cSoftPlayer::ic->AVFormatContext::streams[i]->AVStream::codec?, 
>which is of non-class type ?AVCodecContext*?
>SoftPlayer.c: In member function ?ePlayMode 
>cSoftPlayer::GetPlayMode(AVFormatContext*)?:
>SoftPlayer.c:248: error: request for member ?codec_type? in 
>?IC->AVFormatContext::streams[i]->AVStream::codec?, which is of 
>non-class type ?AVCodecContext*?
>SoftPlayer.c:250: error: request for member ?codec_type? in 
>?IC->AVFormatContext::streams[i]->AVStream::codec?, which is of 
>non-class type ?AVCodecContext*?
>make[1]: *** [SoftPlayer.o] Error 1
>
>_______________________________________________
>Softdevice-devel mailing list
>Softdevice-devel at lists.berlios.de
>http://lists.berlios.de/mailman/listinfo/softdevice-devel

I know.In all lines just do replacements like:

ic->streams[pkt.stream_index]->codec.codec_type
replace by:
ic->streams[pkt.stream_index].codec.codec_type
the "->" replace on "."
in all lines what have error. And softplay will be compiled and working. This softplay working well with my VDR 1.4.0. Have a nice day ! :)





From nicolas at huillard.net  Tue May 16 21:09:14 2006
From: nicolas at huillard.net (Nicolas Huillard)
Date: Tue, 16 May 2006 21:09:14 +0200
Subject: [Softdevice-devel] Via CLE266 hardware MPEG decoding...
In-Reply-To: <200605160142.54930.laz@club-burniston.co.uk>
References: <200605152118.21598.ivor@ivor.org> <4468F25C.6070406@gmx.net> <200605160142.54930.laz@club-burniston.co.uk>
Message-ID: <446A235A.6010805@huillard.net>

Laz a ?crit :
> On Monday 15 May 2006 22:27, Martin Wache wrote:

>>The most pressing question on my mind is: is it possible to reduce the
>>CPU load by getting rid of the busy loop while waiting for the decoder
>>to become ready again? It's quite stupid to waste CPU time just for
>>waiting for the decoder if the goal of using the decoder was to save CPU
>>time :-)
> 
> Good point! It's a great improvement in saving CPU time as it is but could be 
> better.

Not having looked at the code, and only thinking from your comments, I
wonder if no busy waiting could be achieved with some kind of multiple
buffers, or pipeline, frame queuing :
* 1st stage : feed some frames to the decoder
* 2nd stage : post-process decoded frames
* 3rd stage : flip to the screen at interrupt-time

All stages could be driven by the actual interrupt : first flip what's
available, then post-process what's been decoded and is waiting (given
the decoder is faster than the interrupt interval), then feed the
decoder with another set of frames.


From ivor at ivor.org  Tue May 16 21:27:27 2006
From: ivor at ivor.org (Ivor Hewitt)
Date: Tue, 16 May 2006 20:27:27 +0100
Subject: [Softdevice-devel] Via CLE266 hardware MPEG decoding...
In-Reply-To: <446A235A.6010805@huillard.net>
References: <200605152118.21598.ivor@ivor.org> <200605160142.54930.laz@club-burniston.co.uk> <446A235A.6010805@huillard.net>
Message-ID: <200605162027.27720.ivor@ivor.org>

On Tuesday 16 May 2006 20:09, Nicolas Huillard wrote:
> All stages could be driven by the actual interrupt

there is no (working) interrupt.

-- 
Ivor Hewitt.


From nicolas at huillard.net  Tue May 16 22:22:49 2006
From: nicolas at huillard.net (Nicolas Huillard)
Date: Tue, 16 May 2006 22:22:49 +0200
Subject: [Softdevice-devel] Via CLE266 hardware MPEG decoding...
In-Reply-To: <200605162027.27720.ivor@ivor.org>
References: <200605152118.21598.ivor@ivor.org> <200605160142.54930.laz@club-burniston.co.uk> <446A235A.6010805@huillard.net> <200605162027.27720.ivor@ivor.org>
Message-ID: <446A3499.3040405@huillard.net>

Ivor Hewitt a ?crit :
> On Tuesday 16 May 2006 20:09, Nicolas Huillard wrote:
> 
>>All stages could be driven by the actual interrupt
> 
> there is no (working) interrupt.

Isn't there an frame-interrupt, raised when the CRT scan begins on top
of the screen. This one is present on all VGA card, and I think it is
used in softdevice for frame synchronisation.

It is not related at all to the MPEG decoder, but since output will
eventually go in video memory, one can make use of it. I think Xine
can't use it simply because it's architecture make the display step to
independent of the decoding step.

The rationale is simply : you don't need more decoded frames than what
will appear on screen, so just wait until you have to display
(predictable time, every 20ms, or interrupt driven), instead of waiting
until the decoder has finished it's job (busy waiting).

-- 
NH


From jpahka at welho.com  Wed May 17 11:15:26 2006
From: jpahka at welho.com (Juha Pahkala)
Date: Wed, 17 May 2006 12:15:26 +0300
Subject: [Softdevice-devel] Error compiling softplay
In-Reply-To: <4469C7D2.00000A.30189@webmail9.yandex.ru>
References: <4469C3A5.30705@welho.com> <4469C7D2.00000A.30189@webmail9.yandex.ru>
Message-ID: <446AE9AE.3020202@welho.com>

jonis2006 wrote:
> I know.In all lines just do replacements like:
>
> ic->streams[pkt.stream_index]->codec.codec_type
> replace by:
> ic->streams[pkt.stream_index].codec.codec_type
> the "->" replace on "."
> in all lines what have error. And softplay will be compiled and working. This softplay working well with my VDR 1.4.0. Have a nice day ! :)
>
>
>   
Well, actually I had to do it the other way around, changing 
*->codec.codec* to *->codec->codec*

Anyhow, that made it to at least compile, haven't gotten around to 
testing it yet...

thanks, juhis



From admin at berlios.de  Wed May 17 20:01:02 2006
From: admin at berlios.de (admin at berlios.de)
Date: Wed, 17 May 2006 21:01:02 +0300 (EEST)
Subject: [Softdevice-devel] [Bug #7534] MMX2 detected on VIA C3, does not exist
Message-ID: <200605171801.k4HI125f025458@unicorn.berlios.de>

Bug #7534, was updated on 2006-May-17 21:01
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: general
Status: Open
Resolution: None
Bug Group: None
Priority: 5
Submitted by: sandman72
Assigned to : none
Summary: MMX2 detected on VIA C3, does not exist

Details: On VIA C3 CPUs configure detects the chip as having MMX2. This is not the case, it has Cyrix extended MMX, which is a bit different. I don't remember all the gory details, but here's at least some discussion about the issue: 
http://comments.gmane.org/gmane.comp.video.ffmpeg.devel/31865

Quick solution is to change config.h and Makefile (i.e. turn off MMX2), maybe a patch could be made so that all MMX2 stuff would not have to be disabled, as it is partially supported. Affected functions are at least fast_memcpy in utils.c and ScaleUpHoriz_MMX in SoftOsd.c around line 1516. The first asm part seems to work.


For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=7534&group_id=2051


From M.Wache at gmx.net  Wed May 17 22:26:58 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Wed, 17 May 2006 22:26:58 +0200
Subject: [Softdevice-devel] Via CLE266 hardware MPEG decoding...
In-Reply-To: <446A3499.3040405@huillard.net>
References: <200605152118.21598.ivor@ivor.org> <200605160142.54930.laz@club-burniston.co.uk> <446A235A.6010805@huillard.net> <200605162027.27720.ivor@ivor.org> <446A3499.3040405@huillard.net>
Message-ID: <446B8712.5010601@gmx.net>

Nicolas Huillard schrieb:
> Ivor Hewitt a ?crit :
>> On Tuesday 16 May 2006 20:09, Nicolas Huillard wrote:
>>
>>> All stages could be driven by the actual interrupt
>> there is no (working) interrupt.
> 
> Isn't there an frame-interrupt, raised when the CRT scan begins on top
> of the screen. This one is present on all VGA card, and I think it is
> used in softdevice for frame synchronisation.
> 
The problem is that we have to what for the decoder to become ready to
decode the next slice of one frame. This takes about 200ns, the
interrupt which signals this seems to be broken, and I don't think that
we can use an other interrupt. The frame interrupt would for sure wont
work since there are many slices per frame ;-)

Bye,
Martin


From M.Wache at gmx.net  Wed May 17 22:33:28 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Wed, 17 May 2006 22:33:28 +0200
Subject: [Softdevice-devel] Error compiling softplay
In-Reply-To: <446AE9AE.3020202@welho.com>
References: <4469C3A5.30705@welho.com> <4469C7D2.00000A.30189@webmail9.yandex.ru> <446AE9AE.3020202@welho.com>
Message-ID: <446B8898.9010700@gmx.net>

Juha Pahkala schrieb:
> jonis2006 wrote:
>> I know.In all lines just do replacements like:
>>
>> ic->streams[pkt.stream_index]->codec.codec_type
>> replace by:
>> ic->streams[pkt.stream_index].codec.codec_type
>> the "->" replace on "."
>> in all lines what have error. And softplay will be compiled and
>> working. This softplay working well with my VDR 1.4.0. Have a nice day
>> ! :)
>>
>>
>>   
> Well, actually I had to do it the other way around, changing
> *->codec.codec* to *->codec->codec*
> 
You can also use the CVS version which has these isues solved.

Bye,
Martin


From M.Wache at gmx.net  Wed May 17 22:43:10 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Wed, 17 May 2006 22:43:10 +0200
Subject: [Softdevice-devel] colored snow with softplay
In-Reply-To: <Pine.LNX.4.64.0605160754240.32374@pub6.ifh.de>
References: <Pine.LNX.4.64.0605141421100.9954@pub4.ifh.de> <44674FE5.2060001@e-tobi.net> <Pine.LNX.4.64.0605141809570.9954@pub4.ifh.de> <200605141925.24899.stefan@lucke.in-berlin.de> <Pine.LNX.4.64.0605160754240.32374@pub6.ifh.de>
Message-ID: <446B8ADE.1040802@gmx.net>

Patrick Boettcher schrieb:
> Hi,
> 
> This is the start output of vdr:
> 
> [softdevice] processing args
> [softdevice]   argv [0] = softdevice
> [softdevice]   argv [1] = -vo
> vo_argv: xv:
> [setup-softdevice] alsa ac3Mode set to: 0
> [setup-softdevice] alsa device set to: default
> [setup-softdevice] A/V Offset set to (0)
> [setup-softdevice] Cropping 0 lines from bottom
> [setup-softdevice] Cropping 0 columns from left
> [setup-softdevice] cropping mode set to 0 (none)
> [setup-softdevice] cropping mode toggle key set to 0 (none)
> [setup-softdevice] Cropping 0 columns from right
> [setup-softdevice] Cropping 0 lines from top
> [setup-softdevice] deinterlace method set to 0 none
> [setup-softdevice] setting alpha blend mode to pseudo
> [softdevice] picture mirroring set to 0 (off)
> [setup-softdevice] pixel format set to (I420)
> [setup-softdevice] shouldSuspend to: 0
> [softdevice] UseStretchBlitset to off
> [setup-softdevice] startup aspect set to (4:3 normal)
> [softdevice] initializing Plugin
> [softdevice] Initializing Video Out
> [softdevice] ffmpeg version(CVS) build(3211265)
> [XvVideoOut]: osd_image shmid = 753666
> [XvVideoOut]: got osd_image: width 1280 height 1024, bytes per line 5120
> [XvVideoOut]: max area size 2048 x 2048
> [XvVideoOut]: using area size 736 x 576
> [softdevice] Xv out OK !
> [softdevice] Video Out seems to be OK
> [softdevice] Initializing Audio Out
> [softdevice] Audio out seems to be OK
> [softdevice] A/V devices initialized, now initializing MPEG2 Decoder
> 
> and this when I start a xvid-file:
> 
> could not find stream info
> PLDBG: GetPlayMode nb_streams 2
> PLDBG: GetPlayMode stream 0 codec_type 0
> PLDBG: GetPlayMode stream 1 codec_type 1
> #Input #0, avi, from 'test':
>   Duration: 00:44:05.6, start: 0.000000, bitrate: 1111 kb/s
> #  Stream #0.0, 23.98 fps(r): Video: mpeg4, yuv420p, 624x352
>   Stream #0.1: Audio: mp3, 48000 Hz, stereo, 128 kb/s
> ######
> 
> I hope this helps.
> 
I'm not sure about this one. You said that before switching to the
debian packages those files played well?
I would assume that there is something wrong with ffmpeg or there is
some kind of library/header mismatch with the ffmpeg version. I don't
think that I wrote that somewhere, but softplay assumes that it has been
compiled with the same ffmpeg version like the softdevice, if this is
not the case strange things may happen. Similar things can happen if you
compile softplay with an avcodec.h and avformat.h which doesn't match
the shared library...
I assume that it's a bug or a mismatch in the debian package of
softplay, softdevice or ffmpeg.

Martin


From listaccount at e-tobi.net  Wed May 17 23:43:45 2006
From: listaccount at e-tobi.net (Tobias Grimm)
Date: Wed, 17 May 2006 23:43:45 +0200
Subject: [Softdevice-devel] colored snow with softplay
In-Reply-To: <446B8ADE.1040802@gmx.net>
References: <Pine.LNX.4.64.0605141421100.9954@pub4.ifh.de> <44674FE5.2060001@e-tobi.net> <Pine.LNX.4.64.0605141809570.9954@pub4.ifh.de> <200605141925.24899.stefan@lucke.in-berlin.de> <Pine.LNX.4.64.0605160754240.32374@pub6.ifh.de> <446B8ADE.1040802@gmx.net>
Message-ID: <446B9911.1020506@e-tobi.net>

Martin Wache wrote:

>think that I wrote that somewhere, but softplay assumes that it has been
>compiled with the same ffmpeg version like the softdevice, if this is
>not the case strange things may happen.
>

Right now the softdevice and softplay packages in my repository indeed
use different versions of ffmpeg. softdevice uses a statically linked
version and softplay the dynamically linked one, I recently backported
from Sid.

I don't know if this will fix the problem, but I will upload new package
versions tomorrow, that both use the new dynamically linked ffmpeg
version (0.4.9pre - CVS version from 2006-03-29).

Tobias


From nicolas at huillard.net  Thu May 18 09:53:24 2006
From: nicolas at huillard.net (Nicolas Huillard)
Date: Thu, 18 May 2006 09:53:24 +0200
Subject: [Softdevice-devel] Via CLE266 hardware MPEG decoding...
In-Reply-To: <446B8712.5010601@gmx.net>
References: <200605152118.21598.ivor@ivor.org> <200605160142.54930.laz@club-burniston.co.uk> <446A235A.6010805@huillard.net> <200605162027.27720.ivor@ivor.org> <446A3499.3040405@huillard.net> <446B8712.5010601@gmx.net>
Message-ID: <446C27F4.9030701@huillard.net>

Martin Wache a ?crit :
> The problem is that we have to what for the decoder to become ready to
> decode the next slice of one frame. This takes about 200ns, the
> interrupt which signals this seems to be broken, and I don't think that
> we can use an other interrupt. The frame interrupt would for sure wont
> work since there are many slices per frame ;-)

OK.
If there really is an interrupt that should work but do not, maybe the
best if to fix that (if not hardware-broken) ?
Does anyone have URLs I can start with to gather information about the
problem and potential fix ?

-- 
NH


From laz at club-burniston.co.uk  Thu May 18 11:13:53 2006
From: laz at club-burniston.co.uk (Laz)
Date: Thu, 18 May 2006 10:13:53 +0100
Subject: [Softdevice-devel] Via CLE266 hardware MPEG decoding...
In-Reply-To: <446C27F4.9030701@huillard.net>
References: <200605152118.21598.ivor@ivor.org> <446B8712.5010601@gmx.net> <446C27F4.9030701@huillard.net>
Message-ID: <200605181013.53290.laz@club-burniston.co.uk>

On Thursday 18 May 2006 08:53, Nicolas Huillard wrote:
> Martin Wache a ?crit :
> > The problem is that we have to what for the decoder to become ready
> > to decode the next slice of one frame. This takes about 200ns, the
> > interrupt which signals this seems to be broken, and I don't think
> > that we can use an other interrupt. The frame interrupt would for
> > sure wont work since there are many slices per frame ;-)
>
> OK.
> If there really is an interrupt that should work but do not, maybe the
> best if to fix that (if not hardware-broken) ?
> Does anyone have URLs I can start with to gather information about the
> problem and potential fix ?

I'm sure I did read somewhere that said it was a hardware problem, i.e. it 
should work but doesn't! I could be remembering incorrectly, though.

If it _did_ work, I'm sure that the openchrome + mplayer + xine plugins 
would use it but I'm pretty sure they all poll from a loop.

Cheers,

Laz


From laz at club-burniston.co.uk  Thu May 18 16:32:28 2006
From: laz at club-burniston.co.uk (Laz)
Date: Thu, 18 May 2006 15:32:28 +0100
Subject: [Softdevice-devel] Via CLE266 hardware MPEG decoding...
In-Reply-To: <446C27F4.9030701@huillard.net>
References: <200605152118.21598.ivor@ivor.org> <446B8712.5010601@gmx.net> <446C27F4.9030701@huillard.net>
Message-ID: <200605181532.28202.laz@club-burniston.co.uk>

On Thursday 18 May 2006 08:53, Nicolas Huillard wrote:
> Martin Wache a ?crit :
> > The problem is that we have to what for the decoder to become ready
> > to decode the next slice of one frame. This takes about 200ns, the
> > interrupt which signals this seems to be broken, and I don't think
> > that we can use an other interrupt. The frame interrupt would for
> > sure wont work since there are many slices per frame ;-)
>
> OK.
> If there really is an interrupt that should work but do not, maybe the
> best if to fix that (if not hardware-broken) ?
> Does anyone have URLs I can start with to gather information about the
> problem and potential fix ?

Quoting from libxvmc/viaLowlevel.c from the openchrome driver:

static void
syncMpeg(XvMCLowLevel * xl, unsigned int mode, unsigned int doSleep)
{
    /*
     * Ideally, we'd like to have an interrupt wait here, but from 
information from VIA
     * at least the MPEG completion interrupt is broken on the CLE266, 
which was
     * discovered during validation of the chip.
     */

However, there is the inclusion of a nanosleep for 1 ns, although I think 
you need to be running as root or with realtime priority for this to 
work, otherwise the sleep is a few ms, I think. In fact, from: 
http://www.tldp.org/HOWTO/IO-Port-Programming-4.html

"nanosleep()
In the 2.0.x series of Linux kernels, there is a new system call, 
nanosleep() (see the nanosleep(2) manual page), that allows you to sleep 
or delay for short times (a few microseconds or more).

For delays <= 2 ms, if (and only if) your process is set to soft real time 
scheduling (using sched_setscheduler()), nanosleep() uses a busy loop; 
otherwise it sleeps, just like usleep().

The busy loop uses udelay() (an internal kernel function used by many 
kernel drivers), and the length of the loop is calculated using the 
BogoMips value (the speed of this kind of busy loop is one of the things 
that BogoMips measures accurately). See /usr/include/asm/delay.h) for 
details on how it works."

Just done a quick test with nanosleep() and get about 1-2 ms delay without 
changing the priority.

Cheers,

Laz


From listaccount at e-tobi.net  Thu May 18 19:59:56 2006
From: listaccount at e-tobi.net (Tobias Grimm)
Date: Thu, 18 May 2006 19:59:56 +0200
Subject: [Softdevice-devel] colored snow with softplay
In-Reply-To: <446B8ADE.1040802@gmx.net>
References: <Pine.LNX.4.64.0605141421100.9954@pub4.ifh.de> <44674FE5.2060001@e-tobi.net> <Pine.LNX.4.64.0605141809570.9954@pub4.ifh.de> <200605141925.24899.stefan@lucke.in-berlin.de> <Pine.LNX.4.64.0605160754240.32374@pub6.ifh.de> <446B8ADE.1040802@gmx.net>
Message-ID: <446CB61C.3@e-tobi.net>

Ok, new versions of the softdevice and softplay package are available in
my vdr-experimental repository for Sarge and Sid. They now use exactly
the same ffmpeg library. For Sarge you need to include the backports
section in your sources.list too.
(e.g. "deb http://e-tobi.net/vdr-experimental sarge base backports
addons vdr-multipatch")

Please let me know, if this works now, as I can't test it at the moment.

bye,

Tobias



From patrick.boettcher at desy.de  Thu May 18 21:31:32 2006
From: patrick.boettcher at desy.de (Patrick Boettcher)
Date: Thu, 18 May 2006 21:31:32 +0200 (CEST)
Subject: [Softdevice-devel] colored snow with softplay
In-Reply-To: <446CB61C.3@e-tobi.net>
References: <Pine.LNX.4.64.0605141421100.9954@pub4.ifh.de> <44674FE5.2060001@e-tobi.net>
 <Pine.LNX.4.64.0605141809570.9954@pub4.ifh.de> <200605141925.24899.stefan@lucke.in-berlin.de>
 <Pine.LNX.4.64.0605160754240.32374@pub6.ifh.de> <446B8ADE.1040802@gmx.net>
 <446CB61C.3@e-tobi.net>
Message-ID: <Pine.LNX.4.64.0605182124250.6707@pub2.ifh.de>

Hi Tobias,

On Thu, 18 May 2006, Tobias Grimm wrote:
> Ok, new versions of the softdevice and softplay package are available in
> my vdr-experimental repository for Sarge and Sid. They now use exactly
> the same ffmpeg library. For Sarge you need to include the backports
> section in your sources.list too.
> (e.g. "deb http://e-tobi.net/vdr-experimental sarge base backports
> addons vdr-multipatch")
> 
> Please let me know, if this works now, as I can't test it at the moment.

I tested with xv-out on my desktop PC and with dfb-mga-out on my dedicated 
VDR: Very good, it is working. Keep on the good work and thanks for your
support. Your package archive is making life easier for users like me.

best regards,
Patrick.

--
  Mail: patrick.boettcher at desy.de
  WWW:  http://www.wi-bw.tfh-wildau.de/~pboettch/


From listaccount at e-tobi.net  Thu May 18 21:54:19 2006
From: listaccount at e-tobi.net (Tobias Grimm)
Date: Thu, 18 May 2006 21:54:19 +0200
Subject: [Softdevice-devel] colored snow with softplay
In-Reply-To: <446CB61C.3@e-tobi.net>
References: <Pine.LNX.4.64.0605141421100.9954@pub4.ifh.de> <44674FE5.2060001@e-tobi.net> <Pine.LNX.4.64.0605141809570.9954@pub4.ifh.de> <200605141925.24899.stefan@lucke.in-berlin.de> <Pine.LNX.4.64.0605160754240.32374@pub6.ifh.de> <446B8ADE.1040802@gmx.net> <446CB61C.3@e-tobi.net>
Message-ID: <446CD0EB.20100@e-tobi.net>

Just to close this thread, Patrick tested the new packages and it seams
to work.

So Martin was right - the problem was caused by the different ffmpeg
versions used by softdevice and softplay.

bye,

Tobias


From reinelt at eunet.at  Fri May 19 11:13:59 2006
From: reinelt at eunet.at (Michael Reinelt)
Date: Fri, 19 May 2006 11:13:59 +0200
Subject: [Softdevice-devel] Via CLE266 hardware MPEG decoding...
In-Reply-To: <200605181532.28202.laz@club-burniston.co.uk>
References: <200605152118.21598.ivor@ivor.org> <446B8712.5010601@gmx.net> <446C27F4.9030701@huillard.net> <200605181532.28202.laz@club-burniston.co.uk>
Message-ID: <446D8C57.4010202@eunet.at>

Hi there,

> However, there is the inclusion of a nanosleep for 1 ns, although I think 
> you need to be running as root or with realtime priority for this to 
> work, otherwise the sleep is a few ms, I think. In fact, from: 
> http://www.tldp.org/HOWTO/IO-Port-Programming-4.html

Well, I've worked on this problems for years now. Achieving very short
delays in the nanosecond range in userspace is a pain.

> For delays <= 2 ms, if (and only if) your process is set to soft real time 
> scheduling (using sched_setscheduler()), nanosleep() uses a busy loop; 
> otherwise it sleeps, just like usleep().
and as usleep() always does a reschedule, it delays at least 1/HZ (which
is 10 msec with the default of 100 HZ).

Using sched_setscheduler() is dangerous: if something goes wrong, it
will completely block your system (think of an infinitive loop).
Changing the scheduler mode just for the delay loop produces too much
overhead.

In lcd4linux (where I need such small delays) I implemented two forms
for such delays: a simple gettimeofday() busy loop (which works fine,
but there's a quite big syscall overhead) and a RDTSC waiting loop
(which is very fast and precise, but works on i386 only). At least my
EPIA-M6000 supports TSC. The disadvantage of TSC is that it needs to be
calibrated in some way, and produces wrong results when CPU frequency
changes.

I can provide sample code if you're interested.


HTH, Michael

-- 
Michael Reinelt <reinelt at eunet.at>
http://home.pages.at/reinelt
GPG-Key 0xDF13BA50
ICQ #288386781


From laz at club-burniston.co.uk  Fri May 19 11:49:44 2006
From: laz at club-burniston.co.uk (Laz)
Date: Fri, 19 May 2006 10:49:44 +0100
Subject: [Softdevice-devel] Via CLE266 hardware MPEG decoding...
In-Reply-To: <446D8C57.4010202@eunet.at>
References: <200605152118.21598.ivor@ivor.org> <200605181532.28202.laz@club-burniston.co.uk> <446D8C57.4010202@eunet.at>
Message-ID: <200605191049.44627.laz@club-burniston.co.uk>

On Friday 19 May 2006 10:13, Michael Reinelt wrote:
> Hi there,
>
> > However, there is the inclusion of a nanosleep for 1 ns, although I
> > think you need to be running as root or with realtime priority for
> > this to work, otherwise the sleep is a few ms, I think. In fact,
> > from: http://www.tldp.org/HOWTO/IO-Port-Programming-4.html
>
> Well, I've worked on this problems for years now. Achieving very short
> delays in the nanosecond range in userspace is a pain.

:-s

> > For delays <= 2 ms, if (and only if) your process is set to soft real
> > time scheduling (using sched_setscheduler()), nanosleep() uses a busy
> > loop; otherwise it sleeps, just like usleep().
>
> and as usleep() always does a reschedule, it delays at least 1/HZ
> (which is 10 msec with the default of 100 HZ).
>
> Using sched_setscheduler() is dangerous: if something goes wrong, it
> will completely block your system (think of an infinitive loop).
> Changing the scheduler mode just for the delay loop produces too much
> overhead.

I don't think we really want to get into that!

> In lcd4linux (where I need such small delays) I implemented two forms
> for such delays: a simple gettimeofday() busy loop (which works fine,
> but there's a quite big syscall overhead) and a RDTSC waiting loop
> (which is very fast and precise, but works on i386 only). At least my
> EPIA-M6000 supports TSC. The disadvantage of TSC is that it needs to be
> calibrated in some way, and produces wrong results when CPU frequency
> changes.
>
> I can provide sample code if you're interested.

I'd be interested to see how you are doing this: might not be relevant 
here but may come in useful for some other stuff I'm working on!

All we are trying to do here is trying to sleep to reduce CPU load a bit. 
Someone suggested I try using sched_yield() which probably wouldn't 
reduce CPU load but should give other processes a look in! Not got round 
to trying that one yet, though...

Cheers,

Laz


From jpahka at welho.com  Fri May 19 16:56:30 2006
From: jpahka at welho.com (Juha Pahkala)
Date: Fri, 19 May 2006 17:56:30 +0300
Subject: [Softdevice-devel] One or two regressions with softdevice 0.2.3
Message-ID: <446DDC9E.5070708@welho.com>

Hi,

Today I tried to upgrade to 0.2.3 from 0.2.2 but had a few problems:

1) Sound via spdif doesn't seem to work for me anymore. I have been 
using '-ao alsa:spdif' up to 0.2.2 but that doesn't seem to work anymore.

2) tv-out to my g400 via directfb, primary head. I've been using the 
following patch:

http://mail.directfb.org/pipermail/directfb-dev/2005-November/000893.html

with command line '-vo dfb:triple', but now this results in jerky 
movement. Omitting the 'tripple' makes it smooth again so I'm not sure 
is this a problem or not.

Juhis


From stefan at lucke.in-berlin.de  Tue May 23 10:37:51 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 23 May 2006 10:37:51 +0200
Subject: [Softdevice-devel] OSD transparency & DirectFB on EPIA
In-Reply-To: <200605110730.16799.stefan@lucke.in-berlin.de>
References: <Pine.OSF.4.61.0605082348460.194686@kosh.hut.fi> <200605101918.55289.stefan@lucke.in-berlin.de> <200605110730.16799.stefan@lucke.in-berlin.de>
Message-ID: <200605231037.51211.stefan@lucke.in-berlin.de>

On Donnerstag 11 Mai 2006 07:30, Stefan Lucke wrote:
> On Mittwoch 10 Mai 2006 19:18, Stefan Lucke wrote:
> > On Mittwoch 10 Mai 2006 14:22, Laz wrote:
> > > On Wednesday 10 May 2006 11:57, Stefan Lucke wrote:
> > > > Quoting Laz:
> > > > > I had a quick go at trying SetLevel(-1) after reading Readme.txt in
> > > > > the DirectFB unichrome driver source. I can't actually remember what
> > > > > that did but I lost either the OSD or the video layer completely!
> > > >
> > > > From a look at directfb code, it should work with SetLevel(-1), if
> > > > unichrome driver would report capability DLCAPS_ALPHACHANNEL. Reporting
> > > > DLCAPS_ALPHACHANNEL has to be fixed in
> > > > DirectFB/gfxdrivers/unichrome/uc_overlay.h line 5 or 6, by or'ing this
> > > > together with other flags .
> > > 
> > > Hmmmm... I'm sure that my setup does report 'alphachannel' on 
> > > initialisation for me (can't check right now, or which layer this is 
> > > for), and so presumably it does get enabled. Shouldn't this be enabled 
> > > for the primary layer and not the overlay, anyway? Looking at 
> > > video-dfb.c, DLCAPS_ALPHACHANNEL is being checked for and set for the 
> > > video layer rather than the primary layer.
> > 
> > Guess you are right. That's from November:
> > http://mail.directfb.org/pipermail/directfb-dev/2005-November/000970.html
> > 
> 
> But it's definitely more complicated :-( . So now with directfb cvs, I only
> have video when SetLayer(1) or OSD when SetLayer(-1). So I guess
> to fix this, many things may break. I cannot promise that it will work
> with other (older directfb versions) :-( .
> 

So here is the version that works current DirectFB (cvs from 2006-05-10)
and softdevice cvs. Needs to be tested on _all_ other cards/configurations.

-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: dfb-via-fix01.patch
Type: text/x-diff
Size: 11240 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060523/fe6526f6/attachment.patch>

From laz at club-burniston.co.uk  Tue May 23 11:33:29 2006
From: laz at club-burniston.co.uk (Laz)
Date: Tue, 23 May 2006 10:33:29 +0100
Subject: [Softdevice-devel] OSD transparency & DirectFB on EPIA
In-Reply-To: <200605231037.51211.stefan@lucke.in-berlin.de>
References: <Pine.OSF.4.61.0605082348460.194686@kosh.hut.fi> <200605110730.16799.stefan@lucke.in-berlin.de> <200605231037.51211.stefan@lucke.in-berlin.de>
Message-ID: <200605231033.29429.laz@club-burniston.co.uk>

On Tuesday 23 May 2006 09:37, Stefan Lucke wrote:
> So here is the version that works current DirectFB (cvs from
> 2006-05-10) and softdevice cvs. Needs to be tested on _all_ other
> cards/configurations.

Good work. Looks like you've tidied the code up a bit too.

I'll give it a go this evening.

Cheers,

Laz


From stefan at lucke.in-berlin.de  Tue May 23 11:57:24 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 23 May 2006 11:57:24 +0200
Subject: [Softdevice-devel] OSD transparency & DirectFB on EPIA
In-Reply-To: <200605231033.29429.laz@club-burniston.co.uk>
References: <Pine.OSF.4.61.0605082348460.194686@kosh.hut.fi> <200605231037.51211.stefan@lucke.in-berlin.de> <200605231033.29429.laz@club-burniston.co.uk>
Message-ID: <200605231157.24962.stefan@lucke.in-berlin.de>

On Dienstag 23 Mai 2006 11:33, Laz wrote:
> On Tuesday 23 May 2006 09:37, Stefan Lucke wrote:
> > So here is the version that works current DirectFB (cvs from
> > 2006-05-10) and softdevice cvs. Needs to be tested on _all_ other
> > cards/configurations.
> 
> Good work. Looks like you've tidied the code up a bit too.

A bit yes.
I've an update of the patch, as it didn't pass the test with my old
DirectFB version and VIA.

Current test status is (with dfb-via-fix02.patch):
Passed tests:
VIA, VGA-out DirectFB cvs from 2006-05-10 OK
VIA, VGA-out DirectFB cvs from 2005-09-24 OK
RADEON, VGA-out DirectFB cvs from 2006-04-14 OK

Pending tests:
VIA, TV-out with current DirecFB version (newer than december 2005)
VIA, TV-out with old DirecFB version (older than october 2005)
Matrox, TV-out with current DirectFB cvs
Matrox, VGA-out with current DirectFB cvs

> 
> I'll give it a go this evening.

Some TV-out test ?


-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: dfb-via-fix02.patch
Type: text/x-diff
Size: 11283 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060523/a39222d6/attachment.patch>

From laz at club-burniston.co.uk  Tue May 23 12:10:14 2006
From: laz at club-burniston.co.uk (Laz)
Date: Tue, 23 May 2006 11:10:14 +0100
Subject: [Softdevice-devel] OSD transparency & DirectFB on EPIA
In-Reply-To: <200605231157.24962.stefan@lucke.in-berlin.de>
References: <Pine.OSF.4.61.0605082348460.194686@kosh.hut.fi> <200605231033.29429.laz@club-burniston.co.uk> <200605231157.24962.stefan@lucke.in-berlin.de>
Message-ID: <200605231110.14554.laz@club-burniston.co.uk>

On Tuesday 23 May 2006 10:57, Stefan Lucke wrote:
> On Dienstag 23 Mai 2006 11:33, Laz wrote:
> > On Tuesday 23 May 2006 09:37, Stefan Lucke wrote:
> > > So here is the version that works current DirectFB (cvs from
> > > 2006-05-10) and softdevice cvs. Needs to be tested on _all_ other
> > > cards/configurations.
> >
> > Good work. Looks like you've tidied the code up a bit too.
>
> A bit yes.
> I've an update of the patch, as it didn't pass the test with my old
> DirectFB version and VIA.
>
> Current test status is (with dfb-via-fix02.patch):
> Passed tests:
> VIA, VGA-out DirectFB cvs from 2006-05-10 OK
> VIA, VGA-out DirectFB cvs from 2005-09-24 OK
> RADEON, VGA-out DirectFB cvs from 2006-04-14 OK
>
> Pending tests:
> VIA, TV-out with current DirecFB version (newer than december 2005)

Main system is this so this will be tested.

> VIA, TV-out with old DirecFB version (older than october 2005)
> Matrox, TV-out with current DirectFB cvs

Other system is this so I might get round to testing this too.

> Matrox, VGA-out with current DirectFB cvs
>
> > I'll give it a go this evening.
>
> Some TV-out test ?

See above.

:)

Cheers,

Laz


From stefan at lucke.in-berlin.de  Tue May 23 13:03:15 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 23 May 2006 13:03:15 +0200
Subject: [Softdevice-devel] OSD transparency & DirectFB on EPIA
In-Reply-To: <200605231110.14554.laz@club-burniston.co.uk>
References: <Pine.OSF.4.61.0605082348460.194686@kosh.hut.fi> <200605231157.24962.stefan@lucke.in-berlin.de> <200605231110.14554.laz@club-burniston.co.uk>
Message-ID: <200605231303.15801.stefan@lucke.in-berlin.de>

On Dienstag 23 Mai 2006 12:10, Laz wrote:
> On Tuesday 23 May 2006 10:57, Stefan Lucke wrote:
> > On Dienstag 23 Mai 2006 11:33, Laz wrote:
> > > On Tuesday 23 May 2006 09:37, Stefan Lucke wrote:
> > > > So here is the version that works current DirectFB (cvs from
> > > > 2006-05-10) and softdevice cvs. Needs to be tested on _all_ other
> > > > cards/configurations.
> > >
> > > Good work. Looks like you've tidied the code up a bit too.
> >
> > A bit yes.
> > I've an update of the patch, as it didn't pass the test with my old
> > DirectFB version and VIA.
> >
> > Current test status is (with dfb-via-fix02.patch):
> > Passed tests:
> > VIA, VGA-out DirectFB cvs from 2006-05-10 OK
> > VIA, VGA-out DirectFB cvs from 2005-09-24 OK
> > RADEON, VGA-out DirectFB cvs from 2006-04-14 OK
> >
> > Pending tests:
> > VIA, TV-out with current DirecFB version (newer than december 2005)
> 
> Main system is this so this will be tested.
> 
> > VIA, TV-out with old DirecFB version (older than october 2005)
> > Matrox, TV-out with current DirectFB cvs
> 
> Other system is this so I might get round to testing this too.
> 
> > Matrox, VGA-out with current DirectFB cvs

So I'd like to add the following to section passed:
Matrox, TV-out DirectFB cvs from 2006-04-14 with DSBLIT_INTERLACED patch OK
Matrox, VGA-out DirectFB cvs from 2006-04-14 with DSBLIT_INTERLACED patch OK

Other test reports are welcome anyway.

There will be some last minute changes:
- Beautifying of fprintf in function ReportLayerInfo()
- removal of one fprintf in SetParams()
- removal of calling ReportLayerInfo in function SetParams() for VIA


-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Tue May 23 13:28:28 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 23 May 2006 13:28:28 +0200
Subject: [Softdevice-devel] One or two regressions with softdevice 0.2.3
In-Reply-To: <446DDC9E.5070708@welho.com>
References: <446DDC9E.5070708@welho.com>
Message-ID: <200605231328.28788.stefan@lucke.in-berlin.de>

On Freitag 19 Mai 2006 16:56, Juha Pahkala wrote:
> 
> Hi,
> 
> Today I tried to upgrade to 0.2.3 from 0.2.2 but had a few problems:
> 
> 1) Sound via spdif doesn't seem to work for me anymore. I have been 
> using '-ao alsa:spdif' up to 0.2.2 but that doesn't seem to work anymore.

Can you try to comment out line 21 of audio.c (NO_MIXER) ?

> 
> 2) tv-out to my g400 via directfb, primary head. I've been using the 
> following patch:
> 
> http://mail.directfb.org/pipermail/directfb-dev/2005-November/000893.html
> 
> with command line '-vo dfb:triple', but now this results in jerky 
> movement. Omitting the 'tripple' makes it smooth again so I'm not sure 
> is this a problem or not.

That is strange. I backed that patch out, because I got jerky movement
_without_ triple option specified on a G550 (didn't test _with_ triple) .


-- 
Stefan Lucke


From admin at berlios.de  Fri May 19 20:56:41 2006
From: admin at berlios.de (admin at berlios.de)
Date: Fri, 19 May 2006 10:56:41 -0800 (AKDT)
Subject: [Softdevice-devel] [Bug #7549] Fehlfarben im OSD
Message-ID: <200605191856.k4JIuejA025574@unicorn.berlios.de>

Bug #7549, was updated on 2006-May-19 10:56
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: xv-out
Status: Open
Resolution: None
Bug Group: None
Priority: 5
Submitted by: daliman
Assigned to : none
Summary: Fehlfarben im OSD

Details: Ich kann nicht genau nachvollziehen ob es ein Fehler von SD ist oder der ATI-Grafikkarte (video overlay?), denn es ist erst beim Umstieg auf SuSE10.1 aufgetreten. 

Bei ver?ndern des Wertes von z.B. "Expand Top/Bottom lines" wird da? OSD unleserlich. D.h. es wird bei mir von lila Streifen durchsetzt. 


For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=7549&group_id=2051


From marko.makela at hut.fi  Tue May 23 22:07:44 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 23 May 2006 23:07:44 +0300
Subject: [Softdevice-devel] Screen blanked even if video paused
Message-ID: <20060523200744.GA27820@localhost.localdomain>

I just renamed a few recordings that had bogus EPG data.  To do this,
I paused the recording to the frame that showed the title.  Once (out of
some 20 or 30 recordings), softdevice (CVS from last week) blanked the
screen.  A race condition or faulty logic?

	Marko


From laz at club-burniston.co.uk  Tue May 23 22:26:16 2006
From: laz at club-burniston.co.uk (Laz)
Date: Tue, 23 May 2006 21:26:16 +0100
Subject: [Softdevice-devel] OSD transparency & DirectFB on EPIA
In-Reply-To: <200605231157.24962.stefan@lucke.in-berlin.de>
References: <Pine.OSF.4.61.0605082348460.194686@kosh.hut.fi> <200605231033.29429.laz@club-burniston.co.uk> <200605231157.24962.stefan@lucke.in-berlin.de>
Message-ID: <200605232126.16221.laz@club-burniston.co.uk>

On Tuesday 23 May 2006 10:57, Stefan Lucke wrote:
> Pending tests:
> VIA, TV-out with current DirecFB version (newer than december 2005)

Works a treat. I have a transparent OSD once more!

:)

Cheers,

Laz


From M.Wache at gmx.net  Wed May 24 00:00:50 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Wed, 24 May 2006 00:00:50 +0200
Subject: [Softdevice-devel] [PATCH] direct rendering
In-Reply-To: <4468E28F.60306@gmx.net>
References: <4468E28F.60306@gmx.net>
Message-ID: <44738612.7040503@gmx.net>

Martin Wache schrieb:
> Hi list,
> 
> I'm sending you my first concept for direct rendering with the
> softdevice, meaning that the video-out allocates the picture buffes (not
> necessarily in video memory, which may be slower). There are many
> advantages of direct rendering, for example the pictures get allocated
> by the video out, so they can be used at any time by the video out,
> without having to fear that they have been deleted (because the
> mpeg2decoder has been reseted). Very nice for software alpha blending
> and we can also implement screenshots a lot easier :-). X11 XvMC needs
> direct rendering and I think Laz patches also could benefit from it. For
> Xv-out it would also be faster to use direct rendering.
> 

Ok, so here is my second version of the direct rendering, in my opinion
almost ready for inclusion. I moved the buffer managing into a separate
file, as well as most of the video filtering (this is not yet complete)
and the filters now use the new structure sPicBuffer.
This patch also removes the dependency on avcodec.h from video.h and
calculates the aspect ratio of the stream inside of mpeg2decoder.c.
I also moved the call to av_codec_decode_video() into a separate method
together with all the avcodec specific pts calculations.
If there are no objections I will commit this patch soon.

Bye,
Martin
-------------- next part --------------
A non-text attachment was scrubbed...
Name: direct_rendering1.patch.gz
Type: application/x-gzip
Size: 13585 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060524/3694efcf/attachment.bin>

From admin at berlios.de  Sat May 27 13:22:03 2006
From: admin at berlios.de (admin at berlios.de)
Date: Sat, 27 May 2006 13:22:03 +0200 (CEST)
Subject: [Softdevice-devel] [Bug #7534] MMX2 detected on VIA C3, does not exist
Message-ID: <200605271122.k4RBM33I003687@unicorn.berlios.de>

Bug #7534, was updated on 2006-May-17 20:01
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: general
Status: Open
Resolution: None
Bug Group: None
Priority: 5
Submitted by: sandman72
Assigned to : none
Summary: MMX2 detected on VIA C3, does not exist

Details: On VIA C3 CPUs configure detects the chip as having MMX2. This is not the case, it has Cyrix extended MMX, which is a bit different. I don't remember all the gory details, but here's at least some discussion about the issue: 
http://comments.gmane.org/gmane.comp.video.ffmpeg.devel/31865

Quick solution is to change config.h and Makefile (i.e. turn off MMX2), maybe a patch could be made so that all MMX2 stuff would not have to be disabled, as it is partially supported. Affected functions are at least fast_memcpy in utils.c and ScaleUpHoriz_MMX in SoftOsd.c around line 1516. The first asm part seems to work.


Follow-Ups:

Date: 2006-May-27 13:22
By: wachm

Comment:
Hm, the configure script doesn't autodetect mmx or mmx2, by default it is on, I added now a switch which makes it possible to disable it.

About the MMX2, this should in fact only be the subset of instructions which is present in SSE, 3Dnow and MMX2, since the early VIA CPUs support 3Dnow I assumed that it should work for them as well.
I'm sorry the link you posted doesn't reveal much details about which instructions are supported and which aren't, so currently I can't do much about the insctructions.  If you can tell me more details (or just send a patch which disables everything which doesn't work with a preprocessor switch) I will have a look at it again.
For now I can just advice you to switch of MMX2, as you already did.

Bye,
Martin
-------------------------------------------------------

For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=7534&group_id=2051


From admin at berlios.de  Sat May 27 13:23:22 2006
From: admin at berlios.de (admin at berlios.de)
Date: Sat, 27 May 2006 13:23:22 +0200 (CEST)
Subject: [Softdevice-devel] [Bug #7202] Illegal instruction
Message-ID: <200605271123.k4RBNMJ0007483@unicorn.berlios.de>

Bug #7202, was updated on 2006-Apr-20 12:51
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: None
Status: Closed
Resolution: None
Bug Group: None
Priority: 5
Submitted by: drakon
Assigned to : none
Summary: Illegal instruction

Details: Hallo!
Wenn das Programm auf einem Rechner dessen Prozessor kein MMX2 unterst?tzt kompiliert und ausgef?hrt wird kommt es zu diesem Fehler.
Das Problem habe ich hier beschrieben:

http://vdr-portal.de/board/thread.php?threadid=48118

Follow-Ups:

Date: 2006-May-27 13:23
By: wachm

Comment:
I assume this is now fixed...
-------------------------------------------------------

Date: 2006-Apr-23 22:31
By: wachm

Comment:
Ich denke ich habe das Problem gel?st, da wurde ein MMX2-Befehl trotzdem in utils.c und SoftOsd.c benutzt. Ich habe aber selbst kein Prozessor mit dem ich das ausprobieren k?nnte... Bitte probier mal die CVS Version aus und sag bescheid ob's geht
-------------------------------------------------------

For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=7202&group_id=2051


From admin at berlios.de  Sat May 27 13:26:04 2006
From: admin at berlios.de (admin at berlios.de)
Date: Sat, 27 May 2006 13:26:04 +0200 (CEST)
Subject: [Softdevice-devel] [Bug #7549] Fehlfarben im OSD
Message-ID: <200605271126.k4RBQ4CO014806@unicorn.berlios.de>

Bug #7549, was updated on 2006-May-19 20:56
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: xv-out
Status: Open
Resolution: None
Bug Group: None
Priority: 5
Submitted by: daliman
Assigned to : none
Summary: Fehlfarben im OSD

Details: Ich kann nicht genau nachvollziehen ob es ein Fehler von SD ist oder der ATI-Grafikkarte (video overlay?), denn es ist erst beim Umstieg auf SuSE10.1 aufgetreten. 

Bei ver?ndern des Wertes von z.B. "Expand Top/Bottom lines" wird da? OSD unleserlich. D.h. es wird bei mir von lila Streifen durchsetzt. 


Follow-Ups:

Date: 2006-May-27 13:26
By: wachm

Comment:
Tritt das bei Software alpha blending auf?
-------------------------------------------------------

For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=7549&group_id=2051


From admin at berlios.de  Sat May 27 13:28:09 2006
From: admin at berlios.de (admin at berlios.de)
Date: Sat, 27 May 2006 13:28:09 +0200 (CEST)
Subject: [Softdevice-devel] [Bug #7281] Softdevice-CVS
Message-ID: <200605271128.k4RBS96l020015@unicorn.berlios.de>

Bug #7281, was updated on 2006-Apr-25 22:51
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: None
Status: Closed
Resolution: None
Bug Group: None
Priority: 5
Submitted by: daliman
Assigned to : none
Summary: Softdevice-CVS

Details: Trotz vorhandener postproc kann im Setupmen?/ Bildnachbearbeitung nichts anderes gew?hlt werden als lavc. Ist da? ein ?bergangsfehler ober beabsichtigt?
Gru?, DaLiMan


Follow-Ups:

Date: 2006-May-27 13:28
By: wachm

Comment:
Bei mir funktioniert postproc, ich nehme an du hast was falsch konfiguriert.

-------------------------------------------------------

For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=7281&group_id=2051


From admin at berlios.de  Sun May 28 15:43:14 2006
From: admin at berlios.de (admin at berlios.de)
Date: Sun, 28 May 2006 05:43:14 -0800 (AKDT)
Subject: [Softdevice-devel] [Bug #7637] Screenaspect
Message-ID: <200605281343.k4SDhEIo017198@unicorn.berlios.de>

Bug #7637, was updated on 2006-May-28 05:43
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: general
Status: Open
Resolution: None
Bug Group: None
Priority: 5
Submitted by: daliman
Assigned to : none
Summary: Screenaspect

Details: Das Umschalten des Screenaspects(? 4:3 oder 16:9) funktioniert wenn im OSD-Setup eine Bildschirmgr??e "default" eingestellt ist. Wenn dort z.B. 4:3 eingestellt ist dann nicht. Falls das nicht als Fehler angesehen wird, dann w?ren einige kleine Tipps nicht schlecht, damit ich da? wenigstens f?r mich ?ndern kann. Im einfachstem Fall mu? nur eine IF-Abfrage ge?ndert werden. Zus?tzlich mu? man das vorher eingestellte Bildverh?ltnis sichern.


For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=7637&group_id=2051


From admin at berlios.de  Sun May 28 15:45:41 2006
From: admin at berlios.de (admin at berlios.de)
Date: Sun, 28 May 2006 05:45:41 -0800 (AKDT)
Subject: [Softdevice-devel] [Bug #7549] Fehlfarben im OSD
Message-ID: <200605281345.k4SDjfBu017268@unicorn.berlios.de>

Bug #7549, was updated on 2006-May-19 10:56
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: xv-out
Status: Open
Resolution: None
Bug Group: None
Priority: 5
Submitted by: daliman
Assigned to : none
Summary: Fehlfarben im OSD

Details: Ich kann nicht genau nachvollziehen ob es ein Fehler von SD ist oder der ATI-Grafikkarte (video overlay?), denn es ist erst beim Umstieg auf SuSE10.1 aufgetreten. 

Bei ver?ndern des Wertes von z.B. "Expand Top/Bottom lines" wird da? OSD unleserlich. D.h. es wird bei mir von lila Streifen durchsetzt. 


Follow-Ups:

Date: 2006-May-28 05:45
By: daliman

Comment:
Kann geschlossen werden,  da die aktuelle cvs eine neue Configureoption "--disable-mmx" enth?lt, die dieses Problem beseitigt.

-------------------------------------------------------

Date: 2006-May-27 03:26
By: wachm

Comment:
Tritt das bei Software alpha blending auf?
-------------------------------------------------------

For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=7549&group_id=2051


From admin at berlios.de  Sun May 28 16:18:13 2006
From: admin at berlios.de (admin at berlios.de)
Date: Sun, 28 May 2006 16:18:13 +0200 (CEST)
Subject: [Softdevice-devel] [Bug #7637] Screenaspect
Message-ID: <200605281418.k4SEIDVC018209@unicorn.berlios.de>

Bug #7637, was updated on 2006-May-28 15:43
Here is a current snapshot of the bug.

Project: Vdr Softdevice
Category: xv-out
Status: Open
Resolution: None
Bug Group: None
Priority: 5
Submitted by: daliman
Assigned to : lucke
Summary: Screenaspect

Details: Das Umschalten des Screenaspects(? 4:3 oder 16:9) funktioniert wenn im OSD-Setup eine Bildschirmgr??e "default" eingestellt ist. Wenn dort z.B. 4:3 eingestellt ist dann nicht. Falls das nicht als Fehler angesehen wird, dann w?ren einige kleine Tipps nicht schlecht, damit ich da? wenigstens f?r mich ?ndern kann. Im einfachstem Fall mu? nur eine IF-Abfrage ge?ndert werden. Zus?tzlich mu? man das vorher eingestellte Bildverh?ltnis sichern.


Follow-Ups:

Date: 2006-May-28 16:18
By: lucke

Comment:
Ups, da hab ich vergessen mich zu melden, sorry.

Welche Aufl?sung hat dein Bildschirm ?
Welche Ausgabemethode wird verwendet ?

Die Fragen hatte ich schon mal gestellt und wurden hier beantwortet:
http://www.linuxtv.org/pipermail/vdr/2006-May/009297.html

Zeig dich mal bitte die Meldungen aus /var/log/messages , die bei dir so geschrieben werden, und zwar dann wenn deinen Meinung nach etwas nicht richtig gemacht wird.

May 28 16:08:33 jarada jarada vdr: [14894] [VideoOut]: resolution changed: W(736 -> 720); H(576 ->576)
May 28 16:08:33 jarada jarada vdr: [14894] [VideoOut]: aspect changed (0 -> 0 ; 1.366667 -> 1.333333)
May 28 16:08:33 jarada jarada vdr: [14894] [VideoOut]: 720x576 [0,0 720x576] -> 1024x576 [128,0 768x576]

-------------------------------------------------------

For detailed info, follow this link:
http://developer.berlios.de/bugs/?func=detailbug&bug_id=7637&group_id=2051


From stefan at lucke.in-berlin.de  Sun May 28 21:28:31 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 28 May 2006 21:28:31 +0200
Subject: [Softdevice-devel] New PicBuffer code sometimes crashes
Message-ID: <200605282128.31647.stefan@lucke.in-berlin.de>

With new PicBuffer code, vdr chrashes sometimes at startup. It seems
to happen more often, when initial tuning takes a while.

[Thread debugging using libthread_db enabled]
[New Thread -1211340576 (LWP 19140)]
[softdevice] processing args
[softdevice]   argv [0] = softdevice
[softdevice]   argv [1] = -vo
vo_argv: xv:
[setup-softdevice] alsa ac3Mode set to: 3
[setup-softdevice] alsa AC3 device set to: hw:0,1
[setup-softdevice] alsa device set to: default
[setup-softdevice] A/V Offset set to (0)
[setup-softdevice] Cropping 0 lines from bottom
[setup-softdevice] Cropping 0 columns from left
[setup-softdevice] cropping mode set to 0 (none)
[setup-softdevice] cropping mode toggle key set to 0 (none)
[setup-softdevice] Cropping 0 columns from right
[setup-softdevice] Cropping 0 lines from top
[setup-softdevice] deinterlace method set to 1 lavc
[setup-softdevice] mainMenu: 1
[setup-softdevice] setting alpha blend mode to pseudo
[softdevice] picture mirroring set to 0 (off)
[setup-softdevice] pixel format set to (I420)
[setup-softdevice] shouldSuspend to: 0
[setup-softdevice] syncTimerMode: sig
[softdevice] UseStretchBlitset to off
[setup-softdevice] vidBrightness: 50
[setup-softdevice] vidContrast: 50
[setup-softdevice] vidHue: 50
[setup-softdevice] vidSaturation: 50
[setup-softdevice] startup aspect set to (16:9 wide)
[New Thread -1216529488 (LWP 19143)]
[New Thread -1224922192 (LWP 19144)]
[New Thread -1233314896 (LWP 19145)]
[New Thread -1241707600 (LWP 19146)]
[New Thread -1250100304 (LWP 19147)]
[softdevice] initializing Plugin
[softdevice] Initializing Video Out
[softdevice] ffmpeg version(CVS) build(3344640 - 330900)
Plugin file is ./PLUGINS/lib/libvdr-softdevice.so.1.4.0
Plugin path is ./PLUGINS/lib/

____ ./PLUGINS/lib/ ____

[New Thread -1260549200 (LWP 19148)]
[XvVideoOut]: osd_image shmid = 9797634
[XvVideoOut]: got osd_image: width 1280 height 1024, bytes per line 5120
[XvVideoOut]: max area size 2048 x 2048
[XvVideoOut]: using area size 736 x 576
[softdevice] Subplugin successfully opend
[softdevice] Video Out seems to be OK
[softdevice] Initializing Audio Out
[softdevice] Audio out seems to be OK
[softdevice] A/V devices initialized, now initializing MPEG2 Decoder
[New Thread -1275253840 (LWP 19151)]
[New Thread -1286014032 (LWP 19152)]
[New Thread -1294406736 (LWP 19153)]
[New Thread -1302799440 (LWP 19154)]
[New Thread -1315001424 (LWP 19155)]
[New Thread -1323394128 (LWP 19156)]
[New Thread -1331786832 (LWP 19157)]
warning unsupported pixel format!
[softdevice] error, libavcodec deinterlacer failure
[softdevice] switching deinterlacing off !
[New Thread -1341539408 (LWP 19158)]
reallocating buffer format 0-778986860 w: 720-720 h: 576-576
warning unsupported pixel format!

Program received signal SIGSEGV, Segmentation fault.
[Switching to Thread -1331786832 (LWP 19157)]
0xb79d6a7f in avcodec_get_chroma_sub_sample () from /usr/local/lib/libavcodec.so.51
(gdb) bt
#0  0xb79d6a7f in avcodec_get_chroma_sub_sample () from /usr/local/lib/libavcodec.so.51
#1  0xb78bf898 in cLibAvPostProc::Filter (this=0x850e1b0, dest=@0xb09e8410, orig=0x841a884) at VideoFilter.c:366
#2  0xb78ae8e4 in cVideoStreamDecoder::DecodePacket (this=0x850df40, pkt=0x85161e8) at mpeg2decoder.c:818
#3  0xb78accc7 in cStreamDecoder::Action (this=0x850df40) at mpeg2decoder.c:192
#4  0x081058d7 in cThread::StartThread (Thread=0x850df40) at thread.c:244
#5  0xb7eea380 in start_thread () from /lib/tls/libpthread.so.0
#6  0xb7d7fc6e in clone () from /lib/tls/libc.so.6
(gdb) locals


Sometimes there is no crash just strange messages:
[softdevice] A/V devices initialized, now initializing MPEG2 Decoder
warning unsupported pixel format!
[softdevice] error, libavcodec deinterlacer failure
[softdevice] switching deinterlacing off !

-- 
Stefan Lucke


From M.Wache at gmx.net  Mon May 29 21:28:10 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 29 May 2006 21:28:10 +0200
Subject: [Softdevice-devel] New PicBuffer code sometimes crashes
In-Reply-To: <200605282128.31647.stefan@lucke.in-berlin.de>
References: <200605282128.31647.stefan@lucke.in-berlin.de>
Message-ID: <447B4B4A.4030509@gmx.net>

Stefan Lucke schrieb:
> With new PicBuffer code, vdr chrashes sometimes at startup. It seems
> to happen more often, when initial tuning takes a while.
> 
I could not yet reproduce the crashes, so I'm not sure what causes them,
I assume it is a wrongly initialized variable.
I fixed a few bugs in PicBuffer.c and VideoFilter.c, but I'm not sure if
I catched the one which causes this. It would be nice to have the output
of a crash with PICDEB in Picbuffer.c enabled.

Bye,
Martin


From stefan at lucke.in-berlin.de  Mon May 29 21:47:15 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 29 May 2006 21:47:15 +0200
Subject: [Softdevice-devel] New PicBuffer code sometimes crashes
In-Reply-To: <447B4B4A.4030509@gmx.net>
References: <200605282128.31647.stefan@lucke.in-berlin.de> <447B4B4A.4030509@gmx.net>
Message-ID: <200605292147.15637.stefan@lucke.in-berlin.de>

On Montag 29 Mai 2006 21:28, Martin Wache wrote:
> Stefan Lucke schrieb:
> > With new PicBuffer code, vdr chrashes sometimes at startup. It seems
> > to happen more often, when initial tuning takes a while.


From stefan at lucke.in-berlin.de  Mon May 29 21:54:12 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 29 May 2006 21:54:12 +0200
Subject: [Softdevice-devel] New PicBuffer code sometimes crashes
In-Reply-To: <447B4B4A.4030509@gmx.net>
References: <200605282128.31647.stefan@lucke.in-berlin.de> <447B4B4A.4030509@gmx.net>
Message-ID: <200605292154.12491.stefan@lucke.in-berlin.de>

On Montag 29 Mai 2006 21:28, Martin Wache wrote:
> Stefan Lucke schrieb:
> > With new PicBuffer code, vdr chrashes sometimes at startup. It seems
> > to happen more often, when initial tuning takes a while.
> > 
> I could not yet reproduce the crashes, so I'm not sure what causes them,
> I assume it is a wrongly initialized variable.
> I fixed a few bugs in PicBuffer.c and VideoFilter.c, but I'm not sure if
> I catched the one which causes this. It would be nice to have the output
> of a crash with PICDEB in Picbuffer.c enabled.

Compile failes in line 165:
PicBuffer.c: In member function `sPicBuffer* cPicBufferManager::GetBuffer(PixelFormat, int, int)':
PicBuffer.c:165: error: `pic' undeclared (first use this function)

sPicBuffer *cPicBufferManager::GetBuffer(PixelFormat pix_fmt,
                    int w, int h) {
    PICDEB("GetBuffer pix_fmt %d frame %p (%d,%d)\n",pix_fmt,pic,w,h);

or here:
PicBuffer.c:211: error: `pic' undeclared (first use this function)
PicBuffer.c:211: error: (Each undeclared identifier is reported only once for each function it appears in.)
PicBuffer.c: In member function `void cPicBufferManager::ReleaseBuffer(sPicBuffer*)':
PicBuffer.c:217: error: 'struct sPicBuffer' has no member named 'data'


-- 
Stefan Lucke


From M.Wache at gmx.net  Mon May 29 21:55:35 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 29 May 2006 21:55:35 +0200
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
Message-ID: <447B51B7.8070504@gmx.net>

Hi all,

since my last changes to the cvs Ralfs and Laz patches to enable the
cle266 hw decoding in the softdevice any more. I adapted Ralf's latest
patch to the cvs, and fixed a few things. I also made some other
changes: I moved the colorspace back to the default and viatv is no
longer enabled automatically.
I also disabled the sync on horizontal refresh if mgaTV is not enabled,
in my opinion it doesn't make sense to sync on the horizontal refresh
when one doesn't know if the refresh rate is 50Hz/60Hz. One can only be
sure for TV-out. What about viaTv? Should we enable it also for viaTV?
Ah, and the main reason why I disabled it is because the a/v sync was
totally messed up on my EPIA board with VGA-Monitor and sync on
horizontal refresh enabled.
With this patch, postprocessing should work with cle266 enabled (however
it is painfully slow...) and softplay works :-)
Still there is some work to be done. I want to get rid of the method
GetMpegFb() which I temporarily introduced, instead I plan to move the
fb management to PicBufferManager.

Bye,
Martin
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: cle266.patch
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060529/0d34821d/attachment.ksh>

From M.Wache at gmx.net  Mon May 29 22:05:09 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 29 May 2006 22:05:09 +0200
Subject: [Softdevice-devel] New PicBuffer code sometimes crashes
In-Reply-To: <200605292147.15637.stefan@lucke.in-berlin.de>
References: <200605282128.31647.stefan@lucke.in-berlin.de> <447B4B4A.4030509@gmx.net> <200605292147.15637.stefan@lucke.in-berlin.de>
Message-ID: <447B53F5.8080701@gmx.net>

Stefan Lucke schrieb:
> On Montag 29 Mai 2006 21:28, Martin Wache wrote:
>> Stefan Lucke schrieb:
>>> With new PicBuffer code, vdr chrashes sometimes at startup. It seems
>>> to happen more often, when initial tuning takes a while.
> 
>>From the feeling I had, it looked like a race condition (with dfb-out
> I got the famous sig-11 ). The first OSD was shown, but I guess the OSD 
> refresh gets active, while the first video frame is about to be displayed.
> 
>> I could not yet reproduce the crashes, so I'm not sure what causes them,
>> I assume it is a wrongly initialized variable.
> 
> Got the update, now it seems to be impossible to turn deinterlacing on:
That's one of the bug's I fixed, previously deinterlacing was not
disabled on errors. Now we only have to fix the other problem ;-)

> [softdevice] Audio out seems to be OK
> [softdevice] A/V devices initialized, now initializing MPEG2 Decoder
> warning unsupported pixel format(22)!

format 22 is PIX_FMT_NB, interesting... Why should a picture with
PIX_FMT_NB be requested?

> 
> Will try that soon.
> 
Thank you!

Bye,
Martin



From torgeir at pobox.com  Mon May 29 22:10:07 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Mon, 29 May 2006 21:10:07 +0100
Subject: [Softdevice-devel] softplay & vdr-1.4.0?
Message-ID: <1148933407.2314.2.camel@localhost>

Is a release of softplay that compiles with vdr-1.4.0 in the works?

-- 
Torgeir Veimo <torgeir at pobox.com>



From M.Wache at gmx.net  Mon May 29 22:14:21 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 29 May 2006 22:14:21 +0200
Subject: [Softdevice-devel] New PicBuffer code sometimes crashes
In-Reply-To: <200605292154.12491.stefan@lucke.in-berlin.de>
References: <200605282128.31647.stefan@lucke.in-berlin.de> <447B4B4A.4030509@gmx.net> <200605292154.12491.stefan@lucke.in-berlin.de>
Message-ID: <447B561D.5000202@gmx.net>

Stefan Lucke schrieb:
> On Montag 29 Mai 2006 21:28, Martin Wache wrote:
>> Stefan Lucke schrieb:
>>> With new PicBuffer code, vdr chrashes sometimes at startup. It seems
>>> to happen more often, when initial tuning takes a while.
>>>
>> I could not yet reproduce the crashes, so I'm not sure what causes them,
>> I assume it is a wrongly initialized variable.
>> I fixed a few bugs in PicBuffer.c and VideoFilter.c, but I'm not sure if
>> I catched the one which causes this. It would be nice to have the output
>> of a crash with PICDEB in Picbuffer.c enabled.
> 
> Compile failes in line 165:
> PicBuffer.c: In member function `sPicBuffer* cPicBufferManager::GetBuffer(PixelFormat, int, int)':
> PicBuffer.c:165: error: `pic' undeclared (first use this function)
> 
> sPicBuffer *cPicBufferManager::GetBuffer(PixelFormat pix_fmt,
>                     int w, int h) {
>     PICDEB("GetBuffer pix_fmt %d frame %p (%d,%d)\n",pix_fmt,pic,w,h);
> 
> or here:
> PicBuffer.c:211: error: `pic' undeclared (first use this function)
> PicBuffer.c:211: error: (Each undeclared identifier is reported only once for each function it appears in.)
> PicBuffer.c: In member function `void cPicBufferManager::ReleaseBuffer(sPicBuffer*)':
> PicBuffer.c:217: error: 'struct sPicBuffer' has no member named 'data'
> 
> 
Should be fixed in the CVS please try again.

Bye,
Martin


From M.Wache at gmx.net  Mon May 29 22:25:57 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Mon, 29 May 2006 22:25:57 +0200
Subject: [Softdevice-devel] softplay & vdr-1.4.0?
In-Reply-To: <1148933407.2314.2.camel@localhost>
References: <1148933407.2314.2.camel@localhost>
Message-ID: <447B58D5.3070806@gmx.net>

Torgeir Veimo schrieb:
> Is a release of softplay that compiles with vdr-1.4.0 in the works?
> 
I can't say that it is in the works, but you make me think about a
release. I myself didn't yet upgrade to vdr-1.4.0, what is the problem
compiling softplay with vdr-1.4.0?
Wasn't there a patch posted by Stefan? Does this fix the problem? I
guess I should have applied it...

Bye,
Martin


From stefan at lucke.in-berlin.de  Mon May 29 22:29:42 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 29 May 2006 22:29:42 +0200
Subject: [Softdevice-devel] New PicBuffer code sometimes crashes
In-Reply-To: <447B561D.5000202@gmx.net>
References: <200605282128.31647.stefan@lucke.in-berlin.de> <200605292154.12491.stefan@lucke.in-berlin.de> <447B561D.5000202@gmx.net>
Message-ID: <200605292229.42966.stefan@lucke.in-berlin.de>

On Montag 29 Mai 2006 22:14, Martin Wache wrote:
> Stefan Lucke schrieb:
> > On Montag 29 Mai 2006 21:28, Martin Wache wrote:
> >> Stefan Lucke schrieb:
> >>> With new PicBuffer code, vdr chrashes sometimes at startup. It seems
> >>> to happen more often, when initial tuning takes a while.
> >>>
> >> I could not yet reproduce the crashes, so I'm not sure what causes them,
> >> I assume it is a wrongly initialized variable.
> >> I fixed a few bugs in PicBuffer.c and VideoFilter.c, but I'm not sure if
> >> I catched the one which causes this. It would be nice to have the output
> >> of a crash with PICDEB in Picbuffer.c enabled.
> > 
> > Compile failes in line 165:
> > PicBuffer.c: In member function `sPicBuffer* cPicBufferManager::GetBuffer(PixelFormat, int, int)':
> > PicBuffer.c:165: error: `pic' undeclared (first use this function)
> > 
> > sPicBuffer *cPicBufferManager::GetBuffer(PixelFormat pix_fmt,
> >                     int w, int h) {
> >     PICDEB("GetBuffer pix_fmt %d frame %p (%d,%d)\n",pix_fmt,pic,w,h);
> > 
> > or here:
> > PicBuffer.c:211: error: `pic' undeclared (first use this function)
> > PicBuffer.c:211: error: (Each undeclared identifier is reported only once for each function it appears in.)
> > PicBuffer.c: In member function `void cPicBufferManager::ReleaseBuffer(sPicBuffer*)':
> > PicBuffer.c:217: error: 'struct sPicBuffer' has no member named 'data'
> > 
> > 
> Should be fixed in the CVS please try again.

Yup, compiles now but does not crash.
I noticed that even if deinterlaceing seems to be disabled,
Postprocessing Method is still at "fast" and has some negative
effect no displayed colors. Seems to be shifted a bit up and left.

Thats a trace from trying to activate postprocessing:

vout_pic[2184]:GetBuffer pix_fmt 0 (752,608)
vout_pic[2184]:not using buffer 0: use_count=1
vout_pic[2184]:not using buffer 1: use_count=1
vout_pic[2184]:not using buffer 2: use_count=2
vout_pic[2184]:format change relasing old buf_num 3
vout_pic[2184]:ReleasePicBuffer 3vout_pic[2184]:allocating buf_num 3
vout_pic[2184]:AllocPicBuffer buf_num 3 pix_fmt 0 (752,608)
vout_pic[2185]:end AllocPicBuffer buf->pixel[0] 0xb2bfd008
vout_pic[2185]:end GetBuffer: PicBuffer.pixel[0] 0xb2bfd008 buf_num 3
vout_pic[2191]:GetBuffer pix_fmt 22 (720,576)
vout_pic[2191]:not using buffer 0: use_count=1
vout_pic[2191]:not using buffer 1: use_count=1
vout_pic[2191]:not using buffer 2: use_count=2
vout_pic[2191]:not using buffer 3: use_count=1
vout_pic[2191]:allocating buf_num 4
vout_pic[2191]:AllocPicBuffer buf_num 4 pix_fmt 22 (720,576)
warning unsupported pixel format(22)!
vout_pic[2192]:end AllocPicBuffer buf->pixel[0] 0xb10b5008
vout_pic[2192]:end GetBuffer: PicBuffer.pixel[0] 0xb10b5008 buf_num 4
[softdevice] error, libavcodec deinterlacer failure
[softdevice] switching deinterlacing off !
vout_pic[2232]:ReleaseBuffer frame 0x83cd204, pixel[0] 0xb2b8a008
vout_pic[2232]:ReleaseBuffer frame 0x83cd2dc, pixel[0] 0xb2bfd008
vout_pic[2232]:GetBuffer pix_fmt 0 (752,608)
vout_pic[2232]:not using buffer 0: use_count=1
vout_pic[2232]:format change relasing old buf_num 1
vout_pic[2232]:ReleasePicBuffer 1vout_pic[2232]:allocating buf_num 1
vout_pic[2232]:AllocPicBuffer buf_num 1 pix_fmt 0 (752,608)
vout_pic[2234]:end AllocPicBuffer buf->pixel[0] 0xb2b8a008
vout_pic[2234]:end GetBuffer: PicBuffer.pixel[0] 0xb2b8a008 buf_num 1
vout_pic[2268]:GetBuffer pix_fmt 0 (752,608)
vout_pic[2268]:not using buffer 0: use_count=1
vout_pic[2268]:not using buffer 1: use_count=1
vout_pic[2268]:not using buffer 2: use_count=2
vout_pic[2268]:format change relasing old buf_num 3
vout_pic[2268]:ReleasePicBuffer 3vout_pic[2268]:allocating buf_num 3

> 
> Bye,
> Martin
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/softdevice-devel
> 

-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Mon May 29 22:35:27 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Mon, 29 May 2006 22:35:27 +0200
Subject: [Softdevice-devel] softplay & vdr-1.4.0?
In-Reply-To: <447B58D5.3070806@gmx.net>
References: <1148933407.2314.2.camel@localhost> <447B58D5.3070806@gmx.net>
Message-ID: <200605292235.27992.stefan@lucke.in-berlin.de>

On Montag 29 Mai 2006 22:25, Martin Wache wrote:
> Torgeir Veimo schrieb:
> > Is a release of softplay that compiles with vdr-1.4.0 in the works?
> > 
> I can't say that it is in the works, but you make me think about a
> release. I myself didn't yet upgrade to vdr-1.4.0, 

Time to upgrade :-) .

> what is the problem 
> compiling softplay with vdr-1.4.0?
> Wasn't there a patch posted by Stefan? Does this fix the problem? I
> guess I should have applied it...

It should be done a bit simplier ( not the fake comment line ).
More the way softieee1394 is doing now:

http://cvs.berlios.de/cgi-bin/viewcvs.cgi/softdevice/softieee1394/Makefile.diff?r1=1.2&r2=1.3

-- 
Stefan Lucke


From torgeir at pobox.com  Mon May 29 22:40:47 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Mon, 29 May 2006 21:40:47 +0100
Subject: [Softdevice-devel] softplay & vdr-1.4.0?
In-Reply-To: <447B58D5.3070806@gmx.net>
References: <1148933407.2314.2.camel@localhost>  <447B58D5.3070806@gmx.net>
Message-ID: <1148935247.2314.12.camel@localhost>

On Mon, 2006-05-29 at 22:25 +0200, Martin Wache wrote:
> 
> I can't say that it is in the works, but you make me think about a
> release. I myself didn't yet upgrade to vdr-1.4.0, what is the problem
> compiling softplay with vdr-1.4.0? 

APIVERSION.

Probably. I've just gotten back from 8 months of exile in Australia,
without any computer to run vdr on so I might have overlooked it...

-- 
Torgeir Veimo <torgeir at pobox.com>



From laz at club-burniston.co.uk  Tue May 30 00:29:47 2006
From: laz at club-burniston.co.uk (Laz)
Date: Mon, 29 May 2006 23:29:47 +0100
Subject: [Softdevice-devel] softplay & vdr-1.4.0?
In-Reply-To: <1148935247.2314.12.camel@localhost>
References: <1148933407.2314.2.camel@localhost> <447B58D5.3070806@gmx.net> <1148935247.2314.12.camel@localhost>
Message-ID: <200605292329.47199.laz@club-burniston.co.uk>

On Monday 29 May 2006 21:40, Torgeir Veimo wrote:
> On Mon, 2006-05-29 at 22:25 +0200, Martin Wache wrote:
> > I can't say that it is in the works, but you make me think about a
> > release. I myself didn't yet upgrade to vdr-1.4.0, what is the problem
> > compiling softplay with vdr-1.4.0?
>
> APIVERSION.
>
> Probably. I've just gotten back from 8 months of exile in Australia,
> without any computer to run vdr on so I might have overlooked it...

As a quick fix, replace all VDRVERSION in the softplay Makefile for APIVERSION 
and it should work fine.

Cheers,

Laz


From M.Wache at gmx.net  Tue May 30 20:59:23 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 30 May 2006 20:59:23 +0200
Subject: [Softdevice-devel] New PicBuffer code sometimes crashes
In-Reply-To: <200605292229.42966.stefan@lucke.in-berlin.de>
References: <200605282128.31647.stefan@lucke.in-berlin.de> <200605292154.12491.stefan@lucke.in-berlin.de> <447B561D.5000202@gmx.net> <200605292229.42966.stefan@lucke.in-berlin.de>
Message-ID: <447C960B.7010505@gmx.net>

Stefan Lucke schrieb:
> On Montag 29 Mai 2006 22:14, Martin Wache wrote:
>> Stefan Lucke schrieb:
>>> On Montag 29 Mai 2006 21:28, Martin Wache wrote:
>>>> Stefan Lucke schrieb:
>>>>> With new PicBuffer code, vdr chrashes sometimes at startup. It seems
>>>>> to happen more often, when initial tuning takes a while.
>>>>>
>>>> I could not yet reproduce the crashes, so I'm not sure what causes them,
>>>> I assume it is a wrongly initialized variable.
>>>> I fixed a few bugs in PicBuffer.c and VideoFilter.c, but I'm not sure if
>>>> I catched the one which causes this. It would be nice to have the output
>>>> of a crash with PICDEB in Picbuffer.c enabled.
>>> Compile failes in line 165:
>>> PicBuffer.c: In member function `sPicBuffer* cPicBufferManager::GetBuffer(PixelFormat, int, int)':
>>> PicBuffer.c:165: error: `pic' undeclared (first use this function)
>>>
>>> sPicBuffer *cPicBufferManager::GetBuffer(PixelFormat pix_fmt,
>>>                     int w, int h) {
>>>     PICDEB("GetBuffer pix_fmt %d frame %p (%d,%d)\n",pix_fmt,pic,w,h);
>>>
>>> or here:
>>> PicBuffer.c:211: error: `pic' undeclared (first use this function)
>>> PicBuffer.c:211: error: (Each undeclared identifier is reported only once for each function it appears in.)
>>> PicBuffer.c: In member function `void cPicBufferManager::ReleaseBuffer(sPicBuffer*)':
>>> PicBuffer.c:217: error: 'struct sPicBuffer' has no member named 'data'
>>>
>>>
>> Should be fixed in the CVS please try again.
> 
> Yup, compiles now but does not crash.
> I noticed that even if deinterlaceing seems to be disabled,
> Postprocessing Method is still at "fast" and has some negative
> effect no displayed colors. Seems to be shifted a bit up and left.
> 
I think I fixed the problems, I forgot to correctly set the format of
the picture buffer :-(

Bye,
Martin


From stefan at lucke.in-berlin.de  Wed May 31 06:22:37 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 31 May 2006 06:22:37 +0200
Subject: [Softdevice-devel] New PicBuffer code sometimes crashes
In-Reply-To: <447C960B.7010505@gmx.net>
References: <200605282128.31647.stefan@lucke.in-berlin.de> <200605292229.42966.stefan@lucke.in-berlin.de> <447C960B.7010505@gmx.net>
Message-ID: <200605310622.37639.stefan@lucke.in-berlin.de>

On Dienstag 30 Mai 2006 20:59, Martin Wache wrote:
> Stefan Lucke schrieb:
> > On Montag 29 Mai 2006 22:14, Martin Wache wrote:
> >> Stefan Lucke schrieb:
> >>> On Montag 29 Mai 2006 21:28, Martin Wache wrote:
> >>>> Stefan Lucke schrieb:
> >>>>> With new PicBuffer code, vdr chrashes sometimes at startup. It seems
> >>>>> to happen more often, when initial tuning takes a while.
> >>>>>
> >>>> I could not yet reproduce the crashes, so I'm not sure what causes them,
> >>>> I assume it is a wrongly initialized variable.
> >>>> I fixed a few bugs in PicBuffer.c and VideoFilter.c, but I'm not sure if
> >>>> I catched the one which causes this. It would be nice to have the output
> >>>> of a crash with PICDEB in Picbuffer.c enabled.
> >>> Compile failes in line 165:
> >>> PicBuffer.c: In member function `sPicBuffer* cPicBufferManager::GetBuffer(PixelFormat, int, int)':
> >>> PicBuffer.c:165: error: `pic' undeclared (first use this function)
> >>>
> >>> sPicBuffer *cPicBufferManager::GetBuffer(PixelFormat pix_fmt,
> >>>                     int w, int h) {
> >>>     PICDEB("GetBuffer pix_fmt %d frame %p (%d,%d)\n",pix_fmt,pic,w,h);
> >>>
> >>> or here:
> >>> PicBuffer.c:211: error: `pic' undeclared (first use this function)
> >>> PicBuffer.c:211: error: (Each undeclared identifier is reported only once for each function it appears in.)
> >>> PicBuffer.c: In member function `void cPicBufferManager::ReleaseBuffer(sPicBuffer*)':
> >>> PicBuffer.c:217: error: 'struct sPicBuffer' has no member named 'data'
> >>>
> >>>
> >> Should be fixed in the CVS please try again.
> > 
> > Yup, compiles now but does not crash.
> > I noticed that even if deinterlaceing seems to be disabled,
> > Postprocessing Method is still at "fast" and has some negative
> > effect no displayed colors. Seems to be shifted a bit up and left.
> > 
> I think I fixed the problems, I forgot to correctly set the format of
> the picture buffer :-(

Yup, seems to be fixed, no format 22 and crash. Thanks.

-- 
Stefan Lucke


From rahrenbe at cc.hut.fi  Wed May 31 20:33:43 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Wed, 31 May 2006 21:33:43 +0300 (EEST)
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <447B51B7.8070504@gmx.net>
References: <447B51B7.8070504@gmx.net>
Message-ID: <Pine.OSF.4.61.0605312125590.417548@kosh.hut.fi>

On Mon, 29 May 2006, Martin Wache wrote:

> Hi all,
>
> since my last changes to the cvs Ralfs and Laz patches to enable the
> cle266 hw decoding in the softdevice any more. I adapted Ralf's latest
> patch to the cvs, and fixed a few things. I also made some other

Just tried your patch and the latest CVS version. Well, the OSD 
transparency works now (nice! Thanks Stefan!), but the CPU load is 
nearly identical with "cle266" and "viatv" options. It might be just my 
system with messed up libraties, so could someone verify that Martin's 
latest patch really reduces the CPU load when using "cle266" instead of 
"viatv" as Laz's patch did earlier also on my setup.

BR,
--
rofa


From laz at club-burniston.co.uk  Thu Jun  1 13:46:52 2006
From: laz at club-burniston.co.uk (Laz)
Date: Thu, 1 Jun 2006 12:46:52 +0100
Subject: [Softdevice-devel] Re: [vdr] G450 softdevice
In-Reply-To: <20060601100133.9452.qmail@web86406.mail.ukl.yahoo.com>
References: <20060601100133.9452.qmail@web86406.mail.ukl.yahoo.com>
Message-ID: <200606011246.53223.laz@club-burniston.co.uk>

On Thursday 01 Jun 2006 11:01, Stuart Morris wrote:
> I have been reading the 'TV-out, softdevice' thread and it appears
> there are users out there happy with their G450 + softdevice setup.
> I have a G450 but have been put off using it with VDR because
> information on how to get this combination to work on the net is
> poor. Googling gives information that is very old. Can anyone
> provide a concise howto describing everything required to set up
> a G450 head2 rgb-scart with softdevice on a recent 2.6.x kernel?

Have you looked at the TV-out info on the softdevice web page:
http://softdevice.berlios.de/#TV-Out

It was a while ago that I set my G450 up but I think it was pretty 
straightforward. Here's hoping that someone will correct me here!

One thing I _can't_ remember is whether the stock matroxfb in the kernel 
source works or whether it needs replacing with a different version 
(maybe someone else can enlighten us on this!). You will need a couple of 
patches which are to be found in the DirectFB source:

matroxfb-g400-clock-2.6.6.patch.bz2 (not quite sure what this one does)
matroxfb-full-memory-linux-2.6.6.patch.bz2 (this lets you use all of the 
RAM literally changes a couple of lines)

It looks like the matroxfb-vsync-irq patch has been included in the stock 
kernel so isn't needed now.

I made a component RGB cable from the schematics at:
http://forum.matrox.com/mga/viewforum.php?f=52&sid=a1c50e38759f99f96d4bf184cfef9c78
(pretty sure it was the "Scart-RGB cable for the Millennium G450" one 
which I bodged from a lead pinched off an old monitor.

Apart from that, I think I just built CVS DirectFB, CVS softdevice and it 
all just worked, apart from I was seeing lots of horizontal lines when 
scaling to a 4:3 TV (fixed by setting softdevice to 16:9 and setting my 
TV to 16:9 or 4:3 as needed!), although I think that has been resolved 
now.

As I mentioned in a previous posting it was working perfectly until I 
updated softdevice a few weeks back. Now the A-V sync sometimes wanders 
and interlaced streams aren't always smooth. Yet to track down the cause 
of this...

Cheers,

Laz


From marko.makela at hut.fi  Thu Jun  1 14:52:10 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Thu, 1 Jun 2006 15:52:10 +0300
Subject: [Softdevice-devel] Re: [vdr] G450 softdevice
In-Reply-To: <200606011246.53223.laz@club-burniston.co.uk>
References: <20060601100133.9452.qmail@web86406.mail.ukl.yahoo.com> <200606011246.53223.laz@club-burniston.co.uk>
Message-ID: <20060601125210.GA5295@localhost.localdomain>

On Thu, Jun 01, 2006 at 12:46:52PM +0100, Laz wrote:
> As I mentioned in a previous posting it was working perfectly until I 
> updated softdevice a few weeks back. Now the A-V sync sometimes wanders 
> and interlaced streams aren't always smooth. Yet to track down the cause 
> of this...

It's probably the non-MMX scaler function that was introduced in order
to properly scale the interlaced fields separately, to avoid distortions
when the vertical resolution changes.  I posted my findings about that
on the softdevice list a couple of weeks ago.

	Marko


From laz at club-burniston.co.uk  Thu Jun  1 16:28:16 2006
From: laz at club-burniston.co.uk (Laz)
Date: Thu, 1 Jun 2006 15:28:16 +0100
Subject: [Softdevice-devel] Re: [vdr] G450 softdevice
In-Reply-To: <20060601125210.GA5295@localhost.localdomain>
References: <20060601100133.9452.qmail@web86406.mail.ukl.yahoo.com> <200606011246.53223.laz@club-burniston.co.uk> <20060601125210.GA5295@localhost.localdomain>
Message-ID: <200606011528.16997.laz@club-burniston.co.uk>

On Thursday 01 Jun 2006 13:52, Marko M?kel? wrote:
> On Thu, Jun 01, 2006 at 12:46:52PM +0100, Laz wrote:
> > As I mentioned in a previous posting it was working perfectly until I
> > updated softdevice a few weeks back. Now the A-V sync sometimes
> > wanders and interlaced streams aren't always smooth. Yet to track
> > down the cause of this...
>
> It's probably the non-MMX scaler function that was introduced in order
> to properly scale the interlaced fields separately, to avoid
> distortions when the vertical resolution changes.  I posted my findings
> about that on the softdevice list a couple of weeks ago.

Ahhhh...I did see your post and never got round to following it up because 
I had a perfect picture (once I switched my TV to 16:9!)! DOH! Looks like 
my problems are down to those changes: the loss of MMX acceleration 
making the OSD sluggish, etc.

Looking through the thread again:
http://lists.berlios.de/pipermail/softdevice-devel/2006q2/001877.html

Looks like the DSBLIT_INTERLACED patch hasn't made it into DirectFB cvs 
yet but softdevice does include support for it.

Should I be apply Stefan's DirectFB patch at
http://lists.berlios.de/pipermail/softdevice-devel/2006q2/001968.html

Sounds like it makes things jerky so was backed out again.

:-s

Has this been resolved? Should I have a stable interlaced TV-out with 
mgatv or is it still being worked on?

Cheers,

Laz


From laz at club-burniston.co.uk  Thu Jun  1 16:44:01 2006
From: laz at club-burniston.co.uk (Laz)
Date: Thu, 1 Jun 2006 15:44:01 +0100
Subject: [Softdevice-devel] Incorrect aspect ratio for some streams
Message-ID: <200606011544.01943.laz@club-burniston.co.uk>

Has anything changed recently in the softdevice aspect ratio detection? In 
the past few weeks or so, I've noticed a couple of transmissions on the 
BBC (DVB-T in the UK) which are shown at the wrong aspect ratio.

I'm not sure whether this is the BBC changing something or a change in 
softdevice. This was for an older 4:3 transmission which was displayed on 
my 16:9 TV as even narrower than 4:3! The BBC used to broadcast 4:3 
material with black borders to make it 16:9 so maybe they've changed how 
they transmit stuff. Switching softdevice to 4:3 gave me the correct 
shape image!

Works flawlessly with other stuff, 16:9 or 4:3! The 'problem' transmission 
was something from the 1980s rather than something modern.

I can supply a few second clip if needed.

Cheers,

Laz


From stefan at lucke.in-berlin.de  Thu Jun  1 19:12:26 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 1 Jun 2006 19:12:26 +0200
Subject: [Softdevice-devel] Incorrect aspect ratio for some streams
In-Reply-To: <200606011544.01943.laz@club-burniston.co.uk>
References: <200606011544.01943.laz@club-burniston.co.uk>
Message-ID: <200606011912.26502.stefan@lucke.in-berlin.de>

On Donnerstag 01 Juni 2006 16:44, Laz wrote:
> 
> Has anything changed recently in the softdevice aspect ratio detection? In 
> the past few weeks or so, I've noticed a couple of transmissions on the 
> BBC (DVB-T in the UK) which are shown at the wrong aspect ratio.
> 
> I'm not sure whether this is the BBC changing something or a change in 
> softdevice. This was for an older 4:3 transmission which was displayed on 
> my 16:9 TV as even narrower than 4:3! The BBC used to broadcast 4:3 
> material with black borders to make it 16:9 so maybe they've changed how 
> they transmit stuff. Switching softdevice to 4:3 gave me the correct 
> shape image!
> 
> Works flawlessly with other stuff, 16:9 or 4:3! The 'problem' transmission 
> was something from the 1980s rather than something modern.
> 
> I can supply a few second clip if needed.

Would be nice have to some parts of that stream, which was not correct 
displayed.

-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Thu Jun  1 19:12:31 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 1 Jun 2006 19:12:31 +0200
Subject: [Softdevice-devel] Re: [vdr] G450 softdevice
In-Reply-To: <200606011528.16997.laz@club-burniston.co.uk>
References: <20060601100133.9452.qmail@web86406.mail.ukl.yahoo.com> <20060601125210.GA5295@localhost.localdomain> <200606011528.16997.laz@club-burniston.co.uk>
Message-ID: <200606011912.31798.stefan@lucke.in-berlin.de>

On Donnerstag 01 Juni 2006 16:28, Laz wrote:
> On Thursday 01 Jun 2006 13:52, Marko M?kel? wrote:
> > On Thu, Jun 01, 2006 at 12:46:52PM +0100, Laz wrote:
> > > As I mentioned in a previous posting it was working perfectly until I
> > > updated softdevice a few weeks back. Now the A-V sync sometimes
> > > wanders and interlaced streams aren't always smooth. Yet to track
> > > down the cause of this...
> >
> > It's probably the non-MMX scaler function that was introduced in order
> > to properly scale the interlaced fields separately, to avoid
> > distortions when the vertical resolution changes.  I posted my findings
> > about that on the softdevice list a couple of weeks ago.
> 
> Ahhhh...I did see your post and never got round to following it up because 
> I had a perfect picture (once I switched my TV to 16:9!)! DOH! Looks like 
> my problems are down to those changes: the loss of MMX acceleration 
> making the OSD sluggish, etc.

OSD shapes are normal when 4:3 is displayed on 16:9 as there is no
special clear of black bar area :-( .

The MMX version of yv12_to_yuy2_il_c() is on my list.

> 
> Looking through the thread again:
> http://lists.berlios.de/pipermail/softdevice-devel/2006q2/001877.html
> 
> Looks like the DSBLIT_INTERLACED patch hasn't made it into DirectFB cvs 
> yet but softdevice does include support for it.

Patch is not in cvs, Ville is working on a solution which works implicit
(source surface is allocated as interlaced). Once I asked him for the
weekend he had in mind (for further investigations on his patch),
I got a new version from him which had not the desired results too.

> 
> Should I be apply Stefan's DirectFB patch at
> http://lists.berlios.de/pipermail/softdevice-devel/2006q2/001968.html

Original patch starts here:
http://mail.directfb.org/pipermail/directfb-dev/2005-October/000846.html

> 
> Sounds like it makes things jerky so was backed out again.

> 
> :-s
> 
> Has this been resolved? Should I have a stable interlaced TV-out with 
> mgatv or is it still being worked on?

That was a different issue (independant of DSBLIT_INTERLACED etc).
Do you have that applied ?

-- 
Stefan Lucke


From M.Wache at gmx.net  Thu Jun  1 19:31:11 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 01 Jun 2006 19:31:11 +0200
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <Pine.OSF.4.61.0605312125590.417548@kosh.hut.fi>
References: <447B51B7.8070504@gmx.net> <Pine.OSF.4.61.0605312125590.417548@kosh.hut.fi>
Message-ID: <447F245F.9030702@gmx.net>

Rolf Ahrenberg schrieb:
> On Mon, 29 May 2006, Martin Wache wrote:
> 
>> Hi all,
>>
>> since my last changes to the cvs Ralfs and Laz patches to enable the
>> cle266 hw decoding in the softdevice any more. I adapted Ralf's latest
>> patch to the cvs, and fixed a few things. I also made some other
> 
> Just tried your patch and the latest CVS version. Well, the OSD
> transparency works now (nice! Thanks Stefan!), but the CPU load is
> nearly identical with "cle266" and "viatv" options. It might be just my
> system with messed up libraties, so could someone verify that Martin's
> latest patch really reduces the CPU load when using "cle266" instead of
> "viatv" as Laz's patch did earlier also on my setup.
> 

Unfortunately it seems that you are right, now the cpu usage is reduced
when using the clee266 option. I don't know what could cause this, I did
a short run with oprofile which showed this:

    54118 37.5947 no-vmlinux
    49870 34.6437 libdirect-0.9.so.25.0.0
    27745 19.2739 libcle266mpegdec-0.1.so
     8073  5.6082 libvdr-softdevice.so.1.3.44
     1454  1.0101 libc-2.3.5.so
     1280  0.8892 vdr
      424  0.2945 libdirectfb-0.9.so.25.0.0
      297  0.2063 libpthread-0.10.so
      280  0.1945 libasound.so.2.0.0

Not sure why vmlinux takes so much time... libdirect-0.9.so.25 belongs
to DirectFB and contains only one method:

49870    100.000  mmx2_memcpy

When I commented the line

videoSurface->Blit(mpegfb[currentFB], NULL, 0, 0);

the cpu usage dropped drastically (of course I also could not see a
video picture), so it seems that for some reason the blitting is done
via mmx2_memcpy. I don't understand what change cause this. I didn't
change much in video-dfb.c when I changed the cle266-patch, the only
other change was Stefan's fix for the transparency. I also upgraded from
DirectFB-0.9.23 to DirectFB-0.9.25.
Any ideas from the DirectFB experts?

Bye,
Martin


From laz at club-burniston.co.uk  Thu Jun  1 21:06:04 2006
From: laz at club-burniston.co.uk (Laz)
Date: Thu, 1 Jun 2006 20:06:04 +0100
Subject: [Softdevice-devel] Re: [vdr] G450 softdevice
In-Reply-To: <200606011912.31798.stefan@lucke.in-berlin.de>
References: <20060601100133.9452.qmail@web86406.mail.ukl.yahoo.com> <200606011528.16997.laz@club-burniston.co.uk> <200606011912.31798.stefan@lucke.in-berlin.de>
Message-ID: <200606012006.04417.laz@club-burniston.co.uk>

On Thursday 01 June 2006 18:12, Stefan Lucke wrote:
> On Donnerstag 01 Juni 2006 16:28, Laz wrote:
> > Ahhhh...I did see your post and never got round to following it up
> > because I had a perfect picture (once I switched my TV to 16:9!)! DOH!
> > Looks like my problems are down to those changes: the loss of MMX
> > acceleration making the OSD sluggish, etc.
>
> OSD shapes are normal when 4:3 is displayed on 16:9 as there is no
> special clear of black bar area :-( .
>
> The MMX version of yv12_to_yuy2_il_c() is on my list.

Fair enough.

:)

> > Looking through the thread again:
> > http://lists.berlios.de/pipermail/softdevice-devel/2006q2/001877.html
> >
> > Looks like the DSBLIT_INTERLACED patch hasn't made it into DirectFB cvs
> > yet but softdevice does include support for it.
>
> Patch is not in cvs, Ville is working on a solution which works implicit
> (source surface is allocated as interlaced). Once I asked him for the
> weekend he had in mind (for further investigations on his patch),
> I got a new version from him which had not the desired results too.
>
> > Should I be apply Stefan's DirectFB patch at
> > http://lists.berlios.de/pipermail/softdevice-devel/2006q2/001968.html
>
> Original patch starts here:
> http://mail.directfb.org/pipermail/directfb-dev/2005-October/000846.html

Is that the same patch (well, one based on the other)? Is it worth applying 
one of them or should I wait for Ville's solution? Do they both need the 
kernel patch to matroxfb?

> > Sounds like it makes things jerky so was backed out again.
> >
> > :-s
> >
> > Has this been resolved? Should I have a stable interlaced TV-out with
> > mgatv or is it still being worked on?
>
> That was a different issue (independant of DSBLIT_INTERLACED etc).
> Do you have that applied ?

No. Should I apply it (the kernel patch)?

Maybe I'll just go back to an older version of softdevice on that system for 
now!

;)

Cheers,

Laz


From stefan at lucke.in-berlin.de  Thu Jun  1 22:10:15 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 1 Jun 2006 22:10:15 +0200
Subject: [Softdevice-devel] Incorrect aspect ratio for some streams
In-Reply-To: <200606012000.35229.laz@club-burniston.co.uk>
References: <200606011544.01943.laz@club-burniston.co.uk> <200606011912.26502.stefan@lucke.in-berlin.de> <200606012000.35229.laz@club-burniston.co.uk>
Message-ID: <200606012210.16039.stefan@lucke.in-berlin.de>

On Donnerstag 01 Juni 2006 21:00, Laz wrote:
> On Thursday 01 June 2006 18:12, Stefan Lucke wrote:
> > On Donnerstag 01 Juni 2006 16:44, Laz wrote:
> > > Has anything changed recently in the softdevice aspect ratio detection?
> > > In the past few weeks or so, I've noticed a couple of transmissions on
> > > the BBC (DVB-T in the UK) which are shown at the wrong aspect ratio.
> > >
> > > I'm not sure whether this is the BBC changing something or a change in
> > > softdevice. This was for an older 4:3 transmission which was displayed on
> > > my 16:9 TV as even narrower than 4:3! The BBC used to broadcast 4:3
> > > material with black borders to make it 16:9 so maybe they've changed how
> > > they transmit stuff. Switching softdevice to 4:3 gave me the correct
> > > shape image!
> > >
> > > Works flawlessly with other stuff, 16:9 or 4:3! The 'problem'
> > > transmission was something from the 1980s rather than something modern.
> > >
> > > I can supply a few second clip if needed.
> >
> > Would be nice have to some parts of that stream, which was not correct
> > displayed.
> 
> Hopefully these links should work (let me know if they don't or if you want 
> them cutting even shorter):
> 
Thanks got them.

> This is the problem one. I've just tried playing it with mplayer and it is a 
> 4:3 picture with black borders bringing it up to 16:9 but softdevice thinks 
> it should be shown as 4:3 so it gets squashed! As I say, not sure whether 
> this is down to softdevice or BBC putting the wrong flags in the stream!
> 
> 

Both play fine with x11 (4:3 window, and 5:4 full screen)
1st one:
Jun  1 21:28:18 jarada jarada vdr: [11702] replay /net_data/video/test_streams/LAZ_aspect/BAD_aspect/2006-06-01.20.20.99.99.rec
Jun  1 21:28:18 jarada jarada vdr: [11702] playing '/net_data/video/test_streams/LAZ_aspect/BAD_aspect/2006-06-01.20.20.99.99.rec/001.vdr'
Jun  1 21:28:18 jarada jarada vdr: [11702] missing index file /net_data/video/test_streams/LAZ_aspect/BAD_aspect/2006-06-01.20.20.99.99.rec/index.vdr
Jun  1 21:28:18 jarada jarada vdr: [11745] dvbplayer thread started (pid=11702, tid=11745)
Jun  1 21:28:18 jarada jarada vdr: [11746] non blocking file reader thread started (pid=11702, tid=11746)
Jun  1 21:28:19 jarada jarada vdr: [11745] setting audio track to 1 (0)
Jun  1 21:28:19 jarada jarada vdr: [11747] [VideoOut]: aspect changed (0 -> 9 ; 1.333333 -> 1.777778)
Jun  1 21:28:19 jarada jarada vdr: [11747] [VideoOut]: 720x576 [90,0 540x576] -> 768x576 [0,0 768x576]

2nd one:
Jun  1 21:34:21 jarada jarada vdr: [11756] replay /net_data/video/test_streams/LAZ_aspect/OK_aspect/2006-06-01.20.20.99.99.rec
Jun  1 21:34:21 jarada jarada vdr: [11756] playing '/net_data/video/test_streams/LAZ_aspect/OK_aspect/2006-06-01.20.20.99.99.rec/001.vdr'
Jun  1 21:34:21 jarada jarada vdr: [11756] missing index file /net_data/video/test_streams/LAZ_aspect/OK_aspect/2006-06-01.20.20.99.99.rec/index.vdr
Jun  1 21:34:21 jarada jarada vdr: [11826] dvbplayer thread started (pid=11756, tid=11826)
Jun  1 21:34:21 jarada jarada vdr: [11827] non blocking file reader thread started (pid=11756, tid=11827)
Jun  1 21:34:21 jarada jarada vdr: [11826] setting audio track to 1 (0)
Jun  1 21:34:21 jarada jarada vdr: [11828] [VideoOut]: aspect changed (0 -> 8 ; 1.777778 -> 1.333333)
Jun  1 21:34:21 jarada jarada vdr: [11828] [VideoOut]: 720x576 [0,0 720x576] -> 768x576 [0,0 768x576]

thats from dfb
looks like there is an additional black bar on the left.
Jun  1 21:47:58 jarada jarada vdr: [12014] replay /net_data/video/test_streams/LAZ_aspect/BAD_aspect/2006-06-01.20.20.99.99.rec
Jun  1 21:47:58 jarada jarada vdr: [12014] playing '/net_data/video/test_streams/LAZ_aspect/BAD_aspect/2006-06-01.20.20.99.99.rec/001.vdr'
Jun  1 21:47:58 jarada jarada vdr: [12014] missing index file /net_data/video/test_streams/LAZ_aspect/BAD_aspect/2006-06-01.20.20.99.99.rec/index.vdr
Jun  1 21:47:58 jarada jarada vdr: [12038] dvbplayer thread started (pid=12014, tid=12038)
Jun  1 21:47:58 jarada jarada vdr: [12039] non blocking file reader thread started (pid=12014, tid=12039)
Jun  1 21:47:58 jarada jarada vdr: [12038] setting audio track to 1 (0)
Jun  1 21:47:58 jarada jarada vdr: [12040] [VideoOut]: aspect changed (0 -> 9 ; 1.333333 -> 1.777778)
Jun  1 21:47:58 jarada jarada vdr: [12040] [VideoOut]: 720x576 [90,0 540x576] -> 1280x1024 [0,32 1280x960]

Thats a live 16:9 stream which 4:3 cut out, dfb
Jun  1 21:41:17 jarada jarada vdr: [11873] [VideoOut]: 720x576 [90,0 540x576] -> 1280x1024 [0,32 1280x960]

Even my old AFD test streams shows not ok when dfb-out is used.

> This one plays OK, and mplayer shows that it is a 'real' 4:3 stream and 
> softdevice plays it fine.

-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Fri Jun  2 07:08:22 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 2 Jun 2006 07:08:22 +0200
Subject: [Softdevice-devel] Incorrect aspect ratio for some streams
In-Reply-To: <200606012000.35229.laz@club-burniston.co.uk>
References: <200606011544.01943.laz@club-burniston.co.uk> <200606011912.26502.stefan@lucke.in-berlin.de> <200606012000.35229.laz@club-burniston.co.uk>
Message-ID: <200606020708.23043.stefan@lucke.in-berlin.de>

On Donnerstag 01 Juni 2006 21:00, you wrote:
> On Thursday 01 June 2006 18:12, Stefan Lucke wrote:
> > On Donnerstag 01 Juni 2006 16:44, Laz wrote:
> > > Has anything changed recently in the softdevice aspect ratio detection?
> > > In the past few weeks or so, I've noticed a couple of transmissions on
> > > the BBC (DVB-T in the UK) which are shown at the wrong aspect ratio.
> > >
> > > I'm not sure whether this is the BBC changing something or a change in
> > > softdevice. This was for an older 4:3 transmission which was displayed on
> > > my 16:9 TV as even narrower than 4:3! The BBC used to broadcast 4:3
> > > material with black borders to make it 16:9 so maybe they've changed how
> > > they transmit stuff. Switching softdevice to 4:3 gave me the correct
> > > shape image!
> > >
> > > Works flawlessly with other stuff, 16:9 or 4:3! The 'problem'
> > > transmission was something from the 1980s rather than something modern.
> > >
> > > I can supply a few second clip if needed.
> >
> > Would be nice have to some parts of that stream, which was not correct
> > displayed.
> 
> Hopefully these links should work (let me know if they don't or if you want 
> them cutting even shorter):

Which hardware do you use (radeon, matrox, via) ?
via OK.
radeon BAD.
matrox untested.


-- 
Stefan Lucke


From laz at club-burniston.co.uk  Fri Jun  2 09:29:07 2006
From: laz at club-burniston.co.uk (Laz)
Date: Fri, 2 Jun 2006 08:29:07 +0100
Subject: [Softdevice-devel] Incorrect aspect ratio for some streams
In-Reply-To: <200606020708.23043.stefan@lucke.in-berlin.de>
References: <200606011544.01943.laz@club-burniston.co.uk> <200606012000.35229.laz@club-burniston.co.uk> <200606020708.23043.stefan@lucke.in-berlin.de>
Message-ID: <200606020829.07554.laz@club-burniston.co.uk>

On Friday 02 June 2006 06:08, Stefan Lucke wrote:
> On Donnerstag 01 Juni 2006 21:00, you wrote:
> > On Thursday 01 June 2006 18:12, Stefan Lucke wrote:
> > > On Donnerstag 01 Juni 2006 16:44, Laz wrote:
> > > > Has anything changed recently in the softdevice aspect ratio
> > > > detection? In the past few weeks or so, I've noticed a couple of
> > > > transmissions on the BBC (DVB-T in the UK) which are shown at the
> > > > wrong aspect ratio.
> > > >
> > > > I'm not sure whether this is the BBC changing something or a change
> > > > in softdevice. This was for an older 4:3 transmission which was
> > > > displayed on my 16:9 TV as even narrower than 4:3! The BBC used to
> > > > broadcast 4:3 material with black borders to make it 16:9 so maybe
> > > > they've changed how they transmit stuff. Switching softdevice to 4:3
> > > > gave me the correct shape image!
> > > >
> > > > Works flawlessly with other stuff, 16:9 or 4:3! The 'problem'
> > > > transmission was something from the 1980s rather than something
> > > > modern.
> > > >
> > > > I can supply a few second clip if needed.
> > >
> > > Would be nice have to some parts of that stream, which was not correct
> > > displayed.
> >
> > Hopefully these links should work (let me know if they don't or if you
> > want them cutting even shorter):
>
> Which hardware do you use (radeon, matrox, via) ?
> via OK.
> radeon BAD.
> matrox untested.

I've just done another couple of quick tests, both with dfb output:

viatv: softdevice cvs from 15/05/06 (before the PicBuffer and VideoFilter 
stuff) patched for the OSD fix only; set to 16:9 aspect on a 16:9 TV, all 
cropping turned off:
	I get the sideways squashed image as I described.

mgatv: softdevice cvs from 25/03/06 (I've gone back to an older version on 
there before the mmx bits were removed); set to 16:9 on a 4:3 TV set to 16:9, 
all croppping turned off:
	Both play back fine with the correct aspect ratio!

Is this down to how the AFDs are handled? Are the transmitted AFDs even 
correct?! I know the BBC have done some strange things before now!

;)

Cheers,

Laz


From stefan at lucke.in-berlin.de  Fri Jun  2 10:36:06 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri,  2 Jun 2006 10:36:06 +0200
Subject: [Softdevice-devel] Incorrect aspect ratio for some streams
In-Reply-To: <200606020829.07554.laz@club-burniston.co.uk>
References: <200606011544.01943.laz@club-burniston.co.uk> <200606012000.35229.laz@club-burniston.co.uk> <200606020708.23043.stefan@lucke.in-berlin.de> <200606020829.07554.laz@club-burniston.co.uk>
Message-ID: <1149237366.447ff8765855d@webmail.in-berlin.de>

Quoting Laz :

> On Friday 02 June 2006 06:08, Stefan Lucke wrote:
> > On Donnerstag 01 Juni 2006 21:00, you wrote:
> > > On Thursday 01 June 2006 18:12, Stefan Lucke wrote:
> > > > On Donnerstag 01 Juni 2006 16:44, Laz wrote:
> > > > > Has anything changed recently in the softdevice aspect ratio
> > > > > detection? In the past few weeks or so, I've noticed a couple of
> > > > > transmissions on the BBC (DVB-T in the UK) which are shown at the
> > > > > wrong aspect ratio.
> > > > >
> > > > > I'm not sure whether this is the BBC changing something or a change
> > > > > in softdevice. This was for an older 4:3 transmission which was
> > > > > displayed on my 16:9 TV as even narrower than 4:3! The BBC used to
> > > > > broadcast 4:3 material with black borders to make it 16:9 so maybe
> > > > > they've changed how they transmit stuff. Switching softdevice to 4:3
> > > > > gave me the correct shape image!
> > > > >
> > > > > Works flawlessly with other stuff, 16:9 or 4:3! The 'problem'
> > > > > transmission was something from the 1980s rather than something
> > > > > modern.
> > > > >
> > > > > I can supply a few second clip if needed.
> > > >
> > > > Would be nice have to some parts of that stream, which was not correct
> > > > displayed.
> > >
> > > Hopefully these links should work (let me know if they don't or if you
> > > want them cutting even shorter):
> >
> > Which hardware do you use (radeon, matrox, via) ?
> > via OK.
> > radeon BAD.
> > matrox untested.

My test were done with via-vga and radeon-vga. Nearly the
same softdevice cvs head version, with PicBuffer code.

>
> I've just done another couple of quick tests, both with dfb output:
>
> viatv: softdevice cvs from 15/05/06 (before the PicBuffer and VideoFilter
> stuff) patched for the OSD fix only; set to 16:9 aspect on a 16:9 TV, all
> cropping turned off:
> 	I get the sideways squashed image as I described.

Whats does "squashed" mean in your case ?

In my case (radeon-vga), it looked like the video is not shifted left enough.
When playing with our zoom function, I noticed that shifting horizontally was
jumpy (only changed zoom factor). That should mean put to value 8 or 9 only vertical
zoom was done and with value 9 or 10 ther was a bigger horizontal zoom jump.

>
> mgatv: softdevice cvs from 25/03/06 (I've gone back to an older version on
> there before the mmx bits were removed); set to 16:9 on a 4:3 TV set to 16:9,
> all croppping turned off:
> 	Both play back fine with the correct aspect ratio!
>
> Is this down to how the AFDs are handled?
> Are the transmitted AFDs even correct?!

They seem to be correct transmitted, recognized and handled, at least in
common code. Syslog messages are the same and of the _expected_ values.

> I know the BBC have done some strange things before now!
>

Stefan Lucke


From laz at club-burniston.co.uk  Fri Jun  2 11:12:43 2006
From: laz at club-burniston.co.uk (Laz)
Date: Fri, 2 Jun 2006 10:12:43 +0100
Subject: [Softdevice-devel] Incorrect aspect ratio for some streams
In-Reply-To: <1149237366.447ff8765855d@webmail.in-berlin.de>
References: <200606011544.01943.laz@club-burniston.co.uk> <200606020829.07554.laz@club-burniston.co.uk> <1149237366.447ff8765855d@webmail.in-berlin.de>
Message-ID: <200606021012.43530.laz@club-burniston.co.uk>

On Friday 02 Jun 2006 09:36, Stefan Lucke wrote:
> Quoting Laz :
> > On Friday 02 June 2006 06:08, Stefan Lucke wrote:
> > > Which hardware do you use (radeon, matrox, via) ?
> > > via OK.
> > > radeon BAD.
> > > matrox untested.
>
> My test were done with via-vga and radeon-vga. Nearly the
> same softdevice cvs head version, with PicBuffer code.

I've just updated to current cvs on the Via system to see if that makes 
any difference.

> > I've just done another couple of quick tests, both with dfb output:
> >
> > viatv: softdevice cvs from 15/05/06 (before the PicBuffer and
> > VideoFilter stuff) patched for the OSD fix only; set to 16:9 aspect
> > on a 16:9 TV, all cropping turned off:
> > 	I get the sideways squashed image as I described.
>
> Whats does "squashed" mean in your case ?

It is a 4:3 picture transmitted with black borders at the left and right 
to make it up to 16:9 frame size. With viatv output, it is being squashed 
sideways into the size of a 4:3 frame (keeping the black borders), so 
that the picture itself is squashed sideways.

> In my case (radeon-vga), it looked like the video is not shifted left
> enough. When playing with our zoom function, I noticed that shifting
> horizontally was jumpy (only changed zoom factor). That should mean put
> to value 8 or 9 only vertical zoom was done and with value 9 or 10 ther
> was a bigger horizontal zoom jump.

With my setup, it shouldn't be doing any cropping or zooming because it 
has already been put into a 16:9 frame. The aspect ratio of the pictures 
may be 4:3 but the whole frame is 16:9. On a 4:3 display, this would want 
expanding up to fill the screen (removing the borders) but on a 16:9 it 
just wants displaying as 16:9 with its black borders, unless the user 
wants it expanded up with cropping or something.

> > mgatv: softdevice cvs from 25/03/06 (I've gone back to an older
> > version on there before the mmx bits were removed); set to 16:9 on a
> > 4:3 TV set to 16:9, all croppping turned off:
> > 	Both play back fine with the correct aspect ratio!
> >
> > Is this down to how the AFDs are handled?
> > Are the transmitted AFDs even correct?!
>
> They seem to be correct transmitted, recognized and handled, at least
> in common code. Syslog messages are the same and of the _expected_
> values.

Hmmmmm...I'm just adding some debugging bits to video.c to see what it is 
doing. This sort of 'older' transmission used to work so maybe they are 
being transmitted with a different AFD now, or something like that!

Not quite sure when I'll get the time to test this, though.

Cheers,

Laz


From stefan at lucke.in-berlin.de  Fri Jun  2 20:27:04 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 2 Jun 2006 20:27:04 +0200
Subject: [Softdevice-devel] Incorrect aspect ratio for some streams
In-Reply-To: <200606020708.23043.stefan@lucke.in-berlin.de>
References: <200606011544.01943.laz@club-burniston.co.uk> <200606012000.35229.laz@club-burniston.co.uk> <200606020708.23043.stefan@lucke.in-berlin.de>
Message-ID: <200606022027.04847.stefan@lucke.in-berlin.de>

On Freitag 02 Juni 2006 07:08, Stefan Lucke wrote:
> On Donnerstag 01 Juni 2006 21:00, you wrote:
> > On Thursday 01 June 2006 18:12, Stefan Lucke wrote:
> > > On Donnerstag 01 Juni 2006 16:44, Laz wrote:
> > > > Has anything changed recently in the softdevice aspect ratio detection?
> > > > In the past few weeks or so, I've noticed a couple of transmissions on
> > > > the BBC (DVB-T in the UK) which are shown at the wrong aspect ratio.
> > > >
> > > > I'm not sure whether this is the BBC changing something or a change in
> > > > softdevice. This was for an older 4:3 transmission which was displayed on
> > > > my 16:9 TV as even narrower than 4:3! The BBC used to broadcast 4:3
> > > > material with black borders to make it 16:9 so maybe they've changed how
> > > > they transmit stuff. Switching softdevice to 4:3 gave me the correct
> > > > shape image!
> > > >
> > > > Works flawlessly with other stuff, 16:9 or 4:3! The 'problem'
> > > > transmission was something from the 1980s rather than something modern.
> > > >
> > > > I can supply a few second clip if needed.
> > >
> > > Would be nice have to some parts of that stream, which was not correct
> > > displayed.
> > 
> > Hopefully these links should work (let me know if they don't or if you want 
> > them cutting even shorter):
> 
> Which hardware do you use (radeon, matrox, via) ?
> via OK.
> radeon BAD.

In case of radeon, it seems to be a hardware issue. All drivers
I've checked (vidix, Xorg, DirectFB) adjust source x offsets at 32
pixel boundaries ( &= ~15) for color components which is &= ~31
for luma :-(. So for radeon I had to disable HAVE_SetSourceLocation
to get cropping, zoom and expand_columns mode work correct :-( .


-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Tue Jun  6 06:53:38 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 6 Jun 2006 06:53:38 +0200
Subject: [Softdevice-devel] DVB-T in H.264 in France and UK
Message-ID: <200606060653.38747.stefan@lucke.in-berlin.de>

Hi, 
has anyone tried H.264 streams to play or record with vdr & softdevice
in UK or France as discussed of linux-dvb list ?

http://www.linuxtv.org/pipermail/linux-dvb/2006-June/010679.html


-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Tue Jun  6 22:10:53 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 6 Jun 2006 22:10:53 +0200
Subject: [Softdevice-devel] Re: [vdr] G450 softdevice
In-Reply-To: <200606012006.04417.laz@club-burniston.co.uk>
References: <20060601100133.9452.qmail@web86406.mail.ukl.yahoo.com> <200606011912.31798.stefan@lucke.in-berlin.de> <200606012006.04417.laz@club-burniston.co.uk>
Message-ID: <200606062210.53574.stefan@lucke.in-berlin.de>

On Donnerstag 01 Juni 2006 21:06, Laz wrote:
> On Thursday 01 June 2006 18:12, Stefan Lucke wrote:
> > On Donnerstag 01 Juni 2006 16:28, Laz wrote:
> > > Ahhhh...I did see your post and never got round to following it up
> > > because I had a perfect picture (once I switched my TV to 16:9!)! DOH!
> > > Looks like my problems are down to those changes: the loss of MMX
> > > acceleration making the OSD sluggish, etc.
> >
> > OSD shapes are normal when 4:3 is displayed on 16:9 as there is no
> > special clear of black bar area :-( .
> >
> > The MMX version of yv12_to_yuy2_il_c() is on my list.
> 
> Fair enough.
> 
> :)

So I did, but benchmarking is strange.
The following numbers are 10 * 8 frame conversions. Deltas are
usecs numbers:

delta1: warmup with yv12_to_yuy2_il_mmx2()
delta2: yv12_to_yuy2_il_mmx2()
delta3: yv12_to_yuy2_il_c()
delta4: yv12_to_yuy2()
delta5: yv12 fast_memcpy() version

P4 2.2 GHz:
delta1 = 255623
delta2 = 249383
delta3 = 3076097
delta4 = 577051
delta5 = 41929

real    0m4.170s
user    0m4.148s
sys     0m0.004s

VIA Nehemiah 1GHz:
delta1 = 192235
delta2 = 189639
delta3 = 803055
delta4 = 175347
delta5 = 145239

real    0m1.452s
user    0m1.248s
sys     0m0.145s

-- 
Stefan Lucke


From marko.makela at hut.fi  Tue Jun  6 22:19:29 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 6 Jun 2006 23:19:29 +0300
Subject: [Softdevice-devel] Re: [vdr] G450 softdevice
In-Reply-To: <200606062210.53574.stefan@lucke.in-berlin.de>
References: <20060601100133.9452.qmail@web86406.mail.ukl.yahoo.com> <200606011912.31798.stefan@lucke.in-berlin.de> <200606012006.04417.laz@club-burniston.co.uk> <200606062210.53574.stefan@lucke.in-berlin.de>
Message-ID: <20060606201929.GD3563@localhost.localdomain>

On Tue, Jun 06, 2006 at 10:10:53PM +0200, Stefan Lucke wrote:
> So I did, but benchmarking is strange.

Indeed (VIA outperforming Intel at lower clock), but I'm glad that the
MMX version (delta2) outperforms the C version (delta3) by an order of
magnitude on both platforms you tested.

Could you publish your test program? Did you commit the MMX version
already? I could test on a Pentium-M at 1400 MHz and on a Celeron
at 900 MHz (my VDR box).

	Marko


From stefan at lucke.in-berlin.de  Tue Jun  6 22:59:37 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 6 Jun 2006 22:59:37 +0200
Subject: [Softdevice-devel] Re: [vdr] G450 softdevice
In-Reply-To: <20060606201929.GD3563@localhost.localdomain>
References: <20060601100133.9452.qmail@web86406.mail.ukl.yahoo.com> <200606062210.53574.stefan@lucke.in-berlin.de> <20060606201929.GD3563@localhost.localdomain>
Message-ID: <200606062259.37120.stefan@lucke.in-berlin.de>

On Dienstag 06 Juni 2006 22:19, Marko M?kel? wrote:
> On Tue, Jun 06, 2006 at 10:10:53PM +0200, Stefan Lucke wrote:
> > So I did, but benchmarking is strange.
> 
> Indeed (VIA outperforming Intel at lower clock), but I'm glad that the
> MMX version (delta2) outperforms the C version (delta3) by an order of
> magnitude on both platforms you tested.
> 
> Could you publish your test program?

Is attached.

> Did you commit the MMX version 
> already? 

It is now, but not yet called. Have to sort out some changes which
are waiting.

> I could test on a Pentium-M at 1400 MHz and on a Celeron 
> at 900 MHz (my VDR box).
> 

-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: softbench.c
Type: text/x-csrc
Size: 4267 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060606/61e72ed6/attachment.c>

From lucianm at users.sourceforge.net  Wed Jun  7 10:03:00 2006
From: lucianm at users.sourceforge.net (Lucian Muresan)
Date: Wed, 07 Jun 2006 10:03:00 +0200
Subject: [Softdevice-devel] starting softdevice/DirectFB in gentoo init script ?
Message-ID: <44868834.1020409@users.sourceforge.net>

Hi,

If by chance any softdevice user uses Gentoo and softdevice/DirectFB,
did anyone succeed to start from the gentoo scripts provided by 
http://packages.gentoo.org/ebuilds/?gentoo-vdr-scripts-0.3.4 ?
For me it simply does not start, and I can't find an error message in 
the log.
Does anybody start vdr+softdevice/DirectFB on any other distribution 
from the init script? Is there some trick with console terminals or 
something?

Regards,
Lucian


From marko.makela at hut.fi  Wed Jun  7 14:01:32 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 7 Jun 2006 15:01:32 +0300
Subject: [Softdevice-devel] Re: [vdr] G450 softdevice
In-Reply-To: <200606062259.37120.stefan@lucke.in-berlin.de>
References: <20060601100133.9452.qmail@web86406.mail.ukl.yahoo.com> <200606062210.53574.stefan@lucke.in-berlin.de> <20060606201929.GD3563@localhost.localdomain> <200606062259.37120.stefan@lucke.in-berlin.de>
Message-ID: <20060607120132.GA13524@localhost.localdomain>

On Tue, Jun 06, 2006 at 10:59:37PM +0200, Stefan Lucke wrote:
> On Dienstag 06 Juni 2006 22:19, Marko M?kel? wrote:
> > On Tue, Jun 06, 2006 at 10:10:53PM +0200, Stefan Lucke wrote:
> > > So I did, but benchmarking is strange.
> > 
> > Indeed (VIA outperforming Intel at lower clock), but I'm glad that the
> > MMX version (delta2) outperforms the C version (delta3) by an order of
> > magnitude on both platforms you tested.
> > 
> > Could you publish your test program?
> 
> Is attached.

I got softdevice from cvs and vdr 1.4.0.  I didn't build vdr or softdevice,
because I didn't want to install all dependencies (libavcodec et al).
Then I did the following in the softdevice directory:

touch config.h
comment out #include "setup-softdevice.h" in utils.c
gcc -O9 -std=c99 -march=pentium-m -combine softbench.c utils.c -o softbench
./softbench

Results on Pentium-M with userspace governor set to 1400 MHz:

delta1 = 29527
delta2 = 28911
delta3 = 122932
delta4 = 89013
delta5 = 26602

The two first digits seem constant over repeated runs.

gcc --version says:
gcc (GCC) 4.0.4 20060507 (prerelease) (Debian 4.0.3-3)
dpkg --status gcc says:
Version: 4:4.0.3-4

> > Did you commit the MMX version already? 
> 
> It is now, but not yet called. Have to sort out some changes which
> are waiting.

Please announce it on this list, as I believe I'm not the only interested
party who is not subscribed to the CVS commit list.

	Marko


From stefan at lucke.in-berlin.de  Fri Jun  9 19:17:10 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 9 Jun 2006 19:17:10 +0200
Subject: [Softdevice-devel] Re: [vdr] G450 softdevice
In-Reply-To: <200606062259.37120.stefan@lucke.in-berlin.de>
References: <20060601100133.9452.qmail@web86406.mail.ukl.yahoo.com> <20060606201929.GD3563@localhost.localdomain> <200606062259.37120.stefan@lucke.in-berlin.de>
Message-ID: <200606091917.10165.stefan@lucke.in-berlin.de>

On Dienstag 06 Juni 2006 22:59, Stefan Lucke wrote:
> On Dienstag 06 Juni 2006 22:19, Marko M?kel? wrote:
> > On Tue, Jun 06, 2006 at 10:10:53PM +0200, Stefan Lucke wrote:
> > > So I did, but benchmarking is strange.
> > 
> > Indeed (VIA outperforming Intel at lower clock), but I'm glad that the
> > MMX version (delta2) outperforms the C version (delta3) by an order of
> > magnitude on both platforms you tested.
> > 
> > Could you publish your test program?
> 
> Is attached.
> 
> > Did you commit the MMX version 
> > already? 
> 
> It is now, but not yet called. Have to sort out some changes which
> are waiting.
> 

My pending changes are in cvs now.

> > I could test on a Pentium-M at 1400 MHz and on a Celeron 
> > at 900 MHz (my VDR box).
> > 

Marko I don't know why your last mail didn't find it's way to the list.
It is only accessible via the web interface ;-) .
http://lists.berlios.de/pipermail/softdevice-devel/2006q2/002093.html

Your numbers are impressive.

-- 
Stefan Lucke


From marko.makela at hut.fi  Fri Jun  9 22:30:05 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Fri, 9 Jun 2006 23:30:05 +0300
Subject: [Softdevice-devel] Re: [vdr] G450 softdevice
In-Reply-To: <20060607120132.GA13524@localhost.localdomain>
References: <20060601100133.9452.qmail@web86406.mail.ukl.yahoo.com> <200606062210.53574.stefan@lucke.in-berlin.de> <20060606201929.GD3563@localhost.localdomain> <200606062259.37120.stefan@lucke.in-berlin.de> <20060607120132.GA13524@localhost.localdomain>
Message-ID: <20060609203005.GA3563@localhost.localdomain>

I did get this message via the list.  Stefan, maybe there was a temporary
MTA problem (or spam filter) at your end?

On Wed, Jun 07, 2006 at 03:01:32PM +0300, Marko M?kel? wrote:
> I got softdevice from cvs and vdr 1.4.0.  I didn't build vdr or softdevice,
> because I didn't want to install all dependencies (libavcodec et al).
> Then I did the following in the softdevice directory:
> 
> touch config.h
> comment out #include "setup-softdevice.h" in utils.c
> gcc -O9 -std=c99 -march=pentium-m -combine softbench.c utils.c -o softbench
> ./softbench
> 
> Results on Pentium-M with userspace governor set to 1400 MHz:
> 
> delta1 = 29527
> delta2 = 28911
> delta3 = 122932
> delta4 = 89013
> delta5 = 26602
> 
> The two first digits seem constant over repeated runs.

Same binary on the 900 MHz Celeron:

delta1 = 353333
delta2 = 353249
delta3 = 366210
delta4 = 374806
delta5 = 283929

Compiling with -march=pentium3 instead of pentium-m gives virtually
identical results, or perhaps delta5 might be slightly lower (smallest
was 273174, usually around 280000).

	Marko


From marko.makela at hut.fi  Fri Jun  9 23:19:15 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sat, 10 Jun 2006 00:19:15 +0300
Subject: [Softdevice-devel] Re: [vdr] G450 softdevice
In-Reply-To: <20060609203005.GA3563@localhost.localdomain>
References: <20060601100133.9452.qmail@web86406.mail.ukl.yahoo.com> <200606062210.53574.stefan@lucke.in-berlin.de> <20060606201929.GD3563@localhost.localdomain> <200606062259.37120.stefan@lucke.in-berlin.de> <20060607120132.GA13524@localhost.localdomain> <20060609203005.GA3563@localhost.localdomain>
Message-ID: <20060609211915.GB3563@localhost.localdomain>

On Fri, Jun 09, 2006 at 11:30:05PM +0300, Marko M?kel? wrote:
> Same binary on the 900 MHz Celeron:
> 
> delta1 = 353333
> delta2 = 353249
> delta3 = 366210
> delta4 = 374806
> delta5 = 283929

Because delta2 (yv12_to_yuy2_il_mmx2) is almost identical with
delta3 (yv12_to_yuy2_il_c), I ran oprofile for 10 seconds.  In
the run, yv12_to_yuy2_il_mmx2() accounted for 19110 samples
and libvdr-softdevice.so.1.4.0 accounted for 57933 samples (70.6%
of all CPU_CLK_UNHALTED events).  That figure includes statically
linked ffmpeg, it seems.

Of the yv12_to_yuy2_il_mmx2() samples, the majority occurs in two
loops:

    15  0.0259 :   5a2a0:       movq   (%eax),%mm1
  1885  3.2538 :   5a2a3:       mov    0xfffffff0(%ebp),%edx
   132  0.2278 :   5a2a6:       movq   (%eax,%edx,1),%mm2
  1610  2.7791 :   5a2aa:       movq   %mm1,%mm5
     1  0.0017 :   5a2ad:       movd   (%ecx),%mm3
   828  1.4292 :   5a2b0:       movq   %mm2,%mm6
    37  0.0639 :   5a2b3:       mov    0xffffffc8(%ebp),%edx
               :   5a2b6:       movd   (%edx),%mm4
   974  1.6813 :   5a2b9:       punpcklbw %mm4,%mm3
    28  0.0483 :   5a2bc:       punpcklbw %mm3,%mm1
  1754  3.0276 :   5a2bf:       movntq %mm1,(%esi)
    28  0.0483 :   5a2c2:       punpckhbw %mm3,%mm5
     2  0.0035 :   5a2c5:       punpcklbw %mm3,%mm2
    24  0.0414 :   5a2c8:       movntq %mm5,0x8(%esi)
  1668  2.8792 :   5a2cc:       punpckhbw %mm3,%mm6
    58  0.1001 :   5a2cf:       movntq %mm2,(%edi)
   162  0.2796 :   5a2d2:       movntq %mm6,0x8(%edi)
    36  0.0621 :   5a2d6:       incl   0xffffffe4(%ebp)
    56  0.0967 :   5a2d9:       add    $0x4,%edx
     1  0.0017 :   5a2dc:       add    $0x4,%ecx
    43  0.0742 :   5a2df:       add    $0x10,%esi
               :   5a2e2:       mov    %edx,0xffffffc8(%ebp)
    14  0.0242 :   5a2e5:       mov    0xffffffcc(%ebp),%edx
    25  0.0432 :   5a2e8:       add    $0x8,%eax
     6  0.0104 :   5a2eb:       add    $0x10,%edi
    25  0.0432 :   5a2ee:       cmp    %edx,0xffffffe4(%ebp)
    15  0.0259 :   5a2f1:       jne    5a2a0 <_Z20yv12_to_yuy2_il_mmx2PKhS0_S0_Phiiiii+0xa0>

The second loop is here:

    23  0.0397 :   5a330:       movq   (%eax),%mm1
  2289  3.9511 :   5a333:       mov    0xfffffff0(%ebp),%edx
               :   5a336:       movq   (%eax,%edx,1),%mm2
  1579  2.7256 :   5a33a:       movq   %mm1,%mm5
               :   5a33d:       movd   (%esi),%mm3
   876  1.5121 :   5a340:       movq   %mm2,%mm6
    64  0.1105 :   5a343:       movd   (%edi),%mm4
   956  1.6502 :   5a346:       punpcklbw %mm4,%mm3
    20  0.0345 :   5a349:       punpcklbw %mm3,%mm1
   103  0.1778 :   5a34c:       mov    0xffffffc8(%ebp),%edx
  1431  2.4701 :   5a34f:       movntq %mm1,(%edx)
   134  0.2313 :   5a352:       punpckhbw %mm3,%mm5
     6  0.0104 :   5a355:       punpcklbw %mm3,%mm2
    18  0.0311 :   5a358:       movntq %mm5,0x8(%edx)
  1380  2.3821 :   5a35c:       punpckhbw %mm3,%mm6
   134  0.2313 :   5a35f:       movntq %mm2,(%ecx)
   177  0.3055 :   5a362:       movntq %mm6,0x8(%ecx)
    37  0.0639 :   5a366:       incl   0xffffffec(%ebp)
   158  0.2727 :   5a369:       add    $0x10,%edx
               :   5a36c:       add    $0x4,%esi
    43  0.0742 :   5a36f:       add    $0x4,%edi
    24  0.0414 :   5a372:       mov    %edx,0xffffffc8(%ebp)
    42  0.0725 :   5a375:       mov    0xffffffcc(%ebp),%edx
    19  0.0328 :   5a378:       add    $0x8,%eax
     3  0.0052 :   5a37b:       add    $0x10,%ecx
    18  0.0311 :   5a37e:       cmp    %edx,0xffffffec(%ebp)
    23  0.0397 :   5a381:       jne    5a330 <_Z20yv12_to_yuy2_il_mmx2PKhS0_S0_Phiiiii+0x130>

These loops correspond to the two yv12_to_yuy2_il_mmx2_line() invocations
in yv12_to_yuy2_il_mmx2().  I tried to remove the inline qualifier to see
if it makes any difference.  Not much: 18193 samples in
yv12_to_yuy2_il_mmx2_line() and 222 in yv12_to_yuy2_il_mmx2().  This is
slightly less than the 19110 on the previous run, but the difference is
smaller than the margin of error.

Is there anything you could do to speed up yv12_to_yuy2_il_mmx2_line()
on a Celeron (Coppermine) stepping 10 with 128 KiB cache?

Could you at least avoid calling yv12_to_yuy2_il_*() when no vertical scaling
takes place?

	Marko


From stefan at lucke.in-berlin.de  Sat Jun 10 00:03:49 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 10 Jun 2006 00:03:49 +0200
Subject: [Softdevice-devel] Re: [vdr] G450 softdevice
In-Reply-To: <20060609211915.GB3563@localhost.localdomain>
References: <20060601100133.9452.qmail@web86406.mail.ukl.yahoo.com> <20060609203005.GA3563@localhost.localdomain> <20060609211915.GB3563@localhost.localdomain>
Message-ID: <200606100003.49618.stefan@lucke.in-berlin.de>

On Freitag 09 Juni 2006 23:19, Marko M?kel? wrote:
> On Fri, Jun 09, 2006 at 11:30:05PM +0300, Marko M?kel? wrote:
> > Same binary on the 900 MHz Celeron:
> > 
> > delta1 = 353333
> > delta2 = 353249
> > delta3 = 366210
> > delta4 = 374806
> > delta5 = 283929
> 

> 
> Is there anything you could do to speed up yv12_to_yuy2_il_mmx2_line()
> on a Celeron (Coppermine) stepping 10 with 128 KiB cache?
> 
> Could you at least avoid calling yv12_to_yuy2_il_*() when no vertical scaling
> takes place?

But delta4 corresponds to the default (old), frame based yuy2 converter and
is at the same speed ;-( . Is it a pitfall of benchmarking ?

-- 
Stefan Lucke


From marko.makela at hut.fi  Sat Jun 10 22:52:27 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Sat, 10 Jun 2006 23:52:27 +0300
Subject: [Softdevice-devel] Re: [vdr] G450 softdevice
In-Reply-To: <200606100003.49618.stefan@lucke.in-berlin.de>
References: <20060601100133.9452.qmail@web86406.mail.ukl.yahoo.com> <20060609203005.GA3563@localhost.localdomain> <20060609211915.GB3563@localhost.localdomain> <200606100003.49618.stefan@lucke.in-berlin.de>
Message-ID: <20060610205227.GA3565@localhost.localdomain>

On Sat, Jun 10, 2006 at 12:03:49AM +0200, Stefan Lucke wrote:
> On Freitag 09 Juni 2006 23:19, Marko M?kel? wrote:
> > On Fri, Jun 09, 2006 at 11:30:05PM +0300, Marko M?kel? wrote:
> > > Same binary on the 900 MHz Celeron:
> > > 
> > > delta1 = 353333
> > > delta2 = 353249
> > > delta3 = 366210
> > > delta4 = 374806
> > > delta5 = 283929
> > 
> 
> > 
> > Is there anything you could do to speed up yv12_to_yuy2_il_mmx2_line()
> > on a Celeron (Coppermine) stepping 10 with 128 KiB cache?
> > 
> > Could you at least avoid calling yv12_to_yuy2_il_*() when no vertical scaling
> > takes place?
> 
> But delta4 corresponds to the default (old), frame based yuy2 converter and
> is at the same speed ;-( . Is it a pitfall of benchmarking ?

Good point.  Perhaps yv12_to_yuy2_il_mmx2() wasn't slower than the old
frame based converter after all.  Can you give a one-line patch for
reverting to the old converter?  Then I could get accurate benchmarks.
Also, if I don't mind wrong colors, how could the converter be bypassed
altogether?

Incrementing the loop count in softbench.c by a factor of 10 might give more
accurate results.  But I'd rather run the benchmarks within vdr+softdevice,
always playing back the same recording, and varying the converter method.

	Marko


From prakash at punnoor.de  Mon Jun 12 20:24:18 2006
From: prakash at punnoor.de (Prakash Punnoor)
Date: Mon, 12 Jun 2006 20:24:18 +0200
Subject: [Softdevice-devel] [PATCH] fix for softplay
Message-ID: <200606122024.18568.prakash@punnoor.de>

Hi,

I needed following to get it compiled in gentoo with gcc 4.1.1 and 
ffmpeg-0.4.9_p20060302. but it looks like a real bug to me, at least looking 
at the ffmpeg header files. I have also modified Makefile for vdr 1.4.0, but 
I saw that some patch already exists? Hth.


--- SoftPlayer.c.old	2006-06-12 17:48:30.000000000 +0200
+++ SoftPlayer.c	2006-06-12 17:48:03.000000000 +0200
@@ -170,12 +170,12 @@
         
                 // set audio index if not yet set
                 if ( AudioIdx== -1 &&
-                     ic->streams[pkt.stream_index]->codec.codec_type == 
CODEC_TYPE_AUDIO )
+                     ic->streams[pkt.stream_index]->codec->codec_type == 
CODEC_TYPE_AUDIO )
                         AudioIdx=pkt.stream_index;
                    
                 // set video index if not yet set
                 if ( VideoIdx== -1 &&
-                     ic->streams[pkt.stream_index]->codec.codec_type == 
CODEC_TYPE_VIDEO )
+                     ic->streams[pkt.stream_index]->codec->codec_type == 
CODEC_TYPE_VIDEO )
                         VideoIdx=pkt.stream_index;
                 // skip packets which do not belong to the current streams
                 if ( pkt.stream_index != VideoIdx &&
@@ -219,7 +219,7 @@
 			nStreams=ic->nb_streams;
 			fprintf(stderr,"Streams: %d\n",nStreams);
 			for (int i=0; i <nStreams; i++ ) {
-				printf("Codec %d ID: %d\n",i,ic->streams[i]->codec.codec_id);
+				printf("Codec %d ID: %d\n",i,ic->streams[i]->codec->codec_id);
 			};
 		};
 
@@ -245,9 +245,9 @@
 	for (i = 0; i<IC->nb_streams; i++) {
 		PLDBG("GetPlayMode stream %d codec_type %d\n",
 			i, IC->streams[i]->codec.codec_type);
-		if (IC->streams[i]->codec.codec_type == CODEC_TYPE_AUDIO)
+		if (IC->streams[i]->codec->codec_type == CODEC_TYPE_AUDIO)
 			hasAudio=true;
-		else if (IC->streams[i]->codec.codec_type == CODEC_TYPE_VIDEO)
+		else if (IC->streams[i]->codec->codec_type == CODEC_TYPE_VIDEO)
 			hasVideo=true;
 	};
 

-- 
(?=                 =?)
//\ Prakash Punnoor /\\
V_/                 \_V
-------------- next part --------------
A non-text attachment was scrubbed...
Name: deref.diff
Type: text/x-diff
Size: 1683 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060612/200cb751/attachment.diff>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060612/200cb751/attachment.pgp>

From prakash at punnoor.de  Mon Jun 12 20:28:48 2006
From: prakash at punnoor.de (Prakash Punnoor)
Date: Mon, 12 Jun 2006 20:28:48 +0200
Subject: [Softdevice-devel] softdevice/softplay clipping picture
Message-ID: <200606122028.48526.prakash@punnoor.de>

Hi,

I just installed softplay 0.0.2 slightly patched (see other post) with 
gentoo's ffmpeg-0.4.9_p20060302 and softdevice 0.2.3 using XV. In dvb mode 
everything nearly seems fine (only the OSD sometimes tends to show/leave some 
horizontal pink lines when I move the selection.) Playing back an xvid (720p) 
OSD show a lot of wrong colours, but the main problem is, I can only see 
about 60% of the picture the rest of the right side is left black. Any idea?

Cheers,
-- 
(?=                 =?)
//\ Prakash Punnoor /\\
V_/                 \_V
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060612/0bef178b/attachment.pgp>

From prakash at punnoor.de  Mon Jun 12 20:32:40 2006
From: prakash at punnoor.de (Prakash Punnoor)
Date: Mon, 12 Jun 2006 20:32:40 +0200
Subject: [Softdevice-devel] softdevice/softplay clipping picture
In-Reply-To: <200606122028.48526.prakash@punnoor.de>
References: <200606122028.48526.prakash@punnoor.de>
Message-ID: <200606122032.40275.prakash@punnoor.de>

Am Montag Juni 12 2006 20:28 schrieb Prakash Punnoor:
> I just installed softplay 0.0.2 slightly patched (see other post) with
> gentoo's ffmpeg-0.4.9_p20060302 and softdevice 0.2.3 using XV. In dvb mode
> everything nearly seems fine (only the OSD sometimes tends to show/leave
> some horizontal pink lines when I move the selection.) Playing back an xvid
> (720p) OSD show a lot of wrong colours, but the main problem is, I can only
> see about 60% of the picture the rest of the right side is left black. Any
> idea?

Uhm to be precise: I can only see 60% of the video. The OSD is shown full (but 
wrongly coloured), IIRC.
-- 
(?=                 =?)
//\ Prakash Punnoor /\\
V_/                 \_V
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060612/45fe5baa/attachment.pgp>

From stefan at lucke.in-berlin.de  Tue Jun 13 07:23:04 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 13 Jun 2006 07:23:04 +0200
Subject: [Softdevice-devel] softdevice/softplay clipping picture
In-Reply-To: <200606122032.40275.prakash@punnoor.de>
References: <200606122028.48526.prakash@punnoor.de> <200606122032.40275.prakash@punnoor.de>
Message-ID: <200606130723.04401.stefan@lucke.in-berlin.de>

On Montag 12 Juni 2006 20:32, Prakash Punnoor wrote:
> Am Montag Juni 12 2006 20:28 schrieb Prakash Punnoor:
> > I just installed softplay 0.0.2 slightly patched (see other post) with
> > gentoo's ffmpeg-0.4.9_p20060302 and softdevice 0.2.3 using XV. In dvb mode
> > everything nearly seems fine (only the OSD sometimes tends to show/leave
> > some horizontal pink lines when I move the selection.) Playing back an xvid
> > (720p) OSD show a lot of wrong colours, but the main problem is, I can only
> > see about 60% of the picture the rest of the right side is left black. Any
> > idea?
> 
> Uhm to be precise: I can only see 60% of the video. The OSD is shown full (but 
> wrongly coloured), IIRC.

For Xv-out there is an option to use the maximum available area:
-vo:xv:max-area

Do you use a nvidia card ?
Video colors are correct but only OSD colors wrong ?
Can you try to play around with the HUE value setting available in our OSD ?
Default value should be around 50, try 0 or 100. From vdr-portal I know
that should fix video colors. I don't know whats the influence for wrong
OSD colors only. Perhaps we need an option to exchange OSD u-v components.

-- 
Stefan Lucke


From M.Wache at gmx.net  Tue Jun 13 18:28:14 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 13 Jun 2006 18:28:14 +0200
Subject: [Softdevice-devel] [PATCH] fix for softplay
In-Reply-To: <200606122024.18568.prakash@punnoor.de>
References: <200606122024.18568.prakash@punnoor.de>
Message-ID: <448EE79E.40804@gmx.net>

Prakash Punnoor schrieb:
> Hi,
> 
> I needed following to get it compiled in gentoo with gcc 4.1.1 and 
> ffmpeg-0.4.9_p20060302. but it looks like a real bug to me, at least looking 
> at the ffmpeg header files. I have also modified Makefile for vdr 1.4.0, but 
> I saw that some patch already exists? Hth.
> 

Thank you for the patch, but a fix has been in the CVS for some time ;-)
The Makefile fix for vdr-1.4.0 is still missing, I haven't yet upgraded
to vdr-1.4.0.

Bye,
Martin


From M.Wache at gmx.net  Tue Jun 13 18:35:03 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 13 Jun 2006 18:35:03 +0200
Subject: [Softdevice-devel] softdevice/softplay clipping picture
In-Reply-To: <200606122032.40275.prakash@punnoor.de>
References: <200606122028.48526.prakash@punnoor.de> <200606122032.40275.prakash@punnoor.de>
Message-ID: <448EE937.6060900@gmx.net>

Prakash Punnoor schrieb:
> Am Montag Juni 12 2006 20:28 schrieb Prakash Punnoor:
>> I just installed softplay 0.0.2 slightly patched (see other post) with
>> gentoo's ffmpeg-0.4.9_p20060302 and softdevice 0.2.3 using XV. In dvb mode
>> everything nearly seems fine (only the OSD sometimes tends to show/leave
>> some horizontal pink lines when I move the selection.) Playing back an xvid
>> (720p) OSD show a lot of wrong colours, but the main problem is, I can only
>> see about 60% of the picture the rest of the right side is left black. Any
>> idea?
> 
> Uhm to be precise: I can only see 60% of the video. The OSD is shown full (but 
> wrongly coloured), IIRC.

Are you using software alpha blending mode? Which graphics card/drivers
are you using?
Can you please post the system logfile when you start to play the xvid?
There should be some messages with the src and dest size of the video,
it would be interresting what is reported by the softdevice, and of
course also what the actual dimensions of the stream are.

Bye,

Martin


From stefan at lucke.in-berlin.de  Wed Jun 14 00:19:07 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 14 Jun 2006 00:19:07 +0200
Subject: [Softdevice-devel] Re: [vdr] G450 softdevice
In-Reply-To: <20060610205227.GA3565@localhost.localdomain>
References: <20060601100133.9452.qmail@web86406.mail.ukl.yahoo.com> <200606100003.49618.stefan@lucke.in-berlin.de> <20060610205227.GA3565@localhost.localdomain>
Message-ID: <200606140019.07736.stefan@lucke.in-berlin.de>

On Samstag 10 Juni 2006 22:52, Marko M?kel? wrote:
> On Sat, Jun 10, 2006 at 12:03:49AM +0200, Stefan Lucke wrote:
> > On Freitag 09 Juni 2006 23:19, Marko M?kel? wrote:
> > > On Fri, Jun 09, 2006 at 11:30:05PM +0300, Marko M?kel? wrote:
> > > > Same binary on the 900 MHz Celeron:
> > > > 
> > > > delta1 = 353333
> > > > delta2 = 353249
> > > > delta3 = 366210
> > > > delta4 = 374806
> > > > delta5 = 283929

I've some quite different numbers for ny 1,2 GHz Celeron:

delta1 = 325940
delta2 = 321790
delta3 = 421976
delta4 = 128018
delta5 = 99039

These numbers are from softbench. The difference to real-life test is,
that softbench does _not_ write to video ram of graphic card.
But due to the fact that my numbers are bad for delta2 (more like the
plain C version, I'm on the way to do an other mmx-version.

> > > 
> > 
> > > 
> > > Is there anything you could do to speed up yv12_to_yuy2_il_mmx2_line()
> > > on a Celeron (Coppermine) stepping 10 with 128 KiB cache?
> > > 
> > > Could you at least avoid calling yv12_to_yuy2_il_*() when no vertical scaling
> > > takes place?
> > 
> > But delta4 corresponds to the default (old), frame based yuy2 converter and
> > is at the same speed ;-( . Is it a pitfall of benchmarking ?
> 
> Good point.  Perhaps yv12_to_yuy2_il_mmx2() wasn't slower than the old
> frame based converter after all.  Can you give a one-line patch for
> reverting to the old converter?  

Patch ? I think you can just comment out unneeded calls, or make the
same for interlaced/noninterlaced.

      if (interlaceMode) {
        //yv12_to_yuy2_fr_mmx2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
        // below the call that should be done for field based color conversion:
        yv12_to_yuy2_il_mmx2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
                             Pu + UVstride * cutTop + cutLeft,
                             Pv + UVstride * cutTop + cutLeft,
                             dst + pitch * cutTop * 2 + cutLeft * 4,
                             Width - 2 * (cutLeft + cutRight),
                             Height - 2 * (cutTop + cutBottom),
                             Ystride, UVstride, pitch);
      } else {
        //yv12_to_yuy2_il_mmx2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
        // below the call that should be done for frame based col conv:
        yv12_to_yuy2_fr_mmx2(Py + Ystride  * cutTop * 2 + cutLeft * 2,
                             Pu + UVstride * cutTop + cutLeft,
                             Pv + UVstride * cutTop + cutLeft,
                             dst + pitch * cutTop * 2 + cutLeft * 4,
                             Width - 2 * (cutLeft + cutRight),
                             Height - 2 * (cutTop + cutBottom),
                             Ystride, UVstride, pitch);
      }

> Then I could get accurate benchmarks. 
> Also, if I don't mind wrong colors, how could the converter be bypassed
> altogether?
> 
> Incrementing the loop count in softbench.c by a factor of 10 might give more
> accurate results.  But I'd rather run the benchmarks within vdr+softdevice,
> always playing back the same recording, and varying the converter method.
> 

-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Wed Jun 14 00:36:03 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 14 Jun 2006 00:36:03 +0200
Subject: [Softdevice-devel] Incorrect aspect ratio for some streams
In-Reply-To: <200606021012.43530.laz@club-burniston.co.uk>
References: <200606011544.01943.laz@club-burniston.co.uk> <1149237366.447ff8765855d@webmail.in-berlin.de> <200606021012.43530.laz@club-burniston.co.uk>
Message-ID: <200606140036.03105.stefan@lucke.in-berlin.de>

On Freitag 02 Juni 2006 11:12, Laz wrote:
> On Friday 02 Jun 2006 09:36, Stefan Lucke wrote:
> > Quoting Laz :
> > > On Friday 02 June 2006 06:08, Stefan Lucke wrote:
> > > > Which hardware do you use (radeon, matrox, via) ?
> > > > via OK.
> > > > radeon BAD.
> > > > matrox untested.
> >
> > My test were done with via-vga and radeon-vga. Nearly the
> > same softdevice cvs head version, with PicBuffer code.
> 
> I've just updated to current cvs on the Via system to see if that makes 
> any difference.
> 
> > > I've just done another couple of quick tests, both with dfb output:
> > >
> > > viatv: softdevice cvs from 15/05/06 (before the PicBuffer and
> > > VideoFilter stuff) patched for the OSD fix only; set to 16:9 aspect
> > > on a 16:9 TV, all cropping turned off:
> > > 	I get the sideways squashed image as I described.
> >
> > Whats does "squashed" mean in your case ?
> 
> It is a 4:3 picture transmitted with black borders at the left and right 
> to make it up to 16:9 frame size. With viatv output, it is being squashed 
> sideways into the size of a 4:3 frame (keeping the black borders), so 
> that the picture itself is squashed sideways.

Can you check your via chip revision number ?

From stefan at lucke.in-berlin.de  Wed Jun 14 00:41:36 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 14 Jun 2006 00:41:36 +0200
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <447B51B7.8070504@gmx.net>
References: <447B51B7.8070504@gmx.net>
Message-ID: <200606140041.37079.stefan@lucke.in-berlin.de>

On Montag 29 Mai 2006 21:55, Martin Wache wrote:
> Hi all,
> 
> since my last changes to the cvs Ralfs and Laz patches to enable the
> cle266 hw decoding in the softdevice any more. I adapted Ralf's latest
> patch to the cvs, and fixed a few things. I also made some other
> changes: I moved the colorspace back to the default and viatv is no
> longer enabled automatically.

RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.59
diff -u -r1.59 softdevice.c
--- softdevice.c        30 Apr 2006 13:50:12 -0000      1.59
+++ softdevice.c        29 May 2006 19:31:58 -0000
@@ -782,6 +782,12 @@
           else if (!strncmp (vo_argv, "viatv", 5)) {
             setupStore.viaTv = 1;
             fprintf(stderr,"[softdevice] enabling field parity\n");
+#ifdef HAVE_CLE266_MPEG_DECODER
+          } else if (!strncmp (vo_argv, "cle266", 6)) {
+            //setupStore.viaTv = 1;

This commented line may cause the noticed side effect of software blitting.
Code should be modified in a way that both option could be specified,
as some testers do TV-out (like LAZ and Rolf?) and some (like you and me) VGA-out.
-vo:dfb:viatv:cle266

+            setupStore.cle266HWdecode = 1;
+            fprintf(stderr,"[softdevice] enabling CLE266 HW decoding\n");
+#endif // HAVE_CLE266_MPEG_DECODER
           } else if (!strncmp (vo_argv, "triple", 6)) {
             setupStore.tripleBuffering = 1;
             fprintf(stderr,"[softdevice] enabling triple buffering\n");

> I also disabled the sync on horizontal refresh if mgaTV is not enabled,
> in my opinion it doesn't make sense to sync on the horizontal refresh
> when one doesn't know if the refresh rate is 50Hz/60Hz. 

RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.62
diff -u -r1.62 video-dfb.c
--- video-dfb.c 27 May 2006 19:12:41 -0000      1.62
+++ video-dfb.c 29 May 2006 19:32:02 -0000
@@ -501,7 +516,8 @@
? ? ? ? ? ? ? ?videoLayerDescription.name);
? ? ?}
?
- ? ?GetDisplayFrameTime();
+ ? ?if (setupStore->useMGAtv) 
+ ? ? ? ? ? ?GetDisplayFrameTime();
? ? ?/* create an event buffer with all devices attached */
? ? ?events = dfb->CreateInputEventBuffer(DICAPS_ALL,
? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? (setupStore->useMGAtv) ? DFB_TRUE : DFB_FALSE);

Are you referring to this hunk ?
It does not do any sync. It will cause the sleep/delay will be skipped,
if time to delay is lower than current display refresh rate.

It may lead to allways doing no delay, in case we get strange/false
measured times. But it does not introduce an extra delay.

> One can only be 
> sure for TV-out. What about viaTv? Should we enable it also for viaTV?
> Ah, and the main reason why I disabled it is because the a/v sync was
> totally messed up on my EPIA board with VGA-Monitor and sync on
> horizontal refresh enabled.

@@ -1454,8 +1485,8 @@
 #endif
 
       }
-      //scrSurface->Flip(NULL, (setupStore->useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
-      scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
+      scrSurface->Flip(NULL, (setupStore->useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
+      //scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
 
     }
     else

This hunk may cause effects you noticed. But this is a rather sensible change and
should be delayed until the software blit issue is resolved.

Software blit issue:
in video-dfb.c around line 493 there is a test for:
        if (!setupStore->viaTv)
          BESColorkeyState(videoLayer, true);
this should be replaced by:
        if (!isVIAUnichrome)
          BESColorkeyState(videoLayer, true);

When using normal dfb-out I've another strange effect: video is visible
only when OSD is active. To resolve this for me, I commented out
line 362 (      //clearAlpha = 0xff;) .

> With this patch, postprocessing should work with cle266 enabled (however
> it is painfully slow...) and softplay works :-)
> Still there is some work to be done. I want to get rid of the method
> GetMpegFb() which I temporarily introduced, instead I plan to move the
> fb management to PicBufferManager.
> 

-- 
Stefan Lucke


From leo at calidae.net  Wed Jun 14 12:27:32 2006
From: leo at calidae.net (=?ISO-8859-1?Q?Leo_M=E1rquez?=)
Date: Wed, 14 Jun 2006 12:27:32 +0200
Subject: [Softdevice-devel] witch softdevice output depending on hard and soft
Message-ID: <448FE494.5080908@calidae.net>

Hi,

I'm in the way of set different vdr clients based on softdevice and
streamdev-client.
Depending on each I have to decide witch softdevice output use.
For example, one client is a debian gnome desktop machine with a pci
express radeon X700.

The output of :

xdpyinfo |grep Video

Returns only XVideo. What is the best way to set that I want? I have
tried to set the xv option but when I start VDR with:

-P"softdevice -vo xv:"

It says me that softdevice is not compiled with xv support.
I have been checked the softdevice Makefile and XV_SUPPORT is set to 1
But I have noticed that when I execute in the softdevice dir the
./configure command with an option related to xv then the config.h and
config.mak don't change. For example if I execute ./config --disable-fb
I see config.h and config.mak updated.
But if I execute ./configure --disable-xv don't update anything. If
after that I execute again only ./configure anything changed again and
it must update to enable all the outputs again.

The other type of client I want set is a non x-window system based. I
have tried it with directfb without luck. The hardware is geoforce mx
4400 or 5500.

I know there is a lot of docs and I have readed a lot of them but I'm
confused about how to set the best output. I know that the fb output is
bad because cpu have a lot of work. At the moment the fb output is the
only way softdevice worked to me.
I understand that xvmc or directfb is the best way but I don't know
exactly how to set up these.

Thanks.




From prakash at punnoor.de  Wed Jun 14 17:01:03 2006
From: prakash at punnoor.de (Prakash Punnoor)
Date: Wed, 14 Jun 2006 17:01:03 +0200
Subject: [Softdevice-devel] softdevice/softplay clipping picture
In-Reply-To: <448EE937.6060900@gmx.net>
References: <200606122028.48526.prakash@punnoor.de> <200606122032.40275.prakash@punnoor.de> <448EE937.6060900@gmx.net>
Message-ID: <200606141701.04031.prakash@punnoor.de>

Am Dienstag Juni 13 2006 18:35 schrieb Martin Wache:
> Prakash Punnoor schrieb:
> > Am Montag Juni 12 2006 20:28 schrieb Prakash Punnoor:
> >> I just installed softplay 0.0.2 slightly patched (see other post) with
> >> gentoo's ffmpeg-0.4.9_p20060302 and softdevice 0.2.3 using XV. In dvb
> >> mode everything nearly seems fine (only the OSD sometimes tends to
> >> show/leave some horizontal pink lines when I move the selection.)
> >> Playing back an xvid (720p) OSD show a lot of wrong colours, but the
> >> main problem is, I can only see about 60% of the picture the rest of the
> >> right side is left black. Any idea?
> >
> > Uhm to be precise: I can only see 60% of the video. The OSD is shown full
> > (but wrongly coloured), IIRC.
>

Hi Stefan, hi Martin. I couldn't test earlier, so here the infos you 
requested:

> For Xv-out there is an option to use the maximum available area:
> -vo:xv:max-area

Tried, no difference, or rather softdevice doesn't know it:
Jun 14 16:44:02 inter vdr: [1764] [softdevice] ignoring unrecognized 
option "-vo:xv:max-area"
>
> Do you use a nvidia card ?

Yes, Geforce 6600.

> Video colors are correct but only OSD colors wrong ?

Yes - but only using softplay.

> Can you try to play around with the HUE value setting available in our OSD

Actually I don't know where to find this setting. :-)



> Are you using software alpha blending mode?

Yes, the other one makes OSD disappear.

> Which graphics card/drivers 
> are you using?

...w/ Nvidia binary driver 8762 (nv is no good for HD content...)

> Can you please post the system logfile when you start to play the xvid?
> There should be some messages with the src and dest size of the video,
> it would be interresting what is reported by the softdevice, and of
> course also what the actual dimensions of the stream are.

Following the log. Before start a dvb channel was tuned in. Then I played the 
stream in 16:9 mode, then stopped it, set aspect to 5:4 and tried again. both 
time a lot of pic is missing. If I try to play a real 720p file, even less is 
shown and the pic isn't centered anymore It gets moved to left/up. Following 
stream is properly centered, just the right side is missing.

Jun 14 16:44:02 inter vdr: [1764] [XvVideoOut]: patch version (2006-04-24)
Jun 14 16:44:02 inter vdr: [1764] [XvVideoOut]: Initialize XShmCreateImage 
Successful (0x8438a68)
Jun 14 16:44:02 inter vdr: [1764] [XvVideoOut]: Initialize shmget Successful 
(2949120 bytes)
Jun 14 16:44:02 inter vdr: [1764] [XvVideoOut]: Initialize shmat Successful
Jun 14 16:44:02 inter vdr: [1764] [softdevice-xscreensaver]: xscreensaver not 
running
Jun 14 16:44:02 inter vdr: [1764] [XvVideoOut]: initialized OK
Jun 14 16:44:02 inter vdr: [1764] [XvVideoOut]: NV17 Video Texture: available 
ports 274 - 274
Jun 14 16:44:02 inter vdr: [1764] [XvVideoOut]: grabbed port 274
Jun 14 16:44:02 inter vdr: [1764] [XvVideoOut]: max area size 2046 x 2046
Jun 14 16:44:02 inter vdr: [1764] [XvVideoOut]: using area size 736 x 576
Jun 14 16:44:02 inter vdr: [1764] [XvVideoOut]:   XV_SET_DEFAULTS           
NOT-XvGettable     XvSettable (       0 [0x00000000] -        0 [0x00000000]) 
(       0 [0x00000000]
Jun 14 16:44:02 inter vdr: [1764] [XvVideoOut]:   XV_ITURBT_709                 
XvGettable     XvSettable (       0 [0x00000000] -        1 [0x00000001]) (       
0 [0x00000000]
Jun 14 16:44:02 inter vdr: [1764] [XvVideoOut]:   XV_SYNC_TO_VBLANK             
XvGettable     XvSettable (       0 [0x00000000] -        1 [0x00000001]) (       
1 [0x00000001]
Jun 14 16:44:02 inter vdr: [1764] [XvVideoOut]: XvShmCreateImage Successful 
(0x84398e0)
Jun 14 16:44:02 inter vdr: [1764] [XvVideoOut]: shmget Successful (0 bytes)
Jun 14 16:44:02 inter vdr: [1764] [XvVideoOut]: shmat Successful
Jun 14 16:44:02 inter vdr: [1764] [XvVideoOut]: XShmAttach    rc = 1 (should 
be OK)
Jun 14 16:44:02 inter vdr: [1764] [softdevice] videoOut OK !
Jun 14 16:44:02 inter vdr: [1764] [softdevice-audio] Opening alsa device 
default
Jun 14 16:44:02 inter vdr: [1764] [softdevice-audio] Using alsa AC3 device 
iec958:AES0=0x2,AES1=0x82,AES2=0x0,AES3=0x2
Jun 14 16:44:02 inter vdr: [1770] [VideoOut]: 736x576 [0,0 736x576] -> 
1024x768 [143,0 738x768]
Jun 14 16:44:02 inter vdr: [1770] [VideoOut]: 736x576 [0,0 736x576] -> 
1024x768 [143,0 738x768]
Jun 14 16:44:03 inter vdr: [1764] [softdevice-audio] Device opened! Ready to 
play
Jun 14 16:44:03 inter vdr: [1764] initializing plugin: femon (1.0.0): DVB 
Signal Information Monitor (OSD)
Jun 14 16:44:03 inter vdr: [1764] setting primary device to 2
Jun 14 16:44:03 inter vdr: [1764] SVDRP listening on port 2001

[...]

Jun 14 16:44:04 inter vdr: [1779] transfer thread started (pid=1764, tid=1779)
Jun 14 16:44:04 inter vdr: [1780] receiver on device 1 thread started 
(pid=1764, tid=1780)
Jun 14 16:44:04 inter vdr: [1781] TS buffer on device 1 thread started 
(pid=1764, tid=1781)
Jun 14 16:44:04 inter vdr: [1779] setting audio track to 1 (0)
Jun 14 16:44:05 inter vdr: [1783] [VideoOut]: resolution changed: W(736 -> 
480); H(576 ->576)
Jun 14 16:44:05 inter vdr: [1783] [VideoOut]: aspect changed (0 -> 0 ; 
1.366667 -> 1.333333)
Jun 14 16:44:05 inter vdr: [1783] [VideoOut]: 480x576 [0,0 480x576] -> 
1024x768 [152,0 720x768]
Jun 14 16:44:05 inter vdr: [1784] [softdevice-audio] samplerate: 48000Hz, 
channels: #2
Jun 14 16:44:05 inter vdr: [1784] [softdevice-audio] Period size 1152 Buffer 
size 9216
Jun 14 16:44:05 inter vdr: [1784] [softdevice-audio] Hardware initialized

Jun 14 16:44:15 inter vdr: [1779] transfer thread ended (pid=1764, tid=1779)
Jun 14 16:44:16 inter vdr: [1781] TS buffer on device 1 thread ended 
(pid=1764, tid=1781)
Jun 14 16:44:16 inter vdr: [1780] buffer stats: 30268 (1%) used
Jun 14 16:44:16 inter vdr: [1780] receiver on device 1 thread ended (pid=1764, 
tid=1780)
Jun 14 16:44:16 inter vdr: [1764] buffer stats: 72568 (3%) used
Jun 14 16:44:16 inter vdr: [1789] [VideoOut]: resolution changed: W(480 -> 
960); H(576 ->544)
Jun 14 16:44:16 inter vdr: [1789] [VideoOut]: aspect changed (0 -> 0 ; 
1.333333 -> 1.764706)
Jun 14 16:44:16 inter vdr: [1789] [VideoOut]: 960x544 [0,0 960x544] -> 
1024x768 [35,0 953x768]

Jun 14 16:44:28 inter vdr: [1764] switching to channel 32
Jun 14 16:44:28 inter vdr: [1792] transfer thread started (pid=1764, tid=1792)
Jun 14 16:44:28 inter vdr: [1793] receiver on device 1 thread started 
(pid=1764, tid=1793)
Jun 14 16:44:28 inter vdr: [1794] TS buffer on device 1 thread started 
(pid=1764, tid=1794)
Jun 14 16:44:30 inter vdr: [1796] [VideoOut]: resolution changed: W(960 -> 
480); H(544 ->576)
Jun 14 16:44:30 inter vdr: [1796] [VideoOut]: aspect changed (0 -> 0 ; 
1.764706 -> 1.333333)
Jun 14 16:44:30 inter vdr: [1796] [VideoOut]: 480x576 [0,0 480x576] -> 
1024x768 [152,0 720x768]
Jun 14 16:44:30 inter vdr: [1792] setting audio track to 1 (0)
Jun 14 16:44:30 inter vdr: [1797] [softdevice-audio] samplerate: 48000Hz, 
channels: #2
Jun 14 16:44:30 inter vdr: [1797] [softdevice-audio] Period size 1152 Buffer 
size 9216
Jun 14 16:44:30 inter vdr: [1797] [softdevice-audio] Hardware initialized
Jun 14 16:44:32 inter vdr: [1764] softdevice: no translation found 
for 'Softdevice' in language 1 (Deutsch)
Jun 14 16:44:32 inter vdr: [1764] femon: no translation found for 'Signal 
Information' in language 1 (Deutsch)
Jun 14 16:44:39 inter vdr: [1797] [softdevice-audio]: xrun

[...]

Jun 14 16:44:43 inter vdr: [1796] [VideoOut]: 480x576 [0,0 480x576] -> 
1024x768 [112,0 800x768]
Jun 14 16:44:45 inter vdr: [1796] [VideoOut]: 480x576 [0,0 480x576] -> 
1024x768 [152,0 720x768]
Jun 14 16:44:45 inter vdr: [1796] [VideoOut]: 480x576 [0,0 480x576] -> 
1024x768 [32,0 960x768]
Jun 14 16:44:45 inter vdr: [1796] [VideoOut]: 480x576 [0,0 480x576] -> 
1024x768 [0,0 1024x768]
Jun 14 16:44:47 inter vdr: [1764] softdevice: no translation found 
for 'Cropping' in language 1 (Deutsch)
Jun 14 16:44:47 inter vdr: [1764] softdevice: no translation found for 'Post 
processing' in language 1 (Deutsch)
Jun 14 16:44:47 inter vdr: [1764] softdevice: no translation found for 'Video 
out' in language 1 (Deutsch)
Jun 14 16:44:50 inter vdr: [1792] transfer thread ended (pid=1764, tid=1792)
Jun 14 16:44:50 inter vdr: [1794] TS buffer on device 1 thread ended 
(pid=1764, tid=1794)
Jun 14 16:44:50 inter vdr: [1793] buffer stats: 46436 (2%) used
Jun 14 16:44:50 inter vdr: [1793] receiver on device 1 thread ended (pid=1764, 
tid=1793)
Jun 14 16:44:50 inter vdr: [1764] buffer stats: 92872 (4%) used
Jun 14 16:44:50 inter vdr: [1802] [VideoOut]: resolution changed: W(480 -> 
960); H(576 ->544)
Jun 14 16:44:50 inter vdr: [1802] [VideoOut]: aspect changed (0 -> 0 ; 
1.333333 -> 1.764706)
Jun 14 16:44:50 inter vdr: [1802] [VideoOut]: 960x544 [0,0 960x544] -> 
1024x768 [0,94 1024x580]
Jun 14 16:44:56 inter vdr: [1764] softdevice: no translation found 
for 'Softdevice' in language 1 (Deutsch)
Jun 14 16:44:56 inter vdr: [1764] femon: no translation found for 'Signal 
Information' in language 1 (Deutsch)
Jun 14 16:44:58 inter vdr: [1764] switching to channel 32
Jun 14 16:44:58 inter vdr: [1804] transfer thread started (pid=1764, tid=1804)
Jun 14 16:44:58 inter vdr: [1805] receiver on device 1 thread started 
(pid=1764, tid=1805)
Jun 14 16:44:58 inter vdr: [1806] TS buffer on device 1 thread started 
(pid=1764, tid=1806)
Jun 14 16:45:00 inter vdr: [1808] [VideoOut]: resolution changed: W(960 -> 
480); H(544 ->576)
Jun 14 16:45:00 inter vdr: [1808] [VideoOut]: aspect changed (0 -> 0 ; 
1.764706 -> 1.333333)
Jun 14 16:45:00 inter vdr: [1808] [VideoOut]: 480x576 [0,0 480x576] -> 
1024x768 [0,0 1024x768]
Jun 14 16:45:00 inter vdr: [1804] setting audio track to 1 (0)
Jun 14 16:45:00 inter vdr: [1809] [softdevice-audio] samplerate: 48000Hz, 
channels: #2
Jun 14 16:45:00 inter vdr: [1809] [softdevice-audio] Period size 1152 Buffer 
size 9216
Jun 14 16:45:00 inter vdr: [1809] [softdevice-audio] Hardware initialized
Jun 14 16:45:03 inter vdr: [1809] [softdevice-audio]: xrun


-- 
(?=                 =?)
//\ Prakash Punnoor /\\
V_/                 \_V
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060614/ac967a7a/attachment.pgp>

From prakash at punnoor.de  Wed Jun 14 17:08:35 2006
From: prakash at punnoor.de (Prakash Punnoor)
Date: Wed, 14 Jun 2006 17:08:35 +0200
Subject: [Softdevice-devel] [PATCH] fix for softplay
In-Reply-To: <448EE79E.40804@gmx.net>
References: <200606122024.18568.prakash@punnoor.de> <448EE79E.40804@gmx.net>
Message-ID: <200606141708.35706.prakash@punnoor.de>

Am Dienstag Juni 13 2006 18:28 schrieb Martin Wache:

> Thank you for the patch, but a fix has been in the CVS for some time ;-)
> The Makefile fix for vdr-1.4.0 is still missing, I haven't yet upgraded
> to vdr-1.4.0.

What about making a new release for vdr 1.4.x then? :-)
-- 
(?=                 =?)
//\ Prakash Punnoor /\\
V_/                 \_V
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060614/416415f7/attachment.pgp>

From M.Wache at gmx.net  Wed Jun 14 19:17:11 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Wed, 14 Jun 2006 19:17:11 +0200
Subject: [Softdevice-devel] witch softdevice output depending on hard
 and soft
In-Reply-To: <448FE494.5080908@calidae.net>
References: <448FE494.5080908@calidae.net>
Message-ID: <44904497.5020301@gmx.net>

Leo M?rquez schrieb:

> It says me that softdevice is not compiled with xv support.
> I have been checked the softdevice Makefile and XV_SUPPORT is set to 1
> But I have noticed that when I execute in the softdevice dir the
> ./configure command with an option related to xv then the config.h and
> config.mak don't change. For example if I execute ./config --disable-fb
> I see config.h and config.mak updated.
> But if I execute ./configure --disable-xv don't update anything. If
> after that I execute again only ./configure anything changed again and
> it must update to enable all the outputs again.
> 
Do you have the x-development headers installed?

> The other type of client I want set is a non x-window system based. I
> have tried it with directfb without luck. The hardware is geoforce mx
> 4400 or 5500.
> 
I'm not sure how good the support for gforce graphics cards is in
DirectFB. I would suggest you to by a old, cheap and well supported
graphics card if you want to use Directfb.


> I know there is a lot of docs and I have readed a lot of them but I'm
> confused about how to set the best output. I know that the fb output is
> bad because cpu have a lot of work. At the moment the fb output is the
> only way softdevice worked to me.
> I understand that xvmc or directfb is the best way but I don't know
> exactly how to set up these.
> 
Xvmc is currently not supported by the softdevice. DirectFB is certainly
the best way if you want to avoid X. For directFB you need a framebuffer
driver for your graphics card which enables hardware acceleration (like
atyfb for Mach64, aty128fb for Mach128, viafb for via-cle266...). Get
and compile DirectFB and DFB++, set up /etc/directfbrc (examples are on
the softdevice hompage) compile the softdevice with directfb support,
and you should be ready to go.

Bye,

Martin


From prakash at punnoor.de  Wed Jun 14 19:17:37 2006
From: prakash at punnoor.de (Prakash Punnoor)
Date: Wed, 14 Jun 2006 19:17:37 +0200
Subject: [Softdevice-devel] softdevice/softplay clipping picture
In-Reply-To: <200606130723.04401.stefan@lucke.in-berlin.de>
References: <200606122028.48526.prakash@punnoor.de> <200606122032.40275.prakash@punnoor.de> <200606130723.04401.stefan@lucke.in-berlin.de>
Message-ID: <200606141917.37589.prakash@punnoor.de>

Am Dienstag Juni 13 2006 07:23 schrieb Stefan Lucke:
> On Montag 12 Juni 2006 20:32, Prakash Punnoor wrote:
> > Am Montag Juni 12 2006 20:28 schrieb Prakash Punnoor:
> > > I just installed softplay 0.0.2 slightly patched (see other post) with
> > > gentoo's ffmpeg-0.4.9_p20060302 and softdevice 0.2.3 using XV. In dvb
> > > mode everything nearly seems fine (only the OSD sometimes tends to
> > > show/leave some horizontal pink lines when I move the selection.)
> > > Playing back an xvid (720p) OSD show a lot of wrong colours, but the
> > > main problem is, I can only see about 60% of the picture the rest of
> > > the right side is left black. Any idea?
> >
> > Uhm to be precise: I can only see 60% of the video. The OSD is shown full
> > (but wrongly coloured), IIRC.
>
> For Xv-out there is an option to use the maximum available area:
> -vo:xv:max-area

Ok, I figured out it should be -vo xv:max.area and YES it works then as 
expected. :-)) just the OSD is seriously messed up. Setting it to pseudo I 
can see it is OK, but vanishes very quickly. I tried to uncomment the MMX 
defines in the Makefile, but it didn't help. Ideas? Anyway, I am happy that I 
can play back my xvids via vdr now. :-))


BTW, did you guys ever try to run softdevice/softplay through valgrind? There 
seem to be issues, eg. this should probably (I don't know code enough) be in 
softdevice (though it probably isn't critical):
--- video.c.old 2006-06-14 19:10:28.000000000 +0200
+++ video.c     2006-06-14 18:57:42.000000000 +0200
@@ -35,6 +35,7 @@
   old_width = fwidth = lwidth = old_dwidth = dwidth = swidth = 720;
   old_height = fheight = lheight = old_dheight = dheight = sheight = 536;
   sxoff = syoff = lxoff = lyoff = 0;
+  flags = 0;
   cutTop = cutBottom = cutLeft = cutRight = 0;
   OsdPy = OsdPu = OsdPv = OsdPAlphaY = OsdPAlphaUV = NULL;
   Osd_changed = 0;
@@ -44,6 +45,10 @@
   interlaceMode = -1;
   prevZoomFactor = 0;
   realZoomFactor = 1.0;
+  zoomCenterX = 0;
+  zoomCenterY = 0;
+  expandTopBottom = 0;
+  expandLeftRight = 0;
   PixelMask=NULL;
   OsdRefreshCounter=0;
   displayTimeUS = 0;

Cheers,
-- 
(?=                 =?)
//\ Prakash Punnoor /\\
V_/                 \_V
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060614/eaca9732/attachment.pgp>

From M.Wache at gmx.net  Wed Jun 14 19:18:08 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Wed, 14 Jun 2006 19:18:08 +0200
Subject: [Softdevice-devel] [PATCH] fix for softplay
In-Reply-To: <200606141708.35706.prakash@punnoor.de>
References: <200606122024.18568.prakash@punnoor.de> <448EE79E.40804@gmx.net> <200606141708.35706.prakash@punnoor.de>
Message-ID: <449044D0.9090102@gmx.net>

Prakash Punnoor schrieb:
> Am Dienstag Juni 13 2006 18:28 schrieb Martin Wache:
> 
>> Thank you for the patch, but a fix has been in the CVS for some time ;-)
>> The Makefile fix for vdr-1.4.0 is still missing, I haven't yet upgraded
>> to vdr-1.4.0.
> 
> What about making a new release for vdr 1.4.x then? :-)

Yes, I guess there should be a new release soon. But not this weekend,
and I'm not sure about the next... Sorry I'm quite busy lately.

Bye,
Martin


From M.Wache at gmx.net  Wed Jun 14 19:27:34 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Wed, 14 Jun 2006 19:27:34 +0200
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <200606140041.37079.stefan@lucke.in-berlin.de>
References: <447B51B7.8070504@gmx.net> <200606140041.37079.stefan@lucke.in-berlin.de>
Message-ID: <44904706.5010707@gmx.net>

Stefan Lucke schrieb:
> On Montag 29 Mai 2006 21:55, Martin Wache wrote:
>> Hi all,
>>
>> since my last changes to the cvs Ralfs and Laz patches to enable the
>> cle266 hw decoding in the softdevice any more. I adapted Ralf's latest
>> patch to the cvs, and fixed a few things. I also made some other
>> changes: I moved the colorspace back to the default and viatv is no
>> longer enabled automatically.
> 
> RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
> retrieving revision 1.59
> diff -u -r1.59 softdevice.c
> --- softdevice.c        30 Apr 2006 13:50:12 -0000      1.59
> +++ softdevice.c        29 May 2006 19:31:58 -0000
> @@ -782,6 +782,12 @@
>            else if (!strncmp (vo_argv, "viatv", 5)) {
>              setupStore.viaTv = 1;
>              fprintf(stderr,"[softdevice] enabling field parity\n");
> +#ifdef HAVE_CLE266_MPEG_DECODER
> +          } else if (!strncmp (vo_argv, "cle266", 6)) {
> +            //setupStore.viaTv = 1;
> 
> This commented line may cause the noticed side effect of software blitting.
Yes, I thought this too. However, I also saw the difference on my system
and I always had viaTv disabled. I don't have a TV ;-)

> Code should be modified in a way that both option could be specified,
> as some testers do TV-out (like LAZ and Rolf?) and some (like you and me) VGA-out.
> -vo:dfb:viatv:cle266
> 
Can't you now do this?


> -    GetDisplayFrameTime();
> +    if (setupStore->useMGAtv) 
> +            GetDisplayFrameTime();
>      /* create an event buffer with all devices attached */
>      events = dfb->CreateInputEventBuffer(DICAPS_ALL,
>                                           (setupStore->useMGAtv) ? DFB_TRUE : DFB_FALSE);
> 
> Are you referring to this hunk ?
> It does not do any sync. It will cause the sleep/delay will be skipped,
> if time to delay is lower than current display refresh rate.
> 
> It may lead to allways doing no delay, in case we get strange/false
> measured times. But it does not introduce an extra delay.
> 
That's true. However to have good A/V sync I need both hunk, this and
the one below. I didn't check yet what the reason is...

>> One can only be 
>> sure for TV-out. What about viaTv? Should we enable it also for viaTV?
>> Ah, and the main reason why I disabled it is because the a/v sync was
>> totally messed up on my EPIA board with VGA-Monitor and sync on
>> horizontal refresh enabled.
> 
> @@ -1454,8 +1485,8 @@
>  #endif
>  
>        }
> -      //scrSurface->Flip(NULL, (setupStore->useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
> -      scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
> +      scrSurface->Flip(NULL, (setupStore->useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
> +      //scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
>  
>      }
>      else
> 
> This hunk may cause effects you noticed. But this is a rather sensible change and
> should be delayed until the software blit issue is resolved.
> 
I don't mind..

> Software blit issue:
> in video-dfb.c around line 493 there is a test for:
>         if (!setupStore->viaTv)
>           BESColorkeyState(videoLayer, true);
> this should be replaced by:
>         if (!isVIAUnichrome)
>           BESColorkeyState(videoLayer, true);
> 
> When using normal dfb-out I've another strange effect: video is visible
> only when OSD is active. To resolve this for me, I commented out
> line 362 (      //clearAlpha = 0xff;) .
>
I had a similar effect, but only after you fixed the alpha blending. It
disappeared when I explicitly specified ARGB colorspace in the
/etc/directfbrc.


It would be nice if you could have a closer look at these issues, I'm a
bit short on time...
I also thought about a method how we could get rid of the blit
completely, but this would require patching direcfb quite a bit. We
would need quadruple buffering for the video surface, and we could set
up the hardware decoder to decode directly into the four buffers. And we
 would also need a method to flip to one explicit buffer of the four
buffers. No extra copying required :-)

Bye,
Martin


From marko.makela at hut.fi  Wed Jun 14 21:07:30 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 14 Jun 2006 22:07:30 +0300
Subject: [Softdevice-devel] Re: [vdr] G450 softdevice
In-Reply-To: <200606140019.07736.stefan@lucke.in-berlin.de>
References: <20060601100133.9452.qmail@web86406.mail.ukl.yahoo.com> <200606100003.49618.stefan@lucke.in-berlin.de> <20060610205227.GA3565@localhost.localdomain> <200606140019.07736.stefan@lucke.in-berlin.de>
Message-ID: <20060614190730.GA3578@localhost.localdomain>

On Wed, Jun 14, 2006 at 12:19:07AM +0200, Stefan Lucke wrote:
> > > > > Same binary on the 900 MHz Celeron:
> > > > > 
> > > > > delta1 = 353333
> > > > > delta2 = 353249
> > > > > delta3 = 366210
> > > > > delta4 = 374806
> > > > > delta5 = 283929
> 
> I've some quite different numbers for ny 1,2 GHz Celeron:
> 
> delta1 = 325940
> delta2 = 321790
> delta3 = 421976
> delta4 = 128018
> delta5 = 99039
> 
> These numbers are from softbench. The difference to real-life test is,
> that softbench does _not_ write to video ram of graphic card.

My numbers were from softbench as well.  Only the OProfile results were
from vdr+softdevice.

> But due to the fact that my numbers are bad for delta2 (more like the
> plain C version, I'm on the way to do an other mmx-version.

Thanks! If you can make it work well on your Celeron, I guess it should
work for me as well.

> Patch ? I think you can just comment out unneeded calls, or make the
> same for interlaced/noninterlaced.

Thanks, that's what I wanted to know.  But I'll wait for your new MMX
version before making any new measurements.

	Marko


From rahrenbe at cc.hut.fi  Wed Jun 14 21:33:08 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Wed, 14 Jun 2006 22:33:08 +0300 (EEST)
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <44904706.5010707@gmx.net>
References: <447B51B7.8070504@gmx.net> <200606140041.37079.stefan@lucke.in-berlin.de>
 <44904706.5010707@gmx.net>
Message-ID: <Pine.OSF.4.61.0606142228120.334744@kosh.hut.fi>

On Wed, 14 Jun 2006, Martin Wache wrote:

> It would be nice if you could have a closer look at these issues, I'm a
> bit short on time...

Well, I've attached a patch from my softdevice tree that really enables 
the cle266 hw decoding (-vo dfb:viatv:cle266). Now the cpu load is again 
down to ~30% (was ~55%) on my 1GHz EPIA.

BR,
--
rofa
-------------- next part --------------
Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.30
diff -u -r1.30 Makefile
--- Makefile	9 Jun 2006 16:45:13 -0000	1.30
+++ Makefile	14 Jun 2006 19:27:05 -0000
@@ -148,6 +148,12 @@
   DEFINES  += -DDFB_SUPPORT
 endif
 
+ifdef CLE266_SUPPORT
+  CLE266_LIBS = -L/usr/local/lib -lcle266mpegdec
+  CLE266_CFLAGS = -I/usr/local/include
+  DEFINES  += -DHAVE_CLE266_MPEG_DECODER
+endif
+
 ifdef XV_SUPPORT
   XV_LIBS   = -L/usr/X11R6/lib -lXi -lXext -lX11 -lm -lXv
   ifdef LIBXDPMS_SUPPORT
@@ -229,12 +235,13 @@
   ifdef USE_SUBPLUGINS
     DFB_OBJS  = utils.o video.o video-dfb.o PicBuffer.o
     ALL_OBJS += $(DFB_OBJS)
+    LIBS     += $(CLE266_LIBS)
     TARGETS  += lib$(PLUGIN)-dfb.so
   else
     OBJS     += video-dfb.o
-    LIBS     += $(DFB_LIBS)
+    LIBS     += $(DFB_LIBS) $(CLE266_LIBS)
   endif
-  INCLUDES += $(DFB_CFLAGS)
+  INCLUDES += $(DFB_CFLAGS) $(CLE266_CFLAGS)
 endif
 
 ifdef FB_SUPPORT
Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.15
diff -u -r1.15 configure
--- configure	27 May 2006 13:00:07 -0000	1.15
+++ configure	14 Jun 2006 19:27:05 -0000
@@ -35,6 +35,7 @@
 with_subplugins="yes"
 with_mmx="yes"
 with_mmx2="yes"
+cle266="yes"
 
 function help () {
   echo "Usage: configure [options]"
@@ -239,6 +240,19 @@
 fi
 
 #########################################################
+# cle266mpegdec: check if present
+#
+if test "${dfb}" = "yes" ; then
+cle266_cflags=`pkg-config --cflags libcle266mpegdec 2>/dev/null` || cle266="no"
+  if test "${cle266}" = "yes" ; then
+  cle266_libs=`pkg-config --libs libcle266mpegdec`
+  cle266_opts="${cle266_cflags} ${cle266_libs}"
+  fi
+else
+  cle266="no"
+fi
+
+#########################################################
 # X11: check if X11 is present
 #
 if test "${xv}" = "yes" ; then
@@ -378,6 +392,14 @@
   else
     echo "#define HAVE_DSBLIT_INTERLACED          0" >> $TMPH
   fi
+fi
+
+###############################################################################
+# generating DirectFB specific defines
+#
+if test "${cle266}" = "yes" ; then
+  echo "CLE266_LIBS = ${cle266_libs}" >> $TMPM
+  echo "CLE266_CFLAGS = -DHAVE_CLE266_MPEG_DECODER ${cle266_cflags}" >> $TMPM
 fi
 
 ###############################################################################
Index: mpeg2decoder.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.c,v
retrieving revision 1.64
diff -u -r1.64 mpeg2decoder.c
--- mpeg2decoder.c	27 May 2006 19:12:41 -0000	1.64
+++ mpeg2decoder.c	14 Jun 2006 19:27:05 -0000
@@ -16,6 +16,9 @@
 #include "utils.h"
 #include "setup-softdevice.h"
 
+#ifdef HAVE_CLE266_MPEG_DECODER
+#include <cle266mpegdec.h>
+#endif // HAVE_CLE266_MPEG_DECODER
 
 //#define MPGDEB(out...) {printf("mpegdec[%04d]:",(int)(getTimeMilis() % 10000));printf(out);}
 
@@ -717,6 +720,8 @@
   // save the picture's properties
 #if LIBAVCODEC_BUILD > 4684
   pic->interlaced_frame=picture->interlaced_frame;
+#else
+  pic->interlaced_frame=true;
 #endif
   pic->width=context->width;
   pic->height=context->height;
@@ -751,6 +756,54 @@
   return len;
 };
 
+#ifdef HAVE_CLE266_MPEG_DECODER
+float aspect_ratio_values[5]={1.0, 1.0, 4.0/3.0, 16.0/9.0, 221.0/110 };
+
+int cVideoStreamDecoder::DecodePicture_cle266(sPicBuffer *&pic, int &got_picture,
+                              uint8_t *data, int length, int64_t pkt_pts) {
+        int cle266len = length;
+        int64_t cle266pts = pkt_pts;
+        int cle266CurrentFB;
+        int len;
+        got_picture=0;
+	pic = NULL;
+        
+        /* Do HW decode!
+         * Hopefully sets len to number of bytes decoded!
+         * Returns number of buffer containing decoded frame
+         */
+        cle266CurrentFB = CLE266MPEGDecodeData(data, &cle266len, 
+                        &cle266pts);
+        len = cle266len;
+        
+        if ( cle266CurrentFB == -1 ) 
+                // no new picture
+                return len;
+        
+        got_picture = 1;
+        pic = videoOut->GetMpegfbPic(cle266CurrentFB);
+        if ( pic == NULL ) {
+                fprintf(stderr,"No picture buffer returned from cle266! %d\n",
+				cle266CurrentFB);
+		fflush(stderr);
+                return len;
+        };
+        
+        cle266_decoder_state_t decoder = CLE266MPEGGetDecoderState();
+        /* Fill up the necessary AVCodecContext information */
+        pic->width = decoder.width;
+        pic->height = decoder.height;
+        pic->pts = cle266pts;
+	pic->edge_width=pic->edge_height=0;
+        pic->dtg_active_format = 0; // currently not parsed
+        pic->interlaced_frame = true; // FIXME Do we have that information?
+	pic->aspect_ratio = (decoder.aspect_ratio_info >= 0 && decoder.aspect_ratio_info <5) ?
+		aspect_ratio_values[decoder.aspect_ratio_info] : 1.0;
+	
+        return len;
+}
+#endif // HAVE_CLE266_MPEG_DECODER
+
 int cVideoStreamDecoder::DecodePacket(AVPacket *pkt)
 {
   int len=0;
@@ -763,8 +816,14 @@
   while ( size > 0 ) {
     BUFDEB("start decode video stream %d data: %p size: %d \n",
         pkt->stream_index,data,size);
-    len = DecodePicture_avcodec(pic, got_picture,
-                                data, size, pkt->pts)
+#ifdef HAVE_CLE266_MPEG_DECODER
+    if (setupStore.cle266HWdecode && context->codec_id == CODEC_ID_MPEG2VIDEO)
+            len = DecodePicture_cle266(pic, got_picture,
+                                data, size, pkt->pts);
+    else
+#endif //HAVE_CLE266_MPEG_DECODER
+            len = DecodePicture_avcodec(pic, got_picture,
+                                data, size, pkt->pts);
       //avcodec_decode_video(context, picture, &got_picture,data, size);
     BUFDEB("end decode video got_picture %d, data %p, size %d\n",
         got_picture,data,size);
Index: mpeg2decoder.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/mpeg2decoder.h,v
retrieving revision 1.37
diff -u -r1.37 mpeg2decoder.h
--- mpeg2decoder.h	27 May 2006 19:12:41 -0000	1.37
+++ mpeg2decoder.h	14 Jun 2006 19:27:05 -0000
@@ -252,6 +252,10 @@
 
     int DecodePicture_avcodec(sPicBuffer *&pic, int &got_picture,
                               uint8_t *data, int length, int64_t pts);
+#ifdef HAVE_CLE266_MPEG_DECODER
+    int DecodePicture_cle266(sPicBuffer *&pic, int &got_picture,
+                              uint8_t *data, int length, int64_t pts);
+#endif //HAVE_CLE266_MPEG_DECODER
     virtual void      Freeze(bool freeze=true);
     virtual void      Play(void);
     virtual int DecodePacket(AVPacket *pkt);
Index: setup-softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.c,v
retrieving revision 1.43
diff -u -r1.43 setup-softdevice.c
--- setup-softdevice.c	23 May 2006 21:11:37 -0000	1.43
+++ setup-softdevice.c	14 Jun 2006 19:27:06 -0000
@@ -109,6 +109,9 @@
   ac3Mode       = 0;
   useMGAtv      = 0;
   viaTv         = 0;
+#ifdef HAVE_CLE266_MPEG_DECODER
+  cle266HWdecode  = 0;
+#endif // HAVE_CLE266_MPEG_DECODER
   tripleBuffering = 0;
   useStretchBlit  = 0;
   bufferMode      = 0;
Index: setup-softdevice.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/setup-softdevice.h,v
retrieving revision 1.30
diff -u -r1.30 setup-softdevice.h
--- setup-softdevice.h	23 May 2006 21:11:37 -0000	1.30
+++ setup-softdevice.h	14 Jun 2006 19:27:06 -0000
@@ -148,6 +148,10 @@
     int   zoomCenterY;
     int   useMGAtv;
     int   viaTv;
+#ifdef HAVE_CLE266_MPEG_DECODER
+    int   cle266HWdecode;
+    int   cle266FB;
+#endif // HAVE_CLE266_MPEG_DECODER
     int   tripleBuffering;
     int   useStretchBlit;
     int   shouldSuspend;
Index: softdevice.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/softdevice.c,v
retrieving revision 1.60
diff -u -r1.60 softdevice.c
--- softdevice.c	9 Jun 2006 16:45:13 -0000	1.60
+++ softdevice.c	14 Jun 2006 19:27:06 -0000
@@ -704,6 +704,9 @@
   "  -vo dfb:                 enable output via directFB\n"
   "  -vo dfb:mgatv                   output via MATROX TV-out\n"
   "  -vo dfb:viatv                   output via Unichrome TV-out\n"
+#ifdef HAVE_CLE266_MPEG_DECODER
+  "  -vo dfb:viatv:cle266            output via CLE266 accelerated Unichrome TV-out\n"
+#endif
   "  -vo dfb:triple                  enables triple buffering on back end scaler\n"
 #endif
 #ifdef VIDIX_SUPPORT
@@ -805,6 +808,13 @@
           else if (!strncmp (vo_argv, "viatv", 5)) {
             setupStore.viaTv = 1;
             fprintf(stderr,"[softdevice] enabling field parity\n");
+#ifdef HAVE_CLE266_MPEG_DECODER
+            vo_argv += 5;
+            if (!strncmp (vo_argv, ":cle266", 7)) {
+              setupStore.cle266HWdecode = 1;
+              fprintf(stderr,"[softdevice] enabling CLE266 HW decoding\n");
+            }
+#endif // HAVE_CLE266_MPEG_DECODER
           } else if (!strncmp (vo_argv, "triple", 6)) {
             setupStore.tripleBuffering = 1;
             fprintf(stderr,"[softdevice] enabling triple buffering\n");
Index: video-dfb.c
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.c,v
retrieving revision 1.63
diff -u -r1.63 video-dfb.c
--- video-dfb.c	9 Jun 2006 16:24:34 -0000	1.63
+++ video-dfb.c	14 Jun 2006 19:27:06 -0000
@@ -14,6 +14,9 @@
 #include "utils.h"
 #include "setup-softdevice.h"
 
+#ifdef HAVE_CLE266_MPEG_DECODER
+#include <cle266mpegdec.h>
+#endif // HAVE_CLE266_MPEG_DECODER
 
 #ifdef HAVE_CONFIG
 # include "config.h"
@@ -360,6 +363,17 @@
     {
       isVIAUnichrome = true;
       clearAlpha = 0xff;
+#ifdef HAVE_CLE266_MPEG_DECODER
+      if (setupStore->cle266HWdecode) {     
+          if (!SetupCle266Buffers(swidth, sheight)) {
+              fprintf(stderr, "Error allocating hardware buffers for CLE266 decoding: reverting to software decoding\n");
+              setupStore->cle266HWdecode = false;
+          } else {
+              // Need YV12 pixel format for blitting from hardware buffer
+              currentPixelFormat = setupStore->pixelFormat = 1;
+          }
+      }
+#endif // HAVE_CLE266_MPEG_DECODER
 
       ReportLayerInfo(osdLayer, "osdLayer");
       if (osdLayerDescription.caps & DLCAPS_ALPHACHANNEL)
@@ -490,7 +504,7 @@
         fprintf(stderr,"[dfb] Configuring CooperativeLevel for Overlay\n");
         videoLayer->SetCooperativeLevel(DLSCL_ADMINISTRATIVE);
 
-        if (!setupStore->viaTv)
+        if (!isVIAUnichrome)
           BESColorkeyState(videoLayer, true);
       }
 
@@ -501,7 +515,8 @@
               videoLayerDescription.name);
     }
 
-    GetDisplayFrameTime();
+    if (setupStore->useMGAtv) 
+            GetDisplayFrameTime();
     /* create an event buffer with all devices attached */
     events = dfb->CreateInputEventBuffer(DICAPS_ALL,
                                          (setupStore->useMGAtv) ? DFB_TRUE : DFB_FALSE);
@@ -1311,6 +1326,18 @@
   //fprintf(stderr,"[dfb] draw frame (%d x %d) Y: %d UV: %d\n", Width, Height, Ystride, UVstride);
   try
   {
+#ifdef HAVE_CLE266_MPEG_DECODER
+    int currentFB = 0;
+    if (setupStore->cle266HWdecode) {
+      // check if we use internal buffers
+      while ( buf != &mpegfbPic[currentFB]  && currentFB < 4)
+        currentFB++;
+    };
+    
+    if (setupStore->cle266HWdecode && currentFB < 4) {
+      videoSurface->Blit(mpegfb[currentFB], NULL, 0, 0);
+    } else {
+#endif // HAVE_CLE266_MPEG_DECODER
     videoSurface->Lock(DSLF_WRITE, (void **)&dst, &pitch);
     if (pixelformat == DSPF_I420 || pixelformat == DSPF_YV12)
     {
@@ -1391,6 +1418,9 @@
                              Ystride, UVstride, pitch);
       }
      }
+#ifdef HAVE_CLE266_MPEG_DECODER
+    }
+#endif // HAVE_CLE266_MPEG_DECODER
 
     videoSurface->Unlock();
 
@@ -1454,8 +1484,8 @@
 #endif
 
       }
-      //scrSurface->Flip(NULL, (setupStore->useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
-      scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
+      scrSurface->Flip(NULL, (setupStore->useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
+      //scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
 
     }
     else
@@ -1474,6 +1504,83 @@
   }
 }
 
+#ifdef HAVE_CLE266_MPEG_DECODER
+sPicBuffer *cDFBVideoOut::GetMpegfbPic(int fb) 
+{
+  return ( fb>=0 && fb<4 ? &mpegfbPic[fb] : 0 );
+};
+
+bool cDFBVideoOut::SetupCle266Buffers(int width, int height)
+{
+  DFBSurfaceDescription dsc;
+  int *buf;
+  int y_offset, u_offset, v_offset, i;
+  int mpegfb_stride;
+
+  fprintf(stderr, "Initialising CLE266 decoder:");
+  if (!CLE266MPEGInitialise(FBDEV)) {
+      fprintf(stderr, "failed!\n");
+      return false;
+  } else {
+      fprintf(stderr, "success!\n");
+  }
+
+  dsc.flags = (DFBSurfaceDescriptionFlags)(DSDESC_WIDTH |
+                DSDESC_HEIGHT |
+                DSDESC_PIXELFORMAT |
+                DSDESC_CAPS);
+  dsc.caps = DSCAPS_VIDEOONLY;
+  dsc.pixelformat = DSPF_YV12;
+  dsc.width = width;
+  dsc.height = height;
+
+/* Create the 4 MPEG buffers for decoding */
+  fprintf(stderr, "CLE266: Creating buffers for decoder\n");
+  try {
+    for (i = 0; i < 4; i++) {
+      fprintf(stderr, "CLE266: Creating buffer number %i\n", i);
+      mpegfb[i] = dfb->CreateSurface(dsc);
+ 
+      mpegfb[i]->Clear(0,0,0,0);
+      mpegfb[i]->Lock(DSLF_WRITE, (void**) &buf, &mpegfb_stride);
+      mpegfb[i]->GetFramebufferOffset(&mpegfb_ofs[i]);
+      
+      mpegfbPic[i].pixel[0] = (uint8_t*) buf;
+      mpegfbPic[i].pixel[2] = (uint8_t*) buf + height * mpegfb_stride;
+      mpegfbPic[i].pixel[1] = (uint8_t*) mpegfbPic[i].pixel[2]
+                                         +(height>>1)*(mpegfb_stride>>1);
+      mpegfbPic[i].stride[0] = mpegfb_stride;
+      mpegfbPic[i].stride[1] = mpegfbPic[i].stride[2] = mpegfb_stride>>1;
+      mpegfbPic[i].format = PIX_FMT_YUV420P;
+      mpegfbPic[i].owner = NULL;
+    }
+  }
+  catch (DFBException *ex)
+  {
+    fprintf(stderr, "CLE266: Error creating buffer: action=%s, result=%s\n",
+                  ex->GetAction(), ex->GetResult());
+    delete ex;
+    return false;
+  }
+
+  /* Pass info to the decoder...*/
+  fprintf(stderr, "CLE266: passing mpegfb_stride\n");
+  CLE266MPEGSetStride(mpegfb_stride, mpegfb_stride >> 1 );
+
+  height = (height + 15) & ~15;
+  width  = (width  + 15) & ~15;
+
+  fprintf(stderr, "CLE266: passing buffers to decoder\n");
+  for (i = 0; i < 4; i++) {
+    y_offset = mpegfb_ofs[i];
+    v_offset = y_offset + (mpegfb_stride * height);
+    u_offset = v_offset + (mpegfb_stride >> 1) * (height >> 1);
+    CLE266MPEGSetFrameBuffer(i,y_offset,v_offset,u_offset);
+  }
+  return true;
+}
+#endif // HAVE_CLE266_MPEG_DECODER
+
 /* ---------------------------------------------------------------------------
  */
 cDFBVideoOut::~cDFBVideoOut()
@@ -1488,6 +1595,10 @@
   if (videoLayer)   videoLayer->Release ();
   if (osdLayer)     osdLayer->Release();
   if (dfb)          dfb->Release();
+#ifdef HAVE_CLE266_MPEG_DECODER
+  if (setupStore->cle266HWdecode)
+      CLE266MPEGClose();
+#endif // HAVE_CLE266_MPEG_DECODER
 }
 
 #ifdef USE_SUBPLUGINS
Index: video-dfb.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video-dfb.h,v
retrieving revision 1.21
diff -u -r1.21 video-dfb.h
--- video-dfb.h	27 May 2006 19:12:41 -0000	1.21
+++ video-dfb.h	14 Jun 2006 19:27:06 -0000
@@ -50,6 +50,13 @@
     void SetParams();
     void EnableFieldParity(IDirectFBDisplayLayer *layer);
 
+#ifdef HAVE_CLE266_MPEG_DECODER
+    IDirectFBSurface* mpegfb[4];
+    int               mpegfb_ofs[4];
+    sPicBuffer        mpegfbPic[4];
+    bool SetupCle266Buffers(int, int);
+    virtual sPicBuffer *GetMpegfbPic(int fb);
+#endif // HAVE_CLE266_MPEG_DECODER
   public:
     IDirectFB	*dfb;
     cDFBVideoOut(cSetupStore *setupStore);
Index: video.h
===================================================================
RCS file: /cvsroot/softdevice/softdevice/video.h,v
retrieving revision 1.40
diff -u -r1.40 video.h
--- video.h	27 May 2006 19:12:41 -0000	1.40
+++ video.h	14 Jun 2006 19:27:07 -0000
@@ -126,6 +126,11 @@
     cVideoOut(cSetupStore *setupStore);
     virtual ~cVideoOut();
 
+    
+    // FIXME remove
+    virtual sPicBuffer *GetMpegfbPic(int fb)
+    { return NULL;};
+
     virtual void ProcessEvents ()
     {};
     // will be called every xx ms, at a minimum after each frame.

From laz at club-burniston.co.uk  Wed Jun 14 22:27:09 2006
From: laz at club-burniston.co.uk (Laz)
Date: Wed, 14 Jun 2006 21:27:09 +0100
Subject: [Softdevice-devel] Incorrect aspect ratio for some streams
In-Reply-To: <200606140036.03105.stefan@lucke.in-berlin.de>
References: <200606011544.01943.laz@club-burniston.co.uk> <200606021012.43530.laz@club-burniston.co.uk> <200606140036.03105.stefan@lucke.in-berlin.de>
Message-ID: <200606142127.09736.laz@club-burniston.co.uk>

On Tuesday 13 June 2006 23:36, Stefan Lucke wrote:
> On Freitag 02 Juni 2006 11:12, Laz wrote:

> > It is a 4:3 picture transmitted with black borders at the left and right
> > to make it up to 16:9 frame size. With viatv output, it is being squashed
> > sideways into the size of a 4:3 frame (keeping the black borders), so
> > that the picture itself is squashed sideways.
>
> Can you check your via chip revision number ?
> From Readme.txt of unichrome/ :
> * There are different hardware variants of the Unichrome chips.  Since
>   the revision number can only be read by superuser processes, a utility
>   'find_revision.sh' is provided.  The value it reports should be used
>   in /etc/directfbrc in a line of the form 'unichrome-revision=xx'.
>
>   Symptoms of an incorrect revision number are corrupt images on the
>   video overlay layer or incorrect colors when using YUY2 or YV12
>   pixel formats.

That's all fine:

./find_revision.sh
Password:
Your CLE266 revision number is 17.
To use this value, add the following line to /etc/directfbrc:
    unichrome-revision=17

And my /etc/directfbrc:
mode=720x576
depth=32
pixelformat=ARGB
disable-module=lirc
disable-module=joystick
disable-module=cle266
no-vt
unichrome-revision=17

The only time I see incorrect colours is if I select YV12, when I get a bluish 
tinge but I think it has always done this for that format.

I haven't really had a chance to work out how the aspect-ratio code works yet 
but this is some of the output I got from a few additional printfs (for the 
two streams I gave to Stefan):

4:3 aspect ratio picture which has been cropped before transmission and 
displays correctly:

newaspect: AFD = 0; afd_asp: 1.333333; new_asp: 1.333333
[VideoOut]: 720x576 [0,0 720x576] -> 720x576 [90,0 540x576]
[dfb] (re)configuring Videolayer to 720 x 576 (720x576)


4:3 aspect ratio with added borders to bring it up to a full 16:9 frame. 
Shouldn't be scaled for a 16:9 TV but for me is squashed sideways into a 4:3 
framesize:

newaspect: AFD = 1; afd_asp: 1.333333; new_asp: 1.777778
[VideoOut]: 720x576 [90,0 540x576] -> 720x576 [90,0 540x576]
[dfb] (re)configuring Videolayer to 720 x 576 (540x576)

The AFDs and aspect look OK to me, i.e. both are 4:3 images (afd_asp) and the 
aspect ratio should be 4:3 and 16:9, as required. However, the second one is 
being scaled (second line). This was only a quick test but the VideoOut bit 
is the bit I need to study more to try to track this down.

Cheers,

Laz


From leo at calidae.net  Thu Jun 15 09:18:47 2006
From: leo at calidae.net (=?ISO-8859-1?Q?Leo_M=E1rquez?=)
Date: Thu, 15 Jun 2006 09:18:47 +0200
Subject: [Softdevice-devel] witch softdevice output depending on hard
 and soft
In-Reply-To: <44904497.5020301@gmx.net>
References: <448FE494.5080908@calidae.net> <44904497.5020301@gmx.net>
Message-ID: <449109D7.4050009@calidae.net>

Thanks for your answer Martin,

Martin Wache wrote:
> Leo M?rquez schrieb:
>
>   
>> It says me that softdevice is not compiled with xv support.
>> I have been checked the softdevice Makefile and XV_SUPPORT is set to 1
>> But I have noticed that when I execute in the softdevice dir the
>> ./configure command with an option related to xv then the config.h and
>> config.mak don't change. For example if I execute ./config --disable-fb
>> I see config.h and config.mak updated.
>> But if I execute ./configure --disable-xv don't update anything. If
>> after that I execute again only ./configure anything changed again and
>> it must update to enable all the outputs again.
>>
>>     
> Do you have the x-development headers installed?
>   
I dont know in witch debian package are this headers included. I have 
installled the xserver-xorg-dev package but it don't work for me.
The plugins compiles fine but the configure command of softdevice ignore 
the --disable-xv and the ./configure commands that are relative to xv.
>   
>> The other type of client I want set is a non x-window system based. I
>> have tried it with directfb without luck. The hardware is geoforce mx
>> 4400 or 5500.
>>
>>     
> I'm not sure how good the support for gforce graphics cards is in
> DirectFB. I would suggest you to by a old, cheap and well supported
> graphics card if you want to use Directfb.
>
>
>   
>> I know there is a lot of docs and I have readed a lot of them but I'm
>> confused about how to set the best output. I know that the fb output is
>> bad because cpu have a lot of work. At the moment the fb output is the
>> only way softdevice worked to me.
>> I understand that xvmc or directfb is the best way but I don't know
>> exactly how to set up these.
>>
>>     
> Xvmc is currently not supported by the softdevice. DirectFB is certainly
> the best way if you want to avoid X. For directFB you need a framebuffer
> driver for your graphics card which enables hardware acceleration (like
> atyfb for Mach64, aty128fb for Mach128, viafb for via-cle266...). Get
> and compile DirectFB and DFB++, set up /etc/directfbrc (examples are on
> the softdevice hompage) compile the softdevice with directfb support,
> and you should be ready to go.
>   
Ok. This lines helps me to clarify the way to set up that I want. A lot 
of thanks.

Leo


From leo at calidae.net  Thu Jun 15 15:03:24 2006
From: leo at calidae.net (=?ISO-8859-1?Q?Leo_M=E1rquez?=)
Date: Thu, 15 Jun 2006 15:03:24 +0200
Subject: [Softdevice-devel] I only see osd
Message-ID: <44915A9C.8080700@calidae.net>

Hi,

Well I'm setted up a vdr with softdevice, directfb but when I start vdr 
with:

./vdr -P"softdevice -vo dfb:"

I only see the osd menus, but no tv image.
My directfbrc file contains:

mode  = 768x576
depth = 32
pixelformat=ARGB

My hardware is a nvidia tnt2 M64.
The framebuffer module I use is nvidiafb

In var/log/syslog I don't see anything strange.

In the other hand if I start vdr with only -Pstreamdev-server the 
clients can watch TV.
In the server few days a go I use -vo fb: as output and It works.

I supose the problem is related to the directfb configuration but... why 
can I see osd and not TV?

Thanks,

Leo


From leo at calidae.net  Thu Jun 15 15:17:00 2006
From: leo at calidae.net (=?ISO-8859-1?Q?Leo_M=E1rquez?=)
Date: Thu, 15 Jun 2006 15:17:00 +0200
Subject: [Softdevice-devel] I only see osd
In-Reply-To: <44915A9C.8080700@calidae.net>
References: <44915A9C.8080700@calidae.net>
Message-ID: <44915DCC.7000702@calidae.net>

Hi again,
Some logs I see in syslog:

switching to channel 6
Jun 15 15:51:35 vdr vdr: [3606] transfer thread ended (pid=3577, tid=3606)
Jun 15 15:51:35 vdr vdr: [3609] TS buffer on device 1 thread ended 
(pid=3577, tid=3609)
Jun 15 15:51:35 vdr vdr: [3607] buffer stats: 67680 (3%) used
Jun 15 15:51:35 vdr vdr: [3607] receiver on device 1 thread ended 
(pid=3577, tid=3607)
Jun 15 15:51:35 vdr vdr: [3577] cTS2PES got 0 TS errors, 1 TS continuity 
errors
Jun 15 15:51:35 vdr vdr: [3577] buffer stats: 68056 (3%) used
Jun 15 15:51:35 vdr vdr: [3614] transfer thread started (pid=3577, tid=3614)
Jun 15 15:51:35 vdr vdr: [3615] receiver on device 1 thread started 
(pid=3577, tid=3615)
Jun 15 15:51:35 vdr vdr: [3617] TS buffer on device 1 thread started 
(pid=3577, tid=3617)
Jun 15 15:51:36 vdr vdr: [3614] setting audio track to 1 (0)
Jun 15 15:51:36 vdr vdr: [3619] [softdevice-audio]: xrun
Jun 15 15:51:39 vdr vdr: [3577] switching to channel 7
Jun 15 15:51:39 vdr vdr: [3614] transfer thread ended (pid=3577, tid=3614)
Jun 15 15:51:39 vdr vdr: [3617] TS buffer on device 1 thread ended 
(pid=3577, tid=3617)
Jun 15 15:51:39 vdr vdr: [3615] buffer stats: 57528 (2%) used
Jun 15 15:51:39 vdr vdr: [3615] receiver on device 1 thread ended 
(pid=3577, tid=3615)
Jun 15 15:51:39 vdr vdr: [3577] cTS2PES got 0 TS errors, 1 TS continuity 
errors
Jun 15 15:51:39 vdr vdr: [3577] cTS2PES got 1 TS errors, 1 TS continuity 
errors
Jun 15 15:51:39 vdr vdr: [3577] buffer stats: 57904 (2%) used
Jun 15 15:51:39 vdr vdr: [3620] transfer thread started (pid=3577, tid=3620)
Jun 15 15:51:39 vdr vdr: [3621] receiver on device 1 thread started 
(pid=3577, tid=3621)
Jun 15 15:51:39 vdr vdr: [3623] TS buffer on device 1 thread started 
(pid=3577, tid=3623)
Jun 15 15:51:40 vdr vdr: [3624] [VideoOut]: resolution changed: W(720 -> 
528); H(576 ->576)
Jun 15 15:51:40 vdr vdr: [3624] [VideoOut]: 528x576 [0,0 528x576] -> 
768x576 [0,0 768x576]


Can be related to my problem?

Thanks again.

Leo



Leo M?rquez wrote:
> Hi,
>
> Well I'm setted up a vdr with softdevice, directfb but when I start 
> vdr with:
>
> ./vdr -P"softdevice -vo dfb:"
>
> I only see the osd menus, but no tv image.
> My directfbrc file contains:
>
> mode  = 768x576
> depth = 32
> pixelformat=ARGB
>
> My hardware is a nvidia tnt2 M64.
> The framebuffer module I use is nvidiafb
>
> In var/log/syslog I don't see anything strange.
>
> In the other hand if I start vdr with only -Pstreamdev-server the 
> clients can watch TV.
> In the server few days a go I use -vo fb: as output and It works.
>
> I supose the problem is related to the directfb configuration but... 
> why can I see osd and not TV?
>
> Thanks,
>
> Leo
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/softdevice-devel
>



From leo at calidae.net  Thu Jun 15 16:59:15 2006
From: leo at calidae.net (=?ISO-8859-1?Q?Leo_M=E1rquez?=)
Date: Thu, 15 Jun 2006 16:59:15 +0200
Subject: [Softdevice-devel] I only see osd
In-Reply-To: <44915DCC.7000702@calidae.net>
References: <44915A9C.8080700@calidae.net> <44915DCC.7000702@calidae.net>
Message-ID: <449175C3.5080104@calidae.net>

More info. This is my fbset -i:

mode "640x480-60"
    # D: 25.176 MHz, H: 31.469 kHz, V: 59.942 Hz
    geometry 640 480 640 32767 8
    timings 39721 40 24 32 11 96 2
    accel true
    rgba 8/0,8/0,8/0,0/0
endmode

Frame buffer device information:
    Name        : NV2
    Address     : 0xe4000000
    Size        : 33554432
    Type        : PACKED PIXELS
    Visual      : PSEUDOCOLOR
    XPanStep    : 8
    YPanStep    : 1
    YWrapStep   : 0
    LineLength  : 640
    MMIO Address: 0xe6000000
    MMIO Size   : 16777216
    Accelerator : nVidia RIVA TNT

I hope you could help me.

Thanks,

Leo

Leo M?rquez wrote:
> Hi again,
> Some logs I see in syslog:
>
> switching to channel 6
> Jun 15 15:51:35 vdr vdr: [3606] transfer thread ended (pid=3577, 
> tid=3606)
> Jun 15 15:51:35 vdr vdr: [3609] TS buffer on device 1 thread ended 
> (pid=3577, tid=3609)
> Jun 15 15:51:35 vdr vdr: [3607] buffer stats: 67680 (3%) used
> Jun 15 15:51:35 vdr vdr: [3607] receiver on device 1 thread ended 
> (pid=3577, tid=3607)
> Jun 15 15:51:35 vdr vdr: [3577] cTS2PES got 0 TS errors, 1 TS 
> continuity errors
> Jun 15 15:51:35 vdr vdr: [3577] buffer stats: 68056 (3%) used
> Jun 15 15:51:35 vdr vdr: [3614] transfer thread started (pid=3577, 
> tid=3614)
> Jun 15 15:51:35 vdr vdr: [3615] receiver on device 1 thread started 
> (pid=3577, tid=3615)
> Jun 15 15:51:35 vdr vdr: [3617] TS buffer on device 1 thread started 
> (pid=3577, tid=3617)
> Jun 15 15:51:36 vdr vdr: [3614] setting audio track to 1 (0)
> Jun 15 15:51:36 vdr vdr: [3619] [softdevice-audio]: xrun
> Jun 15 15:51:39 vdr vdr: [3577] switching to channel 7
> Jun 15 15:51:39 vdr vdr: [3614] transfer thread ended (pid=3577, 
> tid=3614)
> Jun 15 15:51:39 vdr vdr: [3617] TS buffer on device 1 thread ended 
> (pid=3577, tid=3617)
> Jun 15 15:51:39 vdr vdr: [3615] buffer stats: 57528 (2%) used
> Jun 15 15:51:39 vdr vdr: [3615] receiver on device 1 thread ended 
> (pid=3577, tid=3615)
> Jun 15 15:51:39 vdr vdr: [3577] cTS2PES got 0 TS errors, 1 TS 
> continuity errors
> Jun 15 15:51:39 vdr vdr: [3577] cTS2PES got 1 TS errors, 1 TS 
> continuity errors
> Jun 15 15:51:39 vdr vdr: [3577] buffer stats: 57904 (2%) used
> Jun 15 15:51:39 vdr vdr: [3620] transfer thread started (pid=3577, 
> tid=3620)
> Jun 15 15:51:39 vdr vdr: [3621] receiver on device 1 thread started 
> (pid=3577, tid=3621)
> Jun 15 15:51:39 vdr vdr: [3623] TS buffer on device 1 thread started 
> (pid=3577, tid=3623)
> Jun 15 15:51:40 vdr vdr: [3624] [VideoOut]: resolution changed: W(720 
> -> 528); H(576 ->576)
> Jun 15 15:51:40 vdr vdr: [3624] [VideoOut]: 528x576 [0,0 528x576] -> 
> 768x576 [0,0 768x576]
>
>
> Can be related to my problem?
>
> Thanks again.
>
> Leo
>
>
>
> Leo M?rquez wrote:
>> Hi,
>>
>> Well I'm setted up a vdr with softdevice, directfb but when I start 
>> vdr with:
>>
>> ./vdr -P"softdevice -vo dfb:"
>>
>> I only see the osd menus, but no tv image.
>> My directfbrc file contains:
>>
>> mode  = 768x576
>> depth = 32
>> pixelformat=ARGB
>>
>> My hardware is a nvidia tnt2 M64.
>> The framebuffer module I use is nvidiafb
>>
>> In var/log/syslog I don't see anything strange.
>>
>> In the other hand if I start vdr with only -Pstreamdev-server the 
>> clients can watch TV.
>> In the server few days a go I use -vo fb: as output and It works.
>>
>> I supose the problem is related to the directfb configuration but... 
>> why can I see osd and not TV?
>>
>> Thanks,
>>
>> Leo
>> _______________________________________________
>> Softdevice-devel mailing list
>> Softdevice-devel at lists.berlios.de
>> http://lists.berlios.de/mailman/listinfo/softdevice-devel
>>
>
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/softdevice-devel
>



From M.Wache at gmx.net  Thu Jun 15 19:48:07 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 15 Jun 2006 19:48:07 +0200
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <Pine.OSF.4.61.0606142228120.334744@kosh.hut.fi>
References: <447B51B7.8070504@gmx.net> <200606140041.37079.stefan@lucke.in-berlin.de> <44904706.5010707@gmx.net> <Pine.OSF.4.61.0606142228120.334744@kosh.hut.fi>
Message-ID: <44919D57.8010408@gmx.net>

Rolf Ahrenberg schrieb:
> On Wed, 14 Jun 2006, Martin Wache wrote:
> 
>> It would be nice if you could have a closer look at these issues, I'm a
>> bit short on time...
> 
> Well, I've attached a patch from my softdevice tree that really enables
> the cle266 hw decoding (-vo dfb:viatv:cle266). Now the cpu load is again
> down to ~30% (was ~55%) on my 1GHz EPIA.
> 
That are great news! Can you please tell me which change did the trick?
I only found two differences to the patch I send, the pixelformat is
changed back, and BesColorKeyState() is not called for the unichrome
anymore. I tried both changes, but for me the cpu load is still high.

Bye,

Martin


From prakash at punnoor.de  Thu Jun 15 22:46:33 2006
From: prakash at punnoor.de (Prakash Punnoor)
Date: Thu, 15 Jun 2006 22:46:33 +0200
Subject: [Softdevice-devel] [PATCH] softdevice 0.2.3a issues reported by valgrind
Message-ID: <200606152246.33337.prakash@punnoor.de>

Hi,

I haven't checked against cvs, but last release should probably have something 
like this merged. You possibly have to tweak some inital values, as I dont 
know correct values. This patch fixes

- uninitialized variables
- delete/delete[] mismatch
- calling function with too little parameters

There are some more issues with ioctls and uninitialized stuff, but I haven't 
checked, yet.

diff -urd softdevice-0.2.3a/SoftOsd.c softdevice-0.2.3a.mod/SoftOsd.c
--- softdevice-0.2.3a/SoftOsd.c	2006-04-23 22:35:53.000000000 +0200
+++ softdevice-0.2.3a.mod/SoftOsd.c	2006-06-15 22:32:47.000000000 +0200
@@ -43,6 +43,8 @@
         xPan = yPan = 0;
 	videoOut->OpenOSD();
 	xOfs=X;yOfs=Y;
+	ScreenOsdWidth=0;
+	ScreenOsdHeight=0;
         int Depth; bool HasAlpha; bool AlphaInversed; bool IsYUV; 
         uint8_t *PixelMask;
         videoOut->AdjustOSDMode();
@@ -77,7 +79,7 @@
                 videoOut->CloseOSD();
                 videoOut=0;
         }
-        delete OSD_Bitmap;
+        delete[] OSD_Bitmap;
 }
 
 /* -------------------------------------------------------------------------*/
diff -urd softdevice-0.2.3a/mpeg2decoder.c 
softdevice-0.2.3a.mod/mpeg2decoder.c
--- softdevice-0.2.3a/mpeg2decoder.c	2006-04-14 23:25:44.000000000 +0200
+++ softdevice-0.2.3a.mod/mpeg2decoder.c	2006-06-15 22:32:47.000000000 +0200
@@ -51,7 +51,7 @@
 
 cPacketQueue::~cPacketQueue() {
   Clear();
-  delete queue;
+  delete[] queue;
 };
 
 int cPacketQueue::PutPacket(const AVPacket &Packet) {
diff -urd softdevice-0.2.3a/video.c softdevice-0.2.3a.mod/video.c
--- softdevice-0.2.3a/video.c	2006-04-29 17:57:27.000000000 +0200
+++ softdevice-0.2.3a.mod/video.c	2006-06-15 22:32:47.000000000 +0200
@@ -35,6 +35,7 @@
   old_width = fwidth = lwidth = old_dwidth = dwidth = swidth = 720;
   old_height = fheight = lheight = old_dheight = dheight = sheight = 536;
   sxoff = syoff = lxoff = lyoff = 0;
+  flags = 0;
   cutTop = cutBottom = cutLeft = cutRight = 0;
   OsdPy = OsdPu = OsdPv = OsdPAlphaY = OsdPAlphaUV = NULL;
   Osd_changed = 0;
@@ -44,6 +45,10 @@
   interlaceMode = -1;
   prevZoomFactor = 0;
   realZoomFactor = 1.0;
+  zoomCenterX = 0;
+  zoomCenterY = 0;
+  expandTopBottom = 0;
+  expandLeftRight = 0;
   PixelMask=NULL;
   OsdRefreshCounter=0;
   displayTimeUS = 0;
@@ -118,7 +123,7 @@
                          old_picture->data[2],
                          old_width, old_height,
                          old_picture->linesize[0],
-                         old_picture->linesize[1]);
+                         old_picture->linesize[1],0,0);
       }
       else
       {
@@ -126,7 +131,7 @@
         DrawStill_420pl (OsdPy,OsdPu, OsdPv,
                         OsdWidth,OsdHeight,
                         //OSD_FULL_WIDTH, OSD_FULL_HEIGHT,
-                         OSD_FULL_WIDTH, OSD_FULL_WIDTH/2);
+                         OSD_FULL_WIDTH, OSD_FULL_WIDTH/2,0,0);
       }
       osdMutex.Unlock();
     }


Hth,
-- 
(?=                 =?)
//\ Prakash Punnoor /\\
V_/                 \_V
-------------- next part --------------
A non-text attachment was scrubbed...
Name: val-soft.diff
Type: text/x-diff
Size: 2535 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060615/caf48571/attachment.diff>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060615/caf48571/attachment.pgp>

From rahrenbe at cc.hut.fi  Thu Jun 15 23:17:48 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Fri, 16 Jun 2006 00:17:48 +0300 (EEST)
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <44919D57.8010408@gmx.net>
References: <447B51B7.8070504@gmx.net> <200606140041.37079.stefan@lucke.in-berlin.de>
 <44904706.5010707@gmx.net> <Pine.OSF.4.61.0606142228120.334744@kosh.hut.fi>
 <44919D57.8010408@gmx.net>
Message-ID: <Pine.OSF.4.61.0606160005070.468619@kosh.hut.fi>

On Thu, 15 Jun 2006, Martin Wache wrote:

> That are great news! Can you please tell me which change did the trick?
> I only found two differences to the patch I send, the pixelformat is
> changed back, and BesColorKeyState() is not called for the unichrome
> anymore. I tried both changes, but for me the cpu load is still high.

It was the pixelformat. As the comment in patch says, CLE266 seems to 
require YV12 format. However, I also did enable the viaTV variable for 
cle266, made that BesColorKeyState() modification just in case, and
corrected the configuration script.

BR,
--
rofa


From M.Wache at gmx.net  Thu Jun 15 23:43:01 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 15 Jun 2006 23:43:01 +0200
Subject: [Softdevice-devel] [PATCH] softdevice 0.2.3a issues reported
 by valgrind
In-Reply-To: <200606152246.33337.prakash@punnoor.de>
References: <200606152246.33337.prakash@punnoor.de>
Message-ID: <4491D465.1060606@gmx.net>

Prakash Punnoor schrieb:
> Hi,
> 
> I haven't checked against cvs, but last release should probably have something 
> like this merged. You possibly have to tweak some inital values, as I dont 
> know correct values. This patch fixes
> 
> - uninitialized variables
> - delete/delete[] mismatch
> - calling function with too little parameters
> 

Thank you very much, I fixed the delete/delete[] mismatch. I haven't
fixed the issues in video.c yet, because there have been some changes
lately and I still have some other changes pending...
But they don't look very serious for me. The function which is called
with too little parameters has default parameters, flags is completely
unused and should be removed and zoomCenterXY and expandXXYYY will be
initialized before the first frame is shown. Anyway initializing them in
the constructor won't hurt.

Bye,
Martin


From M.Wache at gmx.net  Thu Jun 15 23:46:21 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 15 Jun 2006 23:46:21 +0200
Subject: [Softdevice-devel] witch softdevice output depending on hard
 and soft
In-Reply-To: <449109D7.4050009@calidae.net>
References: <448FE494.5080908@calidae.net> <44904497.5020301@gmx.net> <449109D7.4050009@calidae.net>
Message-ID: <4491D52D.5090301@gmx.net>

Leo M?rquez schrieb:
> Thanks for your answer Martin,
> 
> Martin Wache wrote:
>> Leo M?rquez schrieb:
>>
>>  
>>> It says me that softdevice is not compiled with xv support.
>>> I have been checked the softdevice Makefile and XV_SUPPORT is set to 1
>>> But I have noticed that when I execute in the softdevice dir the
>>> ./configure command with an option related to xv then the config.h and
>>> config.mak don't change. For example if I execute ./config --disable-fb
>>> I see config.h and config.mak updated.
>>> But if I execute ./configure --disable-xv don't update anything. If
>>> after that I execute again only ./configure anything changed again and
>>> it must update to enable all the outputs again.
>>>
>>>     
>> Do you have the x-development headers installed?
>>   
> I dont know in witch debian package are this headers included. I have
> installled the xserver-xorg-dev package but it don't work for me.
> The plugins compiles fine but the configure command of softdevice ignore
> the --disable-xv and the ./configure commands that are relative to xv.

I would assume that xserver-xorg-dev is the one you need, but maybe you
also need some more. The softdevice also needs the headers of the x11
extensions like XVideo, maybe that is still missing. If you upgrade to
the cvs from today and use configure again you will get a more detailed
report of why xv is disabled in the file config.log.

Bye,
Martin


From M.Wache at gmx.net  Thu Jun 15 23:54:15 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 15 Jun 2006 23:54:15 +0200
Subject: [Softdevice-devel] I only see osd
In-Reply-To: <449175C3.5080104@calidae.net>
References: <44915A9C.8080700@calidae.net> <44915DCC.7000702@calidae.net> <449175C3.5080104@calidae.net>
Message-ID: <4491D707.2020502@gmx.net>

Leo M?rquez schrieb:
> More info. This is my fbset -i:
> 
> mode "640x480-60"
>    # D: 25.176 MHz, H: 31.469 kHz, V: 59.942 Hz
>    geometry 640 480 640 32767 8
>    timings 39721 40 24 32 11 96 2
>    accel true
>    rgba 8/0,8/0,8/0,0/0
> endmode
> 
> Frame buffer device information:
>    Name        : NV2
>    Address     : 0xe4000000
>    Size        : 33554432
>    Type        : PACKED PIXELS
>    Visual      : PSEUDOCOLOR
>    XPanStep    : 8
>    YPanStep    : 1
>    YWrapStep   : 0
>    LineLength  : 640
>    MMIO Address: 0xe6000000
>    MMIO Size   : 16777216
>    Accelerator : nVidia RIVA TNT
> 
Hmm, looks okay to mee.


[...]
>> Jun 15 15:51:39 vdr vdr: [3623] TS buffer on device 1 thread started
>> (pid=3577, tid=3623)
>> Jun 15 15:51:40 vdr vdr: [3624] [VideoOut]: resolution changed: W(720
>> -> 528); H(576 ->576)
>> Jun 15 15:51:40 vdr vdr: [3624] [VideoOut]: 528x576 [0,0 528x576] ->
>> 768x576 [0,0 768x576]
>>
>>
>> Can be related to my problem?
>>
No, the log messages don't show any problem.


>>> I supose the problem is related to the directfb configuration but...
>>> why can I see osd and not TV?
>>>
One possibility is that the VideoLayer in the DFB nvidia driver is
broken. I'm not an DirectFB expert but I think that this is the most
likely reason.
Or is there anyone who has an nvidia card running with the softdevice
and DirectFB?

Martin


From M.Wache at gmx.net  Fri Jun 16 00:22:28 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Fri, 16 Jun 2006 00:22:28 +0200
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <Pine.OSF.4.61.0606160005070.468619@kosh.hut.fi>
References: <447B51B7.8070504@gmx.net> <200606140041.37079.stefan@lucke.in-berlin.de> <44904706.5010707@gmx.net> <Pine.OSF.4.61.0606142228120.334744@kosh.hut.fi> <44919D57.8010408@gmx.net> <Pine.OSF.4.61.0606160005070.468619@kosh.hut.fi>
Message-ID: <4491DDA4.7040106@gmx.net>

Rolf Ahrenberg schrieb:
> On Thu, 15 Jun 2006, Martin Wache wrote:
> 
>> That are great news! Can you please tell me which change did the trick?
>> I only found two differences to the patch I send, the pixelformat is
>> changed back, and BesColorKeyState() is not called for the unichrome
>> anymore. I tried both changes, but for me the cpu load is still high.
> 
> It was the pixelformat. As the comment in patch says, CLE266 seems to
> require YV12 format. However, I also did enable the viaTV variable for
> cle266, made that BesColorKeyState() modification just in case, and
> corrected the configuration script.
> 
I tried the changes again, unfortunately for me the cpu load is still high.
I must say that I'm a bit lost... I've already fixed the last issues
with the buffering, so in principle the patches would be ready to be
merged. But I don't like the idea of merging the patches when they
actually increase the cpu load instead of reducing it.

Bye,
Martin


From stefan at lucke.in-berlin.de  Fri Jun 16 07:10:29 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 16 Jun 2006 07:10:29 +0200
Subject: [Softdevice-devel] I only see osd
In-Reply-To: <449175C3.5080104@calidae.net>
References: <44915A9C.8080700@calidae.net> <44915DCC.7000702@calidae.net> <449175C3.5080104@calidae.net>
Message-ID: <200606160710.29160.stefan@lucke.in-berlin.de>

On Donnerstag 15 Juni 2006 16:59, Leo M?rquez wrote:
> More info. This is my fbset -i:
> 
> mode "640x480-60"
>     # D: 25.176 MHz, H: 31.469 kHz, V: 59.942 Hz
>     geometry 640 480 640 32767 8
>     timings 39721 40 24 32 11 96 2
>     accel true
>     rgba 8/0,8/0,8/0,0/0
> endmode
> 
> Frame buffer device information:
>     Name        : NV2
>     Address     : 0xe4000000
>     Size        : 33554432
>     Type        : PACKED PIXELS
>     Visual      : PSEUDOCOLOR
>     XPanStep    : 8
>     YPanStep    : 1
>     YWrapStep   : 0
>     LineLength  : 640
>     MMIO Address: 0xe6000000
>     MMIO Size   : 16777216
>     Accelerator : nVidia RIVA TNT
> 
> I hope you could help me.
> 

So the only info which is missing, is the messages written to stderr.
Up to now everything looks ok. At least there is no obious error.

Please try to avoid top posts.


> Thanks,
> 
> Leo
> 
> Leo M?rquez wrote:
> > Hi again,
> > Some logs I see in syslog:
> >
> > switching to channel 6
> > Jun 15 15:51:35 vdr vdr: [3606] transfer thread ended (pid=3577, 
> > tid=3606)
> > Jun 15 15:51:35 vdr vdr: [3609] TS buffer on device 1 thread ended 
> > (pid=3577, tid=3609)
> > Jun 15 15:51:35 vdr vdr: [3607] buffer stats: 67680 (3%) used
> > Jun 15 15:51:35 vdr vdr: [3607] receiver on device 1 thread ended 
> > (pid=3577, tid=3607)
> > Jun 15 15:51:35 vdr vdr: [3577] cTS2PES got 0 TS errors, 1 TS 
> > continuity errors
> > Jun 15 15:51:35 vdr vdr: [3577] buffer stats: 68056 (3%) used
> > Jun 15 15:51:35 vdr vdr: [3614] transfer thread started (pid=3577, 
> > tid=3614)
> > Jun 15 15:51:35 vdr vdr: [3615] receiver on device 1 thread started 
> > (pid=3577, tid=3615)
> > Jun 15 15:51:35 vdr vdr: [3617] TS buffer on device 1 thread started 
> > (pid=3577, tid=3617)
> > Jun 15 15:51:36 vdr vdr: [3614] setting audio track to 1 (0)
> > Jun 15 15:51:36 vdr vdr: [3619] [softdevice-audio]: xrun
> > Jun 15 15:51:39 vdr vdr: [3577] switching to channel 7
> > Jun 15 15:51:39 vdr vdr: [3614] transfer thread ended (pid=3577, 
> > tid=3614)
> > Jun 15 15:51:39 vdr vdr: [3617] TS buffer on device 1 thread ended 
> > (pid=3577, tid=3617)
> > Jun 15 15:51:39 vdr vdr: [3615] buffer stats: 57528 (2%) used
> > Jun 15 15:51:39 vdr vdr: [3615] receiver on device 1 thread ended 
> > (pid=3577, tid=3615)
> > Jun 15 15:51:39 vdr vdr: [3577] cTS2PES got 0 TS errors, 1 TS 
> > continuity errors
> > Jun 15 15:51:39 vdr vdr: [3577] cTS2PES got 1 TS errors, 1 TS 
> > continuity errors
> > Jun 15 15:51:39 vdr vdr: [3577] buffer stats: 57904 (2%) used
> > Jun 15 15:51:39 vdr vdr: [3620] transfer thread started (pid=3577, 
> > tid=3620)
> > Jun 15 15:51:39 vdr vdr: [3621] receiver on device 1 thread started 
> > (pid=3577, tid=3621)
> > Jun 15 15:51:39 vdr vdr: [3623] TS buffer on device 1 thread started 
> > (pid=3577, tid=3623)
> > Jun 15 15:51:40 vdr vdr: [3624] [VideoOut]: resolution changed: W(720 
> > -> 528); H(576 ->576)
> > Jun 15 15:51:40 vdr vdr: [3624] [VideoOut]: 528x576 [0,0 528x576] -> 
> > 768x576 [0,0 768x576]
> >
> >
> > Can be related to my problem?
> >
> > Thanks again.
> >
> > Leo
> >
> >
> >
> > Leo M?rquez wrote:
> >> Hi,
> >>
> >> Well I'm setted up a vdr with softdevice, directfb but when I start 
> >> vdr with:
> >>
> >> ./vdr -P"softdevice -vo dfb:"
> >>
> >> I only see the osd menus, but no tv image.
> >> My directfbrc file contains:
> >>
> >> mode  = 768x576
> >> depth = 32
> >> pixelformat=ARGB
> >>
> >> My hardware is a nvidia tnt2 M64.
> >> The framebuffer module I use is nvidiafb
> >>
> >> In var/log/syslog I don't see anything strange.
> >>
> >> In the other hand if I start vdr with only -Pstreamdev-server the 
> >> clients can watch TV.
> >> In the server few days a go I use -vo fb: as output and It works.
> >>
> >> I supose the problem is related to the directfb configuration but... 
> >> why can I see osd and not TV?
> >>
> >> Thanks,
> >>
> >> Leo
> >> _______________________________________________
> >> Softdevice-devel mailing list
> >> Softdevice-devel at lists.berlios.de
> >> http://lists.berlios.de/mailman/listinfo/softdevice-devel
> >>
> >
> > _______________________________________________
> > Softdevice-devel mailing list
> > Softdevice-devel at lists.berlios.de
> > http://lists.berlios.de/mailman/listinfo/softdevice-devel
> >
> 
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/softdevice-devel
> 

-- 
Stefan Lucke


From leo at calidae.net  Fri Jun 16 10:08:17 2006
From: leo at calidae.net (=?ISO-8859-1?Q?Leo_M=E1rquez?=)
Date: Fri, 16 Jun 2006 10:08:17 +0200
Subject: [Softdevice-devel] witch softdevice output depending on hard
 and soft
In-Reply-To: <4491D52D.5090301@gmx.net>
References: <448FE494.5080908@calidae.net> <44904497.5020301@gmx.net> <449109D7.4050009@calidae.net> <4491D52D.5090301@gmx.net>
Message-ID: <449266F1.8010207@calidae.net>

Hi again,
>>>   
>>>       
>> I dont know in witch debian package are this headers included. I have
>> installled the xserver-xorg-dev package but it don't work for me.
>> The plugins compiles fine but the configure command of softdevice ignore
>> the --disable-xv and the ./configure commands that are relative to xv.
>>     
>
> I would assume that xserver-xorg-dev is the one you need, but maybe you
> also need some more. The softdevice also needs the headers of the x11
> extensions like XVideo, maybe that is still missing. If you upgrade to
> the cvs from today and use configure again you will get a more detailed
> report of why xv is disabled in the file config.log.
>   
I think that the packages I need are:

libxv-dev                     - X11 Video extension library (development 
headers)
libxv1                          - X11 Video extension library
libxv1-dbg                   - X11 Video extension library (debug package)

I have installed them and this is the config.log generated after run 
./configure --disable-vidix:

Parameters '--disable-vidix'
PKG_CONFIG_PATH '/usr/local/lib/pkgconfig'
Checking for ffmpeg.------------------------------------
try to use pkg-config.
-lpostproc
Checking for DirectFB and DFB++.------------------
/tmp/softdevice-conf-1926-8428-5600.c: In function 'int main()':
/tmp/softdevice-conf-1926-8428-5600.c:5: error: 'DSBLIT_INTERLACED' was 
not declared in this scope
Checking for vidix.------------------------
Checking for Xv.-----------------------------
/usr/bin/ld: cannot find -lXi
collect2: ld returned 1 exit status
Checking for Xinerama.-----------------------------

It seems that not found vx headers. There is a way to indicate the xv path?
If I make a 'dpkg - L libxv-dev I see:

/usr
/usr/share
/usr/share/doc
/usr/share/doc/libxv-dev
/usr/share/doc/libxv-dev/changelog.Debian.gz
/usr/include
/usr/include/X11
/usr/include/X11/extensions
/usr/include/X11/extensions/Xvlib.h
/usr/lib
/usr/lib/libXv.a
/usr/lib/pkgconfig
/usr/lib/pkgconfig/xv.pc
/usr/lib/libXv.so


Thanks,

Leo
> Bye,
> Martin
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/softdevice-devel
>
>   



From rahrenbe at cc.hut.fi  Fri Jun 16 17:40:17 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Fri, 16 Jun 2006 18:40:17 +0300 (EEST)
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <4491DDA4.7040106@gmx.net>
References: <447B51B7.8070504@gmx.net> <200606140041.37079.stefan@lucke.in-berlin.de>
 <44904706.5010707@gmx.net> <Pine.OSF.4.61.0606142228120.334744@kosh.hut.fi>
 <44919D57.8010408@gmx.net> <Pine.OSF.4.61.0606160005070.468619@kosh.hut.fi>
 <4491DDA4.7040106@gmx.net>
Message-ID: <Pine.OSF.4.61.0606161837080.403697@kosh.hut.fi>

On Fri, 16 Jun 2006, Martin Wache wrote:

> I tried the changes again, unfortunately for me the cpu load is still high.
> I must say that I'm a bit lost... I've already fixed the last issues
> with the buffering, so in principle the patches would be ready to be
> merged. But I don't like the idea of merging the patches when they
> actually increase the cpu load instead of reducing it.

If you could provide your latest patches against the current cvs, I 
could test them on my system...

BR,
--
rofa


From stefan at lucke.in-berlin.de  Fri Jun 16 18:37:16 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Fri, 16 Jun 2006 18:37:16 +0200
Subject: [Softdevice-devel] Incorrect aspect ratio for some streams
In-Reply-To: <200606142127.09736.laz@club-burniston.co.uk>
References: <200606011544.01943.laz@club-burniston.co.uk> <200606140036.03105.stefan@lucke.in-berlin.de> <200606142127.09736.laz@club-burniston.co.uk>
Message-ID: <200606161837.16605.stefan@lucke.in-berlin.de>

On Mittwoch 14 Juni 2006 22:27, Laz wrote:
> On Tuesday 13 June 2006 23:36, Stefan Lucke wrote:
> > On Freitag 02 Juni 2006 11:12, Laz wrote:
> 
> > > It is a 4:3 picture transmitted with black borders at the left and right
> > > to make it up to 16:9 frame size. With viatv output, it is being squashed
> > > sideways into the size of a 4:3 frame (keeping the black borders), so
> > > that the picture itself is squashed sideways.
> >
> > Can you check your via chip revision number ?
> > From Readme.txt of unichrome/ :
> > * There are different hardware variants of the Unichrome chips.  Since
> >   the revision number can only be read by superuser processes, a utility
> >   'find_revision.sh' is provided.  The value it reports should be used
> >   in /etc/directfbrc in a line of the form 'unichrome-revision=xx'.
> >
> >   Symptoms of an incorrect revision number are corrupt images on the
> >   video overlay layer or incorrect colors when using YUY2 or YV12
> >   pixel formats.
> 

> 
> The only time I see incorrect colours is if I select YV12, when I get a bluish 
> tinge but I think it has always done this for that format.
> 
> I haven't really had a chance to work out how the aspect-ratio code works yet 
> but this is some of the output I got from a few additional printfs (for the 
> two streams I gave to Stefan):
> 
> 4:3 aspect ratio picture which has been cropped before transmission and 
> displays correctly:
> 
> newaspect: AFD = 0; afd_asp: 1.333333; new_asp: 1.333333
> [VideoOut]: 720x576 [0,0 720x576] -> 720x576 [90,0 540x576]
> [dfb] (re)configuring Videolayer to 720 x 576 (720x576)
> 
> 
> 4:3 aspect ratio with added borders to bring it up to a full 16:9 frame. 
> Shouldn't be scaled for a 16:9 TV but for me is squashed sideways into a 4:3 
> framesize:
> 
> newaspect: AFD = 1; afd_asp: 1.333333; new_asp: 1.777778
> [VideoOut]: 720x576 [90,0 540x576] -> 720x576 [90,0 540x576]
> [dfb] (re)configuring Videolayer to 720 x 576 (540x576)
> 

All these number are OK. But for some reason zooming and stretching
doesn't work too. Usually I get some warning like this on startup:

[surface capabilities] osdSurface: videoonly double-buffered flipping PixelFormat = 0x00418c04
 (!!!)  *** WARNING [letting unprivileged IDirectFBDisplayLayer::GetSurface() call pass until cooperative level handling is finished] *** [idirectfbdisplaylayer.c:170 in IDirectFBDisplayLayer_GetSurface()]
[surface capabilities] videoSurface: videoonly PixelFormat = 0x0810060a

Now they don't appear anymore and zooming and stretching works. People
in your sample (the "bad" one) stream, are not as tall as previously :-) .

Can you try attached patch ?

> The AFDs and aspect look OK to me, i.e. both are 4:3 images (afd_asp) and the 
> aspect ratio should be 4:3 and 16:9, as required. However, the second one is 
> being scaled (second line). This was only a quick test but the VideoOut bit 
> is the bit I need to study more to try to track this down.
> 

@ALL:

I guess the minium changeset for HW-decoding cpu consumption must be
reevaluated as the layconfiguration was not correct.

-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: via_aspect_fix_01.patch
Type: text/x-diff
Size: 1168 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060616/c93e5616/attachment.patch>

From stefan at lucke.in-berlin.de  Sat Jun 17 00:14:30 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 17 Jun 2006 00:14:30 +0200
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <44904706.5010707@gmx.net>
References: <447B51B7.8070504@gmx.net> <200606140041.37079.stefan@lucke.in-berlin.de> <44904706.5010707@gmx.net>
Message-ID: <200606170014.30484.stefan@lucke.in-berlin.de>

On Mittwoch 14 Juni 2006 19:27, Martin Wache wrote:
> Stefan Lucke schrieb:
> > On Montag 29 Mai 2006 21:55, Martin Wache wrote:

> > 
> > @@ -1454,8 +1485,8 @@
> >  #endif
> >  
> >        }
> > -      //scrSurface->Flip(NULL, (setupStore->useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
> > -      scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
> > +      scrSurface->Flip(NULL, (setupStore->useMGAtv) ? DSFLIP_WAITFORSYNC:DSFLIP_ONSYNC);
> > +      //scrSurface->Flip(NULL, DSFLIP_WAITFORSYNC);
> >  
> >      }
> >      else
> > 
> > This hunk may cause effects you noticed. But this is a rather sensible change and
> > should be delayed until the software blit issue is resolved.
> > 
> I don't mind..
> 

I'm just merging this (Rolf's one) for myself and noticed that this hunk 
is on the stretchblit path. That shouldn't be executed in this case !


-- 
Stefan Lucke


From M.Wache at gmx.net  Sat Jun 17 10:02:28 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sat, 17 Jun 2006 10:02:28 +0200
Subject: [Softdevice-devel] witch softdevice output depending on hard
 and soft
In-Reply-To: <449266F1.8010207@calidae.net>
References: <448FE494.5080908@calidae.net> <44904497.5020301@gmx.net> <449109D7.4050009@calidae.net> <4491D52D.5090301@gmx.net> <449266F1.8010207@calidae.net>
Message-ID: <4493B714.7060302@gmx.net>

Leo M?rquez schrieb:
> Hi again,
>>>>         
>>> I dont know in witch debian package are this headers included. I have
>>> installled the xserver-xorg-dev package but it don't work for me.
>>> The plugins compiles fine but the configure command of softdevice ignore
>>> the --disable-xv and the ./configure commands that are relative to xv.
>>>     
>>
>> I would assume that xserver-xorg-dev is the one you need, but maybe you
>> also need some more. The softdevice also needs the headers of the x11
>> extensions like XVideo, maybe that is still missing. If you upgrade to
>> the cvs from today and use configure again you will get a more detailed
>> report of why xv is disabled in the file config.log.
>>   
> I think that the packages I need are:
> 
> libxv-dev                     - X11 Video extension library (development
> headers)
> libxv1                          - X11 Video extension library
> libxv1-dbg                   - X11 Video extension library (debug package)
> 
> I have installed them and this is the config.log generated after run
> ./configure --disable-vidix:
> 
> Parameters '--disable-vidix'
> PKG_CONFIG_PATH '/usr/local/lib/pkgconfig'
> Checking for ffmpeg.------------------------------------
> try to use pkg-config.
> -lpostproc
> Checking for DirectFB and DFB++.------------------
> /tmp/softdevice-conf-1926-8428-5600.c: In function 'int main()':
> /tmp/softdevice-conf-1926-8428-5600.c:5: error: 'DSBLIT_INTERLACED' was
> not declared in this scope
> Checking for vidix.------------------------
> Checking for Xv.-----------------------------
> /usr/bin/ld: cannot find -lXi
> collect2: ld returned 1 exit status
> Checking for Xinerama.-----------------------------
> 
> It seems that not found vx headers. There is a way to indicate the xv path?
> If I make a 'dpkg - L libxv-dev I see:
> 
No, the xv-headers are found, what is missing is an additional library
called Xi, you probably also need a package called libxi-dev or
something similar.

Bye,
Martin


From M.Wache at gmx.net  Sat Jun 17 10:21:05 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Sat, 17 Jun 2006 10:21:05 +0200
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <Pine.OSF.4.61.0606161837080.403697@kosh.hut.fi>
References: <447B51B7.8070504@gmx.net> <200606140041.37079.stefan@lucke.in-berlin.de> <44904706.5010707@gmx.net> <Pine.OSF.4.61.0606142228120.334744@kosh.hut.fi> <44919D57.8010408@gmx.net> <Pine.OSF.4.61.0606160005070.468619@kosh.hut.fi> <4491DDA4.7040106@gmx.net> <Pine.OSF.4.61.0606161837080.403697@kosh.hut.fi>
Message-ID: <4493BB71.5030702@gmx.net>

Rolf Ahrenberg schrieb:
> On Fri, 16 Jun 2006, Martin Wache wrote:
> 
>> I tried the changes again, unfortunately for me the cpu load is still
>> high.
>> I must say that I'm a bit lost... I've already fixed the last issues
>> with the buffering, so in principle the patches would be ready to be
>> merged. But I don't like the idea of merging the patches when they
>> actually increase the cpu load instead of reducing it.
> 
> If you could provide your latest patches against the current cvs, I
> could test them on my system...
> 
Sure, having more systems to test it is never a bad idea. I'm not sure
if I caught all the changes that you did on the patches, for some reason
 patch refused to apply your patch and also a diff of the diffs failed.

Bye,
Martin
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: cle266.patch
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060617/d59989ad/attachment.ksh>

From stefan at lucke.in-berlin.de  Sat Jun 17 10:27:26 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 17 Jun 2006 10:27:26 +0200
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <Pine.OSF.4.61.0606142228120.334744@kosh.hut.fi>
References: <447B51B7.8070504@gmx.net> <44904706.5010707@gmx.net> <Pine.OSF.4.61.0606142228120.334744@kosh.hut.fi>
Message-ID: <200606171027.26985.stefan@lucke.in-berlin.de>

On Mittwoch 14 Juni 2006 21:33, Rolf Ahrenberg wrote:
> On Wed, 14 Jun 2006, Martin Wache wrote:
> 
> > It would be nice if you could have a closer look at these issues, I'm a
> > bit short on time...
> 
> Well, I've attached a patch from my softdevice tree that really enables 
> the cle266 hw decoding (-vo dfb:viatv:cle266). Now the cpu load is again 
> down to ~30% (was ~55%) on my 1GHz EPIA.
> 

Ok, so I have to flood my version to the list too.

On my system (1GHz EPIA) cpu goes down from about 60% to 35%. System
load is general higher, as there is a vdr server running with 2 cinergyT2 
dvb-t cards in background.

In dfb section I added defines to select OLD version of code I'm in doubt.
All defines OLD_VERSION_0[123] are set to 1 (use the old version). If
someone notice troubles, each of them could be set to 0 separately.

YV12 vs I420:
Handling of these formats is a mess in DirectFB. For one card is has
to be set to I420 and for the other to YV12 to get colors correct displayed.

So now for via without HW-decoding is has to set to I420 and with 
HW-decoding it has to be set to YV12. If it is set the _wrong_ way,
you'll get wrong colors without HW-dec or high cpu load with HW-dec.
Stretchblit should be disabled in any case for via.

-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: cle266-02.patch.bz2
Type: application/x-bzip2
Size: 6133 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060617/2e6e3d69/attachment.bin>

From rahrenbe at cc.hut.fi  Sat Jun 17 14:05:55 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Sat, 17 Jun 2006 15:05:55 +0300 (EEST)
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <4493BB71.5030702@gmx.net>
References: <447B51B7.8070504@gmx.net> <200606140041.37079.stefan@lucke.in-berlin.de>
 <44904706.5010707@gmx.net> <Pine.OSF.4.61.0606142228120.334744@kosh.hut.fi>
 <44919D57.8010408@gmx.net> <Pine.OSF.4.61.0606160005070.468619@kosh.hut.fi>
 <4491DDA4.7040106@gmx.net> <Pine.OSF.4.61.0606161837080.403697@kosh.hut.fi>
 <4493BB71.5030702@gmx.net>
Message-ID: <Pine.OSF.4.61.0606171501360.352980@kosh.hut.fi>

On Sat, 17 Jun 2006, Martin Wache wrote:

> Sure, having more systems to test it is never a bad idea. I'm not sure
> if I caught all the changes that you did on the patches, for some reason
> patch refused to apply your patch and also a diff of the diffs failed.

OK. I've attached my modifications over your patch (some configuration 
stuff and the forced pixelFormat), that makes your patch working on my 
setup too.

BR,
--
rofa
-------------- next part --------------
diff -Nru softdevice-cvs-20060617-cle266-martin/Makefile softdevice-cvs-20060617-cle266-martin-fixed/Makefile
--- softdevice-cvs-20060617-cle266-martin/Makefile	2006-06-17 13:54:17.000000000 +0300
+++ softdevice-cvs-20060617-cle266-martin-fixed/Makefile	2006-06-17 14:51:58.000000000 +0300
@@ -151,7 +151,7 @@
 ifdef CLE266_SUPPORT
   CLE266_LIBS = -L/usr/local/lib -lcle266mpegdec
   CLE266_CFLAGS = -I/usr/local/include
-  DEFINES  += -DHAVE_CLE266_MPEG_DECODER
+  DEFINES  += -DHAVE_CLE266_MPEG_DECODER -DFBDEV=\"$(FBDEV)\"
 endif
 
 ifdef XV_SUPPORT
diff -Nru softdevice-cvs-20060617-cle266-martin/configure softdevice-cvs-20060617-cle266-martin-fixed/configure
--- softdevice-cvs-20060617-cle266-martin/configure	2006-06-17 13:54:17.000000000 +0300
+++ softdevice-cvs-20060617-cle266-martin-fixed/configure	2006-06-17 14:53:12.000000000 +0300
@@ -271,9 +271,9 @@
 #
 if test "${dfb}" = "yes" ; then
 echo -n "Checking for cle266mpegdec... "
-cle266_cflags=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --cflags cle266mpegdec 2>>config.log` || cle266="no"
+cle266_cflags=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --cflags libcle266mpegdec 2>>config.log` || cle266="no"
   if test "${cle266}" = "yes" ; then
-  cle266_libs=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --libs cle266mpegdec`
+  cle266_libs=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --libs libcle266mpegdec`
   cle266_opts="${cle266_cflags} ${cle266_libs}"
   fi
 
@@ -453,6 +453,7 @@
 if test "${cle266}" = "yes" ; then
   echo "CLE266_LIBS = ${cle266_libs}" >> $TMPM
   echo "CLE266_CFLAGS = -DHAVE_CLE266_MPEG_DECODER ${cle266_cflags}" >> $TMPM
+  echo "#define FBDEV \"${fb_dev_name}\"" >> $TMPH
 fi
 
 ###############################################################################
diff -Nru softdevice-cvs-20060617-cle266-martin/setup-softdevice-menu.c softdevice-cvs-20060617-cle266-martin-fixed/setup-softdevice-menu.c
--- softdevice-cvs-20060617-cle266-martin/setup-softdevice-menu.c	2006-06-17 13:53:11.000000000 +0300
+++ softdevice-cvs-20060617-cle266-martin-fixed/setup-softdevice-menu.c	2006-06-17 14:46:15.000000000 +0300
@@ -356,7 +356,7 @@
   Add(new cOsdItem(" ", osUnknown));
 #endif
 
-  if (data->outputMethod == VOUT_DFB || data->outputMethod == VOUT_VIDIX)
+  if ((data->outputMethod == VOUT_DFB || data->outputMethod == VOUT_VIDIX) && !data->cle266HWdecode)
   {
     Add(new cMenuEditStraItem(tr("Pixel Format"),
                               &data->pixelFormat,
diff -Nru softdevice-cvs-20060617-cle266-martin/setup-softdevice.c softdevice-cvs-20060617-cle266-martin-fixed/setup-softdevice.c
--- softdevice-cvs-20060617-cle266-martin/setup-softdevice.c	2006-06-17 13:54:17.000000000 +0300
+++ softdevice-cvs-20060617-cle266-martin-fixed/setup-softdevice.c	2006-06-17 14:54:04.000000000 +0300
@@ -282,9 +282,12 @@
     fprintf(stderr,"[setup-softdevice] Expanding %d columns at left and right\n",
             expandLeftRightCols);
   } else if (!strcasecmp(Name,"PixelFormat")) {
+#ifdef HAVE_CLE266_MPEG_DECODER
+    pixelFormat = 1;
+#else
     pixelFormat = atoi(Value);
     pixelFormat = clamp (0, pixelFormat, 2);
-
+#endif
     fprintf (stderr,
              "[setup-softdevice] pixel format set to (%s)\n",
              pix_fmt [pixelFormat]);
diff -Nru softdevice-cvs-20060617-cle266-martin/softdevice.c softdevice-cvs-20060617-cle266-martin-fixed/softdevice.c
--- softdevice-cvs-20060617-cle266-martin/softdevice.c	2006-06-17 13:54:17.000000000 +0300
+++ softdevice-cvs-20060617-cle266-martin-fixed/softdevice.c	2006-06-17 13:58:58.000000000 +0300
@@ -806,10 +806,11 @@
             setupStore.viaTv = 1;
             fprintf(stderr,"[softdevice] enabling field parity\n");
 #ifdef HAVE_CLE266_MPEG_DECODER
-          } else if (!strncmp (vo_argv, "cle266", 6)) {
-            //setupStore.viaTv = 1;
-            setupStore.cle266HWdecode = 1;
-            fprintf(stderr,"[softdevice] enabling CLE266 HW decoding\n");
+            vo_argv += 5;
+            if (!strncmp (vo_argv, ":cle266", 7)) {
+              setupStore.cle266HWdecode = 1;
+              fprintf(stderr,"[softdevice] enabling CLE266 HW decoding\n");
+            }
 #endif // HAVE_CLE266_MPEG_DECODER
           } else if (!strncmp (vo_argv, "triple", 6)) {
             setupStore.tripleBuffering = 1;
diff -Nru softdevice-cvs-20060617-cle266-martin/video-dfb.c softdevice-cvs-20060617-cle266-martin-fixed/video-dfb.c
--- softdevice-cvs-20060617-cle266-martin/video-dfb.c	2006-06-17 13:54:17.000000000 +0300
+++ softdevice-cvs-20060617-cle266-martin-fixed/video-dfb.c	2006-06-17 13:55:17.000000000 +0300
@@ -370,8 +370,7 @@
               setupStore->cle266HWdecode = false;
           } else {
               // Need YV12 pixel format for blitting from harware buffer
-              currentPixelFormat = setupStore->pixelFormat = 0;
-              //currentPixelFormat = setupStore->pixelFormat = 1;
+              currentPixelFormat = setupStore->pixelFormat = 1;
           }
       }
 #endif // HAVE_CLE266_MPEG_DECODER

From stefan at lucke.in-berlin.de  Sat Jun 17 15:09:32 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 17 Jun 2006 15:09:32 +0200
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <Pine.OSF.4.61.0606171501360.352980@kosh.hut.fi>
References: <447B51B7.8070504@gmx.net> <4493BB71.5030702@gmx.net> <Pine.OSF.4.61.0606171501360.352980@kosh.hut.fi>
Message-ID: <200606171509.32867.stefan@lucke.in-berlin.de>

On Samstag 17 Juni 2006 14:05, Rolf Ahrenberg wrote:
> On Sat, 17 Jun 2006, Martin Wache wrote:
> 
> > Sure, having more systems to test it is never a bad idea. I'm not sure
> > if I caught all the changes that you did on the patches, for some reason
> > patch refused to apply your patch and also a diff of the diffs failed.
> 
> OK. I've attached my modifications over your patch (some configuration 
> stuff and the forced pixelFormat), that makes your patch working on my 
> setup too.

We should break patches into several smaller peaces.

diff -Nru softdevice-cvs-20060617-cle266-martin/setup-softdevice-menu.c softdevice-cvs-20060617-cle266-martin-fixed/setup-softdevice-menu.c
--- softdevice-cvs-20060617-cle266-martin/setup-softdevice-menu.c       2006-06-17 13:53:11.000000000 +0300
+++ softdevice-cvs-20060617-cle266-martin-fixed/setup-softdevice-menu.c 2006-06-17 14:46:15.000000000 +0300
@@ -356,7 +356,7 @@
   Add(new cOsdItem(" ", osUnknown));
 #endif
 
-  if (data->outputMethod == VOUT_DFB || data->outputMethod == VOUT_VIDIX)
+  if ((data->outputMethod == VOUT_DFB || data->outputMethod == VOUT_VIDIX) && !data->cle266HWdecode)
   {
     Add(new cMenuEditStraItem(tr("Pixel Format"),
                               &data->pixelFormat,

That is ok. Don't offer pixelformat selection when in HW-decoder mode. It 
implies that this cSetupStore member is a permanent one and not protected
by ifdefs. Otherwise we would need a ifdef here too. Changing stretchblit 
shouldn't be offered too when cle266HWdecode == 1 .

diff -Nru softdevice-cvs-20060617-cle266-martin/setup-softdevice.c softdevice-cvs-20060617-cle266-martin-fixed/setup-softdevice.c
--- softdevice-cvs-20060617-cle266-martin/setup-softdevice.c    2006-06-17 13:54:17.000000000 +0300
+++ softdevice-cvs-20060617-cle266-martin-fixed/setup-softdevice.c      2006-06-17 14:54:04.000000000 +0300
@@ -282,9 +282,12 @@
     fprintf(stderr,"[setup-softdevice] Expanding %d columns at left and right\n",
             expandLeftRightCols);
   } else if (!strcasecmp(Name,"PixelFormat")) {
+#ifdef HAVE_CLE266_MPEG_DECODER
+    pixelFormat = 1;
+#else
     pixelFormat = atoi(Value);
     pixelFormat = clamp (0, pixelFormat, 2);
-
+#endif
     fprintf (stderr,
              "[setup-softdevice] pixel format set to (%s)\n",
              pix_fmt [pixelFormat]);

No. This would force YV12 pixelformat whenever HAVE_CLE266_MPEG_DECODER
is detected. But without option cle266 we need I420, right ?

In video-dfb.c we have to force stretchblit = 0 and pixelformat = 1 in constructor

-- 
Stefan Lucke


From rahrenbe at cc.hut.fi  Sat Jun 17 16:20:23 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Sat, 17 Jun 2006 17:20:23 +0300 (EEST)
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <200606171509.32867.stefan@lucke.in-berlin.de>
References: <447B51B7.8070504@gmx.net> <4493BB71.5030702@gmx.net>
 <Pine.OSF.4.61.0606171501360.352980@kosh.hut.fi> <200606171509.32867.stefan@lucke.in-berlin.de>
Message-ID: <Pine.OSF.4.61.0606171708480.447856@kosh.hut.fi>

On Sat, 17 Jun 2006, Stefan Lucke wrote:

> No. This would force YV12 pixelformat whenever HAVE_CLE266_MPEG_DECODER
> is detected. But without option cle266 we need I420, right ?
> In video-dfb.c we have to force stretchblit = 0 and pixelformat = 1 in constructor

Yes, my mistake. The forced pixelformat setting should be enabled only 
if "cle266HWdecode" is set. I placed it into setup's parse method just 
to make sure that the setting in setup.conf doesn't have any effect.

Anyway, the patch is quite ready (IMHO) to be included into cvs and all 
those little annoyances can corrected later on.

BR,
--
rofa


From stefan at lucke.in-berlin.de  Sat Jun 17 18:31:53 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 17 Jun 2006 18:31:53 +0200
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <Pine.OSF.4.61.0606171708480.447856@kosh.hut.fi>
References: <447B51B7.8070504@gmx.net> <200606171509.32867.stefan@lucke.in-berlin.de> <Pine.OSF.4.61.0606171708480.447856@kosh.hut.fi>
Message-ID: <200606171831.53086.stefan@lucke.in-berlin.de>

On Samstag 17 Juni 2006 16:20, Rolf Ahrenberg wrote:
> On Sat, 17 Jun 2006, Stefan Lucke wrote:
> 
> > No. This would force YV12 pixelformat whenever HAVE_CLE266_MPEG_DECODER
> > is detected. But without option cle266 we need I420, right ?
> > In video-dfb.c we have to force stretchblit = 0 and pixelformat = 1 in constructor
> 
> Yes, my mistake. The forced pixelformat setting should be enabled only 
> if "cle266HWdecode" is set. I placed it into setup's parse method just 
> to make sure that the setting in setup.conf doesn't have any effect.
> 
> Anyway, the patch is quite ready (IMHO) to be included into cvs and all 
> those little annoyances can corrected later on.

Yes. In cvs, so we can talk in smaller patches.
I left out disabling pixelformat and stretchblit, until we are sure
of the right/fastest one.

-- 
Stefan Lucke


From rahrenbe at cc.hut.fi  Sat Jun 17 19:00:47 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Sat, 17 Jun 2006 20:00:47 +0300 (EEST)
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <200606171831.53086.stefan@lucke.in-berlin.de>
References: <447B51B7.8070504@gmx.net> <200606171509.32867.stefan@lucke.in-berlin.de>
 <Pine.OSF.4.61.0606171708480.447856@kosh.hut.fi> <200606171831.53086.stefan@lucke.in-berlin.de>
Message-ID: <Pine.OSF.4.61.0606171954550.347215@kosh.hut.fi>

On Sat, 17 Jun 2006, Stefan Lucke wrote:

> Yes. In cvs, so we can talk in smaller patches.
> I left out disabling pixelformat and stretchblit, until we are sure
> of the right/fastest one.

Could add also this little patch into cvs? The current configure script 
won't detect cle266mpegdec library without the patch.

Howabout removing the cle266 commandline parameter and add an "hardware 
decoding: yes/no" option into setup menu?

--
rofa
-------------- next part --------------
Index: Makefile
===================================================================
RCS file: /cvsroot/softdevice/softdevice/Makefile,v
retrieving revision 1.31
diff -u -r1.31 Makefile
--- Makefile	17 Jun 2006 16:27:34 -0000	1.31
+++ Makefile	17 Jun 2006 16:52:03 -0000
@@ -151,7 +151,7 @@
 ifdef CLE266_SUPPORT
   CLE266_LIBS = -L/usr/local/lib -lcle266mpegdec
   CLE266_CFLAGS = -I/usr/local/include
-  DEFINES  += -DHAVE_CLE266_MPEG_DECODER
+  DEFINES += -DFBDEV=\"$(FBDEV)\" -DHAVE_CLE266_MPEG_DECODER
 endif
 
 ifdef XV_SUPPORT
Index: configure
===================================================================
RCS file: /cvsroot/softdevice/softdevice/configure,v
retrieving revision 1.17
diff -u -r1.17 configure
--- configure	17 Jun 2006 16:27:34 -0000	1.17
+++ configure	17 Jun 2006 16:52:03 -0000
@@ -48,6 +48,7 @@
   echo "  --disable-subplugins"
   echo "  --disable-mmx"
   echo "  --disable-mmx2"
+  echo "  --with-fb-device YOUR_FB_DEVICE"
   echo "  --with-ffmpeg-path YOUR_FFMPEG_PATH"
   echo "  --with-vidix-path YOUR_VIDIX_PATH"
   echo "  --help"
@@ -67,6 +68,10 @@
     --disable-subplugins) shift; with_subplugins="no" ;;
     --disable-mmx) shift; with_mmx="no";;
     --disable-mmx2) shift; with_mmx2="no";;
+    --with-fb-device) shift;
+      fb_dev_name=$1 ;
+      echo "framebuffer device set to: $fb_dev_name" ;
+      shift ;;
     --with-ffmpeg-path) shift;
       ffmpeg_path=$1 ;
       echo "ffmpeg path set to: $ffmpeg_path" ;
@@ -271,9 +276,9 @@
 #
 if test "${dfb}" = "yes" ; then
 echo -n "Checking for cle266mpegdec... "
-cle266_cflags=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --cflags cle266mpegdec 2>>config.log` || cle266="no"
+cle266_cflags=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --cflags libcle266mpegdec 2>>config.log` || cle266="no"
   if test "${cle266}" = "yes" ; then
-  cle266_libs=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --libs cle266mpegdec`
+  cle266_libs=`PKG_CONFIG_PATH=$PKG_CONFIG_PATH pkg-config --libs libcle266mpegdec`
   cle266_opts="${cle266_cflags} ${cle266_libs}"
   fi
 
@@ -453,6 +458,7 @@
 if test "${cle266}" = "yes" ; then
   echo "CLE266_LIBS = ${cle266_libs}" >> $TMPM
   echo "CLE266_CFLAGS = -DHAVE_CLE266_MPEG_DECODER ${cle266_cflags}" >> $TMPM
+  echo "#define FBDEV \"${fb_dev_name}\"" >> $TMPH
 fi
 
 ###############################################################################

From stefan at lucke.in-berlin.de  Sat Jun 17 21:32:10 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 17 Jun 2006 21:32:10 +0200
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <Pine.OSF.4.61.0606171954550.347215@kosh.hut.fi>
References: <447B51B7.8070504@gmx.net> <200606171831.53086.stefan@lucke.in-berlin.de> <Pine.OSF.4.61.0606171954550.347215@kosh.hut.fi>
Message-ID: <200606172132.10160.stefan@lucke.in-berlin.de>

On Samstag 17 Juni 2006 19:00, Rolf Ahrenberg wrote:
> On Sat, 17 Jun 2006, Stefan Lucke wrote:
> 
> > Yes. In cvs, so we can talk in smaller patches.
> > I left out disabling pixelformat and stretchblit, until we are sure
> > of the right/fastest one.
> 
> Could add also this little patch into cvs? The current configure script 
> won't detect cle266mpegdec library without the patch.

Ah, libcle.. vs. cle.. . Thats ok. With your patch is was libcle.. an with Martin's
one, just cle . As I've both now, I didn't noticed the difference.
That part is in cvs.

Hardcoded framebuffer device name is one thing which is not optimal.

DirectFBs logic is: 
1. get the name from config file
2. look for enviroment variable FRAMEBUFFER
3. probe /dev/fb0 or /dev/fb/0

2. and 3. is what we should do too. But in DirectFB, config file has higher
precedence of enviroment variable and so it cannot be overwritten :-( .

> 
> Howabout removing the cle266 commandline parameter and add an "hardware 
> decoding: yes/no" option into setup menu?

Can we delay that until we have an other hardware support feature ?
Or do you want to switch that on the fly ?


-- 
Stefan Lucke


From rahrenbe at cc.hut.fi  Sat Jun 17 21:55:41 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Sat, 17 Jun 2006 22:55:41 +0300 (EEST)
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <200606172132.10160.stefan@lucke.in-berlin.de>
References: <447B51B7.8070504@gmx.net> <200606171831.53086.stefan@lucke.in-berlin.de>
 <Pine.OSF.4.61.0606171954550.347215@kosh.hut.fi> <200606172132.10160.stefan@lucke.in-berlin.de>
Message-ID: <Pine.OSF.4.61.0606172244210.337021@kosh.hut.fi>

On Sat, 17 Jun 2006, Stefan Lucke wrote:

> Hardcoded framebuffer device name is one thing which is not optimal.
> DirectFBs logic is:
> 1. get the name from config file
> 2. look for enviroment variable FRAMEBUFFER
> 3. probe /dev/fb0 or /dev/fb/0
> 2. and 3. is what we should do too. But in DirectFB, config file has higher
> precedence of enviroment variable and so it cannot be overwritten :-( .

Anyway, you cannot now specify it by configure and Makefile won't add 
the FBDEV define into cflags if you've disabled fb or vidix 
support. So currently none of the mentioned logic doesn't work.

>> Howabout removing the cle266 commandline parameter and add an "hardware
>> decoding: yes/no" option into setup menu?
> Or do you want to switch that on the fly ?

Yes, It would be very convenient to switch between software and hardware 
decoding on the fly.

--
rofa


From stefan at lucke.in-berlin.de  Sat Jun 17 22:46:10 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sat, 17 Jun 2006 22:46:10 +0200
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <Pine.OSF.4.61.0606172244210.337021@kosh.hut.fi>
References: <447B51B7.8070504@gmx.net> <200606172132.10160.stefan@lucke.in-berlin.de> <Pine.OSF.4.61.0606172244210.337021@kosh.hut.fi>
Message-ID: <200606172246.10647.stefan@lucke.in-berlin.de>

On Samstag 17 Juni 2006 21:55, Rolf Ahrenberg wrote:
> On Sat, 17 Jun 2006, Stefan Lucke wrote:
> 
> > Hardcoded framebuffer device name is one thing which is not optimal.
> > DirectFBs logic is:
> > 1. get the name from config file
> > 2. look for enviroment variable FRAMEBUFFER
> > 3. probe /dev/fb0 or /dev/fb/0
> > 2. and 3. is what we should do too. But in DirectFB, config file has higher
> > precedence of enviroment variable and so it cannot be overwritten :-( .
> 
> Anyway, you cannot now specify it by configure and Makefile won't add 
> the FBDEV define into cflags if you've disabled fb or vidix 
> support. So currently none of the mentioned logic doesn't work.
> 

You can _now_ as described above (2. & 3.) .

> >> Howabout removing the cle266 commandline parameter and add an "hardware
> >> decoding: yes/no" option into setup menu?
> > Or do you want to switch that on the fly ?
> 
> Yes, It would be very convenient to switch between software and hardware 
> decoding on the fly.

Let's first get current modification stable.

-- 
Stefan Lucke


From rahrenbe at cc.hut.fi  Sun Jun 18 00:45:24 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Sun, 18 Jun 2006 01:45:24 +0300 (EEST)
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <200606172246.10647.stefan@lucke.in-berlin.de>
References: <447B51B7.8070504@gmx.net> <200606172132.10160.stefan@lucke.in-berlin.de>
 <Pine.OSF.4.61.0606172244210.337021@kosh.hut.fi> <200606172246.10647.stefan@lucke.in-berlin.de>
Message-ID: <Pine.OSF.4.61.0606180138160.520397@kosh.hut.fi>

On Sat, 17 Jun 2006, Stefan Lucke wrote:

> You can _now_ as described above (2. & 3.) .

Thanks.

> Let's first get current modification stable.

Ok. The cle266 option doesn't currently set 'viaTv', that's used to 
enable field parity for Unichrome. Is this intentional?

--
rofa


From stefan at lucke.in-berlin.de  Sun Jun 18 01:09:33 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 18 Jun 2006 01:09:33 +0200
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <Pine.OSF.4.61.0606180138160.520397@kosh.hut.fi>
References: <447B51B7.8070504@gmx.net> <200606172246.10647.stefan@lucke.in-berlin.de> <Pine.OSF.4.61.0606180138160.520397@kosh.hut.fi>
Message-ID: <200606180109.34111.stefan@lucke.in-berlin.de>

On Sonntag 18 Juni 2006 00:45, Rolf Ahrenberg wrote:
> On Sat, 17 Jun 2006, Stefan Lucke wrote:
> 
> > You can _now_ as described above (2. & 3.) .
> 
> Thanks.
> 
> > Let's first get current modification stable.
> 
> Ok. The cle266 option doesn't currently set 'viaTv', that's used to 
> enable field parity for Unichrome. Is this intentional?

Yes, as I guess you can specify -vo:dfb:cle266:viatv or -vo:dfb:viatv:cle266 .
If that doesn't work, we have to change something.

-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Sun Jun 18 09:44:30 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 18 Jun 2006 09:44:30 +0200
Subject: [Softdevice-devel] cle266 HW decode, author of DirectFB, DFB++ patch ?
Message-ID: <200606180944.30307.stefan@lucke.in-berlin.de>

So now that we have the first version fo harware decode support
in softdevice cvs, it would be nice to have the required patch for 
directfb in DirectFB's cvs too. The original author of the patches 
should give his OK for doing this (for coyright reasons).

For reviewing I'll attach them now.

A more efficient way could be done when the final blit from the 
decoded data to videolayer could be dropped. But this will require
another change to DirectFB: A surface with N backbuffers
(3 back + 1 front) in this case and flipping to a dedicated 
backbuffer [0 .. 3].

-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: GetFBOffset.patch
Type: text/x-diff
Size: 2427 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060618/58609a11/attachment.patch>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: GetFBOffsetDFB++.patch
Type: text/x-diff
Size: 1577 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060618/58609a11/attachment-0001.patch>

From laz at club-burniston.co.uk  Sun Jun 18 12:28:17 2006
From: laz at club-burniston.co.uk (Laz)
Date: Sun, 18 Jun 2006 11:28:17 +0100
Subject: [Softdevice-devel] Re: [Softdevice-devel + directfb-dev] cle266 HW decode, author of DirectFB, DFB++ patch ?
In-Reply-To: <200606180944.30307.stefan@lucke.in-berlin.de>
References: <200606180944.30307.stefan@lucke.in-berlin.de>
Message-ID: <200606181128.17739.laz@club-burniston.co.uk>

On Sunday 18 June 2006 08:44, Stefan Lucke wrote:
> So now that we have the first version fo harware decode support
> in softdevice cvs, it would be nice to have the required patch for
> directfb in DirectFB's cvs too. The original author of the patches
> should give his OK for doing this (for coyright reasons).
>
> For reviewing I'll attach them now.

I'm not sure who the original author of these patches was but my best guess is 
that Andreas Robinson distributed the DirectFB patch with 'mtest'. Not as 
sure about the DFB++ patch: that may have been Nicolas Huillard (or maybe 
even me?!).

Rolf Ahrenberg made some newer versions to work better with more recent 
versions of DirectFB.

Cheers,

Laz 


From laz at club-burniston.co.uk  Sun Jun 18 12:54:58 2006
From: laz at club-burniston.co.uk (Laz)
Date: Sun, 18 Jun 2006 11:54:58 +0100
Subject: [Softdevice-devel] Incorrect aspect ratio for some streams
In-Reply-To: <200606161837.16605.stefan@lucke.in-berlin.de>
References: <200606011544.01943.laz@club-burniston.co.uk> <200606142127.09736.laz@club-burniston.co.uk> <200606161837.16605.stefan@lucke.in-berlin.de>
Message-ID: <200606181154.58360.laz@club-burniston.co.uk>

On Friday 16 June 2006 17:37, Stefan Lucke wrote:
> On Mittwoch 14 Juni 2006 22:27, Laz wrote:
> > I haven't really had a chance to work out how the aspect-ratio code works
> > yet but this is some of the output I got from a few additional printfs
> > (for the two streams I gave to Stefan):
> >
> > 4:3 aspect ratio picture which has been cropped before transmission and
> > displays correctly:
> >
> > newaspect: AFD = 0; afd_asp: 1.333333; new_asp: 1.333333
> > [VideoOut]: 720x576 [0,0 720x576] -> 720x576 [90,0 540x576]
> > [dfb] (re)configuring Videolayer to 720 x 576 (720x576)
> >
> >
> > 4:3 aspect ratio with added borders to bring it up to a full 16:9 frame.
> > Shouldn't be scaled for a 16:9 TV but for me is squashed sideways into a
> > 4:3 framesize:
> >
> > newaspect: AFD = 1; afd_asp: 1.333333; new_asp: 1.777778
> > [VideoOut]: 720x576 [90,0 540x576] -> 720x576 [90,0 540x576]
> > [dfb] (re)configuring Videolayer to 720 x 576 (540x576)
>
> All these number are OK. But for some reason zooming and stretching
> doesn't work too. Usually I get some warning like this on startup:
>
> [surface capabilities] osdSurface: videoonly double-buffered flipping
> PixelFormat = 0x00418c04 (!!!)  *** WARNING [letting unprivileged
> IDirectFBDisplayLayer::GetSurface() call pass until cooperative level
> handling is finished] *** [idirectfbdisplaylayer.c:170 in
> IDirectFBDisplayLayer_GetSurface()] [surface capabilities] videoSurface:
> videoonly PixelFormat = 0x0810060a
>
> Now they don't appear anymore and zooming and stretching works. People
> in your sample (the "bad" one) stream, are not as tall as previously :-) .
>
> Can you try attached patch ?

Not sure if it was the attached patch but current CVS has fixed the aspect 
ratio problem with that file.

:)

Laz


From rahrenbe at cc.hut.fi  Sun Jun 18 13:01:19 2006
From: rahrenbe at cc.hut.fi (Rolf Ahrenberg)
Date: Sun, 18 Jun 2006 14:01:19 +0300 (EEST)
Subject: [Softdevice-devel] Re: [Softdevice-devel + directfb-dev] cle266
 HW decode, author of DirectFB, DFB++ patch ?
In-Reply-To: <200606181128.17739.laz@club-burniston.co.uk>
References: <200606180944.30307.stefan@lucke.in-berlin.de>
 <200606181128.17739.laz@club-burniston.co.uk>
Message-ID: <Pine.OSF.4.61.0606181342070.323349@kosh.hut.fi>

On Sun, 18 Jun 2006, Laz wrote:

> I'm not sure who the original author of these patches was but my best guess is
> that Andreas Robinson distributed the DirectFB patch with 'mtest'. Not as
> sure about the DFB++ patch: that may have been Nicolas Huillard (or maybe
> even me?!).

According to these emails and archive, the original authors seems to be 
Andreas Robinson for the DirectFB patch (mtest) and Colin Paton for the 
DFB++ patch (libsoftmpeg-cle266): 
http://www.linuxtv.org/mailinglists/linuxtv-softmpeg/2004/03-2004/msg00031.html 
http://www.directfb.org/index.php/mailinglists/directfb-users/2004/03-2004/msg00002.html
http://cle266dfb.sourceforge.net/mtest-0.1.1.tar.gz
http://crp.pwp.blueyonder.co.uk/MPEG/libsoftmpeg-cle266-0.01.tgz

The next question is the libcle266mpegdec itself as it should be added 
into some kind of public version control (sourceforge, berlios). 
Any volunteers?

--
rofa


From laz at club-burniston.co.uk  Sun Jun 18 13:05:23 2006
From: laz at club-burniston.co.uk (Laz)
Date: Sun, 18 Jun 2006 12:05:23 +0100
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <200606180109.34111.stefan@lucke.in-berlin.de>
References: <447B51B7.8070504@gmx.net> <Pine.OSF.4.61.0606180138160.520397@kosh.hut.fi> <200606180109.34111.stefan@lucke.in-berlin.de>
Message-ID: <200606181205.23935.laz@club-burniston.co.uk>

On Sunday 18 June 2006 00:09, Stefan Lucke wrote:
> On Sonntag 18 Juni 2006 00:45, Rolf Ahrenberg wrote:
> > On Sat, 17 Jun 2006, Stefan Lucke wrote:
> > > You can _now_ as described above (2. & 3.) .
> >
> > Thanks.
> >
> > > Let's first get current modification stable.
> >
> > Ok. The cle266 option doesn't currently set 'viaTv', that's used to
> > enable field parity for Unichrome. Is this intentional?
>
> Yes, as I guess you can specify -vo:dfb:cle266:viatv or
> -vo:dfb:viatv:cle266 . If that doesn't work, we have to change something.

Nice work with integrating the CLE266 decoding stuff! When I last had a chance 
to test this, the aspect ratios were all incorrect but now it's sorted.

I have just checked out softdevice cvs and it is running nicely 
with "-vo:dfb:viatv:cle266". CPU usage like this is ca. 28% like this on a 1 
GHz Epia MII-12000. With "-vo:dfb:viatv", CPU usage is ca. 82% for the same 
channel.

I'll leave it on hardware decoding for now to see how it works long term... 
The only current issue so far is that the A-V sync isn't quite perfect but I 
think that is mainly down to the DirectFB triple buffering for the TV-out 
stuff.

Switching channels or starting/stopping a recording doesn't look as clean as 
with software decoding because I'm seeing block artifacts when the stream is 
changed. The decoder buffers probably clearing or the decoder needs resetting 
somewhere.

Looking good!

:)

Laz


From nicolas at huillard.net  Sun Jun 18 13:11:59 2006
From: nicolas at huillard.net (Nicolas Huillard)
Date: Sun, 18 Jun 2006 13:11:59 +0200
Subject: [Softdevice-devel] Re: [Softdevice-devel + directfb-dev] cle266
 HW decode, author of DirectFB, DFB++ patch ?
In-Reply-To: <200606181128.17739.laz@club-burniston.co.uk>
References: <200606180944.30307.stefan@lucke.in-berlin.de> <200606181128.17739.laz@club-burniston.co.uk>
Message-ID: <449534FF.5060903@huillard.net>

Laz a ?crit :
> I'm not sure who the original author of these patches was but my best guess is 
> that Andreas Robinson distributed the DirectFB patch with 'mtest'. Not as 
> sure about the DFB++ patch: that may have been Nicolas Huillard (or maybe 
> even me?!).

I didn't patch DirectFB (well, I think I didn't patch anything VDR
related this year). Did you ?

I'm still watching carefully what you all code regarding CLE266, and I'm
very happy to see it coming to life.
Thank you all !

-- 
NH


From torgeir at pobox.com  Sun Jun 18 13:56:49 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Sun, 18 Jun 2006 12:56:49 +0100
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <200606181205.23935.laz@club-burniston.co.uk>
References: <447B51B7.8070504@gmx.net>
	 <Pine.OSF.4.61.0606180138160.520397@kosh.hut.fi>
	 <200606180109.34111.stefan@lucke.in-berlin.de>
	 <200606181205.23935.laz@club-burniston.co.uk>
Message-ID: <1150631809.2462.9.camel@localhost>

On Sun, 2006-06-18 at 12:05 +0100, Laz wrote:
> 
> I have just checked out softdevice cvs and it is running nicely 
> with "-vo:dfb:viatv:cle266". CPU usage like this is ca. 28% like this
> on a 1 
> GHz Epia MII-12000. With "-vo:dfb:viatv", CPU usage is ca. 82% for the
> same 
> channel. 

Does this work just as good with higher resolutions without viatv? With
higher resolution I'm thinking about projector native resolutions such
as 1280x720 etc.
 
-- 
Torgeir Veimo <torgeir at pobox.com>



From laz at club-burniston.co.uk  Sun Jun 18 14:10:14 2006
From: laz at club-burniston.co.uk (Laz)
Date: Sun, 18 Jun 2006 13:10:14 +0100
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <1150631809.2462.9.camel@localhost>
References: <447B51B7.8070504@gmx.net> <200606181205.23935.laz@club-burniston.co.uk> <1150631809.2462.9.camel@localhost>
Message-ID: <200606181310.14609.laz@club-burniston.co.uk>

On Sunday 18 June 2006 12:56, Torgeir Veimo wrote:
> On Sun, 2006-06-18 at 12:05 +0100, Laz wrote:
> > I have just checked out softdevice cvs and it is running nicely
> > with "-vo:dfb:viatv:cle266". CPU usage like this is ca. 28% like this
> > on a 1
> > GHz Epia MII-12000. With "-vo:dfb:viatv", CPU usage is ca. 82% for the
> > same
> > channel.
>
> Does this work just as good with higher resolutions without viatv? With
> higher resolution I'm thinking about projector native resolutions such
> as 1280x720 etc.

I know that some parts of the decoder library are hard-coded to 720x576, as 
are the buffers used by the decoder. These could be changed, obviously, but 
I'm not sure whether there are any limits on the actual MPEG2 decoder chip 
itself.

For now, it'll only work at 720x576 and below (unless I've missed some 
changes). In the future, who knows. I'm not sure whether the Unichrome X 
driver provides hardware decoding for larger frames or not.

Cheers,

Laz


From torgeir at pobox.com  Sun Jun 18 14:14:58 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Sun, 18 Jun 2006 13:14:58 +0100
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <200606181310.14609.laz@club-burniston.co.uk>
References: <447B51B7.8070504@gmx.net>
	 <200606181205.23935.laz@club-burniston.co.uk>
	 <1150631809.2462.9.camel@localhost>
	 <200606181310.14609.laz@club-burniston.co.uk>
Message-ID: <1150632898.2462.11.camel@localhost>

On Sun, 2006-06-18 at 13:10 +0100, Laz wrote:
> 
> I know that some parts of the decoder library are hard-coded to
> 720x576, as are the buffers used by the decoder. These could be
> changed, obviously, but I'm not sure whether there are any limits on
> the actual MPEG2 decoder chip itself.

Surely it would involve just the scaler, no? I'm not interested in HDTV
playback yet.

-- 
Torgeir Veimo <torgeir at pobox.com>



From stefan at lucke.in-berlin.de  Sun Jun 18 20:39:31 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 18 Jun 2006 20:39:31 +0200
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <44904706.5010707@gmx.net>
References: <447B51B7.8070504@gmx.net> <200606140041.37079.stefan@lucke.in-berlin.de> <44904706.5010707@gmx.net>
Message-ID: <200606182039.31090.stefan@lucke.in-berlin.de>

On Mittwoch 14 Juni 2006 19:27, Martin Wache wrote:
> Stefan Lucke schrieb:

> > 
> > When using normal dfb-out I've another strange effect: video is visible
> > only when OSD is active. To resolve this for me, I commented out
> > line 362 (      //clearAlpha = 0xff;) .
> >
> I had a similar effect, but only after you fixed the alpha blending. It
> disappeared when I explicitly specified ARGB colorspace in the
> /etc/directfbrc.

Thanks, you are right. There was a silly "pixelformat=AiRGB" in
/etc/directfbrc instead of my usual "pixelformat=ARGB" .

-- 
Stefan Lucke


From stefan at lucke.in-berlin.de  Sun Jun 18 20:40:06 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 18 Jun 2006 20:40:06 +0200
Subject: [Softdevice-devel] DVB-T in H.264 in France and UK
In-Reply-To: <200606060653.38747.stefan@lucke.in-berlin.de>
References: <200606060653.38747.stefan@lucke.in-berlin.de>
Message-ID: <200606182040.06854.stefan@lucke.in-berlin.de>

On Dienstag 06 Juni 2006 06:53, Stefan Lucke wrote:
> Hi, 
> has anyone tried H.264 streams to play or record with vdr & softdevice
> in UK or France as discussed of linux-dvb list ?
> 
> http://www.linuxtv.org/pipermail/linux-dvb/2006-June/010679.html

No one from UK on this list ? Someone who can receive BBC 'Crystal Palace B' 
like mentioned here:
http://www.linuxtv.org/pipermail/linux-dvb/2006-June/010666.html

If vdr sets the video pids for such a transponder to zero, please try attached
patch. I don't know if we could decode it, since within vdr-mode (opposite
to softplay-mode) we are not in play-packet-mode (so many modes, bad english).

-- 
Stefan Lucke
-------------- next part --------------
A non-text attachment was scrubbed...
Name: vdr-H264-pat.c.patch
Type: text/x-diff
Size: 1218 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/softdevice-devel/attachments/20060618/4e3212be/attachment.patch>

From leo at calidae.net  Mon Jun 19 10:14:51 2006
From: leo at calidae.net (=?ISO-8859-1?Q?Leo_M=E1rquez?=)
Date: Mon, 19 Jun 2006 10:14:51 +0200
Subject: [Softdevice-devel] witch softdevice output depending on hard
 and soft
In-Reply-To: <4493B714.7060302@gmx.net>
References: <448FE494.5080908@calidae.net> <44904497.5020301@gmx.net> <449109D7.4050009@calidae.net> <4491D52D.5090301@gmx.net> <449266F1.8010207@calidae.net> <4493B714.7060302@gmx.net>
Message-ID: <44965CFB.9070106@calidae.net>

Hi,

Martin Wache wrote:
> Leo M?rquez schrieb:
>   
>> Hi again,
>>     
>>>>>         
>>>>>           
>>>> I dont know in witch debian package are this headers included. I have
>>>> installled the xserver-xorg-dev package but it don't work for me.
>>>> The plugins compiles fine but the configure command of softdevice ignore
>>>> the --disable-xv and the ./configure commands that are relative to xv.
>>>>     
>>>>         
>>> I would assume that xserver-xorg-dev is the one you need, but maybe you
>>> also need some more. The softdevice also needs the headers of the x11
>>> extensions like XVideo, maybe that is still missing. If you upgrade to
>>> the cvs from today and use configure again you will get a more detailed
>>> report of why xv is disabled in the file config.log.
>>>   
>>>       
>> I think that the packages I need are:
>>
>> libxv-dev                     - X11 Video extension library (development
>> headers)
>> libxv1                          - X11 Video extension library
>> libxv1-dbg                   - X11 Video extension library (debug package)
>>
>> I have installed them and this is the config.log generated after run
>> ./configure --disable-vidix:
>>
>> Parameters '--disable-vidix'
>> PKG_CONFIG_PATH '/usr/local/lib/pkgconfig'
>> Checking for ffmpeg.------------------------------------
>> try to use pkg-config.
>> -lpostproc
>> Checking for DirectFB and DFB++.------------------
>> /tmp/softdevice-conf-1926-8428-5600.c: In function 'int main()':
>> /tmp/softdevice-conf-1926-8428-5600.c:5: error: 'DSBLIT_INTERLACED' was
>> not declared in this scope
>> Checking for vidix.------------------------
>> Checking for Xv.-----------------------------
>> /usr/bin/ld: cannot find -lXi
>> collect2: ld returned 1 exit status
>> Checking for Xinerama.-----------------------------
>>
>> It seems that not found vx headers. There is a way to indicate the xv path?
>> If I make a 'dpkg - L libxv-dev I see:
>>
>>     
> No, the xv-headers are found, what is missing is an additional library
> called Xi, you probably also need a package called libxi-dev or
> something similar.
>   
Ok. Now vdr starts with xv softdevice output option. The problem is now 
I can hear tv but no view, black screen.
Perhaps I still missed install a codec? How can I know what is the problem?

Thanks

Leo


From leo at calidae.net  Mon Jun 19 13:33:04 2006
From: leo at calidae.net (=?ISO-8859-1?Q?Leo_M=E1rquez?=)
Date: Mon, 19 Jun 2006 13:33:04 +0200
Subject: [Softdevice-devel] witch softdevice output depending on hard
 and soft
In-Reply-To: <44965CFB.9070106@calidae.net>
References: <448FE494.5080908@calidae.net> <44904497.5020301@gmx.net> <449109D7.4050009@calidae.net> <4491D52D.5090301@gmx.net> <449266F1.8010207@calidae.net> <4493B714.7060302@gmx.net> <44965CFB.9070106@calidae.net>
Message-ID: <44968B70.2000201@calidae.net>

Hi again,
This messages perhaps helps but I don't view anything strange.

[softdevice] processing args
[softdevice]   argv [0] = softdevice
[softdevice]   argv [1] = -vo
vo_argv: xv:
[setup-softdevice] alsa ac3Mode set to: 0
[setup-softdevice] alsa AC3 device set to: hw:0,1
[setup-softdevice] alsa device set to: default
[setup-softdevice] A/V Offset set to (0)
[setup-softdevice] Cropping 0 lines from bottom
[setup-softdevice] Cropping 0 columns from left
[setup-softdevice] cropping mode set to 0 (none)
[setup-softdevice] cropping mode toggle key set to 0 (none)
[setup-softdevice] Cropping 0 columns from right
[setup-softdevice] Cropping 0 lines from top
[setup-softdevice] deinterlace method set to 1 lavc
[setup-softdevice] mainMenu: 1
[setup-softdevice] setting alpha blend mode to software
[softdevice] picture mirroring set to 0 (off)
[setup-softdevice] pixel format set to (I420)
[setup-softdevice] shouldSuspend to: 0
[setup-softdevice] syncTimerMode: sig
[softdevice] UseStretchBlitset to off
[setup-softdevice] vidBrightness: 50
[setup-softdevice] vidContrast: 50
[setup-softdevice] vidHue: 50
[setup-softdevice] vidSaturation: 50
[setup-softdevice] startup aspect set to (16:9 wide)
[softdevice] initializing Plugin
[softdevice] Initializing Video Out
[softdevice] ffmpeg version(CVS) build(3344384)
[XvVideoOut]: osd_image shmid = 3538967
[XvVideoOut]: got osd_image: width 1280 height 1024, bytes per line 5120
[softdevice] Subplugin successfully opend
[softdevice] Video Out seems to be OK
[softdevice] Initializing Audio Out
[softdevice] Audio out seems to be OK
[softdevice] A/V devices initialized, now initializing MPEG2 Decoder
allocating buffer format orig->format 0
allocating buffer format orig->format 0

Thanks,

Leo.


Leo M?rquez wrote:
> Hi,
>
> Martin Wache wrote:
>> Leo M?rquez schrieb:
>>  
>>> Hi again,
>>>    
>>>>>>                   
>>>>> I dont know in witch debian package are this headers included. I have
>>>>> installled the xserver-xorg-dev package but it don't work for me.
>>>>> The plugins compiles fine but the configure command of softdevice 
>>>>> ignore
>>>>> the --disable-xv and the ./configure commands that are relative to 
>>>>> xv.
>>>>>             
>>>> I would assume that xserver-xorg-dev is the one you need, but maybe 
>>>> you
>>>> also need some more. The softdevice also needs the headers of the x11
>>>> extensions like XVideo, maybe that is still missing. If you upgrade to
>>>> the cvs from today and use configure again you will get a more 
>>>> detailed
>>>> report of why xv is disabled in the file config.log.
>>>>         
>>> I think that the packages I need are:
>>>
>>> libxv-dev                     - X11 Video extension library 
>>> (development
>>> headers)
>>> libxv1                          - X11 Video extension library
>>> libxv1-dbg                   - X11 Video extension library (debug 
>>> package)
>>>
>>> I have installed them and this is the config.log generated after run
>>> ./configure --disable-vidix:
>>>
>>> Parameters '--disable-vidix'
>>> PKG_CONFIG_PATH '/usr/local/lib/pkgconfig'
>>> Checking for ffmpeg.------------------------------------
>>> try to use pkg-config.
>>> -lpostproc
>>> Checking for DirectFB and DFB++.------------------
>>> /tmp/softdevice-conf-1926-8428-5600.c: In function 'int main()':
>>> /tmp/softdevice-conf-1926-8428-5600.c:5: error: 'DSBLIT_INTERLACED' was
>>> not declared in this scope
>>> Checking for vidix.------------------------
>>> Checking for Xv.-----------------------------
>>> /usr/bin/ld: cannot find -lXi
>>> collect2: ld returned 1 exit status
>>> Checking for Xinerama.-----------------------------
>>>
>>> It seems that not found vx headers. There is a way to indicate the 
>>> xv path?
>>> If I make a 'dpkg - L libxv-dev I see:
>>>
>>>     
>> No, the xv-headers are found, what is missing is an additional library
>> called Xi, you probably also need a package called libxi-dev or
>> something similar.
>>   
> Ok. Now vdr starts with xv softdevice output option. The problem is 
> now I can hear tv but no view, black screen.
> Perhaps I still missed install a codec? How can I know what is the 
> problem?
>
> Thanks
>
> Leo
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/softdevice-devel
>



From torgeir at pobox.com  Mon Jun 19 13:48:16 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Mon, 19 Jun 2006 12:48:16 +0100
Subject: [Softdevice-devel] audio delay
Message-ID: <1150717697.2462.18.camel@localhost>

I'm wondering what others are using for a/v (audio) delay? 

I'm constantly using 80ms with Xv output, dvb-t in the uk, since it
gives me the best lipsync.

-- 
Torgeir Veimo <torgeir at pobox.com>



From leo at calidae.net  Mon Jun 19 15:08:03 2006
From: leo at calidae.net (=?ISO-8859-1?Q?Leo_M=E1rquez?=)
Date: Mon, 19 Jun 2006 15:08:03 +0200
Subject: [Softdevice-devel] witch softdevice output depending on hard
 and soft
In-Reply-To: <44968B70.2000201@calidae.net>
References: <448FE494.5080908@calidae.net> <44904497.5020301@gmx.net> <449109D7.4050009@calidae.net> <4491D52D.5090301@gmx.net> <449266F1.8010207@calidae.net> <4493B714.7060302@gmx.net> <44965CFB.9070106@calidae.net> <44968B70.2000201@calidae.net>
Message-ID: <4496A1B3.6040509@calidae.net>

Hi,

Finally the problem is solved. There was a problem with the graphics 
card configuration and xorg.
I have runned this:

aticonfig --overlay-type=Xv

And my radeon x700 show tv images.

Thanks for you attention.

Leo


Leo M?rquez wrote:
> Hi again,
> This messages perhaps helps but I don't view anything strange.
>
> [softdevice] processing args
> [softdevice]   argv [0] = softdevice
> [softdevice]   argv [1] = -vo
> vo_argv: xv:
> [setup-softdevice] alsa ac3Mode set to: 0
> [setup-softdevice] alsa AC3 device set to: hw:0,1
> [setup-softdevice] alsa device set to: default
> [setup-softdevice] A/V Offset set to (0)
> [setup-softdevice] Cropping 0 lines from bottom
> [setup-softdevice] Cropping 0 columns from left
> [setup-softdevice] cropping mode set to 0 (none)
> [setup-softdevice] cropping mode toggle key set to 0 (none)
> [setup-softdevice] Cropping 0 columns from right
> [setup-softdevice] Cropping 0 lines from top
> [setup-softdevice] deinterlace method set to 1 lavc
> [setup-softdevice] mainMenu: 1
> [setup-softdevice] setting alpha blend mode to software
> [softdevice] picture mirroring set to 0 (off)
> [setup-softdevice] pixel format set to (I420)
> [setup-softdevice] shouldSuspend to: 0
> [setup-softdevice] syncTimerMode: sig
> [softdevice] UseStretchBlitset to off
> [setup-softdevice] vidBrightness: 50
> [setup-softdevice] vidContrast: 50
> [setup-softdevice] vidHue: 50
> [setup-softdevice] vidSaturation: 50
> [setup-softdevice] startup aspect set to (16:9 wide)
> [softdevice] initializing Plugin
> [softdevice] Initializing Video Out
> [softdevice] ffmpeg version(CVS) build(3344384)
> [XvVideoOut]: osd_image shmid = 3538967
> [XvVideoOut]: got osd_image: width 1280 height 1024, bytes per line 5120
> [softdevice] Subplugin successfully opend
> [softdevice] Video Out seems to be OK
> [softdevice] Initializing Audio Out
> [softdevice] Audio out seems to be OK
> [softdevice] A/V devices initialized, now initializing MPEG2 Decoder
> allocating buffer format orig->format 0
> allocating buffer format orig->format 0
>
> Thanks,
>
> Leo.
>
>
> Leo M?rquez wrote:
>> Hi,
>>
>> Martin Wache wrote:
>>> Leo M?rquez schrieb:
>>>  
>>>> Hi again,
>>>>   
>>>>>>>                   
>>>>>> I dont know in witch debian package are this headers included. I 
>>>>>> have
>>>>>> installled the xserver-xorg-dev package but it don't work for me.
>>>>>> The plugins compiles fine but the configure command of softdevice 
>>>>>> ignore
>>>>>> the --disable-xv and the ./configure commands that are relative 
>>>>>> to xv.
>>>>>>             
>>>>> I would assume that xserver-xorg-dev is the one you need, but 
>>>>> maybe you
>>>>> also need some more. The softdevice also needs the headers of the x11
>>>>> extensions like XVideo, maybe that is still missing. If you 
>>>>> upgrade to
>>>>> the cvs from today and use configure again you will get a more 
>>>>> detailed
>>>>> report of why xv is disabled in the file config.log.
>>>>>         
>>>> I think that the packages I need are:
>>>>
>>>> libxv-dev                     - X11 Video extension library 
>>>> (development
>>>> headers)
>>>> libxv1                          - X11 Video extension library
>>>> libxv1-dbg                   - X11 Video extension library (debug 
>>>> package)
>>>>
>>>> I have installed them and this is the config.log generated after run
>>>> ./configure --disable-vidix:
>>>>
>>>> Parameters '--disable-vidix'
>>>> PKG_CONFIG_PATH '/usr/local/lib/pkgconfig'
>>>> Checking for ffmpeg.------------------------------------
>>>> try to use pkg-config.
>>>> -lpostproc
>>>> Checking for DirectFB and DFB++.------------------
>>>> /tmp/softdevice-conf-1926-8428-5600.c: In function 'int main()':
>>>> /tmp/softdevice-conf-1926-8428-5600.c:5: error: 'DSBLIT_INTERLACED' 
>>>> was
>>>> not declared in this scope
>>>> Checking for vidix.------------------------
>>>> Checking for Xv.-----------------------------
>>>> /usr/bin/ld: cannot find -lXi
>>>> collect2: ld returned 1 exit status
>>>> Checking for Xinerama.-----------------------------
>>>>
>>>> It seems that not found vx headers. There is a way to indicate the 
>>>> xv path?
>>>> If I make a 'dpkg - L libxv-dev I see:
>>>>
>>>>     
>>> No, the xv-headers are found, what is missing is an additional library
>>> called Xi, you probably also need a package called libxi-dev or
>>> something similar.
>>>   
>> Ok. Now vdr starts with xv softdevice output option. The problem is 
>> now I can hear tv but no view, black screen.
>> Perhaps I still missed install a codec? How can I know what is the 
>> problem?
>>
>> Thanks
>>
>> Leo
>> _______________________________________________
>> Softdevice-devel mailing list
>> Softdevice-devel at lists.berlios.de
>> http://lists.berlios.de/mailman/listinfo/softdevice-devel
>>
>
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/softdevice-devel
>



From malcolm.caldwell at cdu.edu.au  Tue Jun 20 02:46:33 2006
From: malcolm.caldwell at cdu.edu.au (Malcolm Caldwell)
Date: Tue, 20 Jun 2006 10:16:33 +0930
Subject: [Softdevice-devel] audio delay
In-Reply-To: <1150717697.2462.18.camel@localhost>
References: <1150717697.2462.18.camel@localhost>
Message-ID: <1150764393.3504.13.camel@localhost.localdomain>

It reminds me of a question I have:

What is the best way to set AV delay?  And what exactly is the meaning
of the number?   That is, does increasing the value cause audio to be
played earlier or later?  And, once I change the value by OSD, does it
take effect immediately? 

On Mon, 2006-06-19 at 12:48 +0100, Torgeir Veimo wrote:
> I'm wondering what others are using for a/v (audio) delay? 
> 
> I'm constantly using 80ms with Xv output, dvb-t in the uk, since it
> gives me the best lipsync.
> 



From torgeir at pobox.com  Tue Jun 20 08:54:52 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Tue, 20 Jun 2006 07:54:52 +0100
Subject: [Softdevice-devel] audio delay
In-Reply-To: <1150764393.3504.13.camel@localhost.localdomain>
References: <1150717697.2462.18.camel@localhost>
	 <1150764393.3504.13.camel@localhost.localdomain>
Message-ID: <1150786492.2608.1.camel@localhost>

On Tue, 2006-06-20 at 10:16 +0930, Malcolm Caldwell wrote:
> What is the best way to set AV delay?  And what exactly is the meaning
> of the number?   That is, does increasing the value cause audio to be
> played earlier or later?  And, once I change the value by OSD, does it
> take effect immediately?  

It's audio delay. It takes effect immediately when you press ok. The
label should prob be changed from a/v delay to audio delay.

-- 
Torgeir Veimo <torgeir at pobox.com>



From patrick.boettcher at desy.de  Tue Jun 20 08:56:23 2006
From: patrick.boettcher at desy.de (Patrick Boettcher)
Date: Tue, 20 Jun 2006 08:56:23 +0200 (CEST)
Subject: [Softdevice-devel] DVB-T in H.264 in France and UK
In-Reply-To: <200606182040.06854.stefan@lucke.in-berlin.de>
References: <200606060653.38747.stefan@lucke.in-berlin.de>
 <200606182040.06854.stefan@lucke.in-berlin.de>
Message-ID: <Pine.LNX.4.64.0606200852440.30104@pub4.ifh.de>

Hi,

On Sun, 18 Jun 2006, Stefan Lucke wrote:

> On Dienstag 06 Juni 2006 06:53, Stefan Lucke wrote:
> > Hi, 
> > has anyone tried H.264 streams to play or record with vdr & softdevice
> > in UK or France as discussed of linux-dvb list ?
> > 
> > http://www.linuxtv.org/pipermail/linux-dvb/2006-June/010679.html
> 
> No one from UK on this list ? Someone who can receive BBC 'Crystal Palace B' 
> like mentioned here:
> http://www.linuxtv.org/pipermail/linux-dvb/2006-June/010666.html
> 
> If vdr sets the video pids for such a transponder to zero, please try attached
> patch. I don't know if we could decode it, since within vdr-mode (opposite
> to softplay-mode) we are not in play-packet-mode (so many modes, bad english).

I'm living in the south of Paris and I can receive Channels transmitted 
from the Eiffel Tower and Villebon. 

All I know, according to some Emails I saw, there is "some transmission 
over DVB-T" - but I don't know on which frequencies.

I someone has more information, I would really like to try.

Should VDR add at least the channel to the list? (I can manually change 
the VPID and disable autopid for the time)

regards,
Patrick.

--
  Mail: patrick.boettcher at desy.de
  WWW:  http://www.wi-bw.tfh-wildau.de/~pboettch/


From stefan at lucke.in-berlin.de  Tue Jun 20 09:19:30 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 20 Jun 2006 09:19:30 +0200
Subject: [Softdevice-devel] DVB-T in H.264 in France and UK
In-Reply-To: <Pine.LNX.4.64.0606200852440.30104@pub4.ifh.de>
References: <200606060653.38747.stefan@lucke.in-berlin.de> <200606182040.06854.stefan@lucke.in-berlin.de> <Pine.LNX.4.64.0606200852440.30104@pub4.ifh.de>
Message-ID: <1150787970.4497a182daf7f@webmail.in-berlin.de>

Quoting Patrick Boettcher:

> Hi,
>
> On Sun, 18 Jun 2006, Stefan Lucke wrote:
>
> > On Dienstag 06 Juni 2006 06:53, Stefan Lucke wrote:
> > > Hi,
> > > has anyone tried H.264 streams to play or record with vdr & softdevice
> > > in UK or France as discussed of linux-dvb list ?
> > >
> > > http://www.linuxtv.org/pipermail/linux-dvb/2006-June/010679.html
> >
> > No one from UK on this list ? Someone who can receive BBC 'Crystal Palace B'
> > like mentioned here:
> > http://www.linuxtv.org/pipermail/linux-dvb/2006-June/010666.html
> >
> > If vdr sets the video pids for such a transponder to zero, please try attached
> > patch. I don't know if we could decode it, since within vdr-mode (opposite
> > to softplay-mode) we are not in play-packet-mode (so many modes, bad english).
>
> I'm living in the south of Paris and I can receive Channels transmitted
> from the Eiffel Tower and Villebon.
>
> All I know, according to some Emails I saw, there is "some transmission
> over DVB-T" - but I don't know on which frequencies.

I found these links that might be interesting.

http://www.hauppauge.co.uk/board/showthread.php?t=5275
http://morin80s.free.fr/TSReader/051011_R3.htm

Google search was
dvb-t france h264 channels

>
> I someone has more information, I would really like to try.
>
> Should VDR add at least the channel to the list? (I can manually change
> the VPID and disable autopid for the time)
>

I guess vdr should add them to the list, but without modification vdr
would not stroe the video pid.

I even don't know if an unmodified softdevice can play those recordings,
but softplay has a better chance I guess.

Stefan Lucke


From M.Wache at gmx.net  Tue Jun 20 19:27:59 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 20 Jun 2006 19:27:59 +0200
Subject: [Softdevice-devel] audio delay
In-Reply-To: <1150717697.2462.18.camel@localhost>
References: <1150717697.2462.18.camel@localhost>
Message-ID: <4498301F.8060205@gmx.net>

Torgeir Veimo schrieb:
> I'm wondering what others are using for a/v (audio) delay? 
> 
> I'm constantly using 80ms with Xv output, dvb-t in the uk, since it
> gives me the best lipsync.
> 
I've been kind of waiting for your complaint ;-)
I wasn't sure but I somehow had the feeling that I messed up the av sync
with the picbuffer code... I already checked for errors, but I didn't
find any.
Is this the latest CVS? Could you please try the the CVS from the 26.
May and check if you also have the delay?


Bye,
Martin


From M.Wache at gmx.net  Tue Jun 20 19:29:22 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 20 Jun 2006 19:29:22 +0200
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <1150631809.2462.9.camel@localhost>
References: <447B51B7.8070504@gmx.net>	 <Pine.OSF.4.61.0606180138160.520397@kosh.hut.fi>	 <200606180109.34111.stefan@lucke.in-berlin.de>	 <200606181205.23935.laz@club-burniston.co.uk> <1150631809.2462.9.camel@localhost>
Message-ID: <44983072.8000804@gmx.net>

Torgeir Veimo schrieb:
> On Sun, 2006-06-18 at 12:05 +0100, Laz wrote:
>> I have just checked out softdevice cvs and it is running nicely 
>> with "-vo:dfb:viatv:cle266". CPU usage like this is ca. 28% like this
>> on a 1 
>> GHz Epia MII-12000. With "-vo:dfb:viatv", CPU usage is ca. 82% for the
>> same 
>> channel. 
> 
> Does this work just as good with higher resolutions without viatv? With
> higher resolution I'm thinking about projector native resolutions such
> as 1280x720 etc.
>  
I tried it at that resolution, it works without problems for me.

Bye,
Martin


From M.Wache at gmx.net  Tue Jun 20 19:41:53 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Tue, 20 Jun 2006 19:41:53 +0200
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <200606171831.53086.stefan@lucke.in-berlin.de>
References: <447B51B7.8070504@gmx.net> <200606171509.32867.stefan@lucke.in-berlin.de> <Pine.OSF.4.61.0606171708480.447856@kosh.hut.fi> <200606171831.53086.stefan@lucke.in-berlin.de>
Message-ID: <44983361.2040209@gmx.net>

Stefan Lucke schrieb:
> On Samstag 17 Juni 2006 16:20, Rolf Ahrenberg wrote:
>> On Sat, 17 Jun 2006, Stefan Lucke wrote:
>>
>>> No. This would force YV12 pixelformat whenever HAVE_CLE266_MPEG_DECODER
>>> is detected. But without option cle266 we need I420, right ?
>>> In video-dfb.c we have to force stretchblit = 0 and pixelformat = 1 in constructor
>> Yes, my mistake. The forced pixelformat setting should be enabled only 
>> if "cle266HWdecode" is set. I placed it into setup's parse method just 
>> to make sure that the setting in setup.conf doesn't have any effect.
>>
>> Anyway, the patch is quite ready (IMHO) to be included into cvs and all 
>> those little annoyances can corrected later on.
> 
> Yes. In cvs, so we can talk in smaller patches.

Good point.

> I left out disabling pixelformat and stretchblit, until we are sure
> of the right/fastest one.
> 
I still think we should use I420 as default also when using hardware
decoding. I420 and YV12 only differ in the order of the planes, so I
don't see a reason why blitting from I420 to I420 should be faster than
blitting from YV12 to YV12. I currently assume that there is some kind
of bug in DirectFB or for some strange reason (bug?) the acceleration is
disabled for YV12.

Bye,
Martin



From laz at club-burniston.co.uk  Tue Jun 20 22:54:50 2006
From: laz at club-burniston.co.uk (Laz)
Date: Tue, 20 Jun 2006 21:54:50 +0100
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <44983361.2040209@gmx.net>
References: <447B51B7.8070504@gmx.net> <200606171831.53086.stefan@lucke.in-berlin.de> <44983361.2040209@gmx.net>
Message-ID: <200606202154.50808.laz@club-burniston.co.uk>

On Tuesday 20 June 2006 18:41, Martin Wache wrote:

> I still think we should use I420 as default also when using hardware
> decoding. I420 and YV12 only differ in the order of the planes, so I
> don't see a reason why blitting from I420 to I420 should be faster than
> blitting from YV12 to YV12. I currently assume that there is some kind
> of bug in DirectFB or for some strange reason (bug?) the acceleration is
> disabled for YV12.

I think I originally set it to YV12 because that was the format used by the 
original code I had and Blitting would only be accelerated to a YV12 surface. 
I'm not sure whether the decoder needs the buffers in this format or not, 
i.e. whether the 4 decoder buffers can just be set to I420 and it'll all 
work...

I don't think Blitting between different formats is accelerated so the pixel 
format in the setup probably wants fixing at the relevant value. I can 
currently change it between YV12 and I420 with no visible difference (not 
looked at the CPU usage); switching to YUY2 makes it quite jerky.

Cheers,

Laz


From stefan at lucke.in-berlin.de  Wed Jun 21 07:08:51 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 21 Jun 2006 07:08:51 +0200
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <200606202154.50808.laz@club-burniston.co.uk>
References: <447B51B7.8070504@gmx.net> <44983361.2040209@gmx.net> <200606202154.50808.laz@club-burniston.co.uk>
Message-ID: <200606210708.51912.stefan@lucke.in-berlin.de>

On Dienstag 20 Juni 2006 22:54, Laz wrote:
> On Tuesday 20 June 2006 18:41, Martin Wache wrote:
> 
> > I still think we should use I420 as default also when using hardware
> > decoding. I420 and YV12 only differ in the order of the planes, so I
> > don't see a reason why blitting from I420 to I420 should be faster than
> > blitting from YV12 to YV12. I currently assume that there is some kind
> > of bug in DirectFB or for some strange reason (bug?) the acceleration is
> > disabled for YV12.

Ups. Currently we use YV12 for hw-dec ! :

#ifdef HAVE_CLE266_MPEG_DECODER
      if (setupStore->cle266HWdecode) {
          if (!SetupCle266Buffers(swidth, sheight)) {
              fprintf(stderr, "Error allocating hardware buffers for CLE266 decoding: reverting to software decoding\n");
              setupStore->cle266HWdecode = false;
          } else {
              // Need YV12 pixel format for blitting from harware buffer
              // I420 == 0, YV12 == 1, YUY2 == 2
              //currentPixelFormat = setupStore->pixelFormat = 0;
              currentPixelFormat = setupStore->pixelFormat = 1;
              setupStore->useStretchBlit = 0;

But without hw-dec, I've to set it to I420 !!

I420 vs. YV12 is strange in DirectFB. For some cards it has to be set 
to I420, for some others it must be YV12. In xv-out we use allways
YV12. 

Another proove that it is a bug in DirectFB is the fact we've only one
function to produce YUY2 from YV12, and I've never seen that those
cards which need I420, show wrong colors in YUY2 mode.

Thats the disadvantage of work around programming (offering the possibility
of toggleing between I420 and YV12). The bug gets not fixed in the
original place.

> 
> I think I originally set it to YV12 because that was the format used by the 
> original code I had and Blitting would only be accelerated to a YV12 surface. 
> I'm not sure whether the decoder needs the buffers in this format or not, 
> i.e. whether the 4 decoder buffers can just be set to I420 and it'll all 
> work...
> 
> I don't think Blitting between different formats is accelerated so the pixel 
> format in the setup probably wants fixing at the relevant value. I can 
> currently change it between YV12 and I420 with no visible difference (not 
> looked at the CPU usage); switching to YUY2 makes it quite jerky.

Changing format from OSD has _NO_ effect, as it is currently ignored for
hardware decode. YOu have to change both values (sourface displayed
and surfaces used for hw-dec) in source code to change that.


-- 
Stefan Lucke


From torgeir at pobox.com  Wed Jun 21 14:13:20 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Wed, 21 Jun 2006 13:13:20 +0100
Subject: [Softdevice-devel] audio delay
In-Reply-To: <4498301F.8060205@gmx.net>
References: <1150717697.2462.18.camel@localhost> <4498301F.8060205@gmx.net>
Message-ID: <7A288410-4EF2-4663-A238-359886CE9C18@pobox.com>

On 20 Jun 2006, at 18:27, Martin Wache wrote:

> Torgeir Veimo schrieb:
>> I'm wondering what others are using for a/v (audio) delay?
>>
>> I'm constantly using 80ms with Xv output, dvb-t in the uk, since it
>> gives me the best lipsync.
>>
> I've been kind of waiting for your complaint ;-)
> I wasn't sure but I somehow had the feeling that I messed up the av  
> sync
> with the picbuffer code... I already checked for errors, but I didn't
> find any.

Hmm, I think this has been pretty constant since last summer, when  
there was some work done to do sound sync automatically. I always had  
the impression that there was one frame off or something. I'm not  
sure but wouldn't using double buffering with Xv lead to audio being  
a single frame being ahead of the picture?

> Is this the latest CVS? Could you please try the the CVS from the 26.
> May and check if you also have the delay?

I can check next week when I finally get internet set up in the flat  
where VDR is running..

-- 
Torgeir Veimo
torgeir at pobox.com





From stefan at lucke.in-berlin.de  Wed Jun 21 19:09:48 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Wed, 21 Jun 2006 19:09:48 +0200
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <44983361.2040209@gmx.net>
References: <447B51B7.8070504@gmx.net> <200606171831.53086.stefan@lucke.in-berlin.de> <44983361.2040209@gmx.net>
Message-ID: <200606211909.48298.stefan@lucke.in-berlin.de>

On Dienstag 20 Juni 2006 19:41, Martin Wache wrote:
> Stefan Lucke schrieb:
> > On Samstag 17 Juni 2006 16:20, Rolf Ahrenberg wrote:
> >> On Sat, 17 Jun 2006, Stefan Lucke wrote:
> >>
> >>> No. This would force YV12 pixelformat whenever HAVE_CLE266_MPEG_DECODER
> >>> is detected. But without option cle266 we need I420, right ?
> >>> In video-dfb.c we have to force stretchblit = 0 and pixelformat = 1 in constructor
> >> Yes, my mistake. The forced pixelformat setting should be enabled only 
> >> if "cle266HWdecode" is set. I placed it into setup's parse method just 
> >> to make sure that the setting in setup.conf doesn't have any effect.
> >>
> >> Anyway, the patch is quite ready (IMHO) to be included into cvs and all 
> >> those little annoyances can corrected later on.
> > 
> > Yes. In cvs, so we can talk in smaller patches.
> 
> Good point.
> 
> > I left out disabling pixelformat and stretchblit, until we are sure
> > of the right/fastest one.
> > 
> I still think we should use I420 as default also when using hardware
> decoding. I420 and YV12 only differ in the order of the planes, so I
> don't see a reason why blitting from I420 to I420 should be faster than
> blitting from YV12 to YV12. I currently assume that there is some kind
> of bug in DirectFB or for some strange reason (bug?) the acceleration is
> disabled for YV12.

Martin, did you have to any of the defines OLD_VERSION from 1 to 0 ?
That were the parts I did not agree to change. So value 1 means no change,
value 0 reprsent the suggested change.

Just commited a patch to set default pixel format to I420. Accelerated and
unaccelerated modes use now the same.

I think in DirectFB the accelerated blit is disabled when the is a format 
conversion: from I420 to YV12 or vice versa.

-- 
Stefan Lucke


From laz at club-burniston.co.uk  Wed Jun 21 22:34:22 2006
From: laz at club-burniston.co.uk (Laz)
Date: Wed, 21 Jun 2006 21:34:22 +0100
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <200606211909.48298.stefan@lucke.in-berlin.de>
References: <447B51B7.8070504@gmx.net> <44983361.2040209@gmx.net> <200606211909.48298.stefan@lucke.in-berlin.de>
Message-ID: <200606212134.23077.laz@club-burniston.co.uk>

On Wednesday 21 June 2006 18:09, Stefan Lucke wrote:

> Martin, did you have to any of the defines OLD_VERSION from 1 to 0 ?
> That were the parts I did not agree to change. So value 1 means no change,
> value 0 reprsent the suggested change.

All of my testing has been with all of the OLD_VERSIONS set to 1 because I 
haven't had a chance to see what those bits do yet.

> Just commited a patch to set default pixel format to I420. Accelerated and
> unaccelerated modes use now the same.
>
> I think in DirectFB the accelerated blit is disabled when the is a format
> conversion: from I420 to YV12 or vice versa.

I've just changed mine to I420 and it works fine. I think the CPU usage has 
gone up a couple of % to about 32% but that may just be my imagination! 
Probably makes sense to use I420 for both software and hardware decoding, 
especially as YV12 gives incorrect colours with software decoding.

And it _is_ still possible to change the pixel format: try it! YUY2 slows 
right down to about 5 fps! I thought changing this was disabled when using 
hardware decoding, too!

Cheers,

Laz


From laz at club-burniston.co.uk  Wed Jun 21 23:38:15 2006
From: laz at club-burniston.co.uk (Laz)
Date: Wed, 21 Jun 2006 22:38:15 +0100
Subject: [Softdevice-devel] audio delay
In-Reply-To: <7A288410-4EF2-4663-A238-359886CE9C18@pobox.com>
References: <1150717697.2462.18.camel@localhost> <4498301F.8060205@gmx.net> <7A288410-4EF2-4663-A238-359886CE9C18@pobox.com>
Message-ID: <200606212238.15934.laz@club-burniston.co.uk>

On Wednesday 21 June 2006 13:13, Torgeir Veimo wrote:
> On 20 Jun 2006, at 18:27, Martin Wache wrote:
> > Torgeir Veimo schrieb:
> >> I'm wondering what others are using for a/v (audio) delay?
> >>
> >> I'm constantly using 80ms with Xv output, dvb-t in the uk, since it
> >> gives me the best lipsync.
> >
> > I've been kind of waiting for your complaint ;-)
> > I wasn't sure but I somehow had the feeling that I messed up the av
> > sync
> > with the picbuffer code... I already checked for errors, but I didn't
> > find any.
>
> Hmm, I think this has been pretty constant since last summer, when
> there was some work done to do sound sync automatically. I always had
> the impression that there was one frame off or something. I'm not
> sure but wouldn't using double buffering with Xv lead to audio being
> a single frame being ahead of the picture?

I'm using triple buffering with dfb output and my audio usually seems to be 
slightly behind the video. Is the syncing such that A-V sync is worked out 
when a fame is blitted to a buffer, be it front or back, rather than when the 
buffers are flipped? I'm no expert on the A-V sync stuff but it might explain 
why some people need different amounts of A-V sync delay, depending on the 
number of buffers in use.

Probably barking up the wrong tree with this!

Cheers,

Laz


From torgeir at pobox.com  Wed Jun 21 23:55:38 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Wed, 21 Jun 2006 22:55:38 +0100
Subject: [Softdevice-devel] audio delay
In-Reply-To: <200606212238.15934.laz@club-burniston.co.uk>
References: <1150717697.2462.18.camel@localhost> <4498301F.8060205@gmx.net> <7A288410-4EF2-4663-A238-359886CE9C18@pobox.com> <200606212238.15934.laz@club-burniston.co.uk>
Message-ID: <4499C05A.4030307@pobox.com>

Laz wrote:
> On Wednesday 21 June 2006 13:13, Torgeir Veimo wrote:
>   
>> On 20 Jun 2006, at 18:27, Martin Wache wrote:
>>     
>>> Torgeir Veimo schrieb:
>>>       
>>>> I'm wondering what others are using for a/v (audio) delay?
>>>>
>>>> I'm constantly using 80ms with Xv output, dvb-t in the uk, since it
>>>> gives me the best lipsync.
>>>>         
>>> I've been kind of waiting for your complaint ;-)
>>> I wasn't sure but I somehow had the feeling that I messed up the av
>>> sync
>>> with the picbuffer code... I already checked for errors, but I didn't
>>> find any.
>>>       
>> Hmm, I think this has been pretty constant since last summer, when
>> there was some work done to do sound sync automatically. I always had
>> the impression that there was one frame off or something. I'm not
>> sure but wouldn't using double buffering with Xv lead to audio being
>> a single frame being ahead of the picture?
>>     
>
> I'm using triple buffering with dfb output and my audio usually seems to be 
> slightly behind the video. Is the syncing such that A-V sync is worked out 
> when a fame is blitted to a buffer, be it front or back, rather than when the 
> buffers are flipped? I'm no expert on the A-V sync stuff but it might explain 
> why some people need different amounts of A-V sync delay, depending on the 
> number of buffers in use.
Can you try setting the delay to either 80ms 120ms and see if it gives 
good sync? What country are you in? I'm suspecting the special situation 
in the uk with vdb-t requires med to add an additional 40ms audio delay.

The delay is just added to the a/v sync code, so that with a positive 
number, the decoder thinks the audio is behind and delays the video 
until audio is ahead the number of ms specified.


-- 
-Tor


From laz at club-burniston.co.uk  Thu Jun 22 00:12:11 2006
From: laz at club-burniston.co.uk (Laz)
Date: Wed, 21 Jun 2006 23:12:11 +0100
Subject: [Softdevice-devel] audio delay
In-Reply-To: <4499C05A.4030307@pobox.com>
References: <1150717697.2462.18.camel@localhost> <200606212238.15934.laz@club-burniston.co.uk> <4499C05A.4030307@pobox.com>
Message-ID: <200606212312.11684.laz@club-burniston.co.uk>

On Wednesday 21 June 2006 22:55, Torgeir Veimo wrote:
> Laz wrote:
> > On Wednesday 21 June 2006 13:13, Torgeir Veimo wrote:
> >> Hmm, I think this has been pretty constant since last summer, when
> >> there was some work done to do sound sync automatically. I always had
> >> the impression that there was one frame off or something. I'm not
> >> sure but wouldn't using double buffering with Xv lead to audio being
> >> a single frame being ahead of the picture?
> >
> > I'm using triple buffering with dfb output and my audio usually seems to
> > be slightly behind the video. Is the syncing such that A-V sync is worked
> > out when a fame is blitted to a buffer, be it front or back, rather than
> > when the buffers are flipped? I'm no expert on the A-V sync stuff but it
> > might explain why some people need different amounts of A-V sync delay,
> > depending on the number of buffers in use.
>
> Can you try setting the delay to either 80ms 120ms and see if it gives
> good sync? What country are you in? I'm suspecting the special situation
> in the uk with vdb-t requires med to add an additional 40ms audio delay.

I'm in the UK on DVB-T too. What do you mean by '80 or 120 ms'? All I have 
with dfb output is an integer value. Do you mean +8 and +12? I've usually got 
bored changing it before getting to the best value so I tend to just live 
with the video being slightly ahead. I'll try your values, though. Any 
thoughts on why it should be needed in the UK?

> The delay is just added to the a/v sync code, so that with a positive
> number, the decoder thinks the audio is behind and delays the video
> until audio is ahead the number of ms specified.

So a more positive value moves the audio forward relative to the video? Just 
looking at cAudioStreamDecoder::GetPTS(). The offset*10 gets added to the 
audio pts so that the audio is slowed down relative to the video so that the 
video and audio pts values match. Or that's how I see it!

I thought the A/V Delay was an "audio delay" and the other way round, from 
what someone said on this list the other day.

Cheers,

Laz


From torgeir at pobox.com  Thu Jun 22 10:59:49 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Thu, 22 Jun 2006 09:59:49 +0100
Subject: [Softdevice-devel] audio delay
In-Reply-To: <7A288410-4EF2-4663-A238-359886CE9C18@pobox.com>
References: <1150717697.2462.18.camel@localhost> <4498301F.8060205@gmx.net> <7A288410-4EF2-4663-A238-359886CE9C18@pobox.com>
Message-ID: <449A5C05.7060409@pobox.com>

Torgeir Veimo wrote:
>
> On 20 Jun 2006, at 18:27, Martin Wache wrote:
>
>> Torgeir Veimo schrieb:
>>> I'm wondering what others are using for a/v (audio) delay?
>>>
>>> I'm constantly using 80ms with Xv output, dvb-t in the uk, since it
>>> gives me the best lipsync.
>>>
>> I've been kind of waiting for your complaint ;-)
>> I wasn't sure but I somehow had the feeling that I messed up the av sync
>> with the picbuffer code... I already checked for errors, but I didn't
>> find any.
>
> Hmm, I think this has been pretty constant since last summer, when 
> there was some work done to do sound sync automatically. I always had 
> the impression that there was one frame off or something. 

The change I was refering to was this;

http://lists.berlios.de/pipermail/softdevice-devel/2005q1/000238.html

-- 
-Torgeir



From torgeir at pobox.com  Thu Jun 22 12:34:07 2006
From: torgeir at pobox.com (Torgeir Veimo)
Date: Thu, 22 Jun 2006 11:34:07 +0100
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <44983072.8000804@gmx.net>
References: <447B51B7.8070504@gmx.net>	 <Pine.OSF.4.61.0606180138160.520397@kosh.hut.fi>	 <200606180109.34111.stefan@lucke.in-berlin.de>	 <200606181205.23935.laz@club-burniston.co.uk> <1150631809.2462.9.camel@localhost> <44983072.8000804@gmx.net>
Message-ID: <449A721F.3020203@pobox.com>

Martin Wache wrote:
> Torgeir Veimo schrieb:
>   
>> On Sun, 2006-06-18 at 12:05 +0100, Laz wrote:
>>     
>>> I have just checked out softdevice cvs and it is running nicely 
>>> with "-vo:dfb:viatv:cle266". CPU usage like this is ca. 28% like this
>>> on a 1 
>>> GHz Epia MII-12000. With "-vo:dfb:viatv", CPU usage is ca. 82% for the
>>> same 
>>> channel. 
>>>       
>> Does this work just as good with higher resolutions without viatv? With
>> higher resolution I'm thinking about projector native resolutions such
>> as 1280x720 etc.
>>  
>>     
> I tried it at that resolution, it works without problems for me.
>   
What HW? Epia MII 12000?

-- 
-Torgeir



From stefan at lucke.in-berlin.de  Thu Jun 22 22:08:57 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 22 Jun 2006 22:08:57 +0200
Subject: [Softdevice-devel] Fwd: [directfb-dev] Matrox field based blitting now in CVS
Message-ID: <200606222208.58088.stefan@lucke.in-berlin.de>

I havn't tested this one, and I don't know when this will happen,
as it looks like I've lost my entire video data :-( .
If you backout my directfb patch for field based blitting, and
switch to dfb-cvs, you'll have to remove the "#if HAVE_DSBLIT_INTERLACED"
conditional in line 993 and 998 of video-dfb.c to get this work.

Stefan Lucke

----------  Forwarded Message  ----------

Subject: [directfb-dev] Matrox field based blitting now in CVS
Date: Donnerstag 22 Juni 2006 02:58
From: Ville Syrj?l? <syrjala at sci.fi>
To: directfb-dev at directfb.org

Hi,

Field based blitting support for matrox cards is now in cvs.

If both source and destination surfaces are interlaced the driver will 
blit the fields separately. No extra blitting flags were added.

The software rendering code should probably be changed to do similar 
things, but that's a job for another day.


P.S.
I also added PAL-60 support to the matrox driver. It's based on some 
guesswork but my TV seems happy with it.

-- 
Ville Syrj?l?
syrjala at sci.fi
http://www.sci.fi/~syrjala/

_______________________________________________
directfb-dev mailing list
directfb-dev at directfb.org
http://mail.directfb.org/cgi-bin/mailman/listinfo/directfb-dev



-------------------------------------------------------


From jonis2006 at yandex.ru  Sun Jun 25 16:50:39 2006
From: jonis2006 at yandex.ru (jonis2006)
Date: Sun, 25 Jun 2006 18:50:39 +0400 (MSD)
Subject: [Softdevice-devel] PAL and NTSC
Message-ID: <449EA2BF.000008.01698@webmail12.yandex.ru>

Hello !

Is it possible to get switching beetween NTSC and PAL on the fly ? For example I have a many DVD discs in PAL and discs in NTSC, it is very uncomfortable to edit config and restart VDR, how much  possible to create special button on the remote ? Can you implement that ?

With best regards
AgentX


From stefan at lucke.in-berlin.de  Sun Jun 25 18:57:16 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Sun, 25 Jun 2006 18:57:16 +0200
Subject: [Softdevice-devel] Summary of changes
Message-ID: <200606251857.16878.stefan@lucke.in-berlin.de>

For those not subscribed to the cvs list, here is a head of CHANGELOG.

2006-06-25:
   - video pixelformat and stretchblit mode can be locked by output driver, so
     that changeing them is not offered via OSD.
   - video-dfb: - Adapted radeon real alphablend handling to current DirectFB-cvs.
                  It is now handled similary to via mode (with underlay).
                - In mgatv-out mode, video surface is now allways allocated with
                  attribute DSCAPS_INTERLACED to support interlaced stretchblit
                  of DirectFB-cvs.
                - Removed test #if directives introduced in first via hw-dec support.
                - Lock pixelformat and stretchblit mode in case via hw-decode
                  and mgatv mode.
2006-06-21:
   - video-dfb: changed pixel format for HW-decoding to I420. So accelerated and
     unaccelerated modes use the same pixel format.
2006-06-18:
   - ignore config.log on commit checks
   - removed hardcoded FBDEV name in Makefile and configure
2006-06-17:
   - cle266, video-dfb: added HW-decoder support
   - configure: check for libcle266mpegdec instead of cle266mpegdec
   - get frame buffer name at runtime:
     1. via enviroment variable FRAMEBUFFER
     2. try /dev/fb0 or /dev/fb/0
2006-06-16:
   - video-dfb: fix via aspect ratio handling

-- 
Stefan Lucke


From lucianm at users.sourceforge.net  Tue Jun 27 02:25:16 2006
From: lucianm at users.sourceforge.net (Lucian Muresan)
Date: Tue, 27 Jun 2006 02:25:16 +0200
Subject: [Softdevice-devel] Re: Matrox field based blitting now in CVS
In-Reply-To: <200606222208.58088.stefan@lucke.in-berlin.de>
References: <200606222208.58088.stefan@lucke.in-berlin.de>
Message-ID: <44A07AEC.9090400@users.sourceforge.net>

Stefan Lucke wrote:
> I havn't tested this one, and I don't know when this will happen,
> as it looks like I've lost my entire video data :-( .
> If you backout my directfb patch for field based blitting, and
> switch to dfb-cvs, you'll have to remove the "#if HAVE_DSBLIT_INTERLACED"
> conditional in line 993 and 998 of video-dfb.c to get this work.
> 
> Stefan Lucke

Tried this but missed to read this message about removing the
conditional between lines 993 and 998, and now it's sooo late, wil have
to try tomorrow. But, I can tell you what I could see this way:
- video on my G400 TVout is very smooth;
- OSD has double height (only see upper half over whole screen area);
- during and once more 2 or 3 seconds after channel change, and on
showing/hiding the OSD as well, there is a very visible flicker in which
one can always see what looks like one field of the video displayed only
in the upper half of the screen (288 lines, squashed).
What impact should have had removing that conditional, any change on
what I described? I noticed that your configure script didn't detect
HAVE_DSBLIT_INTERLACED, although I checked out DirectFB this evening,
like softdevice. I grepped after DSBLIT_INTERLACED in the whole DirectFB
source, didn't find it. I must be missing something, going to bed now...

Lucian


From stefan at lucke.in-berlin.de  Tue Jun 27 07:57:23 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Tue, 27 Jun 2006 07:57:23 +0200
Subject: [Softdevice-devel] Re: Matrox field based blitting now in CVS
In-Reply-To: <44A07AEC.9090400@users.sourceforge.net>
References: <200606222208.58088.stefan@lucke.in-berlin.de> <44A07AEC.9090400@users.sourceforge.net>
Message-ID: <200606270757.23327.stefan@lucke.in-berlin.de>

On Dienstag 27 Juni 2006 02:25, Lucian Muresan wrote:
> Stefan Lucke wrote:
> > I havn't tested this one, and I don't know when this will happen,
> > as it looks like I've lost my entire video data :-( .
> > If you backout my directfb patch for field based blitting, and
> > switch to dfb-cvs, you'll have to remove the "#if HAVE_DSBLIT_INTERLACED"
> > conditional in line 993 and 998 of video-dfb.c to get this work.
> > 
> > Stefan Lucke
> 
> Tried this but missed to read this message about removing the
> conditional between lines 993 and 998, and now it's sooo late, wil have
> to try tomorrow. But, I can tell you what I could see this way:
> - video on my G400 TVout is very smooth;
> - OSD has double height (only see upper half over whole screen area);
> - during and once more 2 or 3 seconds after channel change, and on
> showing/hiding the OSD as well, there is a very visible flicker in which
> one can always see what looks like one field of the video displayed only
> in the upper half of the screen (288 lines, squashed).
> What impact should have had removing that conditional, any change on
> what I described?

Without conditional it should work as previous version without any
special consideration of interlaced blitting.

Villes version should work implicit. It depends on surfaces allocated interlaced.

> I noticed that your configure script didn't detect 
> HAVE_DSBLIT_INTERLACED, although I checked out DirectFB this evening,
> like softdevice. 

HAVE_DSBLIT_INTERLACED is only relevant for my patch as it requires
a special BLIT parameter. Current softdevice-cvs version has this conditional removed
(revision 1.68). So your effect describes a bug I noticed several times with
Villes pre-versions :-( . 

CC-ing directFB-dev.

> I grepped after DSBLIT_INTERLACED in the whole DirectFB 
> source, didn't find it. I must be missing something, going to bed now...
> 
> Lucian
> _______________________________________________
> Softdevice-devel mailing list
> Softdevice-devel at lists.berlios.de
> http://lists.berlios.de/mailman/listinfo/softdevice-devel
> 

-- 
Stefan Lucke


From marko.makela at hut.fi  Tue Jun 27 22:05:10 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 27 Jun 2006 23:05:10 +0300
Subject: [Softdevice-devel] Re: Matrox field based blitting now in CVS
In-Reply-To: <200606270757.23327.stefan@lucke.in-berlin.de>
References: <200606222208.58088.stefan@lucke.in-berlin.de> <44A07AEC.9090400@users.sourceforge.net> <200606270757.23327.stefan@lucke.in-berlin.de>
Message-ID: <20060627200510.GB3594@localhost.localdomain>

On Tue, Jun 27, 2006 at 07:57:23AM +0200, Stefan Lucke wrote:
> On Dienstag 27 Juni 2006 02:25, Lucian Muresan wrote:
> > - video on my G400 TVout is very smooth;
> > - OSD has double height (only see upper half over whole screen area);
> > - during and once more 2 or 3 seconds after channel change, and on
> > showing/hiding the OSD as well, there is a very visible flicker in which
> > one can always see what looks like one field of the video displayed only
> > in the upper half of the screen (288 lines, squashed).

Ditto, with current CVS of softdevice and DirectFB, on Debian GNU/Linux
unstable (updated tonight) and Matrox G450.

I had to add two #include statements to DirectFB code, or it would not
compile on Debian GNU/Linux unstable gcc 4.1.2 prerelease (patch attached).

	Marko
-------------- next part --------------
Index: gfxdrivers/matrox/matrox_3d.c
===================================================================
RCS file: /cvs/directfb/DirectFB/gfxdrivers/matrox/matrox_3d.c,v
retrieving revision 1.6
diff -p -u -r1.6 matrox_3d.c
--- gfxdrivers/matrox/matrox_3d.c	18 Jun 2006 19:52:19 -0000	1.6
+++ gfxdrivers/matrox/matrox_3d.c	27 Jun 2006 19:43:56 -0000
@@ -34,6 +34,7 @@
 #include <directfb.h>
 
 #include <direct/messages.h>
+#include <direct/types.h>
 
 #include "regs.h"
 #include "mmio.h"
Index: gfxdrivers/matrox/matrox_maven.c
===================================================================
RCS file: /cvs/directfb/DirectFB/gfxdrivers/matrox/matrox_maven.c,v
retrieving revision 1.22
diff -p -u -r1.22 matrox_maven.c
--- gfxdrivers/matrox/matrox_maven.c	20 Jun 2006 19:34:51 -0000	1.22
+++ gfxdrivers/matrox/matrox_maven.c	27 Jun 2006 19:43:56 -0000
@@ -31,6 +31,7 @@
 #include <sys/stat.h>
 #include <fcntl.h>
 #include <sys/ioctl.h>
+#include <errno.h>
 
 #ifdef USE_SYSFS
 #include <sysfs/libsysfs.h>

From marko.makela at hut.fi  Tue Jun 27 22:30:24 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Tue, 27 Jun 2006 23:30:24 +0300
Subject: [Softdevice-devel] Re: Matrox field based blitting now in CVS
In-Reply-To: <20060627200510.GB3594@localhost.localdomain>
References: <200606222208.58088.stefan@lucke.in-berlin.de> <44A07AEC.9090400@users.sourceforge.net> <200606270757.23327.stefan@lucke.in-berlin.de> <20060627200510.GB3594@localhost.localdomain>
Message-ID: <20060627203023.GC3594@localhost.localdomain>

On Tue, Jun 27, 2006 at 11:05:10PM +0300, Marko M?kel? wrote:
> On Tue, Jun 27, 2006 at 07:57:23AM +0200, Stefan Lucke wrote:
> > On Dienstag 27 Juni 2006 02:25, Lucian Muresan wrote:
> > > - video on my G400 TVout is very smooth;
> > > - OSD has double height (only see upper half over whole screen area);
> > > - during and once more 2 or 3 seconds after channel change, and on
> > > showing/hiding the OSD as well, there is a very visible flicker in which
> > > one can always see what looks like one field of the video displayed only
> > > in the upper half of the screen (288 lines, squashed).
> 
> Ditto, with current CVS of softdevice and DirectFB, on Debian GNU/Linux
> unstable (updated tonight) and Matrox G450.

Short profiling results:

opcontrol --start;sleep 20;opcontrol --stop

According to opreport -l, yv12_to_yuy2_il_mmx2() is consuming
26% of all CPU time (across all processes and libraries).
According to opreport -l path/to/libvdr-softdevice.so.1.4.0,
it is 37.4% of softdevice time (with statically linked ffmpeg
and no subplugins).

$ opreport -t 2 -l path/to/libvdr-softdevice.so.1.4.0

CPU: PIII, speed 906.836 MHz (estimated)
Counted CPU_CLK_UNHALTED events (clocks processor is not halted) with a unit mask of 0x00 (No unit mask) count 90000
samples  %        symbol name
37575    37.3903  yv12_to_yuy2_il_mmx2(unsigned char const*, unsigned char const*, unsigned char const*, unsigned char*, int, int, int, int, int)
9302      9.2563  mpeg_decode_mb
7787      7.7487  put_pixels16_mmx
7454      7.4174  ff_mpa_synth_filter
6509      6.4770  put_pixels8_mmx
4693      4.6699  ff_simple_idct_add_mmx
2730      2.7166  MPV_decode_mb
2545      2.5325  put_pixels16_xy2_mmx

$ opreport --global-percent

CPU: PIII, speed 906.836 MHz (estimated)
Counted CPU_CLK_UNHALTED events (clocks processor is not halted) with a unit mask of 0x00 (No unit mask) count 90000
CPU_CLK_UNHALT...|
  samples|      %|
------------------
   100494 69.8108 libvdr-softdevice.so.1.4.0
    20979 14.5736 vmlinux
     4681  3.2518 oprofiled
     3847  2.6724 libc-2.3.6.so
     3371  2.3418 cx8802
     2811  1.9527 cx8800
     2022  1.4046 oprofile
     1372  0.9531 vdr
     1194  0.8294 libasound.so.2.0.0
      568  0.3946 cx88xx
      516  0.3585 libpthread-2.3.6.so
      373  0.2591 bash
      364  0.2529 libdirectfb_matrox.so
      274  0.1903 libdirectfb-0.9.so.26.0.0
[snip]

So, there's no busy waiting in DirectFB any more.  The playback is smooth,
and frames are dropped very seldomly, even though CPU load is slightly
over 50%.

I hope that the OSD bugs can be fixed ASAP.  Stefan, I'd appreciate a
notification on the softdevice mailing list when this happens.

One more bug: the top of the framebuffer is not cleared (made black) when
viewing a 16:9 program and hitting CropModeToggleKey.  The two most recent
fields will just repeat infinitely.

Related bug: when viewing a 16:9 program on a 4:3 screen letterboxed
(full horizontal resolution, downscaled vertical resolution), the
top black bar will be replaced with the topmost lines of the two
interlaced video frames whenever the OSD is either enabled or disabled.
(i.e., hit Schedule to enable the OSD, watch the top lines change; then
hit Back to disable the OSD and watch the top lines change again).

	Marko


From inssomniak at mountaincable.net  Wed Jun 28 06:20:08 2006
From: inssomniak at mountaincable.net (Dave)
Date: Wed, 28 Jun 2006 00:20:08 -0400
Subject: [Softdevice-devel] I only see osd
In-Reply-To: <200606160710.29160.stefan@lucke.in-berlin.de>
References: <44915A9C.8080700@calidae.net> <44915DCC.7000702@calidae.net> <449175C3.5080104@calidae.net> <200606160710.29160.stefan@lucke.in-berlin.de>
Message-ID: <44A20378.9080003@mountaincable.net>

Nvidia RIVA TNT is broken with softdevice/directfb, it always has been
and only shows OSD as you described.  In fact most nvidia cards dont
work with softdevice/directfb, aside from the MX series which work well. 

FX series, GT series all broken.
A crew of us were never able to determine why.


Dave



Stefan Lucke wrote:
> On Donnerstag 15 Juni 2006 16:59, Leo M?rquez wrote:
>   
>> More info. This is my fbset -i:
>>
>> mode "640x480-60"
>>     # D: 25.176 MHz, H: 31.469 kHz, V: 59.942 Hz
>>     geometry 640 480 640 32767 8
>>     timings 39721 40 24 32 11 96 2
>>     accel true
>>     rgba 8/0,8/0,8/0,0/0
>> endmode
>>
>> Frame buffer device information:
>>     Name        : NV2
>>     Address     : 0xe4000000
>>     Size        : 33554432
>>     Type        : PACKED PIXELS
>>     Visual      : PSEUDOCOLOR
>>     XPanStep    : 8
>>     YPanStep    : 1
>>     YWrapStep   : 0
>>     LineLength  : 640
>>     MMIO Address: 0xe6000000
>>     MMIO Size   : 16777216
>>     Accelerator : nVidia RIVA TNT
>>
>> I hope you could help me.
>>
>>     
>
> So the only info which is missing, is the messages written to stderr.
> Up to now everything looks ok. At least there is no obious error.
>
> Please try to avoid top posts.
>
>
>   
>> Thanks,
>>
>> Leo
>>
>> Leo M?rquez wrote:
>>     
>>> Hi again,
>>> Some logs I see in syslog:
>>>
>>> switching to channel 6
>>> Jun 15 15:51:35 vdr vdr: [3606] transfer thread ended (pid=3577, 
>>> tid=3606)
>>> Jun 15 15:51:35 vdr vdr: [3609] TS buffer on device 1 thread ended 
>>> (pid=3577, tid=3609)
>>> Jun 15 15:51:35 vdr vdr: [3607] buffer stats: 67680 (3%) used
>>> Jun 15 15:51:35 vdr vdr: [3607] receiver on device 1 thread ended 
>>> (pid=3577, tid=3607)
>>> Jun 15 15:51:35 vdr vdr: [3577] cTS2PES got 0 TS errors, 1 TS 
>>> continuity errors
>>> Jun 15 15:51:35 vdr vdr: [3577] buffer stats: 68056 (3%) used
>>> Jun 15 15:51:35 vdr vdr: [3614] transfer thread started (pid=3577, 
>>> tid=3614)
>>> Jun 15 15:51:35 vdr vdr: [3615] receiver on device 1 thread started 
>>> (pid=3577, tid=3615)
>>> Jun 15 15:51:35 vdr vdr: [3617] TS buffer on device 1 thread started 
>>> (pid=3577, tid=3617)
>>> Jun 15 15:51:36 vdr vdr: [3614] setting audio track to 1 (0)
>>> Jun 15 15:51:36 vdr vdr: [3619] [softdevice-audio]: xrun
>>> Jun 15 15:51:39 vdr vdr: [3577] switching to channel 7
>>> Jun 15 15:51:39 vdr vdr: [3614] transfer thread ended (pid=3577, 
>>> tid=3614)
>>> Jun 15 15:51:39 vdr vdr: [3617] TS buffer on device 1 thread ended 
>>> (pid=3577, tid=3617)
>>> Jun 15 15:51:39 vdr vdr: [3615] buffer stats: 57528 (2%) used
>>> Jun 15 15:51:39 vdr vdr: [3615] receiver on device 1 thread ended 
>>> (pid=3577, tid=3615)
>>> Jun 15 15:51:39 vdr vdr: [3577] cTS2PES got 0 TS errors, 1 TS 
>>> continuity errors
>>> Jun 15 15:51:39 vdr vdr: [3577] cTS2PES got 1 TS errors, 1 TS 
>>> continuity errors
>>> Jun 15 15:51:39 vdr vdr: [3577] buffer stats: 57904 (2%) used
>>> Jun 15 15:51:39 vdr vdr: [3620] transfer thread started (pid=3577, 
>>> tid=3620)
>>> Jun 15 15:51:39 vdr vdr: [3621] receiver on device 1 thread started 
>>> (pid=3577, tid=3621)
>>> Jun 15 15:51:39 vdr vdr: [3623] TS buffer on device 1 thread started 
>>> (pid=3577, tid=3623)
>>> Jun 15 15:51:40 vdr vdr: [3624] [VideoOut]: resolution changed: W(720 
>>> -> 528); H(576 ->576)
>>> Jun 15 15:51:40 vdr vdr: [3624] [VideoOut]: 528x576 [0,0 528x576] -> 
>>> 768x576 [0,0 768x576]
>>>
>>>
>>> Can be related to my problem?
>>>
>>> Thanks again.
>>>
>>> Leo
>>>
>>>
>>>
>>> Leo M?rquez wrote:
>>>       
>>>> Hi,
>>>>
>>>> Well I'm setted up a vdr with softdevice, directfb but when I start 
>>>> vdr with:
>>>>
>>>> ./vdr -P"softdevice -vo dfb:"
>>>>
>>>> I only see the osd menus, but no tv image.
>>>> My directfbrc file contains:
>>>>
>>>> mode  = 768x576
>>>> depth = 32
>>>> pixelformat=ARGB
>>>>
>>>> My hardware is a nvidia tnt2 M64.
>>>> The framebuffer module I use is nvidiafb
>>>>
>>>> In var/log/syslog I don't see anything strange.
>>>>
>>>> In the other hand if I start vdr with only -Pstreamdev-server the 
>>>> clients can watch TV.
>>>> In the server few days a go I use -vo fb: as output and It works.
>>>>
>>>> I supose the problem is related to the directfb configuration but... 
>>>> why can I see osd and not TV?
>>>>
>>>> Thanks,
>>>>
>>>> Leo
>>>> _______________________________________________
>>>> Softdevice-devel mailing list
>>>> Softdevice-devel at lists.berlios.de
>>>> http://lists.berlios.de/mailman/listinfo/softdevice-devel
>>>>
>>>>         
>>> _______________________________________________
>>> Softdevice-devel mailing list
>>> Softdevice-devel at lists.berlios.de
>>> http://lists.berlios.de/mailman/listinfo/softdevice-devel
>>>
>>>       
>> _______________________________________________
>> Softdevice-devel mailing list
>> Softdevice-devel at lists.berlios.de
>> http://lists.berlios.de/mailman/listinfo/softdevice-devel
>>
>>     
>
>   


From inssomniak at mountaincable.net  Wed Jun 28 06:30:24 2006
From: inssomniak at mountaincable.net (Dave)
Date: Wed, 28 Jun 2006 00:30:24 -0400
Subject: [Softdevice-devel] Better Error Handling for bad sample rates "Fatal: Exiting"
Message-ID: <44A205E0.8090906@mountaincable.net>

I have this problem occasionally with softdevice exiting out due to
unsupported audio sample rates. for example 44100 khz causes softdevice
to exit and kill VDR.

Is there a better way to handle this rather than to kill VDR
completely?  I have 3 DVB-S cards in one box, and 3 dishes.  I often am
recording 3-4 programs at the same time, and for example a brief hard
rain comes by and lowers the signal too low and causes video/audio
errors I lose all my other recordings currently being recorded which
encountered no problems at all.  I would much rather have a recording
with some video/audio errors than no recordings at all. 

Im open to suggestions :)

Dave




From per at mellander.org  Wed Jun 28 09:03:00 2006
From: per at mellander.org (Per Mellander)
Date: Wed, 28 Jun 2006 09:03:00 +0200
Subject: [Softdevice-devel] Setting up CLE266 HW-decode
Message-ID: <20060628065118.M34690@mellander.org>

I've been following the progress of the HW-decode development and today I felt it was
time to give it a try. I have some problems getting started and maybe you guy's could
answer a couple of questions?

First of. Which kernel should I use? I started with the current ( 2.6.17-1 ) and had
problems immediatly. When trying to compile linux-viafb from DirecFB CVS I get the
following error:

-----8<-------------------------------------------------------------------------------

make -C /usr/src/linux EXTRA_CFLAGS=-O0 SUBDIRS=`pwd`/viafb modules
make[1]: Entering directory `/usr/src/linux-2.6.17.1'
/usr/local/src/linux-fb/cle266fb/viafb/Makefile:6: /usr/src/linux-2.6.17.1/Rules.make:
No such file or directory
scripts/Makefile.build:56: kbuild: /usr/local/src/linux-fb/cle266fb/viafb/Makefile -
Usage of O_TARGET := viafb.o is obsolete in 2.6. Please fix!
make[2]: *** No rule to make target `/usr/src/linux-2.6.17.1/Rules.make'.  Stop.
make[1]: *** [_module_/usr/local/src/linux-fb/cle266fb/viafb] Error 2
make[1]: Leaving directory `/usr/src/linux-2.6.17.1'
make: *** [all] Error 2

-----8<--------------------------------------------------------------------------------

Does anyone have a good .config for an EPIA-MII 12000 where I want to run VDR+softdevice
using DirectFB for output?

Is there any HOWTO besides
http://lists.berlios.de/pipermail/softdevice-devel/2006q2/001943.html that could give me
some more help?

Sincerely,

/Per






From marko.makela at hut.fi  Wed Jun 28 09:43:43 2006
From: marko.makela at hut.fi (Marko =?iso-8859-1?B?TeRrZWzk?=)
Date: Wed, 28 Jun 2006 10:43:43 +0300
Subject: [Softdevice-devel] Better Error Handling for bad sample rates "Fatal: Exiting"
In-Reply-To: <44A205E0.8090906@mountaincable.net>
References: <44A205E0.8090906@mountaincable.net>
Message-ID: <20060628074343.GC5684@localhost.localdomain>

On Wed, Jun 28, 2006 at 12:30:24AM -0400, Dave wrote:
> 
> I have this problem occasionally with softdevice exiting out due to
> unsupported audio sample rates. for example 44100 khz causes softdevice
> to exit and kill VDR.
> 
> Is there a better way to handle this rather than to kill VDR
> completely?

You might want to work this around by suspending the output when you are
not watching it.  Then, softdevice shouldn't be able to crash.  That should
also reduce the power consumption of your VDR box by some 10 or 20 watts.

There are at least three alternatives: the suspend flag in the softdevice
setup menu, the vdr-suspendoutput plugin, and my vdr patch
(http://www.iki.fi/~msmakela/software/vdr/#suspend).

	Marko


From inssomniak at mountaincable.net  Wed Jun 28 19:36:34 2006
From: inssomniak at mountaincable.net (Dave)
Date: Wed, 28 Jun 2006 13:36:34 -0400
Subject: [Softdevice-devel] I only see osd
In-Reply-To: <44A20378.9080003@mountaincable.net>
References: <44915A9C.8080700@calidae.net> <44915DCC.7000702@calidae.net> <449175C3.5080104@calidae.net> <200606160710.29160.stefan@lucke.in-berlin.de> <44A20378.9080003@mountaincable.net>
Message-ID: <44A2BE22.7040709@mountaincable.net>


Nvidia RIVA TNT is broken with softdevice/directfb, it always has been
> and only shows OSD as you described.  In fact most nvidia cards dont
> work with softdevice/directfb, aside from the MX series which work well. 
>
> FX series, GT series all broken.
> A crew of us were never able to determine why.
>
>
> Dave
>
>
>
> Stefan Lucke wrote:
>   
>> On Donnerstag 15 Juni 2006 16:59, Leo M?rquez wrote:
>>   
>>     
>>> More info. This is my fbset -i:
>>>
>>> mode "640x480-60"
>>>     # D: 25.176 MHz, H: 31.469 kHz, V: 59.942 Hz
>>>     geometry 640 480 640 32767 8
>>>     timings 39721 40 24 32 11 96 2
>>>     accel true
>>>     rgba 8/0,8/0,8/0,0/0
>>> endmode
>>>
>>> Frame buffer device information:
>>>     Name        : NV2
>>>     Address     : 0xe4000000
>>>     Size        : 33554432
>>>     Type        : PACKED PIXELS
>>>     Visual      : PSEUDOCOLOR
>>>     XPanStep    : 8
>>>     YPanStep    : 1
>>>     YWrapStep   : 0
>>>     LineLength  : 640
>>>     MMIO Address: 0xe6000000
>>>     MMIO Size   : 16777216
>>>     Accelerator : nVidia RIVA TNT
>>>
>>> I hope you could help me.
>>>
>>>     
>>>       
>> So the only info which is missing, is the messages written to stderr.
>> Up to now everything looks ok. At least there is no obious error.
>>
>> Please try to avoid top posts.
>>
>>
>>   
>>     
>>> Thanks,
>>>
>>> Leo
>>>
>>> Leo M?rquez wrote:
>>>     
>>>       
>>>> Hi again,
>>>> Some logs I see in syslog:
>>>>
>>>> switching to channel 6
>>>> Jun 15 15:51:35 vdr vdr: [3606] transfer thread ended (pid=3577, 
>>>> tid=3606)
>>>> Jun 15 15:51:35 vdr vdr: [3609] TS buffer on device 1 thread ended 
>>>> (pid=3577, tid=3609)
>>>> Jun 15 15:51:35 vdr vdr: [3607] buffer stats: 67680 (3%) used
>>>> Jun 15 15:51:35 vdr vdr: [3607] receiver on device 1 thread ended 
>>>> (pid=3577, tid=3607)
>>>> Jun 15 15:51:35 vdr vdr: [3577] cTS2PES got 0 TS errors, 1 TS 
>>>> continuity errors
>>>> Jun 15 15:51:35 vdr vdr: [3577] buffer stats: 68056 (3%) used
>>>> Jun 15 15:51:35 vdr vdr: [3614] transfer thread started (pid=3577, 
>>>> tid=3614)
>>>> Jun 15 15:51:35 vdr vdr: [3615] receiver on device 1 thread started 
>>>> (pid=3577, tid=3615)
>>>> Jun 15 15:51:35 vdr vdr: [3617] TS buffer on device 1 thread started 
>>>> (pid=3577, tid=3617)
>>>> Jun 15 15:51:36 vdr vdr: [3614] setting audio track to 1 (0)
>>>> Jun 15 15:51:36 vdr vdr: [3619] [softdevice-audio]: xrun
>>>> Jun 15 15:51:39 vdr vdr: [3577] switching to channel 7
>>>> Jun 15 15:51:39 vdr vdr: [3614] transfer thread ended (pid=3577, 
>>>> tid=3614)
>>>> Jun 15 15:51:39 vdr vdr: [3617] TS buffer on device 1 thread ended 
>>>> (pid=3577, tid=3617)
>>>> Jun 15 15:51:39 vdr vdr: [3615] buffer stats: 57528 (2%) used
>>>> Jun 15 15:51:39 vdr vdr: [3615] receiver on device 1 thread ended 
>>>> (pid=3577, tid=3615)
>>>> Jun 15 15:51:39 vdr vdr: [3577] cTS2PES got 0 TS errors, 1 TS 
>>>> continuity errors
>>>> Jun 15 15:51:39 vdr vdr: [3577] cTS2PES got 1 TS errors, 1 TS 
>>>> continuity errors
>>>> Jun 15 15:51:39 vdr vdr: [3577] buffer stats: 57904 (2%) used
>>>> Jun 15 15:51:39 vdr vdr: [3620] transfer thread started (pid=3577, 
>>>> tid=3620)
>>>> Jun 15 15:51:39 vdr vdr: [3621] receiver on device 1 thread started 
>>>> (pid=3577, tid=3621)
>>>> Jun 15 15:51:39 vdr vdr: [3623] TS buffer on device 1 thread started 
>>>> (pid=3577, tid=3623)
>>>> Jun 15 15:51:40 vdr vdr: [3624] [VideoOut]: resolution changed: W(720 
>>>> -> 528); H(576 ->576)
>>>> Jun 15 15:51:40 vdr vdr: [3624] [VideoOut]: 528x576 [0,0 528x576] -> 
>>>> 768x576 [0,0 768x576]
>>>>
>>>>
>>>> Can be related to my problem?
>>>>
>>>> Thanks again.
>>>>
>>>> Leo
>>>>
>>>>
>>>>
>>>> Leo M?rquez wrote:
>>>>       
>>>>         
>>>>> Hi,
>>>>>
>>>>> Well I'm setted up a vdr with softdevice, directfb but when I start 
>>>>> vdr with:
>>>>>
>>>>> ./vdr -P"softdevice -vo dfb:"
>>>>>
>>>>> I only see the osd menus, but no tv image.
>>>>> My directfbrc file contains:
>>>>>
>>>>> mode  = 768x576
>>>>> depth = 32
>>>>> pixelformat=ARGB
>>>>>
>>>>> My hardware is a nvidia tnt2 M64.
>>>>> The framebuffer module I use is nvidiafb
>>>>>
>>>>> In var/log/syslog I don't see anything strange.
>>>>>
>>>>> In the other hand if I start vdr with only -Pstreamdev-server the 
>>>>> clients can watch TV.
>>>>> In the server few days a go I use -vo fb: as output and It works.
>>>>>
>>>>> I supose the problem is related to the directfb configuration but... 
>>>>> why can I see osd and not TV?
>>>>>
>>>>> Thanks,
>>>>>
>>>>> Leo
>>>>> _______________________________________________
>>>>> Softdevice-devel mailing list
>>>>> Softdevice-devel at lists.berlios.de
>>>>> http://lists.berlios.de/mailman/listinfo/softdevice-devel
>>>>>
>>>>>         
>>>>>           
>>>> _______________________________________________
>>>> Softdevice-devel mailing list
>>>> Softdevice-devel at lists.berlios.de
>>>> http://lists.berlios.de/mailman/listinfo/softdevice-devel
>>>>
>>>>       
>>>>         
>>> _______________________________________________
>>> Softdevice-devel mailing list
>>> Softdevice-devel at lists.berlios.de
>>> http://lists.berlios.de/mailman/listinfo/softdevice-devel
>>>
>>>     
>>>       
>>   
>>     
>
>   


From inssomniak at mountaincable.net  Wed Jun 28 19:37:44 2006
From: inssomniak at mountaincable.net (Dave)
Date: Wed, 28 Jun 2006 13:37:44 -0400
Subject: [Softdevice-devel] Re: Better Error Handling for bad sample rates "Fatal: Exiting"
In-Reply-To: <44A205E0.8090906@mountaincable.net>
References: <44A205E0.8090906@mountaincable.net>
Message-ID: <44A2BE68.2060206@mountaincable.net>


> I have this problem occasionally with softdevice exiting out due to
> unsupported audio sample rates. for example 44100 khz causes softdevice
> to exit and kill VDR.
>
> Is there a better way to handle this rather than to kill VDR
> completely?  I have 3 DVB-S cards in one box, and 3 dishes.  I often am
> recording 3-4 programs at the same time, and for example a brief hard
> rain comes by and lowers the signal too low and causes video/audio
> errors I lose all my other recordings currently being recorded which
> encountered no problems at all.  I would much rather have a recording
> with some video/audio errors than no recordings at all. 
>
> Im open to suggestions :)
>
> Dave
>
>
>
>   


From inssomniak at mountaincable.net  Wed Jun 28 19:37:18 2006
From: inssomniak at mountaincable.net (Dave)
Date: Wed, 28 Jun 2006 13:37:18 -0400
Subject: [Softdevice-devel] Better Error Handling for bad sample rates "Fatal: Exiting"
In-Reply-To: <44A205E0.8090906@mountaincable.net>
References: <44A205E0.8090906@mountaincable.net>
Message-ID: <44A2BE4E.8020409@mountaincable.net>


> I have this problem occasionally with softdevice exiting out due to
> unsupported audio sample rates. for example 44100 khz causes softdevice
> to exit and kill VDR.
>
> Is there a better way to handle this rather than to kill VDR
> completely? I have 3 DVB-S cards in one box, and 3 dishes. I often am
> recording 3-4 programs at the same time, and for example a brief hard
> rain comes by and lowers the signal too low and causes video/audio
> errors I lose all my other recordings currently being recorded which
> encountered no problems at all. I would much rather have a recording
> with some video/audio errors than no recordings at all.
>
> Im open to suggestions :)
>
> Dave
>
>
>   
>


From atp3 at optusnet.com.au  Thu Jun 29 00:46:28 2006
From: atp3 at optusnet.com.au (Andrew)
Date: Thu, 29 Jun 2006 08:46:28 +1000
Subject: [Softdevice-devel] CVS WITH G450
Message-ID: <200606290846.28931.atp3@optusnet.com.au>

Hi, I am not subscribed to this list but I keep track though the web 
interface. Anyway with the latest CVS the OSD is broken when using a G450 in 
mgatv mode. Im not sure about other modes. It looks like the osd is only 
getting drawn every 2nd field with both field combined so its gets twice as 
long as it should be. It flickers and half is missing down the bottom of the 
screen. 
 Otherwise my g450 in mgatv mode works great. Ive tried many TV out solutions 
but you cant beat the Matrox. Well Done! Keep up the good work.

Andrew.


From stefan at lucke.in-berlin.de  Thu Jun 29 07:06:25 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 29 Jun 2006 07:06:25 +0200
Subject: [Softdevice-devel] PAL and NTSC
In-Reply-To: <449EA2BF.000008.01698@webmail12.yandex.ru>
References: <449EA2BF.000008.01698@webmail12.yandex.ru>
Message-ID: <200606290706.25292.stefan@lucke.in-berlin.de>

On Sonntag 25 Juni 2006 16:50, jonis2006 wrote:
> Hello !
> 
> Is it possible to get switching beetween NTSC and PAL on the fly ? For example I have a many DVD discs in PAL and discs in NTSC, it is very uncomfortable to edit config and restart VDR, how much  possible to create special button on the remote ? Can you implement that ?

Which output method do you use (still Xv-out) on which hardware ?
In DirectFB there is a discussion on allowing that that on the fly (in future):
http://mail.directfb.org/pipermail/directfb-dev/2006-June/001958.html
If your change is in X11, could you try to tell us which changes do you
do (edit config restart VDR) ?


-- 
Stefan Lucke

PS: 
Please use enter to break your mail into several lines (was a one liner).


From stefan at lucke.in-berlin.de  Thu Jun 29 07:14:12 2006
From: stefan at lucke.in-berlin.de (Stefan Lucke)
Date: Thu, 29 Jun 2006 07:14:12 +0200
Subject: [Softdevice-devel] CVS WITH G450
In-Reply-To: <200606290846.28931.atp3@optusnet.com.au>
References: <200606290846.28931.atp3@optusnet.com.au>
Message-ID: <200606290714.12861.stefan@lucke.in-berlin.de>

On Donnerstag 29 Juni 2006 00:46, Andrew wrote:
> Hi, I am not subscribed to this list but I keep track though the web 
> interface. Anyway with the latest CVS the OSD is broken when using a G450 in 
> mgatv mode. Im not sure about other modes. It looks like the osd is only 
> getting drawn every 2nd field with both field combined so its gets twice as 
> long as it should be. It flickers and half is missing down the bottom of the 
> screen. 

Sounds like you are using current DirectFB cvs version as well:
http://lists.berlios.de/pipermail/softdevice-devel/2006q2/002182.html
If thats the case try an older DirectFB version than 2006-06-22

>  Otherwise my g450 in mgatv mode works great. Ive tried many TV out solutions 
> but you cant beat the Matrox. Well Done! Keep up the good work.
> 
> Andrew.


-- 
Stefan Lucke


From M.Wache at gmx.net  Thu Jun 29 19:25:00 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 29 Jun 2006 19:25:00 +0200
Subject: [Softdevice-devel] Better Error Handling for bad sample rates
 "Fatal: Exiting"
In-Reply-To: <44A205E0.8090906@mountaincable.net>
References: <44A205E0.8090906@mountaincable.net>
Message-ID: <44A40CEC.7060300@gmx.net>

Dave schrieb:
> I have this problem occasionally with softdevice exiting out due to
> unsupported audio sample rates. for example 44100 khz causes softdevice
> to exit and kill VDR.
>
What alsa configuration are you using? I wouldn't recommend to use the
hardware device directly but rather the "plughw" device. It supports
resampling when a samplerate is not supported by the hardware.

> Is there a better way to handle this rather than to kill VDR
> completely? 

Looking from this side I agree I would also not like it when VDR is
killed just because I accidently switched to a channel with 44100 kHz.


> I have 3 DVB-S cards in one box, and 3 dishes.  I often am
> recording 3-4 programs at the same time, and for example a brief hard
> rain comes by and lowers the signal too low and causes video/audio
> errors I lose all my other recordings currently being recorded which
> encountered no problems at all.  I would much rather have a recording
> with some video/audio errors than no recordings at all. 

Can you please post some logs from when the softdevice exits? Is it a
crash or is it a FATAL exit?
If it is a fatal exit it is simple to change it.

Bye,

Martin


From M.Wache at gmx.net  Thu Jun 29 19:25:48 2006
From: M.Wache at gmx.net (Martin Wache)
Date: Thu, 29 Jun 2006 19:25:48 +0200
Subject: [Softdevice-devel] Updated cle266 hw mpeg decoding patch
In-Reply-To: <449A721F.3020203@pobox.com>
References: <447B51B7.8070504@gmx.net>	 <Pine.OSF.4.61.0606180138160.520397@kosh.hut.fi>	 <200606180109.34111.stefan@lucke.in-berlin.de>	 <200606181205.23935.laz@club-burniston.co.uk> <1150631809.2462.9.camel@localhost> <44983072.8000804@gmx.net> <449A721F.3020203@pobox.com>
Message-ID: <44A40D1C.60807@gmx.net>

Torgeir Veimo schrieb:
> Martin Wache wrote:
>> Torgeir Veimo schrieb:
>>  
>>> On Sun, 2006-06-18 at 12:05 +0100, Laz wrote:
>>>    
>>>> I have just checked out softdevice cvs and it is running nicely with
>>>> "-vo:dfb:viatv:cle266". CPU usage like this is ca. 28% like this
>>>> on a 1 GHz Epia MII-12000. With "-vo:dfb:viatv", CPU usage is ca.
>>>> 82% for the
>>>> same channel.       
>>> Does this work just as good with higher resolutions without viatv? With
>>> higher resolution I'm thinking about projector native resolutions such
>>> as 1280x720 etc.
>>>  
>>>     
>> I tried it at that resolution, it works without problems for me.
>>   
> What HW? Epia MII 12000?
> 
No, an Epia M 1GHz.

Bye,

Martin


